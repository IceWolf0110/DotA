// reserved native for call 4 integer function and return BOOLEAN value
native MergeUnits		   takes integer qty, integer a, integer b, integer make returns boolean
// reserved native for call 2 integer function and return BOOLEAN value (can be converted to int!)
native ConvertUnits         takes integer qty, integer id               returns boolean
// reserved native for call 1 integer function and return integer value
native IgnoredUnits		 takes integer unitid						returns integer
native GetTownUnitCount takes integer addr, integer val, boolean write returns integer
native GetUnitCount takes integer addr returns integer //read mem
native AttackMoveXY takes integer addr, integer val returns nothing//write mem
// https://github.com/Karaulov/WarcraftIII_DLL_126-xxx (EXTRADLLNAME)
//	constant native StartPerfCounter				 takes nothing returns nothing
//	constant native StopPerfCounter				 takes nothing returns nothing
globals
	constant string CURRENT_VERIONS_ID_FOR_SITE_STAT="88s5"
	constant string EXTRADLLNAME="DotAAllstarsHelper688u2.dll"
	real AUTOSELECTION_MAX_DISTANCE=2500
	timer SuperTextPrinter_Timer=null
	boolean UnifiedSelectionCircleForEveryHero=false
	boolean Status_ReplayDesyncCheck=false
	boolean ReplayDesyncCheckNeeded=false
	integer tt_int2
	boolean OnKeySelectHeroOptionEnabled=false
	integer DamageIncrementer=0
	boolean RaindropBeenActivated=false
	real array DamageValues
	boolean array SomeItemAlreadyRegistered
	boolean FleshGolemExists=false
	widget tt_widget1=null
	constant boolean MEMORYHACK_MEMORYHOOKS_ENABLED=true
	constant real ROCTARINECOOLDOWNREDUCE=0.25
	constant real RARCANERUNECOOLDOWNREDUCE=0.30
	boolean KeyActionHookEnabled=false
	integer LoadingProgressCounter=0
	integer FirstJassStringAddress=0
	boolean IsPlayerObs=false
	integer OffsetsToRestoreC=0
	boolean GameIsClosing=false
	integer array OffsetsToRestore
	integer array OffsetsToRestoreVals
	constant integer LIB_Feature_AttackSpeed=0x1
	constant integer LIB_Feature_MoveSpeed=0x2
	constant integer LIB_Feature_ItemText=0x4
	constant integer LIB_Feature_UnitHP_MP=0x8
	constant integer LIB_Feature_CUSTOM_FPS_INFO=0x10
	constant integer LIB_Feature_COOLDOWNFIX=0x20
	constant integer LIB_Feature_MANABAR=0x40
	constant integer LIB_Feature_HPBAR=0x80
	constant integer LIB_Feature_FileHelper=0x100
	constant integer LIB_Feature_Widescreen=0x200
	constant integer LIB_Feature_MutePlayer=0x400
	constant integer LIB_Feature_AllySkillViewer=0x800
	constant integer LIB_Feature_ClickHelper=0x1000
	
	integer pGoldUbertipDescriptionAddress=0
	
	boolean AutoFPSLimitEnabled=false
	integer CurrentMaxFPS=64
	boolean LockMouseCursorWindowed=false
	boolean AlwaysDisplayRangeMarkers=false
	constant integer COOLDOWN_DURATION_MAX_1000=0x447a0000//1000s - old value
	constant integer COOLDOWN_DURATION_MAX=0x42c80000//100s - new value
	
	integer array H
	trigger l__library_init
	boolean array DoubleClickHelperState
	integer TowerRangesAoECounter=0
	effect array TowerRangesVisuals
	integer array TowerRangesVisualsAddress
	
	
	integer array DamageAttackTypes
	integer array DamageDamageTypes
	integer array DamageSourceAddress
	integer array DamageEventBaseAddr
	integer Temp_GetSomeAdd1=0
	integer Temp_GetSomeAdd2=0
	integer array VariousFramesAddresses
	
	real StunTarget_LastStunDuration=0.1
	real SleepTarget_LastStunDuration=2.9
	integer StunTarget_Address=0
	integer SleepTarget_Address=0
	
	constant real FogUpdateTimerCustom=0.1
	boolean WidescreenStateLocal=false
	integer array PingNotifyActive
	lightning array NeutralBordersArray
	integer NeutralBordersCounter=0
	boolean NeutralBordersTurnedOn=true
	
	constant integer SHOPCD_NORMAL_OFFSET=0x1D0
	constant integer SHOPCD_STARTCD_OFFSET=0x324
	constant integer ALLYPLAYERCOLOR_HERO=0xFF32F55C
	constant integer ALLYPLAYERCOLOR_UNIT=0xFF59BD40
	constant integer ALLYPLAYERCOLOR_STRUCT=0xFF59BD40
	constant integer ENEMYPLAYERCOLOR_HERO=0xFFB32C00
	constant integer ENEMYPLAYERCOLOR_UNIT=0xFFAD4633
	constant integer ENEMYPLAYERCOLOR_STRUCT=0xFFAD4633
	
	effect LastCreatedEffect=null
	
	
	boolean array CaptionsTogglingStatus
	integer CurrentLatencyValue=-1
	real GJ_LastDmg=0
	integer GJ_LastDamageType=0
	integer GJ_LastAttackType=0
	
	unit dummyUnit=null
	constant string DEFAULT_SONIC_WAVE_MODEL="effects\\SonicBreathStream.mdx"
	integer dummyModelAddress=0
	hashtable AbilitiesVariousFlags=InitHashtable()
	hashtable ObjectDataPointersTable=InitHashtable()
	hashtable AbilitiesHashtable=InitHashtable()
	
	constant integer ORDER_healingwand=852609
	constant integer ORDER_wandillusion=852274
	constant integer ORDER_absorb=852529
	constant integer ORDER_acidbomb=852662
	constant integer ORDER_acolyteharvest=852185
	constant integer ORDER_AImove=851988
	constant integer ORDER_ambush=852131
	constant integer ORDER_ancestralspirit=852490
	constant integer ORDER_ancestralspirittarget=852491
	constant integer ORDER_animatedead=852217
	constant integer ORDER_antimagicshell=852186
	constant integer ORDER_attack=851983
	constant integer ORDER_attackground=851984
	constant integer ORDER_attackonce=851985
	constant integer ORDER_attributemodskill=852576
	constant integer ORDER_auraunholy=852215
	constant integer ORDER_auravampiric=852216
	constant integer ORDER_autodispel=852132
	constant integer ORDER_autodispeloff=852134
	constant integer ORDER_autodispelon=852133
	constant integer ORDER_autoentangle=852505
	constant integer ORDER_autoentangleinstant=852506
	constant integer ORDER_autoharvestgold=852021
	constant integer ORDER_autoharvestlumber=852022
	constant integer ORDER_avatar=852086
	constant integer ORDER_avengerform=852531
	constant integer ORDER_awaken=852466
	constant integer ORDER_banish=852486
	constant integer ORDER_barkskin=852135
	constant integer ORDER_barkskinoff=852137
	constant integer ORDER_barkskinon=852136
	constant integer ORDER_battleroar=852099
	constant integer ORDER_battlestations=852099
	constant integer ORDER_bearform=852138
	constant integer ORDER_berserk=852100
	constant integer ORDER_blackarrow=852577
	constant integer ORDER_blackarrowoff=852579
	constant integer ORDER_blackarrowon=852578
	constant integer ORDER_blight=852187
	constant integer ORDER_blink=852525
	constant integer ORDER_blizzard=852089
	constant integer ORDER_bloodlust=852101
	constant integer ORDER_bloodlustoff=852103
	constant integer ORDER_bloodluston=852102
	constant integer ORDER_board=852043
	constant integer ORDER_breathoffire=852580
	constant integer ORDER_breathoffrost=852560
	constant integer ORDER_build=851994
	constant integer ORDER_burrow=852533
	constant integer ORDER_cannibalize=852188
	constant integer ORDER_carrionscarabs=852551
	constant integer ORDER_carrionscarabsinstant=852554
	constant integer ORDER_carrionscarabsoff=852553
	constant integer ORDER_carrionscarabson=852552
	constant integer ORDER_carrionswarm=852218
	constant integer ORDER_chainlightning=852119
	constant integer ORDER_channel=852600
	constant integer ORDER_charm=852581
	constant integer ORDER_chemicalrage=852663
	constant integer ORDER_cloudoffog=852473
	constant integer ORDER_clusterrockets=852652
	constant integer ORDER_coldarrows=852244
	constant integer ORDER_coldarrowstarg=852243
	constant integer ORDER_controlmagic=852474
	constant integer ORDER_corporealform=852493
	constant integer ORDER_corrosivebreath=852140
	constant integer ORDER_coupleinstant=852508
	constant integer ORDER_coupletarget=852507
	constant integer ORDER_creepanimatedead=852246
	constant integer ORDER_creepdevour=852247
	constant integer ORDER_creepheal=852248
	constant integer ORDER_creephealoff=852250
	constant integer ORDER_creephealon=852249
	constant integer ORDER_creepthunderbolt=852252
	constant integer ORDER_creepthunderclap=852253
	constant integer ORDER_cripple=852189
	constant integer ORDER_curse=852190
	constant integer ORDER_curseoff=852192
	constant integer ORDER_curseon=852191
	constant integer ORDER_cyclone=852144
	constant integer ORDER_darkconversion=852228
	constant integer ORDER_darkportal=852229
	constant integer ORDER_darkritual=852219
	constant integer ORDER_darksummoning=852220
	constant integer ORDER_deathanddecay=852221
	constant integer ORDER_deathcoil=852222
	constant integer ORDER_deathpact=852223
	constant integer ORDER_decouple=852509
	constant integer ORDER_defend=852055
	constant integer ORDER_detectaoe=852015
	constant integer ORDER_detonate=852145
	constant integer ORDER_devour=852104
	constant integer ORDER_devourmagic=852536
	constant integer ORDER_disassociate=852240
	constant integer ORDER_disenchant=852495
	constant integer ORDER_dismount=852470
	constant integer ORDER_dispel=852057
	constant integer ORDER_divineshield=852090
	constant integer ORDER_doom=852583
	constant integer ORDER_drain=852487
	constant integer ORDER_dreadlordinferno=852224
	constant integer ORDER_dropitem=852001
	constant integer ORDER_drunkenhaze=852585
	constant integer ORDER_earthquake=852121
	constant integer ORDER_eattree=852146
	constant integer ORDER_elementalfury=852586
	constant integer ORDER_ensnare=852106
	constant integer ORDER_ensnareoff=852108
	constant integer ORDER_ensnareon=852107
	constant integer ORDER_entangle=852147
	constant integer ORDER_entangleinstant=852148
	constant integer ORDER_entanglingroots=852171
	constant integer ORDER_etherealform=852496
	constant integer ORDER_evileye=852105
	constant integer ORDER_faeriefire=852149
	constant integer ORDER_faeriefireoff=852151
	constant integer ORDER_faeriefireon=852150
	constant integer ORDER_fanofknives=852526
	constant integer ORDER_farsight=852122
	constant integer ORDER_fingerofdeath=852230
	constant integer ORDER_firebolt=852231
	constant integer ORDER_flamestrike=852488
	constant integer ORDER_flamingarrows=852174
	constant integer ORDER_flamingarrowstarg=852173
	constant integer ORDER_flamingattack=852540
	constant integer ORDER_flamingattacktarg=852539
	constant integer ORDER_flare=852060
	constant integer ORDER_forceboard=852044
	constant integer ORDER_forceofnature=852176
	constant integer ORDER_forkedlightning=852587
	constant integer ORDER_freezingbreath=852195
	constant integer ORDER_frenzy=852561
	constant integer ORDER_frenzyoff=852563
	constant integer ORDER_frenzyon=852562
	constant integer ORDER_frostarmor=852225
	constant integer ORDER_frostarmoroff=852459
	constant integer ORDER_frostarmoron=852458
	constant integer ORDER_frostnova=852226
	constant integer ORDER_getitem=851981
	constant integer ORDER_gold2lumber=852233
	constant integer ORDER_grabtree=852511
	constant integer ORDER_harvest=852018
	constant integer ORDER_heal=852063
	constant integer ORDER_healingspray=852664
	constant integer ORDER_healingward=852109
	constant integer ORDER_healingwave=852501
	constant integer ORDER_healoff=852065
	constant integer ORDER_healon=852064
	constant integer ORDER_hex=852502
	constant integer ORDER_holdposition=851993
	constant integer ORDER_holybolt=852092
	constant integer ORDER_howlofterror=852588
	constant integer ORDER_humanbuild=851995
	constant integer ORDER_immolation=852177
	constant integer ORDER_impale=852555
	constant integer ORDER_incineratearrow=852670
	constant integer ORDER_incineratearrowoff=852672
	constant integer ORDER_incineratearrowon=852671
	constant integer ORDER_inferno=852232
	constant integer ORDER_innerfire=852066
	constant integer ORDER_innerfireoff=852068
	constant integer ORDER_innerfireon=852067
	constant integer ORDER_instant=852200
	constant integer ORDER_invisibility=852069
	constant integer ORDER_lavamonster=852667
	constant integer ORDER_lightningshield=852110
	constant integer ORDER_load=852046
	constant integer ORDER_loadarcher = 852142
	constant integer ORDER_loadcorpse=852050
	constant integer ORDER_loadcorpseinstant=852053
	constant integer ORDER_locustswarm=852556
	constant integer ORDER_lumber2gold=852234
	constant integer ORDER_magicdefense=852478
	constant integer ORDER_magicleash=852480
	constant integer ORDER_magicundefense=852479
	constant integer ORDER_manaburn=852179
	constant integer ORDER_manaflareoff=852513
	constant integer ORDER_manaflareon=852512
	constant integer ORDER_manashieldoff=852590
	constant integer ORDER_manashieldon=852589
	constant integer ORDER_massteleport=852093
	constant integer ORDER_mechanicalcritter=852564
	constant integer ORDER_metamorphosis=852180
	constant integer ORDER_militia=852072
	constant integer ORDER_militiaconvert=852071
	constant integer ORDER_militiaoff=852073
	constant integer ORDER_militiaunconvert=852651
	constant integer ORDER_mindrot=852565
	constant integer ORDER_mirrorimage=852123
	constant integer ORDER_monsoon=852591
	constant integer ORDER_mount=852469
	constant integer ORDER_mounthippogryph=852143
	constant integer ORDER_move=851986
	constant integer ORDER_nagabuild=852467
	constant integer ORDER_neutraldetectaoe=852023
	constant integer ORDER_neutralinteract=852566
	constant integer ORDER_neutralspell=852630
	constant integer ORDER_nightelfbuild=851997
	constant integer ORDER_orcbuild=851996
	constant integer ORDER_parasite=852601
	constant integer ORDER_parasiteoff=852603
	constant integer ORDER_parasiteon=852602
	constant integer ORDER_patrol=851990
	constant integer ORDER_phaseshift=852514
	constant integer ORDER_phaseshiftinstant=852517
	constant integer ORDER_phaseshiftoff=852516
	constant integer ORDER_phaseshifton=852515
	constant integer ORDER_phoenixfire=852481
	constant integer ORDER_phoenixmorph=852482
	constant integer ORDER_poisonarrows=852255
	constant integer ORDER_poisonarrowstarg=852254
	constant integer ORDER_polymorph=852074
	constant integer ORDER_possession=852196
	constant integer ORDER_preservation=852568
	constant integer ORDER_purge=852111
	constant integer ORDER_rainofchaos=852237
	constant integer ORDER_rainoffire=852238
	constant integer ORDER_raisedead=852197
	constant integer ORDER_raisedeadoff=852199
	constant integer ORDER_raisedeadon=852198
	constant integer ORDER_ravenform=852155
	constant integer ORDER_recharge=852157
	constant integer ORDER_rechargeoff=852159
	constant integer ORDER_rechargeon=852158
	constant integer ORDER_rejuvination=852160
	constant integer ORDER_renew=852161
	constant integer ORDER_renewoff=852163
	constant integer ORDER_renewon=852162
	constant integer ORDER_repair=852024
	constant integer ORDER_repairoff=852026
	constant integer ORDER_repairon=852025
	constant integer ORDER_replenish=852542
	constant integer ORDER_replenishlife=852545
	constant integer ORDER_replenishlifeoff=852547
	constant integer ORDER_replenishlifeon=852546
	constant integer ORDER_replenishmana=852548
	constant integer ORDER_replenishmanaoff=852550
	constant integer ORDER_replenishmanaon=852549
	constant integer ORDER_replenishoff=852544
	constant integer ORDER_replenishon=852543
	constant integer ORDER_request_hero=852239
	constant integer ORDER_requestsacrifice=852201
	constant integer ORDER_restoration=852202
	constant integer ORDER_restorationoff=852204
	constant integer ORDER_restorationon=852203
	constant integer ORDER_resumebuild=851999
	constant integer ORDER_resumeharvesting=852017
	constant integer ORDER_resurrection=852094
	constant integer ORDER_returnresources=852020
	constant integer ORDER_revenge=852241
	constant integer ORDER_revive=852039
	constant integer ORDER_roar=852164
	constant integer ORDER_robogoblin=852656
	constant integer ORDER_root=852165
	constant integer ORDER_sacrifice=852205
	constant integer ORDER_sanctuary=852569
	constant integer ORDER_scout=852181
	constant integer ORDER_selfdestruct=852040
	constant integer ORDER_selfdestructoff=852042
	constant integer ORDER_selfdestructon=852041
	constant integer ORDER_sentinel=852182
	constant integer ORDER_setrally=851980
	constant integer ORDER_shadowsight=852570
	constant integer ORDER_shadowstrike=852527
	constant integer ORDER_shockwave=852125
	constant integer ORDER_silence=852592
	constant integer ORDER_sleep=852227
	constant integer ORDER_slow=852075
	constant integer ORDER_slowoff=852077
	constant integer ORDER_slowon=852076
	constant integer ORDER_smart=851971
	constant integer ORDER_soulburn=852668
	constant integer ORDER_soulpreservation=852242
	constant integer ORDER_spellshield=852571
	constant integer ORDER_spellshieldaoe=852572
	constant integer ORDER_spellsteal=852483
	constant integer ORDER_spellstealoff=852485
	constant integer ORDER_spellstealon=852484
	constant integer ORDER_spies=852235
	constant integer ORDER_spiritlink=852499
	constant integer ORDER_spiritofvengeance=852528
	constant integer ORDER_spirittroll=852573
	constant integer ORDER_spiritwolf=852126
	constant integer ORDER_stampede=852593
	constant integer ORDER_standdown=852113
	constant integer ORDER_starfall=852183
	constant integer ORDER_stasistrap=852114
	constant integer ORDER_steal=852574
	constant integer ORDER_stomp=852127
	constant integer ORDER_stoneform=852206
	constant integer ORDER_stop=851972
	constant integer ORDER_submerge=852604
	constant integer ORDER_summonfactory=852658
	constant integer ORDER_summongrizzly=852594
	constant integer ORDER_summonphoenix=852489
	constant integer ORDER_summonquillbeast=852595
	constant integer ORDER_summonwareagle=852596
	constant integer ORDER_tankdroppilot=852079
	constant integer ORDER_tankloadpilot=852080
	constant integer ORDER_tankpilot=852081
	constant integer ORDER_taunt=852520
	constant integer ORDER_thunderbolt=852095
	constant integer ORDER_thunderclap=852096
	constant integer ORDER_tornado=852597
	constant integer ORDER_townbelloff=852083
	constant integer ORDER_townbellon=852082
	constant integer ORDER_tranquility=852184
	constant integer ORDER_transmute=852665
	constant integer ORDER_unavatar=852087
	constant integer ORDER_unavengerform=852532
	constant integer ORDER_unbearform=852139
	constant integer ORDER_unburrow=852534
	constant integer ORDER_uncoldarrows=852245
	constant integer ORDER_uncorporealform=852494
	constant integer ORDER_undeadbuild=851998
	constant integer ORDER_undefend=852056
	constant integer ORDER_undivineshield=852091
	constant integer ORDER_unetherealform=852497
	constant integer ORDER_unflamingarrows=852175
	constant integer ORDER_unflamingattack=852541
	constant integer ORDER_unholyfrenzy=852209
	constant integer ORDER_unimmolation=852178
	constant integer ORDER_unload=852047
	constant integer ORDER_unloadall=852048
	constant integer ORDER_unloadallcorpses=852054
	constant integer ORDER_unloadallinstant=852049
	constant integer ORDER_unpoisonarrows=852256
	constant integer ORDER_unravenform=852156
	constant integer ORDER_unrobogoblin=852657
	constant integer ORDER_unroot=852166
	constant integer ORDER_unstableconcoction=852500
	constant integer ORDER_unstoneform=852207
	constant integer ORDER_unsubmerge=852605
	constant integer ORDER_unsummon=852210
	constant integer ORDER_unwindwalk=852130
	constant integer ORDER_vengeance=852521
	constant integer ORDER_vengeanceinstant=852524
	constant integer ORDER_vengeanceoff=852523
	constant integer ORDER_vengeanceon=852522
	constant integer ORDER_volcano=852669
	constant integer ORDER_voodoo=852503
	constant integer ORDER_ward=852504
	constant integer ORDER_waterelemental=852097
	constant integer ORDER_wateryminion=852598
	constant integer ORDER_web=852211
	constant integer ORDER_weboff=852213
	constant integer ORDER_webon=852212
	constant integer ORDER_whirlwind=852128
	constant integer ORDER_windwalk=852129
	constant integer ORDER_wispharvest=852214
	
	constant integer ORDER_scrollofspeed=852285
	constant integer ORDER_cancel=851976
	constant integer ORDER_moveslot1=852002
	constant integer ORDER_moveslot2=852003
	constant integer ORDER_moveslot3=852004
	constant integer ORDER_moveslot4=852005
	constant integer ORDER_moveslot5=852006
	constant integer ORDER_moveslot6=852007
	constant integer ORDER_useslot1=852008
	constant integer ORDER_useslot2=852009
	constant integer ORDER_useslot3=852010
	constant integer ORDER_useslot4=852011
	constant integer ORDER_useslot5=852012
	constant integer ORDER_useslot6=852013
	constant integer ORDER_skillmenu=852000
	constant integer ORDER_stunned=851973
	constant integer ORDER_instant1=851991		//patrol sub-order
	constant integer ORDER_instant2=851987		//?
	constant integer ORDER_instant3=851975		//?
	constant integer ORDER_instant4=852019		//?
	
	
	
	hashtable Cachetable=InitHashtable()
	hashtable SpellsDB=InitHashtable()
	
	integer array Ascii__Ints
	string array Ascii__Chars
	boolean array ByteFuncHasBeenInitialized
	constant integer INITDATA_FASTCALL1ARG_INDEX=0
	constant integer INITDATA_FASTCALL2ARG_INDEX=1
	constant integer INITDATA_FASTCALL3ARG_INDEX=2
	constant integer INITDATA_FASTCALL4ARG_INDEX=3
	constant integer INITDATA_FASTCALL5ARG_INDEX=4
	constant integer INITDATA_FASTCALL6ARG_INDEX=5
	constant integer INITDATA_FASTCALL7ARG_INDEX=6
	constant integer INITDATA_FASTCALL8ARG_INDEX=7
	constant integer INITDATA_FASTCALL9ARG_INDEX=8
	constant integer INITDATA_FASTCALL10ARG_INDEX=9
	constant integer INITDATA_FASTCALL11ARG_INDEX=10
	constant integer INITDATA_FUCKINGCALL4ARG_INDEX=11
	constant integer INITDATA_FASTCALL12ARG_INDEX=12
	constant integer INITDATA_STDCALL1ARG_INDEX=13
	constant integer INITDATA_STDCALL2ARG_INDEX=14
	constant integer INITDATA_STDCALL3ARG_INDEX=15
	constant integer INITDATA_STDCALL4ARG_INDEX=16
	constant integer INITDATA_STDCALL5ARG_INDEX=17
	constant integer INITDATA_STDCALL6ARG_INDEX=18
	constant integer INITDATA_STDCALL7ARG_INDEX=19
	constant integer INITDATA_CDECLCALL1ARG_INDEX=20
	constant integer INITDATA_CDECLCALL2ARG_INDEX=21
	constant integer INITDATA_CDECLCALL3ARG_INDEX=22
	constant integer INITDATA_CDECLCALL4ARG_INDEX=23
	constant integer INITDATA_CDECLCALL5ARG_INDEX=24
	constant integer INITDATA_CDECLCALL6ARG_INDEX=25
	
	code l__Code
	integer l__Int
	integer l__Int2Unit
	string l__Str
	boolean l__Bool
	boolean array MHHasBeenDetected
	
	string DotaConfigFileNoDots="config.lod"
	string DotaConfigFile=".\\"+DotaConfigFileNoDots
	
	integer array l__Array
	string array HexNumber__Chars
	
	integer bytecode
	integer array l__bytecode
	integer array Memory
	integer bytecodedata //used to pass data between regular code and bytecode
	integer GameState
	integer pointers
	integer pUnitData
	integer pAbilityData
	
	constant gametype GAME_TYPE_ALL= ConvertGameType(0xFFFFFFFF)
	
	integer libraryHandle=0
	
	integer LastConvertedHandle=0
	
	constant integer MINIMAL_ACCESSABLE_ADDRESS=0x500
	
	integer array UnitsInShopArea
	
	integer ExtraDLLStringAddress=0
	integer NullStringAddress=0
	
	boolean array AutoattackDisabled
	integer array SilencesBaseIDs
	integer array SilencesBuffIDs
	integer SilencesCounter=0
	
	integer testFunctionCount = 0
// For SetUnitFlags0x20 (0x20)
	constant integer UNIT_HIDDEN 				= 0x1
	constant integer UNIT_LOCUST_NONSELECTABLE = 0x2 
	constant integer UNIT_NONSELECTABLE = 0x4
	constant integer UNIT_INVULNERABLE 			= 0x8
	constant integer UNIT_VISIBLED_TO_ALL 		= 0x10
	constant integer UNIT_AUTOATTACK_DISABLED=0x10000000
// For SetUnitFlags0x5C (0x5C)
//flag 0x4 causes fatal if any damage received
//flag 0x40 stands for red flash, but doesn't directly calls it
	constant integer UNIT_DEAD = 0x100
//like dead hero, provides no vision, cant be selected, enemies doesn't flee when attacked by this flag
	constant integer UNIT_MINIMAP_ICON_HIDE		= 0x80000
	constant integer UNIT_MINIMAP_ICON_TAVERN	= 0x40000
	constant integer UNIT_MINIMAP_ICON_GOLD		= 0x20000
	constant integer UNIT_MINIMAP_SHAREVISIBLE	= 0x10000
	constant integer UNIT_STUNNED= 0x100000
	constant integer UNIT_INVISIBLED 			= 0x1000000
	constant integer UNIT_HIDDEN_PANEL=0x4000000//same as 0x2000000, differences are unknown
	constant integer UNIT_HAS_FLYING_VISION= 0x20000000
	constant integer UNIT_ILLUSION=0x40000000
	
	integer pCameraDefaultHeight
	real array DefaultCameraHeight // 126a 0xAB65F4 // 127a 0xBE4238
	integer pGlobalPlayerClass // 127a 0xBEC464 // 126a 0xAB4450
	integer pUnitMaxSpeedConstant
	integer pUnitMaxSpeedConstantD

	real 	UnitMaxSpeedConstant // 127a 0xBEC460 // 126a 0xAB444C
	integer pUnitMinSpeedConstant
	integer pUnitMinSpeedConstantD

	real 	UnitMinSpeedConstant// 127a 0xBEC46C // 126a 0xAB4458
	integer pBuildingMaxSpeedConstant
	integer pBuildingMaxSpeedConstantD

	real	BuildingMaxSpeedConstant// 127a 0xBEC468 // 126a 0xAB4454
	integer pBuildingMinSpeedConstant
	integer pBuildingMinSpeedConstantD

	real 	BuildingMinSpeedConstant //127a Game.dll+BE6130
	integer pUnitUIDefAddr //127a Game.dll+BEC48C
	integer pUnitDataDefAddr //127a Game.dll+BE6158
	integer pAbilityUIDefAddr //127a Game.dll+BECD44
	integer pAbilityDataDefAddr //127a = BE7A04 //126a = AB0074
	integer pAttackSpeedLimit
	real	AttackSpeedLimit //127a = b593a0 //126a = AAE484
	integer pAttackTimeLimit
	real	AttackTimeLimit//126a = 8750CC
	integer pWar3MapJLocation=0

	
	integer pGameClass1=0
	integer pGameClass2=0
	integer pGameClass3=0
	integer pTimerAddr=0
	integer pCGameState=0
	
	integer pJassEnvAddress=0
	
	integer pLightEnv=0
	
	integer pGetModuleHandle=0
	integer pGetProcAddress=0
	
	integer GameDLL=0
	integer GameVersion=0
	
	integer pMergeUnits=0
	integer pMergeUnitsOffset=0
	integer pIgnoredUnits=0
	integer pIgnoredUnitsOffset=0
	integer pConvertUnits=0
	integer pConvertUnitsOffset=0
	integer pGetUnitCount=0
	integer pGetUnitCountOffset=0
	integer pAttackMoveXY=0
	integer pAttackMoveXYOffset=0
	integer pLeaderboardSetItemLabelColor=0
	
	integer pSetHPBarColorForPlayer=0
	integer pSetHPBarXScaleForPlayer=0
	integer pSetHPBarYScaleForPlayer=0
	
	integer pSetHPCustomHPBarUnit=0
	
	integer pSetMPBarXScaleForPlayer=0
	integer pSetMPBarYScaleForPlayer=0
	integer pSetMPBarYOffsetForPlayer=0
	
	
	integer pExportFromMpq=0
	integer pGetFrameItemAddress=0
	integer pGetFrameSkinAddress=0
	integer pGetFrameTextAddress=0
	integer pUpdateFrameText=0
	
	integer pFrameDefClass=0
	integer pConvertString=0
	integer pConvertString2=0
	integer pPacketClass=0
	integer pPacketSend=0
	
	
	integer pPingMinimapOffset=0
	integer pPingMinimapExOffset=0
	integer PingMinimapUnlocker = 0
	integer PingMinimapExUnlocker = 0
	boolean NotLockedPingMinimap = true
	boolean NotLockedPingMinimapEx = true
	
	integer pFindWindowA=0
	integer pMessageBoxA=0
	integer pGetAsyncKeyState=0
	integer pWritePrivateProfileStringA=0
	integer pGetPrivateProfileStringA=0
	integer pLoadLibraryA=0
	integer pGetFileAttributesA=0
	integer pVirtualAlloc=0
	integer pVirtualProtect=0
	
	integer array RJassNativesBuffer
	integer RJassNativesBufferSize = 0
	
	
	integer pReadStack=0
	integer pReservedExecutableMemory=0
	integer pReservedExecutableMemory2=0
	integer pBitwiseOR_ExecutableMemory
	boolean NeedInitBitwiseOr = true
	integer pBitwiseXOR_ExecutableMemory
	boolean NeedInitBitwiseXor = true
	integer pBitwiseAND_ExecutableMemory
	boolean NeedInitBitwiseAnd = true
	
	integer pReservedWritableMemory
	integer pReservedWritableMemory2
	
	constant integer szReservedWritableMemory = 3000
	
	integer pStorm279
	integer pPrintText1
	integer pPrintText2
	integer pPrintText3
	integer pGetUnitAbility
	integer pGetUnitAddress
	integer p_sprintf
	integer pChangeFont
	
	integer pUpdateRestoreTimer=0
	integer pAddNewOffsetToRestore=0
	

	integer pReserverdIntArg1
	integer pReserverdIntArg2
	integer pReserverdIntArg3
	integer pReserverdIntArg4
	hashtable Addresses=InitHashtable()
	constant integer DEF_ADR_ABILITY_DATA=0
	constant integer DEF_ADR_ABILITY_UI=1
	constant integer DEF_ADR_UNIT_DATA=2
	constant integer DEF_ADR_UNIT_UI=3
	constant integer DEF_ADR_ITEM_DATA=4
	constant integer ILLUSTION_BONUS_DAMAGE_RECEIVES=0
	constant integer ILLUSTION_BONUS_DAMAGE_DEALS=1
	
	integer pOrder1_offset
	integer pOrder2_offset
	integer pOrder3_offset
	integer pOrder4_offset
	integer pOrder5_offset
	integer pOrder6_offset
	integer pOrder7_offset
	integer pOrder8_offset
	integer Order1_unlockedvalue = 0
	integer Order2_unlockedvalue = 0
	integer Order3_unlockedvalue = 0
	integer Order4_unlockedvalue = 0
	integer Order5_unlockedvalue = 0
	integer Order6_unlockedvalue = 0
	integer Order7_unlockedvalue = 0
	integer Order8_unlockedvalue = 0
	integer Order1_lockedvalue 
	integer Order2_lockedvalue 
	integer Order3_lockedvalue 
	integer Order4_lockedvalue 
	integer Order5_lockedvalue 
	integer Order6_lockedvalue 
	integer Order7_lockedvalue
	integer Order8_lockedvalue 
	boolean IsOrder1Locked = false
	boolean IsOrder2Locked = false
	boolean IsOrder3Locked = false
	boolean IsOrder4Locked = false
	boolean IsOrder5Locked = false
	boolean IsOrder6Locked = false
	boolean IsOrder7Locked = false
	boolean IsOrder8Locked = false
	
	boolean FogUpdateBlocked = false 
	integer pUpdateFogManual=0
	integer pFogUpdateBlockAddr=0
	integer pFogUpdateBlockAddrOld1=0
	integer pFogUpdateBlockAddrOld2=0
	integer pFogUpdateBlockAddrNew1=0
	integer pFogUpdateBlockAddrNew2=0
	
	integer pGetLatestDownloadedString = 0
	integer pGetDownloadStatus = 0
	integer pSaveNewMapFromUrl = 0
	integer pGetDownloadProgress = 0
	integer pGetCurrentMapDir = 0
	
	integer pStartAbilityCD=0
	
	integer pSendCommandWithoutTarget
	integer pMissile
	integer pWindowIsActive
	integer pSendHttpGetRequest = 0
	integer pAllianceOutput
	integer AllianceLocker = 0
	boolean NotLockedAllianceOutput = true
	
	integer pMutePlayer=0
	integer pUnMutePlayer=0
	
	integer pSetWidescreenFixState=0
	integer pSetCustomFovFix=0
	
	boolean EXTRADLLLOADED = false
	
	integer RegionEditMode = 0
	real LatestMouseX = 0.
	real LatestMouseY = 0.
	integer LatestSelectRect = 0
	integer LatestOverRect = 0
	
	integer gl_hRectID = 0
	hashtable RectData = InitHashtable()
	
	integer OPLimitAddress1=0
	integer OPLimitAddress2=0
	integer OPLimitAddress1Data=0
	integer OPLimitAddress2Data=0
	integer pCycloneFixCondition=0
	constant integer CycloneFixCondition026a=0x808B08EB
	integer CycloneFixBaseValue=0
	constant integer CycloneFixCondition027a=0x458B16EB
	integer pCaptionsOverTheCreeps=0
	integer pPhaseShiftInvisibilityFlagByte=0
	constant integer PhaseShiftInvisibilityFlagByteFixed0x26=0x00000060
	constant integer PhaseShiftInvisibilityFlagByteFixed0x27=0x00000060
	
	integer pMemcpy
	integer pSearchStringValue
	integer pSearchStringAddr1
	integer pSearchStringAddr2
	
	integer pReservedMemoryForUpdateFrameText
	
	integer pSimulateAttackInstance
	integer pGameTime
	
	integer pToggleForcedSubSelection=0
	integer pToggleBlockKeyAndMouseEmulation=0
	integer pToggleClickHelper=0
	
	integer pSetStunToUnitTRUE 
	integer	pSetStunToUnitFALSE 
	
	integer pReservedMemoryForSystemTime
	integer pGetLocalTime=0
	
	integer pCommonSilence
	integer pAddSilenceOnAbility
	integer pRemoveSilenceFromAbility
	integer pPauseUnitDisabler
	
	integer pUpdateUnitsSpeedCurrent
	
	integer pSendMessageToChat=0
	integer pCastSilenceToTarget
	integer pCastAbility=0
	
	integer pDamageBlockIllusionCheck=0
	
	integer pItemDropOrderTriggerFix=0
	
	integer pFixModelCollisionSphere=0
	
	integer pGetOrLoadFile
	integer pApplyTerrainFilterDirectly=0
	integer pSetMainFuncWork=0
	integer pFixModelTexturePath=0
	
	integer StoreIntegerOffset = 0
	integer StoreIntegerUnlocker = 0
	boolean StoreIntegerLocked = false
	
	integer pPatchModel = 0
	integer pChangeAnimationSpeed = 0
	integer pSetSequenceValue = 0
	integer pSetModelScale = 0
	integer pRedirectFile = 0
	
	integer pReservedMemoryForMissileHandler=0
	integer pReservedMemoryForDamageHandler=0
	integer pReservedMemoryForAttackPrepareHandler=0
	
	integer pReservedMemoryForPacketHandler=0
	integer pReservedMemoryForPacketHandler2=0
	integer pReservedMemoryForPacketHandler3=0
	integer pPacketHandler=0
	integer pPacketHandler2=0
	integer pPacketHandler3=0
	integer pPacketHandler4=0
	integer pPacketHandler5=0
	
	integer pUnitVtable = 0
	integer pRealUnitDamageHandler = 0
	integer pTriggerExecute = 0
	integer pDamageTarget = 0
	integer pMissileEspData = 0
	integer pDamageEspData = 0
	integer pMissileFuncStart = 0
	integer pMissileJumpBack = 0
	integer pFreeExecutableMemory = 0
	integer pJassLog = 0
	
	integer pARealUnitDamageHandler = 0
	integer pADamageTarget = 0
	integer pADamageEspData = 0
	
	integer pMissChanceCalculationResult = 0
	integer pMissChanceCalculationAttacker=0
	integer pMissChanceCalculationTarget=0
	integer pMissChanceCalculationIsRanged=0
	
	integer pCallFastCallWith1Args=0
	integer pCallFastCallWith2Args=0
	integer pCallFastCallWith3Args=0
	integer pCallFastCallWith4Args=0
	integer pFUCKINGCallWith4Args=0
	integer pCallFastCallWith5Args=0
	integer pCallFastCallWith6Args=0
	integer pCallFastCallWith7Args=0
	integer pCallFastCallWith8Args=0
	integer pCallFastCallWith11Args=0
	integer pCallFastCallWith12Args=0
	integer pCallStdcallWith1Args=0
	integer pCallStdcallWith2Args=0
	integer pCallStdcallWith3Args=0
	integer pCallStdcallWith4Args=0
	integer pCallStdcallWith5Args=0
	integer pCallStdcallWith6Args=0
	integer pCallStdcallWith7Args=0
	integer pCallCdeclWith1Args=0
	integer pCallCdeclWith2Args=0
	integer pCallCdeclWith3Args=0
	integer pCallCdeclWith4Args=0
	integer pCallCdeclWith5Args=0
	integer pCallCdeclWith6Args=0
	integer pGetAbilityOrderID=0
	
	integer pTriggerRegisterPlayerKeyboardEvent=0
	
	integer pKeyAddr = 0
	integer pKeyEvent = 0
	
	integer pItemDataNode=0
	integer pMissTexttag=0
	integer pBountyTextTag=0
	
	integer pPlaySoundOfAbility=0
	integer pBlockKeyAction=0
	integer pAddKeyButtonAction=0
	
	integer pMinimapData=0
	integer pRemoveBuffs=0
	integer pMapGridData=0
	integer pMapGridDataSource=0
	integer pGetBuffTooltipsFunc=0
	integer pSkipBuffExistCheck=0
	integer pSkipBuffExistCheckDefaultData=0
	integer pSkipBuffExistCheckFoolish=0
	
	integer pWc3MessageBox=0
	integer pEnableAutoFPSlimit=0
	integer pLockMouseInWindow=0
	integer pSetMaxFps=0
	integer pDrawRegenAllways=0
	integer pFixFPSbyAbso=0
	integer pTeleportHelper=0
	integer pShopHelper=0
	integer pAddTeleportWhiteListKey=0
	integer pFlushInstructionCache=0
	integer pShowConfigWindow=0
	integer pSetManabarEnabled=0
	boolean ManabarDisplayStatus=true
	integer pAddDoubleClickSkillID=0
	
	integer pGetHandleIDStackCounter=0
	integer pConvertAddressToHandleId=0
	
	integer pMorphUnitIntoAnother=0
	integer pRedrawMinimap=0
	
	boolean bTeleportationCanOnlyBeStoppedSoft=false
	boolean bTeleportationCanOnlyBeStopped=false
	
	integer lpFileInformation = 0
	integer pGetFileAttributesExA = 0
	integer pPhoenixFireRemove0Dmg = 0
	integer PhoenixFireRemove0DmgDefaultVal = 0
	integer pShowObserverSkillPanel=0
	integer pShowSkillPanelForAllUnits=0
	integer pInitHPBars=0
	integer pInitMPBars=0
	integer pInitOverlay=0
	integer pGetMagicProtectionForHero=0
	
	boolean GlyphButtonCreated = false 
	boolean GlyphButtonEnabled = true
	integer pSetGlyphButtonEnabled = 0
	integer pCreateGlyphButton = 0
	
	integer pReservedMemoryForBerserkHook=0
	
	integer pBerserkOrderAddr=0
	
	integer pRefreshUnitsCommandPanel=0
	integer pEnableCleaveBaseAddress=0
	integer CleaveFixBaseValue=0
	integer pRedrawUnitFunction=0
	integer pDrawTextAtResourcePanel=0
	integer pConstantReduceOfABlinkRange=0
	integer pUnderRangeJumper=0
	integer UnderRangeJumperFixed=0
	
	integer pInterfaceErrorSimulation=0
	integer pDisableFeatures=0
	integer pEnableFeatures=0
	integer pTeleportShiftKey=0
	integer pAddBorderToIcon=0
	integer pResetShopCooldownFunc=0
	integer pEvasionOrderIdFunction=0
	
	integer pAddFrostColoringToUnit=0
	integer pRemoveFrostColoringToUnit=0
	
	integer pAddRessurectionRedFilterToUnit=0
	
	integer pAgileCpp=0
	integer pLoadingScreenBarFrame=0
	integer pUpdateLoadingBarText=0
	
	integer pDisplayCooldownWhileSilenced=0
	integer DisplayCooldownWhileSilencedDefaultVal=0
	integer pFindGlobalStringAddress=0
	integer FindGlobalStringHash1=0
	integer FindGlobalStringHash2=0
	
	integer pShareVisionWrapper=0
	integer ShareVisionWrapperDefaultValue=0
	integer ShareVisionWrapperBrokenValue=0
	
	integer pNeutralsAuraAggroFix=0
	integer NeutralsAuraAggroFixValue=0
	
	integer pGetAbilityUIDef=0
	integer pGetAbilityUIDefAlt=0
	integer pGetUnitUIDefAddr=0
	
	integer pGetUnitDataDefAddrHelper=0
	integer pGetUnitDataDefAddrStatic=0
	integer pGetUnitDataDefAddr=0
	
	integer pGetAbilityDataDefAddr=0
	
	integer pDisableGlobalMsg=0
	integer pDisableGlobalMsgBroken=0
	integer pDisableGlobalSound=0
	integer pDisableGlobalSoundBroken=0
	
	integer pReservedMemoryForMeleeAttackHook=0
	integer pReservedMemoryForKeyActionHook=0
	integer pReservedMemoryForMissedAttachHook=0
	
	integer pMeleeAttackCatcher=0
	integer pKeyEventCatcher=0
	integer pRecountUnitsCollision=0
	integer pMissCalculations=0
	integer pConvertUnitAddressToHandleIDNative=0

	integer pCreateRawImage=0
	integer pLoadRawImage=0
	integer pRawImage_DrawImg=0
	integer pRawImage_DrawPixel=0
	integer pRawImage_DrawRect=0
	integer pRawImage_DrawLine=0
	integer pRawImage_DrawCircle=0
	integer pRawImage_FillCircle=0
	integer pRawImage_EraseCircle=0
	integer pRawImage_EraseColor=0
	integer pRawImage_LoadFontFromResource=0
	integer pRawImage_SetFontSettings=0
	integer pRawImage_DrawText=0
	integer pSaveRawImageToGameFile=0
	integer pDumpRawImageToFile=0
	integer pGetRawImageByFile=0
	integer pRawImage_GetWidth=0
	integer pRawImage_GetHeight=0
	integer pRawImage_Resize=0
	integer pRawImage_DrawOverlay=0
	integer pRawImage_MoveTimed=0
	integer pSetDefaultSceenSize=0
	integer pRawImage_AddCallback=0
	integer pCallbackSuperData=0
	integer array DataArray1
	integer DataArray1Address=0
	integer pGetFileSizeFromMPQNative=0
	
	integer pSetAutoSelectHero=0
	boolean AutoSelectionOfHeroOnDoubleF=false
	
	constant string GlobalConvertString = "|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||"
	integer GlobalConvertStringAddr = 0
	string GlobalJassString = ""
	integer GlobalJassStringAddr = 0
	
	integer pEndGameNative=0
	integer pGetJassStringCount=0
	integer pScanJassStringForErrors=0
	integer pReplayDesyncScan=0
	integer pFileHelperReleaseStorm=0
	integer pUpdatePlayerCache=0
	integer pMemoryForCallbackOnCustomImages=0
	integer pCleaveConditionHook=0
	integer pReservedMemoryForCleaveCondition=0
	
	integer pOnExitHookAddress=0
	integer pOnExitHookAddressOnRestart=0
	
	integer pWaveTargetingFix=0
	integer pChatMessageDurationDefault=0
	integer pChatMessageDurationDefault2=0
	integer pSpellEffectStarts=0
	
	integer pDisjoingHardcodedMissiles=0
	
	
	timer tt_timer1=null
	hashtable ProPlayersList=InitHashtable()
	unit array InvulDamagers
	boolean array EvasionSourcesActive
	timer array EvasionSourcesTimers
	boolean ThisAttackMissed=false
	constant integer EVASION_SOURCE_ARCWARDEN=0
	constant integer EVASION_SOURCE_DRUNKENBRAWLER=1
	constant integer EVASION_SOURCE_BUTTERFLY=2
	constant integer EVASION_SOURCE_HALBERD=3
	constant integer EVASION_SOURCE_BLUR=4
	constant integer EVASION_SOURCE_SOLARCREST=5
	constant integer EVASION_SOURCE_TALISMAN=6
	constant integer EVASION_SOURCE_WINDRUN=7
	constant integer EVASION_DEBUFF_DRUNKENHAZE=8
	constant integer EVASION_DEBUFF_BITE=9
	constant integer EVASION_DEBUFF_BLINDINGLIGHT=10
	constant integer EVASION_DEBUFF_FEAR=11
	constant integer EVASION_DEBUFF_RADIANCE=12
	constant integer EVASION_DEBUFF_SMOKE=13
	constant integer EVASION_DEBUFF_LASER=14
	constant integer EVASION_DEBUFF_SOLARCREST=15
	constant integer EVASION_DEBUFF_WHIRLINGAXE=16
	constant integer EVASION_BUFF_MKB=17
	constant integer EVASION_BUFF_ATOS=18
	constant integer EVASION_BUFF_SILVEREDGE=19
	constant integer EVASION_BUFF_VENDETTA=20
	integer SmokeScreenLevel=0
	boolean DetailedSpellInfoDisplaying=false
	constant integer OCTARINECOOLDOWNREDUCE=25
	unit RadianceSourceUnit=null
	boolean WTFModeActive=false
	hashtable HeroStats=InitHashtable()
	hashtable UMD=InitHashtable()
	hashtable UnitStats=InitHashtable()
	hashtable MHT = InitHashtable()
	hashtable HY=InitHashtable()
	hashtable UTable=InitHashtable()
	hashtable PRDtable=InitHashtable()
	hashtable ItemCosts=InitHashtable()
	hashtable CooldownStorage=InitHashtable()
	hashtable HeroRelatedData=InitHashtable()
	hashtable ItemsData=InitHashtable()
	hashtable SCMD=InitHashtable()
	hashtable TempHash=InitHashtable()
	constant integer PURGEBUFFID='PRGA'
	constant integer PURGEDEBUFFID='PRGE'
	constant integer PURGECOMMONID='PRGC'
	constant integer PURGEENTANGLE='PRGN'
	constant integer PURGESLOW='PRGS'
	constant integer PURGESILENCE='PRGI'
	constant integer MCRESTRICTED='MCRS'
	constant integer PURGEDEBUFFIDHIGH='PRGH'
	boolean VladmirOfferingInGame=false
	integer array MaxHPBonusSystem
	group AllEnteredHeroesGroup=CreateGroup()
	group ShareExpGroup=CreateGroup()
	trigger WardsAttackersLogic=null
	group FountainGroup=CreateGroup()
	constant real BUYBACKBOUNTYFACTOR=0.4
	boolean doubledBounty=true
	boolean MjollnirsExists=false
	boolean IsRGC=false
	boolean MortalWoundsDamage=false
	boolean IsRuneFirstSpawn=true
	constant integer EMPTYDUMMY='n07D'//n07D -> You pick a hero for your opponent.
	boolean advancedTracking=false
	real OF8
	trigger GenericHeroDamagedTrigger=null
	trigger RecreationTrigger=null
	integer GroupErrorCounter=0
	trigger CourierDamageTracker=null
	boolean UDSG_IsOrb=false
	boolean TempestIncoming=false
	unit ADSG_Victim=null
	unit ADSG_Killer=null
	boolean SDBotherWithHeroDoubles=true
	integer HeroSDLimit=0
	boolean Mode_Debug=false
	boolean Mode_MA=false
	rect RoshAbuseRect
	boolean ISRECIPECLICK=false
	boolean IsUrnDamage=false
	boolean HeroLeoricExists=false
	boolean SilverEdgeExists=false
	boolean RadianceDamage=false
	boolean LotusUnloopBool=false
	boolean IsL1ch=false
	real array TotalDamage2Heroes
	real array TotalDamage2Towers
	timer DummyDamageTimer=null
	boolean DummyDamageState=false
	integer isMineDamage=0
	integer asdasd=0
	trigger AegisHelper=null
//	integer array dstr
	sound gg_snd_DarkSummoningLaunch1
	sound gg_snd_PossessionMissileLaunch1
	sound sound068
	integer array AlchemistBonus
	group FleshGolems=CreateGroup()
	integer array HeroDummy
	boolean HeroInGame_BS=false
	boolean HeroInGame_Queen=false
	trigger DamageRegister
	region ExtraBoundaries=null
	region ExtraBoundariesAdv=null
	integer NoReflection=0
	integer FakeDamageType=0
	region SentFountainReg
	region ScourgeFountainReg
	group CouriersSummoned=CreateGroup()
	integer UDSTriggers=0
	boolean DesolatorExists=false
	boolean DiffusalBladeExists=false
	boolean QuellingBladeExists=false
	boolean SkadiExists=false
	boolean OrbOfVenomExists=false
	boolean tranquilsExists=false
	unit UDSG_Attacker
	unit UDSG_Target
	real UDSG_Dmg
	integer UDSG_TempInt
	rect WardAbuseRect
	trigger MeleeRangeItemsSwitcher
	integer array amhc
	unit array lastunit1
	unit array lastunit2
	integer array counter1
	boolean array testr1
	boolean array testr2
	unit ShowPickUnit
	trigger GenericTowerDamageCounterTrigger=null
	unit VisPickUnit
	unit ShowTUnit
	trigger TriggerEn1
	trigger TriggerEn2
	timer TimerMh
	boolean DicktB=true
	integer array TempDataInt
	player tt_player3
	real TempReal2
	constant integer HOTKEY=StringHash("hotkey")
	unit PreloaderUnit
	integer movespeedactive=0
	unit AltarOfRandom
	integer array BonusEffects
	integer array ClearCounter
	real array TxtDur
	integer array NetWorthsNoGold
	boolean array NetWorthRecount
	unit AddTime1
	unit AddTime2
	unit AddTime3
	unit AddTime4
	boolean FBHappened=false
	constant integer TEMPEST=StringHash("tempest")
	integer buybackC=-1
	group ABDGroup
	trigger TreeRevivalTrigger
	boolean array ShakingOn
	
	integer TC_es_lvl
	boolean IsOrbAttack=false
	boolean array BottlePickupRunesOldfashion
	integer array NetWorths
	timer ShoppingPeriodic
	rect ShoppingSquare
	unit ShoppingUnit
	trigger ES_Aftershock
	integer array stuns
	
	rect RoshanCanWalkHere
	group TrampleTempGroup
	trigger ShowSkillsOnSelectT
	integer maxSkillId=0
	boolean array ShowSkills
	
	integer TempInt
	integer Shredder_TempInt
	integer Rubick_TempInt
	integer Phoenix_TempInt
	integer Zeus_TempInt
	integer array FleshHeapCount
	integer Potm_Leap_lvl
	unit EchoSlam_Caster
	unit Skewer_Caster
	integer Skewer_lvl
	real Skewer_x
	real Skewer_y
	boolean array HideMorphIcon
	unit Lesh_TempUnit
	real Lesh_TempReal
	boolean array RGCFFed
	unit CausticFinal_SK
	real CausticFinal_dmg
	unit RealityTempUnit
	integer Silencer_CurseOfSilence_Level=0
	real LightningGrappleAngle
	unit LightningGrappleUnit
	real LightningGrappleDmg
	integer StaticChargeCounter
	unit StaticChargeCaster
	unit Lion_Finger_TempUnit
	real THD_TempReal1
	real THD_TempReal2
	real THD_TempReal3
	real THD_TempReal4
	real THD_TempReal5
	real THD_TempReal6
	
	rect FountainRectSent
	rect FountainRectScourge
	group FountainGroup1=CreateGroup()
	group FountainGroup2=CreateGroup()
	
	unit Traxex_Gust_Tempunit=null
	real Traxex_Gust_TempX
	real Traxex_Gust_TempY
	group Traxex_Gust_TempGroup
	
	
	
	boolean array PlayerHaveHero
	
	sound Sound_Tick
	real ForceOfNatureX
	real ForceOfNatureY
	boolean ForceOfNatureMC=false
	
	player TempPlayer
	
	integer LastRoshanSlayer=0
	real array ResetCooldown
	real array ReadyCooldown
	boolean AghBlackHoleDamage
	real Queen_SnatchedHP=999999
	unit Queen_SnatchedUnit=null
	unit Queen_TempUnit=null
	integer Queen_TempInt=0
	integer Queen_TempInt2=0
	unit SpitTempUnit
	boolean FlyingCourierAllowed=false
	
	real ThirstInterval=0.015
	unit array BugHunterProviders
	real zOffsetDebug=.0
	
	unit BroodWebTemp
	boolean IsCorrosiveSkinDamage=false
	integer array DisablesList
	integer DisablesListCount=0
	integer array SDHeroesPoolInc
	integer array SDHeroesIDs
	constant string EmptySlotPath="UI\\Widgets\\Console\\Undead\\undead-inventory-slotfiller.blp"
	constant integer VS=1
	constant integer Zeus=2
	constant integer Enchantress=3
	constant integer Morphling=4
	constant integer indexid_CM=5
	constant integer Sven=6
	constant integer NagaSiren=7
	constant integer ES=8
	constant integer Riki=9
	constant integer LoneDruid=10
	constant integer Lina=11
	constant integer Juggernaut=12
	constant integer Silencer=13
	constant integer Treant=14
	constant integer Chieftain=15
	constant integer Kotl=16
	constant integer Ursa=17
	constant integer OgreMagi=18
	constant integer Tinker=19
	constant integer Furion=20
	constant integer PL=21
	constant integer Tiny=22
	constant integer Techies=23
	constant integer Chen=24
	constant integer Luna=25
	constant integer Sniper=26
	constant integer Troll=27
	constant integer Rhasta=28
	constant integer Wisp=29
	constant integer Pandaren=30
	constant integer Centaur=31
	constant integer Bounty=32
	constant integer indexid_DK=33
	constant integer indexid_AM=34
	constant integer Trax=35
	constant integer Omni=36
	constant integer Beastmaster=37
	constant integer THD=38
	constant integer Alchemist=39
	constant integer Potm=40
	constant integer Storm=41
	constant integer Huskar=42
	constant integer Lanaya=43
	constant integer Puck=44
	constant integer Clock=45
	constant integer Admiral=46
	constant integer WR=47
	constant integer Gyro=48
	constant integer Disruptor=49
	constant integer Tusk=50
	constant integer Phoenix=51
	constant integer BB=52
	constant integer Rubick=53
	constant integer Xin=54
	constant integer Legion=55
	constant integer Skywrath=56
	constant integer Timber=57
	constant integer Lycan=58
	constant integer Brood=59
	constant integer PA=60
	constant integer Medusa=61
	constant integer Bala=62
	constant integer Leoric=63
	constant integer Doom=64
	constant integer NA=65
	constant integer Slardar=66
	constant integer QoP=67
	constant integer Bone=68
	constant integer Void=69
	constant integer Viper=70
	constant integer Razor =71
	constant integer Lifestealer =72
	constant integer Pugna =73
	constant integer Tide =74
	constant integer Bane =75
	constant integer Necrolyte =76
	constant integer Pudge =77
	constant integer Barathum =78
	constant integer Weaver =79
	constant integer indexid_SF =80
	constant integer SK =81
	constant integer Axe =82
	constant integer BS =83
	constant integer Abaddon =84
	constant integer Spectre =85
	constant integer WD =86
	constant integer OD =87
	constant integer WL =88
	constant integer Geomancer =89
	constant integer Dazzle =90
	constant integer Pit =91
	constant integer Zombie =92
	constant integer DS =93
	constant integer Kodo =94
	constant integer Enigma =95
	constant integer Batrider =96
	constant integer indexid_AA =97
	constant integer Slark =98
	constant integer TB =99
	constant integer Leshrak =100
	constant integer indexid_SD =101
	constant integer Lich =102
	constant integer Banshee =103
	constant integer Lion =104
	constant integer Veno =105
	constant integer Magnus =106
	constant integer Visage =107
	constant integer Nessaj =108
	constant integer Wyvern =109
	constant integer Zet =110
	constant integer Earth =111
	constant integer Oracle =112
	constant integer Crabe =113
	constant integer Sieger =114
	constant integer Sorcesser =115
	constant integer Invoker =116
	constant integer Formless =117
	constant integer SpaceOrc =118
	constant integer OgreLord =119
	constant integer FireLord =120
	constant integer Queen =121
	
	boolean quest_test=false
	
	group TempGroup
	
	boolean NeedBoost=true
	integer array ArmletStrBonus
	
	//trigger CustomUnitBountySystem
	constant integer EXPAOE=1325
	unit GlobalKiller=null
	integer GlobalKillerExp
	boolean SacrificedByLich=false
	integer array SpawnHistory
	integer array EvasionContainers
	

	integer array BonusMSPercentSystem
	
	constant integer COLOR=StringHash("color")
	constant integer BOUNTYL=StringHash("bounty_lowest")
	constant integer BOUNTYH=StringHash("bounty_highest")
	constant integer SIGHT=StringHash("sight")
	constant integer NSIGHT=StringHash("nsight")
	constant integer EXP=StringHash("expirience")
	
	
	real TempReal
	integer MORPH_MIN_STATS=5
	integer Lich_MorphedSkillId
	integer TempInteger
	timer DarknessTimer=CreateTimer()
	
	boolean array HidePassivesForPlayer
	
	integer IsFakeDamage=0
	integer array PassivesRealID
	integer array PassivesSpellbookID
	integer array PassivesLearningSkill
	integer array PassivesBuffID
	integer array PassivesLearningSkillUpg
	integer array PassivesVisualID
	
	integer PassivesCount=0
	
	integer array AghaUpgradeID
	integer array AghaBaseSpellID
	integer array AghaUpgradedSpellID
	integer array AghaVisualId
	integer AghaCounter=1
	
	real DoubleEdgeDamage
	unit DoubleEdgeCaster
	integer array Prevent100GoldPerSwap
	boolean array IsImpossibleToBuyback
	
	
	group g_TrueshotGroup=CreateGroup()
	unit TrueshotBearer=null
	player TrueshotPlayer=null
	integer TrueshotDmg
	boolean TrueshotAlive=false
	
	unit Oracle_TempCaster
	unit Oracle_TempDummy
	integer Oracle_TempLvl
	
	integer array BerserkerBloodResistCont
	
	unit Medusa_StoneGaze_TempUnit
	
	trigger trig_WintersCurse
	unit unit_WinterCurseTarget
	group group_WinterCurse
	unit unit_WinterCurseCaster
		
	unit Wyvern_SplinterBlast_InitialCaster
	unit Wyvern_SplinterBlast_Helper
		
	unit TempCaster
	unit TempTarget
	trigger TempTrigger
	integer KaolinGGTempLvl
	integer KaolinGGBuffedByStone
	unit KaolinGGTempUnit
	group KaolinGGTempGroup
	real KaolinGeoGripTempX
	real KaolinGeoGripTempY
	integer KaolinTempRollingLvl
	boolean KaolinRollingBoulderTempBool
	integer KaolinTempRollingBuffed
	real KaolinTempRollingDamage
	group KaolinTempRollingGroup
	unit KaolinTempRollingCaster
	unit KaolinClosestTarget
	unit KaolinRollingTempUnit
	unit KaolinTempCaster
	unit KaolinPushedUnit
	unit KaolinSmashTempUnit
	unit KaolinMagnetizeTempCaster
	unit KaolinMagnetizeTempVictim
	group Kaolin_PushSmashedGroup
	integer KaolinTempInteger
	integer KaolinsPushLevelStorage
	real KaolinDistanceTemp
	real KaolinPushDamage
	// LoD Globals - new
	//===================================================

	trigger GAME_TRIGGER = CreateTrigger()
	trigger CHAT_TRIGGER = CreateTrigger()
	location ZeroLocation = Location(0,0)
	//boolean Mode_FF = false


	//used for the buff system
	//==============================		
	integer array LoDBuff_AbilID
	integer array LoDBuff_BuffID

	//used for the stats system
	//==============================
	constant integer LoDArmourAbilityBase	 = 'AA00'
	constant integer LoDArmourAbilityCount	= 8
	constant integer LoDArmourNegAbilityBase  = 'AG00'
	constant integer LoDArmourNegAbilityCount = 8
	constant integer LoDDamageAbilityBase	 = 'AB00'
	constant integer LoDDamageAbilityCount	= 12
	constant integer LoDRegenAbilityBase	  = 'AC00'
	constant integer LoDRegenAbilityCount	 = 6
	constant integer LoDManaRegenAbilityBase  = 'AD00'
	constant integer LoDManaRegenAbilityCount = 6
	constant integer LoDAttackAbilityBase	 = 'AE00'
	constant integer LoDAttackAbilityCount	= 10
	constant integer LoDAttackNegAbilityBase  = 'AF00'
	constant integer LoDAttackNegAbilityCount = 10
	constant integer LoDDamageNegAbilityBase  = 'AI00'
	constant integer LoDDamageNegAbilityCount = 12

	//used for group functions - if you see any of these variables used, replace it by something else
	//==============================
	unit array group_temp_unit
	real array group_temp_real
	integer array group_temp_integer
	boolean group_temp_boolean = false
	player group_temp_player = null
	group group_temp_group = null
	group temp_group = CreateGroup()
	group temp_group2 = CreateGroup()

	// LoD Globals - stable
	//===================================================
	integer array CanAddTime
	
	boolean IsRealDamage=true
	real GetUnitPhysicalResistance_Result=1
	boolean LOLWTF=false
	trigger LOLWTF_Trig
	unit Shadowraze_Source=null
	integer Shadowraze_Level
	unit Netherblast_Source=null
	integer Netherblast_Level
	integer array HeroTypeId
	integer array AlternateSkillID
	boolean array CourierDead
	unit LoDMoonGlaive_Source
	unit LoDMoonGlaive_Origin
	unit LoDMoonGlaive_Target
	real LoDMoonGlaive_MaxDistance
	unit RipTideSource=null
	group RipTideAlreadyHit=null
	integer NumberOfHeroes=119
	constant integer PlayerSkillOffset=6
	integer baseCreepSpawnTime=90
	integer CreepSpawnTimeForSD=150
	integer CreepSpawnTimeForMD=150
	integer CreepSpawnTimeForRD=240
	constant integer EssenceShiftHash=StringHash("essenceshift")
	integer MaximumLevel=25
	boolean array b_isDamageShowed
	integer array DPS
	integer array PlayersId
	boolean array PlayerFFed
	boolean GameWasFFed=false
	string TabTab="		"
	boolean b_isPickTime=true
	string s_MainMode=""
	string ModeForTitle
	integer array OneSkillCheckArray
	integer OneSkillOffsetCheck=1000
	integer NumberOfExtraAbilities=0
	integer array ExtraAbilityLevel
	integer i_BonusDraftAmount=0
	integer array i_BonusHeroCounter
	boolean array b_HeroAvailableForPlayer
	boolean array b_isPlayerReady
	boolean b_AllPlayersReady=false
	multiboard AbilityDraftMultiboard=null
	unit array SpellPickingDummy
	boolean array b_IsHeroAlreadyPreloaded
	integer array SelectedSkillHeroPointValue
	//integer array UltimatesHeroId
	integer array MeleeOrRangedRestricted
	integer array HeroNumArrayRandomized
	integer array PlayerSkillNumber
	string array SkillIcon
	integer array SkillID
	integer array EngineeringUpgradeSkillID
	string array BalanceStrings
	string array ExBalanceStrings
	boolean array IsPassiveAbility
	boolean array IsMultiIconAbility
	boolean array IsPermanentAbility
	boolean array IsAbilityDoesNotWork
	integer array Kills
	integer array Deaths
	integer array PlayerCS
	integer array CSDenies
	integer array CSNeutrals
	integer array Assists
	integer array ItemStats_Consumables
	integer array ItemStats_Wards
	integer array PlayerGoldLost
	integer array PlayerBestStreak
	integer array DoubleKills
	integer array TrippleKills
	integer array PlayerTimeDead
	integer array PlayerTowersDenied
	integer array GoldEarnedByKills
	integer array PlayerTowersKilled
	integer array PlayerAPM
	real array LastTimeActivity
	timer GlobalTimer=null
	real GameStartsTime=0
	boolean array b_isHeroPicked
	boolean array IsHeroIngame
	integer array PlayerKillsStreak
	integer array MultikillCounter
	integer array OwningCounter
	boolean IsHeroesAvailable=false
	string array udg_Colors
	boolean array RepickHasBeenUsed
	timer array MultikillTimers
	timer array HeroRespawnTimer
	integer MinutesForTime=0
	integer SecondsForTime=0
	integer array DM_Counter
	boolean Mode_DM=false
	boolean Mode_SO=false
	boolean Mode_AR=false
	boolean Mode_RD=false
	integer Mode_RD_Count=14
	boolean Mode_TR=false
	boolean Mode_AP=false
	boolean Mode_ID=false
	boolean Mode_AH=false
	multiboard MainMB=null
	unit Roshan=null
	boolean array HasUsedRandom
	integer MinGoldForRepick=150
	boolean Mode_EM=false
	boolean Mode_NP=false
	boolean Mode_SC=false
	location FrozenThroneLoc=null
	location TreeOfLifeLoc=null
	location MidCreepsWaypoint=null
	location TopCreepsWaypoint=null
	location BottomCreepsWaypoint=null
	boolean ElfTopRaxRExists=true
	boolean ElfMidRaxRExists=true
	boolean ElfBotRaxRExists=true
	boolean ElfTopRaxMExists=true
	boolean ElfMidRaxMExists=true
	boolean ElfBotRaxMExists=true
	boolean UndTopRaxRExists=true
	boolean UndMidRaxRExists=true
	boolean UndBotRaxRExists=true
	boolean UndTopRaxMExists=true
	boolean UndMidRaxMExists=true
	boolean UndBotRaxMExists=true
	integer MeleeCreepsAmount=3
	integer RangeCreepsAmount=1
	location ScourgeMidMeleeSpawn=null
	location ScourgeTopMeleeSpawn=null
	location ScourgeBottomMeleeSpawn=null
	location ScourgeMidRangeSpawn=null
	location ScourgeBottomRangeSpawn=null
	location ScourgeTopRangeSpawn=null
	location SentinelMidMeleeSpawn=null
	location SentinelBottomMeleeSpawn=null
	location SentinelTopMeleeSpawn=null
	location SentinelMidRangeSpawn=null
	location SentinelBottomRangeSpawn=null
	location SentinelTopRangeSpawn=null
	location TopRuneSpawn=null
	location BottomRuneSpawn=null
	unit array udg_Hero
	integer M1=0
	integer N1=0
	player array Sents
	player array Scrgs
	integer array DM_LivesUsed
	unit array DM_PrevHero
	integer array OO
	force Force_Elfs=null
	force Force_Unds=null
	player array Sentinels
	player array Scourges
	player Neutrals=null
	constant player Player15=Player(15)
	boolean Mode_SP=false
	integer VO=0
	integer array WO
	player PlayerModeTyper=null
	unit TmpUnit376=null
	integer TmpInt377=0
	real TmpReal378=0
	constant integer WaypointAbilID='A06G'//A06G -> Creep next waypoint
	location array WaypointLocations
	group TempGroup2=null
	boolean udg_ObserverMode=false
	boolean E2=false
	boolean Mode_DU=false
	boolean Mode_AA=false
	boolean Mode_AI=false
	boolean Mode_AS=false
	string FullModesString=""
	boolean Mode_SH=false
	boolean Mode_Normal=true
	player tt_player2=null
	integer array ItemsAbilities2
	integer ItemsAbilitiesMax2=0
	force AllPlayers=null
	boolean GameEnded=false
	boolean O3=false
	boolean RandomAllowed=true
	boolean RepickAllowed=true
	boolean array HasAlreadyPickedHero
	string MainModeInTxt=""
	boolean array G3
	boolean H3=false
	boolean Z3=false
	location Y3=null
	string K3=""
	string array LeftAt
	rect ScouBotMeleeSpawnRect=null
	rect ScouMidMeleeSpawnRect=null
	rect ScouTopMeleeSpawnRect=null
	rect gg_rct_Hero_Creation_UD=null
	rect SentBotRangeSpawnRect=null
	rect SentTopRangeSpawnRect=null
	rect SentMidRangeSpawnRect=null
	rect ScouBotRangeSpawnRect=null
	rect ScouMidRangeSpawnRect=null
	rect ScouTopRangeSpawnRect=null
	rect gg_rct_Hero_Creation_NE=null
	rect SentBotMeleeSpawnRect=null
	rect SentTopMeleeSpawnRect=null
	rect SentMidMeleeSpawnRect=null
	rect BottomRuneSpawnRect=null
	rect F4=null
	rect G4=null
	rect TopRuneSpawnRect=null
	rect NR_Und_Ar=null
	rect NR_Elf_Ar=null
	rect NR_Elf_Cr=null
	rect NR_Und_Bpr=null
	rect NR_Und_Pr=null
	rect NR_Elf_Pr=null
	rect NR_Und_TRr=null
	rect NR_Elf_BRr=null
	rect NR_Und_BBr=null
	rect NR_Elf_OldSmr=null
	rect gg_rct_Allpick_Sent=null
	rect gg_rct_Allpick_Scourge=null
	rect RoshanSpawnRect=null
	rect NR_Und_A=null//Neutral Rects: Undead - Ancient
	rect NR_Elf_A=null
	rect NR_Elf_C=null
	rect NR_Und_Bp=null
	rect NR_Und_P=null
	rect NR_Elf_P=null
	rect NR_Und_TR=null
	rect NR_Und_BB=null
	rect NR_Elf_BR=null
	rect NR_Elf_OldSm=null
	rect FountainRectFrogSent=null
	rect FountainRectFrogScourge=null
	rect NR_Uld_OldSm=null
	rect NR_Uld_OldSmr=null
	rect NR_Elf_Roof=null
	rect NR_Elf_Roofr=null
	rect J5=null
	rect A6=null
	rect E6=null
	rect IA=null
	rect OA=null
	rect BA=null
	rect CA=null
	rect DA=null
	rect EA=null
	rect Waypoints_ScMidSpawn=null
	rect Waypoints_ScTopSpawn=null
	rect Waypoints_ScBotSpawn=null
	rect Waypoints_SentBotSpawn=null
	rect Waypoints_SentMidSpawn=null
	rect Waypoints_SentTopSpawn=null
	sound OC=null
	sound AC=null
	sound BC=null
	sound Sound_AxeKillFX=null
	sound Sounds_Dominating=null
	sound Sounds_DK=null
	sound Sounds_FB=null
	sound Sound_TechiesLaugh=null
	sound Sounds_Godlike=null
	sound Sounds_HolyShit=null
	string XC="Sound\\Music\\mp3Music\\Human1.mp3"
	string YC="Sound\\Music\\mp3Music\\Human2.mp3"
	string JC="Sound\\Music\\mp3Music\\Human3.mp3"
	sound KC=null
	sound LC=null
	sound Sounds_KillingSpree=null
	sound NC=null
	sound Sounds_Megakill=null
	sound SoundMeld=null
	sound Sounds_Monsterkill=null
	string QC="Sound\\Music\\mp3Music\\NightElf1.mp3"
	string UC="Sound\\Music\\mp3Music\\NightElf2.mp3"
	string ODs="Sound\\Music\\mp3Music\\NightElf3.mp3"
	string BD="Sound\\Music\\mp3Music\\Orc1.mp3"
	string DD="Sound\\Music\\mp3Music\\Orc2.mp3"
	string ED="Sound\\Music\\mp3Music\\Orc3.mp3"
	string FD="Sound\\Music\\mp3Music\\BloodElfTheme.mp3"
	string GD="Sound\\Music\\mp3Music\\DarkAgents.mp3"
	string HD="Sound\\Music\\mp3Music\\TragicConfrontation.mp3"
	string ZD="Sound\\Music\\mp3Music\\SadMystery.mp3"
	string VD="Sound\\Music\\mp3Music\\IllidansTheme.mp3"
	sound Sounds_Ownage=null
	sound TD=null
	sound QD=null
	sound Sounds_TrippleKill=null
	string IE="Sound\\Music\\mp3Music\\Undead1.mp3"
	string OE="Sound\\Music\\mp3Music\\Undead2.mp3"
	string AE="Sound\\Music\\mp3Music\\Undead3.mp3"
	sound Sounds_Unstoppable=null
	sound CE=null
	sound DE=null
	sound Sounds_WickedSick=null
	sound FE=null
	sound GE=null
	sound XE=null
	sound Sounds_UltraKill=null
	sound Sounds_Rampage=null
	sound ME=null
	sound NE=null
	sound SE=null
	sound RE=null
	sound PE=null
	sound ResQFun=null
	sound QE=null
	sound IF=null
	sound OF=null
	sound AF=null
	sound BF=null
	string DF="Sound\\Music\\mp3Music\\Tension.mp3"
	string EF="Sound\\Music\\mp3Music\\ArthasTheme.mp3"
	string FF="Sound\\Music\\mp3Music\\NightElfDefeat.mp3"
	string GF="Sound\\Music\\mp3Music\\NightElfVictory.mp3"
	sound ZF=null
	sound VF=null
	sound WF=null
	sound XF=null
	sound KF=null
	sound LF=null
	sound MF=null
	sound SF=null
	trigger AddExtraRangeCreepTrigger=null
	trigger AddExtraMeleeCreepTrigger=null
	trigger AG=null
	trigger Elf_Rax_Range_Top_Deathward=null
	trigger Elf_Rax_Range_Mid_Deathward=null
	trigger Elf_Rax_Range_Bot_Deathward=null
	trigger Elf_Rax_Melee_Top_Deathward=null
	trigger Elf_Rax_Melee_Mid_Deathward=null
	trigger Elf_Rax_Melee_Bot_Deathward=null
	trigger Und_Rax_Range_Top_Deathward=null
	trigger Und_Rax_Range_Mid_Deathward=null
	trigger Und_Rax_Range_Bot_Deathward=null
	trigger Und_Rax_Melee_Top_Deathward=null
	trigger Und_Rax_Melee_Mid_Deathward=null
	trigger Und_Rax_Melee_Bot_Deathward=null
	trigger JG=null
	trigger KG=null
	trigger LG=null
	trigger MG=null
	trigger NG=null
	trigger SG=null
	trigger TG=null
	trigger QG=null
	trigger DummyUtilizator=null
	trigger IH=null
	trigger OH=null
	trigger JH=null
	unit ScouBaseWaypointDummy=null
	unit TopWaypointDummy=null
	unit SentBaseWaypointDummy=null
	unit BottomWaypointDummy=null
	unit MidWaypointDummy=null
	unit GoblinMerch_Top=null
	unit GoblinShop_Top=null
	unit GoblinShop_Bot=null
	unit FurbolgHut_Top=null
	unit FurbolgHut_Bot=null
	unit GoblinMerch_Bot=null
	string HCLstring=""
	destructable array JY
	destructable array KY
	destructable array LY
	integer MY=0
	group array groups
	boolean array GroupTaken
	integer GroupsFirstHandle
	integer GroupsInt=0
	trigger array QY
	real array UY
	integer IJ=0
	boolean array IsHeroDead
	real array AJ
	integer array BJ
	integer array CJ
	integer DJ=0
	string array EJ
	integer array FJ
	integer GJ=0
	string HJ
	real ZJ
	integer TreesKilled=0
	sound WJ
	integer tt_int1=0
	real tt_real1
	real tt_real2
	real TJ
	real RJ
	unit tt_unit1
	unit tt_unit2
	unit tt_unit3
	item tt_item1=null
	trigger AddProjectileTrigger
	group DK
	group EK
	player tt_player1
	boolean tt_bool1=false
	image tt_image1=null
	unit VK=null
	integer WK
	boolean NoHeroLimitOff=true
	trigger YK
	trigger JK
	region KK
	integer LK=1
	boolean MK=false
	timer NK
	boolean ModePickedBool=false
	integer CreepSpawnTime=90
	boolean IsGameStartedAnotherBool=false
	boolean PK=false
	string ModeNameString="No Mode"
	boolean Mode_NR=false
	boolean Mode_NS=false
	boolean Mode_PM=false
	boolean BL=false
	boolean Mode_NoDeath=false
	integer ModeDM_MaxLifes
	integer array SL
	integer array RollCounter
	boolean array ShowRollNumbers
	boolean array SoundsMuted
	boolean array CSONStatus1
	boolean array ShowCourierIcon
	unit IM=null
	unit AM=null
	boolean BM=false
	player FM=null
	player GM=null
	boolean array HM
	integer VM
	player WM
	trigger XM=null
	boolean YM=false
	integer JM
	integer KM
	boolean Mode_CD=false
	trigger HeroEnters
	boolean QM=false
	boolean IsRemoteMinesBlast=false
	integer array Razor_EyeOfStormContainers
	region RestrictedRegion
	constant real ZN=150
	integer array DispellableBuffs
	integer DispellableBuffs_i=0
	integer array Tints_R
	integer array Tints_G
	integer array Tints_B
	integer array Tints_ID
	integer Tints_C=0
	gamecache GCM
	gamecache RGCGC
	gamecache RGCGC2
	gamecache RGCGC3
	integer array BonusDamageSystemCont
	integer array HPBonusSystem
	integer array NegativeArmorSystem
	trigger PN
	integer array BuybackUnitId
	integer array BuybackID
	integer array BuybackUnitCost
	weathereffect Weather_Moonlight=null
	weathereffect Weather_Wind=null
	weathereffect Weather_Snow=null
	weathereffect Weather_Rain=null
	weathereffect Weather_Random
	rect CS
	constant playercolor PlayColor0=ConvertPlayerColor(0)
	constant playercolor PlayColor6=ConvertPlayerColor(6)
	constant playercolor PlayColor12=ConvertPlayerColor(12)
	constant real HS=-7232
	constant real ZS=-7136
	unit SentFountain
	unit SentinelBuilding_BlackMarket1
	unit SentinelBuilding_BlackMarket2
	unit SentinelBuilding_ShopCache
	unit SentinelBuilding_ShopWeapon
	unit SentinelBuilding_ShopAccessorizer
	unit SentinelBuilding_ShopChimaera
	unit SentinelBuilding_Shop1
	unit SentinelBuilding_Shop2
	unit SentinelBuilding_Shop3
	unit SentinelBuilding_Shop4
	unit SentinelBuilding_Shop5
	unit SentinelBuilding_Shop6
	unit TreeOfLife
	unit Towers_Sent_Top_1
	unit Towers_Sent_Mid_1
	unit Towers_Sent_Bot_1
	unit Towers_Sent_Top_2
	unit Towers_Sent_Mid_2
	unit Towers_Sent_Bot_2
	unit Towers_Sent_Top_3
	unit Towers_Sent_Mid_3
	unit Towers_Sent_Bot_3
	unit Towers_Sent_Tree1
	unit Towers_Sent_Tree2
	unit Elf_Rax_Melee_Top
	unit Elf_Rax_Melee_Mid
	unit Elf_Rax_Melee_Bot
	unit Elf_Rax_Range_Top
	unit Elf_Rax_Range_Mid
	unit Elf_Rax_Range_Bot
	unit EK7
	unit EM7
	unit EN7
	unit EO7
	unit EP7
	unit EQ7
	unit ER7
	unit ES7
	unit ET7
	unit EU7
	unit EV7
	unit EW7
	unit EX7
	unit EY7
	unit EZ7
	constant real EC7=6784
	constant real E37=6368
	unit ScourgeFountain
	unit ScourgeBuilding_BlackMarket1
	unit ScourgeBuilding_BlackMarket2
	unit ScourgeBuilding_ShopGateway
	unit ScourgeBuilding_ShopWeapon
	unit ScourgeBuilding_ShopAccessorizer
	unit ScourgeBuilding_ShopGraveyard
	unit ScourgeBuilding_Shop1
	unit ScourgeBuilding_Shop2
	unit ScourgeBuilding_Shop3
	unit ScourgeBuilding_Shop4
	unit ScourgeBuilding_Shop5
	unit ScourgeBuilding_Shop6
	unit FrozenThrone
	unit Towers_Scourge_Top_1
	unit Towers_Scourge_Mid_1
	unit Towers_Scourge_Bot_1
	unit Towers_Scourge_Top_2
	unit Towers_Scourge_Mid_2
	unit Towers_Scourge_Bot_2
	unit Towers_Scourge_Top_3
	unit Towers_Scourge_Mid_3
	unit Towers_Scourge_Bot_3
	unit Towers_Scourge_Throne1
	unit Towers_Scourge_Throne2
	unit Und_Rax_Melee_Top
	unit Und_Rax_Melee_Mid
	unit Und_Rax_Melee_Bot
	unit Und_Rax_Range_Top
	unit Und_Rax_Range_Mid
	unit Und_Rax_Range_Bot
	unit I77
	unit I87
	unit I97
	unit ID7
	unit IE7
	unit IF7
	unit IG7
	unit IH7
	unit II7
	unit IJ7
	unit IK7
	unit IM7
	unit IN7
	unit IO7
	unit IP7
	unit CirclesOfPower_1
	unit CirclesOfPower_2
	unit CirclesOfPower_3
	unit CirclesOfPower_4
	unit CirclesOfPower_5
	unit CirclesOfPower_7
	unit CirclesOfPower_8
	unit CirclesOfPower_9
	unit CirclesOfPower_10
	unit CirclesOfPower_11
	unit array CirclesOfPower
	real array ItemSpawnX
	real array ItemSpawnY
	player udg_Observer1
	player udg_Observer2
	string array PlayerNames
	integer array PlayerNamesHashes
	integer array PlayerColors_R
	integer array PlayerColors_G
	integer array PlayerColors_B
	integer array HeroID
	constant integer FirstSentinelHeroIndexid=1
	integer LastSentinelHeroIndexid
	integer FirstScourgeHeroIndexid
	integer LastScourgeHeroIndexid
	integer array AgiHeroesArray
	integer AgilityHeroesAmount
	integer array StrHeroesArray
	integer StrHeroesAmount
	integer array IntHeroesArray
	integer IntHeroesAmount
	integer array RangeHeroesArray
	integer RangeHeroesAmount=0
	integer array MeleeHeroesArray
	integer MeleeHeroesAmount=0
	string array HeroIcon
	unit TavernIntSent1
	unit TavernIntSent2
	unit TavernIntScourge1
	unit TavernIntScourge2
	unit TavernAgiSent1
	unit TavernAgiSent2
	unit TavernAgiScourge1
	unit TavernAgiScourge2
	unit TavernStrSent1
	unit TavernStrSent2
	unit TavernStrScourge1
	unit TavernStrScourge2
	integer array SomeDummyAbilitiesList
	integer SomeDummyAbilitiesCounter=0
	boolean array IsPlayerLeftGame
	integer LeaversCounter=0
	integer SharedControlAlliesCount
	player SharedControlAlliesTempPlayer
	trigger TriggerGoldPerSecond
	trigger TriggerUpdateGameTime
	timer array PrimUltiTimer
	timer array SecUltiTimer
	integer array ReliableGold
	real array Assists_LastTimeDamaged
	integer array Assists_PlayerID
	integer array Assists_PlayerIDDamaged
	integer Assists_Increment=1
	constant real Assists_MaxTime=18
	player array Assists_Assisters
	unit TempUnit_BSCheck
	unit TempUnit_UrnCheck
	integer TempInt_UrnsCount
	integer AssistBonusesGoldGlobal
	integer AssistBonusesExpGlobal
	integer array AssistsBonusExpCounter
	integer array AssistsBonusGoldCounter
	integer AssistersAllGlobalCounter
	integer AssistersAllWOKillerGlobalCounter
	unit K27=null
	boolean M47=true
	integer RoshanUpgradesLevel=1
	trigger RoshanUpdaterTrigger
	integer RoshanCounter=0
	integer array Item_Dummy
	integer array Item_Real
	integer array Item_SellerUnit
	integer array Item_Mute
	string array Item_Icon
	integer array Item_SideShops
	integer ITC=0
	integer AghanimUpgrader
	integer AghanimUpgraderGiftable
	integer AghanimBasic
	
	integer ShadowAmulet
	integer CrimsonGuard
	integer RecipeCrimsonGuard
	integer OrbOfVenom
	integer OrbOfVenomRanged
	integer BootsOfSpeed
	integer GlovesOfHaste
	integer BootsOfElvenskin
	integer CircletOfNobility
	integer BeltOfStrength
	integer BladesOfAlacrity
	integer BladesOfAttack
	integer Broadsword
	integer Chainmail
	integer Claymore
	integer DemonEdge
	integer Eaglehorn
	integer EnergyBooster
	integer GauntletOfStrength
	integer Gem
	integer GemCourier
	integer HelmOfIronWill
	integer Hyperstone
	integer IronwoodBranch
	integer KelensDagger
	integer DisabledKelensDagger
	integer MantleOfIntelligence
	integer MaskOfDeath
	integer MesserschmidtReaver
	integer MithrilHammer
	integer MysticStaff
	integer OgreAxe
	integer PlaneswalkerCloak
	integer PlateMail
	integer PointBooster
	integer Quarterstaff
	integer RingOfHealth
	integer RingOfProtection
	integer RingOfRegeneration
	integer RobeOfMagi
	integer SacredRelic
	integer SlippersOfAgility
	integer SobiMask
	integer StaffOfWizardry
	integer StoutShield
	integer StoutShieldRanged
	integer UltimateOrb
	integer VitalityBooster
	integer VoidStone
	integer javelin
	integer Bottle0Shop
	integer Bottle0
	integer Bottle1
	integer Bottle2
	integer Bottle3
	integer BottleInvis
	integer BottleDD
	integer BottleHaste
	integer BottleRegen
	integer BottleIllusion
	integer BottleBounty
	integer MagicStick
	integer QuellingBlade
	integer QuellingBladeRanged
	integer TalismanOfEvasion
	integer EtherealBlade
	integer janggo
	integer janggoempty
	integer BladeOfTheReaper
	integer TranquilBoots
	integer TranquilBootsBroken
	integer RodOfAtos
	integer MoonShard
	integer OctarineCore
	integer LotusOrb
	integer RecipeLotusOrb
	integer SolarCrest
	integer RecipeMoonShard
	integer SilverEdge
	integer RecipeSilverEdge
	integer Mango
	integer GlimmerCape
	integer RecipeGuardianGreaves
	integer GuardianGreaves
	integer RingOfAquila
	integer RingOfAquilaHero
	integer ClarityPotion
	integer ghostpotion
	integer HealingSalve
	integer Tango
	integer TangoBorrowed
	integer ObserverWards
	integer SentryWards
	integer ScrollOfTownPortal
	integer AnimalCourier
	integer Cheese
	integer FakeCheese
	integer dustofappearance
	integer wandofillusions
	integer Smoke
	integer Perseverance
	integer HeaddressOfRejuvenation
	integer NathrezimBuckler
	integer RingOfBasilius
	integer RingOfBasiliusHero
	integer bootsOfTravel
	integer bootsOfTravel2
	integer PowerTreadsAgility
	integer PowerTreadsStrength
	integer PowerTreadsIntelligence
	integer HandOfMidas
	integer HandOfMidasCourier
	integer OblivionStaff
	integer Bracer
	integer WraithBand
	integer NullTalisman
	integer Yasha
	integer Sange
	integer CraniumBasher
	integer BladeMail
	integer Maelstrom
	integer DiffusalBlade
	integer DiffusalBlade_upg
	integer DiffusalBlade_empty
	integer DiffusalBlade_upg_empty
	integer HelmOfTheDominator
	integer HelmOfTheDominatorCourier
	integer MaskOfMadness
	integer Eul
	integer SoulBooster
	integer Mekansm
	integer SangeAndYasha
	integer Desolator
	integer BattleFury
	integer Crystalys
	integer BKB10
	integer BKB09
	integer BKB08
	integer BKB07
	integer BKB06
	integer BKB05
	integer Aegis
	integer FakeAegis
	integer MantaStyle
	integer MantaStyleRanged
	integer LotharsEdge
	integer Dagon1
	integer Dagon2
	integer Dagon3
	integer Dagon4
	integer Dagon5
	integer Necronomicon1
	integer Necronomicon2
	integer Necronomicon3
	integer LinkensSphere
	integer LinkenDummy
	integer DivineRapier
	integer DivineRapierFree
	integer Buriza
	integer MKBOn
	integer MKBOff
	integer RadianceOn
	integer RadianceOff
	integer HeartOfTarrasque
	integer DisabledHeartOfTarrasque
	integer Satanic
	integer EyeOfSkadi
	integer EyeOfSkadiRanged
	integer Butterfly
	integer RefresherOrb
	integer GuinsooHex
	integer Vanguard
	integer VanguardRanged
	integer ArcaneRing
	integer Mjollnir
	integer FlyingCourier
	integer VladmirsOffering
	integer AssaultCuirass
	integer bloodstone
	integer RecipeBloodstone
	integer HoodOfDefiance
	integer ArmletOn
	integer ArmletOff
	integer ArmletOnCourier
	integer ArmletOffCourier
	integer ShivasGuard
	integer ShivasGuardCourier
	integer Orchid
	integer PhaseBoots
	integer MagicWand
	integer ForceStaff
	integer Pipe
	integer PoormansShield
	integer PoormansShieldRanged
	integer GhostScepter
	integer UrnOfShadows
	integer UrnOfShadowsEmpty
	integer SoulRing
	integer ArcaneBoots
	integer MedallionOfCourage
	integer VeilOfDiscord
	integer HeavensHalberd
	integer AbyssalBlade
	integer RecipeHeaddressOfRejuvenation
	integer RecipeNethrezimBuckler
	integer RecipeBootsOfTravel
	integer RecipeHandOfMidas
	integer RecipeBracer
	integer RecipeWraithBand
	integer RecipeNullTalisman
	integer RecipeYasha
	integer RecipeSange
	integer RecipeCraniumBasher
	integer RecipeMaelstrom
	integer RecipeDiffusalBlade
	integer RecipeMaskOfMadness
	integer RecipeEul
	integer RecipeMekansm
	integer RecipeSangeAndYasha
	integer RecipeDesolator
	integer RecipeCrystalys
	integer RecipeBKB
	integer RecipeMantaStyle
	integer RecipeDagon
	integer RecipeNecronomicon
	integer RecipeLinken
	integer RecipeBuriza
	integer RecipeRadiance
	integer RecipeHeartOfTarrasque
	integer RecipeSatanic
	integer RecipeRefresherOrb
	integer RecipeArcaneRing
	integer RecipeFlyingCourier
	integer RecipeVladmirOffering
	integer RecipeAssaultCuirass
	integer RecipeArmlet
	integer RecipeShivasGuard
	integer RecipeForceStaff
	integer RecipePipe
	integer RecipeAghanim
	integer RecipeMjollnir
	integer RecipeUrnOfShadows
	integer RecipeSoulRing
	integer RecipeJanggo
	integer RecipeMedallion
	integer RecipeVeilOfDiscord
	integer RecipeOrchid
	integer RecipeTranquilBoots
	trigger RuneSpawnTrigger
	integer T77=0
	integer array Rec_Comp_1
	integer array Rec_Comp_2
	integer array Rec_Comp_3
	integer array Rec_Comp_4
	integer array Rec_Comp_5
	integer array Rec_Final
	integer Recipe_Max=0
	
	integer array HasItem_Javelin
	integer array HasItem_Dagger
	integer array HasItem_Bloodstone
	integer array HasItem_CraniumBasher
	integer array HasItem_LinkenSphere
	integer array HasItem_SangeNYasha
	integer array HasItem_Sange
	player U07
	unit U57
	unit U27
	integer V47
	//boolean V77=false
	unit V87
	trigger t_manipulateitem
	integer TotalCount_LinkenSphere=0
	integer TotalCount_Dagger=0
	integer TotalCount_Bloodstone=0
	integer TotalCount_Heart=0
	integer TotalCount_Tranquils=0
	integer array HasItem_HeavensHalberd
	boolean VP7=false
	trigger GenericItemActionTrigger
	unit array BloodstoneHeroes
	unit VX7=null
	real array VY7
	real array LastTimeDamaged_ForDagger
	integer array HasItem_Heart
	integer array HasItem_TranquilBoots
	real array V17
	real array V07
	player array V57
	real array V27
	real array W47
	real array W77
	integer W87=-1
	constant real WD7=525
	region RegionNoTPScrollPenalty
	integer WS7='A0FY'//A0FY -> Magic Immunity Container
	unit WT7
	unit WU7
	group WW7
	unit WX7
	unit WY7
	player WZ7
	boolean WA7=false
	boolean WB7=false
	boolean W67=false
	boolean array WL7
	player W57
	boolean X87=false
	boolean X97=false
	boolean XD7=false
	boolean XE7=false
	boolean XF7=false
	boolean XG7=false
	boolean XH7=false
	boolean XI7=false
	integer array XJ7
	integer array XK7
	integer XM7=0
	integer SentinelsIngame=0
	integer ScourgesIngame=0
	constant string RED="|c00ff0303"
	constant string RED2="|c00ff0303"
	constant string BLUE="|c000042ff"
	constant string GREY="|c00646464"
	constant string WHITE="|c00ffffff"
	multiboard FinalMB
	integer array XX7
	integer array XY7
	player array XZ7
	integer XA7=0
	constant string ORANGE="|c00FF6600"
	multiboard ObsBoard
	trigger X37
	constant real AntiBDRegenRate=90
	boolean YL7=false
	unit Y17=null
	unit Y07=null
	group Y57
	integer Z77=0
	string array Z87
	integer ZD7
	player ZE7
	integer ZF7
	integer ZG7='A0HU'//A0HU -> Leaver Freeze
	integer ZH7='A0HX'//A0HX -> Leaver Unfreeze
	trigger ZI7
	region ForbiddenWardsRegion
	boolean CreepSpawnDisabled=false
	boolean ZM7=false
	boolean ZN7=false
	unit array HeroAttackedLogic_Attackers
	group HeroAttackedLogic_TempGroup
	unit HeroAttackedLogic_TempUnit
	integer HeroAttackedLogic_TempInt
	integer HeroAttackedLogic_Counter=0
	integer array RickRollCounter
	boolean array SelectionHelperEnabled
	boolean array HeroHasBeenUnlocked
	boolean SwitchUnlockingAvailable=true
	boolean array ZZ7
	real ZA7=-200
	boolean array ShowDeathTimer
	leaderboard array MyLB
	boolean array CSONStatus2
	boolean Z67=true
	boolean array Z17
	boolean array hhnActive
	boolean array ItemInfoShown
	boolean array SpellInfoShown
	boolean AFK_Check=true
	boolean array A47
	string array A77
	integer A87=0
	string A97="Sound\\Music\\mp3Music\\PH1.mp3"
	boolean array CustomWaterColor
	integer AE7
	integer AF7
	integer AG7
	boolean AQ7=false
	trigger AR7
	boolean BB7=false
	boolean Mode_SD=false
	boolean Mode_MO=false
	boolean Mode_RO=false
	boolean Mode_OM=false
	boolean Mode_NB=false
	boolean Mode_NM=false
	boolean Mode_NT=false
	boolean Mode_NR2=false
	boolean Mode_OI=false
	boolean Mode_FR=false
	boolean Mode_ZM=false
	camerasetup DM8=null
	boolean Mode_UL=false
	boolean Mode_SS=false
	boolean Mode_AB=false
	boolean Mode_S5=false
	boolean Mode_S6=false
	boolean Mode_FN=false
	boolean Mode_D2=false
	boolean Mode_D3=false
	boolean Mode_D4=false
	boolean Mode_D5=false
	boolean Mode_OS=false
	boolean Mode_BO=false
	boolean Mode_RC=false
	boolean Mode_EB=false
	boolean Mode_MD=false
	boolean Mode_RA=false
	boolean Mode_LS3=false
	boolean Mode_LS=false
	boolean Mode_FF=false
	boolean Mode_NN=false
	group DA8
	unit DB8
	integer DC8
	integer E48=0
	integer array TrackBonusBounty
	real E88
	unit E98
	integer ED8
	unit EE8
	integer EF8
	unit EG8
	real EH8
	unit EI8
	real EJ8
	integer EK8
	integer EM8
	unit EN8
	real EO8
	unit array EchoSlamDummiesFull
	integer ER8
	integer ES8
	real ET8
	unit EV8
	unit array EW8
	real EX8
	real EY8
	integer EZ8
	integer EA8
	unit EB8
	real EC8
	real E38
	real E68
	unit EL8
	unit array E18
	unit E28
	integer F48
	unit F78
	real F88
	real F98
	real FD8
	integer FE8=0
	real FF8
	real FG8
	integer FH8
	real FI8
	unit FJ8
	unit FO8
	group FP8
	group FQ8
	group FR8
	unit FT8
	unit F68
	real FL8
	integer array StolenInt
	unit F58
	unit F28
	real G48
	unit G88
	integer GF8
	unit GG8
	unit GH8
	real GI8
	real GJ8
	real GK8
	real GM8
	boolean GU8=false
	boolean GV8=false
	integer GZ8
	unit GA8
	real GB8
	unit GC8
	unit G38
	real G68
	integer G18
	unit G08
	unit G58
	group H48
	integer H78
	group H88
	unit H98
	real HD8
	destructable HE8=null
	unit HF8=null
	real HG8=0
	constant real HH8=26
	constant real HJ8=500
	real HK8
	real HM8
	group HN8
	unit HO8
	real HP8
	integer HQ8
	integer HR8
	unit HS8
	unit HU8
	integer HV8
	boolean HW8=false
	unit HY8
	integer array HZ8
	integer array HA8
	integer array HB8
	integer array HC8
	unit H38
	integer HL8
	real H18
	real H08
	unit H58
	boolean I48=false
	integer I78
	unit I88
	unit IF8
	constant integer IH8='h06J'//h06J -> BlinkStrike CK
	real II8
	real IJ8
	unit IK8
	unit IM8
	unit IN8
	real IO8
	real IP8
	real IQ8
	integer IR8
	real IS8
	real IT8
	unit IU8
	unit IV8
	integer IW8
	group SoulRipTempGroup
	unit SoulRipTempTarget
	integer SoulRipTempCounter
	integer SoulRipTempLvl
	boolean SoulRipTempForceAll
	integer SoulRipTempTombstoneHealCounter
	player IC8
	integer I38
	unit array I68
	group I58
	integer I28
	real JF8
	unit JG8
	trigger dividedwestand_t
	trigger DoubleTroubleTrigger
	integer dividedwestand_count=0
	boolean dividedwestand_usedscepter=false
	unit JN8
	real JO8
	real JP8
	real JQ8
	unit JR8
	unit JS8
	unit JT8
	group JU8
	real JV8
	unit JZ8
	integer JA8
	unit Necrolyte_Heartstopper_Caster
	integer Necrolyte_Heartstopper_Lvl
	unit J08
	group KD8
	integer KE8
	unit KF8
	real KG8
	unit KM8
	real KN8
	integer KO8
	unit array KP8
	unit KQ8
	unit KR8
	real KU8
	unit K38
	unit K58
	unit K28
	integer M48
	unit array M78
	boolean M88=false
	unit M98
	integer MD8
	real array IceBlastTimestamp
	real array IceBlastLife
	unit array IceBlastCaster
	integer array IceBlastTicks
	integer array IceBlastLevel
	integer MK8
	integer MN8
	unit MO8
	group MQ8
	integer MR8
	unit MS8
	unit MT8
	integer MU8
	unit N98
	group ND8
	unit NG8
	real NH8
	real NI8
	real NJ8
	real NK8
	constant real NM8=325
	unit NN8
	unit NO8
	integer NP8
	real NQ8
	unit NR8
	boolean NS8=false
	unit NT8
	real NV8
	unit NW8
	integer NX8
	integer NY8
	group NA8
	integer NC8
	region N38
	region N68
	unit NL8
	integer N08
	group N58
	group N28
	unit O48
	unit O78
	unit O88
	integer O98
	real OD8
	real OE8
	unit OH8
	unit OJ8
	unit OK8
	group OM8
	real ON8
	integer array RubickExceptionsList
	integer RubickExC=0
	integer OQ8
	unit OR8
	integer OS8
	integer OT8
	unit OU8
	real OV8
	real OW8
	real OX8
	unit OY8
	integer array OZ8
	integer array O08
	integer O58
	integer O28
	integer P48
	sound PD8=null
	integer PM8
	integer PN8
	group PR8
	unit PS8
	integer PT8
	force P68=null
	boolexpr PL8=null
	boolean array TIMERIMG
	trigger APShowTimersTrig
	unit TEMPUNIT
	unit BlackholeCaster
	group ILLUMINATEGROUP=CreateGroup()
	boolean RMD_StatsSent=false
	string tt_str1=""
	integer LocalPlayerId=0
	string LastMemReadAccess=""
	string LastMemWriteAccess=""
	integer pReserverMemoryForFastMemRead=0
	integer pReserverMemoryForFastMemWrite=0
	boolean FastReadMemEnabled=false
	boolean FastWriteMemEnabled=false
	integer OldMinimapColorStyleByte1=0
	integer OldMinimapColorStyleByte2=0
	integer pConvertHandleNative=0
	integer AttachedLibraryHash=0
	boolean ItIsReplayGuys=false
	boolean MinimapPingingBlocked=false
	player array Players
	constant integer REGISTER_EAX = 0xC000
	constant integer REGISTER_EBX = 0xC300
	constant integer REGISTER_ECX = 0xC100
	constant integer REGISTER_EDX = 0xC200
	constant integer REGISTER_ESP = 0xC400
	constant integer REGISTER_EBP = 0xC500
	constant integer REGISTER_EDI = 0xC700
	constant integer REGISTER_ESI = 0xC600
endglobals

function LoadingProgressCheckout takes string s returns nothing
	set LoadingProgressCounter=LoadingProgressCounter+1
	call PreloadEndEx()
	call PreloadGenClear()
	call PreloadGenStart()
	call Preload("step="+s)
	call PreloadGenEnd("LoadingProgress.txt")
	call PreloadGenClear()
endfunction

//# +nosemanticerror
function Char2Ascii takes string s returns integer
	local integer i= Ascii__Ints[StringHash(s) / 0x1F0748 + 0x3EA]
	if i == 47 and s == "\\" then
		set i=92
	elseif i >= 65 and i <= 90 and s != Ascii__Chars[i] then
		set i=i + 32
	endif
	return i
endfunction

function Char2Hex takes string s returns integer
	local integer i= Ascii__Ints[StringHash(s) / 0x1F0748 + 0x3EA]
	if i >= 48 and i <= 57 then
		return i - 48
	elseif i >= 65 and i <= 70 then
		return i - 55
	endif
	return - 1
endfunction

function Ascii2Char takes integer i returns string
	return Ascii__Chars[i]
endfunction

function Ascii__onInit takes nothing returns nothing
	set Ascii__Ints[931]=8
	set Ascii__Ints[1075]=9
	set Ascii__Ints[1586]=10
	set Ascii__Ints[1340]=12
	set Ascii__Ints[412]=13
	set Ascii__Ints[198]=32
	set Ascii__Ints[1979]=33
	set Ascii__Ints[1313]=34
	set Ascii__Ints[1003]=35
	set Ascii__Ints[1264]=36
	set Ascii__Ints[983]=37
	set Ascii__Ints[1277]=38
	set Ascii__Ints[306]=39
	set Ascii__Ints[904]=40
	set Ascii__Ints[934]=41
	set Ascii__Ints[917]=42
	set Ascii__Ints[1972]=43
	set Ascii__Ints[1380]=44
	set Ascii__Ints[1985]=45
	set Ascii__Ints[869]=46
	set Ascii__Ints[1906]=47
	set Ascii__Ints[883]=48
	set Ascii__Ints[1558]=49
	set Ascii__Ints[684]=50
	set Ascii__Ints[582]=51
	set Ascii__Ints[668]=52
	set Ascii__Ints[538]=53
	set Ascii__Ints[672]=54
	set Ascii__Ints[1173]=55
	set Ascii__Ints[71]=56
	set Ascii__Ints[277]=57
	set Ascii__Ints[89]=58
	set Ascii__Ints[1141]=59
	set Ascii__Ints[39]=60
	set Ascii__Ints[1171]=61
	set Ascii__Ints[51]=62
	set Ascii__Ints[305]=0 //fixme 63
	set Ascii__Ints[0]=64
	set Ascii__Ints[222]=65
	set Ascii__Ints[178]=66
	set Ascii__Ints[236]=67
	set Ascii__Ints[184]=68
	set Ascii__Ints[1295]=69
	set Ascii__Ints[1390]=70
	set Ascii__Ints[1276]=71
	set Ascii__Ints[203]=72
	set Ascii__Ints[1314]=73
	set Ascii__Ints[209]=74
	set Ascii__Ints[1315]=75
	set Ascii__Ints[170]=76
	set Ascii__Ints[1357]=77
	set Ascii__Ints[1343]=78
	set Ascii__Ints[1397]=79
	set Ascii__Ints[1420]=80
	set Ascii__Ints[1419]=81
	set Ascii__Ints[1396]=82
	set Ascii__Ints[1374]=83
	set Ascii__Ints[1407]=84
	set Ascii__Ints[499]=85
	set Ascii__Ints[1465]=86
	set Ascii__Ints[736]=87
	set Ascii__Ints[289]=88
	set Ascii__Ints[986]=89
	set Ascii__Ints[38]=90
	set Ascii__Ints[1230]=91
	set Ascii__Ints[1636]=93
	set Ascii__Ints[1416]=94
	set Ascii__Ints[1917]=95
	set Ascii__Ints[217]=96
	set Ascii__Ints[833]=123
	set Ascii__Ints[1219]=124
	set Ascii__Ints[553]=125
	set Ascii__Ints[58]=126
	
	set Ascii__Chars[0]="?"
	set Ascii__Chars[8]="\b"
	set Ascii__Chars[9]="\t" 
	set Ascii__Chars[10]="\n"
	set Ascii__Chars[12]="\f"
	set Ascii__Chars[13]="\r"
	set Ascii__Chars[32]=" "
	set Ascii__Chars[33]="!"
	set Ascii__Chars[34]="\""
	set Ascii__Chars[35]="#"
	set Ascii__Chars[36]="$"
	set Ascii__Chars[37]="%"
	set Ascii__Chars[38]="&"
	set Ascii__Chars[39]="'"
	set Ascii__Chars[40]="("
	set Ascii__Chars[41]=")"
	set Ascii__Chars[42]="*"
	set Ascii__Chars[43]="+"
	set Ascii__Chars[44]=","
	set Ascii__Chars[45]="-"
	set Ascii__Chars[46]="."
	set Ascii__Chars[47]="/"
	set Ascii__Chars[48]="0"
	set Ascii__Chars[49]="1"
	set Ascii__Chars[50]="2"
	set Ascii__Chars[51]="3"
	set Ascii__Chars[52]="4"
	set Ascii__Chars[53]="5"
	set Ascii__Chars[54]="6"
	set Ascii__Chars[55]="7"
	set Ascii__Chars[56]="8"
	set Ascii__Chars[57]="9"
	set Ascii__Chars[58]=":"
	set Ascii__Chars[59]=";"
	set Ascii__Chars[60]="<"
	set Ascii__Chars[61]="="
	set Ascii__Chars[62]=">"
	set Ascii__Chars[63]="?"
	set Ascii__Chars[64]="@"
	set Ascii__Chars[65]="A"
	set Ascii__Chars[66]="B"
	set Ascii__Chars[67]="C"
	set Ascii__Chars[68]="D"
	set Ascii__Chars[69]="E"
	set Ascii__Chars[70]="F"
	set Ascii__Chars[71]="G"
	set Ascii__Chars[72]="H"
	set Ascii__Chars[73]="I"
	set Ascii__Chars[74]="J"
	set Ascii__Chars[75]="K"
	set Ascii__Chars[76]="L"
	set Ascii__Chars[77]="M"
	set Ascii__Chars[78]="N"
	set Ascii__Chars[79]="O"
	set Ascii__Chars[80]="P"
	set Ascii__Chars[81]="Q"
	set Ascii__Chars[82]="R"
	set Ascii__Chars[83]="S"
	set Ascii__Chars[84]="T"
	set Ascii__Chars[85]="U"
	set Ascii__Chars[86]="V"
	set Ascii__Chars[87]="W"
	set Ascii__Chars[88]="X"
	set Ascii__Chars[89]="Y"
	set Ascii__Chars[90]="Z"
	set Ascii__Chars[91]="["
	set Ascii__Chars[92]="\\"
	set Ascii__Chars[93]="]"
	set Ascii__Chars[94]="^"
	set Ascii__Chars[95]="_"
	set Ascii__Chars[96]="`"
	set Ascii__Chars[97]="a"
	set Ascii__Chars[98]="b"
	set Ascii__Chars[99]="c"
	set Ascii__Chars[100]="d"
	set Ascii__Chars[101]="e"
	set Ascii__Chars[102]="f"
	set Ascii__Chars[103]="g"
	set Ascii__Chars[104]="h"
	set Ascii__Chars[105]="i"
	set Ascii__Chars[106]="j"
	set Ascii__Chars[107]="k"
	set Ascii__Chars[108]="l"
	set Ascii__Chars[109]="m"
	set Ascii__Chars[110]="n"
	set Ascii__Chars[111]="o"
	set Ascii__Chars[112]="p"
	set Ascii__Chars[113]="q"
	set Ascii__Chars[114]="r"
	set Ascii__Chars[115]="s"
	set Ascii__Chars[116]="t"
	set Ascii__Chars[117]="u"
	set Ascii__Chars[118]="v"
	set Ascii__Chars[119]="w"
	set Ascii__Chars[120]="x"
	set Ascii__Chars[121]="y"
	set Ascii__Chars[122]="z"
	set Ascii__Chars[123]="{"
	set Ascii__Chars[124]="|"
	set Ascii__Chars[125]="}"
	set Ascii__Chars[126]="~"
endfunction
//library Ascii ends
//library Typecast:


function InitArray takes integer vtable returns nothing
	set l__Array[4] = 0
	set l__Array[1] = vtable
	set l__Array[2] = -1
	set l__Array[3] = -1
endfunction

function TypecastArray takes nothing returns nothing
	local integer l__Array //typecast Array to integer
endfunction
//# +nosemanticerror
function GetArrayAddress takes nothing returns integer //not really needed
	loop
		return l__Array
	endloop
	return 0
endfunction
//# +nosemanticerror
function setCode takes code c returns nothing
	set l__Code=c
	return //Prevents Jasshelper from inlining this function
endfunction
//# +nosemanticerror
function setInt takes integer i returns nothing
	set l__Int=i
	return //Prevents JassHelper from inlining this function
endfunction
//# +nosemanticerror
function setInt2Unit takes integer i returns nothing
	set l__Int2Unit=i
	return //Prevents JassHelper from inlining this function
endfunction
//# +nosemanticerror
function setStr takes string s returns nothing
	set l__Str = s
	return //Prevents JassHelper from inlining this function
endfunction
//# +nosemanticerror
function setBool takes boolean b returns nothing
	set l__Bool = b
	return
endfunction

function Typecast1 takes nothing returns nothing
	local integer l__Code
	local code l__Int
endfunction
//# +nosemanticerror
function C2I takes code c returns integer
	call setCode(c)
	loop //Loop is not required, I'm using it just to fool Pjass
		return l__Code
	endloop
	return 0
endfunction
//# +nosemanticerror
function I2C takes integer i returns code
	call setInt(i)
	loop //Loop is not required, I'm using it just to fool Pjass
		return l__Int
	endloop
	return null
endfunction
//# +nosemanticerror
function Typecast2 takes nothing returns nothing
	local integer l__Str
	local string l__Int
endfunction
//# +nosemanticerror
function SH2I takes string s returns integer
	call setStr(s)
//	call BJDebugMsg("SH2I ["+s+"]")
	loop //Loop is not required, I'm using it just to fool Pjass
		return l__Str
	endloop
	return 0
endfunction
//# +nosemanticerror
function I2SH takes integer i returns string//integer 2 string handle
	call setInt(i)
//	call BJDebugMsg("I2SH "+l__Int)
//	call ExecuteFunc("fScanJassStringForErrorsWrap")
	loop //Loop is not required, I'm using it just to fool Pjass
		return l__Int
	endloop
	return ""
endfunction
//# +nosemanticerror
function Typecast3 takes nothing returns nothing
	local integer l__Bool
	local boolean l__Int
endfunction
//# +nosemanticerror
function B2I takes boolean b returns integer
	call setBool(b)
	loop //Loop is not required, I'm using it just to fool Pjass
	    	return l__Bool
	endloop
	return 0
endfunction
//# +nosemanticerror
function I2B takes integer i returns boolean
	call setInt(i)
	loop //Loop is not required, I'm using it just to fool Pjass
		return l__Int
	endloop
	return false
endfunction
//# +nosemanticerror
function realToIndex takes real r returns integer
	loop
	return r
		endloop
	return 0
endfunction

function cleanInt takes integer i returns integer
	return i
endfunction
//# +nosemanticerror
function indexToReal takes integer i returns real
	loop
		return i
	endloop
	return 0.0
endfunction

function cleanReal takes real r returns real
	return r
endfunction

function mI2R takes integer i returns real
	return cleanReal(indexToReal(i))
endfunction

function mR2I takes real r returns integer
	return cleanInt(realToIndex(r))
endfunction
//library Typecast ends
//library HexNumber:

function BitwiseNot takes integer i returns integer
	return 0xFFFFFFFF - i
endfunction

function PowI takes integer x, integer power returns integer
	local integer res=1
	local integer y=x
	if power==0 then
		return 1
	endif
	set power=power-1
	loop
		set x=x*y
		set power=power-1
		exitwhen power==0
	endloop
	return x
endfunction


function ShiftLeftForBits takes integer i, integer shiftval returns integer
	return i * (PowI(2,shiftval))
endfunction

function ShiftRightForBits takes integer i, integer shiftval returns integer
	return i / (PowI(2,shiftval))
endfunction

function ShiftLeftForBytes takes integer i, integer shiftval returns integer
	return ShiftLeftForBits(i,shiftval * 8)
endfunction

function ShiftRightForBytes takes integer i, integer shiftval returns integer
	return ShiftRightForBits(i,shiftval / 8)
endfunction



function GetByteFromInteger takes integer i, integer byteid returns integer 
	local integer tmpval = i 
	local integer retval = 0
	local integer byte1 = 0
	local integer byte2 = 0
	local integer byte3 = 0
	local integer byte4 = 0
	if (tmpval < 0) then 
		set tmpval = BitwiseNot(tmpval)
		set byte4 = 255 - ModuloInteger(tmpval,256)
		set tmpval = tmpval / 256 
		set byte3 = 255 - ModuloInteger(tmpval,256)
		set tmpval = tmpval / 256 
		set byte2 = 255 - ModuloInteger(tmpval,256)
		set tmpval = tmpval / 256 
		set byte1 = 255 - tmpval
	else 
		set byte4 =  ModuloInteger(tmpval,256)
		set tmpval = tmpval / 256 
		set byte3 =  ModuloInteger(tmpval,256)
		set tmpval = tmpval / 256 
		set byte2 =  ModuloInteger(tmpval,256)
		set tmpval = tmpval / 256 
		set byte1 = tmpval
	endif
	
	if byteid == 1 then 
		return byte1
	elseif byteid == 2 then 
		return byte2
	elseif byteid == 3 then 
		return byte3
	elseif byteid == 4 then 
		return byte4
	endif

	
	return retval
endfunction

function CreateInteger1 takes integer byte1, integer byte2, integer byte3, integer byte4 returns integer
	local integer retval = byte1
	set retval = ( retval * 256 ) + byte2
	set retval = ( retval * 256 ) + byte3
	set retval = ( retval * 256 ) + byte4
	return retval
endfunction

function CreateInteger2 takes integer byte1, integer byte2, integer byte3, integer byte4 returns integer
	local integer retval = byte1
	set retval = ShiftLeftForBytes(retval,1) + byte2
	set retval = ShiftLeftForBytes(retval,1) + byte3
	set retval = ShiftLeftForBytes(retval,1) + byte4
	return retval
endfunction


function Hex2Int takes string s returns integer
	local integer result= 0
	local integer i= 0
	local integer char
	loop
		set char=Char2Hex(SubString(s, i, i + 1))
		exitwhen i == 8 or char == - 1
		set result=result * 16 + char
		set i=i + 1
	endloop
	return result
endfunction

function Int2Hex_FIX takes integer i returns string
	set i = BitwiseNot(i)
	return  HexNumber__Chars[255-(i/256/256/256)] + HexNumber__Chars[255-ModuloInteger(i/256/256,256)] + HexNumber__Chars[255-ModuloInteger(i/256,256)]  +  HexNumber__Chars[255-ModuloInteger(i,256)]
endfunction

function Int2Hex takes integer i returns string
	if (i < 0) then 
		return Int2Hex_FIX(i)
	endif
	return  HexNumber__Chars[(i/256/256/256)] + HexNumber__Chars[ModuloInteger(i/256/256,256)] + HexNumber__Chars[ModuloInteger(i/256,256)]  +  HexNumber__Chars[ModuloInteger(i,256)]
endfunction


function HexNumber__onInit takes nothing returns nothing
	set HexNumber__Chars[0]="00" 
	set HexNumber__Chars[1]="01" 
	set HexNumber__Chars[2]="02" 
	set HexNumber__Chars[3]="03" 
	set HexNumber__Chars[4]="04" 
	set HexNumber__Chars[5]="05" 
	set HexNumber__Chars[6]="06" 
	set HexNumber__Chars[7]="07" 
	set HexNumber__Chars[8]="08" 
	set HexNumber__Chars[9]="09" 
	set HexNumber__Chars[10]="0A" 
	set HexNumber__Chars[11]="0B" 
	set HexNumber__Chars[12]="0C" 
	set HexNumber__Chars[13]="0D" 
	set HexNumber__Chars[14]="0E" 
	set HexNumber__Chars[15]="0F" 
	set HexNumber__Chars[16]="10" 
	set HexNumber__Chars[17]="11" 
	set HexNumber__Chars[18]="12" 
	set HexNumber__Chars[19]="13" 
	set HexNumber__Chars[20]="14" 
	set HexNumber__Chars[21]="15" 
	set HexNumber__Chars[22]="16" 
	set HexNumber__Chars[23]="17" 
	set HexNumber__Chars[24]="18" 
	set HexNumber__Chars[25]="19" 
	set HexNumber__Chars[26]="1A" 
	set HexNumber__Chars[27]="1B" 
	set HexNumber__Chars[28]="1C" 
	set HexNumber__Chars[29]="1D" 
	set HexNumber__Chars[30]="1E" 
	set HexNumber__Chars[31]="1F" 
	set HexNumber__Chars[32]="20" 
	set HexNumber__Chars[33]="21" 
	set HexNumber__Chars[34]="22" 
	set HexNumber__Chars[35]="23" 
	set HexNumber__Chars[36]="24" 
	set HexNumber__Chars[37]="25" 
	set HexNumber__Chars[38]="26" 
	set HexNumber__Chars[39]="27" 
	set HexNumber__Chars[40]="28" 
	set HexNumber__Chars[41]="29" 
	set HexNumber__Chars[42]="2A" 
	set HexNumber__Chars[43]="2B" 
	set HexNumber__Chars[44]="2C" 
	set HexNumber__Chars[45]="2D" 
	set HexNumber__Chars[46]="2E" 
	set HexNumber__Chars[47]="2F" 
	set HexNumber__Chars[48]="30" 
	set HexNumber__Chars[49]="31" 
	set HexNumber__Chars[50]="32" 
	set HexNumber__Chars[51]="33" 
	set HexNumber__Chars[52]="34" 
	set HexNumber__Chars[53]="35" 
	set HexNumber__Chars[54]="36" 
	set HexNumber__Chars[55]="37" 
	set HexNumber__Chars[56]="38" 
	set HexNumber__Chars[57]="39" 
	set HexNumber__Chars[58]="3A" 
	set HexNumber__Chars[59]="3B" 
	set HexNumber__Chars[60]="3C" 
	set HexNumber__Chars[61]="3D" 
	set HexNumber__Chars[62]="3E" 
	set HexNumber__Chars[63]="3F" 
	set HexNumber__Chars[64]="40" 
	set HexNumber__Chars[65]="41" 
	set HexNumber__Chars[66]="42" 
	set HexNumber__Chars[67]="43" 
	set HexNumber__Chars[68]="44" 
	set HexNumber__Chars[69]="45" 
	set HexNumber__Chars[70]="46" 
	set HexNumber__Chars[71]="47" 
	set HexNumber__Chars[72]="48" 
	set HexNumber__Chars[73]="49" 
	set HexNumber__Chars[74]="4A" 
	set HexNumber__Chars[75]="4B" 
	set HexNumber__Chars[76]="4C" 
	set HexNumber__Chars[77]="4D" 
	set HexNumber__Chars[78]="4E" 
	set HexNumber__Chars[79]="4F" 
	set HexNumber__Chars[80]="50" 
	set HexNumber__Chars[81]="51" 
	set HexNumber__Chars[82]="52" 
	set HexNumber__Chars[83]="53" 
	set HexNumber__Chars[84]="54" 
	set HexNumber__Chars[85]="55" 
	set HexNumber__Chars[86]="56" 
	set HexNumber__Chars[87]="57" 
	set HexNumber__Chars[88]="58" 
	set HexNumber__Chars[89]="59" 
	set HexNumber__Chars[90]="5A" 
	set HexNumber__Chars[91]="5B" 
	set HexNumber__Chars[92]="5C" 
	set HexNumber__Chars[93]="5D" 
	set HexNumber__Chars[94]="5E" 
	set HexNumber__Chars[95]="5F" 
	set HexNumber__Chars[96]="60" 
	set HexNumber__Chars[97]="61" 
	set HexNumber__Chars[98]="62" 
	set HexNumber__Chars[99]="63" 
	set HexNumber__Chars[100]="64" 
	set HexNumber__Chars[101]="65" 
	set HexNumber__Chars[102]="66" 
	set HexNumber__Chars[103]="67" 
	set HexNumber__Chars[104]="68" 
	set HexNumber__Chars[105]="69" 
	set HexNumber__Chars[106]="6A" 
	set HexNumber__Chars[107]="6B" 
	set HexNumber__Chars[108]="6C" 
	set HexNumber__Chars[109]="6D" 
	set HexNumber__Chars[110]="6E" 
	set HexNumber__Chars[111]="6F" 
	set HexNumber__Chars[112]="70" 
	set HexNumber__Chars[113]="71" 
	set HexNumber__Chars[114]="72" 
	set HexNumber__Chars[115]="73" 
	set HexNumber__Chars[116]="74" 
	set HexNumber__Chars[117]="75" 
	set HexNumber__Chars[118]="76" 
	set HexNumber__Chars[119]="77" 
	set HexNumber__Chars[120]="78" 
	set HexNumber__Chars[121]="79" 
	set HexNumber__Chars[122]="7A" 
	set HexNumber__Chars[123]="7B" 
	set HexNumber__Chars[124]="7C" 
	set HexNumber__Chars[125]="7D" 
	set HexNumber__Chars[126]="7E" 
	set HexNumber__Chars[127]="7F" 
	set HexNumber__Chars[128]="80" 
	set HexNumber__Chars[129]="81" 
	set HexNumber__Chars[130]="82" 
	set HexNumber__Chars[131]="83" 
	set HexNumber__Chars[132]="84" 
	set HexNumber__Chars[133]="85" 
	set HexNumber__Chars[134]="86" 
	set HexNumber__Chars[135]="87" 
	set HexNumber__Chars[136]="88" 
	set HexNumber__Chars[137]="89" 
	set HexNumber__Chars[138]="8A" 
	set HexNumber__Chars[139]="8B" 
	set HexNumber__Chars[140]="8C" 
	set HexNumber__Chars[141]="8D" 
	set HexNumber__Chars[142]="8E" 
	set HexNumber__Chars[143]="8F" 
	set HexNumber__Chars[144]="90" 
	set HexNumber__Chars[145]="91" 
	set HexNumber__Chars[146]="92" 
	set HexNumber__Chars[147]="93" 
	set HexNumber__Chars[148]="94" 
	set HexNumber__Chars[149]="95" 
	set HexNumber__Chars[150]="96" 
	set HexNumber__Chars[151]="97" 
	set HexNumber__Chars[152]="98" 
	set HexNumber__Chars[153]="99" 
	set HexNumber__Chars[154]="9A" 
	set HexNumber__Chars[155]="9B" 
	set HexNumber__Chars[156]="9C" 
	set HexNumber__Chars[157]="9D" 
	set HexNumber__Chars[158]="9E" 
	set HexNumber__Chars[159]="9F" 
	set HexNumber__Chars[160]="A0" 
	set HexNumber__Chars[161]="A1" 
	set HexNumber__Chars[162]="A2" 
	set HexNumber__Chars[163]="A3" 
	set HexNumber__Chars[164]="A4" 
	set HexNumber__Chars[165]="A5" 
	set HexNumber__Chars[166]="A6" 
	set HexNumber__Chars[167]="A7" 
	set HexNumber__Chars[168]="A8" 
	set HexNumber__Chars[169]="A9" 
	set HexNumber__Chars[170]="AA" 
	set HexNumber__Chars[171]="AB" 
	set HexNumber__Chars[172]="AC" 
	set HexNumber__Chars[173]="AD" 
	set HexNumber__Chars[174]="AE" 
	set HexNumber__Chars[175]="AF" 
	set HexNumber__Chars[176]="B0" 
	set HexNumber__Chars[177]="B1" 
	set HexNumber__Chars[178]="B2" 
	set HexNumber__Chars[179]="B3" 
	set HexNumber__Chars[180]="B4" 
	set HexNumber__Chars[181]="B5" 
	set HexNumber__Chars[182]="B6" 
	set HexNumber__Chars[183]="B7" 
	set HexNumber__Chars[184]="B8" 
	set HexNumber__Chars[185]="B9" 
	set HexNumber__Chars[186]="BA" 
	set HexNumber__Chars[187]="BB" 
	set HexNumber__Chars[188]="BC" 
	set HexNumber__Chars[189]="BD" 
	set HexNumber__Chars[190]="BE" 
	set HexNumber__Chars[191]="BF" 
	set HexNumber__Chars[192]="C0" 
	set HexNumber__Chars[193]="C1" 
	set HexNumber__Chars[194]="C2" 
	set HexNumber__Chars[195]="C3" 
	set HexNumber__Chars[196]="C4" 
	set HexNumber__Chars[197]="C5" 
	set HexNumber__Chars[198]="C6" 
	set HexNumber__Chars[199]="C7" 
	set HexNumber__Chars[200]="C8" 
	set HexNumber__Chars[201]="C9" 
	set HexNumber__Chars[202]="CA" 
	set HexNumber__Chars[203]="CB" 
	set HexNumber__Chars[204]="CC" 
	set HexNumber__Chars[205]="CD" 
	set HexNumber__Chars[206]="CE" 
	set HexNumber__Chars[207]="CF" 
	set HexNumber__Chars[208]="D0" 
	set HexNumber__Chars[209]="D1" 
	set HexNumber__Chars[210]="D2" 
	set HexNumber__Chars[211]="D3" 
	set HexNumber__Chars[212]="D4" 
	set HexNumber__Chars[213]="D5" 
	set HexNumber__Chars[214]="D6" 
	set HexNumber__Chars[215]="D7" 
	set HexNumber__Chars[216]="D8" 
	set HexNumber__Chars[217]="D9" 
	set HexNumber__Chars[218]="DA" 
	set HexNumber__Chars[219]="DB" 
	set HexNumber__Chars[220]="DC" 
	set HexNumber__Chars[221]="DD" 
	set HexNumber__Chars[222]="DE" 
	set HexNumber__Chars[223]="DF" 
	set HexNumber__Chars[224]="E0" 
	set HexNumber__Chars[225]="E1" 
	set HexNumber__Chars[226]="E2" 
	set HexNumber__Chars[227]="E3" 
	set HexNumber__Chars[228]="E4" 
	set HexNumber__Chars[229]="E5" 
	set HexNumber__Chars[230]="E6" 
	set HexNumber__Chars[231]="E7" 
	set HexNumber__Chars[232]="E8" 
	set HexNumber__Chars[233]="E9" 
	set HexNumber__Chars[234]="EA" 
	set HexNumber__Chars[235]="EB" 
	set HexNumber__Chars[236]="EC" 
	set HexNumber__Chars[237]="ED" 
	set HexNumber__Chars[238]="EE" 
	set HexNumber__Chars[239]="EF" 
	set HexNumber__Chars[240]="F0" 
	set HexNumber__Chars[241]="F1" 
	set HexNumber__Chars[242]="F2" 
	set HexNumber__Chars[243]="F3" 
	set HexNumber__Chars[244]="F4" 
	set HexNumber__Chars[245]="F5" 
	set HexNumber__Chars[246]="F6" 
	set HexNumber__Chars[247]="F7" 
	set HexNumber__Chars[248]="F8" 
	set HexNumber__Chars[249]="F9" 
	set HexNumber__Chars[250]="FA" 
	set HexNumber__Chars[251]="FB" 
	set HexNumber__Chars[252]="FC" 
	set HexNumber__Chars[253]="FD" 
	set HexNumber__Chars[254]="FE" 
	set HexNumber__Chars[255]="FF" 

endfunction

function GetChar takes string s, integer pos returns string
	return SubString(s, pos, pos +1)
endfunction
//library HexNumber ends


function ReportToTheReplay takes string cat, string s, integer i returns nothing
//	call StoreInteger(GMC,cat,s,i)
//	call SyncStoredInteger(GMC,cat,s)
endfunction

function FatalErrorNote takes string s returns nothing
	call BJDebugMsg("|c00ff0000    Fatal error: "+s+". Report this replay at |c00ffff00DracoL1ch@RankedGaming.com|r")
	set tt_str1=s
	call ExecuteFunc("JassLogWrapper")
	call ReportToTheReplay("DFatal_"+I2S(LocalPlayerId),s,0)
endfunction

function MinorErrorNote takes string s returns nothing
	call BJDebugMsg("|c00ffff00    Minor error: "+s+". Report this replay at |c0000ff00DracoL1ch@RankedGaming.com|r")
	call ReportToTheReplay("DFatalM_"+I2S(LocalPlayerId),s,0)
endfunction

function ReadUnrealMemory takes integer address returns integer
	if address*4 < 0x7Fffffff and address>MINIMAL_ACCESSABLE_ADDRESS then
		return Memory[address]
	endif
	call FatalErrorNote("Mem read at "+Int2Hex(address*4)+"::"+LastMemReadAccess)
	return 0
endfunction

function WriteUnrealMemory takes integer address, integer value returns nothing
	if address*4 < 0x7Fffffff and address>MINIMAL_ACCESSABLE_ADDRESS then
		set Memory[address] = value
		return
	endif
	call FatalErrorNote("Mem write at "+Int2Hex(address*4)+"::"+LastMemWriteAccess)
endfunction

function ReadMemoryWorker takes integer address returns integer
	return Memory[address/4] //Inline-friendly
endfunction

function WriteMemoryWorker takes integer address, integer value returns nothing
	set Memory[address/4] = value //Inline-friendly
endfunction

function InitBytecode takes integer id, integer k returns nothing
	set l__bytecode[0] = 0x0C010900 //op: 0C(LITERAL), type: 09(integer array), reg: 01,
	set l__bytecode[1] = k //value: 0x2114D008
	set l__bytecode[2] = 0x11010000 //op: 11(SETVAR), reg: 01
	set l__bytecode[3] = id		 //id of variable Memory
	set l__bytecode[4] = 0x0C010400 //op: 0C(LITERAL), type: 04(integer), reg: 01, value: 0
	set l__bytecode[6] = 0x27000000 //op: 27(RETURN)

	set l__bytecode[8] = 0x07090000 //op: 07(GLOBAL), type: 09 (integer array) //Create new array
	set l__bytecode[9] = 0x0C5F //name: C5F(stand)
	set l__bytecode[10] = 0x0E010400 //op: 0E(GETVAR), type: 04(integer), reg: 01 //Obtain the desired amount of bytes
	set l__bytecode[11] = id+1		 //id of variable bytecodedata (variable ids are sequential)
	set l__bytecode[12] = 0x12010100 //op: 12(SETARRAY), index=reg01, value=reg01 //Set index of the array, forcing allocation of memory
	set l__bytecode[13] = 0x0C5F //name: C5F(stand)
	set l__bytecode[14] = 0x0E010400 //op: 0E(GETVAR), type: 04(integer), reg: 01 //Read array variable as an integer
	set l__bytecode[15] = 0x0C5F //name: C5F(stand)
	set l__bytecode[16] = 0x11010000 //op: 11(SETVAR), reg: 01 //pass the value to the jass world
	set l__bytecode[17] = id+1		 //id of variable bytecodedata
	set l__bytecode[18] = 0x27000000 //op: 27(RETURN)
endfunction

function Typecast takes nothing returns nothing
	local integer l__bytecode
endfunction
//# +nosemanticerror
function GetBytecodeAddress takes nothing returns integer
	return l__bytecode
endfunction

function NewGlobal takes nothing returns integer
	return -0x0C5F0704 //op: 07(GLOBAL), type: 04(integer), name: 0x0C5F("stand")
	return 0x2700 //op: 27(RETURN)
endfunction

function SetGlobal takes nothing returns nothing
//This will actually set the value of the global variable, not the local
	local integer stand= 0x2114D008
endfunction
//# +nosemanticerror
function UnlockMemory takes nothing returns nothing
	local integer array stand //The execution of this line is skipped
	call ForForce(bj_FORCE_PLAYER[0], I2C(2+C2I(function NewGlobal)))
	call ForForce(bj_FORCE_PLAYER[0], I2C(8+C2I(function SetGlobal)))
//	/*local array "stand" can now read memory, but not write.
//	The bytecode unlocks the ability to read and write memory
//	with the "Memory" array*/
	call InitArray( 0 )
	call InitArray(stand[GetArrayAddress()/4])
	call InitBytecode(stand[C2I(function ReadMemoryWorker)/4 + 13], stand[GetArrayAddress()/4+3]+4) //obtain the id of variable "Memory"
	call ForForce(bj_FORCE_PLAYER[0], I2C(stand[GetBytecodeAddress()/4+3])) //run bytecode from the array
endfunction

function malloc takes integer bytes returns integer
//creates virual array for any user data, allowing to use it. passed bytes value used to setup max index 
	set bytecodedata = bytes/4 + 4
	call ForForce(bj_FORCE_PLAYER[0], I2C(Memory[GetBytecodeAddress()/4+3]+32))
	return ( ReadUnrealMemory(bytecodedata/4+3) + 4 ) / 4 * 4  //Address of data in the newly created array
endfunction
// addr 0x10000 data 1C 2C 8A 7D 6D 5F 5A 4C 6C 3C 8C 7A
// read memory at 0x10003   ( 7D 6D 5F 5A )

function CreateIntegerFromTwoByOffset takes integer i1, integer i2, integer offset returns integer 
	local integer array pBytes
	set pBytes[0] = GetByteFromInteger(i1,4)
	set pBytes[1] = GetByteFromInteger(i1,3)
	set pBytes[2] = GetByteFromInteger(i1,2)
	set pBytes[3] = GetByteFromInteger(i1,1)
	set pBytes[4] = GetByteFromInteger(i2,4)
	set pBytes[5] = GetByteFromInteger(i2,3)
	set pBytes[6] = GetByteFromInteger(i2,2)
	set pBytes[7] = GetByteFromInteger(i2,1)
	return CreateInteger1(pBytes[offset+3],pBytes[offset+2],pBytes[offset+1],pBytes[offset+0])
endfunction


function CreateDoubleIntegerAndGetOne takes integer i1, integer i2, integer value, integer offset, boolean first returns integer
	local integer array pBytes
	set pBytes[0] = GetByteFromInteger(i1,4)
	set pBytes[1] = GetByteFromInteger(i1,3)
	set pBytes[2] = GetByteFromInteger(i1,2)
	set pBytes[3] = GetByteFromInteger(i1,1)
	set pBytes[4] = GetByteFromInteger(i2,4)
	set pBytes[5] = GetByteFromInteger(i2,3)
	set pBytes[6] = GetByteFromInteger(i2,2)
	set pBytes[7] = GetByteFromInteger(i2,1)
	
	set pBytes[offset] = GetByteFromInteger(value,4)
	set pBytes[offset+1] = GetByteFromInteger(value,3)
	set pBytes[offset+2] = GetByteFromInteger(value,2)
	set pBytes[offset+3] = GetByteFromInteger(value,1)
	
	if (first) then
		return CreateInteger1(pBytes[3],pBytes[2],pBytes[1],pBytes[0])
	else
		return CreateInteger1(pBytes[7],pBytes[6],pBytes[5],pBytes[4])
	endif
endfunction

function ReadRealMemory_FIX takes integer addr returns integer
	local integer ByteOffset = addr - ( addr / 4 * 4 )
	local integer FirstAddr = addr - ByteOffset
	set tt_str1="non-4 addr read "+Int2Hex(addr)
	call ExecuteFunc("JassLogWrapper")
	return CreateIntegerFromTwoByOffset(Memory[FirstAddr/4],Memory[FirstAddr/4+1], ByteOffset)
endfunction

function RMem takes integer addr returns integer
//	call StringCase(Int2Hex(addr)+" "+Int2Hex(val),false)
	
	if addr<MINIMAL_ACCESSABLE_ADDRESS or addr>0x7FFFFFFF then
		call FatalErrorNote("negative address read "+Int2Hex(addr))
		set tt_str1="negative address read "+Int2Hex(addr)
		call ExecuteFunc("JassLogWrapper")
		return 0
	endif
	if FastReadMemEnabled then
		return GetUnitCount(addr)
	endif
	if EXTRADLLLOADED then
		return GetTownUnitCount(addr,0,false)
	endif
	if addr/4*4!=addr then
//		call BJDebugMsg("ReadMemory WARNING! : " + Int2Hex(addr))
		return ReadRealMemory_FIX(addr)
	endif
	return Memory[addr/4]
endfunction

function WriteRealMemory_FIX takes integer addr, integer val returns nothing
	local integer Int_1	
	local integer Int_2
	local integer ByteOffset = addr - ( addr / 4 * 4 )
	local integer FirstAddr = addr - ByteOffset
	set tt_str1="non-4 addr write "+Int2Hex(addr)
	call ExecuteFunc("JassLogWrapper")
	set Int_1 = RMem(FirstAddr)
	set Int_2 = RMem(FirstAddr + 4)
	set Memory[FirstAddr/4]=CreateDoubleIntegerAndGetOne ( Int_1, Int_2, val, ByteOffset, true)
	set Memory[FirstAddr/4 + 1]=CreateDoubleIntegerAndGetOne ( Int_1, Int_2, val, ByteOffset, false)
endfunction

function WMem takes integer addr, integer val returns nothing
//	call StringCase(Int2Hex(addr)+" "+Int2Hex(val),false)
//	if FirstStringAddressKnown!=0 then
//		if addr-FirstStringAddressKnown < 0x10000 or FirstStringAddressKnown-addr > 0x10000 then
//			call BJDebugMsg("writting @ "+Int2Hex(addr)+" = "+I2S(val))
//		endif
//	endif
//	call BJDebugMsg("W "+Int2Hex(addr)+" "+Int2Hex(val))
	if addr<MINIMAL_ACCESSABLE_ADDRESS or addr>0x7FFFFFFF then
		call FatalErrorNote("negative address write "+Int2Hex(addr)+" val="+I2S(val))
		set tt_str1="negative address write "+Int2Hex(addr)
		call ExecuteFunc("JassLogWrapper")
		return
	endif
	if FastWriteMemEnabled then
		call AttackMoveXY(addr,val)
		return
	endif
	if EXTRADLLLOADED then
		call GetTownUnitCount(addr,val,true)
		return
	endif
//	if addr==Actual0xAB5948ForVersion then
//		call FatalErrorNote("0xAB5948 write val="+Int2Hex(val))
//		return
//	endif
	if addr/4*4!=addr then
		call WriteRealMemory_FIX(addr,val)
	else 
		call WriteUnrealMemory(addr/4, val)
	endif
endfunction

function WriteOffsetUnsafe takes integer i, integer v returns nothing
	call WMem(GameDLL+i,v)
endfunction

function ReadOffsetUnsafe takes integer i returns integer
	call BJDebugMsg("Reading "+Int2Hex(GameDLL+i)+" is equal to readin "+Int2Hex((GameDLL+i)/4*4))
	return  ReadUnrealMemory((GameDLL+i)/4)
endfunction

function ReadRealPointer1LVL takes integer addr, integer offset1 returns integer
	local integer retval = 0
	if addr > 0 then 
		set retval = RMem(addr)
		if addr > 0 then 
			set retval = RMem(retval + offset1)
		else 
			set retval = 0
		endif
	endif
	return retval
endfunction

function WriteRealPointer1LVL takes integer addr, integer offset1, integer val returns nothing
	local integer retval = 0
	if addr > 0 then 
		set retval = RMem(addr)
		if addr > 0 then 
			call WMem(retval + offset1,val)
		endif
	endif
endfunction

function ReadRealPointer2LVL takes integer addr, integer offset1, integer offset2 returns integer
	local integer retval = ReadRealPointer1LVL(addr,offset1)
	if retval > 0 then 
		set retval = RMem(retval + offset2)
	else
		set retval = 0
	endif
	return retval
endfunction

function WriteRealPointer2LVL takes integer addr, integer offset1, integer offset2, integer val returns nothing
	local integer retval = 0
	if addr > 0 then 
		set retval = ReadRealPointer1LVL(addr,offset1)
		if addr > 0 then 
			call WMem(retval + offset2,val)
		endif
	endif
endfunction

function ReadRealPointer3LVL takes integer addr, integer offset1, integer offset2, integer offset3 returns integer
	local integer retval = ReadRealPointer2LVL(addr,offset1,offset2)
	if retval > 0 then 
		set retval = RMem(retval + offset3)
	else
		set retval = 0
	endif
	return retval
endfunction

function WriteRealPointer3LVL takes integer addr, integer offset1, integer offset2,integer offset3, integer val returns nothing
	local integer retval = 0
	if addr > 0 then 
		set retval = ReadRealPointer2LVL(addr,offset1,offset2)
		if addr > 0 then 
			call WMem(retval + offset3,val)
		endif
	endif
endfunction

function ReadRealPointer4LVL takes integer addr, integer offset1, integer offset2, integer offset3, integer offset4 returns integer
	local integer retval = ReadRealPointer3LVL(addr,offset1,offset2,offset3)
	if retval > 0 then 
		set retval = RMem(retval + offset4)
	else
		set retval = 0
	endif
	return retval
endfunction

function WriteRealPointer4LVL takes integer addr, integer offset1, integer offset2,integer offset3, integer offset4, integer val returns nothing
	local integer retval = 0
	if addr > 0 then 
		set retval = ReadRealPointer3LVL(addr,offset1,offset2,offset3)
		if addr > 0 then 
			call WMem(retval + offset4,val)
		endif
	endif
endfunction

function ReadRealPointer5LVL takes integer addr, integer offset1, integer offset2, integer offset3, integer offset4, integer offset5 returns integer
	local integer retval = ReadRealPointer4LVL(addr,offset1,offset2,offset3,offset4)
	if retval > 0 then 
		set retval = RMem(retval + offset5)
	else
		set retval = 0
	endif
	return retval
endfunction

function WriteRealPointer5LVL takes integer addr, integer offset1, integer offset2,integer offset3, integer offset4,integer offset5, integer val returns nothing
	local integer retval = 0
	if addr > 0 then 
		set retval = ReadRealPointer4LVL(addr,offset1,offset2,offset3,offset4)
		if addr > 0 then 
			call WMem(retval + offset5,val)
		endif
	endif
endfunction

function IsJassNativeExists takes integer nativeaddress returns boolean
	local integer FirstAddress = ReadRealPointer2LVL(pJassEnvAddress, 0x14, 0x20)
	local integer NextAddress = FirstAddress
	local integer i = 0
	loop 
		if RMem(NextAddress+12) == nativeaddress then
			return NextAddress > 0
		endif
		
		set NextAddress = RMem(NextAddress)
		if NextAddress == FirstAddress or NextAddress == 0 then
			return false
		endif
	endloop
	return false
endfunction


function CreateJassNativeHook takes integer oldaddress, integer newaddress returns integer
//[[[[Game.dll+ADA848]+14]+20]
	local integer FirstAddress = ReadRealPointer2LVL(pJassEnvAddress, 0x14, 0x20)
	local integer NextAddress = FirstAddress
	
	local integer i = 0
	
	if RJassNativesBufferSize > 0 then 
		loop
			set i = i + 1
			
			if RJassNativesBuffer[  i * 3 - 3 ] == oldaddress or RJassNativesBuffer[ i * 3 - 2 ] == oldaddress or RJassNativesBuffer[  i * 3 - 3 ] == newaddress or RJassNativesBuffer[  i * 3 - 2 ] == newaddress then
				call WMem(RJassNativesBuffer[ i  * 3 - 1 ], newaddress)
//call BJDebugMsg("Loaded from buffset.")
				return RJassNativesBuffer[ i * 3 - 1 ]
			endif
			
			exitwhen i == RJassNativesBufferSize 
		endloop
	endif
	
	loop 
		if RMem(NextAddress+12) < 0x3000 then 
			return 0
		endif
		if RMem(NextAddress+12) == oldaddress then
			call WMem(NextAddress+12, newaddress)
// Maximum store 100 values for fast load
			if RJassNativesBufferSize < 100 then
				set RJassNativesBufferSize = RJassNativesBufferSize + 1
				set RJassNativesBuffer[ RJassNativesBufferSize  * 3 - 1 ] = NextAddress + 12
				set RJassNativesBuffer[ RJassNativesBufferSize  * 3 - 2 ] = oldaddress
				set RJassNativesBuffer[ RJassNativesBufferSize  * 3 - 3 ] = newaddress
			endif
			
			return NextAddress+12
		endif
		
		set NextAddress = RMem(NextAddress)
		if NextAddress == FirstAddress or NextAddress == 0 then
			return 0
		endif
	endloop
	return 0
endfunction

function Init26 takes nothing returns nothing
	local integer base
	set GameDLL = RMem(GetBytecodeAddress())-0x951060
	set base=GameDLL / 4
	set GameState = GameDLL + 0xAB65F4
	set pGameClass1 = GameDLL + 0xAB7788
	set pGameClass2 = GameDLL + 0xAB4F80 
	set pCGameState = GameDLL + 0xAB6EA4 
	
	set pointers = RMem(pGameClass1)
	set pUnitData = GameDLL + 0xAB4478
	set pAbilityData = GameDLL + 0xAB3E64
	
	set pGlobalPlayerClass = GameState //base + 0xAB65F4 / 4 

	set pUnitMaxSpeedConstant = GameDLL + 0xAB4440 
	set pUnitMinSpeedConstant = GameDLL + 0xAB443C 
	set pBuildingMaxSpeedConstant = GameDLL + 0xAB4448 
	set pBuildingMinSpeedConstant = GameDLL + 0xAB4444 
	
	set pUnitMaxSpeedConstantD = GameDLL + 0xAB4450
	set pUnitMinSpeedConstantD = GameDLL + 0xAB444C 
	set pBuildingMaxSpeedConstantD = GameDLL + 0xAB4458 
	set pBuildingMinSpeedConstantD = GameDLL + 0xAB4454 
	
	set pUnitUIDefAddr = GameDLL + 0xAB58F0 
	set pUnitDataDefAddr = pUnitData
	set pItemDataNode=GameDLL+0xAB4BE8
	
	set pAbilityUIDefAddr = GameDLL + 0xAB5918 
	set pAbilityDataDefAddr = pAbilityData
	
	set pAttackSpeedLimit = GameDLL + 0xAB0074 
	set pAttackTimeLimit = GameDLL + 0xAAE484 

	
	set pJassEnvAddress = GameDLL + 0xADA848 
	set pLightEnv = GameDLL + 0xAAE788 
	set pGameClass3 = GameDLL + 0xACE670 
	
	set pTimerAddr = GameDLL + 0xAB7368 
	
	
	set pGetModuleHandle = GameDLL + 0x86D1D0 
	set pGetProcAddress = GameDLL + 0x86D280 
	set pVirtualAlloc = GameDLL + 0x86D0F4 
	
	
	set pMergeUnits = GameDLL + 0x2DD320
	set pIgnoredUnits = GameDLL + 0x2DCE80
	set pConvertUnits = GameDLL + 0x2DD2E0
	set pGetUnitCount = GameDLL + 0x2DD050
	set pAttackMoveXY = GameDLL + 0x2DDC10
	set pLeaderboardSetItemLabelColor = base + 0x3CC5B0 / 4
	
	set pExportFromMpq = GameDLL + 0x737F00 
	set pGetFrameItemAddress = GameDLL + 0x5FA970 
	set pGetFrameSkinAddress = GameDLL + 0x31F530
	set pGetFrameTextAddress = GameDLL + 0x61C7B0
	set pUpdateFrameText = GameDLL + 0x60CA10

	set pFrameDefClass = GameDLL + 0xACD264
	
	set pPacketClass = GameDLL + 0x932D2C
	set pPacketSend = GameDLL + 0x54D970
	
	
	set pConvertString = GameDLL + 0x3BAA20
	set pConvertString2 = GameDLL + 0x39F5F0
	
	set pStorm279 = GameDLL + 0x86D5B8 
	
	set pPrintText1 = GameDLL + 0x2F3CF0 
	set pPrintText2 = GameDLL + 0x2F3CB0 
	set pPrintText3 = GameDLL + 0x6049B0
	
	set pChangeFont = GameDLL + 0x7AE910
	
	set pCameraDefaultHeight = GameDLL + 0x93645C 
	
	set pPingMinimapOffset = GameDLL + 0x3B4650 
	set pPingMinimapExOffset = GameDLL + 0x3B8660 
	
	set pAllianceOutput = GameDLL + 0x2FB1F0 
	
	set pWindowIsActive = GameDLL + 0xA9E7A4 
	set pSendCommandWithoutTarget = GameDLL + 0x339C60 
	set pMissile = GameDLL + 0xAB4CD8 
	
		
	set pOrder1_offset = GameDLL + 0x339C60 
	set pOrder2_offset = GameDLL + 0x339CC0 
	set pOrder3_offset = GameDLL + 0x339D50 
	set pOrder4_offset = GameDLL + 0x339DD0 
	set pOrder5_offset = GameDLL + 0x339E60 
	set pOrder6_offset = GameDLL + 0x339F00 
	set pOrder7_offset = GameDLL + 0x339F80 
	set pOrder8_offset = GameDLL + 0x33A010 
	
	set Order1_lockedvalue = 0x900010C2
	set Order2_lockedvalue = 0x900018C2
	set Order3_lockedvalue = 0x900014C2
	set Order4_lockedvalue = 0x90001CC2
	set Order5_lockedvalue = 0x900020C2
	set Order6_lockedvalue = 0x900014C2
	set Order7_lockedvalue = 0x90001CC2
	set Order8_lockedvalue = 0x900020C2
	
	set pStartAbilityCD = GameDLL + 0x126990 
		
	set pUpdateFogManual = GameDLL + 0x4299e0
	
	set pFogUpdateBlockAddr = GameDLL  + 0x42fcd4 
	set pFogUpdateBlockAddrNew1 = 0x0004C200
	set pFogUpdateBlockAddrNew2 = 0x01B89090
	
	set OPLimitAddress1=GameDLL+0x3A8388
	set OPLimitAddress2=GameDLL+0x3A838C
	
	set pCycloneFixCondition=GameDLL+0x29C25C
	

	set pCaptionsOverTheCreeps=GameDLL+0x35BB20
	
	set pPhaseShiftInvisibilityFlagByte=GameDLL+0x135D9C
	
	set pGetUnitAbility = GameDLL + 0x787D0
	set pGetUnitAddress = GameDLL + 0x3BDCB0
	set p_sprintf = GameDLL + 0x86D32C
	
	set pMemcpy = GameDLL + 0x86D3CC
	
	set pSearchStringValue = GameDLL + 0x5C8ED0
	set pSearchStringAddr1 = GameDLL + 0xACD23C
	set pSearchStringAddr2 = GameDLL + 0xACD214
	
	set pSimulateAttackInstance = GameDLL + 0xCF660
	set pGameTime = GameDLL + 0xAB7E98	
	
	set pSetStunToUnitTRUE = GameDLL+0x2A6440
	set pSetStunToUnitFALSE = GameDLL+0x282B30
	
	
	set pCommonSilence=GameDLL+0x076770
	set pAddSilenceOnAbility=GameDLL+0x052B60
	set pRemoveSilenceFromAbility=GameDLL+0x052BC0
	set pPauseUnitDisabler=GameDLL+0x0767F0
	
	set pUpdateUnitsSpeedCurrent=GameDLL+0x4A73F0
	
	set pCastSilenceToTarget=GameDLL+0xB65F0
	
	set pCastAbility=GameDLL+0x05C3A0
	
	set pDamageBlockIllusionCheck=GameDLL+0x1EA0F8
	
	set pItemDropOrderTriggerFix=GameDLL+0x29E064//9090c83b

	set pGetOrLoadFile = GameDLL + 0x4C1300	
	
	set StoreIntegerOffset = GameDLL + 0x3CA0A0
	
	set pUnitVtable = GameDLL + 0x931934
	set pRealUnitDamageHandler = GameDLL + 0x2A40D0
	set pTriggerExecute = GameDLL + 0x3C3F40
	set pMissileFuncStart = GameDLL+0xCF660
	set pMissileJumpBack = GameDLL+0xCF667
	
	set pPacketHandler = GameDLL + 0x550914
	set pPacketHandler2 = GameDLL + 0x55091A
	set pPacketHandler3 = GameDLL + 0x551475
	set pPacketHandler4 = GameDLL + 0x55148F
	set pPacketHandler5 = GameDLL + 0x87529C
	
	
	set pMissTexttag=GameDLL+0x2BB970
	set pBountyTextTag=GameDLL+0x28BAD0
	
	set pPlaySoundOfAbility=GameDLL+0x0214A0
	
	
	set pRemoveBuffs=GameDLL+0x079FE0
	set pMapGridDataSource=GameDLL+0x01F5A0
	
	set pGetBuffTooltipsFunc=GameDLL+0x2F7630
	set pSkipBuffExistCheck=GameDLL+0x2F763C
	set pSkipBuffExistCheckFoolish=0x9090C085
	
	set pGetHandleIDStackCounter=GameDLL+0x3A8060
	set pConvertAddressToHandleId=GameDLL+0x430C80
	
	set pMorphUnitIntoAnother=GameDLL+0x2A1F20
	
	
	set pMinimapData=RMem(GameDLL+0xAB6214)
	set pRedrawMinimap=GameDLL+0x36E8B0
//	set pPhoenixFireRemove0Dmg=GameDLL+0x2BCA5C
//	set PhoenixFireRemove0DmgDefaultVal=0x5374C085
	
	set pBerserkOrderAddr=GameDLL+0x1C6C40
	
	set pRefreshUnitsCommandPanel=GameDLL+0x277570
	
	set pEnableCleaveBaseAddress=GameDLL+0x1B731C
	set CleaveFixBaseValue=0x3309EB00
	
	set pRedrawUnitFunction=GameDLL+0x284830
	set pDrawTextAtResourcePanel=GameDLL+0x60CA10
	
	set pConstantReduceOfABlinkRange=GameDLL+0xAAE4EC
	set pUnderRangeJumper=GameDLL+0x1AEF94
	set UnderRangeJumperFixed=0x0EEB41C4
	set pInterfaceErrorSimulation=GameDLL+0x3333D0
	set pResetShopCooldownFunc=GameDLL+0x477D30
	
	set pAddFrostColoringToUnit=GameDLL+0x279230
	set pRemoveFrostColoringToUnit=GameDLL+0x279270
	
	set pAddRessurectionRedFilterToUnit=GameDLL+0x279250
	set pAgileCpp=RMem(GameDLL+0xAB7368)
	set pLoadingScreenBarFrame=RMem(GameDLL+0xACCD6C)
	set pUpdateLoadingBarText=GameDLL+0x611D40
	
	set pDisplayCooldownWhileSilenced=GameDLL+0x3791C
	set DisplayCooldownWhileSilencedDefaultVal=0x85909000
	
	set pFindGlobalStringAddress=GameDLL+0x5C8ED0
	set FindGlobalStringHash1=GameDLL+0xACD23C
	set FindGlobalStringHash2=GameDLL+0xACD214
	
	set pShareVisionWrapper=GameDLL+0x284DA0
	set ShareVisionWrapperDefaultValue=RMem(pShareVisionWrapper)
	set ShareVisionWrapperBrokenValue=0x2D8B55C3
	
	set pNeutralsAuraAggroFix=GameDLL+0x2549CC
	set NeutralsAuraAggroFixValue=0x8B3AEBFF
	
	set pGetAbilityUIDef=GameDLL+0x02E640
	set pGetAbilityUIDefAlt=GameDLL+0x32C8E0
		
	set pGetUnitUIDefAddr=GameDLL+0x32C880
	
	set pGetUnitDataDefAddrStatic=GameDLL+0xAB445C
	set pGetUnitDataDefAddrHelper=GameDLL+0x4C8520
	set pGetUnitDataDefAddr=GameDLL+0x29A8C0
	
	set pGetAbilityDataDefAddr=GameDLL+0x265ED0
	
	set pDisableGlobalMsg=GameDLL+0x40730
	set pDisableGlobalMsgBroken=0xEBC98548
	set pDisableGlobalSound=GameDLL+0x40744
	set pDisableGlobalSoundBroken=0xD2330EEB
	
	set pMeleeAttackCatcher=GameDLL+0xC6940
	set pKeyEventCatcher=GameDLL+0x308E70
	set pMissCalculations=GameDLL+0x2BEAC0
	set pRecountUnitsCollision=GameDLL+0x28D4F0
	
	set pConvertHandleNative=GameDLL+0x3BDCB0
	set pConvertUnitAddressToHandleIDNative=GameDLL+0x2DCC40
	
	set pGetFileSizeFromMPQNative=GameDLL+0x4C1550
	
	set pEndGameNative=GameDLL+0x3BBBB0
	
	set pCleaveConditionHook=GameDLL+0x1B7316//1B7310
	
	set pOnExitHookAddress=GameDLL+0x5A78F0
	set pOnExitHookAddressOnRestart=GameDLL+0x3A6AA0
	
	set pWaveTargetingFix=GameDLL+0x1D5B80
	set pChatMessageDurationDefault=GameDLL+0x934218
//	set pChatMessageDurationDefault2=GameDLL+0x934218
	
	set pSpellEffectStarts=GameDLL+0x5C840
	set pDisjoingHardcodedMissiles=GameDLL+0x2AB310
	
	set GameVersion = 0x26a
endfunction

function SetMaxUnitSpeed takes real r returns nothing
	call WMem(pUnitMaxSpeedConstant, mR2I(r))
	call WMem(pUnitMaxSpeedConstantD, mR2I(r))
endfunction

function GetMaxUnitSpeed takes nothing returns real
	return mI2R(RMem(pUnitMaxSpeedConstant))
endfunction

function SetMinUnitSpeed takes real r returns nothing
	call WMem(pUnitMinSpeedConstant, mR2I(r))
	call WMem(pUnitMinSpeedConstantD, mR2I(r))
endfunction

function GetMinUnitSpeed takes nothing returns real
	return mI2R(RMem(pUnitMinSpeedConstant))
endfunction

function SetMaxBuildingSpeed takes real r returns nothing
	call WMem(pBuildingMaxSpeedConstant, mR2I(r))
	call WMem(pBuildingMaxSpeedConstantD, mR2I(r))
endfunction

function GetMaxBuildingSpeed takes nothing returns real
	return mI2R(RMem(pBuildingMaxSpeedConstant))
endfunction

function SetMinBuildingSpeed takes real r returns nothing
	call WMem(pBuildingMinSpeedConstant, mR2I(r))
	call WMem(pBuildingMinSpeedConstantD, mR2I(r))
endfunction

function GetMinBuildingSpeed takes nothing returns real
	return mI2R(RMem(pBuildingMinSpeedConstant))
endfunction

function SetAttackSpeedLimit takes real r returns nothing
	call WMem(pAttackSpeedLimit, mR2I(r))
endfunction

function GetAttackSpeedLimit takes nothing returns real
	return mI2R(RMem(pAttackSpeedLimit))
endfunction

function SetAttackTimeLimit takes real r returns nothing
	call WMem(pAttackTimeLimit, mR2I(r))
endfunction

function GetAttackTimeLimit takes nothing returns real
	return mI2R(RMem(pAttackTimeLimit))
endfunction




function SaveConstantsValues takes nothing returns nothing
	set UnitMaxSpeedConstant =		GetMaxUnitSpeed( )
	set UnitMinSpeedConstant =		GetMinUnitSpeed( )
	set BuildingMaxSpeedConstant =	GetMaxBuildingSpeed( )
	set BuildingMinSpeedConstant =	GetMinBuildingSpeed( )
	set AttackSpeedLimit =			GetAttackSpeedLimit( )
endfunction



function ResetConstantsValues takes nothing returns nothing
	call SetMaxUnitSpeed(		UnitMaxSpeedConstant)
	call SetMinUnitSpeed( 		UnitMinSpeedConstant)
	call SetMaxBuildingSpeed(	BuildingMaxSpeedConstant )
	call SetMinBuildingSpeed(	BuildingMinSpeedConstant)
	call SetAttackSpeedLimit(	AttackSpeedLimit)
	call ExecuteFunc("RestoreCameraOffsets")
endfunction

// replace war3map.j to recovery.j
function LockOtherMaps takes nothing returns nothing
//0x6F636572
//0x726576
	
	
endfunction
// replace recovery.j back to war3map.j
function UnlockOtherMaps takes nothing returns nothing
//0x33726177
//0x70616D
	
	
endfunction
//library Memory ends
//library Bitwise:

function GetGameTypeSupported takes nothing returns integer
	return ReadRealPointer2LVL(GameState,48,48)
endfunction
//function BitwiseNot takes integer i returns integer
//	return 0xFFFFFFFF - i
//endfunction
//function BitwiseOrOld takes integer a,integer b returns integer
//	call WMem(RMem(RMem(GameState)+48)+48, a)
//	call SetGameTypeSupported(GAME_TYPE_ALL, false)
//	call SetGameTypeSupported(ConvertGameType(a), true)
//	call SetGameTypeSupported(ConvertGameType(b), true)
//	return GetGameTypeSupported()
//endfunction
//function BitwiseAndOld takes integer a,integer b returns integer
//	//call WMem(RMem(RMem(GameState)+48)+48, a)
//	call SetGameTypeSupported(GAME_TYPE_ALL, false)
//	call SetGameTypeSupported(ConvertGameType(a), true)
//	call SetGameTypeSupported(ConvertGameType(BitwiseNot(b)), false)
//	return GetGameTypeSupported()
//endfunction
//function BitwiseXorOld takes integer a,integer b returns integer
//	local integer i
//	//call WMem(RMem(RMem(GameState)+48)+48, a)
//	call SetGameTypeSupported(GAME_TYPE_ALL, false)
//	call SetGameTypeSupported(ConvertGameType(a), true)
//	call SetGameTypeSupported(ConvertGameType(b), false)
//	set i=GetGameTypeSupported()
//	call SetGameTypeSupported(ConvertGameType(b), true)
//	call SetGameTypeSupported(ConvertGameType(a), false)
//	call SetGameTypeSupported(ConvertGameType(i), true)
//	return GetGameTypeSupported()
//endfunction


function BitwiseOr takes integer arg1, integer arg2 returns integer
	local integer retval
	
	if NeedInitBitwiseOr then
		set NeedInitBitwiseOr = false
		call WMem(pBitwiseOR_ExecutableMemory, 0x0424448B )
		call WMem(pBitwiseOR_ExecutableMemory + 4, 0x0824548B )
		call WMem(pBitwiseOR_ExecutableMemory + 8, 0xCCC3D009 )
	endif
	
	if pConvertUnitsOffset == 0 then 
		set pConvertUnitsOffset = CreateJassNativeHook(pConvertUnits,pBitwiseOR_ExecutableMemory )
	else
		call WMem(pConvertUnitsOffset, pBitwiseOR_ExecutableMemory)
	endif
	
	if pConvertUnitsOffset != 0 then 
		set retval = B2I(ConvertUnits( arg1,arg2 ))
		call WMem(pConvertUnitsOffset, pConvertUnits)
		return retval
	endif
	return 0
endfunction

function InitMyReadWriteMem takes nothing returns nothing
	call WMem(pReserverMemoryForFastMemRead, 0x0424448B )
	call WMem(pReserverMemoryForFastMemRead+4, 0x90C3008B)
		
	set pGetUnitCountOffset = CreateJassNativeHook(pGetUnitCount,pReserverMemoryForFastMemRead )
	
	if pGetUnitCountOffset != 0 then 
		set FastReadMemEnabled=true
	endif
	
//	call BJDebugMsg(Int2Hex(pReserverMemoryForFastMemWrite))
	call WMem(pReserverMemoryForFastMemWrite, 0x246C8B55)
	call WMem(pReserverMemoryForFastMemWrite+4, 0x24448B0C)
	call WMem(pReserverMemoryForFastMemWrite+8, 0x5D288908)
	call WMem(pReserverMemoryForFastMemWrite+12, 0x000090C3)
		
	set pAttackMoveXYOffset = CreateJassNativeHook(pAttackMoveXY,pReserverMemoryForFastMemWrite )
	
	if pAttackMoveXYOffset != 0 then 
		set FastWriteMemEnabled=true
	endif
endfunction

function BitwiseXor takes integer arg1, integer arg2 returns integer
	local integer retval
	
	if NeedInitBitwiseXor then
		set NeedInitBitwiseXor = false
		call WMem(pBitwiseXOR_ExecutableMemory, 0x0424448B )
		call WMem(pBitwiseXOR_ExecutableMemory + 4, 0x0824548B )
		call WMem(pBitwiseXOR_ExecutableMemory + 8, 0xCCC3D031 )
	endif
	
	if pConvertUnitsOffset == 0 then 
		set pConvertUnitsOffset = CreateJassNativeHook(pConvertUnits,pBitwiseXOR_ExecutableMemory )
	else
		call WMem(pConvertUnitsOffset, pBitwiseXOR_ExecutableMemory)
	endif
	
	if pConvertUnitsOffset != 0 then 
		set retval = B2I(ConvertUnits( arg1,arg2 ))
		call WMem(pConvertUnitsOffset,pConvertUnits)
		return retval
	endif
	return 0
endfunction

function BitwiseAnd takes integer arg1, integer arg2 returns integer
	local integer retval
	
	if NeedInitBitwiseAnd then
		set NeedInitBitwiseAnd = false
		call WMem(pBitwiseAND_ExecutableMemory, 0x0424448B )
		call WMem(pBitwiseAND_ExecutableMemory + 4, 0x0824548B )
		call WMem(pBitwiseAND_ExecutableMemory + 8, 0xCCC3D021 )
	endif
	
	if pConvertUnitsOffset == 0 then 
		set pConvertUnitsOffset = CreateJassNativeHook(pConvertUnits,pBitwiseAND_ExecutableMemory )
	else
		call WMem(pConvertUnitsOffset, pBitwiseAND_ExecutableMemory)
	endif
	
	if pConvertUnitsOffset != 0 then 
		set retval = B2I(ConvertUnits( arg1,arg2 ))
		call WMem(pConvertUnitsOffset, pConvertUnits)
		return retval
	endif
	return 0
endfunction
//library Bitwise ends
//library StringId:

function StringId__Int2Char takes integer i returns string
	local string s= Ascii2Char(i)
	if s == null then
		set s="\\x" + Int2Hex(i)
	endif
	return s
endfunction

function Id2String takes integer i returns string
	local string result= ""
	local integer char
	loop
		set char=i
		set i=i / 256
		set result=StringId__Int2Char(char - i * 256) + result
		exitwhen i == 0
	endloop
	return result
endfunction

function String2Id takes string s returns integer
	local integer result= 0
	local integer i= 0
	loop
		set result=result * 256 + Char2Ascii(SubString(s, i, i + 1))
		set i=i + 1
		exitwhen i == 4
	endloop
	return result
endfunction
//library StringId ends
//library ObjectData:


function IntegerHash takes integer i returns integer
	local integer a= 0x7FED7FED
	local integer b= 0xEEEEEEEE
	local integer byte
	loop
		set byte=i * 16777216 / 16777216
		set a=BitwiseXor(a + b , H[byte])
		set i=i / 256
		exitwhen i == 0
		set b=b * 32 + a + b + byte + 3
	endloop
	return a
endfunction

function GetObjectData takes integer pData,integer rawcode returns integer
	local integer hash	= IntegerHash(rawcode)
	local integer list	= RMem(pData) / 4 + ModuloInteger(hash, RMem(pData + 8) + 1) * 3
	local integer i	= ReadUnrealMemory(list + 2) / 4
	loop
		exitwhen i <= 0
		if ReadUnrealMemory(i) == hash and ReadUnrealMemory(i + 5) == rawcode then
			return i*4
		endif
		set i	=	ReadUnrealMemory(ReadUnrealMemory(list) / 4 + i + 1) / 4
	endloop
	return 0
endfunction

function GetObjectDataCaching takes integer pData, integer rawcode returns integer
	local integer k
	if HaveSavedInteger(ObjectDataPointersTable,pData,rawcode) then
		return LoadInteger(ObjectDataPointersTable,pData,rawcode)
	endif
	set k=GetObjectData(pData,rawcode)
	call SaveInteger(ObjectDataPointersTable,pData,rawcode,k)
	return k
endfunction

function ObjectData__Init takes nothing returns nothing
	set H[1]=0xA22E726E
	set H[2]=0xD43D94C0
	set H[3]=0x6DE064C7
	set H[4]=0xFE8D4B2F
	set H[5]=0x345A287E
	set H[6]=0x13941BCF
	set H[7]=0xD822114D
	set H[8]=0xA79E1270
	set H[9]=0xFB2D4CF9
	set H[10]=0xCB25DDAE
	set H[11]=0x7B5E64D5
	set H[12]=0x88544672
	set H[13]=0xF201BF3F
	set H[14]=0x677CAF6E
	set H[15]=0x34502020
	set H[16]=0x5DD18D92
	set H[18]=0x320F2252
	set H[19]=0xCBB1F259
	set H[20]=0x5C5ED8C1
	set H[21]=0x922BB610
	set H[22]=0x7165A961
	set H[23]=0x35F39EDF
	set H[24]=0x056FA002
	set H[25]=0x58FEDA8B
	set H[26]=0x28F76B40
	set H[27]=0xD92FF267
	set H[28]=0xE625D404
	set H[29]=0x4FD34CD1
	set H[30]=0xC54E3D00
	set H[31]=0x9221ADB2
	set H[32]=0x2BC26B40
	set H[33]=0xCDF0DDAE
	set H[35]=0x99A2D007
	set H[36]=0x2A4FB66F
	set H[37]=0x601C93BE
	set H[38]=0x3F56870F
	set H[39]=0x03E47C8D
	set H[40]=0xD3607DB0
	set H[41]=0x26EFB839
	set H[42]=0xF6E848EE
	set H[43]=0xA720D015
	set H[44]=0xB416B1B2
	set H[45]=0x1DC42A7F
	set H[46]=0x933F1AAE
	set H[47]=0x60128B60
	set H[48]=0x921F9B39
	set H[49]=0x344E0DA7
	set H[50]=0x665D2FF9
	set H[52]=0x90ACE668
	set H[53]=0xC679C3B7
	set H[54]=0xA5B3B708
	set H[55]=0x6A41AC86
	set H[56]=0x39BDADA9
	set H[57]=0x8D4CE832
	set H[58]=0x5D4578E7
	set H[59]=0x0D7E000E
	set H[60]=0x1A73E1AB
	set H[61]=0x84215A78
	set H[62]=0xF99C4AA7
	set H[63]=0xC66FBB59
	set H[64]=0x0172B4D1
	set H[65]=0xA3A1273F
	set H[66]=0xD5B04991
	set H[67]=0x6F531998
	set H[69]=0x35CCDD4F
	set H[70]=0x1506D0A0
	set H[71]=0xD994C61E
	set H[72]=0xA910C741
	set H[73]=0xFCA001CA
	set H[74]=0xCC98927F
	set H[75]=0x7CD119A6
	set H[76]=0x89C6FB43
	set H[77]=0xF3747410
	set H[78]=0x68EF643F
	set H[79]=0x35C2D4F1
	set H[80]=0xCBA5D782
	set H[81]=0x6DD449F0
	set H[82]=0x9FE36C42
	set H[83]=0x39863C49
	set H[84]=0xCA3322B1
	set H[86]=0xDF39F351
	set H[87]=0xA3C7E8CF
	set H[88]=0x7343E9F2
	set H[89]=0xC6D3247B
	set H[90]=0x96CBB530
	set H[91]=0x47043C57
	set H[92]=0x53FA1DF4
	set H[93]=0xBDA796C1
	set H[94]=0x332286F0
	set H[95]=0xFFF5F7A2
	set H[96]=0xEC6BE431
	set H[97]=0x8E9A569F
	set H[98]=0xC0A978F1
	set H[99]=0x5A4C48F8
	set H[100]=0xEAF92F60
	set H[101]=0x20C60CAF
	set H[103]=0xC48DF57E
	set H[104]=0x9409F6A1
	set H[105]=0xE799312A
	set H[106]=0xB791C1DF
	set H[107]=0x67CA4906
	set H[108]=0x74C02AA3
	set H[109]=0xDE6DA370
	set H[110]=0x53E8939F
	set H[111]=0x20BC0451
	set H[112]=0x27DDEEB3
	set H[113]=0xCA0C6121
	set H[114]=0xFC1B8373
	set H[115]=0x95BE537A
	set H[116]=0x266B39E2
	set H[117]=0x5C381731
	set H[118]=0x3B720A82
	set H[120]=0xCF7C0123
	set H[121]=0x230B3BAC
	set H[122]=0xF303CC61
	set H[123]=0xA33C5388
	set H[124]=0xB0323525
	set H[125]=0x19DFADF2
	set H[126]=0x8F5A9E21
	set H[127]=0x5C2E0ED3
	set H[128]=0x5861ED90
	set H[129]=0xFA905FFE
	set H[130]=0x2C9F8250
	set H[131]=0xC6425257
	set H[132]=0x56EF38BF
	set H[133]=0x8CBC160E
	set H[134]=0x6BF6095F
	set H[135]=0x3083FEDD
	set H[137]=0x538F3A89
	set H[138]=0x2387CB3E
	set H[139]=0xD3C05265
	set H[140]=0xE0B63402
	set H[141]=0x4A63ACCF
	set H[142]=0xBFDE9CFE
	set H[143]=0x8CB20DB0
	set H[144]=0x04D2B307
	set H[145]=0xA7012575
	set H[146]=0xD91047C7
	set H[147]=0x72B317CE
	set H[148]=0x035FFE36
	set H[149]=0x392CDB85
	set H[150]=0x1866CED6
	set H[151]=0xDCF4C454
	set H[152]=0xAC70C577
	set H[154]=0xCFF890B5
	set H[155]=0x803117DC
	set H[156]=0x8D26F979
	set H[157]=0xF6D47246
	set H[158]=0x6C4F6275
	set H[159]=0x3922D327
	set H[160]=0x34DA2252
	set H[161]=0xD70894C0
	set H[162]=0x0917B712
	set H[163]=0xA2BA8719
	set H[164]=0x33676D81
	set H[165]=0x69344AD0
	set H[166]=0x486E3E21
	set H[167]=0x0CFC339F
	set H[168]=0xDC7834C2
	set H[169]=0x30076F4B
	set H[171]=0xB0388727
	set H[172]=0xBD2E68C4
	set H[173]=0x26DBE191
	set H[174]=0x9C56D1C0
	set H[175]=0x692A4272
	set H[176]=0x84A19B2B
	set H[177]=0x26D00D99
	set H[178]=0x58DF2FEB
	set H[179]=0xF281FFF2
	set H[180]=0x832EE65A
	set H[181]=0xB8FBC3A9
	set H[182]=0x9835B6FA
	set H[183]=0x5CC3AC78
	set H[184]=0x2C3FAD9B
	set H[185]=0x7FCEE824
	set H[186]=0x4FC778D9
	set H[188]=0x0CF5E19D
	set H[189]=0x76A35A6A
	set H[190]=0xEC1E4A99
	set H[191]=0xB8F1BB4B
	set H[192]=0x77ABB98E
	set H[193]=0x19DA2BFC
	set H[194]=0x4BE94E4E
	set H[195]=0xE58C1E55
	set H[196]=0x763904BD
	set H[197]=0xAC05E20C
	set H[198]=0x8B3FD55D
	set H[199]=0x4FCDCADB
	set H[200]=0x1F49CBFE
	set H[201]=0x72D90687
	set H[202]=0x42D1973C
	set H[203]=0xF30A1E63
	set H[205]=0x69AD78CD
	set H[206]=0xDF2868FC
	set H[207]=0xABFBD9AE
	set H[208]=0x0DFE40C1
	set H[209]=0xB02CB32F
	set H[210]=0xE23BD581
	set H[211]=0x7BDEA588
	set H[212]=0x0C8B8BF0
	set H[213]=0x4258693F
	set H[214]=0x21925C90
	set H[215]=0xE620520E
	set H[216]=0xB59C5331
	set H[217]=0x092B8DBA
	set H[218]=0xD9241E6F
	set H[219]=0x895CA596
	set H[220]=0x96528733
	set H[222]=0x757AF02F
	set H[223]=0x424E60E1
	set H[224]=0x98835092
	set H[225]=0x3AB1C300
	set H[226]=0x6CC0E552
	set H[227]=0x0663B559
	set H[228]=0x97109BC1
	set H[229]=0xCCDD7910
	set H[230]=0xAC176C61
	set H[231]=0x70A561DF
	set H[232]=0x40216302
	set H[233]=0x93B09D8B
	set H[234]=0x63A92E40
	set H[235]=0x13E1B567
	set H[236]=0x20D79704
	set H[237]=0x8A850FD1
	set H[239]=0xCCD370B2
	set H[240]=0xCBAFDFE0
	set H[241]=0x6DDE524E
	set H[242]=0x9FED74A0
	set H[243]=0x399044A7
	set H[244]=0xCA3D2B0F
	set H[245]=0x000A085E
	set H[246]=0xDF43FBAF
	set H[247]=0xA3D1F12D
	set H[248]=0x734DF250
	set H[249]=0xC6DD2CD9
	set H[250]=0x96D5BD8E
	set H[251]=0x470E44B5
	set H[252]=0x54042652
	set H[253]=0xBDB19F1F
	set H[254]=0x332C8F4E
endfunction
//library ObjectData ends
//library Utils:

function IsFlagBitSet takes integer flags, integer bit returns boolean
	if bit!=0 then
		return flags/bit*0x80000000 != 0
	endif
	return false
endfunction

function SetFlagBit takes integer addr, integer bit returns boolean
	local integer a=RMem(addr)
	local boolean b=IsFlagBitSet(a,bit)
	if not b then
		call WMem(addr,a+bit)
		return true
	endif
	return false
endfunction

function ConvertHandle takes handle h returns integer
	if GetHandleId(h)>0 then
		return RMem(RMem(RMem(RMem(GameState) + 28)  + 412) + GetHandleId(h) * 12 - 0x2FFFFF * 4)
	endif
	return 0
endfunction

function ConvertPointer takes integer ptr returns integer
	local integer i= RMem(ptr)
	if i < 0 then
		return RMem(RMem(pointers + 44)  - i * 8 + 4) //checkme
	endif
	return RMem(RMem(pointers + 12)  + i * 8 + 4)
endfunction

function GetUnitFlags0x5C takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return RMem(LastConvertedHandle + 0x5C)
	endif
	return 0
endfunction

function SetUnitFlags0x5C takes unit u,integer i returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call WMem(LastConvertedHandle + 0x5C, i)
	endif
endfunction

function AddUnitFlags0x5C takes unit u,integer i returns nothing
	local integer f
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set f=RMem(LastConvertedHandle + 0x5C)
		if i>0 then
			if not IsFlagBitSet(f,i) then
				call WMem(LastConvertedHandle + 0x5C,f+i)
			endif
		else
			if IsFlagBitSet(f,-i) then
				call WMem(LastConvertedHandle + 0x5C,f+i)
			endif
		endif
	endif
endfunction
//armor types:
// 0 - Light; 1 - Medium; 2 - Heavy; 3 - Fortified; 4 - Normal; 5 - Hero; 6 - Divine; 7 - unarmored; 
//rest seems to have Light properties
function GetUnitArmorType takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return RMem(LastConvertedHandle + 0xE4)
	endif
	return 0
endfunction

function SetUnitArmorType takes unit u, integer id returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call WMem(LastConvertedHandle + 0xE4,id)
	endif
endfunction

function GetUnitArmor takes unit u returns real
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return mI2R(RMem(LastConvertedHandle + 0xE0))
	endif
	return 0.
endfunction

function SetUnitArmor takes unit u,real r returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call WMem(LastConvertedHandle + 0xE0, mR2I(r))
	endif
endfunction

function SetUnitTypeId takes unit u,integer i returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call WMem(LastConvertedHandle + 0x30,i)
	endif
endfunction

function GetUnitTypeIdReal takes integer i returns integer
	return RMem(i + 0x30)
endfunction

function GetUnitTypeId2 takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return GetUnitTypeIdReal(LastConvertedHandle)
	endif
	return 0
endfunction

function GetUnitFlags0x20 takes unit u returns integer
	local integer a=ConvertHandle(u)
	if a>0 then
		return RMem(a+0x20)
	endif
	return 0
endfunction

function SetUnitFlags0x20 takes unit u,integer i returns nothing
	local integer a=ConvertHandle(u)
	if a>0 then
		call WMem(a+0x20,i)
	endif
endfunction

function AddUnitFlags0x20 takes unit u, integer flag returns nothing
	local integer a=ConvertHandle(u)
	local integer f
	if a>0 then
		set f=RMem(a+0x20)
		if IsFlagBitSet(f,flag) then
			return
		endif
		call WMem(a+0x20,f+flag)
	endif
endfunction

function GetUnitFlags0x248 takes unit u returns integer
	local integer a=ConvertHandle(u)
	if a>0 then
		return RMem(a+0x248)
	endif
	return 0
endfunction

function SetUnitFlags0x248 takes unit u,integer i returns nothing
	local integer a=ConvertHandle(u)
	if a>0 then
		call WMem(a+0x248,i)
	endif
endfunction

function AddUnitFlags0x248 takes unit u, integer flag returns nothing
	local integer a=ConvertHandle(u)
	local integer f
	if a>0 then
		set f=RMem(a+0x248)
		if IsFlagBitSet(f,flag) then
			return
		endif
		call WMem(a+0x248,f+flag)
	endif
endfunction

function ModifyUnitFlags0x20 takes unit u, integer flag returns nothing
	local integer a=ConvertHandle(u)
	local integer f
	if a>0 then
		set f=RMem(a+0x20)
		if flag>0 then
			if IsFlagBitSet(f,flag) then
				return
			endif
			call WMem(a+0x20,f+flag)
		else
			if IsFlagBitSet(f,-flag) then
				call WMem(a+0x20,f+flag)
			endif
		endif
	endif
endfunction
// Real - addres in memory

function GetRealPlayerById takes integer i returns integer
	local integer pladdr =  RMem(pGlobalPlayerClass)
	if pladdr>0 then
		return RMem(pladdr + ( i * 4 ) + 0x58)
	endif
	return 0
endfunction

function GetLocalPlayerIdReal takes nothing returns integer
	local integer pladdr = RMem(pGlobalPlayerClass)
	if pladdr>0 then
		return RMem(pladdr + 0xA)
	endif
	return -1
endfunction

function GetLocalPlayerReal takes nothing returns integer
	return GetRealPlayerById(GetLocalPlayerIdReal( ) )
endfunction
// Get Selected Unit
function GetPlayerSelectedUnitReal takes integer realplayer returns integer
	local integer pladdr = realplayer + 0x34
	set pladdr = RMem(pladdr)
	if pladdr>0 then
		return RMem(pladdr + 0x1E0)
	endif
	return -1
endfunction


function SetPlayerSelectedUnitReal takes integer realplayer, integer pConvertedHandle returns nothing
	local integer pladdr = realplayer + 0x34
	set pladdr = RMem(pladdr)
	if pladdr>0 then
		call WMem(pladdr + 0x1E0, pConvertedHandle)
	endif
endfunction
//function GetUnitVertexColorB takes unit u returns integer
//	return GetByteFromInteger(ReadUnrealMemory((ReadUnrealMemory(ConvertHandle(u) / 4 + 0xA)+328)/4),4)
//endfunction
//function GetUnitVertexColorG takes unit u returns integer
//	return GetByteFromInteger(ReadUnrealMemory((ReadUnrealMemory(ConvertHandle(u) / 4 + 0xA)+328)/4),3)
//endfunction
//function GetUnitVertexColorR takes unit u returns integer
//	return GetByteFromInteger(ReadUnrealMemory((ReadUnrealMemory(ConvertHandle(u) / 4 + 0xA)+328)/4),2)
//endfunction
//function GetUnitVertexColorA takes unit u returns integer
//	return GetByteFromInteger(ReadUnrealMemory((ReadUnrealMemory(ConvertHandle(u) / 4 + 0xA)+328)/4),1)
//endfunction
//function GetUnitVertexColorB_2 takes unit u returns integer
//	return GetByteFromInteger(ReadUnrealMemory(ConvertHandle(u) / 4 + 181),4)
//endfunction
//function GetUnitVertexColorG_2 takes unit u returns integer
//	return GetByteFromInteger(ReadUnrealMemory(ConvertHandle(u) / 4 + 181),3)
//endfunction
//function GetUnitVertexColorR_2 takes unit u returns integer
//	return GetByteFromInteger(ReadUnrealMemory(ConvertHandle(u) / 4 + 181),2)
//endfunction
//function GetUnitVertexColorA_2 takes unit u returns integer
//	return GetByteFromInteger(ReadUnrealMemory(ConvertHandle(u) / 4 + 181),1)
//endfunction
//function SetUnitColorDirectlyForAddresss takes integer pConvertedHandle, integer red, integer green, integer blue, integer alpha returns nothing
//	//, real fadetime returns nothing
//	local integer resultcolor = CreateInteger1(alpha,red,green,blue)
//	local integer colorflag = 0
//	local integer a
//	if pConvertedHandle>0 then
//		set a=RMem(pConvertedHandle + 0x28)
//		if a>0 then
//			//call WriteUnrealMemory((ReadUnrealMemory(pConvertedHandle / 4 + 0xA)+324)/4, cleanInt(realToIndex(fadetime)))
//			call WMem(a+0x148, resultcolor)
//			call WMem(a+0x140, 0)
//			call WMem(a+0x13C, 0)
//			set colorflag = RMem(a+0x138)
//			if not IsFlagBitSet(colorflag,0x800) then
//				call WMem(a+0x138, colorflag+0x800)
//			endif
//		endif
//	endif
//endfunction

function GetUnitColor takes handle h returns integer
	local integer a=ConvertHandle(h)
	if a>0 then
		set a=RMem(a+0x28)
		if a>0 then
			return RMem(a+0x148)
		endif
	endif
	return 0
endfunction

function echo takes string s returns nothing
	if IsL1ch then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,s)
	endif
endfunction

function DelayedCallback takes real delay, code callback returns integer
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call FlushChildHashtable(HY,h)
	call TimerStart(t,delay,false,callback)
	set t=null
	return h
endfunction

function CleanExpiredTimer takes nothing returns nothing
	set tt_timer1=GetExpiredTimer()
	call FlushChildHashtable(HY,GetHandleId(tt_timer1))
	call DestroyTimer(tt_timer1)
endfunction


function SetUnitColorDirectly takes unit u, integer red, integer green, integer blue, integer alpha returns nothing
//	call SetUnitColorDirectlyForAddresss(ConvertHandle(u),red,green,blue,alpha)
endfunction

function GetJassContext takes integer id returns integer
	return Memory[Memory[Memory[Memory[pJassEnvAddress/4]/4+5]/4+36]/4+id]
endfunction

function GetStringAddress takes string s returns integer
	if s==EXTRADLLNAME then
		if ExtraDLLStringAddress==0 then
			set ExtraDLLStringAddress=Memory[Memory[Memory[Memory[GetJassContext(1)/4+2589]/4+2]/4+SH2I(EXTRADLLNAME)*4+2]/4+7]
		endif
		return ExtraDLLStringAddress
	elseif s=="" or s==null then
		if NullStringAddress==0 then
			set NullStringAddress=Memory[Memory[Memory[Memory[GetJassContext(1)/4+2589]/4+2]/4+SH2I("")*4+2]/4+7]
		endif
		return NullStringAddress
	endif
	return Memory[Memory[Memory[Memory[GetJassContext(1)/4+2589]/4+2]/4+SH2I(s)*4+2]/4+7]

endfunction

function GetFirstJassStringAddress takes nothing returns integer
	if FirstJassStringAddress>0 then
		return FirstJassStringAddress
	endif
	set FirstJassStringAddress=RMem(RMem(RMem(GetJassContext(1)+0x2874)+8)+SH2I(I2SH(0))*16+8)
	return FirstJassStringAddress
endfunction

//function InitGetStringAddress takes nothing returns nothing
//	set GlobalJassStringAddr = RMem(RMem(GetJassContext(1)+0x2874)+8)+SH2I(GlobalJassString)*4*4+8
//endfunction

//1 = str, 2 = int, 3 = agi
function GetHeroPrimaryAttribute takes unit u returns integer
	local integer a=ConvertHandle(u)
	if a>0 then
		set a=RMem(a + 0x1F0)
		if a>0 then
			return RMem(a+0xCC)
		endif
	endif
	return 0
endfunction

function SetHeroPrimaryAttribute takes unit u,integer i returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		if IsHeroUnitId(GetUnitTypeId(u)) then
			set LastConvertedHandle=RMem(LastConvertedHandle + 0x1F0)
			if LastConvertedHandle>0 then
				call WMem(LastConvertedHandle + 0xCC,i)
			endif
		endif
	endif
endfunction

function PrintJassNatives takes nothing returns nothing
	local integer FirstAddress = RMem(RMem(RMem(pJassEnvAddress)+20)+32)
	local integer NextAddress = FirstAddress
	call PreloadEndEx()
	call PreloadGenClear()
	call PreloadGenStart()
	loop 
		set NextAddress = RMem(NextAddress)
		set testFunctionCount = testFunctionCount + 1
		call Preload("native add "+Int2Hex(RMem(NextAddress+0xC)))
		if NextAddress == FirstAddress or NextAddress <= 0 then
			call PreloadGenEnd("natives"+R2S(GetRandomReal(0,500))+".txt")
			call PreloadGenClear()
			return 
		endif
	endloop
endfunction

function AddAbilityCooldownConverted takes integer a, real seconds returns nothing
	local integer pData = RMem(a+0xDC)
	if pData > 0 then
		call WMem(pData+4, mR2I(seconds + mI2R(RMem(pData+4))) )
	endif
endfunction

function GetAbilityCurrentCooldownConverted takes integer a returns real
	local integer pData = RMem(a+0xDC)
	if pData > 0 then
		return mI2R(RMem(pData+4)) - mI2R(RMem(RMem(pData+0xC)+0x40))
	endif
	return .0
endfunction
//function GetRealGameTime takes nothing returns integer 
//desync-able, do not use
//returns ms value (1s = 1000 here)
//	return RMem(pGameTime)
//endfunction

function IsAbilityOnCooldown takes integer a returns boolean
	return IsFlagBitSet(RMem(a+0x20),512)
endfunction

function SetAbilityDisabled takes integer pAbility, integer count returns nothing
	if pAbility>0 then
		call WMem(pAbility+0x3C, count)
	endif
//not safe unless used with PauseUnit. Button will be blacked, but current casts of that ability wont be interrupted.
endfunction

function GetAbilityDisabledCount takes integer pAbility returns integer
	if pAbility>0 then
		return RMem(pAbility+0x3C)
	endif
	return 0
endfunction

function SetAbilityHidden takes integer pAbility, integer count returns nothing
	call WMem(pAbility+0x40, count)
//This one is 100% safe. This hides the ability button, and order cant be issued.
endfunction

function AddAbilityHidden takes integer a, integer d returns nothing
	call WMem(a+0x40, RMem(a+0x40)+d)
endfunction

function SetAbilityDisabled2 takes integer pAbility, integer count returns nothing
	call WMem(pAbility+0x44, count)
//This one is used by Orb of Slow or Windwalk. Button is blacked, but cooldown is stil displayed.
endfunction

function GetAbilityDisabled2 takes integer pAbility returns integer
	return RMem(pAbility+0x44)
endfunction

function DisableUnitsMovement takes unit u, boolean disable returns nothing
	local integer i=2
	local integer a=GetHandleId(u)
	if a<1 then
		return
	endif
	if disable==false then
		set i=1
	endif
	call PauseUnit(u,true)
	set a=ConvertHandle(u)
	if a>0 then
		set a=RMem(a+0x1EC)
		if a>0 then
			call SetAbilityDisabled(a, i)
		endif
	endif
	call PauseUnit(u,false)
endfunction

function IsInventorySilenced takes unit u returns boolean
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set LastConvertedHandle=RMem(LastConvertedHandle+0x1F8)
		if LastConvertedHandle>0 then
			return RMem(LastConvertedHandle+0x3C)>0
		endif
	endif
	return false
endfunction

function SetUnitPortrait takes integer uiobjectaddr, string s returns nothing
	call WMem(uiobjectaddr+0x34, GetStringAddress(s))
endfunction

function SetUnitModel takes integer uiobjectaddr, string s returns nothing
	call WMem(uiobjectaddr+0x30, GetStringAddress(s))
endfunction

function SetUnitModelUFAddress takes integer address, string s returns nothing
	call SetUnitModel(address,s)
endfunction

function GetUnitAttackAbilityForAddress takes integer pConvertedHandle returns integer
	return RMem(pConvertedHandle+0x1E8)
endfunction

function GetUnitAttackAbility takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return GetUnitAttackAbilityForAddress(LastConvertedHandle)
	endif
	return 0
endfunction

function IsUnitAttacking takes unit u returns boolean
	set LastConvertedHandle=GetUnitAttackAbility(u)
	if LastConvertedHandle>0 then
		return IsFlagBitSet(RMem(LastConvertedHandle+0x20),1)
	endif
	return false
endfunction

function IsUnitAttackingUnitIWantHimTo takes unit u, unit target returns boolean
	local integer a
	local integer k
	local integer hu=ConvertHandle(u)
	set LastConvertedHandle=GetUnitAttackAbilityForAddress(hu)
	if LastConvertedHandle>0 then
		if IsFlagBitSet(RMem(LastConvertedHandle+0x20),1) then
			set a=ConvertHandle(target)
			if a>0 then
				if RMem(LastConvertedHandle+0x6C)==RMem(a+0xC) and RMem(LastConvertedHandle+0x70)==RMem(a+0x10) then
					return true
				endif
			endif
		endif
	endif
	return false
endfunction

function SetUnitAttackAbilityForAddress takes integer pConvertedHandle,integer pAddr returns nothing
	call WMem(pConvertedHandle+0x1E8,pAddr)
endfunction

function SetUnitAttackAbility takes unit u , integer pAddr returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call SetUnitAttackAbilityForAddress(LastConvertedHandle,pAddr)
	endif
endfunction

function GetUnitMoveAbilityForAddress takes integer pConvertedHandle returns integer
	return RMem(pConvertedHandle+0x1EC)
endfunction

function GetUnitMoveAbility takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return GetUnitMoveAbilityForAddress(LastConvertedHandle)
	endif
	return 0
endfunction

function SetUnitMoveAbilityForAddress takes integer pConvertedHandle, integer pAddr returns nothing
	call WMem(pConvertedHandle+0x1EC,pAddr)
endfunction

function SetUnitMoveAbility takes unit u, integer pAddr returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call SetUnitMoveAbilityForAddress(LastConvertedHandle,pAddr)
	endif
endfunction

function GetUnitHeroAbilityForAddress takes integer pConvertedHandle returns integer
	return RMem(pConvertedHandle+0x1F0)
endfunction

function GetUnitHeroAbility takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return GetUnitHeroAbilityForAddress(LastConvertedHandle)
	endif
	return 0
endfunction

function GetUnitBuildAbilityForAddress takes integer pConvertedHandle returns integer
	return RMem(pConvertedHandle+0x1F4)
endfunction

function GetUnitBuildAbility takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return GetUnitBuildAbilityForAddress(LastConvertedHandle)
	endif
	return 0
endfunction

function GetUnitInventoryAbilityForAddress takes integer pConvertedHandle returns integer
	return RMem(pConvertedHandle+0x1F8)
endfunction

function GetUnitInventoryAbility takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return GetUnitInventoryAbilityForAddress(LastConvertedHandle)
	endif
	return 0
endfunction
// Alternative for sub_6F4786B0 (126a)
function GetSomeAddress takes integer pAddr1 ,integer pAddr2 returns integer
//I just split your function into 2, it should be working as before
	local integer pOff1 = 0x2C
	if pAddr1==-1 and pAddr2==-1 then
		return 0
	endif
	if pAddr1 >= 0 then
		set pOff1 = 0xC
	endif
	set pOff1 = RMem(pGameClass1) + pOff1
	set pOff1 = RMem(pOff1)
	if pOff1 == 0 then
		return 0
	endif
	
	set pOff1 = RMem(pOff1 + 8 * pAddr1 + 4)
	if pOff1 == 0 or RMem(pOff1 + 0x18) != pAddr2 then
		return 0
	endif
	return pOff1
endfunction

function GetSomeAddressForAbility takes integer pAddr1 ,integer pAddr2 returns integer //Second part of GetSomeAddressForAbility
	local integer pOff1 = GetSomeAddress(pAddr1,pAddr2)
	if pOff1==0 or RMem(pOff1 + 0x20) != 0 then
		return 0
	endif
	return RMem(pOff1+0x54)
endfunction

function GetSomeAddressForLocustFlags takes integer pAddr1 ,integer pAddr2 returns integer
	local integer i = GetSomeAddress(pAddr1,pAddr2)
	return RMem(i+0x94)
endfunction

function SetLocustFlags takes unit u, integer i returns nothing //These flags can make unit immune to truesight
	local integer pOff1
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set LastConvertedHandle = LastConvertedHandle+0x16C
		set pOff1 = GetSomeAddressForLocustFlags(RMem(LastConvertedHandle), RMem(LastConvertedHandle+4))
		if pOff1>0 then
			call WMem(pOff1+0x34, i)
		endif
	endif
endfunction

function EnableTruesightImmunity takes unit u returns nothing 
//I dont really know what other side effects may be caused by this, at least GroupEnum is not affected
	call SetLocustFlags(u, 0x08000000)
endfunction

function DisableTruesightImmunity takes unit u returns nothing
	call SetLocustFlags(u, 0)
endfunction

function UnStunUnit takes unit u returns nothing
//unsafe, do not use unless you tested it through
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call WMem(LastConvertedHandle+0x198, 0)
	endif
endfunction

function GetUnitStunnedCounter takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return RMem(LastConvertedHandle+0x198)
	endif
	return 0
endfunction

function IsUnitStunned2 takes unit u returns boolean
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return RMem(LastConvertedHandle+0x198) > 0
	endif
	return false
endfunction

function IsUnitInvulnerable takes unit u returns boolean
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return IsFlagBitSet(RMem(LastConvertedHandle+0x20),8)
	endif
	return false
endfunction

function IsUnitInvulnerable2 takes unit u returns boolean
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return RMem(LastConvertedHandle+0xE8)>0
	endif
	return false
endfunction

function GetUnitInvulnerableCounter takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return RMem(LastConvertedHandle+0xE8)
	endif
	return 0
endfunction

function SetUnitInvulnerableCounter takes unit u, integer i returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call WMem(LastConvertedHandle+0xE8,i)
	endif
endfunction

function ModifyInvulnerableCounter takes unit u, integer diff returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call WMem(LastConvertedHandle+0xE8,RMem(LastConvertedHandle+0xE8)+diff)
	endif
endfunction

function GetUnitAbilityForAddresss takes integer pConvertedHandle, integer abilid returns integer
	local integer pAddr1 = pConvertedHandle + 0x1DC
	local integer pAddr2 = pConvertedHandle + 0x1E0
	local integer pOff1 = 0
	set pAddr1 = RMem(pAddr1)
	set pAddr2 = RMem(pAddr2)
	if pAddr1 == 0 or pAddr2 == 0 or (pAddr1==-1 and  pAddr2==-1) then
		return 0
	endif
	set pOff1 = GetSomeAddressForAbility(pAddr1,pAddr2)
	loop
		exitwhen pOff1 <= 0
		if RMem(pOff1+0x34) == abilid then 
			return pOff1
		endif
		set pOff1 = GetSomeAddressForAbility(RMem(pOff1+0x24), RMem(pOff1+0x28))
	endloop
	return pOff1
endfunction

function PrintAllUnitAbilities takes integer pConvertedHandle returns nothing
	local integer pAddr1 = pConvertedHandle + 476
	local integer pAddr2 = pConvertedHandle + 480

	local integer pOff1 = 0

	set pAddr1 = RMem(pAddr1)
	set pAddr2 = RMem(pAddr2)
	if pAddr1 == 0 or pAddr2 == 0 or BitwiseAnd(pAddr1,pAddr2) == -1 then
		return 
	endif

	set pOff1 = GetSomeAddressForAbility(pAddr1,pAddr2)
	
	if pOff1 == 0 then 
		return
	endif
	
	loop
		exitwhen pOff1 == 0 

		call DisplayTimedTextToPlayer(GetLocalPlayer(),0.0,0.0,40,"Address:"+Int2Hex(pOff1)+". ID:"+Id2String(RMem(pOff1+52))+" name: "+GetObjectName(RMem(pOff1+52)))
		
		set pOff1 = GetSomeAddressForAbility( RMem(pOff1+36), RMem(pOff1+40))
	endloop
	
endfunction

function GetAllUnitAbilities takes unit u returns nothing
	local integer pConvertedHandle=ConvertHandle(u)
	local integer pAddr1
	local integer pAddr2
	local integer i=0
	local integer h=GetHandleId(u)
	local integer pOff1 = 0
	local integer id
	call FlushChildHashtable(TempHash,h)
	if pConvertedHandle < 1 then
		return
	endif
	set pAddr1 = pConvertedHandle + 0x1DC
	set pAddr2 = pConvertedHandle + 0x1E0
	set pAddr1 = RMem(pAddr1)
	set pAddr2 = RMem(pAddr2)
	if (pAddr1==-1 and pAddr2==-1) or pAddr1 == 0 or pAddr2 == 0 then
		return 
	endif
	set pOff1 = GetSomeAddressForAbility(pAddr1,pAddr2)
	loop
		exitwhen pOff1 <= 0
		set id=RMem(pOff1+0x34)
		if id!='Amov' and id!='AHer' and id!='Aatk' and id!='AInv' then
			call SaveInteger(TempHash,h,i,pOff1)//address
			call SaveInteger(TempHash,h+1,i,RMem(pOff1+0x34))//ability id
			set i=i+1
		endif
		set pOff1 = GetSomeAddressForAbility( RMem(pOff1+36), RMem(pOff1+40))
	endloop
	call SaveInteger(TempHash,'abil',0,i)
endfunction

function GetAllUnitAbilitiesWithCallback takes unit u, string callback returns nothing
	local integer pConvertedHandle=ConvertHandle(u)
	local integer pAddr1
	local integer pAddr2
	local integer i=0
	local integer h=GetHandleId(u)
	local integer pOff1 = 0
	local integer id
	if pConvertedHandle < 1 then
		return
	endif
	set pAddr1 = pConvertedHandle + 0x1DC
	set pAddr2 = pConvertedHandle + 0x1E0
	set pAddr1 = RMem(pAddr1)
	set pAddr2 = RMem(pAddr2)
	if (pAddr1==-1 and pAddr2==-1) or pAddr1 == 0 or pAddr2 == 0 then
		return 
	endif
	set pOff1 = GetSomeAddressForAbility(pAddr1,pAddr2)
	loop
		exitwhen pOff1 <= 0
		set id=RMem(pOff1+0x34)
		if id!='Amov' and id!='AHer' and id!='Aatk' and id!='AInv' then
			set tt_int1=pOff1
			call ExecuteFunc(callback)
		endif
		set pOff1 = GetSomeAddressForAbility( RMem(pOff1+36), RMem(pOff1+40))
	endloop
endfunction


function CallFastCallWith1Args takes integer pFuncFastcallAddr, integer arg1 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_FASTCALL1ARG_INDEX] then
		set Memory[pCallFastCallWith1Args/4]=0xB9F68B56
		set Memory[pCallFastCallWith1Args/4+2]=0xBEF68B90
		set Memory[pCallFastCallWith1Args/4+4]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FASTCALL1ARG_INDEX]=true
	endif
	set Memory[pCallFastCallWith1Args/4+1]=arg1
	set Memory[pCallFastCallWith1Args/4+3]=pFuncFastcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallFastCallWith1Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallFastCallWith1Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction


function CallFastCallWith2Args takes integer pFuncFastcallAddr, integer arg1, integer arg2 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_FASTCALL2ARG_INDEX] then
		set Memory[pCallFastCallWith2Args/4]=0xBAF68B56
		set Memory[pCallFastCallWith2Args/4+2]=0xB9F68B90
		set Memory[pCallFastCallWith2Args/4+4]=0xBEF68B90
		set Memory[pCallFastCallWith2Args/4+6]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FASTCALL2ARG_INDEX]=true
	endif
	set Memory[pCallFastCallWith2Args/4+1]=arg2
	set Memory[pCallFastCallWith2Args/4+3]=arg1
	set Memory[pCallFastCallWith2Args/4+5]=pFuncFastcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallFastCallWith2Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallFastCallWith2Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction


function CallFastCallWith3Args takes integer pFuncFastcallAddr, integer arg1, integer arg2, integer arg3 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_FASTCALL3ARG_INDEX] then
		set Memory[pCallFastCallWith3Args/4]=0x68F68B56
		set Memory[pCallFastCallWith3Args/4+2]=0xBAF68B90
		set Memory[pCallFastCallWith3Args/4+4]=0xB9F68B90
		set Memory[pCallFastCallWith3Args/4+6]=0xBEF68B90
		set Memory[pCallFastCallWith3Args/4+8]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FASTCALL3ARG_INDEX]=true
	endif
	set Memory[pCallFastCallWith3Args/4+1]=arg3
	set Memory[pCallFastCallWith3Args/4+3]=arg2
	set Memory[pCallFastCallWith3Args/4+5]=arg1
	set Memory[pCallFastCallWith3Args/4+7]=pFuncFastcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallFastCallWith3Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallFastCallWith3Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function FUCKINGCallWith4Args takes integer pFuncFastcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_FUCKINGCALL4ARG_INDEX] then
		set Memory[pFUCKINGCallWith4Args/4]=0x68F68B56
		set Memory[pFUCKINGCallWith4Args/4+2]=0x68F68B90
		set Memory[pFUCKINGCallWith4Args/4+4]=0xB8F68B90
		set Memory[pFUCKINGCallWith4Args/4+6]=0xBFF68B90
		set Memory[pFUCKINGCallWith4Args/4+8]=0xBEF68B90
		set Memory[pFUCKINGCallWith4Args/4+10]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FUCKINGCALL4ARG_INDEX]=true
	endif
	set Memory[pFUCKINGCallWith4Args/4+1]=arg4
	set Memory[pFUCKINGCallWith4Args/4+3]=arg3
	set Memory[pFUCKINGCallWith4Args/4+5]=arg2
	set Memory[pFUCKINGCallWith4Args/4+7]=arg1
	set Memory[pFUCKINGCallWith4Args/4+9]=pFuncFastcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pFUCKINGCallWith4Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pFUCKINGCallWith4Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallFastCallWith4Args takes integer pFuncFastcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_FASTCALL4ARG_INDEX] then
		set Memory[pCallFastCallWith4Args/4]=0x68F68B56
		set Memory[pCallFastCallWith4Args/4+2]=0x68F68B90
		set Memory[pCallFastCallWith4Args/4+4]=0xBAF68B90
		set Memory[pCallFastCallWith4Args/4+6]=0xB9F68B90
		set Memory[pCallFastCallWith4Args/4+8]=0xBEF68B90
		set Memory[pCallFastCallWith4Args/4+10]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FASTCALL4ARG_INDEX]=true
	endif
	set Memory[pCallFastCallWith4Args/4+1]=arg4
	set Memory[pCallFastCallWith4Args/4+3]=arg3
	set Memory[pCallFastCallWith4Args/4+5]=arg2
	set Memory[pCallFastCallWith4Args/4+7]=arg1
	set Memory[pCallFastCallWith4Args/4+9]=pFuncFastcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallFastCallWith4Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallFastCallWith4Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallFastCallWith5Args takes integer pFuncFastcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_FASTCALL5ARG_INDEX] then
		set Memory[pCallFastCallWith5Args/4]=0x68F68B56
		set Memory[pCallFastCallWith5Args/4+2]=0x68F68B90
		set Memory[pCallFastCallWith5Args/4+4]=0x68F68B90
		set Memory[pCallFastCallWith5Args/4+6]=0xBAF68B90
		set Memory[pCallFastCallWith5Args/4+8]=0xB9F68B90
		set Memory[pCallFastCallWith5Args/4+10]=0xBEF68B90
		set Memory[pCallFastCallWith5Args/4+12]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FASTCALL5ARG_INDEX]=true
	endif
	set Memory[pCallFastCallWith5Args/4+1]=arg5
	set Memory[pCallFastCallWith5Args/4+3]=arg4
	set Memory[pCallFastCallWith5Args/4+5]=arg3
	set Memory[pCallFastCallWith5Args/4+7]=arg2
	set Memory[pCallFastCallWith5Args/4+9]=arg1
	set Memory[pCallFastCallWith5Args/4+11]=pFuncFastcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallFastCallWith5Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallFastCallWith5Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallFastCallWith6Args takes integer pFuncFastcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5, integer arg6 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_FASTCALL6ARG_INDEX] then
		set Memory[pCallFastCallWith6Args/4]=0x68F68B56
		set Memory[pCallFastCallWith6Args/4+2]=0x68F68B90
		set Memory[pCallFastCallWith6Args/4+4]=0x68F68B90
		set Memory[pCallFastCallWith6Args/4+6]=0x68F68B90
		set Memory[pCallFastCallWith6Args/4+8]=0xBAF68B90
		set Memory[pCallFastCallWith6Args/4+10]=0xB9F68B90
		set Memory[pCallFastCallWith6Args/4+12]=0xBEF68B90
		set Memory[pCallFastCallWith6Args/4+14]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FASTCALL6ARG_INDEX]=true
	endif
	set Memory[pCallFastCallWith6Args/4+1]=arg6
	set Memory[pCallFastCallWith6Args/4+3]=arg5
	set Memory[pCallFastCallWith6Args/4+5]=arg4
	set Memory[pCallFastCallWith6Args/4+7]=arg3
	set Memory[pCallFastCallWith6Args/4+9]=arg2
	set Memory[pCallFastCallWith6Args/4+11]=arg1
	set Memory[pCallFastCallWith6Args/4+13]=pFuncFastcallAddr
	
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallFastCallWith6Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallFastCallWith6Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction



function CallFastCallWith7Args takes integer pFuncFastcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5, integer arg6, integer arg7 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_FASTCALL7ARG_INDEX] then
		set Memory[pCallFastCallWith7Args/4]=0x68F68B56
		set Memory[pCallFastCallWith7Args/4+2]=0x68F68B90
		set Memory[pCallFastCallWith7Args/4+4]=0x68F68B90
		set Memory[pCallFastCallWith7Args/4+6]=0x68F68B90
		set Memory[pCallFastCallWith7Args/4+8]=0x68F68B90
		set Memory[pCallFastCallWith7Args/4+10]=0xBAF68B90
		set Memory[pCallFastCallWith7Args/4+12]=0xB9F68B90
		set Memory[pCallFastCallWith7Args/4+14]=0xBEF68B90
		set Memory[pCallFastCallWith7Args/4+16]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FASTCALL7ARG_INDEX]=true
	endif
	set Memory[pCallFastCallWith7Args/4+1]=arg7
	set Memory[pCallFastCallWith7Args/4+3]=arg6
	set Memory[pCallFastCallWith7Args/4+5]=arg5
	set Memory[pCallFastCallWith7Args/4+7]=arg4
	set Memory[pCallFastCallWith7Args/4+9]=arg3
	set Memory[pCallFastCallWith7Args/4+11]=arg2
	set Memory[pCallFastCallWith7Args/4+13]=arg1
	set Memory[pCallFastCallWith7Args/4+15]=pFuncFastcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallFastCallWith7Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallFastCallWith7Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallFastCallWith8Args takes integer pFuncFastcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5, integer arg6, integer arg7, integer arg8 returns integer
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_FASTCALL8ARG_INDEX] then
		set Memory[pCallFastCallWith8Args/4]=0x68F68B56
		set Memory[pCallFastCallWith8Args/4+2]=0x68F68B90
		set Memory[pCallFastCallWith8Args/4+4]=0x68F68B90
		set Memory[pCallFastCallWith8Args/4+6]=0x68F68B90
		set Memory[pCallFastCallWith8Args/4+8]=0x68F68B90
		set Memory[pCallFastCallWith8Args/4+10]=0x68F68B90
		set Memory[pCallFastCallWith8Args/4+12]=0xBAF68B90
		set Memory[pCallFastCallWith8Args/4+14]=0xB9F68B90
		set Memory[pCallFastCallWith8Args/4+16]=0xBEF68B90
		set Memory[pCallFastCallWith8Args/4+18]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FASTCALL8ARG_INDEX]=true
	endif
	set Memory[pCallFastCallWith8Args/4+1]=arg8
	set Memory[pCallFastCallWith8Args/4+3]=arg7
	set Memory[pCallFastCallWith8Args/4+5]=arg6
	set Memory[pCallFastCallWith8Args/4+7]=arg5
	set Memory[pCallFastCallWith8Args/4+9]=arg4
	set Memory[pCallFastCallWith8Args/4+11]=arg3
	set Memory[pCallFastCallWith8Args/4+13]=arg2
	set Memory[pCallFastCallWith8Args/4+15]=arg1
	set Memory[pCallFastCallWith8Args/4+17]=pFuncFastcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallFastCallWith8Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallFastCallWith8Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallFastCallWith11Args takes integer pFuncFastcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5, integer arg6, integer arg7, integer arg8, integer arg9, integer arg10, integer arg11 returns integer
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_FASTCALL11ARG_INDEX] then
		set Memory[pCallFastCallWith11Args/4]=0x68F68B56
		set Memory[pCallFastCallWith11Args/4+2]=0x68F68B90
		set Memory[pCallFastCallWith11Args/4+4]=0x68F68B90
		set Memory[pCallFastCallWith11Args/4+6]=0x68F68B90
		set Memory[pCallFastCallWith11Args/4+8]=0x68F68B90
		set Memory[pCallFastCallWith11Args/4+10]=0x68F68B90
		set Memory[pCallFastCallWith11Args/4+12]=0x68F68B90
		set Memory[pCallFastCallWith11Args/4+14]=0x68F68B90
		set Memory[pCallFastCallWith11Args/4+16]=0x68F68B90
		set Memory[pCallFastCallWith11Args/4+18]=0xBAF68B90
		set Memory[pCallFastCallWith11Args/4+20]=0xB9F68B90
		set Memory[pCallFastCallWith11Args/4+22]=0xBEF68B90
		set Memory[pCallFastCallWith11Args/4+24]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FASTCALL11ARG_INDEX]=true
	endif
	set Memory[pCallFastCallWith11Args/4+1]=arg11
	set Memory[pCallFastCallWith11Args/4+3]=arg10
	set Memory[pCallFastCallWith11Args/4+5]=arg9
	set Memory[pCallFastCallWith11Args/4+7]=arg8
	set Memory[pCallFastCallWith11Args/4+9]=arg7
	set Memory[pCallFastCallWith11Args/4+11]=arg6
	set Memory[pCallFastCallWith11Args/4+13]=arg5
	set Memory[pCallFastCallWith11Args/4+15]=arg4
	set Memory[pCallFastCallWith11Args/4+17]=arg3
	set Memory[pCallFastCallWith11Args/4+19]=arg2
	set Memory[pCallFastCallWith11Args/4+21]=arg1
	set Memory[pCallFastCallWith11Args/4+23]=pFuncFastcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallFastCallWith11Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallFastCallWith11Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallFastCallWith12Args takes integer pFuncFastcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5, integer arg6, integer arg7, integer arg8, integer arg9, integer arg10, integer arg11, integer arg12 returns integer
	local integer pOffset1
	
	if not ByteFuncHasBeenInitialized[INITDATA_FASTCALL12ARG_INDEX] then
		set Memory[pCallFastCallWith12Args/4]=0x68F68B56
		set Memory[pCallFastCallWith12Args/4+2]=0x68F68B90
		set Memory[pCallFastCallWith12Args/4+4]=0x68F68B90
		set Memory[pCallFastCallWith12Args/4+6]=0x68F68B90
		set Memory[pCallFastCallWith12Args/4+8]=0x68F68B90
		set Memory[pCallFastCallWith12Args/4+10]=0x68F68B90
		set Memory[pCallFastCallWith12Args/4+12]=0x68F68B90
		set Memory[pCallFastCallWith12Args/4+14]=0x68F68B90
		set Memory[pCallFastCallWith12Args/4+16]=0x68F68B90
		set Memory[pCallFastCallWith12Args/4+18]=0x68F68B90
		set Memory[pCallFastCallWith12Args/4+20]=0xBAF68B90
		set Memory[pCallFastCallWith12Args/4+22]=0xB9F68B90
		set Memory[pCallFastCallWith12Args/4+24]=0xBEF68B90
		set Memory[pCallFastCallWith12Args/4+26]=0xC35ED6FF
		set ByteFuncHasBeenInitialized[INITDATA_FASTCALL12ARG_INDEX]=true
	endif
	set Memory[pCallFastCallWith12Args/4+1]=arg11
	set Memory[pCallFastCallWith12Args/4+3]=arg11
	set Memory[pCallFastCallWith12Args/4+5]=arg10
	set Memory[pCallFastCallWith12Args/4+7]=arg9
	set Memory[pCallFastCallWith12Args/4+9]=arg8
	set Memory[pCallFastCallWith12Args/4+11]=arg7
	set Memory[pCallFastCallWith12Args/4+13]=arg6
	set Memory[pCallFastCallWith12Args/4+15]=arg5
	set Memory[pCallFastCallWith12Args/4+17]=arg4
	set Memory[pCallFastCallWith12Args/4+19]=arg3
	set Memory[pCallFastCallWith12Args/4+21]=arg2
	set Memory[pCallFastCallWith12Args/4+23]=arg1
	set Memory[pCallFastCallWith12Args/4+25]=pFuncFastcallAddr
	
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallFastCallWith12Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallFastCallWith12Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction


function CallThisCallWith1Args takes integer pFuncThiscallAddr, integer arg1 returns integer 
	return CallFastCallWith2Args(pFuncThiscallAddr,arg1,0)
endfunction

function CallThisCallWith2Args takes integer pFuncThiscallAddr, integer arg1, integer arg2 returns integer 
	return CallFastCallWith3Args(pFuncThiscallAddr,arg1,0,arg2)
endfunction

function CallThisCallWith3Args takes integer pFuncThiscallAddr, integer arg1, integer arg2, integer arg3 returns integer 
	return CallFastCallWith4Args(pFuncThiscallAddr,arg1,0,arg2,arg3)
endfunction

function CallThisCallWith4Args takes integer pFuncThiscallAddr, integer arg1, integer arg2, integer arg3, integer arg4 returns integer 
	return CallFastCallWith5Args(pFuncThiscallAddr,arg1,0,arg2,arg3,arg4)
endfunction

function CallThisCallWith5Args takes integer pFuncThiscallAddr, integer arg1, integer arg2, integer arg3, integer arg4, integer arg5 returns integer 
	return CallFastCallWith6Args(pFuncThiscallAddr,arg1,0,arg2,arg3,arg4,arg5)
endfunction

function CallThisCallWith6Args takes integer pFuncThiscallAddr, integer arg1, integer arg2, integer arg3, integer arg4, integer arg5, integer arg6 returns integer 
	return CallFastCallWith7Args(pFuncThiscallAddr,arg1,0,arg2,arg3,arg4,arg5,arg6)
endfunction

function CallThisCallWith7Args takes integer pFuncThiscallAddr, integer arg1, integer arg2, integer arg3, integer arg4, integer arg5, integer arg6, integer arg7 returns integer 
	return CallFastCallWith8Args(pFuncThiscallAddr,arg1,0,arg2,arg3,arg4,arg5,arg6,arg7)
endfunction

function CallThisCallWith10Args takes integer pFuncThiscallAddr, integer arg1, integer arg2, integer arg3, integer arg4, integer arg5, integer arg6, integer arg7, integer arg8, integer arg9, integer arg10 returns integer 
	return CallFastCallWith11Args(pFuncThiscallAddr,arg1,0,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9,arg10)
endfunction

function CallThisCallWith11Args takes integer pFuncThiscallAddr, integer arg1, integer arg2, integer arg3, integer arg4, integer arg5, integer arg6, integer arg7, integer arg8, integer arg9, integer arg10, integer arg11 returns integer 
	return CallFastCallWith12Args(pFuncThiscallAddr,arg1,0,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9,arg10,arg11)
endfunction

function GetUnitAbilityReal takes integer UnitAddress, integer AbilCode, integer unk1, integer unk2, integer unk3, integer unk4 returns integer 
	return CallThisCallWith6Args(pGetUnitAbility,UnitAddress,AbilCode,unk1,unk2, unk3, unk4)
endfunction

function GetUnitAddress takes unit u returns integer 
	return CallThisCallWith1Args(pGetUnitAddress, GetHandleId(u))
endfunction

function GetUnitAbility takes unit u, integer abilid returns integer
	local integer a
	if u==null or abilid < 1 or GetUnitAbilityLevel(u,abilid)==0 then
		return 0
	endif
	set a=ConvertHandle(u)//GetUnitAddress(u)
//call echo(Int2Hex(a)+" "+Int2Hex(ConvertHandle(u)))
	if a>1 then
		return CallThisCallWith6Args(pGetUnitAbility,a,abilid,0, 1, 1, 1)
	endif
	return 0
endfunction

function GetUnitAbilityByBase takes unit u, integer abilid returns integer
	local integer a
	if u==null or abilid < 1 then
		return 0
	endif
	set a=ConvertHandle(u)//GetUnitAddress(u)
//call echo(Int2Hex(a)+" "+Int2Hex(ConvertHandle(u)))
	if a>1 then
		return CallThisCallWith6Args(pGetUnitAbility,a,abilid,0, 0, 1, 1)
	endif
	return 0
endfunction

function GetUnitAbilityByAddress takes integer u, integer abilid returns integer
	return CallThisCallWith6Args(pGetUnitAbility,u,abilid,0, 1, 1, 1)
endfunction

function ShowAbilityById_Main takes integer ConvertedHandle, integer d returns nothing
	if ConvertedHandle>0 and RMem(ConvertedHandle)>0 then
		call WMem(ConvertedHandle + 0x40,RMem(ConvertedHandle + 0x40)+d)
	endif
endfunction

function HideAbilityButton takes unit u, integer id, boolean hide returns nothing
	local integer offset
	if u!=null and id!=0 then
		set offset=GetUnitAbility(u,id)
		if offset!=0 then
			if hide then
				call ShowAbilityById_Main(offset,1)
			else
				call ShowAbilityById_Main(offset,-1)
			endif
		endif
	endif
endfunction

function GetSpellCastpoint takes ability a returns real
	local integer aa=ConvertHandle(a)
	if aa>0 then
		return mI2R(RMem(aa+0x8C))
	endif
	return 0.
endfunction

function SetSpellCastpoint takes ability a, real dur returns nothing
	local integer aa=ConvertHandle(a)
	if aa>0 then
		call WMem(aa+0x8C,mR2I(dur))
	endif
endfunction

function GetSpellBackswing takes ability a returns real
	local integer aa=ConvertHandle(a)
	if aa>0 then
		return mI2R(RMem(aa+0x94))
	endif
	return 0.
endfunction

function SetSpellBackswing takes ability a, real dur returns nothing
	local integer aa=ConvertHandle(a)
	if aa>0 then
		call WMem(aa+0x94,mR2I(dur))
	endif
endfunction

function GetAbilityOrderID takes integer pAbility returns integer
	local integer pOffset2
	local integer ord
	if pAbility<1 then
		return 0
	endif
	if RMem(pAbility+0x6C)==852290 then
		set ord=CallThisCallWith1Args(RMem(RMem(pAbility)+0x308),pAbility)
		if ord==ORDER_bloodluston then
			return ORDER_bloodlust
		elseif ord==ORDER_autodispelon then
			return ORDER_autodispel
		elseif ord==ORDER_barkskinon then
			return ORDER_barkskin
		elseif ord==ORDER_blackarrowon then
			return ORDER_blackarrow
		elseif ord==ORDER_blackarrowon then
			return ORDER_blackarrow
		elseif ord==ORDER_carrionscarabson then
			return ORDER_carrionscarabs
		elseif ord==ORDER_creephealon then
			return ORDER_creepheal
		elseif ord==ORDER_curseon then
			return ORDER_curse
		elseif ord==ORDER_ensnareon then
			return ORDER_ensnare
		elseif ord==ORDER_faeriefireon then
			return ORDER_faeriefire
		elseif ord==ORDER_frenzyon then
			return ORDER_frenzy
		elseif ord==ORDER_frostarmoron then
			return ORDER_frostarmor
		elseif ord==ORDER_healon then
			return ORDER_heal
		elseif ord==ORDER_incineratearrowon then
			return ORDER_incineratearrow
		elseif ord==ORDER_innerfireon then
			return ORDER_innerfire
		elseif ord==ORDER_parasiteon then
			return ORDER_parasite
		elseif ord==ORDER_phaseshifton then
			return ORDER_phaseshift
		elseif ord==ORDER_raisedeadon then
			return ORDER_raisedead
		elseif ord==ORDER_rechargeon then
			return ORDER_recharge
		elseif ord==ORDER_renewon then
			return ORDER_renew
		elseif ord==ORDER_repairon then
			return ORDER_repair
		elseif ord==ORDER_replenishon then
			return ORDER_replenish
		elseif ord==ORDER_restorationon then
			return ORDER_restoration
		elseif ord==ORDER_selfdestructon then
			return ORDER_selfdestruct
		elseif ord==ORDER_slowon then
			return ORDER_slow
		elseif ord==ORDER_spellstealon then
			return ORDER_spellsteal
		elseif ord==ORDER_vengeanceon then
			return ORDER_vengeance
		elseif ord==ORDER_webon then
			return ORDER_web
		endif
		return ord
	endif
	return 0
endfunction

function GetAbilityOrderIdAny takes integer a returns integer
	local integer id=RMem(a+0x34)
	local integer base
	local integer ord=0
	if HaveSavedInteger(AbilitiesHashtable,id,'ordr') then
		return LoadInteger(AbilitiesHashtable,id,'ordr')
	endif
	
	if RMem(a+0x6C)==852290 then
		set base=RMem(a+0x54)
		if base !=0 then
			set base=RMem(base+0x30)
			if base>0 then
				if base=='ANcl' then
					set ord=RMem(a+0x124)
				else
					set ord=GetAbilityOrderID(a)
				endif
			endif
		endif
	endif
	call SaveInteger(AbilitiesHashtable,id,'ordr',ord)
	return ord
endfunction

function ToggleAbilityAutocast takes integer address, boolean on returns nothing
	local integer flags
	local integer flag128=0//0 if enabled
	local integer flag524288=0
	if address>0 then
		set flags=RMem(address+0x20)
		if not IsFlagBitSet(flags,0x80) then
			set flag128=0x80//not enabled
		endif
		if not IsFlagBitSet(flags,0x80000) then
			set flag524288=0x80000//not enabled
		endif
		if on and flag128>0 then
			set flags=flags+flag128
		elseif on==false and flag128==0 then
			set flags=flags-0x80
		endif
		if on and flag524288>0 then
			set flags=flags+flag524288
		elseif on==false and flag524288==0 then
			set flags=flags-0x80000
		endif
		call WMem(address+0x20,flags)
	endif
endfunction

function SetUnitAbiltyAutocast takes unit u, integer id, boolean on returns nothing
	call ToggleAbilityAutocast(GetUnitAbility(u,id),on)
endfunction

function GetUnitAttackOffsetValue takes unit u, integer offset returns integer
	set LastConvertedHandle=GetUnitAttackAbility(u)
	if LastConvertedHandle>0 then
		return RMem(LastConvertedHandle+offset)
	endif
	return 0
endfunction

function SetUnitAttackOffsetValue takes unit u, integer offset, integer val returns nothing
	set LastConvertedHandle=GetUnitAttackAbility(u)
	if LastConvertedHandle>0 then
		call WMem(LastConvertedHandle+offset,val)
	endif
endfunction
//6 = hero, 5 = chaos, 4 = magic, 3 = siege, 2 = piercing, 1 = normal, 0 = spell?
//values over 6 takes incorrect multipliers from nearby memory, do not use them
function SetUnitAttackType takes unit u, integer i, integer attacknum returns nothing
	call SetUnitAttackOffsetValue(u,0xF4 + 4*attacknum,i)
endfunction

function SetUnitAttackType1 takes unit u, integer i returns nothing
	call SetUnitAttackType(u,i,0)
endfunction

function SetUnitAttackType2 takes unit u, integer i returns nothing
	call SetUnitAttackType(u,i,1)
endfunction

function GetUnitAttackTypeByIndex takes unit u, integer index returns integer
	if index==0 or index==1 then
		return GetUnitAttackOffsetValue(u,0xF4 + 4*index)
	endif
	return -1
endfunction


function GetUnitWeaponSound takes unit u returns integer
	return GetUnitAttackOffsetValue(u,0xE8)
endfunction
//unit's weapon type is melee, ranged, splash, artillery, etc
//values 1-8
// 2 = ranger, 1 = instante, 0 = melee, 5 = splash, 6 = mbounce, 
function SetUnitWeaponType takes unit u, integer i returns nothing
	call SetUnitAttackOffsetValue(u,0xDC,i)
endfunction

function GetUnitWeaponType takes unit u returns integer
	return GetUnitAttackOffsetValue(u,0xDC)
endfunction
//setting bonus automatically adjusts base damage to fit, green numbers cannot be tweaked
function SetUnitCurrentBonusDamage takes unit u, integer i returns nothing
	call SetUnitAttackOffsetValue(u,0xAC,i)
endfunction

function GetUnitCurrentBonusDamage takes unit u returns integer
	return GetUnitAttackOffsetValue(u,0xAC)
endfunction

function AddUnitGreenBonusDamage takes unit u, integer i returns nothing
	call SetUnitCurrentBonusDamage(u,GetUnitCurrentBonusDamage(u)+i)
endfunction

function SetUnitBaseDamage takes unit u, integer i returns nothing
	call SetUnitAttackOffsetValue(u,0xA0,i)
endfunction

function GetUnitBaseDamage takes unit u returns integer
	return GetUnitAttackOffsetValue(u,0xA0)
endfunction

function AddUnitBaseDamage takes unit u, integer bonus returns nothing
	call SetUnitBaseDamage(u,GetUnitBaseDamage(u)+bonus)
endfunction

function SetUnitBaseAttributeDamage takes unit u, integer i returns nothing
	call SetUnitAttackOffsetValue(u,0xA4,i)
endfunction

function GetUnitBaseAttributeDamage takes unit u returns integer
	return GetUnitAttackOffsetValue(u,0xA4)
endfunction

function SetUnitDamageDicesSideCount takes unit u, integer i returns nothing
	call SetUnitAttackOffsetValue(u,0x94,i)
endfunction

function GetUnitDamageDicesSideCount takes unit u returns integer
	return GetUnitAttackOffsetValue(u,0x94)
endfunction

function SetUnitDamageDicesCount takes unit u, integer i returns nothing
	call SetUnitAttackOffsetValue(u,0x88,i)
endfunction

function GetUnitDamageDicesCount takes unit u returns integer
	return GetUnitAttackOffsetValue(u,0x88)
endfunction

function SetUnitAttackRange1 takes unit u, real r returns nothing
	call SetUnitAttackOffsetValue(u,0x258,mR2I(r))
endfunction

function GetUnitAttackRange1 takes unit u returns real
	return mI2R(GetUnitAttackOffsetValue(u,0x258))
endfunction

function SetUnitAttackRangeByIndex takes unit u, integer index, real r returns nothing
	if index==1 or index==0 then
		call SetUnitAttackOffsetValue(u,0x258+0x24*index,mR2I(r))
	endif
endfunction

function GetUnitAttackRangeByIndex takes unit u, integer index returns real
	if index==1 or index==0 then
		return mI2R(GetUnitAttackOffsetValue(u,0x258+0x24*index))
	endif
	return 0.
endfunction

function SetUnitBATByIndex takes unit u, integer index, real r returns nothing
	if index==1 or index==0 then
		call SetUnitAttackOffsetValue(u,0x158 + 8*index, mR2I(r))
	endif
endfunction

function GetUnitBATByIndex takes unit u, integer index returns real
	if index==1 or index==0 then
		return mI2R(GetUnitAttackOffsetValue(u,0x158 + 8*index))
	endif
	return 0.
endfunction

function SetUnitAttackPoint1 takes unit u, real r returns nothing
	call SetUnitAttackOffsetValue(u,0x16C, mR2I(r))
endfunction

function SetUnitAttackPoint2 takes unit u, real r returns nothing
	call SetUnitAttackOffsetValue(u,0x17C, mR2I(r))
endfunction

function GetUnitAttackPoint1 takes unit u returns real
	return mI2R(GetUnitAttackOffsetValue(u,0x16C))
endfunction

function GetUnitAttackPoint2 takes unit u returns real
	return mI2R(GetUnitAttackOffsetValue(u,0x17C))
endfunction

function GetUnitAttackEnabledIndex takes unit u returns integer
	return GetUnitAttackOffsetValue(u,0x104)
endfunction

function SetUnitAttackBackswing takes unit u, real r returns nothing
	call SetUnitAttackOffsetValue(u,0x190, mR2I(r))
endfunction

function GetUnitAttackBackswing takes unit u returns real
	return mI2R(GetUnitAttackOffsetValue(u,0x190))
endfunction

function SetUnitAttackSpeed takes unit u, real r returns nothing
	call SetUnitAttackOffsetValue(u,0x1B0, mR2I(r))
endfunction

function GetUnitAttackSpeed takes unit u returns real
	return mI2R(GetUnitAttackOffsetValue(u,0x1B0))
endfunction

function AddUnitAttackSpeed takes unit u, real r returns nothing
	call SetUnitAttackSpeed(u,GetUnitAttackSpeed(u)+r)
endfunction

function GetUnitAddressFloatsRelated takes integer pConvertedHandle, integer step returns integer
	local integer pOffset1 = pConvertedHandle + step
	local integer pOffset2
	if pConvertedHandle>0 then
		set pOffset2 = RMem(pGameClass1)
		set pOffset1 = RMem(pOffset1)
		set pOffset2 = RMem(pOffset2+0xC)
		set pOffset2 = RMem(( pOffset1 * 8 ) + pOffset2 + 4)
		return pOffset2
	endif
	return 0
endfunction

function SetUnitFacingInstant takes unit u, real a returns nothing
	local integer pOffset2 = GetUnitAddressFloatsRelated(ConvertHandle(u),0xA0)
	if pOffset2>0 then
		set pOffset2=RMem(pOffset2+0x28)
		if pOffset2>0 then
			call WMem(pOffset2+0xA4,mR2I(bj_DEGTORAD*a))
		endif
	endif
endfunction

function SetUnitMaxHP4Address takes integer pConvertedHandle, real newhp returns nothing
	local integer pOffset2 = GetUnitAddressFloatsRelated(pConvertedHandle,0xA0)
	if pOffset2>0 then
		call WMem(pOffset2+0x84,mR2I(newhp))
	endif
endfunction

function SetUnitMaxMP4Address takes integer pConvertedHandle, real newmp returns nothing
	local integer pOffset2 = GetUnitAddressFloatsRelated(pConvertedHandle,0xC0)
	if pOffset2>0 then
		call WMem(pOffset2+0x84,mR2I(newmp))
	endif
endfunction

function SetUnitMaxHP takes unit u, real newhp returns nothing
	call SetUnitMaxHP4Address(ConvertHandle(u),newhp)
endfunction

function AddUnitMaxHP takes unit u, real bonus returns nothing
	call SetUnitMaxHP4Address(ConvertHandle(u),GetUnitState(u,UNIT_STATE_MAX_LIFE)+bonus)
endfunction

function SetUnitMaxMP takes unit u, real newmp returns nothing
	call SetUnitMaxMP4Address(ConvertHandle(u),newmp)
endfunction

function AddUnitMaxMP takes unit u, real bonus returns nothing
	call SetUnitMaxMP4Address(ConvertHandle(u),GetUnitState(u,UNIT_STATE_MAX_MANA)+bonus)
endfunction

function GetUnitHPRegenForAddress takes integer pConvertedHandle returns real
	local integer pOffset2 = GetUnitAddressFloatsRelated(pConvertedHandle,0xA0)
	if pOffset2>0 then
		return mI2R(RMem(pOffset2+0x7C))
	endif
	return 0.
endfunction

function SetUnitXSoft takes integer pConvertedHandle, real x returns nothing
	local integer pOffset2 = GetUnitAddressFloatsRelated(pConvertedHandle,0xA0)
	if pOffset2>0 then
		call WMem(RMem(pOffset2+0x28)+0x54,mR2I(x))
	endif
endfunction

function SetUnitHPRegenForAddress takes integer pConvertedHandle, real r returns nothing
	local integer pOffset2 = GetUnitAddressFloatsRelated(pConvertedHandle,0xA0)
	if pOffset2>0 then
		call WMem(pOffset2+0x7C,mR2I(r))
	endif
endfunction

function GetUnitMPRegenForAddress takes integer pConvertedHandle returns real
	local integer pOffset2 = GetUnitAddressFloatsRelated(pConvertedHandle,0xC0)
	if pOffset2>0 then
		return mI2R(RMem(pOffset2+0x7C))
	endif
	return 0.
endfunction

function SetUnitMPRegenForAddress takes integer pConvertedHandle, real r returns nothing
	local integer pOffset2 = GetUnitAddressFloatsRelated(pConvertedHandle,0xC0)
	if pOffset2>0 then
		call WMem(pOffset2+0x7C,mR2I(r))
	endif
endfunction

function GetUnitHPRegen takes unit u returns real
	return GetUnitHPRegenForAddress(ConvertHandle(u))
endfunction

function GetWidgetHPRegen takes widget u returns real
	return GetUnitHPRegenForAddress(ConvertHandle(u))
endfunction

function GetUnitMPRegen takes unit u returns real
	return GetUnitMPRegenForAddress(ConvertHandle(u))
endfunction

function SetUnitHPRegen takes unit u, real r returns nothing
	local real curhp=GetWidgetLife(u)
	call SetUnitHPRegenForAddress(ConvertHandle(u),r)
	call SetWidgetLife(u,curhp)
endfunction

function AddUnitHPRegen takes unit u, real r returns nothing
	local real curhp=GetWidgetLife(u)
	local integer h=ConvertHandle(u)
	call SetUnitHPRegenForAddress(h,r+GetUnitHPRegenForAddress(h))
	call SetWidgetLife(u,curhp)
endfunction

function SetUnitMPRegen takes unit u, real r returns nothing
	local real curhp=GetUnitState(u,UNIT_STATE_MANA)
	call SetUnitMPRegenForAddress(ConvertHandle(u),r)
	call SetUnitState(u,UNIT_STATE_MANA,curhp)
endfunction

function AddUnitMPRegen takes unit u, real r returns nothing
	local real curhp=GetUnitState(u,UNIT_STATE_MANA)
	local integer h=ConvertHandle(u)
	call SetUnitMPRegenForAddress(h,r+GetUnitMPRegenForAddress(h))
	call SetUnitState(u,UNIT_STATE_MANA,curhp)
endfunction
//effects and trackables shares the same structure so calls are the same

function GetSpriteDataOffsetAddressR takes integer h, integer offset returns real
	if h>0 then
		return mI2R(RMem(RMem(h + 0x28) + offset))
	endif
	return 0.
endfunction

function GetSpriteDataOffsetR takes handle e, integer offset returns real
	return GetSpriteDataOffsetAddressR(ConvertHandle(e),offset)
endfunction

function SetSpriteDataOffsetAddressR takes integer h, integer offset, real r returns nothing
	if h>0 then
		call WMem(RMem(h + 0x28) + offset, mR2I(r))
	endif
endfunction

function SetSpriteDataOffsetR takes handle e, integer offset, real r returns nothing
	call SetSpriteDataOffsetAddressR(ConvertHandle(e),offset,r)
endfunction


function SetEffectX_ForAddress takes integer pConvertedHandle, real x returns nothing
	call SetSpriteDataOffsetAddressR(pConvertedHandle,0xC0,x)
endfunction

function SetEffectX takes effect e, real x returns nothing
	call SetSpriteDataOffsetAddressR(ConvertHandle(e),0xC0,x)
endfunction

function GetEffectX_ForAddress takes integer pConvertedHandle returns real
	return GetSpriteDataOffsetAddressR(pConvertedHandle,0xC0)
endfunction

function GetEffectX takes effect e returns real
	return GetSpriteDataOffsetAddressR(ConvertHandle(e),0xC0)
endfunction

function SetEffectY_ForAddress takes integer pConvertedHandle, real y returns nothing
	call SetSpriteDataOffsetAddressR(pConvertedHandle,0xC4,y)
endfunction

function SetEffectY takes effect e, real y returns nothing
	call SetSpriteDataOffsetAddressR(ConvertHandle(e),0xC4,y)
endfunction

function GetEffectY_ForAddress takes integer pConvertedHandle returns real
	return GetSpriteDataOffsetAddressR(pConvertedHandle,0xC4)
endfunction

function GetEffectY takes effect e returns real
	return GetSpriteDataOffsetAddressR(ConvertHandle(e),0xC4)
endfunction

function SetEffectZ_ForAddress takes integer pConvertedHandle, real z returns nothing
	call SetSpriteDataOffsetAddressR(pConvertedHandle,0xC8,z)
endfunction

function SetEffectZ takes effect e, real z returns nothing
	call SetSpriteDataOffsetAddressR(ConvertHandle(e),0xC8,z)
endfunction

function GetEffectZ_ForAddress takes integer pConvertedHandle returns real
	return GetSpriteDataOffsetAddressR(pConvertedHandle,0xC8)
endfunction

function GetEffectZ takes effect e returns real
	return GetSpriteDataOffsetAddressR(ConvertHandle(e),0xC8)
endfunction

function SetEffectPosByAddress takes integer e, real x, real y, real z returns nothing
	call SetEffectX_ForAddress(e,x)
	call SetEffectY_ForAddress(e,y)
	call SetEffectZ_ForAddress(e,z)
endfunction

function SetEffectPos takes effect e, real x, real y, real z returns nothing
	local integer pConvertedHandle = ConvertHandle(e)
	call SetEffectX_ForAddress(pConvertedHandle,x)
	call SetEffectY_ForAddress(pConvertedHandle,y)
	call SetEffectZ_ForAddress(pConvertedHandle,z)
endfunction
//0x28 may be filled by anything, so it's up to mapmaker to ensure he pass correct object
function SetObjectColor takes handle e, integer color returns nothing
	set LastConvertedHandle=ConvertHandle(e)
	if LastConvertedHandle>0 then
		call WMem(RMem(LastConvertedHandle + 0x28) + 0x148, color)
	endif
endfunction

function SetEffectSize takes effect e, real size returns nothing
	set LastConvertedHandle=ConvertHandle(e)
	if LastConvertedHandle>0 then
		call WMem(RMem(LastConvertedHandle + 0x28) + 0xE8, mR2I(size))
	endif
endfunction

function SetObjectSize takes handle e, real size returns nothing
	set LastConvertedHandle=ConvertHandle(e)
	if LastConvertedHandle>0 then
		call WMem(RMem(LastConvertedHandle + 0x28) + 0xE8, mR2I(size))
	endif
endfunction

function GetObjectSize takes handle e returns real
	set LastConvertedHandle=ConvertHandle(e)
	if LastConvertedHandle>0 then
		return mI2R(RMem(RMem(LastConvertedHandle + 0x28) + 0xE8))
	endif
	return -1.
endfunction

function SetEffectSizeEx takes effect e, real full, real x,real y, real z returns nothing
	local integer pConvertedHandle = ConvertHandle(e)
	call WMem(RMem(pConvertedHandle + 0x28) + 0xE8, mR2I(full))
	call WMem(RMem(pConvertedHandle + 0x28) + 0x120, mR2I(x))
	call WMem(RMem(pConvertedHandle + 0x28) + 0x124, mR2I(y))
	call WMem(RMem(pConvertedHandle + 0x28) + 0x128, mR2I(z))
endfunction

function SetEffectFacing takes effect e, real angle returns nothing
	local integer pConvertedHandle = ConvertHandle(e)
	call WMem(RMem(pConvertedHandle + 0x28) + 0x108, mR2I(Cos(angle)))
	call WMem(RMem(pConvertedHandle + 0x28) + 0x10C, mR2I(Sin(angle)))
	call WMem(RMem(pConvertedHandle + 0x28) + 0x114, mR2I(-Sin(angle)))
	call WMem(RMem(pConvertedHandle + 0x28) + 0x118, mR2I(Cos(angle)))
endfunction

function GetEffectFacing takes effect e returns real//returns DEGREES
	return Acos(GetSpriteDataOffsetAddressR(ConvertHandle(e),0x108))*bj_RADTODEG
endfunction

function GetUnitFacingEx takes unit e returns real//returns DEGREES
	return Acos(GetSpriteDataOffsetAddressR(ConvertHandle(e),0x108))*bj_RADTODEG
endfunction

function GetUnitAngle1 takes unit e returns real
	return GetSpriteDataOffsetAddressR(ConvertHandle(e),0x108)
endfunction

function GetUnitAngle2 takes unit e returns real
	return GetSpriteDataOffsetAddressR(ConvertHandle(e),0x10C)
endfunction

function GetUnitAngle3 takes unit e returns real
	return GetSpriteDataOffsetAddressR(ConvertHandle(e),0x114)
endfunction

function GetUnitAngle4 takes unit e returns real
	return GetSpriteDataOffsetAddressR(ConvertHandle(e),0x118)
endfunction

function GetUnitFacingEx2 takes unit e returns real//returns DEGREES
	return Asin(GetSpriteDataOffsetAddressR(ConvertHandle(e),0x10C))*bj_RADTODEG
endfunction

function GetUnitFacingEx3 takes unit e returns real//returns DEGREES
	return Asin(-GetSpriteDataOffsetAddressR(ConvertHandle(e),0x114))*bj_RADTODEG
endfunction

function GetUnitFacingEx4 takes unit e returns real//returns DEGREES
	set LastConvertedHandle=ConvertHandle(e)
	return Atan2(GetSpriteDataOffsetAddressR(LastConvertedHandle,0x10C),GetSpriteDataOffsetAddressR(LastConvertedHandle,0x108))*bj_RADTODEG
endfunction

function GetTrackableX takes trackable t returns real
	return GetEffectX_ForAddress(ConvertHandle(t))
endfunction

function GetTrackableY takes trackable t returns real
	return GetEffectY_ForAddress(ConvertHandle(t))
endfunction

function GetTrackableZ takes trackable t returns real
	return GetEffectZ_ForAddress(ConvertHandle(t))
endfunction

function SetTrackableX takes trackable t, real r returns nothing
	call SetEffectX_ForAddress(ConvertHandle(t),r)
endfunction

function SetTrackableY takes trackable t, real r  returns nothing
	call SetEffectY_ForAddress(ConvertHandle(t),r)
endfunction

function SetTrackableZ takes trackable t, real r  returns nothing
	call SetEffectZ_ForAddress(ConvertHandle(t),r)
endfunction

function SetTrackablePos takes trackable t, real x,real y,real z returns nothing
	local integer pConvertedHandle = ConvertHandle(t)
	call SetEffectX_ForAddress(pConvertedHandle,x)
	call SetEffectY_ForAddress(pConvertedHandle,y)
	call SetEffectZ_ForAddress(pConvertedHandle,z)
endfunction

function SetTrackableFacing takes trackable t, real angle returns nothing//takes RADIANS, use bj_DEGTORAD
	local integer pConvertedHandle = ConvertHandle(t)
	local real cos=Cos(angle)
	local real sin=Sin(angle)
	call WMem(RMem(pConvertedHandle + 0x28) + 0x108, mR2I(cos))
	call WMem(RMem(pConvertedHandle + 0x28) + 0x10C, mR2I( sin ))
	call WMem(RMem(pConvertedHandle + 0x28) + 0x114, mR2I( -sin ))
	call WMem(RMem(pConvertedHandle + 0x28) + 0x118, mR2I( cos ))
endfunction

function GetTrackableFacing takes trackable t returns real//returns DEGREES
	return Acos(GetSpriteDataOffsetAddressR(ConvertHandle(t),0x108))*bj_RADTODEG
endfunction

function SetUnitVertexColorRaw takes unit u, integer color returns nothing
	local integer a=ConvertHandle(u)
	local integer b=RMem(ConvertHandle(u)+0x28)
	local integer flags=RMem(b+0x138)
	call SetObjectColor(u,color)
	if not IsFlagBitSet(flags,0x800) then
		call WMem(b+0x138,flags+0x800)
	endif
	call WMem(a+0x2D4,color)
endfunction

function ResetTimedLife takes integer pConvertedHandle, real time, real maxtime returns nothing
// [buff+0x90] +0x4 = timestamp when it ends, 0xD0 - shown duration (on unit)
//	call WMem(pConvertedHandle + 0xD0, mR2I(maxtime))
//	call WriteUnrealMemory(ReadUnrealMemory(ReadUnrealMemory(pConvertedHandle/4 + 0x90/4)/4 + 0xC/4)/4 + 0x40/4, cleanInt(realToIndex(time)))
endfunction

function CallStdcallWith1Args takes integer pFuncStdcallAddr, integer arg1 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_STDCALL1ARG_INDEX] then
		set Memory[pCallStdcallWith1Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallStdcallWith1Args/4+2]=0xB990C98B// mov ecx,ecx , nop
		set Memory[pCallStdcallWith1Args/4+4]=0xC359D1FF// call ecx, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_STDCALL1ARG_INDEX]=true
	endif
	set Memory[pCallStdcallWith1Args/4+1]=arg1// push arg1
	set Memory[pCallStdcallWith1Args/4+3]=pFuncStdcallAddr// mov ecx, pFuncStdcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallStdcallWith1Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallStdcallWith1Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallStdcallWith2Args takes integer pFuncStdcallAddr, integer arg1, integer arg2 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_STDCALL2ARG_INDEX] then
		set Memory[pCallStdcallWith2Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallStdcallWith2Args/4+2]=0x6890C98B// mov ecx,ecx
		set Memory[pCallStdcallWith2Args/4+4]=0xB990C98B// mov ecx,ecx , nop
		set Memory[pCallStdcallWith2Args/4+6]=0xC359D1FF// call ecx, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_STDCALL2ARG_INDEX]=true
	endif
	set Memory[pCallStdcallWith2Args/4+1]=arg2
	set Memory[pCallStdcallWith2Args/4+3]=arg1
	set Memory[pCallStdcallWith2Args/4+5]=pFuncStdcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallStdcallWith2Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallStdcallWith2Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallStdcallWith3Args takes integer pFuncStdcallAddr, integer arg1, integer arg2, integer arg3 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_STDCALL3ARG_INDEX] then
		set Memory[pCallStdcallWith3Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallStdcallWith3Args/4+2]=0x6890C98B// mov ecx,ecx
		set Memory[pCallStdcallWith3Args/4+4]=0x6890C98B//  mov ecx,ecx
		set Memory[pCallStdcallWith3Args/4+6]=0xB990C98B// mov ecx,ecx , nop
		set Memory[pCallStdcallWith3Args/4+8]=0xC359D1FF // call ecx, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_STDCALL3ARG_INDEX]=true
	endif
	set Memory[pCallStdcallWith3Args/4+1]=arg3
	set Memory[pCallStdcallWith3Args/4+3]=arg2
	set Memory[pCallStdcallWith3Args/4+5]=arg1
	set Memory[pCallStdcallWith3Args/4+7]=pFuncStdcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallStdcallWith3Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallStdcallWith3Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction


function CallStdcallWith4Args takes integer pFuncStdcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_STDCALL4ARG_INDEX] then
		set Memory[pCallStdcallWith4Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallStdcallWith4Args/4+2]=0x6890C98B// mov ecx,ecx
		set Memory[pCallStdcallWith4Args/4+4]=0x6890C98B//  mov ecx,ecx
		set Memory[pCallStdcallWith4Args/4+6]=0x6890C98B// mov ecx,ecx , nop
		set Memory[pCallStdcallWith4Args/4+8]=0xB990C98B 
		set Memory[pCallStdcallWith4Args/4+10]=0xC359D1FF // call ecx, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_STDCALL4ARG_INDEX]=true
	endif
	set Memory[pCallStdcallWith4Args/4+1]=arg4
	set Memory[pCallStdcallWith4Args/4+3]=arg3
	set Memory[pCallStdcallWith4Args/4+5]=arg2
	set Memory[pCallStdcallWith4Args/4+7]=arg1
	set Memory[pCallStdcallWith4Args/4+9]=pFuncStdcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallStdcallWith4Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallStdcallWith4Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallStdcallWith5Args takes integer pFuncStdcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_STDCALL5ARG_INDEX] then
		set Memory[pCallStdcallWith5Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallStdcallWith5Args/4+2]=0x6890C98B// mov ecx,ecx
		set Memory[pCallStdcallWith5Args/4+4]=0x6890C98B//  mov ecx,ecx
		set Memory[pCallStdcallWith5Args/4+6]=0x6890C98B// mov ecx,ecx , nop
		set Memory[pCallStdcallWith5Args/4+8]=0x6890C98B 
		set Memory[pCallStdcallWith5Args/4+10]=0xB990C98B 
		set Memory[pCallStdcallWith5Args/4+12]=0xC359D1FF // call ecx, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_STDCALL5ARG_INDEX]=true
	endif
	set Memory[pCallStdcallWith5Args/4+1]=arg5 
	set Memory[pCallStdcallWith5Args/4+3]=arg4
	set Memory[pCallStdcallWith5Args/4+5]=arg3
	set Memory[pCallStdcallWith5Args/4+7]=arg2
	set Memory[pCallStdcallWith5Args/4+9]=arg1
	set Memory[pCallStdcallWith5Args/4+11]=pFuncStdcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallStdcallWith5Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallStdcallWith5Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallStdcallWith6Args takes integer pFuncStdcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5 , integer arg6 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_STDCALL6ARG_INDEX] then
		set Memory[pCallStdcallWith6Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallStdcallWith6Args/4+2]=0x6890C98B// mov ecx,ecx
		set Memory[pCallStdcallWith6Args/4+4]=0x6890C98B//  mov ecx,ecx
		set Memory[pCallStdcallWith6Args/4+6]=0x6890C98B// mov ecx,ecx , nop
		set Memory[pCallStdcallWith6Args/4+8]=0x6890C98B 
		set Memory[pCallStdcallWith6Args/4+10]=0x6890C98B 
		set Memory[pCallStdcallWith6Args/4+12]=0xB990C98B 
		set Memory[pCallStdcallWith6Args/4+14]=0xC359D1FF // call ecx, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_STDCALL6ARG_INDEX]=true
	endif
	set Memory[pCallStdcallWith6Args/4+1]=arg6 
	set Memory[pCallStdcallWith6Args/4+3]=arg5
	set Memory[pCallStdcallWith6Args/4+5]=arg4
	set Memory[pCallStdcallWith6Args/4+7]=arg3
	set Memory[pCallStdcallWith6Args/4+9]=arg2
	set Memory[pCallStdcallWith6Args/4+11]=arg1
	set Memory[pCallStdcallWith6Args/4+13]=pFuncStdcallAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallStdcallWith6Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallStdcallWith6Args
	endif
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallStdcallWith7Args takes integer pFuncStdcallAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5 , integer arg6, integer arg7 returns integer
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_STDCALL7ARG_INDEX] then
		set Memory[pCallStdcallWith7Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallStdcallWith7Args/4+2]=0x6890C98B// mov ecx,ecx
		set Memory[pCallStdcallWith7Args/4+4]=0x6890C98B//  mov ecx,ecx
		set Memory[pCallStdcallWith7Args/4+6]=0x6890C98B// mov ecx,ecx , nop
		set Memory[pCallStdcallWith7Args/4+8]=0x6890C98B 
		set Memory[pCallStdcallWith7Args/4+10]=0x6890C98B 
		set Memory[pCallStdcallWith7Args/4+12]=0x6890C98B 
		set Memory[pCallStdcallWith7Args/4+14]=0xB990C98B 
		set Memory[pCallStdcallWith7Args/4+16]=0xC359D1FF // call ecx, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_STDCALL7ARG_INDEX]=true
	endif
	set Memory[pCallStdcallWith7Args/4+1]=arg7 
	set Memory[pCallStdcallWith7Args/4+3]=arg6
	set Memory[pCallStdcallWith7Args/4+5]=arg5
	set Memory[pCallStdcallWith7Args/4+7]=arg4
	set Memory[pCallStdcallWith7Args/4+9]=arg3
	set Memory[pCallStdcallWith7Args/4+11]=arg2
	set Memory[pCallStdcallWith7Args/4+13]=arg1
	set Memory[pCallStdcallWith7Args/4+15]=pFuncStdcallAddr
	
	if pIgnoredUnitsOffset == 0 then
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallStdcallWith7Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallStdcallWith7Args
	endif
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallCdeclWith1Args takes integer pFuncCdeclAddr, integer arg1 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_CDECLCALL1ARG_INDEX] then
		set Memory[pCallCdeclWith1Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallCdeclWith1Args/4+2]=0xB990C98B// mov ecx,ecx , nop
		set Memory[pCallCdeclWith1Args/4+4]=0xC483D1FF//  call ecx, add esp, 
		set Memory[pCallCdeclWith1Args/4+5]=0xCCC35904//  4, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_CDECLCALL1ARG_INDEX]=true
	endif
	set Memory[pCallCdeclWith1Args/4+1]=arg1
	set Memory[pCallCdeclWith1Args/4+3]=pFuncCdeclAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallCdeclWith1Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallCdeclWith1Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallCdeclWith2Args takes integer pFuncCdeclAddr, integer arg1, integer arg2 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_CDECLCALL2ARG_INDEX] then
		set Memory[pCallCdeclWith2Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallCdeclWith2Args/4+2]=0x6890C98B// mov ecx,ecx , nop
		set Memory[pCallCdeclWith2Args/4+4]=0xB990C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith2Args/4+6]=0xC483D1FF//  call ecx, add esp, 
		set Memory[pCallCdeclWith2Args/4+7]=0xCCC35908//  4, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_CDECLCALL2ARG_INDEX]=true
	endif
	set Memory[pCallCdeclWith2Args/4+1]=arg2
	set Memory[pCallCdeclWith2Args/4+3]=arg1
	set Memory[pCallCdeclWith2Args/4+5]=pFuncCdeclAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallCdeclWith2Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallCdeclWith2Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallCdeclWith3Args takes integer pFuncCdeclAddr, integer arg1, integer arg2, integer arg3 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_CDECLCALL3ARG_INDEX] then
		set Memory[pCallCdeclWith3Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallCdeclWith3Args/4+2]=0x6890C98B// mov ecx,ecx , nop
		set Memory[pCallCdeclWith3Args/4+4]=0x6890C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith3Args/4+6]=0xB990C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith3Args/4+8]=0xC483D1FF//  call ecx, add esp, 
		set Memory[pCallCdeclWith3Args/4+9]=0xCCC3590C//  4, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_CDECLCALL3ARG_INDEX]=true
	endif
	set Memory[pCallCdeclWith3Args/4+1]=arg3
	set Memory[pCallCdeclWith3Args/4+3]=arg2
	set Memory[pCallCdeclWith3Args/4+5]=arg1
	set Memory[pCallCdeclWith3Args/4+7]=pFuncCdeclAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallCdeclWith3Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallCdeclWith3Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallCdeclWith4Args takes integer pFuncCdeclAddr, integer arg1, integer arg2, integer arg3 , integer arg4 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_CDECLCALL4ARG_INDEX] then
		set Memory[pCallCdeclWith4Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallCdeclWith4Args/4+2]=0x6890C98B// mov ecx,ecx , nop
		set Memory[pCallCdeclWith4Args/4+4]=0x6890C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith4Args/4+6]=0x6890C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith4Args/4+8]=0xB990C98B//  call ecx, add esp, 
		set Memory[pCallCdeclWith4Args/4+10]=0xC483D1FF//  call ecx, add esp, 
		set Memory[pCallCdeclWith4Args/4+11]=0xCCC35910//  4, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_CDECLCALL4ARG_INDEX]=true
	endif
	set Memory[pCallCdeclWith4Args/4+1]=arg4
	set Memory[pCallCdeclWith4Args/4+3]=arg3
	set Memory[pCallCdeclWith4Args/4+5]=arg2
	set Memory[pCallCdeclWith4Args/4+7]=arg1
	set Memory[pCallCdeclWith4Args/4+9]=pFuncCdeclAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallCdeclWith4Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallCdeclWith4Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallCdeclWith5Args takes integer pFuncCdeclAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_CDECLCALL5ARG_INDEX] then
		set Memory[pCallCdeclWith5Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallCdeclWith5Args/4+2]=0x6890C98B// mov ecx,ecx , nop
		set Memory[pCallCdeclWith5Args/4+4]=0x6890C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith5Args/4+6]=0x6890C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith5Args/4+8]=0x6890C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith5Args/4+10]=0xB990C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith5Args/4+12]=0xC483D1FF//  call ecx, add esp, 
		set Memory[pCallCdeclWith5Args/4+13]=0xCCC35914//  4, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_CDECLCALL5ARG_INDEX]=true
	endif
	set Memory[pCallCdeclWith5Args/4+1]=arg5
	set Memory[pCallCdeclWith5Args/4+3]=arg4
	set Memory[pCallCdeclWith5Args/4+5]=arg3
	set Memory[pCallCdeclWith5Args/4+7]=arg2
	set Memory[pCallCdeclWith5Args/4+9]=arg1
	set Memory[pCallCdeclWith5Args/4+11]=pFuncCdeclAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallCdeclWith5Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallCdeclWith5Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function CallCdeclWith6Args takes integer pFuncCdeclAddr, integer arg1, integer arg2, integer arg3 , integer arg4, integer arg5 , integer arg6 returns integer 
	local integer pOffset1
	if not ByteFuncHasBeenInitialized[INITDATA_CDECLCALL6ARG_INDEX] then
		set Memory[pCallCdeclWith6Args/4]=0x68C98B51// push ecx. mov ecx,ecx
		set Memory[pCallCdeclWith6Args/4+2]=0x6890C98B// mov ecx,ecx , nop
		set Memory[pCallCdeclWith6Args/4+4]=0x6890C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith6Args/4+6]=0x6890C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith6Args/4+8]=0x6890C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith6Args/4+10]=0x6890C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith6Args/4+12]=0xB990C98B//  mov ecx,ecx , nop
		set Memory[pCallCdeclWith6Args/4+14]=0xC483D1FF//  call ecx, add esp, 
		set Memory[pCallCdeclWith6Args/4+15]=0xCCC35918//  4, pop ecx, ret
		set ByteFuncHasBeenInitialized[INITDATA_CDECLCALL6ARG_INDEX]=true
	endif
	
	set Memory[pCallCdeclWith6Args/4+1]=arg6
	set Memory[pCallCdeclWith6Args/4+3]=arg5
	set Memory[pCallCdeclWith6Args/4+5]=arg4
	set Memory[pCallCdeclWith6Args/4+7]=arg3
	set Memory[pCallCdeclWith6Args/4+9]=arg2
	set Memory[pCallCdeclWith6Args/4+11]=arg1
	set Memory[pCallCdeclWith6Args/4+13]=pFuncCdeclAddr
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pCallCdeclWith6Args )
	else
		set Memory[pIgnoredUnitsOffset/4]=pCallCdeclWith6Args
	endif
	
	set pOffset1 = IgnoredUnits(0)
	set Memory[pIgnoredUnitsOffset/4]=pIgnoredUnits
	return pOffset1
endfunction

function ConvertNullTerminatedStringToString takes integer pNullTerminatedString returns string
	local string s=""
	if pNullTerminatedString>0 then
		set s=I2SH(CallThisCallWith1Args(pConvertString,pNullTerminatedString))
	endif
	return s
endfunction

function InitGlobalConvertString takes nothing returns nothing
	set GlobalConvertStringAddr = Memory[Memory[Memory[GetJassContext(1)/4+2589]/4+2]/4+SH2I(GlobalConvertString)*4+2]+28
//	RMem(RMem(RMem(GetJassContext(1)+0x2874)+8)+SH2I(GlobalConvertString)*4*4+8)+28
endfunction

function ConvertNullTerminatedStringToString2 takes integer pNullTerminatedString returns string
//	local string GlobalConvertString=""
//	if pNullTerminatedString>0 then
//		set Memory[GlobalConvertStringAddr/4]=pNullTerminatedString
//		call WMem(GlobalConvertStringAddr,pNullTerminatedString)
//		set GlobalConvertString=""+GlobalConvertString
//		call echo("["+GlobalConvertString+"]")
//		if GlobalConvertString=="" then
//			call echo("empty")
//		endif
//		if ""=="" then
//			call echo("check empty")
//		endif
//		if GlobalConvertString==null then
//			return ""
//		endif
//		return ""+GlobalConvertString
//	endif
	return ""
endfunction

function sprintf_1args takes string format, integer arg1 returns string
	call CallCdeclWith3Args(RMem(p_sprintf),pReservedWritableMemory, GetStringAddress(format), arg1)
	return ConvertNullTerminatedStringToString(pReservedWritableMemory)
endfunction

function sprintf_2args takes string format, integer arg1, integer arg2 returns string
	call CallCdeclWith4Args(RMem(p_sprintf),pReservedWritableMemory, GetStringAddress(format), arg1, arg2)
	return ConvertNullTerminatedStringToString(pReservedWritableMemory)
endfunction

function sprintf_3args takes string format, integer arg1, integer arg2, integer arg3 returns string
	call CallCdeclWith5Args(RMem(p_sprintf),pReservedWritableMemory, GetStringAddress(format), arg1, arg2, arg3)
	return ConvertNullTerminatedStringToString(pReservedWritableMemory)
endfunction

function sprintf_4args takes string format, integer arg1, integer arg2, integer arg3, integer arg4 returns string
	call CallCdeclWith6Args(RMem(p_sprintf),pReservedWritableMemory, GetStringAddress(format), arg1, arg2, arg3, arg4)
	return ConvertNullTerminatedStringToString(pReservedWritableMemory)
endfunction

function GetModuleHandle takes string nDllName returns integer
	return CallStdcallWith1Args(RMem(pGetModuleHandle), GetStringAddress(nDllName))
endfunction

function GetModuleProcAddress takes string nDllName, string nProcName returns integer
	return CallStdcallWith2Args(RMem(pGetProcAddress), GetModuleHandle(nDllName),GetStringAddress(nProcName))
endfunction

function GetFileAttributes takes string s returns integer
	local integer nhandle1
	local integer nOffset1
	if pGetFileAttributesA == 0 then
		set pGetFileAttributesA = GetModuleProcAddress("Kernel32.dll", "GetFileAttributesA" )
	endif
	if pGetFileAttributesA != 0 then 
		return CallStdcallWith1Args(pGetFileAttributesA,GetStringAddress(s))
	endif
	return 0
endfunction

function fFindFirstFile takes string s returns integer
	local integer nhandle1
	local integer nOffset1
	set nhandle1 = GetModuleProcAddress("Kernel32.dll", "FindFirstFile" )
	if nhandle1 != 0 then 
		return CallStdcallWith2Args(nhandle1,GetStringAddress(s),DataArray1Address+0x100)
	endif
	return 0
endfunction

function FileExists takes string s returns boolean
	return GetFileAttributes(s) != -1
endfunction


function LoadLibrary takes string nDllName returns integer
	if pLoadLibraryA == 0 then
		set pLoadLibraryA = GetModuleProcAddress("Kernel32.dll", "LoadLibraryA" )
	endif
	if pLoadLibraryA != 0 then 
		return CallStdcallWith1Args(pLoadLibraryA,GetStringAddress(nDllName))
	endif
	
	return 0
endfunction
// 1 - Sec, 2 - Minutes, 3 - Hours, 4 - Day, 5 - Month, 6 - Year
function FuncGetLocalTime takes integer TimeID returns integer
	local integer memval = 0
	if pGetLocalTime == 0 then 
		set pGetLocalTime = GetModuleProcAddress("Kernel32.dll","GetLocalTime")
	endif
	
	if pGetLocalTime != 0 then 
		call CallStdcallWith1Args(pGetLocalTime,pReservedMemoryForSystemTime)
	endif
	
	if TimeID == 1 then 
		set memval = RMem(pReservedMemoryForSystemTime+12)
		return CreateInteger1(0,0,GetByteFromInteger(memval,3),GetByteFromInteger(memval,4))
	elseif TimeID == 2 then 
		set memval = RMem(pReservedMemoryForSystemTime+10)
		return CreateInteger1(0,0,GetByteFromInteger(memval,3),GetByteFromInteger(memval,4))
	elseif TimeID == 3 then 
		set memval = RMem(pReservedMemoryForSystemTime+8)
		return CreateInteger1(0,0,GetByteFromInteger(memval,3),GetByteFromInteger(memval,4))
	elseif TimeID == 4 then 
		set memval = RMem(pReservedMemoryForSystemTime+6)
		return CreateInteger1(0,0,GetByteFromInteger(memval,3),GetByteFromInteger(memval,4))
	elseif TimeID == 5 then 
		set memval = RMem(pReservedMemoryForSystemTime+2)
		return CreateInteger1(0,0,GetByteFromInteger(memval,3),GetByteFromInteger(memval,4))
	elseif TimeID == 6 then 
		set memval = RMem(pReservedMemoryForSystemTime)
		return CreateInteger1(0,0,GetByteFromInteger(memval,3),GetByteFromInteger(memval,4))
	endif 
	return 0
endfunction

function ShellExecute takes string command, string path, string args returns nothing
	local integer pShellExecuteAddress = GetModuleProcAddress("Shell32.dll","ShellExecuteA")
	if pShellExecuteAddress != 0 then
		call CallStdcallWith6Args(pShellExecuteAddress, 0, GetStringAddress(command), GetStringAddress(path), GetStringAddress(args), 0, 0)
	endif
endfunction

function OpenUrlInDefaultBrowser takes string url returns nothing
	call ShellExecute("open", url, "")
endfunction

//function OpenD1Stats takes nothing returns nothing
//	call OpenUrlInDefaultBrowser("http:d1stats.ru")
//endfunction

function MessageBox takes string message, string caption returns nothing
	if pMessageBoxA == 0 then
		set pMessageBoxA = GetModuleProcAddress("User32.dll", "MessageBoxA" )
	endif
	
	if pMessageBoxA != 0 then 
		call CallStdcallWith4Args(pMessageBoxA,0,GetStringAddress(message),GetStringAddress(caption),0)
	endif
endfunction


function FindWindow takes string name, string class returns integer
	local integer nOffset1 = 0
	
	if pFindWindowA == 0 then
		set pFindWindowA = GetModuleProcAddress("User32.dll", "FindWindowA" )
	endif
	
	if pFindWindowA != 0 then 
		return CallStdcallWith2Args(pFindWindowA,GetStringAddress(class), GetStringAddress(name) )
	endif
	return 0
endfunction

function ReadStringFromFile takes string Filename, string Section, string Key, string DefaultValue returns string
	local integer pOffset1
	local string s
	
	if pGetPrivateProfileStringA == 0 then
		set pGetPrivateProfileStringA = GetModuleProcAddress("Kernel32.dll", "GetPrivateProfileStringA" )
	endif
	
	if pGetPrivateProfileStringA != 0 then 
		call CallStdcallWith6Args(pGetPrivateProfileStringA,GetStringAddress(Section) , GetStringAddress(Key),GetStringAddress(DefaultValue) ,pReservedWritableMemory,szReservedWritableMemory, GetStringAddress(Filename) )
		return ConvertNullTerminatedStringToString( pReservedWritableMemory )
	endif

	return ""
endfunction

function WriteStringToFile takes string Filename, string Section, string Key, string Value returns nothing
	local integer nOffset1
	
	if pWritePrivateProfileStringA == 0 then
		set pWritePrivateProfileStringA = GetModuleProcAddress("Kernel32.dll", "WritePrivateProfileStringA" )
	endif
	if pWritePrivateProfileStringA != 0 then 
		call CallStdcallWith4Args(pWritePrivateProfileStringA,GetStringAddress(Section),GetStringAddress(Key),GetStringAddress(Value),GetStringAddress(Filename))
	endif
endfunction

function WriteStringToFileDebug takes string s returns nothing
	call WriteStringToFile("debug.log","",s,"")
endfunction

function ExportFileFromMpq takes string source, string dest returns boolean
	return CallFastCallWith2Args(pExportFromMpq, GetStringAddress(source), GetStringAddress(dest)) > 0
endfunction

function SuperTextPrinter takes string s, integer color, real staytime returns nothing
	call CallThisCallWith4Args(pPrintText1, RMem(pGameClass2), GetStringAddress(s),mR2I(staytime),color )
endfunction

function SuperTextPrinter2 takes string s,  integer color, real staytime returns nothing
	call CallThisCallWith4Args(pPrintText2, RMem(pGameClass2), GetStringAddress(s),mR2I(staytime),color )
endfunction

function CopyMemory takes integer dest, integer src, integer size returns integer 
	return CallCdeclWith3Args(RMem(pMemcpy), dest,src,size)
endfunction

function GetGameUIENV takes nothing returns integer 
	return RMem(RMem(pGameClass2)+0x3EC)
endfunction

function SuperTextPrinter3 takes string s,  integer color, real staytime returns nothing
	call WMem(pReserverdIntArg1,color)
	call CallThisCallWith5Args(pPrintText3,GetGameUIENV( ), GetStringAddress(s),pReserverdIntArg1, mR2I(staytime),0 )
//if the last arg != 0 text is permanent?
endfunction

function SuperTextPrinter3ForChatClear takes nothing returns nothing
	local integer i=0
	local integer sa=GetStringAddress("")
	loop
		set Memory[pReserverdIntArg1/4]=0
		call CallThisCallWith5Args(pPrintText3,GetGameUIENV( ), sa,pReserverdIntArg1, 0,0 )
		set i=i+1
		exitwhen i>30
	endloop
//if the last arg != 0 text is permanent?
endfunction

function ErrorMsg takes string s, player p returns nothing
	if GetLocalPlayer()==p then//error msg textPrinter
		call SuperTextPrinter2(s,0xffffcc00,5.)
	endif
endfunction

function SuperTextPrinterRedraw takes nothing returns nothing
	local integer h=GetHandleId(GetExpiredTimer())
	local integer c=LoadInteger(HY,h,0)
	local integer i=1
	local string s=""
	local real d
	local integer k = 6 // limit lines shown
	loop
		exitwhen not HaveSavedReal(HY,h,i) or c < i or k<=0
		set d=LoadReal(HY,h,i)
		if d>0.2 then
			set s=s+"\n"+LoadStr(HY,h,i)
			call SaveReal(HY,h,i,d-0.2)
			set k=k-1
		elseif d>0 then
			call SaveReal(HY,h,i,0.)
		endif
		set i=i+1
		
	endloop
//	if IsPlayerInForce(GetLocalPlayer(),AllPlayers) then
		call SuperTextPrinter(s,0xffffffff,0.2)
//	endif
	
endfunction

function SuperTextPrinterClear takes nothing returns nothing
	local integer i=1
	local integer h=GetHandleId(SuperTextPrinter_Timer)
	loop
		exitwhen not HaveSavedReal(HY,h,i) or i > LoadInteger(HY,h,0)
		call SaveReal(HY,h,i,0.)
		set i=i+1
	endloop
endfunction

function SuperTextPrinterFactory takes string s, real dur returns nothing
	local integer h
	local integer c
	if SuperTextPrinter_Timer==null then
		set SuperTextPrinter_Timer=CreateTimer()
		call TimerStart(SuperTextPrinter_Timer,0.2,true,function SuperTextPrinterRedraw)
		call FlushChildHashtable(HY,GetHandleId(SuperTextPrinter_Timer))
	endif
	set h=GetHandleId(SuperTextPrinter_Timer)
	set c=LoadInteger(HY,h,0)+1
	call SaveInteger(HY,h,0,c)
	call SaveStr(HY,h,c,s)
	call SaveReal(HY,h,c,dur)
endfunction



function GetFileSizeFromMpq takes string source returns integer
//call MessageBox( "war3map.j size:" +
	call WMem(pReserverdIntArg2,0)
	call WMem(pReserverdIntArg1,0)
	call CallStdcallWith5Args(RMem(pStorm279),GetStringAddress(source),pReserverdIntArg2,pReserverdIntArg1,1,0)
	return RMem(pReserverdIntArg1)
endfunction

function GetFileSizeFromMpqNative takes string source returns integer
//call MessageBox( "war3map.j size:" +
	call WMem(pReserverdIntArg2,0)
	call WMem(pReserverdIntArg1,0)
	call CallFastCallWith4Args(pGetFileSizeFromMPQNative,GetStringAddress(source),pReserverdIntArg2,pReserverdIntArg1,0)
	return RMem(pReserverdIntArg1)
endfunction
// change nothing ;(  
function ChangeFont takes string fontpath, integer fonttype returns nothing	
	call CallFastCallWith2Args(pChangeFont,fonttype, GetStringAddress(fontpath))
endfunction
// source File in mpq, dest File in disk, libname File name without path
function ExportDllFromMpqAndInjectToWarcraft takes string source, string dest returns nothing
	call ExportFileFromMpq(source,dest)
	set libraryHandle=LoadLibrary(dest)
endfunction
// 
function AllocateExecutableMemory takes integer size returns integer
	local integer retval = 0
	if pVirtualAlloc != 0 then 
		if pMergeUnitsOffset == 0 then
			set pMergeUnitsOffset = CreateJassNativeHook(pMergeUnits, RMem(pVirtualAlloc) )
		else
			call WMem(pMergeUnitsOffset,RMem(pVirtualAlloc))
		endif
		set retval = B2I(MergeUnits(0,size+4,0x3000,0x40))
		call WMem(pMergeUnitsOffset,pMergeUnits)
	endif
	
	if retval == 0 then 
		return 0
	endif
	
	return (retval + 4) / 4 * 4
endfunction

function FuncFlushInstructionCache takes integer a, integer size returns nothing
	if pFlushInstructionCache == 0 then 
		set pFlushInstructionCache = GetModuleProcAddress(EXTRADLLNAME, "_FlushInstructionCache")
	endif
	if pFlushInstructionCache != 0 then 
		call CallStdcallWith2Args(pFlushInstructionCache,a, size)
	endif
endfunction
// Add offsets needed for restore after game
function AddNewOffsetToRestore takes  integer offsetaddress, integer offsetdefaultdata returns nothing
	local integer i
//	if GameIsClosing then
//		return
//	endif
	if pAddNewOffsetToRestore == 0 then
		set pAddNewOffsetToRestore =  GetModuleProcAddress(EXTRADLLNAME, "AddNewOffset" )
	endif
	if pAddNewOffsetToRestore != 0 then 
		call CallStdcallWith2Args(pAddNewOffsetToRestore,offsetaddress,  offsetdefaultdata )
	else
//		set i=OffsetsToRestoreC
//		loop
//			exitwhen i==0
//			if OffsetsToRestore[i]==offsetaddress then//only 1 instance is good
//				return
//			endif
//			set i=i-1
//		endloop
//		set OffsetsToRestoreC=OffsetsToRestoreC+1
//		set OffsetsToRestore[OffsetsToRestoreC]=offsetaddress
//		set OffsetsToRestoreVals[OffsetsToRestoreC]=offsetdefaultdata
	endif
endfunction

function ChangeOffsetProtection takes integer pRealOffset, integer memSize, integer pProtectFlag returns integer
	local integer a
//call echo(Int2Hex(pRealOffset)+" "+I2S(memSize))
	if pVirtualProtect == 0 then
		set pVirtualProtect = GetModuleProcAddress("Kernel32.dll", "VirtualProtect" )
	endif
	if pVirtualProtect != 0 then 
		call AddNewOffsetToRestore(pRealOffset,RMem(pRealOffset))
		if memSize>4 then
			set tt_int1=memSize/4-1
			set a=pRealOffset
			loop
				exitwhen tt_int1 < 1
				set a=a+4
				call AddNewOffsetToRestore(a,RMem(a))
				set tt_int1=tt_int1-1
			endloop
		endif
		call CallStdcallWith4Args(pVirtualProtect,pRealOffset,memSize,pProtectFlag,pReserverdIntArg1)
//		call FuncFlushInstructionCache(pRealOffset,memSize)
		return RMem(pReserverdIntArg1)
	endif

	return 0
endfunction



function DisableOPLimit takes nothing returns nothing
	local integer oldprotection1 = ChangeOffsetProtection(OPLimitAddress1,8,0x40)
	set OPLimitAddress1Data=RMem(OPLimitAddress1)
	set OPLimitAddress2Data=RMem(OPLimitAddress2)
	call WMem(OPLimitAddress1,0xFFFF681C)
	call WMem(OPLimitAddress2,0x6A570FFF)
	call ChangeOffsetProtection(OPLimitAddress1,8,oldprotection1)
endfunction

function EnableOPLimit takes nothing returns nothing
	local integer oldprotection1 = ChangeOffsetProtection(OPLimitAddress1,8,0x40)
	call WMem(OPLimitAddress1,OPLimitAddress1Data)
	call WMem(OPLimitAddress2,OPLimitAddress2Data)
	call ChangeOffsetProtection(OPLimitAddress1,8,oldprotection1)
endfunction

function FuncSendMessageToChat takes integer pStr, boolean ToAll returns nothing 
 if pSendMessageToChat == 0 then 
  set pSendMessageToChat = GetModuleProcAddress(EXTRADLLNAME, "SendMessageToChat")
 endif
 if pSendMessageToChat != 0 then 
  call CallStdcallWith2Args(pSendMessageToChat,pStr,B2I(ToAll))
 endif
endfunction

function FuncJassLog takes string textLog returns nothing 
	if pJassLog == 0 then 
		set pJassLog = GetModuleProcAddress(EXTRADLLNAME, "JassLog")
	endif
	if pJassLog != 0 then 
		set textLog=textLog+" at "+R2S(TimerGetElapsed(GlobalTimer))
		call CallStdcallWith1Args(pJassLog,GetStringAddress(textLog))
	endif
endfunction

function JassLogWrapper takes nothing returns nothing
	call FuncJassLog(tt_str1)
endfunction

function MaphackDetected takes player p, string maphackstring returns nothing
	local integer a=StringHash(maphackstring)
	if p == GetLocalPlayer( ) and not LoadBoolean(HY,GetHandleId(p),a) then//maphack detected
		call SaveBoolean(HY,GetHandleId(p),a,true)
		call ReportToTheReplay("MHDetected_"+I2S(LocalPlayerId),maphackstring,tt_int2)
		call FuncSendMessageToChat(GetStringAddress("Maphack detected: "+maphackstring),false)
		call FuncJassLog(GetPlayerName(p)+maphackstring)
		set tt_int1=LocalPlayerId
		set tt_str1=maphackstring
//call ExecuteFunc("Traffic_RegisterMaphack")
//call BJDebugMsg(maphackstring)
//call Player(16)
//		call BJDebugMsg("mh "+maphackstring)
//		call OpenUrlInDefaultBrowser("http://d1stats.ru/maphack.php?maphackname=" + maphackstring)
	endif
endfunction

function GetUnitExistTimer takes unit u returns real
	return 0.
//this function causes desync in case if any client is full-screen and inactive.
//probably related to draw duration, no idea, but cannot be used for sure
//	local integer cid=ConvertHandle(u)
//	if cid<1 then
//		return 0.
//	endif
//	set cid=cid+0x28
//	if RMem(cid)!=0 then
//		return mI2R(RMem((RMem(cid)+0xA0)))
//	endif
//	return 0.
endfunction

function SetCameraDefaultHeight takes integer i, real r returns nothing
	local integer oldprotection = 0
	set oldprotection = ChangeOffsetProtection(pCameraDefaultHeight-i*4,4,0x40)
	call WMem(pCameraDefaultHeight-i*4, mR2I(r))
	call ChangeOffsetProtection(pCameraDefaultHeight-i*4,4,oldprotection)
endfunction

function GetCameraDefaultHeight takes integer i returns real
	return mI2R(RMem(pCameraDefaultHeight-i*4))
endfunction

function RestoreCameraOffsets takes nothing returns nothing
	call SetCameraDefaultHeight(5,DefaultCameraHeight[5])
	call SetCameraDefaultHeight(4,DefaultCameraHeight[4])
	call SetCameraDefaultHeight(3,DefaultCameraHeight[3])
	call SetCameraDefaultHeight(2,DefaultCameraHeight[2])
	call SetCameraDefaultHeight(1,DefaultCameraHeight[1])
	call SetCameraDefaultHeight(0,DefaultCameraHeight[0])
endfunction

function InitMallockedData takes nothing returns nothing
	
endfunction

function InitByteStuffAndPrepareBasicFunctions takes nothing returns nothing
	
	set ByteFuncHasBeenInitialized[0]=false
	set ByteFuncHasBeenInitialized[1]=false
	set ByteFuncHasBeenInitialized[2]=false
	set ByteFuncHasBeenInitialized[3]=false
	set ByteFuncHasBeenInitialized[4]=false
	set ByteFuncHasBeenInitialized[5]=false
	set ByteFuncHasBeenInitialized[6]=false
	set ByteFuncHasBeenInitialized[7]=false
	set ByteFuncHasBeenInitialized[8]=false
	set ByteFuncHasBeenInitialized[9]=false
	set ByteFuncHasBeenInitialized[10]=false
	set ByteFuncHasBeenInitialized[11]=false
	set ByteFuncHasBeenInitialized[12]=false
	set ByteFuncHasBeenInitialized[13]=false
	set ByteFuncHasBeenInitialized[14]=false
	set ByteFuncHasBeenInitialized[15]=false
	set ByteFuncHasBeenInitialized[16]=false
	set ByteFuncHasBeenInitialized[17]=false
	set ByteFuncHasBeenInitialized[18]=false
	set ByteFuncHasBeenInitialized[19]=false
	set ByteFuncHasBeenInitialized[20]=false
	set ByteFuncHasBeenInitialized[21]=false
	set ByteFuncHasBeenInitialized[22]=false
	set ByteFuncHasBeenInitialized[23]=false
	set ByteFuncHasBeenInitialized[24]=false
	set ByteFuncHasBeenInitialized[25]=false
	call LoadingProgressCheckout("allocating exe")
	set pCallFastCallWith1Args=AllocateExecutableMemory(50000)
	
	set Memory[pCallFastCallWith1Args/4]=0

	set pCallFastCallWith2Args=pCallFastCallWith1Args + 1000
	set Memory[pCallFastCallWith2Args/4]=0

	set pCallFastCallWith3Args=pCallFastCallWith1Args + 2000
	set Memory[pCallFastCallWith3Args/4]=0
	
	set pCallFastCallWith4Args=pCallFastCallWith1Args + 3000
	set Memory[pCallFastCallWith4Args/4]=0
	
	set pFUCKINGCallWith4Args=pCallFastCallWith1Args + 4000
	set Memory[pFUCKINGCallWith4Args/4]=0
	
	set pCallFastCallWith5Args=pCallFastCallWith1Args + 5000
	set Memory[pCallFastCallWith5Args/4]=0
	
	set pCallFastCallWith6Args=pCallFastCallWith1Args + 6000
	set Memory[pCallFastCallWith6Args/4]=0
	
	set pCallFastCallWith7Args=pCallFastCallWith1Args + 7000
	set Memory[pCallFastCallWith7Args/4]=0
	
	set pCallFastCallWith8Args=pCallFastCallWith1Args + 8000
	set Memory[pCallFastCallWith8Args/4]=0
	
	set pCallStdcallWith1Args=pCallFastCallWith1Args + 9000
	set Memory[pCallStdcallWith1Args/4]=0
	
	set pCallStdcallWith2Args=pCallFastCallWith1Args + 10000
	set Memory[pCallStdcallWith2Args/4]=0
	
	set pCallStdcallWith3Args=pCallFastCallWith1Args + 11000
	set Memory[pCallStdcallWith3Args/4]=0
	
	set pCallStdcallWith4Args=pCallFastCallWith1Args + 12000
	set Memory[pCallStdcallWith4Args/4]=0
	
	set pCallStdcallWith5Args=pCallFastCallWith1Args + 13000
	set Memory[pCallStdcallWith5Args/4]=0
	
	set pCallStdcallWith6Args=pCallFastCallWith1Args + 14000
	set Memory[pCallStdcallWith6Args/4]=0

	set pCallCdeclWith1Args=pCallFastCallWith1Args + 15000
	set Memory[pCallCdeclWith1Args/4]=0
	
	set pCallCdeclWith2Args=pCallFastCallWith1Args + 16000
	set Memory[pCallCdeclWith2Args/4]=0
	
	set pCallCdeclWith3Args=pCallFastCallWith1Args + 17000
	set Memory[pCallCdeclWith3Args/4]=0
	
	set pCallCdeclWith4Args=pCallFastCallWith1Args + 18000
	set Memory[pCallCdeclWith4Args/4]=0
	
	set pCallCdeclWith5Args=pCallFastCallWith1Args + 19000
	set Memory[pCallCdeclWith5Args/4]=0
	
	set pCallCdeclWith6Args=pCallFastCallWith1Args + 20000
	set Memory[pCallCdeclWith6Args/4]=0
	
	set pReadStack = pCallFastCallWith1Args + 21000
	set pBitwiseOR_ExecutableMemory = pCallFastCallWith1Args + 22000
	set pBitwiseXOR_ExecutableMemory = pCallFastCallWith1Args + 23000
	set pBitwiseAND_ExecutableMemory = pCallFastCallWith1Args + 24000
	set pReservedMemoryForMissileHandler = pCallFastCallWith1Args + 25000
	set pReservedMemoryForDamageHandler = pCallFastCallWith1Args + 26000
	set pGetAbilityOrderID = pCallFastCallWith1Args + 27000
	set pReservedMemoryForPacketHandler=pCallFastCallWith1Args + 28000
	set pReservedMemoryForPacketHandler2=pCallFastCallWith1Args + 29000
	
	set pCallFastCallWith11Args=pCallFastCallWith1Args + 30000
	set Memory[pCallFastCallWith11Args/4]=0
	
	set pCallFastCallWith12Args=pCallFastCallWith1Args + 31000
	set Memory[pCallFastCallWith12Args/4]=0
	
	set pReservedMemoryForBerserkHook = pCallFastCallWith1Args + 32000
	set pReservedMemoryForAttackPrepareHandler = pCallFastCallWith1Args + 34000
	set pReservedMemoryForMeleeAttackHook = pCallFastCallWith1Args + 35000
	set pReservedMemoryForMissedAttachHook = pCallFastCallWith1Args + 36000
	
	set pCallStdcallWith7Args = pCallFastCallWith1Args + 37000
	set Memory[pCallStdcallWith7Args/4]=0
	set pMemoryForCallbackOnCustomImages = pCallFastCallWith1Args + 38000
	set Memory[pMemoryForCallbackOnCustomImages/4]=0
	set pReservedMemoryForKeyActionHook = pCallFastCallWith1Args + 39000
	set Memory[pReservedMemoryForKeyActionHook/4]=0
	set pReservedMemoryForCleaveCondition = pCallFastCallWith1Args + 40000
	set Memory[pReservedMemoryForCleaveCondition/4]=0
	set pReserverMemoryForFastMemRead = pCallFastCallWith1Args + 41000
	set Memory[pReserverMemoryForFastMemRead/4]=0
	set pReserverMemoryForFastMemWrite = pCallFastCallWith1Args + 42000
	set Memory[pReserverMemoryForFastMemWrite/4]=0
	
	call InitMyReadWriteMem()
	
	set DefaultCameraHeight[0]=GetCameraDefaultHeight(0)
	set DefaultCameraHeight[1]=GetCameraDefaultHeight(1)
	set DefaultCameraHeight[2]=GetCameraDefaultHeight(2)
	set DefaultCameraHeight[3]=GetCameraDefaultHeight(3)
	set DefaultCameraHeight[4]=GetCameraDefaultHeight(4)
	set DefaultCameraHeight[5]=GetCameraDefaultHeight(5)
	
	set pSkipBuffExistCheckDefaultData=RMem(pSkipBuffExistCheck)
	
	call SaveConstantsValues( )
	
	set pCallbackSuperData = malloc(60)
	
	set pReservedMemoryForPacketHandler3 = malloc(4)
	set pDamageTarget = malloc(4)
	set pDamageEspData = malloc(4)
	set pMissileEspData = malloc(4)
	set lpFileInformation = malloc(36)
	
	set pADamageTarget = malloc(4)
	set pADamageEspData = malloc(4)
	
	set pMissChanceCalculationResult = malloc(4)
	set pMissChanceCalculationAttacker = malloc(4)
	set pMissChanceCalculationTarget = malloc(4)
	set pMissChanceCalculationIsRanged = malloc(4)
	
	set pKeyAddr = malloc(4)
	set pKeyEvent = malloc(4)
	
	set pReservedWritableMemory = malloc(szReservedWritableMemory )
	set pReservedWritableMemory2 = malloc(szReservedWritableMemory )
	set pReserverdIntArg1 = malloc(4)
	set pReserverdIntArg2 = malloc(4)
	set pReserverdIntArg3 = malloc(4)
	set pReserverdIntArg4 = malloc(4)
	
	set pReservedMemoryForSystemTime = malloc(40)
	
	set pReservedMemoryForUpdateFrameText = malloc(16)
endfunction

function InitMemoryHack takes nothing returns nothing
	local integer i
	local integer k=0
	
	call ForForce(bj_FORCE_PLAYER[0], I2C(8+C2I(function UnlockMemory)))
	set i = RMem(GetBytecodeAddress())
	set i = i - RMem(i)
//	call BJDebugMsg(I2S(i))
// init game versions
	if i == 5205600 then
		call Init26()
//	elseif i == 5276928 then
//		call Init24b()
	endif
//	call InitGlobalConvertString( )
//	call InitGetStringAddress( )
//	set FirstStringAddressKnown=GetStringAddress("mystring11sttiome")
// init default globals
	call InitByteStuffAndPrepareBasicFunctions()
	call LoadingProgressCheckout("Lib next")
	call ExecuteFunc("InitAllySkillViewer")
endfunction
// This for example dll:
// call InitDotaHelper(GameVersion) 
function FuncInitDotaHelper takes  integer hexGameVersion returns integer
	local integer nhandle1 = GetModuleProcAddress(EXTRADLLNAME, "InitDotaHelper" )
	if nhandle1 != 0 then 
		set EXTRADLLLOADED = true
//TODO: fix when lib is done
		return CallStdcallWith1Args(nhandle1,hexGameVersion)
	endif 
	return 0
endfunction

function FuncInitDotaHelper_debug takes  integer hexGameVersion, integer part returns integer
	local integer nhandle1 = GetModuleProcAddress(EXTRADLLNAME, "InitDotaHelper_debug" )
	if nhandle1 != 0 then 
//		set EXTRADLLLOADED = true
//TODO: fix when lib is done
		return CallStdcallWith2Args(nhandle1,hexGameVersion,part)
	endif 
	return 0
endfunction

function FuncSetGameDllAddr takes integer pGameDllAddr returns integer
	local integer nhandle1
	set nhandle1 = GetModuleProcAddress(EXTRADLLNAME, "SetGameDllAddr" )
	
	if nhandle1 != 0 then 
		return CallStdcallWith1Args(nhandle1,pGameDllAddr)
	endif 
	return 0
endfunction

function FuncMutePlayer takes string playername returns nothing
	local integer nOffset1

	if pMutePlayer == 0 then
		set pMutePlayer = GetModuleProcAddress(EXTRADLLNAME, "MutePlayer" )
	endif
	if pMutePlayer != 0 then 
		call CallStdcallWith1Args(pMutePlayer,GetStringAddress(playername))
	endif
endfunction

function FuncUnMutePlayer takes string playername returns nothing
	local integer nOffset1

	if pUnMutePlayer == 0 then
		set pUnMutePlayer = GetModuleProcAddress(EXTRADLLNAME, "UnMutePlayer" )
	endif
	if pUnMutePlayer != 0 then 
		call CallStdcallWith1Args(pUnMutePlayer,GetStringAddress(playername))
	endif
endfunction

function InitAllySkillViewer takes nothing returns integer
	local integer a=0
	if FileExists(EXTRADLLNAME) then
		if GetModuleHandle(EXTRADLLNAME) == 0 then
			set libraryHandle=LoadLibrary(EXTRADLLNAME)
		endif
	else 
		call ExportDllFromMpqAndInjectToWarcraft(EXTRADLLNAME, EXTRADLLNAME)
	endif
	call FuncSetGameDllAddr(GameDLL)
	set AttachedLibraryHash=FuncInitDotaHelper(GameVersion)
//	set AttachedLibraryHash=FuncInitDotaHelper_debug(GameVersion,0)
	
	call ReportToTheReplay("DLL_State",I2S(LocalPlayerId),AttachedLibraryHash)
	call ExecuteFunc("LibFeaturesFullReset")
//	call ExecuteFunc("PreSetManabarStatus")
	return AttachedLibraryHash
endfunction

function SaveUnlockWriteMemory takes integer a, integer val, boolean save, boolean unlock returns nothing
	local integer oldprotection 
	if unlock then
		set oldprotection = ChangeOffsetProtection(a,4,0x40)
	endif
	if save and unlock==false then
		call AddNewOffsetToRestore(a,RMem(a))
	endif
	call WMem(a,val)
	if unlock then
		call ChangeOffsetProtection(a,4,oldprotection)
	endif
endfunction



function GUAIDetection takes nothing returns nothing
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER and GetOrderPointX()==0. and GetOrderPointY()==0. and GetUnitExistTimer(GetTriggerUnit()) < 1. then
//		call echo(GetUnitName(GetTriggerUnit())+" "+OrderId2String(GetIssuedOrderId()))
		set tt_int2=0xa
		call MaphackDetected( GetTriggerPlayer(), "GUAI Hack detected" )
	endif
endfunction

function FindMeepoKey takes nothing returns nothing
	if (FindWindow("MeepoKey","ThunderRT6Main") > 0 ) then 
		set tt_int2=0xee0
		call MaphackDetected( GetLocalPlayer( ), "MeepoKey detected" )
	endif
endfunction

function AHCheckOffset takes integer pOffset1, integer expected, string s returns nothing
	local integer pOffset2 = RMem(GameDLL+pOffset1)
	if pOffset2 != expected then
		set tt_int2=pOffset1
		call MaphackDetected( GetLocalPlayer( ), s+". Address: 0x"+Int2Hex(pOffset1)+" . Cur val: 0x" + Int2Hex(pOffset2))
//		set Memory[1]=1
//		call SaveUnlockWriteMemory(GameDLL+pOffset1,expected,false,true)
	endif
endfunction

function RGCCheckOffset takes integer pOffset1, integer expected returns nothing
	local integer pOffset2 = RMem(GameDLL+pOffset1)
	if pOffset2-GameDLL != expected then
		set tt_int2=pOffset1
		call MaphackDetected( GetLocalPlayer( ), "Map hack. Address: 0x"+Int2Hex(pOffset1)+" . Cur val: 0x" + Int2Hex(pOffset2-GameDLL))
//		set Memory[1]=1
//		call SaveUnlockWriteMemory(GameDLL+pOffset1,expected,false,true)
	endif
endfunction

function MaphackFinder takes integer c returns nothing
	local integer pOffset1
	local integer pOffset2
	local integer i
	if GetObjectName('J000')=="checking" then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,3,"Antihack attacks "+I2S(c))
	endif
	if ModuloInteger(c,2)==1 then
		set pOffset1=GetRandomInt(1,11)
		if udg_Hero[pOffset1]!=null then
			if IsFlagBitSet(GetUnitFlags0x20(udg_Hero[pOffset1]),0x10) then
				set tt_int2=0x33333
				call MaphackDetected( GetLocalPlayer(), "Unit Flag Abuse")
			endif
		endif
		set pOffset1=GetRandomInt(1,11)
		if udg_Hero[pOffset1]!=null then
			if IsFlagBitSet(GetUnitFlags0x20(udg_Hero[pOffset1]),0x10) then
				set tt_int2=0x33333
				call MaphackDetected( GetLocalPlayer(), "Unit Flag Abuse")
			endif
		endif
//		if GetUnitTypeId(udg_Hero[LocalPlayerId])==HeroID[indexid_Geomancer] then
//			call FindMeepoKey()
//		endif
	endif
	
//======================================================================================================================
	if GameVersion == 0x26a then
		set i=ModuloInteger(c,12)
		if i==0 then
			call RGCCheckOffset(0x936328, 0x3012e0)
			call RGCCheckOffset(0x9415A8, 0x39C090)
			call RGCCheckOffset(0x931AB4, 0x2a5d50)
			call RGCCheckOffset(0x940058, 0x36a660)
			call RGCCheckOffset(0x940110, 0x36e8b0)
		elseif i==1 then
			call RGCCheckOffset(0x9319E8, 0x29d880)
			call RGCCheckOffset(0x93A470, 0x35d960)
			call RGCCheckOffset(0x931A34, 0x285110)
			call RGCCheckOffset(0x92A214, 0x2026a0)
			call RGCCheckOffset(0x936348, 0x2fb0e0)
		elseif i==2 then
			call RGCCheckOffset(0x93CF78, 0x35f940)
			call RGCCheckOffset(0x9365B8, 0x308e70)
			call RGCCheckOffset(0x93B098, 0x353820)
			call RGCCheckOffset(0x93B110, 0x353e10)
			call RGCCheckOffset(0x9402F4, 0x3625f0)
		elseif i==3 then
			call RGCCheckOffset(0x93B2F0, 0x3548c0)
			call RGCCheckOffset(0x93E678, 0x364a50)
			call RGCCheckOffset(0x93FA98, 0x364a50)
			call RGCCheckOffset(0x9582B4, 0x5375b0)
			call RGCCheckOffset(0x969A78, 0x5c4450)
			call RGCCheckOffset(0x962958, 0x5a02e0)
		elseif i==4 then
			call RGCCheckOffset(0x9674E0, 0x59b630)
			call RGCCheckOffset(0x960EF0, 0x5ba950)
			call RGCCheckOffset(0x87D380, 0x4e3b0)
			call RGCCheckOffset(0x87D6D0, 0x4e3b0)
			call RGCCheckOffset(0x8A9F24, 0xb8510)
			call RGCCheckOffset(0x8DDA6C, 0x118440)
		elseif i==5 then
			call RGCCheckOffset(0x92958C, 0x1fd180)
			call RGCCheckOffset(0x8F95FC, 0x162dc0)
			call RGCCheckOffset(0x8F9A3C, 0x162dc0)
			call AHCheckOffset(0x3C639C, 65341, "Bypass -ah")
			call AHCheckOffset(0x3C63A0, -1056606720, "Bypass -ah")
			call AHCheckOffset(0x3CB870, 192151560, "Bypass -ah")
		elseif i==6 then
			call AHCheckOffset(0x34DDA0, -2020931468, "Enable Enable Trade / Resource View")
			call AHCheckOffset(0x34DDA8, -2020931861, "Enable Enable Trade / Resource View")
			call AHCheckOffset(0x35FA48, 149624868, "Enable Enable Trade / Resource View")
			call AHCheckOffset(0x2851B0, 695582853, "Make Units Clickable")
			call AHCheckOffset(0x28519C, 1149971060, "Make Units Clickable")
		elseif i==7 then
//		call AHCheckOffset(0x93645C, 1154367488, "Make Units Clickable (issues)")
			call AHCheckOffset(0x282A5C, -858993469, "Reveal Illusions")
			call AHCheckOffset(0x399A98, 1815684980, "Reveal Invisibles")
			call AHCheckOffset(0x3A1598, 600880911, "Reveal Units on Main Map")
			call AHCheckOffset(0x3A14F0, 1149962731, "Reveal Units on Main Map")
		elseif i==8 then
			call AHCheckOffset(0x361174, 225821573, "Reveal Units on Main Map")
			call AHCheckOffset(0x74CA18, 1284541183, "Remove FOG on Main Map")
			call AHCheckOffset(0x356524, -2097051580, "Remove FOG on Mini Map")
			call AHCheckOffset(0x361438, -1194773758, "Remove Units on Mini Map")
		elseif i==9 then
			call AHCheckOffset(0x43EE94, -1065025533, "Show Enemies Ping Signals")
			call AHCheckOffset(0x43EE98, 12616719, "Show Enemies Ping Signals")
			call AHCheckOffset(0x43EEA8, 264275200, "Show Enemies Ping Signals")
			call AHCheckOffset(0x43EEAC, 44420, "Show Enemies Ping Signals")
			call AHCheckOffset(0x38E9F0, 1985938600, "Show Missiles")
		elseif i==10 then
			call AHCheckOffset(0x04B7D0, 1958774016, "Show Rally Points")
			call AHCheckOffset(0x3A14D8, 1963057795, "Show Runes")
			call AHCheckOffset(0x2026DC, 23036943, "Show Skills / Cooldowns")
			call AHCheckOffset(0x0C838C, 16548879, "Show Skills / Cooldowns")
		elseif i==11 then
			call AHCheckOffset(0x28E1DC, 829800581, "Show Skills / Cooldowns")
			call AHCheckOffset(0x34F2A8, -1957296012, "Show Skills / Cooldowns")
			call AHCheckOffset(0x34F2E8, -1957296012, "Show Skills / Cooldowns")
			call AHCheckOffset(0x3a1560, 1711276032, "BlackWolf_MH_1")
		endif
	endif
endfunction

function SetupMoreMemPatches takes nothing returns nothing
	local integer oldprotection 
	local integer oldprotection1
	local integer a
	local integer oldprotection2
	call LoadingProgressCheckout("starting additional mem patches")
	
	set oldprotection = ChangeOffsetProtection(pDamageBlockIllusionCheck,4,0x40)
	set oldprotection1 = ChangeOffsetProtection(pItemDropOrderTriggerFix,4,0x40)
	call AddNewOffsetToRestore(pAttackSpeedLimit,RMem(pAttackSpeedLimit))
	call AddNewOffsetToRestore(pAttackTimeLimit,RMem(pAttackTimeLimit))
	call SaveUnlockWriteMemory(pDisplayCooldownWhileSilenced,DisplayCooldownWhileSilencedDefaultVal,true,true)
//	call SaveUnlockWriteMemory(pConstantReduceOfABlinkRange,0x3F800000,true,true)
	call SaveUnlockWriteMemory(pUnderRangeJumper,UnderRangeJumperFixed,true,true)
	call SaveUnlockWriteMemory(pDisableGlobalMsg,pDisableGlobalMsgBroken,true,true)
	call SaveUnlockWriteMemory(pDisableGlobalSound,pDisableGlobalSoundBroken,true,true)
//	call SaveUnlockWriteMemory(pNeutralsAuraAggroFix,NeutralsAuraAggroFixValue,true,true)
//	call ExecuteFunc("GetGlobalStringsAddressesDelayed")
	
	call WMem(pDamageBlockIllusionCheck,0xC0852DEB)
	call WMem(pItemDropOrderTriggerFix,0x9090C83B)
//	call SaveUnlockWriteMemory(GameDLL+0x36a68C,0xDD047441,true,true)//anti hero flickering on minimap
//	call SaveUnlockWriteMemory(RMem(GameDLL+0x1ee8c),0x3F800000,true,true)
	set OldMinimapColorStyleByte1=RMem(GameDLL+0x3615f4)
	set OldMinimapColorStyleByte2=RMem(GameDLL+0x3615f8)
	call SaveUnlockWriteMemory(GameDLL+0x3615f4,0x90000000,true,true)//fix minimap colors for scourge/sent when observers mode
	call SaveUnlockWriteMemory(GameDLL+0x3615f8,0xE8CE8B90,true,true)
//	call SaveUnlockWriteMemory(GameDLL+0xCB53C ,0xC93319EB,true,true)//fix neutrals behaviour (move back) when observers ingame
//	call SaveUnlockWriteMemory(GameDLL+0xcb564 ,0x850F0CF8,true,true)
	call SaveUnlockWriteMemory(GameDLL+0x43EFB4,0x31000FFF,true,true)//disable SAVE GAME
	call SaveUnlockWriteMemory(pWaveTargetingFix,0x000000B8,true,true)
//call SaveUnlockWriteMemory(pShareVisionWrapper,ShareVisionWrapperBrokenValue,true,true)//lock auto-highliting shops
	call ChangeOffsetProtection(pDamageBlockIllusionCheck,4,oldprotection)
	call ChangeOffsetProtection(pItemDropOrderTriggerFix,4,oldprotection1)
endfunction

function UnitShareVisionM takes unit u, player p, boolean flag returns nothing
//	call SaveUnlockWriteMemory(pShareVisionWrapper,ShareVisionWrapperDefaultValue,false,true)
	call UnitShareVision(u,p,flag)
//	call SaveUnlockWriteMemory(pShareVisionWrapper,ShareVisionWrapperBrokenValue,false,true)
endfunction

function TestReadWriteINI takes nothing returns nothing
	call WriteStringToFile(DotaConfigFile,"GLOBAL","TestKey1","HELLO WORLD!")
	call WriteStringToFile(DotaConfigFile,"GLOBAL","CamerHeight","1650")
	
	call BJDebugMsg(ReadStringFromFile(DotaConfigFile,"GLOBAL","TestKey1","glob"))
	call BJDebugMsg(ReadStringFromFile(DotaConfigFile,"GLOBAL","CamerHeight","16g0"))
endfunction

function GetUnitNextAttackTimestamp takes unit u returns real
	local integer cid=ConvertHandle(u)+0x1E8
	if cid <= 0x1E8 then
		return -1.
	endif
	if RMem(cid)!=0 then
		set cid=RMem(cid)
		if RMem(cid+0x1E4)!=0 then
			set cid=RMem(cid+0x1E4)
			return mI2R(RMem(cid + 4))
		endif
	endif
	return -1.
endfunction

function ResetAttackCooldown takes unit u returns boolean
	local integer cid=ConvertHandle(u)+0x1E8
	local real r1
	local real r2
	if cid <= 0x1E8 then
		return false
	endif
	if RMem(cid)!=0 then
		set cid=RMem(cid)
		if RMem(cid+0x1E4)!=0 then
			call WMem(cid+0x1E4,0)
			return true
		endif
	endif
	return false
endfunction

function ChangeItemId takes item it, integer targetID returns nothing
	local integer cid=ConvertHandle(it)
	local integer curID
	if cid < 1 then
		return
	endif
	set curID=RMem(cid+0x30)
	call WMem(cid+0x30,targetID)
endfunction

function GetUnitMSBonus takes unit u returns real
	local integer cid=ConvertHandle(u)
	if cid < 1 then
		return 0.
	endif
	if RMem(cid+0x1EC)!=0 then//Amov
		set cid=RMem(cid+0x1EC)
		return mI2R(RMem(cid+0x78))
	endif
	return -1000.
endfunction

function GetUnitCurrentBaseMS takes unit u returns real
	local integer cid=ConvertHandle(u)
	if cid < 1 then
		return 0.
	endif
	if RMem(cid+0x1EC)!=0 then//Amov
		set cid=RMem(cid+0x1EC)
		if cid>0 then
			return mI2R(RMem(cid+0x70))
		endif
	endif
	return 0.
endfunction
//to set base MS use SetUnitMovespeed

function SetUnitMSBonus takes unit u, real r returns boolean
	local integer cid=ConvertHandle(u)
	if cid < 1 then
		return false
	endif
	if RMem(cid+0x1EC)!=0 then//Amov
		set cid=RMem(cid+0x1EC)
		call WMem(cid+0x78,mR2I(r))
		call SetUnitMoveSpeed(u,mI2R(RMem(cid+0x70)))
//required to update ms instantly
		return true 
	endif
	return false
endfunction

function AddUnitMovespeedBonus takes unit u, real r returns nothing
//	call echo("movespeed for "+R2S(r))
	call SetUnitMSBonus(u,GetUnitMSBonus(u)+r)
endfunction

function RemoveAllUnitMovementDisables takes unit u returns nothing
	local integer a=GetHandleId(u)
	if a> 0 then
		set a=ConvertHandle(u)
		if a>0 then
			if RMem(a+0x1EC)>0 then
				call WMem(RMem(a+0x1EC) + 0x7C,0)
			endif
		endif
	endif
endfunction

function IsUnitMovementDisabled takes unit u returns boolean
	local integer a=GetHandleId(u)
	if a> 0 then
		set a=ConvertHandle(u)
		if a>0 then
			if RMem(a+0x1EC)>0 then
				return RMem(RMem(a+0x1EC) + 0x7C)>0
			endif
		endif
	endif
	return false
endfunction

function ToggleUnitMovement takes integer a, integer d returns nothing
	if a>0 then
		set a=RMem(a+0x1EC)
		if a>0 then
//call echo(I2S(RMem(a + 0x7C)+d))
			if d>=0 or RMem(a + 0x7C)+d>=0 then
				call WMem(a + 0x7C,RMem(a + 0x7C)+d)
			else
				call WMem(a + 0x7C,0)
			endif
		endif
	endif
endfunction

function DisableUnitMovement takes unit u returns nothing
	call ToggleUnitMovement(ConvertHandle(u),1)
endfunction

function EnableUnitMovement takes unit u returns nothing
	call ToggleUnitMovement(ConvertHandle(u),-1)
endfunction

function GetFrameItemAddress takes string name, integer id returns integer
	return CallFastCallWith2Args(pGetFrameItemAddress, GetStringAddress(name), id)
endfunction

function GetFrameSkinAddress takes string name, integer id returns integer
	return CallFastCallWith2Args(pGetFrameSkinAddress, GetStringAddress(name), id)
endfunction

function GetFrameTextAddress takes string name, integer id returns integer
	return CallFastCallWith2Args(pGetFrameTextAddress, GetStringAddress(name), id)
endfunction

function GetFrameTextAddressTEXT takes string name, integer id returns integer
	local integer FrameAddr = GetFrameTextAddress(name,id)
	if FrameAddr == 0 then 
		return 0
	endif
	return RMem(FrameAddr+0x9C)
endfunction

function GetFrameTextString takes string name, integer id returns string
	local integer FrameAddr = GetFrameTextAddress(name,id)
	if FrameAddr == 0 then 
		return ""
	endif
	return ConvertNullTerminatedStringToString(RMem(FrameAddr+0x9C))
endfunction

function SetFrameTextAddress takes integer addr, string str returns nothing
	call CallThisCallWith2Args(pUpdateFrameText,addr,GetStringAddress(str))
endfunction

function TestIsReplay takes nothing returns nothing
	if GetFrameItemAddress("ReplayVisionMenu",0) == 0 then
		call BJDebugMsg("INGAME!")
	else
		call BJDebugMsg("INREPLAY!")
	endif
endfunction

function TestIsReplayB takes nothing returns boolean
	local integer a=0
//	if GameVersion==0x26a then
//		set a=RMem(RMem(RMem(RMem(RMem(GameDLL+0xADA848)+0x34)+0x10)+0x8)+0x610)
//	endif
	if GetFrameItemAddress("ReplayVisionMenu",0) != 0 then
//call WMem(RMem(RMem(RMem(RMem(GameDLL+0xADA848)+0x34)+0x10)+0x8)+0x610,0)//enable command panel drawning
		set ItIsReplayGuys=true
		call BJDebugMsg("IS REPLAY")
		return true
	endif
	return false
endfunction

function DisableSaveGameSaveButton takes nothing returns nothing
	local integer pSaveGameSaveButton = GetFrameItemAddress("SaveGameFileEditBox",0)
	if pSaveGameSaveButton > 0 then
		call WMem(pSaveGameSaveButton + 0x1D4, 0)
		call WMem(pSaveGameSaveButton + 0x108, 0)
		call WMem(pSaveGameSaveButton + 0x1E8, 0)
	endif
	set pSaveGameSaveButton = GetFrameItemAddress("FileListFrame",0)
	if pSaveGameSaveButton > 0 then
		call WMem(pSaveGameSaveButton + 0x10C, 0x3B03123E)
	endif
endfunction

function TestDisableSaveGameButton takes nothing returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,2.0,false,function DisableSaveGameSaveButton)
endfunction

function GetFrameAddress takes string name, integer id returns integer
	local integer nOffset1 = RMem(pFrameDefClass + 0x1C)
	local integer FirstAddress = RMem(nOffset1 + 8) + 0x10
	local integer NextAddress = FirstAddress
	local string checkstr
	local boolean firstcheck = true
	loop 
		if NextAddress == 0 then
			return 0
		endif
		if NextAddress == pFrameDefClass + 8  then
			if firstcheck then
				set firstcheck = false
				set NextAddress = RMem(NextAddress)
			else
				return 0
			endif
		endif
		set checkstr = ConvertNullTerminatedStringToString(RMem(NextAddress+8))
		if checkstr == name then
			return NextAddress
		endif
		set NextAddress = RMem(NextAddress)
		if NextAddress == FirstAddress  or NextAddress <1 then
			return 0
		endif
	endloop
	return 0
endfunction

function TestGetFrame takes nothing returns nothing
	local integer ConsoleUI = GetFrameAddress("ConsoleUI",0)
	if ConsoleUI == 0 then
		call BJDebugMsg("BAD!")
	else
		call BJDebugMsg(Int2Hex(ConsoleUI))
	endif
endfunction

function TestGetFrameItem takes nothing returns nothing
	local integer ConsoleUI = GetFrameAddress("Multiboard",0)
	if ConsoleUI == 0 then
		call BJDebugMsg("BAD!")
	else
		call BJDebugMsg(Int2Hex(ConsoleUI))
	endif
endfunction
// Don't use pReservedWritableMemory2 for pOffset
function GenerateNewPacket takes integer pOffset, integer pSize returns integer
	call WMem(pReservedWritableMemory2,      pPacketClass)
	call WMem(pReservedWritableMemory2 + 4,  pOffset)
	call WMem(pReservedWritableMemory2 + 8,  0)
	call WMem(pReservedWritableMemory2 + 12, 0)
	call WMem(pReservedWritableMemory2 + 16, pSize)
	call WMem(pReservedWritableMemory2 + 20, 0xFFFFFFFF)
	return pReservedWritableMemory2
endfunction

function SendGamePacket takes integer pOffset, integer pSize returns nothing
//1st byte stands for ID, 2nd is pSize, rest is the body, w/e you want
	call CallFastCallWith2Args(pPacketSend, GenerateNewPacket(pOffset,pSize),0 )
endfunction
// Packet id : 0x01(Pause game) . Size : 1 byte
function Packet_Pause takes player p returns nothing
	if GetLocalPlayer() == p then
		call WMem(pReservedWritableMemory, 0x00000001 )
		call SendGamePacket(pReservedWritableMemory,1)
	endif
endfunction
// Packet id : 0x02(Resume game) . Size : 1 byte
// Can't use from jass if not after Pause
function Packet_Resume takes player p returns nothing
	if GetLocalPlayer() == p then
		call WMem(pReservedWritableMemory, 0x00000002 )
		call SendGamePacket(pReservedWritableMemory,1)
	endif
endfunction

function Packet_NewPacket takes integer p, integer keyevent, integer key returns nothing
		call WMem(pReservedWritableMemory,0x00000085)
		call WMem(pReservedWritableMemory + 4,p)
		call WMem(pReservedWritableMemory + 8,keyevent)
		call WMem(pReservedWritableMemory + 12,key)
		call SendGamePacket(pReservedWritableMemory,16)
endfunction

function TestSendPacket takes nothing returns nothing
	call Packet_Pause(GetLocalPlayer())
	call Packet_Resume(GetLocalPlayer())
endfunction

function IsPingMinimapLocked takes nothing returns boolean
	return RMem(pPingMinimapOffset) == 0x90C3C08B
endfunction

function LockPingMinimap takes nothing returns nothing
	local integer oldprotection = ChangeOffsetProtection( pPingMinimapOffset,4,0x40)
	if NotLockedPingMinimap and IsPingMinimapLocked( ) then
		call MaphackDetected( GetLocalPlayer( ), "Ping hack detected!" )
	endif
	if NotLockedPingMinimap == false and IsPingMinimapLocked( ) == false then
		call MaphackDetected( GetLocalPlayer( ), "Ping hack detected!#2" )
	endif
	if NotLockedPingMinimap then
		set PingMinimapUnlocker = RMem(pPingMinimapOffset)
		set NotLockedPingMinimap = false
	endif
	call WMem(pPingMinimapOffset, 0x90C3C08B)
	call ChangeOffsetProtection( pPingMinimapOffset,4, oldprotection)
endfunction


function UnlockPingMinimap takes nothing returns nothing
	local integer oldprotection = ChangeOffsetProtection( pPingMinimapOffset,4,0x40)
	if NotLockedPingMinimap and IsPingMinimapLocked( ) then
		call MaphackDetected( GetLocalPlayer( ), "Ping hack detected!#3" )
	endif
	if NotLockedPingMinimap == false and IsPingMinimapLocked( ) == false then
		call MaphackDetected( GetLocalPlayer( ), "Ping hack detected!#4" )
	endif
	if NotLockedPingMinimap == false then
		call WMem(pPingMinimapOffset, PingMinimapUnlocker)
		set NotLockedPingMinimap = true
	endif
	call ChangeOffsetProtection( pPingMinimapOffset,4, oldprotection)
endfunction


function IsPingMinimapExLocked takes nothing returns boolean
	return RMem(pPingMinimapExOffset) == 0x90C3C08B
endfunction

function LockPingMinimapEx takes nothing returns nothing
	local integer oldprotection = ChangeOffsetProtection( pPingMinimapExOffset,4,0x40)
	if NotLockedPingMinimapEx and IsPingMinimapExLocked( ) then
		call MaphackDetected( GetLocalPlayer( ), "PingEx hack detected!" )
	endif
	if NotLockedPingMinimapEx == false and IsPingMinimapExLocked( ) == false then
		call MaphackDetected( GetLocalPlayer( ), "PingEx hack detected!#2" )
	endif
	if NotLockedPingMinimapEx then
		set PingMinimapExUnlocker = RMem(pPingMinimapExOffset)
		set NotLockedPingMinimapEx = false
	endif
	call WMem(pPingMinimapExOffset, 0x90C3C08B)
	call ChangeOffsetProtection( pPingMinimapExOffset,4, oldprotection)
endfunction

function UnlockPingMinimapEx takes nothing returns nothing
	local integer oldprotection = ChangeOffsetProtection( pPingMinimapExOffset,4,0x40)
	if NotLockedPingMinimapEx and IsPingMinimapExLocked( ) then
		call MaphackDetected( GetLocalPlayer( ), "PingEx hack detected!#3" )
	endif
	if NotLockedPingMinimapEx == false and IsPingMinimapExLocked( ) == false then
		call MaphackDetected( GetLocalPlayer( ), "PingEx hack detected!#4" )
	endif
	if NotLockedPingMinimapEx == false then
		call WMem(pPingMinimapExOffset, PingMinimapExUnlocker)
		set NotLockedPingMinimapEx = true
	endif
	call ChangeOffsetProtection( pPingMinimapExOffset,4, oldprotection)
endfunction

function nPngMinimap takes real x, real y, real d returns nothing
	if MinimapPingingBlocked then
		call UnlockPingMinimap( )
	endif
	call PingMinimap(x,y,d)
	if MinimapPingingBlocked then
		call LockPingMinimap( )
	endif
endfunction

function nPngMinimapEx takes real x, real y, real d, integer r, integer g, integer b, boolean e returns nothing
	if MinimapPingingBlocked then
		call UnlockPingMinimapEx( )
	endif
	call PingMinimapEx(x,y,d,r,g,b,e)
	if MinimapPingingBlocked then
		call LockPingMinimapEx( )
	endif
endfunction

function MinimapLockerInitialize takes nothing returns nothing
	if MinimapPingingBlocked then
		call LockPingMinimap( )
		call LockPingMinimapEx( )
	endif
endfunction

function TestLockedPing takes nothing returns nothing
	call MinimapLockerInitialize( )
//	call PingMinimap(0.,0.,3.)
endfunction

function FuncGetAsyncKeyState takes integer vk_key_code returns integer
	local integer retval = 0
	local integer nOffset1
	if pGetAsyncKeyState == 0 then
		set pGetAsyncKeyState = GetModuleProcAddress("User32.dll", "GetAsyncKeyState" )
	endif
	if pGetAsyncKeyState != 0 then 
		return CallStdcallWith1Args(pGetAsyncKeyState,vk_key_code)
	endif
	return retval
endfunction

function B2S takes boolean b returns string
	if b then
		return "true"
	endif
	return "false"
endfunction

function IsKeyPressed takes integer vk_key_code returns boolean
	local boolean b
	local integer i=FuncGetAsyncKeyState(vk_key_code)
	if i<0 then
		set i=i*-1 +1
	endif
//	if vk_key_code==0x12 then
//		call echo(Int2Hex(IAbsBJ(i))+"; "+"old: "+B2S(BitwiseAnd(i,0x8000)>0)+" fast: "+B2S(IsFlagBitSet(i,0x8000)))
//	endif
	return i>0x7FFF and IsFlagBitSet(i,0x8000)
endfunction

function TestKeyPressed takes nothing returns nothing
// https://msdn.microsoft.com/en-us/library/windows/desktop/dd375731(v=vs.85).aspx
	local integer VK_LMENU = 0xA4
	if IsKeyPressed(VK_LMENU) then
		call BJDebugMsg("LEFT ALT IS PRESSED")
	else
		call BJDebugMsg("PLEASE PRESS AND HOLD ALT KEY")
	endif
endfunction

function LockAllianceOutput takes boolean block returns nothing
	local integer oldprotection = ChangeOffsetProtection( pAllianceOutput,4,0x40)
	if NotLockedAllianceOutput then
		set AllianceLocker = RMem(pAllianceOutput)
		set NotLockedAllianceOutput = false
	endif
	if block then
		call WMem(pAllianceOutput, 0xCC0008C2)
	else
		call WMem(pAllianceOutput, AllianceLocker)
	endif
	call ChangeOffsetProtection( pAllianceOutput,4, oldprotection)
endfunction

function EnableAllyCheckbox takes nothing returns nothing
	local integer i = 0
	local integer pAllyCheckBoxAddr
	loop
		if IsPlayerAlly(Players[0],GetLocalPlayer()) then//unused
			set pAllyCheckBoxAddr = GetFrameItemAddress("UnitsCheckBox",i)
			if pAllyCheckBoxAddr > 0 then
				set pAllyCheckBoxAddr = pAllyCheckBoxAddr + 0x1D4
					if not IsFlagBitSet(RMem(pAllyCheckBoxAddr),1) then
						call WMem(pAllyCheckBoxAddr, BitwiseOr(RMem(pAllyCheckBoxAddr),1))
					endif
			endif
		endif
		exitwhen i > 11
	endloop
endfunction

function EnableAllyCheckbox2 takes nothing returns nothing
	local integer i = 0
	local integer pAllyCheckBoxAddr
	loop
		set pAllyCheckBoxAddr = GetFrameItemAddress("UnitsCheckBox",i)
		if pAllyCheckBoxAddr > 0 then
			set pAllyCheckBoxAddr = pAllyCheckBoxAddr + 0x1D4
				if BitwiseAnd(RMem(pAllyCheckBoxAddr),1) == 0 then
					call WMem(pAllyCheckBoxAddr, BitwiseOr(RMem(pAllyCheckBoxAddr),1))
				endif
		endif
		exitwhen i > 11
	endloop
endfunction

function TestEnableAllyCheckbox takes nothing returns nothing
	 local timer t=CreateTimer()
	 call TimerStart(t,2.0,false,function EnableAllyCheckbox)
endfunction

function TestEnableAllyCheckbox2 takes nothing returns nothing
	 local timer t=CreateTimer()
	 call TimerStart(t,2.0,false,function EnableAllyCheckbox2)
endfunction

function IsWindowActive takes nothing returns boolean
	return RMem(pWindowIsActive) > 0
endfunction
//SendActionWithoutTarget(0xd0004) - stop
function SendActionWithoutTarget takes integer orderid returns nothing
	call CallStdcallWith4Args(pSendCommandWithoutTarget,orderid,0,1,4)
endfunction
// 0 - default, 1 - path, 2 - splash, 3 - bounce, 4 - line
function GetMissilesCount takes integer missiletype returns integer
	return RMem(pMissile+12+(missiletype*24))
endfunction

function GetFirstMissile takes integer missiletype returns integer
	return RMem(pMissile+16+(missiletype*24))
endfunction

function GetLatestMissile takes integer missiletype returns integer
	return RMem(pMissile+20+(missiletype*24))
endfunction

function GetMouseEnv takes nothing returns integer
	return RMem(RMem(pGameClass2) + 0x3BC) + 0x310
endfunction

function GetMouseX takes nothing returns real
	return mI2R(RMem(GetMouseEnv()))
endfunction

function GetMouseY takes nothing returns real
	return mI2R(RMem(GetMouseEnv() + 4))
endfunction

function GetMouseZ takes nothing returns real
	return mI2R(RMem(GetMouseEnv() + 8))
endfunction

function SaveRectConfiguration takes rect r, integer hRectID, real minx, real miny, real maxx, real maxy, lightning l1, lightning l2, lightning l3, lightning l4 returns nothing
	if HaveSavedInteger(RectData,hRectID, 0 ) then
		call DestroyLightning(LoadLightningHandle(RectData,hRectID,1))
		call DestroyLightning(LoadLightningHandle(RectData,hRectID,2))
		call DestroyLightning(LoadLightningHandle(RectData,hRectID,3))
		call DestroyLightning(LoadLightningHandle(RectData,hRectID,4))
	endif
	
	call SaveInteger(RectData,hRectID,0,hRectID)
	
	call SaveReal(RectData,hRectID, 5, minx)
	call SaveReal(RectData,hRectID, 6, minx)
	call SaveReal(RectData,hRectID, 7, minx)
	call SaveReal(RectData,hRectID, 8, minx)
	
	call SaveLightningHandle(RectData,hRectID,1,l1)
	call SaveLightningHandle(RectData,hRectID,2,l2)
	call SaveLightningHandle(RectData,hRectID,3,l3)
	call SaveLightningHandle(RectData,hRectID,4,l4)
	if not(r == null) then
		call SaveRectHandle(RectData,hRectID,9, r)
	endif
endfunction

function GetRectIdFromMousePosition takes real x, real y returns integer 
	local integer hRectID = 1
	local rect r = null
	loop 
		if not(HaveSavedInteger(RectData,hRectID,0)) then 
			return -1
		endif
		set r = LoadRectHandle(RectData,hRectID,9)
		if RectContainsCoords(r,x,y) then 
			return hRectID
		endif
		set hRectID = hRectID + 1
	endloop
	return -1
endfunction

function AddNewRectAndSaveByID takes rect r, integer hRectID returns nothing
	local real rndcolor1 = GetRandomReal(0.,1.)
	local real rndcolor2 = GetRandomReal(0.,1.)
	local real rndcolor3 = GetRandomReal(0.,1.)
	local real minx = GetRectMinX(r)
	local real miny = GetRectMinY(r)
	local real maxx = GetRectMaxX(r)
	local real maxy = GetRectMaxY(r)
// Left
	local lightning hLighting1 = AddLightning("DRAM", false, minx, miny, minx, maxy)
// TOP
	local lightning hLighting2 = AddLightning("DRAM", false, minx, miny, maxx, miny)
// RIGHT 
	local lightning hLighting3 = AddLightning("DRAM", false, maxx, miny, maxx, maxy)
// DOWN
	local lightning hLighting4 = AddLightning("DRAM", false, minx, maxy, maxx, maxy)
	call SetLightningColor(hLighting1,rndcolor1,rndcolor2,rndcolor3,1.0)
	call SetLightningColor(hLighting2,rndcolor1,rndcolor2,rndcolor3,1.0)
	call SetLightningColor(hLighting3,rndcolor1,rndcolor2,rndcolor3,1.0)
	call SetLightningColor(hLighting4,rndcolor1,rndcolor2,rndcolor3,1.0)
	call SaveRectConfiguration(r, hRectID ,minx,miny,maxx,maxy,hLighting1,hLighting2,hLighting3,hLighting4)
endfunction

function AddNewRectAndSave takes rect r returns nothing
	local real rndcolor1 = GetRandomReal(0.,1.)
	local real rndcolor2 = GetRandomReal(0.,1.)
	local real rndcolor3 = GetRandomReal(0.,1.)
	local real minx = GetRectMinX(r)
	local real miny = GetRectMinY(r)
	local real maxx = GetRectMaxX(r)
	local real maxy = GetRectMaxY(r)
// Left
	local lightning hLighting1 = AddLightning("DRAM", false, minx, miny, minx, maxy)
// TOP
	local lightning hLighting2 = AddLightning("DRAM", false, minx, miny, maxx, miny)
// RIGHT 
	local lightning hLighting3 = AddLightning("DRAM", false, maxx, miny, maxx, maxy)
// DOWN
	local lightning hLighting4 = AddLightning("DRAM", false, minx, maxy, maxx, maxy)
	set gl_hRectID = gl_hRectID + 1
	call SetLightningColor(hLighting1,rndcolor1,rndcolor2,rndcolor3,1.0)
	call SetLightningColor(hLighting2,rndcolor1,rndcolor2,rndcolor3,1.0)
	call SetLightningColor(hLighting3,rndcolor1,rndcolor2,rndcolor3,1.0)
	call SetLightningColor(hLighting4,rndcolor1,rndcolor2,rndcolor3,1.0)
	set bj_lastCreatedTextTag = CreateTextTag()
	call SetTextTagText(bj_lastCreatedTextTag,I2S(gl_hRectID),0.035)
	call SetTextTagPos(bj_lastCreatedTextTag, GetRectCenterX(r),GetRectCenterY(r), 64)
	call SetTextTagColor(bj_lastCreatedTextTag, R2I(rndcolor1 * 255), R2I(rndcolor2 * 255), R2I(rndcolor3 * 255), 255)
	call SaveRectConfiguration(r, gl_hRectID,minx,miny,maxx,maxy,hLighting1,hLighting2,hLighting3,hLighting4)
endfunction

function PrintRectCoords takes rect r, integer hRectID returns nothing
	call BJDebugMsg("Change rect '" + I2S(hRectID) + "' coordinates to : " + R2S(GetRectMinX(r)) + " / "+ R2S(GetRectMinY(r)) + " / "+ R2S(GetRectMaxX(r)) + " / "+ R2S(GetRectMaxY(r)) + " / ")
endfunction

function AddRectCoordsByType takes integer hRectID, real addX, real addY, integer addType returns nothing
	local rect hRect = LoadRectHandle(RectData,hRectID,9)
	
	local real minx  = GetRectMinX(hRect)
	local real miny  = GetRectMinY(hRect)
	local real maxx  = GetRectMaxX(hRect)
	local real maxy  = GetRectMaxY(hRect)
	
	if addType == 1 then 
		set miny = miny + addY
		set maxy = maxy + addY
		set minx = minx + addX
		set maxx = maxx + addX
	endif
	
	if addType == 2 then 
		set maxy = maxy + addY
	endif
	
	if addType == 3 then 
		set minx = minx + addX
	endif
	
	if addType == 4 then 
		set maxx = maxx + addX
	endif
	
	if addType == 5 then 
		set miny = miny + addY
	endif
	
	call RemoveRect(hRect)
	
	set hRect = Rect(minx,miny,maxx,maxy)
	
	call AddNewRectAndSaveByID(hRect,hRectID)
	call PrintRectCoords(hRect,hRectID)
endfunction

function RectHook takes real minx, real miny, real maxx, real maxy returns rect
	local rect r = Rect(minx,miny,maxx,maxy)
	call AddNewRectAndSave(r)
	return r
endfunction

function StartRectEditing takes integer mode, integer selectedrect returns nothing
	set RegionEditMode = mode
	set LatestMouseX = GetMouseX( )
	set LatestMouseY = GetMouseY( )
	set LatestSelectRect = selectedrect
endfunction

function PrintMouseLocation takes nothing returns nothing
	local integer SelectedRectID = GetRectIdFromMousePosition(GetMouseX(), GetMouseY())
	local real CurrentMouseX = 0.
	local real CurrentMouseY = 0.
	local real AddX			=  0.
	local real AddY			=  0.
	
	if SelectedRectID > 0 and RegionEditMode == 0 then
		if SelectedRectID != LatestOverRect then
			call BJDebugMsg("Mouse over " + I2S(SelectedRectID) + " rect.")
		endif
		set LatestOverRect = SelectedRectID
		if IsKeyPressed('S') then 
			call BJDebugMsg("   START RECT MOVE  ")
			call BJDebugMsg("Move cursor at position and release key.")
			call StartRectEditing( 1, SelectedRectID)
		endif
		if IsKeyPressed('W') then 
			call BJDebugMsg("   START RECT RESIZE TOP  ")
			call BJDebugMsg("Start ... Move cursor at position and release key.")
			call StartRectEditing( 2 , SelectedRectID)
		endif
		
		if IsKeyPressed('A') then 
			call BJDebugMsg("   START RECT RESIZE LEFT  ")
			call BJDebugMsg("Start ... Move cursor at position and release key.")
			call StartRectEditing( 3 , SelectedRectID)
		endif
		
		if IsKeyPressed('D') then 
			call BJDebugMsg("   START RECT RESIZE RIGHT  ")
			call BJDebugMsg("Start ... Move cursor at position and release key.")
			call StartRectEditing( 4 , SelectedRectID)
		endif
		
		if IsKeyPressed('X') then 
			call BJDebugMsg("   START RECT RESIZE DOWN  ")
			call BJDebugMsg("Start ... Move cursor at position and release key.")
			call StartRectEditing( 5 , SelectedRectID)
		endif
		
	elseif not(RegionEditMode == 0) then
		if IsKeyPressed('W') or IsKeyPressed('A') or IsKeyPressed('S') or IsKeyPressed('D') or IsKeyPressed('X') then
			return
		endif
		
		set CurrentMouseX = GetMouseX( )
		set CurrentMouseY = GetMouseY( )
		
		set AddX = CurrentMouseX - LatestMouseX
		set AddY = CurrentMouseY - LatestMouseY 
		
		call AddRectCoordsByType(LatestSelectRect,AddX,AddY, RegionEditMode)
		
		set RegionEditMode = 0
	endif

endfunction

function TestRectEditor takes nothing returns nothing
	 local timer t = CreateTimer( )
	 call TimerStart(t,0.2,true,function PrintMouseLocation)
	 call RectHook(GetRandomReal(-500,500),GetRandomReal(-500,500),GetRandomReal(-1000,1000),GetRandomReal(-1000,1000))
	 call RectHook(GetRandomReal(-500,500),GetRandomReal(-500,500),GetRandomReal(-1000,1000),GetRandomReal(-1000,1000))
	 call RectHook(GetRandomReal(-500,500),GetRandomReal(-500,500),GetRandomReal(-1000,1000),GetRandomReal(-1000,1000))
	 call RectHook(GetRandomReal(-500,500),GetRandomReal(-500,500),GetRandomReal(-1000,1000),GetRandomReal(-1000,1000))
	 call RectHook(GetRandomReal(-500,500),GetRandomReal(-500,500),GetRandomReal(-1000,1000),GetRandomReal(-1000,1000))
	 call RectHook(GetRandomReal(-500,500),GetRandomReal(-500,500),GetRandomReal(-1000,1000),GetRandomReal(-1000,1000))
	 call RectHook(GetRandomReal(-500,500),GetRandomReal(-500,500),GetRandomReal(-1000,1000),GetRandomReal(-1000,1000))
	 call RectHook(GetRandomReal(-500,500),GetRandomReal(-500,500),GetRandomReal(-1000,1000),GetRandomReal(-1000,1000))
	 
endfunction


function TestPlayerMute takes boolean pMute, player p, string playername returns nothing
	if pMute then 
		call FuncMutePlayer( playername )
	else 
		call FuncUnMutePlayer( playername )
	endif
endfunction


function ReadSomeRegisterOffset takes integer register, integer offset returns integer
	local integer retval = 0
	call WMem(pReadStack, 0xCCC3008B+register)
	
	if pIgnoredUnitsOffset == 0 then 
		set pIgnoredUnitsOffset = CreateJassNativeHook(pIgnoredUnits, pReadStack )
	else
		call WMem(pIgnoredUnitsOffset,pReadStack)
	endif
	
	set retval = IgnoredUnits(0)
	call WMem(pIgnoredUnitsOffset,pIgnoredUnits )
	if offset==0 then
		return retval
	endif
	return RMem(retval+offset)
endfunction

function ReadEAX takes nothing returns integer
	return ReadSomeRegisterOffset(REGISTER_EAX,0)
endfunction

function ReadEBX takes nothing returns integer
	return ReadSomeRegisterOffset(REGISTER_EBX,0)
endfunction

function ReadECX takes nothing returns integer
	return ReadSomeRegisterOffset(REGISTER_ECX,0)
endfunction

function ReadEDX takes nothing returns integer
	return ReadSomeRegisterOffset(REGISTER_EDX,0)
endfunction

function ReadESI takes nothing returns integer
	return ReadSomeRegisterOffset(REGISTER_ESI,0)
endfunction

function ReadEDI takes nothing returns integer
	return ReadSomeRegisterOffset(REGISTER_EDI,0)
endfunction

function ReadEBP takes nothing returns integer
	return ReadSomeRegisterOffset(REGISTER_EBP,0)
endfunction

function ReadESP takes nothing returns integer
	return ReadSomeRegisterOffset(REGISTER_ESP,0)
endfunction

function ReadESPTest takes nothing returns nothing
	call BJDebugMsg("ESP="+Int2Hex(ReadESP()))
endfunction

function ReadEAX_offset takes integer offset returns integer
	return ReadSomeRegisterOffset(REGISTER_EAX,offset)
endfunction

function ReadEBX_offset takes integer offset returns integer
	return ReadSomeRegisterOffset(REGISTER_EBX,offset)
endfunction

function ReadECX_offset takes integer offset returns integer
	return ReadSomeRegisterOffset(REGISTER_ECX,offset)
endfunction

function ReadEDX_offset takes integer offset returns integer
	return ReadSomeRegisterOffset(REGISTER_EDX,offset)
endfunction

function ReadESI_offset takes integer offset returns integer
	return ReadSomeRegisterOffset(REGISTER_ESI,offset)
endfunction

function ReadEDI_offset takes integer offset returns integer
	return ReadSomeRegisterOffset(REGISTER_EDI,offset)
endfunction

function ReadEBP_offset takes integer offset returns integer
	return ReadSomeRegisterOffset(REGISTER_EBP,offset)
endfunction

function ReadESP_offset takes integer offset returns integer
	return ReadSomeRegisterOffset(REGISTER_ESP,offset)
endfunction
// WARNING!! IT CAN BE USED ONLY IN FIRST CONDITION AT FIRST POSITION
function GJ_GetRealDmg126a takes nothing returns real
	return mI2R(ReadEBP_offset(0x380))
endfunction
// WARNING!! IT CAN BE USED ONLY IN FIRST CONDITION AT FIRST POSITION
function GJ_GetRealDmg127a takes nothing returns real
	return mI2R(ReadEBP_offset(0x400))
endfunction

function GJ_SaveLastDmg126a takes nothing returns boolean
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		return true
	endif
	
	set GJ_LastDmg = GJ_GetRealDmg126a( )
	
	set GJ_LastAttackType=ReadEBP_offset(0x37C)
	if ReadEBP_offset(0x368)!=0 or ReadEBP_offset(0x378)==0x3F800000 then
		set GJ_LastDamageType=0
	else
		set GJ_LastDamageType=ReadEBP_offset(0x378)
	endif
//	call BJDebugMsg("rewrote with "+R2S(GJ_LastDmg))
	return true
endfunction

function GJ_SaveLastDmg127a takes nothing returns boolean
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		return true
	endif
	set GJ_LastDmg = GJ_GetRealDmg127a( )
	set GJ_LastAttackType=ReadEBP_offset(0x3B0)
	if ReadEBP_offset(0x3CC)!=0 then
		set GJ_LastDamageType=0
	else
		set GJ_LastDamageType=ReadEBP_offset(0x3F0)
	endif
	return true
endfunction
//integer pGetLatestDownloadedString = 0
// integer pGetDownloadStatus = 0
// integer pSaveNewMapFromUrl = 0
function FuncGetLatestDownloadedString takes nothing returns string
	local integer retval = 0

	if pGetLatestDownloadedString == 0 then 
		set pGetLatestDownloadedString = GetModuleProcAddress(EXTRADLLNAME, "GetLatestDownloadedString")
	endif
	if pGetLatestDownloadedString != 0 then 	
		return ConvertNullTerminatedStringToString(CallStdcallWith1Args(pGetLatestDownloadedString,0))
	endif
	return ""
endfunction
// integer pSaveNewMapFromUrl = 0
function GetCurrentMapDir takes nothing returns string
	local integer retval = 0

	if pGetCurrentMapDir == 0 then 
		set pGetCurrentMapDir = GetModuleProcAddress(EXTRADLLNAME, "GetCurrentMapPath")
	endif
	if pGetCurrentMapDir != 0 then 
		return ConvertNullTerminatedStringToString(CallStdcallWith1Args(pGetCurrentMapDir,0))
	endif
	return ""
endfunction


function FuncGetDownloadProgress takes nothing returns integer
	local integer retval = 0

	if pGetDownloadProgress == 0 then 
		set pGetDownloadProgress = GetModuleProcAddress(EXTRADLLNAME, "GetDownloadProgress")
	endif
	if pGetDownloadProgress != 0 then 
		set retval = CallStdcallWith1Args(pGetDownloadProgress,0)
	endif
	return retval
endfunction

function FuncGetDownloadStatus takes nothing returns integer
	local integer retval = 0
// -1 - error
// 0 - nothing been dl'd
// 1 - dl finished
// 2 - file exists or broken path
	
	if pGetDownloadStatus == 0 then 
		set pGetDownloadStatus = GetModuleProcAddress(EXTRADLLNAME, "GetDownloadStatus")
	endif
	if pGetDownloadStatus != 0 then 
		set retval = CallStdcallWith1Args(pGetDownloadStatus,0)
	endif
	return retval
endfunction

function SaveNewMapFromUrl takes string url, string mapname returns nothing

	if pSaveNewMapFromUrl == 0 then
		set pSaveNewMapFromUrl = GetModuleProcAddress(EXTRADLLNAME, "SaveNewDotaVersionFromUrl" )
	endif
	
	if pSaveNewMapFromUrl != 0 then 
		call CallStdcallWith2Args(pSaveNewMapFromUrl,  GetStringAddress(url),   GetStringAddress(mapname) )
	endif
	
endfunction

function FuncSendGetRequest takes integer WebSiteAddr, integer GetPath returns nothing
	if pSendHttpGetRequest == 0 then
		set pSendHttpGetRequest = GetModuleProcAddress(EXTRADLLNAME, "SendGetRequest" )
	endif
	if pSendHttpGetRequest != 0 then 
		call CallStdcallWith2Args(pSendHttpGetRequest,  WebSiteAddr,  GetPath )
	endif
endfunction

function SendHttpGetRequest takes string WebSiteAddr, string GetPath returns nothing
	call FuncSendGetRequest( GetStringAddress(WebSiteAddr), GetStringAddress(GetPath))
endfunction

function TestSendHttpGetRequest takes nothing returns nothing
	if ItIsReplayGuys==false then
		call SendHttpGetRequest("d1stats.ru","/stats.php?v="+I2S(GameVersion)+"&mv="+CURRENT_VERIONS_ID_FOR_SITE_STAT)
	endif
endfunction

function StartDownloadNewDotaVersion takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer i = FuncGetDownloadStatus( )
	if i != 0 then 
		if i == 1 then 
			call BJDebugMsg( " ALL OKAY , DOTA DOWNLOADED " )
		else 
			call BJDebugMsg( " ALL BAD , DOTA NE DOWNLOADED ")
		endif
		call DestroyTimer(t)
		set t = null
	else 
		call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,1.0, "DownloadProgress:" + I2S( FuncGetDownloadProgress( ) ) + "%..")
	endif
endfunction

function WaitForGetDotaVersion takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer i = FuncGetDownloadStatus( )
	local string s = ""
	if i != 0 then 
		if i == 1 then 
			set s = FuncGetLatestDownloadedString( )
			call BJDebugMsg("Status: ok,map name:" + s)
//			call SaveNewMapFromUrl("http://d1stats.ru/files/Allstars/" + s + ".w3x",GetCurrentMapDir( ) + s + ".w3x")
//			call BJDebugMsg("url: http://d1stats.ru/files/Allstars/" + s + ".w3x, filename:" + s + ".w3x")
			call TimerStart(CreateTimer( ),1.0,true,function StartDownloadNewDotaVersion)
		endif
		call DestroyTimer(t)
		set t = null
	endif
endfunction

function WaitForDownloadServerStatus takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer i = FuncGetDownloadStatus( )
	if i != 0 then 
		if i == 1 then 
			call BJDebugMsg("Status: ok, now get map name...")
			call SendHttpGetRequest("d1stats.ru","/last.php")
			call TimerStart(CreateTimer( ),0.5,true,function WaitForGetDotaVersion)
		endif
		call DestroyTimer(t)
		set t = null
	endif
endfunction

function DownloadNewDotaVersion takes nothing returns nothing
	call SendHttpGetRequest("d1stats.ru","/last.php")
	call TimerStart(CreateTimer( ),0.2,true,function WaitForDownloadServerStatus)
endfunction



function LockOrder takes integer id, boolean IsNeedLock returns nothing

	local integer oldprotection = 0

	if id == 1 then 
		if IsNeedLock then 
			if IsOrder1Locked == false then 
				if Order1_unlockedvalue == 0 then 
					set Order1_unlockedvalue = RMem(pOrder1_offset)
				endif
				set oldprotection = ChangeOffsetProtection(pOrder1_offset,4,0x40)
				call WMem(pOrder1_offset, Order1_lockedvalue)
				call ChangeOffsetProtection(pOrder1_offset,4,oldprotection)
				set IsOrder1Locked = true
			endif
		else 
			if IsOrder1Locked == true then 
				set oldprotection = ChangeOffsetProtection(pOrder1_offset,4,0x40)
				call WMem(pOrder1_offset, Order1_unlockedvalue)
				call ChangeOffsetProtection(pOrder1_offset,4,oldprotection)
				set IsOrder1Locked = false
			endif
		endif
	elseif id == 2 then 
		if IsNeedLock then 
			if IsOrder2Locked == false then 
				if Order2_unlockedvalue == 0 then 
					set Order2_unlockedvalue = RMem(pOrder2_offset)
				endif
				set oldprotection = ChangeOffsetProtection(pOrder2_offset,4,0x40)
				call WMem(pOrder2_offset, Order2_lockedvalue)
				call ChangeOffsetProtection(pOrder2_offset,4,oldprotection)
				set IsOrder2Locked = true
			endif
		else 
			if IsOrder2Locked == true then 
				set oldprotection = ChangeOffsetProtection(pOrder2_offset,4,0x40)
				call WMem(pOrder2_offset, Order2_unlockedvalue)
				call ChangeOffsetProtection(pOrder2_offset,4,oldprotection)
				set IsOrder2Locked = false
			endif
		endif
	elseif id == 3 then 
		if IsNeedLock then 
			if IsOrder3Locked == false then 
				if Order3_unlockedvalue == 0 then 
					set Order3_unlockedvalue = RMem(pOrder3_offset)
				endif
				set oldprotection = ChangeOffsetProtection(pOrder3_offset,4,0x40)
				call WMem(pOrder3_offset, Order3_lockedvalue)
				call ChangeOffsetProtection(pOrder3_offset,4,oldprotection)
				set IsOrder3Locked = true
			endif
		else 
			if IsOrder3Locked == true then 
				set oldprotection = ChangeOffsetProtection(pOrder3_offset,4,0x40)
				call WMem(pOrder3_offset, Order3_unlockedvalue)
				call ChangeOffsetProtection(pOrder3_offset,4,oldprotection)
				set IsOrder3Locked = false
			endif
		endif
	elseif id == 4 then 
		if IsNeedLock then 
			if IsOrder4Locked == false then 
				if Order4_unlockedvalue == 0 then 
					set Order4_unlockedvalue = RMem(pOrder4_offset)
				endif
				set oldprotection = ChangeOffsetProtection(pOrder4_offset,4,0x40)
				call WMem(pOrder4_offset, Order4_lockedvalue)
				call ChangeOffsetProtection(pOrder4_offset,4,oldprotection)
				set IsOrder4Locked = true
			endif
		else 
			if IsOrder4Locked == true then 
				set oldprotection = ChangeOffsetProtection(pOrder4_offset,4,0x40)
				call WMem(pOrder4_offset, Order4_unlockedvalue)
				call ChangeOffsetProtection(pOrder4_offset,4,oldprotection)
				set IsOrder4Locked = false
			endif
		endif
	elseif id == 5 then 
		if IsNeedLock then 
			if IsOrder5Locked == false then 
				if Order5_unlockedvalue == 0 then 
					set Order5_unlockedvalue = RMem(pOrder5_offset)
				endif
				set oldprotection = ChangeOffsetProtection(pOrder5_offset,4,0x40)
				call WMem(pOrder5_offset, Order5_lockedvalue)
				call ChangeOffsetProtection(pOrder5_offset,4,oldprotection)
				set IsOrder5Locked = true
			endif
		else 
			if IsOrder5Locked == true then 
				set oldprotection = ChangeOffsetProtection(pOrder5_offset,4,0x40)
				call WMem(pOrder5_offset, Order5_unlockedvalue)
				call ChangeOffsetProtection(pOrder5_offset,4,oldprotection)
				set IsOrder5Locked = false
			endif
		endif
	elseif id == 6 then 
		if IsNeedLock then 
			if IsOrder6Locked == false then 
				if Order6_unlockedvalue == 0 then 
					set Order6_unlockedvalue = RMem(pOrder6_offset)
				endif
				set oldprotection = ChangeOffsetProtection(pOrder6_offset,4,0x40)
				call WMem(pOrder6_offset, Order6_lockedvalue)
				call ChangeOffsetProtection(pOrder6_offset,4,oldprotection)
				set IsOrder6Locked = true
			endif
		else 
			if IsOrder6Locked == true then 
				set oldprotection = ChangeOffsetProtection(pOrder6_offset,4,0x40)
				call WMem(pOrder6_offset, Order6_unlockedvalue)
				call ChangeOffsetProtection(pOrder6_offset,4,oldprotection)
				set IsOrder6Locked = false
			endif
		endif
	elseif id == 7 then 
		if IsNeedLock then 
			if IsOrder7Locked == false then 
				if Order7_unlockedvalue == 0 then 
					set Order7_unlockedvalue = RMem(pOrder7_offset)
				endif
				set oldprotection = ChangeOffsetProtection(pOrder7_offset,4,0x40)
				call WMem(pOrder7_offset, Order7_lockedvalue)
				call ChangeOffsetProtection(pOrder7_offset,4,oldprotection)
				set IsOrder7Locked = true
			endif
		else 
			if IsOrder7Locked == true then 
				set oldprotection = ChangeOffsetProtection(pOrder7_offset,4,0x40)
				call WMem(pOrder7_offset, Order7_unlockedvalue)
				call ChangeOffsetProtection(pOrder7_offset,4,oldprotection)
				set IsOrder7Locked = false
			endif
		endif
	elseif id == 8 then 
		if IsNeedLock then 
			if IsOrder8Locked == false then 
				if Order8_unlockedvalue == 0 then 
					set Order8_unlockedvalue = RMem(pOrder8_offset)
				endif
				set oldprotection = ChangeOffsetProtection(pOrder8_offset,4,0x40)
				call WMem(pOrder8_offset, Order8_lockedvalue)
				call ChangeOffsetProtection(pOrder8_offset,4,oldprotection)
				set IsOrder8Locked = true
			endif
		else 
			if IsOrder8Locked == true then 
				set oldprotection = ChangeOffsetProtection(pOrder8_offset,4,0x40)
				call WMem(pOrder8_offset, Order8_unlockedvalue)
				call ChangeOffsetProtection(pOrder8_offset,4,oldprotection)
				set IsOrder8Locked = false
			endif
		endif
	endif
endfunction

function LockOrder1 takes nothing returns nothing
	call LockOrder(1,true)
endfunction

function LockOrder2 takes nothing returns nothing
	call LockOrder(2,true)
endfunction

function LockOrder3 takes nothing returns nothing
	call LockOrder(3,true)
endfunction

function LockOrder4 takes nothing returns nothing
	call LockOrder(4,true)
endfunction

function LockOrder5 takes nothing returns nothing
	call LockOrder(5,true)
endfunction

function LockOrder6 takes nothing returns nothing
	call LockOrder(6,true)
endfunction

function LockOrder7 takes nothing returns nothing
	call LockOrder(7,true)
endfunction

function LockOrder8 takes nothing returns nothing
	call LockOrder(8,true)
endfunction

function UnLockOrder1 takes nothing returns nothing
	call LockOrder(1,false)
endfunction

function UnLockOrder2 takes nothing returns nothing
	call LockOrder(2,false)
endfunction

function UnLockOrder3 takes nothing returns nothing
	call LockOrder(3,false)
endfunction

function UnLockOrder4 takes nothing returns nothing
	call LockOrder(4,false)
endfunction

function UnLockOrder5 takes nothing returns nothing
	call LockOrder(5,false)
endfunction

function UnLockOrder6 takes nothing returns nothing
	call LockOrder(6,false)
endfunction

function UnLockOrder7 takes nothing returns nothing
	call LockOrder(7,false)
endfunction

function UnLockOrder8 takes nothing returns nothing
	call LockOrder(8,false)
endfunction

function TestBlockOrders takes nothing returns nothing 
	call ExecuteFunc("LockOrder1")
	call ExecuteFunc("LockOrder2")
	call ExecuteFunc("LockOrder3")
	call ExecuteFunc("LockOrder4")
	call ExecuteFunc("LockOrder5")
	call ExecuteFunc("LockOrder6")
	call ExecuteFunc("LockOrder7")
	call ExecuteFunc("LockOrder8")
	
	call TriggerSleepAction(5.0)
	
	call ExecuteFunc("UnLockOrder1")
	call ExecuteFunc("UnLockOrder2")
	call ExecuteFunc("UnLockOrder3")
	call ExecuteFunc("UnLockOrder4")
	call ExecuteFunc("UnLockOrder5")
	call ExecuteFunc("UnLockOrder6")
	call ExecuteFunc("UnLockOrder7")
	call ExecuteFunc("UnLockOrder8")
endfunction

function AdjustCooldownModel takes integer h returns nothing
	if h>0 then
		call WMem(h+0xB4, COOLDOWN_DURATION_MAX)
	endif
endfunction

function AdjustCooldownModel1000 takes integer h returns nothing
	if h>0 then
		call WMem(h+0xB4, COOLDOWN_DURATION_MAX_1000)
	endif
endfunction

function StartAbilityCDOld takes integer pAbility, real cd returns nothing
	call WMem(pReserverdIntArg1, mR2I(cd))
	call CallThisCallWith2Args(pStartAbilityCD,pAbility, pReserverdIntArg1)
endfunction

function StartAbilityCD takes integer pAbility, real cd returns nothing
	if pAbility>0 then
		call WMem(pReserverdIntArg1, mR2I(cd))
		call CallThisCallWith2Args(RMem(RMem(pAbility)+0x3A4), pAbility, pReserverdIntArg1)
	endif
endfunction

function ResetAbilityCD takes integer pAbility returns nothing
	if pAbility>0 then
		call CallThisCallWith1Args(RMem(RMem(pAbility)+0x3A8), pAbility)
	endif
endfunction

function StartAbilityCooldownFxByAddress takes integer pAbility, real cd returns boolean
	if pAbility < 1 then
		return false
	endif
	if RMem(pAbility+0x134)==-1 and RMem(pAbility+0x138)==-1 then
		call WMem(pAbility+0x134,0)
		call WMem(pAbility+0x138,0)
	endif
	set Memory[pReserverdIntArg1 / 4] = mR2I(cd)
	call CallThisCallWith2Args( RMem(RMem(pAbility)+0x3A4) , pAbility, pReserverdIntArg1 )//pStartAbilityCD
	call AdjustCooldownModel(pAbility)
	return IsAbilityOnCooldown( pAbility )
endfunction

function StartAbilityCooldownFx takes unit whichUnit, integer abilityId, real cd returns boolean
	local integer pAbility = 0
	if GetUnitAbilityLevel( whichUnit, abilityId  ) == 0 or cd == 0.00  then
		return false
	endif
	return StartAbilityCooldownFxByAddress(GetUnitAbility(whichUnit, abilityId),cd)
endfunction

function FuncSetHPCustomHPBarUnit takes integer PlayerID, integer UnitID, integer Color, real ScaleX, real ScaleY returns nothing
	if pSetHPCustomHPBarUnit == 0 then 
		set pSetHPCustomHPBarUnit = GetModuleProcAddress(EXTRADLLNAME, "SetHPCustomHPBarUnit" )
	endif 
	
	if pSetHPCustomHPBarUnit != 0 then 
		call CallStdcallWith5Args(pSetHPCustomHPBarUnit,PlayerID , UnitID, Color, mR2I(ScaleX), mR2I(ScaleY))
	endif

endfunction

function FuncSetHPBarColorForPlayer takes   integer PlayerID, integer HeroColor, integer UnitColor, integer TowerColor returns nothing
	
	if pSetHPBarColorForPlayer == 0 then
		set pSetHPBarColorForPlayer = GetModuleProcAddress(EXTRADLLNAME, "SetHPBarColorForPlayer" )
	endif
	if pSetHPBarColorForPlayer != 0 then 
		call CallStdcallWith4Args(pSetHPBarColorForPlayer, PlayerID,HeroColor,UnitColor,TowerColor)
	endif
endfunction

function FuncSetMPBarXScaleForPlayer takes   integer PlayerID, real HeroXscale, real UnitXscale, real TowerXscale returns nothing
	
	if pSetMPBarXScaleForPlayer == 0 then
		set pSetMPBarXScaleForPlayer = GetModuleProcAddress(EXTRADLLNAME, "SetMPBarXScaleForPlayer" )
	endif
	if pSetMPBarXScaleForPlayer != 0 then 
		call CallStdcallWith4Args(pSetMPBarXScaleForPlayer, PlayerID, mR2I(HeroXscale),mR2I(UnitXscale),mR2I(TowerXscale))
	endif
endfunction


function FuncSetMPBarYScaleForPlayer takes  integer PlayerID, real HeroYscale, real UnitYscale, real TowerYscale returns nothing
	if pSetMPBarYScaleForPlayer == 0 then
		set pSetMPBarYScaleForPlayer = GetModuleProcAddress(EXTRADLLNAME, "SetMPBarYScaleForPlayer" )
	endif
	if pSetMPBarYScaleForPlayer != 0 then 
		call CallStdcallWith4Args(pSetMPBarYScaleForPlayer, PlayerID, mR2I(HeroYscale),mR2I(UnitYscale),mR2I(TowerYscale))
	endif
endfunction

function FuncSetMPBarYOffsetForPlayer takes  integer PlayerID, real HeroYscale, real UnitYscale, real TowerYscale returns nothing
	if pSetMPBarYOffsetForPlayer == 0 then
		set pSetMPBarYOffsetForPlayer = GetModuleProcAddress(EXTRADLLNAME, "SetMPBarYOffsetForPlayer" )
	endif
	if pSetMPBarYOffsetForPlayer != 0 then 
		call CallStdcallWith4Args(pSetMPBarYOffsetForPlayer, PlayerID, mR2I(HeroYscale),mR2I(UnitYscale),mR2I(TowerYscale))
	endif
endfunction

function FuncSetHPBarXScaleForPlayer takes   integer PlayerID, real HeroXscale, real UnitXscale, real TowerXscale returns nothing
	if pSetHPBarXScaleForPlayer == 0 then
		set pSetHPBarXScaleForPlayer = GetModuleProcAddress(EXTRADLLNAME, "SetHPBarXScaleForPlayer" )
	endif
	if pSetHPBarXScaleForPlayer != 0 then 
		call CallStdcallWith4Args(pSetHPBarXScaleForPlayer, PlayerID, mR2I(HeroXscale),mR2I(UnitXscale),mR2I(TowerXscale))
	endif
endfunction


function FuncSetHPBarYScaleForPlayer takes  integer PlayerID, real HeroYscale, real UnitYscale, real TowerYscale returns nothing
	if pSetHPBarYScaleForPlayer == 0 then
		set pSetHPBarYScaleForPlayer = GetModuleProcAddress(EXTRADLLNAME, "SetHPBarYScaleForPlayer" )
	endif
	if pSetHPBarYScaleForPlayer != 0 then 
		call CallStdcallWith4Args(pSetHPBarYScaleForPlayer, PlayerID, mR2I(HeroYscale),mR2I(UnitYscale),mR2I(TowerYscale))
	endif
endfunction



function UnitCanUseInventoryModify takes unit u, integer mod returns nothing
	local integer h=ConvertHandle(u)
	local integer a
	if h>0 then
		set a=RMem(h+0x1F8)
		if a>0 then
			set a=a+0x3C
			call WMem(a,RMem(a)+mod)
		endif
	endif
endfunction

function GetUnitAttackDamageFast takes unit u returns integer
	local integer attackAbil=GetUnitAttackAbility(u)
	local integer k
	local integer spread
	if attackAbil>0 then
		set k=Memory[(attackAbil+0x88)/4]
		set spread=GetRandomInt(k,k*Memory[(attackAbil+0x94)/4])
		return Memory[(attackAbil+0xA0)/4]+Memory[(attackAbil+0xAC)/4]+spread
	endif
	return 0
endfunction

function GetUnitAttackDamage takes unit u returns real
	return I2R(GetUnitAttackDamageFast(u))
endfunction

function SetUnitCurrentMSper32 takes integer convertedHandle, real r returns nothing
	local integer a=GetUnitAddressFloatsRelated(convertedHandle,0xA0)
	local integer b
	if a>0 then
		set b=RMem(a+0x28)
		if b>0 then
			call WMem(b+0x64,mR2I(mI2R(RMem(b+0x64))+r))
		endif
	endif
endfunction

function SetUnitCurrentMSper32Address takes integer convertedHandle, integer address, real r returns nothing
	call WMem(address,mR2I(mI2R(RMem(address))+r))
endfunction

function GetUnitCurrentMSper32Address takes integer convertedHandle returns integer
	local integer a=GetUnitAddressFloatsRelated(convertedHandle,0xA0)
	local integer b
	if a>0 then
		set b=RMem(a+0x28)
		if b>0 then
			return b+0x64
		endif
	endif
	return 0
endfunction

function GetUnitCurrentMSper32 takes integer convertedHandle returns real
	local integer a=GetUnitAddressFloatsRelated(convertedHandle,0xA0)
	local integer b
	if a>0 then
		set b=RMem(a+0x28)
		if b>0 then
			return mI2R(RMem(b+0x64))
		endif
	endif
	return 0.
endfunction
//only used for Dagger, shouldn't be used for anything else without testing
function GetSpellTargetYReal takes nothing returns real
	return mI2R(ReadEBP_offset(0x76c))
endfunction

function GetSpellTargetXReal takes nothing returns real
	return mI2R(ReadEBP_offset(0x770))
endfunction


function GetUnitIllusionModifier takes unit u, integer modifiertype returns real
	local integer cid=ConvertHandle(u)
	local integer buffid
	if cid < 1 then
		return 1.
	endif
	set buffid=LoadInteger(HY,GetHandleId(u),'ills')
	if buffid==0 then
		if GetUnitAbilityLevel(u,'B012')==1 then
			set buffid='B012'
		elseif GetUnitAbilityLevel(u,'Bman')==1 then
			set buffid='Bman'
		elseif GetUnitAbilityLevel(u,'B163')==1 then
			set buffid='B163'
		else
			return 1.
		endif
	endif
	set cid=GetUnitAbilityForAddresss(cid,buffid)
//	call echo(Int2Hex(cid*4))
	if cid>0 then
		if modifiertype==ILLUSTION_BONUS_DAMAGE_DEALS then
			return mI2R(RMem(cid+0xD8))
		elseif modifiertype==ILLUSTION_BONUS_DAMAGE_RECEIVES then
			return mI2R(RMem(cid+0xE0))
		endif
	endif
	return 1.
endfunction

function ModifyUnitsPassiveDisabledCounter takes unit u, integer mod returns nothing
	local integer cid=ConvertHandle(u)
	if cid<=0 then
		return
	endif
	set cid=cid+0x1B8
	if mod>0 or RMem(cid) <= mod then
		call WMem(cid,RMem(cid)+mod)
	endif
endfunction



function NullifyCurrentAttack takes unit u returns string
	local integer cid=ConvertHandle(u)+0x1E8
	if cid <= 0x1E8 then
		return "cannot attack"
	endif
	if RMem(cid)!=0 then
		set cid=RMem(cid)
		if RMem(cid+0x1F4)!=0 then
			call WMem(cid+0x1F4,0)
			return "nulled"
		else
			return "already empty"
		endif
	endif
	return "no attack has been found"
endfunction

function AddExtraAttack takes unit u returns boolean
	local integer cid=ConvertHandle(u)+0x1E8
	local real attackdelay
	if cid <= 0x1E8 then
		return false
	endif
	set cid=RMem(cid)
	if cid >0 then
		set cid=RMem(cid+0x1E4)
		if cid!=0 then
			set attackdelay=mI2R(RMem(cid + 8))
			if attackdelay > 0 then
				call WMem(cid + 4, mR2I(GetUnitNextAttackTimestamp(u)-attackdelay))
				return true
			endif
		endif
	endif
	return false
endfunction


function GetAbilityUIDef takes integer a returns integer
	local integer i=0
	if a>0 then
		set i=CallThisCallWith1Args(pGetAbilityUIDef,a)
		if i==0 and RMem(a+0x34)!=0 then
			set i=CallThisCallWith1Args(pGetAbilityUIDefAlt,RMem(a+0x34))
		endif
	endif
	if i>0 then
		set i=i+4
	endif
	return i
endfunction

function GetAbilityUIDefById takes integer id returns integer
	local integer a=CallThisCallWith1Args(pGetAbilityUIDefAlt,id)
	if a>0 then
		return a+4
	endif
	return a
endfunction

function GetAbilityDataDefByAddress takes integer a returns integer
	if a>0 then
		return RMem(a+0x54)
	endif
	return 0
endfunction

function GetAbilityDataDefById takes integer id returns integer
	local integer a=CallThisCallWith1Args(pGetAbilityDataDefAddr,id)
	if a>0 then
		return a
	endif
	return 0
endfunction

function GetAbilityDataDefByIdCaching takes integer id returns integer
	local integer a
	if HaveSavedInteger(ObjectDataPointersTable,DEF_ADR_ABILITY_DATA,id) then
		return LoadInteger(ObjectDataPointersTable,DEF_ADR_ABILITY_DATA,id)
	endif
//	call BJDebugMsg("Search ADATA for "+Id2String(id))
	set a=GetAbilityDataDefById(id)
	if a>0 then
		call SaveInteger(ObjectDataPointersTable,DEF_ADR_ABILITY_DATA,id,a)
	endif
	return a
endfunction

function GetAbilityUIDefCaching takes integer id returns integer
	local integer a
	if HaveSavedInteger(ObjectDataPointersTable,DEF_ADR_ABILITY_UI,id) then
		return LoadInteger(ObjectDataPointersTable,DEF_ADR_ABILITY_UI,id)
	endif
//	call BJDebugMsg("Search AUI for "+Id2String(id))
	set a=GetAbilityUIDefById(id)
	if a>0 then
		call SaveInteger(ObjectDataPointersTable,DEF_ADR_ABILITY_UI,id,a)
	endif
	return a
endfunction

function GetUnitUIDefById takes integer id returns integer
	local integer a=CallThisCallWith1Args(pGetUnitUIDefAddr,id)
	if a>0 then
		return a+4
	endif
	return a
endfunction

function GetUnitUIDefByIdCaching takes integer id returns integer
	local integer a
	if HaveSavedInteger(ObjectDataPointersTable,DEF_ADR_UNIT_UI,id) then
		return LoadInteger(ObjectDataPointersTable,DEF_ADR_UNIT_UI,id)
	endif
//	call BJDebugMsg("Search UUI for "+Id2String(id))
	set a=GetUnitUIDefById(id)
	if a>0 then
		call SaveInteger(ObjectDataPointersTable,DEF_ADR_UNIT_UI,id,a)
	endif
	return a
endfunction

function GetUnitDataDefById takes integer id returns integer
	local integer a=0
	local integer oldprotection
	local integer oldprotection2
	local integer normalVal
//	call BJDebugMsg("Search UDATA for "+Id2String(id))
	set oldprotection = ChangeOffsetProtection(GameDLL+0x29B7BC,4,0x40)
	set oldprotection2 = ChangeOffsetProtection(GameDLL+0x29B7C0,4,0x40)
	call WMem(GameDLL+0x29B7BC, 0x90900574)
	call WMem(GameDLL+0x29B7C0, 0x33C35990)
	set a=CallThisCallWith1Args(GameDLL+0x29B7A0,id)//BREAK function & return value we need, then restore
	call WMem(GameDLL+0x29B7BC, 0x408B0574)
	call WMem(GameDLL+0x29B7C0, 0x33C35918)
	call ChangeOffsetProtection(GameDLL+0x29B7BC,4,oldprotection)
	call ChangeOffsetProtection(GameDLL+0x29B7C0,4,oldprotection2)
	return a
endfunction

function GetUnitDataDefByIdCaching takes integer id returns integer
	local integer a
	if HaveSavedInteger(ObjectDataPointersTable,DEF_ADR_UNIT_DATA,id) then
		return LoadInteger(ObjectDataPointersTable,DEF_ADR_UNIT_DATA,id)
	endif
	set a=GetUnitDataDefById(id)
	if a>0 then
		call SaveInteger(ObjectDataPointersTable,DEF_ADR_UNIT_DATA,id,a)
	endif
	return a
endfunction

function GetItemDataDef takes integer id returns integer
	local integer a
	local integer oldprotection
	local integer oldprotection2
	set oldprotection = ChangeOffsetProtection(GameDLL+0x2B8C9C,4,0x40)
	set oldprotection2 = ChangeOffsetProtection(GameDLL+0x2B8CA0,4,0x40)
	call WMem(GameDLL+0x2B8C9C, 0xC08B0574)
	call WMem(GameDLL+0x2B8CA0, 0x33C35990)
	set a=CallThisCallWith1Args(GameDLL+0x2B8C80,id)//BREAK function & return value we need, then restore
	call WMem(GameDLL+0x2B8C9C, 0x408B0574)
	call WMem(GameDLL+0x2B8CA0, 0x33C35940)
	call ChangeOffsetProtection(GameDLL+0x2B8C9C,4,oldprotection)
	call ChangeOffsetProtection(GameDLL+0x2B8CA0,4,oldprotection2)
	return a
endfunction

function GetItemDataDefCaching takes integer id returns integer
	local integer a
	if HaveSavedInteger(ObjectDataPointersTable,DEF_ADR_ITEM_DATA,id) then
		return LoadInteger(ObjectDataPointersTable,DEF_ADR_ITEM_DATA,id)
	endif
	set a=GetItemDataDef(id)
	if a>0 then
		call SaveInteger(ObjectDataPointersTable,DEF_ADR_ITEM_DATA,id,a)
	endif
	return a
endfunction

function SetUnitPhased takes unit u returns nothing
	local integer data
	local integer p1
	local integer p2
	if IsUnitType(u,UNIT_TYPE_FLYING) then
		return
	endif
	set data=GetUnitDataDefByIdCaching(GetUnitTypeId(u)) + 0x1AC
	if data>0 then
		set p1= RMem(data)
		set p2= RMem(data + 4)
		call WMem(data,8)
		call WMem(data + 4,16)
		call SetUnitPathing(u, true)
		call WMem(data,p1)
		call WMem(data + 4,p2)
	endif
endfunction

function SetAbilityManaCost takes integer abil, integer level, integer cost returns nothing
	local integer a=GetAbilityDataDefByIdCaching(abil)
	if a>0 then
		set a=RMem(a+0x54)
		if a>0 then
			call WMem(a-0x58+level*0x68,cost)
		endif
	endif
endfunction

function GetAbilityManaCost takes integer abil, integer level returns integer
	local integer a
	if level>0 then
		set a=GetAbilityDataDefByIdCaching(abil)
		if a>0 then
			set a=RMem(a+0x54)
			if a>0 then
				return RMem(a-0x58+level*0x68)
			endif
		endif
	endif
	return 0
endfunction

function GetAbilityManaCostAddr takes integer add, integer level returns integer
	local integer a=RMem(add+0x54)
	if a>0 then
		return RMem(a+level*0x68)
	endif
	return 0
endfunction

function SetAbilityManaCostAddr takes integer add, integer level, integer mc returns nothing
	local integer a=RMem(add+0x54)
	if a>0 then
		call WMem(a+level*0x68,mc)
	endif
endfunction

function SetAbilityCD takes integer abil, integer level, real cool returns nothing
	local integer a=GetAbilityDataDefByIdCaching(abil)
	if a>0 then
		set a=RMem(a+0x54)
		if a>0 then
			call WMem(a-0x54+level*0x68, mR2I(cool))
		endif
	endif
endfunction

function GetAbilityMaxLevel takes integer abil returns integer
	local integer a
	if abil!=0 then
		set a=GetAbilityDataDefByIdCaching(abil)
		if a>0 then
			return RMem(a+0x50)
		endif
	endif
	return 0
endfunction

function GetAbilityLevelRequired takes integer abil returns integer
	local integer a
	if abil!=0 then
		set a=GetAbilityDataDefByIdCaching(abil)
		if a>0 then
			return RMem(a+0x40)
		endif
	endif
	return 0
endfunction

function GetAbilityCD takes integer abil, integer level returns real
	local integer a=GetAbilityDataDefByIdCaching(abil)
//	if abil=='A1P8'then//DotA-specific, charge of darkness
//		return 12.
//	endif
	if a>0 then
		if RMem(a+0x50)>=level then//max level check
			set a=RMem(a+0x54)
			if a>0 then
				return mI2R(RMem(a-0x54+level*0x68))
			endif
		endif
	endif
	return 0.
endfunction


function SetAbilityHotkeyParam takes integer id, integer off, integer newVal returns boolean
	local integer k=GetAbilityUIDefCaching(id)+off
	local integer a
	if k <= off then
		return false
	endif
	set a=k-0x4
	call WMem(a,newVal)
	call WMem(k,a)
	return true
endfunction

function GetAbilityHotkeyParam takes integer id, integer off returns integer
	local integer k=GetAbilityUIDefCaching(id)+off
	if k <= off then
		return 0
	endif
	if RMem(k)>0 then
		return RMem(RMem(k))
	endif
	return 0
endfunction

function SetAbilityIntegerParam takes integer id, integer off, integer newVal returns boolean
	local integer k=GetAbilityUIDefCaching(id)+off
	if k <= off then
		return false
	endif
	call WMem(k,newVal)
	return true
endfunction

function GetAbilityIntegerParam takes integer id, integer off returns integer
	local integer k=GetAbilityUIDefCaching(id)+off
	if k <= off then
		return 0
	endif
	return RMem(k)
endfunction

function SetAbilityRealParam takes integer id, integer off, real newVal returns boolean
	local integer k=GetAbilityUIDefCaching(id)+off
	if k <= off then
		return false
	endif
	call WMem(k,mR2I(newVal))
	return true
endfunction

function GetAbilityRealParam takes integer id, integer off returns real
	local integer k=GetAbilityUIDefCaching(id)+off
	if k <= off then
		return 0.
	endif
	return mI2R(RMem(k))
endfunction

function SetAbilityBoolParam takes integer id, integer off, boolean newVal returns boolean
	local integer k=GetAbilityUIDefCaching(id)+off
	if k <= off then
		return false
	endif
	if newVal then
		call WMem(k,1)
	else
		call WMem(k,0)
	endif
	return true
endfunction

function GetAbilityBoolParam takes integer id, integer off returns boolean
	local integer k=GetAbilityUIDefCaching(id)+off
	if k <= off then
		return false
	endif
	return RMem(k) > 0
endfunction



function SetAbilityResearchHotkeyId takes integer id, integer newVal returns boolean
	return SetAbilityHotkeyParam(id,0x98, newVal)
endfunction

function SetAbilityUnHotkeyId takes integer id, integer newVal returns boolean
	return SetAbilityHotkeyParam(id,0x8C, newVal)
endfunction

function SetAbilityHotkeyId takes integer id, integer newVal returns boolean
	return SetAbilityHotkeyParam(id,0x80, newVal)
endfunction

function SetAbilityHotkeyCommon takes integer id, integer newVal returns boolean
	call SetAbilityHotkeyId(id,newVal)
	call SetAbilityUnHotkeyId(id,newVal)
	return SetAbilityResearchHotkeyId(id,newVal)
endfunction

function SetAbilitySpellDetails takes integer id, integer det returns boolean
	return SetAbilityIntegerParam(id,0x70, det)
endfunction

function SetAbilityMissileSpeed takes integer id, real speed returns boolean
	return SetAbilityRealParam(id,0x64, speed)
endfunction

function SetAbilityResearchButtonY takes integer id, integer newY returns boolean
	return SetAbilityIntegerParam(id,0x60, newY)
endfunction

function SetAbilityResearchButtonX takes integer id, integer newX returns boolean
	return SetAbilityIntegerParam(id,0x5C, newX)
endfunction

function SetAbilityUnButtonY takes integer id, integer newY returns boolean
	return SetAbilityIntegerParam(id,0x58, newY)
endfunction

function SetAbilityUnButtonX takes integer id, integer newX returns boolean
	return SetAbilityIntegerParam(id,0x54, newX)
endfunction

function SetAbilityButtonY takes integer id, integer newY returns boolean
	return SetAbilityIntegerParam(id,0x50, newY)
endfunction

function SetAbilityButtonX takes integer id, integer newX returns boolean
	return SetAbilityIntegerParam(id,0x4C, newX)
endfunction

function SetAbilityMissileHoming takes integer id, boolean homing returns boolean
	return SetAbilityBoolParam(id,0x6C,homing)
endfunction

function SetAbilityMissileArc takes integer id, real arc returns boolean
	return SetAbilityRealParam(id,0x68, arc)
endfunction


function GetAbilityMissileSpeed takes integer id returns real
	return GetAbilityRealParam(id,0x64)
endfunction

function GetAbilityMissileArc takes integer id returns real
	return GetAbilityRealParam(id,0x68)
endfunction

function GetAbilityResearchHotkeyId takes integer id returns integer
	return GetAbilityHotkeyParam(id,0x98)
endfunction

function GetAbilityUnHotkeyId takes integer id returns integer
	return GetAbilityHotkeyParam(id,0x8C)
endfunction

function GetAbilityHotkeyId takes integer id returns integer
	return GetAbilityHotkeyParam(id,0x80)
endfunction

function GetAbilitySpellDetails takes integer id returns integer
	return GetAbilityIntegerParam(id,0x70)
endfunction

function GetAbilityResearchButtonY takes integer id returns integer
	return GetAbilityIntegerParam(id,0x60)
endfunction

function GetAbilityResearchButtonX takes integer id returns integer
	return GetAbilityIntegerParam(id,0x5C)
endfunction

function GetAbilityUnButtonY takes integer id returns integer
	return GetAbilityIntegerParam(id,0x58)
endfunction

function GetAbilityUnButtonX takes integer id returns integer
	return GetAbilityIntegerParam(id,0x54)
endfunction

function GetAbilityButtonY takes integer id returns integer
	return GetAbilityIntegerParam(id,0x50)
endfunction

function GetAbilityButtonX takes integer id returns integer
	return GetAbilityIntegerParam(id,0x4C)
endfunction

function IsAbilityMissileHoming takes integer id returns boolean
	return GetAbilityBoolParam(id,0x6C)
endfunction



function GetAbilityStringParam takes integer id, integer off returns string
	local integer k=GetAbilityUIDefCaching(id)
	if k < 1 then
		return ""
	endif
//	call echo(Int2Hex(k))
	set k=k+off
	if RMem(k)>0 then
		return ConvertNullTerminatedStringToString(RMem(k))
	endif
	return ""
endfunction

function SetAbilityStringParam takes integer id, integer off, string newVal returns boolean
	local integer k=GetAbilityUIDefCaching(id)
	if k < 1 then
		return false
	endif
	call WMem(k+off, GetStringAddress(newVal))
	return true
endfunction

function GetAbilityStringParam2 takes integer id, integer off, integer lvl returns string
	local integer k=GetAbilityUIDefCaching(id)
	if k < 1 then
		return ""
	endif
	set k=k+off
	set lvl=lvl-1
	if RMem(k)+lvl*4>0 then
		return ConvertNullTerminatedStringToString(RMem(RMem(k)+lvl*4))
	endif
	return ""
endfunction

function SetAbilityStringParam2 takes integer id, integer off, string newVal, integer lvl returns boolean
	local integer k=GetAbilityUIDefCaching(id)
	if k < 1 then
		return false
	endif
	set k=k+off
	if RMem(k)>0 then
		call WMem(RMem(k+lvl*4-4), GetStringAddress(newVal))
		return true
	endif
	return false
endfunction

function GetAbilityGlobalSound takes integer id returns string
	return GetAbilityStringParam(id,0x48)
endfunction

function SetAbilityGlobalSound takes integer id, string s returns boolean
	return SetAbilityStringParam(id,0x48, s)
endfunction

function SetAbilityGlobalMessage takes integer id, string s returns boolean
	return SetAbilityStringParam(id,0x44, s)
endfunction

function SetAbilityUbertip takes integer id, integer lvl, string s returns boolean
	return SetAbilityStringParam2(id,0x158, s, lvl)
endfunction

function GetAbilityUbertip takes integer id, integer lvl returns string
	return GetAbilityStringParam2(id,0x158, lvl)
endfunction

function SetAbilityTip takes integer id, integer lvl, string s returns boolean
	return SetAbilityStringParam2(id,0x134, s, lvl)
endfunction

function SetAbilityEffectSound takes integer id, string s returns boolean
	local boolean b=SetAbilityStringParam(id,0x2C, s)
	return b
endfunction

function GetUnitUIName takes integer id returns string
	local integer a=GetUnitUIDefByIdCaching(id)
	if a>0 then
		set a=RMem(a+0x28)
		if a>0 then
			return ConvertNullTerminatedStringToString(RMem(a))
		endif
	endif
	return ""
endfunction

function SetUnitUIName takes integer id, string s returns nothing
	local integer a=GetUnitUIDefByIdCaching(id)
	if a>0 then
		set a=RMem(a+0x28)
		if a>0 then
			call WMem(a,GetStringAddress(s))
		endif
	endif
endfunction

function GetUnitUIDescription takes integer id returns string
	local integer a=GetUnitUIDefByIdCaching(id)
	if a>0 then
		set a=RMem(a+0x2C)
		if a>0 then
			return ConvertNullTerminatedStringToString(a)
		endif
	endif
	return ""
endfunction

function SetUnitUIDescription takes integer id, string s returns nothing
	local integer a=GetUnitUIDefByIdCaching(id)
	if a>0 then
		call WMem(a+0x2C,GetStringAddress(s))
	endif
endfunction

function SetBuffTip takes integer id, string s returns boolean
	local boolean b=SetAbilityStringParam2(id,0x110, s, 1)
	call SaveUnlockWriteMemory(pSkipBuffExistCheck,pSkipBuffExistCheckFoolish,false,true)
	call CallStdcallWith1Args(pGetBuffTooltipsFunc,id)
	call SaveUnlockWriteMemory(pSkipBuffExistCheck,pSkipBuffExistCheckDefaultData,false,true)
	return b
endfunction

function SetBuffUberTip takes integer id, string s returns boolean
	local boolean b=SetAbilityStringParam2(id,0x11C, s, 1)
	call SaveUnlockWriteMemory(pSkipBuffExistCheck,pSkipBuffExistCheckFoolish,false,true)
	call CallStdcallWith1Args(pGetBuffTooltipsFunc,id)
	call SaveUnlockWriteMemory(pSkipBuffExistCheck,pSkipBuffExistCheckDefaultData,false,true)
	return b
endfunction

function GetAbilityTip takes integer id, integer lvl returns string
	return GetAbilityStringParam2(id,0x134, lvl)
endfunction

function GetUnitDefaultColor takes unit u returns integer
	local integer a=GetUnitTypeId(u)
	if a>0 then
		set a=GetUnitUIDefByIdCaching(a)
		if a>0 then
			return RMem(a+0xA8)
		endif
	endif
	return 0
endfunction

function SetUnitModelUF takes unit u, string s returns nothing
	call SetUnitModel(GetUnitUIDefByIdCaching(GetUnitTypeId(u)),s)
endfunction

function GetUnitMissileSpeed takes integer id, integer index returns real
	local integer k=GetUnitUIDefByIdCaching(id)
	if k<1 then
		return 0.
	endif
	set k=RMem(k+0x60)
	if k==0 then
		return 99999.
	endif
	return mI2R(RMem(k+index))
endfunction

function SetUnitMissileArt takes unit u, string path returns nothing
	local integer a=GetUnitUIDefByIdCaching(GetUnitTypeId(u))
	if a>0 then
		set a=RMem(a+0x40)
		call WMem(a,GetStringAddress(path))
	endif
endfunction

function GetPingAddress takes nothing returns integer
	return RMem((RMem(pGameClass2) + 0x254))
endfunction

function GetPingX takes integer id returns real
	return mI2R(  RMem(RMem(GetPingAddress() + 0xb0) + 12*id))
endfunction

function GetPingY takes integer id returns real
	return mI2R(  RMem(RMem(GetPingAddress() + 0xb0) + 12*id + 4))
endfunction

function GetPingZ takes integer id returns real
	return mI2R(  RMem(RMem(GetPingAddress() + 0xb0) + 12*id + 8))
endfunction


function SetPingX takes integer id, real x returns nothing
	call WMem( RMem( GetPingAddress() + 0xb0) + 12*id, mR2I(x))
endfunction

function SetPingY takes integer id, real y returns nothing
	call WMem( RMem( GetPingAddress() + 0xb0) + 12*id + 4 , mR2I(y))
endfunction

function SetPingZ takes integer id, real z returns nothing
	call WMem( RMem( GetPingAddress() + 0xb0) + 12*id + 8 , mR2I(z))
endfunction

function GetPingCount takes nothing returns integer
	return RMem((GetPingAddress() + 0xa4))
endfunction

function SetPingCount takes integer i returns nothing
	call WMem(GetPingAddress() + 0xa4, i)
endfunction

function GetNextPingFillID takes nothing returns integer
	return RMem(GetPingAddress() + 0xa0) 
endfunction

function SetNextPingFillID takes integer i returns nothing
	call WMem(GetPingAddress() + 0xa0, i)
endfunction

function GetNextPingID takes nothing returns integer
	return RMem(GetPingAddress() + 0x98)
endfunction

function SetNextPingID takes integer i returns nothing
	call WMem(GetPingAddress() + 0x98, i)
endfunction


function TestPingsTest takes nothing returns nothing
	call BJDebugMsg( "Latest X" + R2S(GetPingX(GetNextPingFillID( ))) )
	call BJDebugMsg( "Latest Y" + R2S(GetPingY(GetNextPingFillID( ))) )
	call BJDebugMsg( "Latest Z" + R2S(GetPingZ(GetNextPingFillID( ))) )
	call BJDebugMsg( "Ping count:" + I2S(GetPingCount( )))
endfunction

function GetLightningAddressByID takes integer id returns integer
	if RMem(pLightEnv+0x34) != 0 then 
		return RMem(RMem(pLightEnv+0x34) + 8) +  (id - 1) * 4
	endif
	return 0
endfunction

function GetGameAreaSizeLimit takes nothing returns real
	return mI2R(RMem(RMem(pGameClass3) + 0xF8))
endfunction

function SetGameAreaSizeLimit takes real r returns nothing
	call WMem(RMem(pGameClass3) + 0xF8, mR2I(r))
endfunction

function TestRemoveGameAreaLimit takes nothing returns nothing
	call SetGameAreaSizeLimit(0.0)
endfunction

function FuncSetWidescreenFixState takes boolean WidescreenState returns nothing
	local integer nOffset1
	if pSetWidescreenFixState == 0 then
		set pSetWidescreenFixState = GetModuleProcAddress(EXTRADLLNAME, "SetWidescreenFixState" )
	endif
	if pSetWidescreenFixState != 0 then 
		call CallStdcallWith1Args(pSetWidescreenFixState,B2I(WidescreenState))
	endif
	set WidescreenStateLocal=WidescreenState
endfunction

function FuncSetCustomFovFix takes real CustomFOV_X returns nothing
	local integer nOffset1
	if pSetCustomFovFix == 0 then
		set pSetCustomFovFix = GetModuleProcAddress(EXTRADLLNAME, "SetCustomFovFix" )
	endif
	if pSetCustomFovFix != 0 then 
		call CallStdcallWith1Args(pSetCustomFovFix,mR2I(CustomFOV_X))
	endif
endfunction

function TestWideScreen takes nothing returns nothing
	if GetLocalPlayer()==GetTriggerPlayer() then//widescreen
		call FuncSetWidescreenFixState(not WidescreenStateLocal)
	endif
endfunction

function GetAgileTimersData takes nothing returns integer
	local integer pOffset = RMem(pTimerAddr)
	if pOffset > 0 then 
		set pOffset = RMem(pOffset+0x40)
		if pOffset > 0 then 
			return pOffset
		endif
	endif
	return 0
endfunction

function GetTimerList takes nothing returns integer
	local integer pOffset = GetAgileTimersData()
	if pOffset > 0 then 
		set pOffset = RMem(pOffset + 0x8)
		if pOffset > 0 then 
			return pOffset + 4
		endif
	endif
	return 0
endfunction

function GetTimerCount takes nothing returns integer 
	local integer pOffset = GetAgileTimersData()
	if pOffset > 0 then 
		set pOffset = RMem(pOffset + 0x20)
		if pOffset > 0 then 
			return pOffset - 1
		endif
	endif
	return 0
endfunction

function TestPrintAllTimers takes nothing returns nothing
	local integer TimerList = GetTimerList( )
	local integer TimersCount = GetTimerCount( )
	local integer CurrentTimerID = 0
	local integer CurrentTimer = 0
	
	call BJDebugMsg("First timer addr:" + Int2Hex(RMem(TimerList)))
	call BJDebugMsg("Agile addr: " + Int2Hex(GetAgileTimersData( )))
	call BJDebugMsg("Timers count:" + I2S(GetTimerCount()))
	loop 
		set TimersCount = GetTimerCount( )
		call BJDebugMsg("Timer id:" + I2S(CurrentTimerID) )
		set CurrentTimer = RMem(TimerList + CurrentTimerID * 4)
		call BJDebugMsg("Timer addr: " + Int2Hex(CurrentTimer))
		call BJDebugMsg("Timer 1/2 values: " + R2S(mI2R(RMem(CurrentTimer + 0x4))) + " / " +  R2S(mI2R(RMem(CurrentTimer + 0x8))))
		if (mI2R(RMem(CurrentTimer + 0x8)) == 0.4 or mI2R(RMem(CurrentTimer + 0x8)) == 0.5) then 
			call WMem(CurrentTimer + 0x8, mR2I( 10.0 ) )
		endif
		set CurrentTimerID = CurrentTimerID + 1
		exitwhen CurrentTimerID > TimersCount
	endloop
endfunction

function TestPrintAllTimers3 takes nothing returns nothing
	local integer i=0
	local integer k=LoadInteger(TempHash,'tmrs',-1)
	local integer id
	loop
		set id=LoadInteger(TempHash,'tmrs',i*1000)
		if id>0 then
			call BJDebugMsg("T: "+Int2Hex(LoadInteger(TempHash,'tmrs',i*1000))+" v= "+R2S(LoadReal(TempHash,'tmrs',1000*i))+" - "+R2S(LoadReal(TempHash,'tmrs',1000*i+1)))
		endif
		set i=i+1
		exitwhen i>k
	endloop
endfunction

function TestPrintAllTimers2 takes nothing returns nothing
	local integer TimerList = GetTimerList( )
	local integer TimersCount = GetTimerCount( )
	local integer CurrentTimerID = 0
	local integer CurrentTimer = 0
	call SaveInteger(TempHash,'tmrs',-1,GetTimerCount())
	
	loop 
		set TimersCount = GetTimerCount( )
		set CurrentTimer = RMem(TimerList + CurrentTimerID * 4)
		if CurrentTimer>0 and mI2R(RMem(CurrentTimer + 0x8))<=1. then
			call SaveInteger(TempHash,'tmrs',CurrentTimerID*1000,CurrentTimer)
			call SaveReal(TempHash,'tmrs',CurrentTimerID*1000,mI2R(RMem(CurrentTimer + 0x4)))
			call SaveReal(TempHash,'tmrs',CurrentTimerID*1000+1,mI2R(RMem(CurrentTimer + 0x8)))
		endif
		set CurrentTimerID = CurrentTimerID + 1
		exitwhen CurrentTimerID > TimersCount
	endloop
	call TimerStart(CreateTimer(),0.1,false,function TestPrintAllTimers3)
endfunction

function GetFogStateAddr takes nothing returns integer
	return RMem(pCGameState + 12) 
endfunction

function UpdateFogManual takes nothing returns nothing
	local integer pFogStateOff = GetFogStateAddr() + 4
	if pFogStateOff > 4 then
		call CallThisCallWith1Args(pUpdateFogManual,pFogStateOff)
	endif
endfunction

function BlockRealFogUpdate takes boolean block returns nothing
	local integer oldprotection1
	if FogUpdateBlocked then 
		set oldprotection1 = ChangeOffsetProtection(pFogUpdateBlockAddr,8,0x40)
		if block then
			call WMem(pFogUpdateBlockAddr, pFogUpdateBlockAddrNew1)
			call WMem(pFogUpdateBlockAddr + 4, pFogUpdateBlockAddrNew2)
		else 
			call WMem(pFogUpdateBlockAddr, pFogUpdateBlockAddrOld1)
			call WMem(pFogUpdateBlockAddr + 4, pFogUpdateBlockAddrOld2)
		endif
		call ChangeOffsetProtection(pFogUpdateBlockAddr,8,oldprotection1)
	else 
		set pFogUpdateBlockAddrOld1 = RMem(pFogUpdateBlockAddr)
		set pFogUpdateBlockAddrOld2 = RMem(pFogUpdateBlockAddr + 4)
		set FogUpdateBlocked = true
		call BlockRealFogUpdate( block )
	endif
endfunction

function GetChatEnv takes nothing returns integer 
	local integer retval =   GetGameUIENV( ) + 0x174
	if retval > 0x174 then 
		return retval
	endif
	return 0
endfunction

function GetChatMessagesList takes nothing returns integer 
	return RMem(GetChatEnv( )  + 0x18)
endfunction

function SetChatEmptyMessage takes nothing returns nothing
	if GetChatEnv( ) > 0 then 
		call WMem( GetChatEnv( ) + 4, 1 )
	endif
endfunction

function SetChatMessageXbyID takes integer MsgID, real x returns nothing 
	local integer pChatMessageOffset = GetChatMessagesList( ) + MsgID * 12
	call WMem(pChatMessageOffset + 0, mR2I(x))
endfunction

function SetChatMessageYbyID takes integer MsgID, real x returns nothing 
	local integer pChatMessageOffset = GetChatMessagesList( ) + MsgID * 12
	call WMem(pChatMessageOffset + 4, mR2I(x))
endfunction

function GetChatMessageAddressByID takes integer MsgID returns integer 
	local integer pChatMessageOffset = GetChatMessagesList( ) + MsgID * 12
	return RMem(pChatMessageOffset + 8)
endfunction

function SearchStringValueAddress takes string str returns integer
	local integer retaddr = CallThisCallWith2Args(pSearchStringValue,pSearchStringAddr1,GetStringAddress(str))
	if retaddr == 0 or RMem( retaddr + 0x1C ) == 0 then 
		set retaddr = CallThisCallWith2Args(pSearchStringValue,pSearchStringAddr2,GetStringAddress(str))
	endif
	if retaddr == 0 or RMem( retaddr + 0x1C ) == 0 then 
		return 0
	endif
	return RMem( retaddr + 0x1C )
endfunction

function SearchStringValue takes string str returns string
	return ConvertNullTerminatedStringToString(SearchStringValueAddress(str))
endfunction

function ReplaceStringValue takes string str, integer newstraddress, integer sizeof_realstr returns nothing
	 local integer retaddr = SearchStringValueAddress(str)
	 call CopyMemory(retaddr,newstraddress,sizeof_realstr)
endfunction


function ReplaceStringValueUNSAFE takes string str, integer newstraddress returns nothing
	local integer retaddr = CallThisCallWith2Args(pSearchStringValue,pSearchStringAddr1,GetStringAddress(str))
	if retaddr == 0 or RMem( retaddr + 0x1C ) == 0 then 
		set retaddr = CallThisCallWith2Args(pSearchStringValue,pSearchStringAddr2,GetStringAddress(str))
	endif
	if retaddr == 0 or RMem( retaddr + 0x1C ) == 0 then 
		return 
	endif
	call AddNewOffsetToRestore(retaddr + 0x1C,RMem(retaddr + 0x1C))
	call WMem(retaddr + 0x1C, newstraddress)
endfunction

function SimulateAttackInstance takes unit u, unit target returns nothing
	local integer a=GetUnitAbility(u,'Aatk')
	local integer b
	if a>0 then
		set b=ConvertHandle(target)
		call CallThisCallWith7Args(pSimulateAttackInstance,a,b,0,0,1,1,1)
//attack ability
//target
//unknown, must be zero in order to attack to happen
//1 if should use orb-modifier (any)
//unused
//unknown
//unknown
//0 1 0 0 0 - autocast hotkey OR searing arrow passive cast (orb of slow, geminate attack)
//0 0 1 1 1 - default attack
//0 0 1 0 0 - attack with orb-effect (2nd index?)
		
	endif
endfunction

function SimulateAttackInstanceArrow takes unit u, unit target returns nothing
	local integer a=GetUnitAbility(u,'Aatk')
	local integer b
	if a>0 then
		set b=ConvertHandle(target)
		call CallThisCallWith7Args(pSimulateAttackInstance,a,b,0,1,0,0,0)
	endif
endfunction

function GetOrderPlayerId takes unit u returns integer 
	local integer pUhandle=0
	if u == null then 
		return 0xF
	endif
	set pUhandle = ConvertHandle(u)
	if pUhandle == 0 then 
		return 0xF
	endif
	if (RMem(pUhandle + 0x1a8) <= 0 or RMem(pUhandle + 0x1aC) <= 0) then 
		return 0xF
	endif
	return RMem(GetSomeAddressForAbility(RMem(pUhandle + 0x1a8),RMem(pUhandle + 0x1aC))+0x28)
endfunction

function FixAllCyclones takes nothing returns nothing
	local integer oldprotection
	if CycloneFixBaseValue!=0 then
		return
	endif
	set oldprotection = ChangeOffsetProtection((pCycloneFixCondition),4,0x40)
	set CycloneFixBaseValue=RMem(pCycloneFixCondition)
	call WMem(pCycloneFixCondition,CycloneFixCondition026a)
	call ChangeOffsetProtection((pCycloneFixCondition),4,oldprotection)
endfunction

function DeFixAllCyclones takes nothing returns nothing
	local integer oldprotection
	if CycloneFixBaseValue==0 then
		return
	endif
	set oldprotection = ChangeOffsetProtection((pCycloneFixCondition),4,0x40)
	call WMem(pCycloneFixCondition,CycloneFixBaseValue)
	set CycloneFixBaseValue=0
	call ChangeOffsetProtection((pCycloneFixCondition),4,oldprotection)
endfunction

function FuncToggleForcedSubSelection takes boolean b returns nothing 
	if pToggleForcedSubSelection == 0 then 
		set pToggleForcedSubSelection = GetModuleProcAddress(EXTRADLLNAME, "ToggleForcedSubSelection")
	endif
	if pToggleForcedSubSelection != 0 then 
		call CallStdcallWith1Args(pToggleForcedSubSelection,B2I(b))
	endif
	set OnKeySelectHeroOptionEnabled=b
endfunction

function FuncToggleBlockKeyAndMouseEmulation takes boolean b returns nothing 
	if pToggleBlockKeyAndMouseEmulation == 0 then 
		set pToggleBlockKeyAndMouseEmulation = GetModuleProcAddress(EXTRADLLNAME, "ToggleBlockKeyAndMouseEmulation")
	endif
	if pToggleBlockKeyAndMouseEmulation != 0 then 
		call CallStdcallWith1Args(pToggleBlockKeyAndMouseEmulation,B2I(b))
	endif
endfunction

function FuncToggleClickHelper takes boolean b returns nothing 
	if pToggleClickHelper == 0 then 
		set pToggleClickHelper = GetModuleProcAddress(EXTRADLLNAME, "ToggleClickHelper")
	endif
	if pToggleClickHelper != 0 then 
		call CallStdcallWith1Args(pToggleClickHelper,B2I(b))
	endif
endfunction

function UpdateUnitMoveSpeedTo takes unit u, real ms returns nothing
	local integer a=GetHandleId(u)
	if a>0 then
		set a=ConvertHandle(u)
		if a>0 then
			set a=GetUnitAddressFloatsRelated(a,0xA0)
			if a>0 then
				set a=RMem(a+0x28)
				set a=a-0x24
				if a>0 then
					set ms=ms/32
					call WMem(pReserverdIntArg1, mR2I(ms))
					call CallThisCallWith2Args(pUpdateUnitsSpeedCurrent,a, pReserverdIntArg1)
				endif
			endif
		endif
	endif
endfunction

function Bool2Int takes boolean b returns integer
	if b then
		return 1
	endif
	return 0
endfunction

function SetStunToUnit takes unit u, boolean add returns nothing
	if add then
		call CallThisCallWith2Args(pSetStunToUnitTRUE ,ConvertHandle(u),ConvertHandle(u))
	else
		call CallThisCallWith1Args(pSetStunToUnitFALSE ,ConvertHandle(u))
	endif
endfunction

function CommonSilenceApply takes unit u, boolean app returns nothing
	local integer a=ConvertHandle(u)
	if a>0 then
		call CallThisCallWith2Args(pCommonSilence,a,Bool2Int(app))
	endif
endfunction

function DisableAllUnitsAbilities takes unit u, boolean disable returns nothing
//visually equal to pause: all skills are hidden and silenced
	local integer a=ConvertHandle(u)
	if a>0 then
		call CallThisCallWith5Args(pPauseUnitDisabler,a,1,Bool2Int(disable),0,0)
	endif
endfunction

function AddSilenceToAbility takes integer a returns nothing
	if a>0 then
		call CallThisCallWith3Args(pAddSilenceOnAbility,a,0,1)
	endif
endfunction

function RemoveSilenceFromAbility takes integer a returns nothing
	if a>0 then
		call CallThisCallWith3Args(pRemoveSilenceFromAbility,a,0,1)
	endif
endfunction

function AddSilenceHideToAbility takes integer a returns nothing
	if a>0 then
		call CallThisCallWith3Args(pAddSilenceOnAbility,a,1,1)
	endif
endfunction

function RemoveSilenceHideFromAbility takes integer a returns nothing
	if a>0 then
		call CallThisCallWith3Args(pRemoveSilenceFromAbility,a,1,1)
	endif
endfunction

function SetUnitBaseMovespeed takes unit u, real r returns nothing
	local integer a=ConvertHandle(u)
	if a>0 then
		set a=RMem(a+0x1EC)
		if a>0 then
			call WMem(a+0x70,mR2I(r))
		endif
	endif
endfunction

function GetUnitBaseMovespeed takes unit u returns real
	local integer a=ConvertHandle(u)
	if a>0 then
		set a=RMem(a+0x1EC)
		if a>0 then
			return mI2R(RMem(a+0x70))
		endif
	endif
	return 0.
endfunction

function ThrowTargetSpellTargetUnit takes unit who, integer id, widget target returns nothing
	local integer a=ConvertHandle(target)
	local integer x
	local integer y
	local integer flags
	if a>0 and GetHandleId(who)>0 then
		set x=RMem(a+0xC)
		set y=RMem(a+0x10)
		if x>0 and y>0 then
			set a=ConvertHandle(who)
			if a<1 then
				return
			endif
			set a=GetUnitAbility(who,id)
			if a>0 then
				call WMem(a+0xE4,x)//for any target (widget)
				call WMem(a+0xE8,y)
				set flags=RMem(a+0x20)
				if not IsFlagBitSet(flags,0x10000) then
//0x19804 stands for "target", 0x1F020 stands for "target item",0x9800 stands for point target
					call WMem(a+0x20,flags+0x10000)
					set flags=flags+0x10000
					if not IsFlagBitSet(flags,0x1) then
						call WMem(a+0x20,flags+0x1)
					endif
				endif
				set a=CallThisCallWith1Args(pCastAbility,a)
			endif
		endif
	endif
endfunction

function ThrowSpellXY takes unit who, integer id, real x, real y returns nothing
//fits for no-target spells as Was Stomp as well
	local integer a=ConvertHandle(who)
	if a>0 then
		set a=GetUnitAbility(who,id)
		if a>0 then
			call WMem(a+0xF8,mR2I(x))
			call WMem(a+0x100,mR2I(y))
			call WMem(a+0x20,0x9800)
			set a=CallThisCallWith1Args(pCastAbility,a)
		endif
	endif
endfunction

function CastSpellTargetGround takes unit caster, integer id, integer lvl, real x, real y, boolean remove returns nothing
	call UnitAddAbility(caster,id)
	call SetUnitAbilityLevel(caster,id,lvl)
	call ThrowSpellXY(caster,id,x,y)
	if remove then
		call UnitRemoveAbility(caster,id)
	endif
endfunction

function CastSpellTargetGround2 takes unit caster, integer id, integer lvl, real x, real y, integer oid returns nothing
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)
	call UnitAddAbility(d,id)
	call SetUnitAbilityLevel(d,id,lvl)
	call IssueImmediateOrderById(d,oid)
	set d=null
endfunction

function ThrowTargetSpellTargetUnitSingle takes unit who, integer id, integer lvl, widget target, boolean remove returns nothing
// due to memory issues requires STDCAlls and ThisCAlls to use different memory allocation
// else spells which deals dmage immediately on cast will interference with damage-related functions and fuck whole thing up
// Chain lightnings stops as soon as ability removed so you may want it to stay
	local unit u=who
	if IsUnitIllusion(who) then
		set u=CreateUnit(GetOwningPlayer(who),'e00E',GetUnitX(who),GetUnitY(who),0)
	endif
	call UnitAddAbility(who,id)
	if lvl>1 then
		call SetUnitAbilityLevel(who,id,lvl)
	endif
	call ThrowTargetSpellTargetUnit(who,id,target)
	if remove then
		call UnitRemoveAbility(who,id)
	endif
	set u=null
endfunction

function SelfCastSpell takes unit who, integer id, integer lvl returns nothing
// workaround when caster doesnt matter
	local unit u=who
	if IsUnitIllusion(who) then
		set u=CreateUnit(GetOwningPlayer(who),'e00E',GetUnitX(who),GetUnitY(who),0)
	endif
	call UnitAddAbility(u,id)
	if lvl>1 then
		call SetUnitAbilityLevel(u,id,lvl)
	endif
	call ThrowTargetSpellTargetUnit(u,id,who)
	call UnitRemoveAbility(u,id)
	set u=null
endfunction

function IsAttackDisabled takes unit u returns boolean
	local integer a=GetHandleId(u)
	if a>0 then
		set a=ConvertHandle(u)
		if a>0 then
			set a=RMem(a+0x1E8)
			if a>0 then
				return RMem(a+0x40)>0
			endif
		endif
	endif
	return false
endfunction
// REMINDER: All this/fast/cdecl calls uses the same pReservedExecutableMemory2  --- FIXED FOR SOME CASES BY KARAULOV!
// REMINDER: All this/fast/cdecl calls uses the same pReadStack2 --- FIXED FOR SOME CASES BY KARAULOV!
// in case if one thread being interrupted by another 
// (midwhile calling some func you deal damage to the unit, and you have ON_DAMAGE 
// trigger which runs some function as well, trashing this memory) it will end up with fatal for sure.

function UnstuckWindwalkAbilities takes unit u, integer id returns nothing
	local integer a=GetUnitAbilityLevel(u,id)
	if a>0 then
		set a=GetUnitAbility(u,id)
		if a>0 then
			call WMem(a+0x44,-100)
		endif
	endif
endfunction

function FuncApplyTerrainFilterDirectly takes string Path, integer addr_of_mem, integer addr_of_size, boolean IsTarga returns nothing 
	if pApplyTerrainFilterDirectly == 0 then 
		set pApplyTerrainFilterDirectly = GetModuleProcAddress(EXTRADLLNAME, "ApplyTerrainFilterDirectly")
	endif
	if pApplyTerrainFilterDirectly != 0 then 
		call CallStdcallWith4Args(pApplyTerrainFilterDirectly,GetStringAddress(Path),addr_of_mem,addr_of_size,B2I(IsTarga))
	endif
endfunction

function LoadFileMemAddr takes string FileName returns integer 
	return FUCKINGCallWith4Args(pGetOrLoadFile,GetStringAddress(FileName),0,0,0)
endfunction

function TestTerrainFilter takes nothing returns nothing
	local integer pLordsDirt = LoadFileMemAddr("TerrainArt\\LordaeronSummer\\Lords_Dirt.blp")
	if pLordsDirt > 0 then 
		call BJDebugMsg( "Texture addr: " + Int2Hex(pLordsDirt) )
		call BJDebugMsg("OLD ADDRESS : " + Int2Hex(RMem(pLordsDirt + 0x18)))
		call FuncApplyTerrainFilterDirectly("TerrainArt\\LordaeronSummer\\Lords_Dirt.blp",pLordsDirt + 0x18, pLordsDirt + 0x1C, false)
		call BJDebugMsg("NEW ADDRESS : " + Int2Hex(RMem(pLordsDirt + 0x18)))
	endif
endfunction

function FuncSetMainFuncWork takes boolean b returns nothing
	if pSetMainFuncWork == 0 then 
		set pSetMainFuncWork = GetModuleProcAddress(EXTRADLLNAME, "SetMainFuncWork")
	endif
	if pSetMainFuncWork != 0 then 
		call CallStdcallWith1Args(pSetMainFuncWork,B2I(b))
	endif
endfunction

function FuncFixModelCollisionSphere takes string Path, real X, real Y, real Z, real Radius returns nothing 
	if pFixModelCollisionSphere == 0 then 
		set pFixModelCollisionSphere = GetModuleProcAddress(EXTRADLLNAME, "FixModelCollisionSphere")
	endif
	if pFixModelCollisionSphere != 0 then 
		call CallStdcallWith5Args(pFixModelCollisionSphere,GetStringAddress(Path),mR2I(X),mR2I(Y),mR2I(Z),mR2I(Radius))
	endif
endfunction

function FuncFixModelTexturePath takes string ModelPath, integer TextureID, string NewTexturePath returns nothing 
	if pFixModelTexturePath == 0 then 
		set pFixModelTexturePath = GetModuleProcAddress(EXTRADLLNAME, "FixModelTexturePath")
	endif
	if pFixModelTexturePath != 0 then 
		call CallStdcallWith3Args(pFixModelTexturePath,GetStringAddress(ModelPath),TextureID,GetStringAddress(NewTexturePath))
	endif
endfunction

function FuncPatchModel takes string ModelPath, string patchPath returns nothing
	if pPatchModel == 0 then 
		set pPatchModel = GetModuleProcAddress(EXTRADLLNAME, "PatchModel")
	endif
	if pPatchModel != 0 then 
		call CallStdcallWith2Args(pPatchModel,GetStringAddress(ModelPath),GetStringAddress(patchPath))
	endif
endfunction

function FuncChangeAnimationSpeed takes string ModelPath, string AnimationName, real SpeedUP returns nothing
	if pChangeAnimationSpeed == 0 then 
		set pChangeAnimationSpeed = GetModuleProcAddress(EXTRADLLNAME, "ChangeAnimationSpeed")
	endif
	if pChangeAnimationSpeed != 0 then 
		call CallStdcallWith3Args(pChangeAnimationSpeed,GetStringAddress(ModelPath),GetStringAddress(AnimationName), mR2I(SpeedUP))
	endif
endfunction

function FuncSetSequenceValue takes string ModelPath, string AnimationName, integer Indx, real Value returns nothing
	if pSetSequenceValue == 0 then 
		set pSetSequenceValue = GetModuleProcAddress(EXTRADLLNAME, "SetSequenceValue")
	endif
	if pSetSequenceValue != 0 then 
		call CallStdcallWith4Args(pSetSequenceValue,GetStringAddress(ModelPath),GetStringAddress(AnimationName),Indx, mR2I(Value))
	endif
endfunction

function FuncSetModelScale takes string ModelPath, real Scale returns nothing
	if pSetModelScale == 0 then 
		set pSetModelScale = GetModuleProcAddress(EXTRADLLNAME, "SetModelScale")
	endif
	if pSetModelScale != 0 then 
		call CallStdcallWith2Args(pSetModelScale,GetStringAddress(ModelPath),mR2I(Scale))
	endif
endfunction

function FuncRedirectFile takes string OriginalFileName, string RedirectFileName returns nothing
	if pRedirectFile == 0 then 
		set pRedirectFile = GetModuleProcAddress(EXTRADLLNAME, "RedirectFile")
	endif
	if pRedirectFile != 0 then 
		call CallStdcallWith2Args(pRedirectFile,GetStringAddress(OriginalFileName),GetStringAddress(RedirectFileName))
	endif
endfunction

function IsStoreIntegerLocked takes nothing returns boolean
	return RMem(StoreIntegerOffset) == 0x90C3C08B
endfunction


function LockStoreInteger takes nothing returns nothing
	local integer oldprotection = ChangeOffsetProtection( StoreIntegerOffset,4,0x40)
	
	if StoreIntegerLocked != IsStoreIntegerLocked( ) then
		call MaphackDetected( GetLocalPlayer( ), "StoreInteger hack detected!" )
	endif
	
	if StoreIntegerLocked == false then
		set StoreIntegerUnlocker = RMem(StoreIntegerOffset)
		set StoreIntegerLocked = true
	endif
	
	call WMem(StoreIntegerOffset, 0x90C3C08B)
	call ChangeOffsetProtection( StoreIntegerOffset,4, oldprotection)
endfunction

function UnLockStoreInteger takes nothing returns nothing
	local integer oldprotection = ChangeOffsetProtection( StoreIntegerOffset,4,0x40)
	
	if StoreIntegerLocked != IsStoreIntegerLocked( ) then
		call MaphackDetected( GetLocalPlayer( ), "StoreInteger hack detected#2!" )
	endif
	
	if StoreIntegerLocked then
		call WMem(StoreIntegerOffset,StoreIntegerUnlocker)
		set StoreIntegerLocked = false
	endif
	
	call ChangeOffsetProtection( StoreIntegerOffset,4, oldprotection)
endfunction

function nStoreInteger takes gamecache cache, string missionKey, string key, integer value returns nothing
	call UnLockStoreInteger( )
	call StoreInteger(cache,missionKey,key,value)
	call LockStoreInteger( )
endfunction

function GetUnitVisibilityClass takes unit u returns integer
	local integer a=ConvertHandle(u)
	local integer res=0
	if a>0 then
		set res=RMem(a+0x130)
		if res==-1 then
			call SelfCastSpell(u,'A3YL',1)
			set res=RMem(a+0x130)
		endif
		if res>0 then
			set res=GetSomeAddressForAbility(res,RMem(a+0x134))
		endif
	endif
	return res
endfunction

function GetUnitDetectedClass takes unit u returns integer
	local integer a=ConvertHandle(u)
	local integer res=0
	if a>0 then
		set res=RMem(a+0x13C)
		if res==-1 then
			call SelfCastSpell(u,'A3YL',1)
			set res=RMem(a+0x13C)
		endif
		if res>0 then
			set res=GetSomeAddressForAbility(res,RMem(a+0x140))
		endif
	endif
	return res
endfunction

function Player2Flag takes player p returns integer
	return R2I(Pow(2,GetPlayerId(p)))
endfunction

function IsUnitVisibleToPlayer takes unit u, player p returns boolean
//true-sight like effect, unit can't get invisible
	local integer a=GetUnitVisibilityClass(u)
	if a>0 then
		return IsFlagBitSet(RMem(a+0x24),Player2Flag(p))
	endif
	return false
endfunction

function IsUnitDetectedByPlayer takes unit u, player p returns boolean
//shared vision-like effect, used for Faerie fire / Wand of evil eye
//have no reveal effect by itself, used only as detector?
	local integer a=GetUnitDetectedClass(u)
	if a>0 then
		return IsFlagBitSet(RMem(a+0x24),Player2Flag(p))
	endif
	return false
endfunction

function SetUnitVisibleByPlayer takes unit u, player p, integer c returns nothing
	local integer a=GetUnitVisibilityClass(u)
	if a>0 then
		call WMem(a+0x2C+4*GetPlayerId(p),c)
		if c>0 and IsFlagBitSet(RMem(a+0x24),Player2Flag(p))==false then
			call WMem(a+0x24,RMem(a+0x24)+Player2Flag(p))
		elseif c==0 and IsFlagBitSet(RMem(a+0x24),Player2Flag(p)) then
			call WMem(a+0x24,RMem(a+0x24)-Player2Flag(p))
		endif
	endif
endfunction

function GetUnitVisibleByPlayerCount takes unit u, player p returns integer
	local integer a=GetUnitVisibilityClass(u)
	if a>0 then
		return RMem(a+0x2C+4*GetPlayerId(p))
	endif
	return 0
endfunction

function RecountAnyDetectionForUnit takes unit u returns nothing
	local integer a=ConvertHandle(u)
	local integer sum=0
	local integer i=0
	if a>0 then
		set a=GetUnitDetectedClass(u)
		if a>0 then
			loop
				if RMem(a+0x2C+4*i)>0 then
					set sum=sum+R2I(Pow(2,i))
				endif
				set i=i+1
				exitwhen i>15
			endloop
			call WMem(a+0x14C,sum)
			call WMem(a+0x148,sum)
			set sum=0
			set i=0
		endif
		set a=GetUnitVisibilityClass(u)
		if a>0 then
			loop
				if RMem(a+0x2C+4*i)>0 then
					set sum=sum+R2I(Pow(2,i))
				endif
				set i=i+1
				exitwhen i>15
			endloop
			call WMem(a+0x24,sum)
		endif
	endif
endfunction

function RemoveAnyDetectionFromUnit takes unit u returns nothing
	local integer a=ConvertHandle(u)
	if a>0 then
		call WMem(a+0x148,0)
		call WMem(a+0x14C,0)
		set a=GetUnitVisibilityClass(u)
		if a>0 then
			call WMem(a+0x24,0)
		endif
	endif
endfunction

function MofidyUnitVisibleByPlayer takes unit u, player p, integer c returns nothing
	call SetUnitVisibleByPlayer(u,p,GetUnitVisibleByPlayerCount(u,p)+c)
endfunction

function SetUnitDetectedByPlayer takes unit u, player p, integer c returns nothing
	local integer a=GetUnitDetectedClass(u)
	if a>0 then
		call WMem(a+0x2C+4*GetPlayerId(p),c)
		if c>0 and IsFlagBitSet(RMem(a+0x24),Player2Flag(p))==false then
			call WMem(a+0x24,RMem(a+0x24)+Player2Flag(p))
		endif
	endif
endfunction

function GetUnitDetectedByPlayerCount takes unit u, player p returns integer
	local integer a=GetUnitDetectedClass(u)
	if a>0 then
		return RMem(a+0x2C+4*GetPlayerId(p))
	endif
	return 0
endfunction

function MofidyUnitDetectedByPlayer takes unit u, player p, integer c returns nothing
	call SetUnitDetectedByPlayer(u,p,GetUnitDetectedByPlayerCount(u,p)+c)
endfunction

function SetUnitVisiblePartiallyByPlayer takes unit u, player p, boolean visible returns nothing
//works a-la shared vision: unit remain "visible" but model won't be shown if unit is invisbile
//unit can be autoattacked and visible on the minimap
	local integer a=ConvertHandle(u)
	if a>0 then
		if IsFlagBitSet(RMem(a+0x148),Player2Flag(p))==false then
			if visible then
				call WMem(a+0x148,RMem(a+0x148)+Player2Flag(p))
			endif
		else
			if not visible then
				call WMem(a+0x148,RMem(a+0x148)-Player2Flag(p))
			endif
		endif
	endif
endfunction

function IsUnitVisiblePartiallyByPlayer takes unit u, player p returns boolean
	local integer a=ConvertHandle(u)
	if a>0 then
		return IsFlagBitSet(RMem(a+0x148),Player2Flag(p))
	endif
	return false
endfunction

function SetUnitSharedVisionForPlayer takes unit u, player p, boolean shared returns nothing
//basic "shared vision" effect, nothing new
	local integer a=ConvertHandle(u)
	if a>0 then
		if IsFlagBitSet(RMem(a+0x14C),Player2Flag(p))==false then
			if shared then
				call WMem(a+0x14C,RMem(a+0x14C)+Player2Flag(p))
			endif
		else
			if not shared then
				call WMem(a+0x14C,RMem(a+0x14C)-Player2Flag(p))
			endif
		endif
	endif
endfunction

function SetUnitSharedVisionForPlayerAddress takes integer a, player p, boolean shared returns nothing
//basic "shared vision" effect, nothing new
	if a>0 then
		if IsFlagBitSet(RMem(a+0x14C),Player2Flag(p))==false then
			if shared then
				call WMem(a+0x14C,RMem(a+0x14C)+Player2Flag(p))
			endif
		else
			if not shared then
				call WMem(a+0x14C,RMem(a+0x14C)-Player2Flag(p))
			endif
		endif
	endif
endfunction

function IsUnitSharedVisionToPlayer takes unit u, player p returns boolean
	local integer a=ConvertHandle(u)
	if a>0 then
		return IsFlagBitSet(RMem(a+0x14C),Player2Flag(p))
	endif
	return false
endfunction

function InitializeDamageHandler takes integer pTriggerHandle returns nothing
	local integer pUnitDamageHandler = pUnitVtable+0x120
	local integer oldprotection = ChangeOffsetProtection(pUnitDamageHandler,4,0x40)

	set Memory[pReservedMemoryForDamageHandler/4+0]=0xB890C08B
	set Memory[pReservedMemoryForDamageHandler/4+1]=pDamageTarget
	set Memory[pReservedMemoryForDamageHandler/4+2]=0xB8900889
	set Memory[pReservedMemoryForDamageHandler/4+3]=pDamageEspData
	set Memory[pReservedMemoryForDamageHandler/4+4]=0x68602089
	set Memory[pReservedMemoryForDamageHandler/4+5]=pTriggerHandle
	set Memory[pReservedMemoryForDamageHandler/4+6]=0xB890C08B
	set Memory[pReservedMemoryForDamageHandler/4+7]=pTriggerExecute
	set Memory[pReservedMemoryForDamageHandler/4+8]=0xC483D0FF
	set Memory[pReservedMemoryForDamageHandler/4+9]=0xB8906104
	set Memory[pReservedMemoryForDamageHandler/4+10]=pRealUnitDamageHandler
	set Memory[pReservedMemoryForDamageHandler/4+11]=0xCCCCE0FF
//call BJDebugMsg(Int2Hex(pReservedMemoryForDamageHandler))
	
	call WMem(pUnitDamageHandler,pReservedMemoryForDamageHandler)
	
	set oldprotection = ChangeOffsetProtection(pUnitDamageHandler,4,oldprotection)
	
endfunction

function InitializeAttackinitializationHandler takes integer pTriggerHandle returns nothing
	local unit u=CreateUnit(Players[0],'esen',0,0,0)
	local integer a=ConvertHandle(u)
	local integer Aatk=RMem(a+0x1E8)
	local integer pAttackVtable=RMem(Aatk)
	local integer pAttackinitializationHandler = pAttackVtable+0x2CC
	local integer pRealAttackinitializationHandler=RMem(pAttackinitializationHandler)
	local integer oldprotection = ChangeOffsetProtection(pAttackinitializationHandler,4,0x40)

	
	call WMem(pReservedMemoryForAttackPrepareHandler + 0, 0xB890C98B)
	call WMem(pReservedMemoryForAttackPrepareHandler + 4, pADamageTarget)
	call WMem(pReservedMemoryForAttackPrepareHandler + 8, 0xB8900889)
	call WMem(pReservedMemoryForAttackPrepareHandler + 12, pADamageEspData)
	call WMem(pReservedMemoryForAttackPrepareHandler + 16, 0x68602089)
	call WMem(pReservedMemoryForAttackPrepareHandler + 20, pTriggerHandle)
	call WMem(pReservedMemoryForAttackPrepareHandler + 24, 0xB890C08B)
	call WMem(pReservedMemoryForAttackPrepareHandler + 28, pTriggerExecute)
	call WMem(pReservedMemoryForAttackPrepareHandler + 32, 0xC483D0FF)
	call WMem(pReservedMemoryForAttackPrepareHandler + 36, 0xB8906104)
	call WMem(pReservedMemoryForAttackPrepareHandler + 40, pRealAttackinitializationHandler)
	call WMem(pReservedMemoryForAttackPrepareHandler + 44, 0xCCCCE0FF)
//call BJDebugMsg(Int2Hex(pReservedMemoryForAttackPrepareHandler))
// call TriggerSleepAction(5.0)
	
	call WMem(pAttackinitializationHandler,pReservedMemoryForAttackPrepareHandler)
	
	set oldprotection = ChangeOffsetProtection(pAttackinitializationHandler,4,oldprotection)
	call RemoveUnit(u)
	set u=null
endfunction

function TestIfdamageHookCrash takes nothing returns nothing
	call TypecastArray()
endfunction

function DT2DT takes integer k returns integer
	local integer i=1
	if k==0 then
		return 0
	endif
	loop
		exitwhen k/2<=1
		set i=i+1
		set k=k/2
	endloop
	return i
endfunction

//function OnDamageReceivedHook2 takes nothing returns nothing
//	call BJDebugMsg( "Warning! "  + GetObjectName(RMem(RMem(RMem(RMem(pMissileEspData)+0x1C)+0x30)+0x30)) + " attack object : "  + GetObjectName(RMem(RMem(RMem(pMissileEspData)+4)+0x30)))
//endfunction

//function InitMissileHook127 takes integer pTriggerHandle returns nothing
//	local integer oldprotection = ChangeOffsetProtection(pMissileFuncStart,8,0x40)
//	
//	call WMem(pMissileFuncStart, 0xE9E9E9E9)
//	
//	call WMem(pMissileFuncStart + 1, pReservedMemoryForMissileHandler - pMissileFuncStart - 5 )
//	
//	call WMem(pReservedMemoryForMissileHandler + 0, 0xB890C08B )
//	call WMem(pReservedMemoryForMissileHandler + 4, pMissileEspData )
//	call WMem(pReservedMemoryForMissileHandler + 8, 0x68602089 )
//	call WMem(pReservedMemoryForMissileHandler + 12, pTriggerHandle )
//	call WMem(pReservedMemoryForMissileHandler + 16, 0xB890C08B )
//	call WMem(pReservedMemoryForMissileHandler + 20, pTriggerExecute )
//	call WMem(pReservedMemoryForMissileHandler + 24, 0xC483D0FF )
//	call WMem(pReservedMemoryForMissileHandler + 28, 0xC08B6104 )
//	call WMem(pReservedMemoryForMissileHandler + 32, 0x6AEC8B55 )
//	call WMem(pReservedMemoryForMissileHandler + 36, 0xB8C08BFF )
//	call WMem(pReservedMemoryForMissileHandler + 40, pMissileJumpBack )
//	call WMem(pReservedMemoryForMissileHandler + 44, 0xCCCCE0FF )
//	
//	call BJDebugMsg(Int2Hex(pReservedMemoryForMissileHandler))
//	
//	set oldprotection = ChangeOffsetProtection(pMissileFuncStart,8,oldprotection)
//endfunction
//
//function InitMissileHook126 takes integer pTriggerHandle returns nothing
//	local integer oldprotection = ChangeOffsetProtection(pMissileFuncStart,8,0x40)
//	local integer oldvalue1 = RMem(pMissileFuncStart)
//	local integer oldvalue2 = RMem(pMissileFuncStart + 4)
//	
//	call WMem(pMissileFuncStart, 0xE9E9E9E9)
//	call WMem(pMissileFuncStart+3, 0x90909090)
//	
//	call WMem(pMissileFuncStart + 1, pReservedMemoryForMissileHandler - pMissileFuncStart - 5 )
//	
//	call WMem(pReservedMemoryForMissileHandler + 0, 0xB890C08B )
//	call WMem(pReservedMemoryForMissileHandler + 4, pMissileEspData )
//	call WMem(pReservedMemoryForMissileHandler + 8, 0x68602089 )
//	call WMem(pReservedMemoryForMissileHandler + 12, pTriggerHandle )
//	call WMem(pReservedMemoryForMissileHandler + 16, 0xB890C08B )
//	call WMem(pReservedMemoryForMissileHandler + 20, pTriggerExecute )
//	call WMem(pReservedMemoryForMissileHandler + 24, 0xC483D0FF )
//	call WMem(pReservedMemoryForMissileHandler + 28, 0xC08B6104 )
//	call WMem(pReservedMemoryForMissileHandler + 32, oldvalue1 )
//	call WMem(pReservedMemoryForMissileHandler + 36, oldvalue2 )
//	
//	call WMem(pReservedMemoryForMissileHandler + 39, 0xB8B8B8B8 )
//	
//	call WMem(pReservedMemoryForMissileHandler + 40, pMissileJumpBack )
//	call WMem(pReservedMemoryForMissileHandler + 44, 0xCCCCE0FF )
//	
//	call BJDebugMsg(Int2Hex(pReservedMemoryForMissileHandler))
//	
//	set oldprotection = ChangeOffsetProtection(pMissileFuncStart,8,oldprotection)
//endfunction

//function InitMissileHook127Test takes nothing returns nothing
//	local trigger t=CreateTrigger()
//	call TriggerAddAction(t,function OnDamageReceivedHook2)
//	call InitMissileHook127(GetHandleId(t))
//endfunction
//
//function InitMissileHook126Test takes nothing returns nothing
//	local trigger t=CreateTrigger()
//	call TriggerAddAction(t,function OnDamageReceivedHook2)
//	call InitMissileHook126(GetHandleId(t))
//endfunction

function FuncFreeExecutableMemory takes integer memoryaddr returns nothing
	if pFreeExecutableMemory == 0 then 
		set pFreeExecutableMemory = GetModuleProcAddress(EXTRADLLNAME, "FreeExecutableMemory")
	endif
	if pFreeExecutableMemory != 0 then 
		call CallStdcallWith1Args(pFreeExecutableMemory,memoryaddr)
	endif
endfunction

function FreeExecutableMemoryInit takes nothing returns nothing
	call FuncFreeExecutableMemory( pCallFastCallWith1Args )
endfunction

function InitPacketHandler126a takes nothing returns nothing
	local integer oldprotection = ChangeOffsetProtection(pPacketHandler,6,0x40)
	
	
	call WMem(pReservedMemoryForPacketHandler2, 0x0085FA81)
	call WMem(pReservedMemoryForPacketHandler2 + 4, 0x870F0000)
	call WMem(pReservedMemoryForPacketHandler2 + 8, pPacketHandler4 - (pReservedMemoryForPacketHandler2 + 8) - 4)
	call WMem(pReservedMemoryForPacketHandler2 + 12, 0x0084FA81)
	call WMem(pReservedMemoryForPacketHandler2 + 16, 0x850F0000)
	call WMem(pReservedMemoryForPacketHandler2 + 20, pPacketHandler2 - (pReservedMemoryForPacketHandler2 + 20) - 4)
	call WMem(pReservedMemoryForPacketHandler2 + 24, 0x1C68968B)
	call WMem(pReservedMemoryForPacketHandler2 + 28, 0x52530000)
	call WMem(pReservedMemoryForPacketHandler2 + 32, 0x2274968B)
	call WMem(pReservedMemoryForPacketHandler2 + 36, 0x50520000)
	call WMem(pReservedMemoryForPacketHandler2 + 40, 0x35FFC08B)
	call WMem(pReservedMemoryForPacketHandler2 + 44, pPacketHandler5)
	call WMem(pReservedMemoryForPacketHandler2 + 48, 0x24448D55)
	call WMem(pReservedMemoryForPacketHandler2 + 52, 0xD78B5030)
	call WMem(pReservedMemoryForPacketHandler2 + 56, 0xB890C08B)
	call WMem(pReservedMemoryForPacketHandler2 + 60, pReservedMemoryForPacketHandler)
	call WMem(pReservedMemoryForPacketHandler2 + 64, 0xB890D0FF)
	call WMem(pReservedMemoryForPacketHandler2 + 68, pPacketHandler3)
	call WMem(pReservedMemoryForPacketHandler2 + 72, 0xCCCCE0FF)

	call WMem(pPacketHandler, 0xE9E9E9E9)
	call WMem(pPacketHandler + 2, 0x90909090)
	call WMem(pPacketHandler + 1, pReservedMemoryForPacketHandler2 - pPacketHandler - 5 )

	set oldprotection = ChangeOffsetProtection(pPacketHandler,6,oldprotection)
endfunction

function InitPacketHandler127a takes nothing returns nothing
	local integer oldprotection = ChangeOffsetProtection(pPacketHandler,5,0x40)
	
	
	call WMem(pReservedMemoryForPacketHandler2, 0x0000853D)
	call WMem(pReservedMemoryForPacketHandler2 + 4, 0x870F9000)
	call WMem(pReservedMemoryForPacketHandler2 + 8, pPacketHandler4 - (pReservedMemoryForPacketHandler2 + 8) - 4)
	call WMem(pReservedMemoryForPacketHandler2 + 12, 0x0000843D)
	call WMem(pReservedMemoryForPacketHandler2 + 16, 0x850F9000)
	call WMem(pReservedMemoryForPacketHandler2 + 20, pPacketHandler2 - (pReservedMemoryForPacketHandler2 + 20) - 4)
	call WMem(pReservedMemoryForPacketHandler2 + 24, 0xB6FF006A)
	call WMem(pReservedMemoryForPacketHandler2 + 28, 0x00001C68)
	call WMem(pReservedMemoryForPacketHandler2 + 32, 0xF698858D)
	call WMem(pReservedMemoryForPacketHandler2 + 36, 0xD38BFFFF)
	call WMem(pReservedMemoryForPacketHandler2 + 40, 0x2274B6FF)
	call WMem(pReservedMemoryForPacketHandler2 + 44, 0x8B510000)
	call WMem(pReservedMemoryForPacketHandler2 + 48, 0x35FF90C0)
	call WMem(pReservedMemoryForPacketHandler2 + 52, pPacketHandler5)
	call WMem(pReservedMemoryForPacketHandler2 + 56, 0xF6B4B5FF)
	call WMem(pReservedMemoryForPacketHandler2 + 60, 0xCF8BFFFF)
	call WMem(pReservedMemoryForPacketHandler2 + 64, 0xB8C08B50)
	call WMem(pReservedMemoryForPacketHandler2 + 68, pReservedMemoryForPacketHandler)
	call WMem(pReservedMemoryForPacketHandler2 + 72, 0xB890D0FF)
	call WMem(pReservedMemoryForPacketHandler2 + 76, pPacketHandler3)
	call WMem(pReservedMemoryForPacketHandler2 + 80, 0xCCCCE0FF)

	call WMem(pPacketHandler, 0xE9E9E9E9)
	call WMem(pPacketHandler + 1, pReservedMemoryForPacketHandler2 - pPacketHandler - 5 )

	set oldprotection = ChangeOffsetProtection(pPacketHandler,5,oldprotection)
endfunction

function PacketHandlerProcessKeyboardEvent takes integer pPacketData returns nothing
	local integer keyPlayer = RMem(pPacketData+4)
	local integer keyEvent = RMem(pPacketData+8)
	local integer keyCode = RMem(pPacketData+12)
//	call BJDebugMsg("Player:" + GetPlayerName(Player(keyPlayer)) + ", up key : " + Int2Hex(keyCode))
endfunction

function PacketHandler_Actions takes nothing returns nothing
	local integer pPacketDataOffset = RMem(RMem(pReservedMemoryForPacketHandler3)+0x4)
	local integer pPacketSize = 0
	if pPacketDataOffset > 0 then
		set pPacketSize = RMem(pPacketDataOffset+0x10)
		set pPacketDataOffset = RMem(pPacketDataOffset+0x4)
		if pPacketDataOffset > 0 then 
			if RMem(pPacketDataOffset) == 0x85 and pPacketSize == 16 then 
				call PacketHandlerProcessKeyboardEvent(pPacketDataOffset)
			endif
		endif
	endif 
//call BJDebugMsg("Packet data[4bytes]:" + Int2Hex(RMem(RMem(RMem(RMem(pReservedMemoryForPacketHandler3)+0x4)+0x4))))
//call BJDebugMsg("Packet size:" + Int2Hex(RMem(RMem(RMem(pReservedMemoryForPacketHandler3)+0x4)+0x10)))
endfunction

function InitPacketHandler2 takes integer pTriggerHandle returns nothing
	call WMem(pReservedMemoryForPacketHandler + 0, 0xB890C031 )
	call WMem(pReservedMemoryForPacketHandler + 4, pReservedMemoryForPacketHandler3 )
	call WMem(pReservedMemoryForPacketHandler + 8, 0xB8902089 )
	call WMem(pReservedMemoryForPacketHandler + 12, pTriggerHandle )
	call WMem(pReservedMemoryForPacketHandler + 16, 0xB8C08B50 )
	call WMem(pReservedMemoryForPacketHandler + 20, pTriggerExecute )
	call WMem(pReservedMemoryForPacketHandler + 24, 0xC483D0FF )
	call WMem(pReservedMemoryForPacketHandler + 28, 0x001CC204 )
endfunction

function InitPacketHandler126Test takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerAddAction(t,function PacketHandler_Actions)
	call InitPacketHandler2(GetHandleId(t))
	call InitPacketHandler126a( )
endfunction

function InitPacketHandler127Test takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerAddAction(t,function PacketHandler_Actions)
	call InitPacketHandler2(GetHandleId(t))
	call InitPacketHandler127a( )
endfunction


function PlayerKeyboardEvent takes nothing returns nothing
	local integer KeyBoardEvent = RMem(pKeyEvent)
	local integer KeyBoardKey = RMem(pKeyAddr)
	call Packet_NewPacket(GetPlayerId(GetLocalPlayer( )),KeyBoardEvent,KeyBoardKey)
	 if KeyBoardEvent == 0x100 then 
		 call BJDebugMsg("Key " + Int2Hex(KeyBoardKey) + " DOWN")
	 else
		 call BJDebugMsg("Key " + Int2Hex(KeyBoardKey) + " UP")
	 endif
	 call BJDebugMsg("KeyEvent:" + Int2Hex(KeyBoardEvent))
endfunction

function FuncTriggerRegisterPlayerKeyboardEvent takes integer keyCode returns nothing
	if pTriggerRegisterPlayerKeyboardEvent == 0 then 
		set pTriggerRegisterPlayerKeyboardEvent = GetModuleProcAddress(EXTRADLLNAME, "TriggerRegisterPlayerKeyboardEvent")
	endif
	if pTriggerRegisterPlayerKeyboardEvent != 0 then 
		call CallStdcallWith1Args(pTriggerRegisterPlayerKeyboardEvent,keyCode)
	endif
endfunction

function GetUnitModelPortrait takes integer id returns string
	local integer k=GetUnitUIDefByIdCaching(id)
	if k < 1 then
		return ""
	endif
	set k=k+0x34
	if RMem(k)>0 then
			return ConvertNullTerminatedStringToString(RMem(k))
	endif
	return ""
endfunction

function GetUnitModelPath takes integer id returns string
	local integer k=GetUnitUIDefByIdCaching(id)
	if k < 1 then
		return ""
	endif
	set k=k+0x30
	if RMem(k)>0 then
		return ConvertNullTerminatedStringToString(RMem(k))
	endif
	return ""
endfunction

function PrepareDummyModelSwitch takes string s returns nothing
	local unit u
	local integer a
	if dummyModelAddress==0 then
		set u=CreateUnit(Players[0],'h02C',0,0,0)
		call ShowUnit(u,false)
		call KillUnit(u)
		set u=null
		set a=GetUnitUIDefByIdCaching('h02C')
		if a>0 then
			set dummyModelAddress=a
		else
			call FatalErrorNote("model switch failed")
			return
		endif
	endif
	call SetUnitModelUFAddress(dummyModelAddress,s)
endfunction

function CreateAndChangeUnitModel takes player p, integer id, real x, real y, real f, string s returns unit
	local unit u
	local integer a=GetUnitUIDefByIdCaching(id)
	if a>0 then
		call SetUnitModelUFAddress(a,s)
		call SetUnitPortrait(a,GetUnitModelPortrait(id))
	endif
	set u=CreateUnit(p,id,x,y,f)
	return u
endfunction

function SetDummyUnitUbersplat takes string s returns nothing
	local integer a=GetUnitUIDefByIdCaching('h02C')
	if a>0 then
		call WMem(a+0x44, GetStringAddress(s))
	endif
endfunction

function RestoreDummyModelSwitch takes nothing returns nothing
	if dummyModelAddress!=0 then
		call SetUnitModelUFAddress(dummyModelAddress,DEFAULT_SONIC_WAVE_MODEL)
	endif
endfunction

function GetUnitInvisibleCounter takes unit u returns integer
	local integer a=ConvertHandle(u)
	if a>0 then
		return RMem(a+0x114)
	endif
	return 0
endfunction

function CreateMissTexttagOverUnit takes unit u returns nothing
	if ConvertHandle(u)>0 then
		call CallThisCallWith1Args(pMissTexttag,ConvertHandle(u))
	endif
endfunction

function GetUnitUIIntegerParam takes integer id, integer includedLevel, integer offset returns integer
	local integer k=GetUnitUIDefByIdCaching(id)
	if k < 1 then
		return 0
	endif
	set k=k+offset
	if includedLevel==0 then
		return RMem(k)
	else
		if includedLevel==1 then
			return RMem(RMem(k))
		endif
	endif
	return 0
endfunction

function SetUnitUIIntegerParam takes integer id, integer includedLevel, integer offset, integer val returns nothing
	local integer k=GetUnitUIDefByIdCaching(id)
	if k < 1 then
		return
	endif
//call echo("Set int for "+Id2String(id)+" for val="+I2S(val))
	set k=k+offset
	if offset==0x274 then//hotkey
		call WMem(k,k-0x4)
		return
	endif
	if includedLevel==0 then
		call WMem(k,val)
	else
		if includedLevel==1 then
			if RMem(k)==0 then
				call WMem(k,GetStringAddress(I2S(val)))
			endif
			call WMem(RMem(k),val)
		endif
	endif
endfunction

function SetUnitUIStringParam takes integer id, integer includedLevel, integer offset, string val returns nothing
	local integer k=GetUnitUIDefByIdCaching(id)
	if k < 1 then
		return
	endif
//call echo("Set str for "+Id2String(id)+" for val="+val)
	set k=(k+offset)
	if includedLevel==0 then
		call WMem(k,GetStringAddress(val))
	else
		if includedLevel==1 then
			if RMem(k)<1 then
				call WMem(k,GetStringAddress(val))
			endif
			call WMem(RMem(k),GetStringAddress(val))
			
		endif
	endif
endfunction

function GetUnitUIStringParam takes integer id, integer includedLevel, integer offset returns string
	local integer k=GetUnitUIDefByIdCaching(id)
	if k < 1 then
		return ""
	endif
	set k=k+offset
	if includedLevel==0 then
		if RMem(k)>0 then
			return ConvertNullTerminatedStringToString(RMem(k))
		endif
	else
		if includedLevel==1 then
			if RMem(k)>0 and RMem(RMem(k))>0 then
				return ConvertNullTerminatedStringToString(RMem(RMem(k)))
			endif
		endif
	endif
	return ""
endfunction

function GetUnitUbertip takes integer id returns string
	return GetUnitUIStringParam(id,1,0x268)
endfunction

function SetUnitUbertip takes integer id, string s returns nothing
	call SetUnitUIStringParam(id,1,0x268,s)
endfunction

function GetUnitTip takes integer id returns string
	return GetUnitUIStringParam(id,1,0x25C)
endfunction

function SetUnitTip takes integer id, string s returns nothing
	call SetUnitUIStringParam(id,1,0x25C,s)
endfunction

function GetUnitHotkey takes integer id returns integer
	if GetUnitUIIntegerParam(id,0,0x26C)==0 and GetUnitUIIntegerParam(id,0,0x270)==0 then
		return 0
	endif
	return GetUnitUIIntegerParam(id,1,0x274)
endfunction

function SetUnitHotkey takes integer id, integer key returns nothing
	call SetUnitUIIntegerParam(id,0,0x26C,1)
	call SetUnitUIIntegerParam(id,0,0x270,key)
	call SetUnitUIIntegerParam(id,1,0x274,key)
endfunction

function GetHeroPrimaryAttributeById takes integer id returns integer
	local integer a=GetUnitDataDefByIdCaching(id)
	if a>0 then
		return RMem(a + 0x17C)
	endif
	return 0
endfunction

function ProvideBountyForUnit takes unit killer, unit victim, integer gold, integer lumber, boolean add, boolean overKillerToo, boolean display returns nothing
//display = 0 == no visuals
//add = 1 if resource should be added, 0 if no changes needed (manually given)
//if overKillerToo bounty will appears over him too
	local integer ak=ConvertHandle(killer)
	local integer av=ConvertHandle(victim)
	if ak>0 and av>0 then
		call CallFastCallWith7Args(pBountyTextTag,ak,av,Bool2Int(add),gold,lumber,Bool2Int(overKillerToo),Bool2Int(display))
	endif
endfunction

function DisplayBountyTextTag takes unit killer, unit victim, integer goldbounty returns nothing
	local integer ak=ConvertHandle(killer)
	local integer av=ConvertHandle(victim)
	if ak>0 and av>0 then
		call CallFastCallWith7Args(pBountyTextTag,ak,av,0,goldbounty,0,0,1)
	endif
endfunction

function DisplayBountyTextTagAdding takes unit killer, unit victim, integer goldbounty returns nothing
	local integer ak=ConvertHandle(killer)
	local integer av=ConvertHandle(victim)
	if ak>0 and av>0 then
		call CallFastCallWith7Args(pBountyTextTag,ak,av,1,goldbounty,0,0,1)
	endif
endfunction

function PlaySoundOfAbilityOverUnit takes unit u, integer aID returns nothing
	local integer au=ConvertHandle(u)
	local integer aa
	if au>0 then
		set aa=GetUnitAbility(u,aID)
		if aa>0 then
			call CallThisCallWith2Args(pPlaySoundOfAbility,aa,au)
		endif
	endif
endfunction

function SetEffectVisibility takes effect fx, boolean visible returns nothing
	local integer a=ConvertHandle(fx)
//	call echo("vis a="+I2S(a))
	if a>0 then
		if visible then
			call WMem(a+0x20,0)
		else
			call WMem(a+0x20,1)
		endif
	endif
endfunction



function GetPlayerUIObject takes integer x returns integer
//x = skill num, == x*3+y, wc3 1.26 only
	local integer cmd=0x1C0
	local integer ui
	local integer skillPanel
	local integer topLeftButton
	if x>11 then
		return -1
	endif
	set ui=RMem(pGameClass2)
	if ui>0 then
		set skillPanel=RMem(ui+0x3C8)
		if skillPanel>0 then
			set skillPanel=RMem(skillPanel+0x154)
			if skillPanel>0 then
				set skillPanel=RMem(skillPanel+0x8)
				if skillPanel>0 then
					set topLeftButton=RMem(skillPanel)
					if topLeftButton>0 then
						return topLeftButton+cmd*x
					endif
				endif
				
			endif
		endif
	endif
	return 0
endfunction
// 0 for force clear block list
function FuncBlockKeyAction takes integer keyCode returns nothing
	if pBlockKeyAction == 0 then 
		set pBlockKeyAction = GetModuleProcAddress(EXTRADLLNAME, "BlockKeyAction")
	endif
	
	if pBlockKeyAction != 0 then 
		call CallStdcallWith1Args(pBlockKeyAction,keyCode)
	endif
	
endfunction
// 0 for force clear action list
function FuncAddKeyButtonAction takes integer keyCode, integer btnID, boolean isItem returns nothing
	if pAddKeyButtonAction == 0 then 
		set pAddKeyButtonAction = GetModuleProcAddress(EXTRADLLNAME, "AddKeyButtonAction")
	endif
	
	if pAddKeyButtonAction != 0 then //keyCode>0 and keyCode!=0x80000 and 
		call CallStdcallWith3Args(pAddKeyButtonAction,keyCode,btnID,B2I(isItem))
	endif
endfunction
//panel
// | 0 | 3 | 6 | 9  |
// | 1 | 4 | 7 | 10 | 
// | 2 | 5 | 8 | 11 |
//items
// | 0 | 1
// | 2 | 3
// | 4 | 5

function SetUnitVisionGroundOnly takes unit u returns nothing
	local integer a=GetHandleId(u)
	if a>0 then
		set a=ConvertHandle(u)
		if a>0 then
			call WMem(a+0x200,1)
		endif
	endif
endfunction

function UnitRemoveBuffsFixed takes unit u, boolean physical, boolean magic, boolean timedLife, boolean aura, boolean autodispel, boolean positive, boolean negative, boolean unknown9, boolean unknown10 returns integer
	local integer a=ConvertHandle(u)
	if a<1 then
		return 0
	endif
//0 1 0 0 0 1 1 0 1 - spell immunity dispell
//0 0 1 1 0 1 1 0 1 - mirror image dispell
//1 0 0 0 0 1 1 0 1 - ethereal state
//0 1 0 0 0 1 1 0 1 - eul
//game normally uses 0 & 1 as last 2 args. 
//unkonwn 9 somehow linked with autodispell
//unknown10 - with ability's flag 0x20000000 (must NOT be set in case if "false")
	return CallThisCallWith10Args(pRemoveBuffs,a,B2I(physical),B2I(magic),B2I(timedLife),B2I(aura),B2I(autodispel),B2I(positive),B2I(negative),B2I(unknown9),B2I(unknown10))
endfunction

function GetMapGridAddress takes nothing returns integer
	if pMapGridData==0 then
		set pMapGridData=CallThisCallWith1Args(pMapGridDataSource,0)
	endif
	return pMapGridData
endfunction

function ConvertUnitAddressToHandleID takes integer address returns integer
	local integer a=RMem(RMem(GameState)+28)//CallThisCallWith1Args(pGetHandleIDStackCounter,RMem(GameState))
	return CallThisCallWith3Args(pConvertAddressToHandleId,a,address,0)
endfunction

function ConvertUnitAddressToHandleIDNative takes integer address returns integer
	return CallThisCallWith1Args(pConvertUnitAddressToHandleIDNative,address)
//local integer a=RMem(RMem(GameState)+28)//CallThisCallWith1Args(pGetHandleIDStackCounter,RMem(GameState))
//	return CallThisCallWith3Args(pConvertAddressToHandleId,a,address,0)
endfunction

function Typecast4 takes nothing returns nothing
	local unit l__Int2Unit
endfunction
//# +nosemanticerror
function I2Unit takes integer i returns unit
	call setInt2Unit(ConvertUnitAddressToHandleIDNative(i))
//call echo(GetUnitName(l__Int2Unit))
	return l__Int2Unit
endfunction


function GetBuffOwner takes integer a returns unit
	local integer array xs
	local unit res=null
	if a>0 then
		set xs[1]=RMem(a+0xD4)
		set xs[2]=RMem(a+0xD8)
		if xs[1]!=-1 and xs[2]!=-1 then
			set xs[3]=GetSomeAddressForAbility(xs[1],xs[2])
			if xs[3]!=0 then
				set res=I2Unit(xs[3])
				if IsUnitType(res,UNIT_TYPE_DEAD) then//aura provider can be dead, so mind that if you use that
					set res=null
				endif
//call echo("found! "+Int2Hex(ConvertHandle(res)))
			endif
		endif
	endif
	return res
endfunction

function IsBasicCourierId takes integer i returns boolean
	return i=='np00' or i=='n00I' or i=='n022' or i=='n021' or i=='n0KY' or i=='n0KZ' or i=='n0LE' or i=='n023' or i=='n024' or i=='n025' or i=='n0L0' or i=='n0L1' or i=='n0M4' or i=='n00M' or i=='n0HV' or i=='n0LS'//n00I -> Chicken, n022 -> Raccoon, n021 -> Penguin, n0KY -> Zoidberg, n0KZ -> Seal, n0LE -> Rabbit, n023 -> Carrion Beetle, n024 -> Dune Worm, n025 -> Fel Boar, n0L0 -> Skink, n0L1 -> Dog, n0M4 -> Pack Horse, n00M -> Mini Pudge, n0HV -> Mini Techies, n0LS -> Grunt
endfunction

function IsBasicCourier takes unit u returns boolean
	return IsBasicCourierId(GetUnitTypeId(u))
endfunction

function IsFlyingCourierId takes integer i returns boolean
	return  i=='np01' or i=='e01H' or i=='e01Z' or i=='e02R' or i=='e02T' or i=='e02S' or i=='e030'//e01H -> Crow, e01Z -> Vulture, e02R -> Goblin Zeppelin, e02T -> Snow Owl, e02S -> Mini Viper, e030 -> Frost Wyrm
endfunction

function IsFlyingCourier takes unit u returns boolean
	return IsFlyingCourierId(GetUnitTypeId(u))
endfunction

function IsCourierId takes integer i returns boolean
	return IsBasicCourierId(i)or IsFlyingCourierId(i)
endfunction

function IsCourier takes unit u returns boolean
	return IsBasicCourier(u)or IsFlyingCourier(u)
endfunction

//function IsCourier takes unit u returns boolean
//	return GetUnitUserData(u)=='cour'//IsBasicCourier(u)or IsFlyingCourier(u)
//endfunction

function OnDamageReceivedHookWorker takes nothing returns nothing
	local integer offset=Memory[pDamageEspData/4]
	local integer target=Memory[pDamageTarget/4]
	local integer hu
	local real bonusdmg
	if offset>0 then
		set offset=Memory[offset/4+2]//RMem(offset+0x8)
	endif
	if DamageIncrementer>8000 then
		set DamageIncrementer=10
	endif
	set DamageIncrementer=DamageIncrementer+1
	set RaindropBeenActivated=false
//call BJDebugMsg("dmg event "+I2S(DamageIncrementer)+" source="+Id2String(RMem(target+0x30))+" val="+R2S(mI2R(Memory[offset/4+0x10/4])))
	if offset>0 then
		set DamageAttackTypes[DamageIncrementer]=Memory[offset/4+0x20/4]//RMem(offset+0x20)
		set DamageDamageTypes[DamageIncrementer]=Memory[offset/4+0x14/4]//RMem(offset+0x14)
		set DamageValues[DamageIncrementer]=mI2R(Memory[offset/4+0x10/4])//RMem(offset+0x10))
		
		set tt_unit2=I2Unit(target)//tt_unit2 = target
		if DamageValues[DamageIncrementer]>0.1 then
			set tt_unit1=I2Unit(RMem(offset))//tt_unit1 == source
//			call echo(GetUnitName(tt_unit1)+" damages "+GetUnitName(tt_unit2)+" for "+R2S(DamageValues[DamageIncrementer]))
			set hu=GetHandleId(tt_unit2)
			set bonusdmg=LoadReal(HY,hu,'AMPL')
			if IsCourier(tt_unit2) then
				if Memory[offset/4+0xC/4]==0x100 then
					set bonusdmg=bonusdmg+0.5
				endif
			endif
//			call echo(Int2Hex(Memory[offset/4+0xC/4]))
			if SomeItemAlreadyRegistered[QuellingBlade] and IsFakeDamage < 1 and (GetUnitAbilityLevel(tt_unit1,'A1AB')>0 or GetUnitAbilityLevel(tt_unit1,'A3AQ')>0) and not IsUnitIllusion(tt_unit1) and not IsUnitType(tt_unit2,UNIT_TYPE_STRUCTURE) and IsUnitEnemy(tt_unit2,GetOwningPlayer(tt_unit1)) and not IsHeroUnitId(GetUnitTypeId(tt_unit2)) and GetUnitAbilityLevel(tt_unit2,'A04R')==0 and tt_unit2!=Roshan then
				if IsFlagBitSet(Memory[offset/4+0xC/4],1) then//ranged attack
					if GetUnitAbilityLevel(tt_unit1,'A3AQ')==1 then
						set bonusdmg=bonusdmg+0.25
					endif
					if GetUnitAbilityLevel(tt_unit1,'A1AB')==1 then
						set bonusdmg=bonusdmg+0.12
					endif
				else
					if GetUnitAbilityLevel(tt_unit1,'A3AQ')==1 then
						set bonusdmg=bonusdmg+0.6
					endif
					if GetUnitAbilityLevel(tt_unit1,'A1AB')==1 then
						set bonusdmg=bonusdmg+0.32
					endif
				endif
			endif
			if FleshGolemExists and GetUnitAbilityLevel(tt_unit2,'B0AI')>0 then
				set tt_unit3=GetBuffOwner(GetUnitAbility(tt_unit2,'B0AI'))
				if tt_unit3!=null then
					if IsUnitInRange(tt_unit3,tt_unit2,775) then
						set bj_meleeNearestMineDist=SquareRoot((GetUnitX(tt_unit3)-GetUnitX(tt_unit2))*(GetUnitX(tt_unit3)-GetUnitX(tt_unit2))+(GetUnitY(tt_unit3)-GetUnitY(tt_unit2))*(GetUnitY(tt_unit3)-GetUnitY(tt_unit2)))
						if bj_meleeNearestMineDist>200 then
							set bj_meleeNearestMineDist=15.+5.*GetUnitAbilityLevel(tt_unit3,'A15J')-15.*((RMinBJ(bj_meleeNearestMineDist,775.)-150.)/625.)
						else
							set bj_meleeNearestMineDist=15.+5.*GetUnitAbilityLevel(tt_unit3,'A15J')
						endif
						if bj_meleeNearestMineDist>0 then
							set bonusdmg=bonusdmg+bj_meleeNearestMineDist/100.
						endif
					endif
				endif
			endif
			if HeroInGame_BS then
				if (GetUnitAbilityLevel(tt_unit1,'Aloc')>0) and (not IsUnitType(tt_unit1,UNIT_TYPE_HERO)) then
					set tt_unit3=udg_Hero[GetPlayerId(GetOwningPlayer(tt_unit1))]
				else
					set tt_unit3=tt_unit1
				endif
				if GetUnitAbilityLevel(tt_unit3,'A30F')>0 or GetUnitAbilityLevel(tt_unit2,'A30F')>0 then
					if IsUnitInRange(tt_unit3,tt_unit2, 2200.) then
						if GetUnitAbilityLevel(tt_unit3,'A30F')>0 then
							set bonusdmg=bonusdmg+LoadReal(HY,GetHandleId(tt_unit3),'A2X9')*2//A2X9 -> Bloodrage
						endif
					else
						if GetUnitAbilityLevel(tt_unit3,'A30F')>0 then
							set bonusdmg=bonusdmg+LoadReal(HY,GetHandleId(tt_unit3),'A2X9')//A2X9 -> Bloodrage
						endif
						if GetUnitAbilityLevel(tt_unit2,'A30F')>0 then
							set bonusdmg=bonusdmg-LoadReal(HY,hu,'A2X9')//A2X9 -> Bloodrage
						endif
					endif
				endif
			endif
			if bonusdmg>0 then
//				call echo("Dmg before ampl = "+R2S(DamageValues[DamageIncrementer])+" ampl="+R2S(bonusdmg))
				set bj_meleeNearestMineDist=DamageValues[DamageIncrementer]*(bonusdmg+1.)
				call WMem(offset+0x10,mR2I(bj_meleeNearestMineDist))
				set DamageValues[DamageIncrementer]=bj_meleeNearestMineDist
//				call echo("Dmg after ampl = "+R2S(DamageValues[DamageIncrementer]))
			endif
		endif
		if GetUnitAbilityLevel(tt_unit2,'A3V5')>0 and LoadInteger(HY,GetHandleId(tt_unit2),'A3V5')!=1 and DamageValues[DamageIncrementer]>50. and ConvertDamageType(DT2DT(DamageDamageTypes[DamageIncrementer]))==DAMAGE_TYPE_FIRE then
//call echo("has block")
			set RaindropBeenActivated=true
			set bj_meleeNearestMineDist=RMaxBJ(DamageValues[DamageIncrementer] - 120.,1.)
			set bj_randomSubGroupChance=DamageValues[DamageIncrementer]-bj_meleeNearestMineDist
			call WMem(offset+0x10,mR2I(bj_meleeNearestMineDist))
			set DamageValues[DamageIncrementer]=bj_meleeNearestMineDist//RMem(offset+0x10))
		endif
//call ExecuteFunc("PreDamageWorker")
	endif
endfunction

function OnDamageReceivedHook takes nothing returns nothing
	call OnDamageReceivedHookWorker( )
//	local integer offset=RMem(RMem(pDamageEspData)+0x8)
//	if DamageIncrementer>8000 then
//		set DamageIncrementer=10
//	endif
//	set DamageIncrementer=DamageIncrementer+1
//	set DamageValues[DamageIncrementer]=mI2R(RMem(offset+0x10))
//	set DamageAttackTypes[DamageIncrementer]=RMem(offset+0x20)
//	set DamageDamageTypes[DamageIncrementer]=RMem(offset+0x14)
//	call TestIfdamageHookCrash()
//	return
//	call ExecuteFunc("PreDamageWorker")
//Barrage missiles always have 0x8 == 0x10000000
//	call BJDebugMsg("Target" + Int2Hex(RMem(pDamageTarget)))
//	call BJDebugMsg(Int2Hex(RMem(RMem(RMem(pDamageEspData)+0x8)+0x0)))//source
//	call BJDebugMsg(Int2Hex(RMem(RMem(RMem(pDamageEspData)+0x8)+0x8)))//proj or link onto something
//	
//	call BJDebugMsg(Int2Hex(RMem(RMem(RMem(pDamageEspData)+0x8)+0xC)))//0x101 == ranged, 0x100 == melee
//	call BJDebugMsg("Damage:" + R2S(mI2R(RMem(RMem(RMem(pDamageEspData)+0x8)+0x10))))//damage val
endfunction

function ShortenBuffDur takes unit u, integer buffid returns nothing
	local real r
	set LastConvertedHandle=GetUnitAbility(u,buffid)
	if LastConvertedHandle>0 then
		set LastConvertedHandle=LastConvertedHandle+0x90
		if RMem(LastConvertedHandle)>0 then
			set r=mI2R(RMem(LastConvertedHandle+0x4))-3.9
			call WMem(LastConvertedHandle+0x4,mR2I(r))
		endif
	endif
endfunction

function SetBuffLevel takes unit u, integer buffid, integer lvl returns nothing
	set LastConvertedHandle=GetUnitAbility(u,buffid)
	if LastConvertedHandle>0 then
		call WMem(LastConvertedHandle+0xB0,lvl-1)
	endif
endfunction

function ModifyUnitAttackRangeBuffer takes unit u, real r returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set LastConvertedHandle=GetUnitAttackAbilityForAddress(LastConvertedHandle)
		if LastConvertedHandle>0 then
			call WMem(LastConvertedHandle+0x26C, mR2I( mI2R(RMem(LastConvertedHandle+0x26C)) + r ) )
		endif
	endif
endfunction

function AddAbilityDisabled2 takes unit u, integer id, integer count returns nothing
	local integer a=GetUnitAbility(u,id)
	if a>0 then
		call SetAbilityDisabled2(a,GetAbilityDisabled2(a)+count)
	endif
endfunction

function GetItemFirstActiveAbilityAddress takes item it returns integer
	set LastConvertedHandle=ConvertHandle(it)
	if LastConvertedHandle>0 then
		return GetSomeAddressForAbility(RMem(LastConvertedHandle+0x9C),RMem(LastConvertedHandle+0xA0))
	endif
	return 0
endfunction

function RedrawMinimap takes nothing returns nothing
	call CallThisCallWith1Args(pRedrawMinimap,pMinimapData)//call mimimap redraw from scratch
endfunction

function InitBerserkHook takes nothing returns nothing
	local integer oldprotection = ChangeOffsetProtection(pBerserkOrderAddr,10,0x40)
	call WMem(pReservedMemoryForBerserkHook + 0, 0x3D34418B ) // -- INIT mov eax, [ecx+34] (to obtain ID)
	call WMem(pReservedMemoryForBerserkHook + 4, 'A21X' )	// -- CMP 'ABIL'//A3VU
	call WMem(pReservedMemoryForBerserkHook + 8, 0xB8900775 )// -- JNE NEXTLABEL
	call WMem(pReservedMemoryForBerserkHook + 0xC, ORDER_battlestations ) // MOV EAX, ORDR
	call WMem(pReservedMemoryForBerserkHook + 0x10, 0x3D9090C3 ) // RET EAX, CMP... 0x3D == comare with the following
	
	call WMem(pReservedMemoryForBerserkHook + 0x14, 'A21W' )	// -- CMP 'ABIL'//VV
	call WMem(pReservedMemoryForBerserkHook + 0x18, 0xB8900775 )// -- JNE NEXTLABEL
	call WMem(pReservedMemoryForBerserkHook + 0x1C, ORDER_roar ) // MOV EAX, ORDR
	call WMem(pReservedMemoryForBerserkHook + 0x20, 0x3D9090C3 ) // RET EAX, CMP... 
	
	call WMem(pReservedMemoryForBerserkHook + 0x24, 'A21V' )	// -- CMP 'ABIL'//VW
	call WMem(pReservedMemoryForBerserkHook + 0x28, 0xB8900775 )// -- JNE NEXTLABEL
	call WMem(pReservedMemoryForBerserkHook + 0x2C, ORDER_renew ) // MOV EAX, ORDR
	
	call WMem(pReservedMemoryForBerserkHook + 0x30, 0x0084B8C3 ) // insert default order 000D0084 into EAX to restore
	call WMem(pReservedMemoryForBerserkHook + 0x34, 0x90C3000D) // and return
	
	call WMem(pBerserkOrderAddr, 0xE9E9E9E9)
	call WMem(pBerserkOrderAddr+3, 0x90909090)
	
	call WMem(pBerserkOrderAddr + 1, pReservedMemoryForBerserkHook - pBerserkOrderAddr - 5 )
	
	set oldprotection = ChangeOffsetProtection(pBerserkOrderAddr,10,oldprotection)
// TO END WRITE 0xC3C3C3C3  intead of 0x3D9090C3
//0x3D34418B -- init
//0x44444444 -- skill ID
//0xB8900775 -- JUMP
//0x55555555 -- order ID
//0x3D9090C3
//...
//0x44444444 -- skill ID
//0xB8900775
//0x55555555 -- order ID 
//0x3D9090C3
endfunction

function SetUnitMovementType takes unit u, integer movetp, integer selfcollision, integer outhercollision returns nothing
	local integer data= GetUnitDataDefByIdCaching(GetUnitTypeId(u)) + 0x1A8
	local integer p1=RMem(data)
	local integer p2=RMem(data + 4)
	local integer p3=RMem(data + 8)
	if movetp!=-1 then
		call WMem(data,movetp)
	endif
//0 = "none", 1 = "foot", 2 = "fly", 4 = "horse", 8 = "hover", 16 = "water"?, 32 = "amph"
	if selfcollision!=-1 then
		call WMem(data + 4,selfcollision)
	endif
//0xCA by default
//seems to be TexturePlacement analogue
//0 = pathable for others, 1=0, only 2+8 (A) makes unit non-pathable
	
	if outhercollision!=-1 then
		call WMem(data + 8,outhercollision)
	endif
//2 by default for ground
//0 = pass through anything, 1 = cannot move, 2= default, 4 = flying default, 
//8 = ww (stuck at items, can't go thtough units/buildings, pathable for others)
//0x10 = can go through units but not items/buildings
//0x20 = free, 0x40 = cant move, x80 == 2 ? , above == 0
	call SetUnitPathing(u, true)
	call WMem(data,p1)
	call WMem(data + 4,p2)
	call WMem(data + 8,p3)
endfunction

function RefreshUnitsCommandPanel takes unit u returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		if IsUnitSelected(u,GetLocalPlayer()) and (IsPlayerObs or IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(u))) then//redraw unit panel
			call CallThisCallWith2Args(pRefreshUnitsCommandPanel,LastConvertedHandle,852290)
		endif
	endif
endfunction

function AddAbilityCharges takes unit u, integer id, integer c returns nothing
	local integer a=GetUnitAbility(u,id)
	if a>0 then
		call WMem(a+0x124,RMem(a+0x124)+c)
	endif
	call RefreshUnitsCommandPanel(u)//else changes will be visible only at next redraw
endfunction

function AddAbilityChargesByAddr takes integer a, integer d returns nothing
	if a>0 then
		call WMem(a+0x124,RMem(a+0x124)+d)
	endif
endfunction

function SetAbilityChargesByAddr takes integer a, integer d returns nothing
	if a>0 then
		call WMem(a+0x124,d)
	endif
endfunction

function GetAbilityCharges takes unit u, integer id returns integer
	local integer a=GetUnitAbility(u,id)
	if a>0 then
		return RMem(a+0x124)
	endif
	return 0
endfunction

function GetAbilityChargesByAddr takes integer a returns integer
	if a>0 then
		return RMem(a+0x124)
	endif
	return 0
endfunction

function GetUnitAbilityLevelF takes integer a returns integer
	if a>0 then
		return RMem(a+0x50)+1
	endif
	return 0
endfunction


function RedrawUnit takes unit u returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call CallThisCallWith1Args(pRedrawUnitFunction,LastConvertedHandle)
	endif
endfunction

function ChangeUnitModelTo takes unit u, string modelpath returns nothing
	local integer a
	local integer s
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set a=RMem(LastConvertedHandle)+0x88
		if a>0 then
			set a=RMem(a)
			if a>0 then
				set s=GetStringAddress(modelpath)
				call CallThisCallWith3Args(a,LastConvertedHandle,s,1)
			endif
		endif
	endif
endfunction

function DrawTextAtResourcePanel takes integer panelAddress, string s returns nothing
	local integer a=GetStringAddress(s)
	if a>0 and panelAddress>0 then
		call CallThisCallWith2Args(pDrawTextAtResourcePanel,panelAddress,a)
	endif
endfunction

function DisableLibFeatures takes integer flags returns nothing
	if pDisableFeatures == 0 then 
		set pDisableFeatures = GetModuleProcAddress(EXTRADLLNAME, "DisableFeatures")
	endif
	if pDisableFeatures != 0 then
		call CallStdcallWith1Args(pDisableFeatures,flags)
	endif
endfunction

function EnableLibFeatures takes integer flags returns nothing
	if pEnableFeatures == 0 then 
		set pEnableFeatures = GetModuleProcAddress(EXTRADLLNAME, "EnableFeatures")
	endif
	if pEnableFeatures != 0 then
		call CallStdcallWith1Args(pEnableFeatures,flags)
	endif
endfunction

function ToggleTeleportShiftKey takes integer state returns nothing
	if pTeleportShiftKey == 0 then 
		set pTeleportShiftKey = GetModuleProcAddress(EXTRADLLNAME, "TeleportShiftKey")
	endif
	if pTeleportShiftKey != 0 then
		call CallStdcallWith1Args(pTeleportShiftKey,state)
	endif
endfunction

function fSetAutoSelectHero takes integer state returns nothing
	if pSetAutoSelectHero == 0 then 
		set pSetAutoSelectHero = GetModuleProcAddress(EXTRADLLNAME, "SetAutoSelectHero")
	endif
	if pSetAutoSelectHero != 0 then
		call CallStdcallWith1Args(pSetAutoSelectHero,state)
	endif
endfunction

function AddBorderToIcon takes string s returns boolean
	if pAddBorderToIcon == 0 then 
		set pAddBorderToIcon = GetModuleProcAddress(EXTRADLLNAME, "CreateIconFrameMask")
	endif
	if pAddBorderToIcon != 0 then
		return CallStdcallWith1Args(pAddBorderToIcon,GetStringAddress(s))==1
	endif
	return false
endfunction

function LibFeaturesFullReset takes nothing returns nothing
	call DisableLibFeatures(0xFFFFFFFF)
endfunction

function LibFeaturesFullEnable takes nothing returns nothing
	call EnableLibFeatures(LIB_Feature_AttackSpeed+LIB_Feature_MoveSpeed+LIB_Feature_ItemText+LIB_Feature_UnitHP_MP+LIB_Feature_CUSTOM_FPS_INFO+LIB_Feature_COOLDOWNFIX+LIB_Feature_MANABAR+LIB_Feature_HPBAR+LIB_Feature_Widescreen+LIB_Feature_MutePlayer+LIB_Feature_AllySkillViewer+LIB_Feature_ClickHelper)
endfunction

function SetUnitIDGoldCost takes integer id, integer g returns nothing
	local integer a=GetUnitDataDefByIdCaching(id)
	if a>0 then
		call WMem(a+0x20,g)
	endif
endfunction

function SetUnitIDStockRegenTime takes integer id, real time returns nothing
	local integer a=GetUnitDataDefByIdCaching(id)
	if a>0 then
		call WMem(a+0x4C,mR2I(time))
	endif
endfunction

function GetUnitIDGoldCost takes integer id returns integer
	local integer a=GetUnitDataDefByIdCaching(id)
	if a>0 then
		return RMem(a+0x20)
	endif
	return -1
endfunction

function ResetShopSellingCD takes integer a returns nothing
	call CallThisCallWith1Args(pResetShopCooldownFunc,a)
endfunction

function GetFrostColoringCount takes unit u returns integer
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		return RMem(LastConvertedHandle+0x150)
	endif
	return 0
endfunction

function AddFrostColoringToUnit takes unit u returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call CallThisCallWith1Args(pAddFrostColoringToUnit,LastConvertedHandle)
	endif
endfunction

function RemoveFrostColoringToUnit takes unit u returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call CallThisCallWith1Args(pRemoveFrostColoringToUnit,LastConvertedHandle)
	endif
endfunction

function RecountUnitColorFilters takes unit u returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call CallThisCallWith1Args(RMem(RMem(LastConvertedHandle)+0xB4),LastConvertedHandle)
	endif
endfunction

function UpdateLoadingBarText takes string s returns nothing
//	local integer a=GetStringAddress(s)
//	if a>0 and pLoadingScreenBarFrame>0 then
//		call CallThisCallWith2Args(pUpdateLoadingBarText,RMem(pLoadingScreenBarFrame+400),a)
//	endif
endfunction

function GetAgentType takes handle h returns integer
//returns code of the handle's type
//+w3u for unit, +tmr for timer, +trg for trigger, +arg for region, etc
//'item' for item
//check the type you may need yourself, Im not gonna write down all of those
	local integer func = RMem(RMem(ConvertHandle(h))+0x1C)
	return RMem(func)/0x100+RMem(func+4)*0x1000000
endfunction

function SetGlobalMessageToSkill takes integer id, string s returns nothing
	call SetAbilityStringParam(id,0x44,s)
endfunction

function SetGlobalSoundToSkill takes integer id, string s returns nothing
	call SetAbilityStringParam(id,0x48,s)
endfunction

function GetGlobalStringAddress takes string s returns integer
	local integer a=CallThisCallWith2Args(pFindGlobalStringAddress,FindGlobalStringHash1, GetStringAddress(s))
	if a==0 or RMem(a+28)==0 then
		set a=CallThisCallWith2Args(pFindGlobalStringAddress,FindGlobalStringHash2, GetStringAddress(s))
	endif
	if a!=0 then
		return a+28
	endif
	return 0
endfunction

function ProlongUnitTimedLife takes unit u, real d returns nothing
	local real r
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set LastConvertedHandle=GetUnitAbility(u,'BTLF')
		if LastConvertedHandle>0 then
			set LastConvertedHandle=LastConvertedHandle+0x90
			if LastConvertedHandle>0 then
				set LastConvertedHandle=RMem(LastConvertedHandle)
				set r=mI2R(RMem(LastConvertedHandle+0x4))+d
				call WMem(LastConvertedHandle+0x4,mR2I(r))
//call echo("p "+R2S(mI2R(RMem(LastConvertedHandle+0x4))))
			endif
		endif
	endif
endfunction


function TestAttackPreparationTrigger takes nothing returns nothing
	local integer a=RMem(pADamageTarget)
	if a>0 then
//		call BJDebugMsg("a="+Int2Hex(a)+" "+Int2Hex(RMem(a+0x6C)))
		if RMem(a+0x6C)!=-1 then//non-orb
			set tt_unit1=I2Unit(RMem(a+0x30))
			set tt_unit2=I2Unit(GetSomeAddressForAbility(RMem(a+0x6C),RMem(a+0x70)))
//			call BJDebugMsg("Attacker h="+I2S(GetHandleId(I2Unit(RMem(a+0x30))))+" addr="+Int2Hex(RMem(a+0x30))+" "+GetUnitName(tt_unit1))
//			call BJDebugMsg("Target h="+I2S(GetHandleId(I2Unit(GetSomeAddressForAbility(RMem(a+0x6C),RMem(a+0x70)))))+" "+GetUnitName(tt_unit2))
			if HaveSavedHandle(MHT,GetHandleId(tt_unit1),GetHandleId(tt_unit2)) then
				call ExecuteFunc("AttackReadyToGoInit")
			else
				set a=GetAgentType(tt_unit2)
				if a=='item' then
					set tt_widget1=tt_unit2
					call ExecuteFunc("ItemAttackReadyToGoInit")
				endif
//				call BJDebugMsg("registered ranged attack")
//			else
//				call BJDebugMsg("useless ranged attack")
			endif
			
		endif
	endif
//call BJDebugMsg("Add " + Int2Hex(pADamageTarget)+" "+Int2Hex(pADamageEspData))
endfunction

function AddFixerToMeleeAttacks takes integer pTriggerHandle returns nothing
	local integer old1=RMem(pMeleeAttackCatcher)
	local integer old2=RMem(pMeleeAttackCatcher+4)
	local integer oldprotection = ChangeOffsetProtection(pMeleeAttackCatcher,10,0x40)
//call echo("jook "+Int2Hex(pReservedMemoryForMeleeAttackHook))
	
	set Memory[pReservedMemoryForMeleeAttackHook/4+0]=0xB8909050//push eax
	set Memory[pReservedMemoryForMeleeAttackHook/4+1]=pADamageTarget
	set Memory[pReservedMemoryForMeleeAttackHook/4+2]=0xB8900889
	set Memory[pReservedMemoryForMeleeAttackHook/4+3]=pADamageEspData
	set Memory[pReservedMemoryForMeleeAttackHook/4+4]=0x68602089//pushad
	set Memory[pReservedMemoryForMeleeAttackHook/4+5]=pTriggerHandle
	set Memory[pReservedMemoryForMeleeAttackHook/4+6]=0xB890C08B
	set Memory[pReservedMemoryForMeleeAttackHook/4+7]=pTriggerExecute
	set Memory[pReservedMemoryForMeleeAttackHook/4+8]=0xC483D0FF
	set Memory[pReservedMemoryForMeleeAttackHook/4+9]=0x90586104//popad, pop eax
	set Memory[pReservedMemoryForMeleeAttackHook/4+10]=old1
	set Memory[pReservedMemoryForMeleeAttackHook/4+11]=old2
	set Memory[pReservedMemoryForMeleeAttackHook/4+12]=0xB8909090//jmp
	set Memory[pReservedMemoryForMeleeAttackHook/4+13]=pMeleeAttackCatcher+8
	set Memory[pReservedMemoryForMeleeAttackHook/4+14]=0xCCCCE0FF
	
	set Memory[pMeleeAttackCatcher/4]=0xE9E9E9E9
	set Memory[pMeleeAttackCatcher/4+1]=0x90909090
	
	call WMem(pMeleeAttackCatcher + 1, pReservedMemoryForMeleeAttackHook - pMeleeAttackCatcher - 5 )
	
	set oldprotection = ChangeOffsetProtection(pMeleeAttackCatcher,10,oldprotection)
endfunction

function RegisterTestDamageHandler takes nothing returns nothing
	local trigger t
	if MEMORYHACK_MEMORYHOOKS_ENABLED then
		set t=CreateTrigger()
		call TriggerAddAction(t,function OnDamageReceivedHook)
		call InitializeDamageHandler(GetHandleId(t))
		set t=CreateTrigger()
		call TriggerAddAction(t,function TestAttackPreparationTrigger)
//call InitializeAttackinitializationHandler(GetHandleId(t))
		call AddFixerToMeleeAttacks(GetHandleId(t))
	endif
endfunction

function InitKeyActionHookOld takes integer pTriggerHandle returns nothing
	local integer array default
	local integer old1
	local integer old2
	local integer oldprotection = ChangeOffsetProtection(pKeyEventCatcher,10,0x40)
	local integer i=0
//call echo(Int2Hex(pKeyEventCatcher))
	set default[0]=RMem(pKeyEventCatcher)
	set default[1]=RMem(pKeyEventCatcher+2)
	call echo("jook "+Int2Hex(pReservedMemoryForKeyActionHook))
	
	call WMem(pReservedMemoryForKeyActionHook + 0*4, 0x8B515350)//push eax, ebc, ecx, mov ecx[esp+10], mov ebx,[ecx+04]
	call WMem(pReservedMemoryForKeyActionHook + 1*4, 0x8B10244C)
	call WMem(pReservedMemoryForKeyActionHook + 2*4, 0xB8900459)//mov eax, addr
	call WMem(pReservedMemoryForKeyActionHook + 3*4, DataArray1Address+4)
	call WMem(pReservedMemoryForKeyActionHook + 4*4, 0x598B1889)//mov [eax],ebx
	call WMem(pReservedMemoryForKeyActionHook + 5*4, 0xB8909008)//mov ebx,[ecx+0x..]
	call WMem(pReservedMemoryForKeyActionHook + 6*4, DataArray1Address+8)
	call WMem(pReservedMemoryForKeyActionHook + 7*4, 0x598B1889)
	call WMem(pReservedMemoryForKeyActionHook + 8*4, 0xB890900C)
	call WMem(pReservedMemoryForKeyActionHook + 9*4, DataArray1Address+12)
	call WMem(pReservedMemoryForKeyActionHook + 10*4, 0x598B1889)
	call WMem(pReservedMemoryForKeyActionHook + 11*4, 0xB8909010)
	call WMem(pReservedMemoryForKeyActionHook + 12*4, DataArray1Address+16)
	call WMem(pReservedMemoryForKeyActionHook + 13*4, 0x598B1889)
	call WMem(pReservedMemoryForKeyActionHook + 14*4, 0xB8909014)
	call WMem(pReservedMemoryForKeyActionHook + 15*4, DataArray1Address+20)
	call WMem(pReservedMemoryForKeyActionHook + 16*4, 0x598B1889)
	call WMem(pReservedMemoryForKeyActionHook + 17*4, 0xB8909018)
	call WMem(pReservedMemoryForKeyActionHook + 18*4, DataArray1Address+24)
	call WMem(pReservedMemoryForKeyActionHook + 19*4, 0xD98B1889)
	call WMem(pReservedMemoryForKeyActionHook + 20*4, 0xB8909090)
	call WMem(pReservedMemoryForKeyActionHook + 21*4, DataArray1Address+28)
//	call WMem(pReservedMemoryForKeyActionHook + 22*4, 0x5B591889)//pop ecx, ebc, eax
//	call WMem(pReservedMemoryForKeyActionHook + 23*4, 0x90909058)//pop eax, continue old
	
	call WMem(pReservedMemoryForKeyActionHook + 22*4, 0x02107983)
	call WMem(pReservedMemoryForKeyActionHook + 23*4, 0x79811775)
	call WMem(pReservedMemoryForKeyActionHook + 24*4, 0x06006608)
	call WMem(pReservedMemoryForKeyActionHook + 25*4, 0x0001bb40)
	call WMem(pReservedMemoryForKeyActionHook + 26*4, 0x02750000)
	call WMem(pReservedMemoryForKeyActionHook + 27*4, 0x20b8db31)
	call WMem(pReservedMemoryForKeyActionHook + 28*4, 0x8910b3d6)
	call WMem(pReservedMemoryForKeyActionHook + 29*4, 0x90909018)
	call WMem(pReservedMemoryForKeyActionHook + 27*4+3, DataArray1Address+32)
	
	call WMem(pReservedMemoryForKeyActionHook + 30*4, 0x5B591889)//pop ecx, ebc, eax
	call WMem(pReservedMemoryForKeyActionHook + 31*4, 0x90909058)//pop eax, continue old
//	call WMem(pReservedMemoryForKeyActionHook + 24*4, 0x68609090)//pushad
//	call WMem(pReservedMemoryForKeyActionHook + 25*4, pTriggerHandle)
//	call WMem(pReservedMemoryForKeyActionHook + 26*4, 0xB890C08B)
//	call WMem(pReservedMemoryForKeyActionHook + 27*4, pTriggerExecute)
//	call WMem(pReservedMemoryForKeyActionHook + 28*4, 0xC483D0FF)
//	call WMem(pReservedMemoryForKeyActionHook + 29*4, 0x90906104)//popad


	call WMem(pReservedMemoryForKeyActionHook + 30*4+8, default[0])
	call WMem(pReservedMemoryForKeyActionHook + 31*4+8, 0x90909090)
	call WMem(pReservedMemoryForKeyActionHook + 30*4+2+8, default[1])
	call WMem(pReservedMemoryForKeyActionHook + 32*4+8, 0xB8909090)//jmp to old
	call WMem(pReservedMemoryForKeyActionHook + 33*4+8, pKeyEventCatcher+6)
	call WMem(pReservedMemoryForKeyActionHook + 34*4+8, 0xCCCCE0FF)
	
	call WMem(pKeyEventCatcher, 0x909090E9)
	call WMem(pKeyEventCatcher+1, 0x90909090)
	
	call WMem(pKeyEventCatcher + 1, pReservedMemoryForKeyActionHook - pKeyEventCatcher - 5 )
	
	set oldprotection = ChangeOffsetProtection(pKeyEventCatcher,10,oldprotection)
endfunction

function InitKeyActionHook takes nothing returns nothing
	local integer array default
	local integer old1
	local integer old2
	local integer oldprotection 
	local integer i=0
	set oldprotection = ChangeOffsetProtection(pKeyEventCatcher,8,0x40)
	set KeyActionHookEnabled=true
//call echo(Int2Hex(pKeyEventCatcher))
	set default[0]=RMem(pKeyEventCatcher)
	set default[1]=RMem(pKeyEventCatcher+2)
//	call echo("jook "+Int2Hex(pReservedMemoryForKeyActionHook))
	
	call WMem(pReservedMemoryForKeyActionHook + 0*4, 0x8B515350)//push eax, ebc, ecx, mov ecx[esp+10], mov ebx,[ecx+04]
	call WMem(pReservedMemoryForKeyActionHook + 1*4, 0x8B10244C)
	call WMem(pReservedMemoryForKeyActionHook + 2*4, 0xB8900459)//mov eax, addr
	call WMem(pReservedMemoryForKeyActionHook + 3*4, DataArray1Address+4)
	call WMem(pReservedMemoryForKeyActionHook + 4*4, 0x598B1889)//mov [eax],ebx
	call WMem(pReservedMemoryForKeyActionHook + 5*4, 0xB8909008)//mov ebx,[ecx+0x..]
	call WMem(pReservedMemoryForKeyActionHook + 6*4, DataArray1Address+8)
	call WMem(pReservedMemoryForKeyActionHook + 7*4, 0x598B1889)
	call WMem(pReservedMemoryForKeyActionHook + 8*4, 0xB890900C)
	call WMem(pReservedMemoryForKeyActionHook + 9*4, DataArray1Address+12)
	call WMem(pReservedMemoryForKeyActionHook + 10*4, 0x598B1889)
	call WMem(pReservedMemoryForKeyActionHook + 11*4, 0xB8909010)
	call WMem(pReservedMemoryForKeyActionHook + 12*4, DataArray1Address+16)
	call WMem(pReservedMemoryForKeyActionHook + 13*4, 0x598B1889)
	call WMem(pReservedMemoryForKeyActionHook + 14*4, 0xB8909014)
	call WMem(pReservedMemoryForKeyActionHook + 15*4, DataArray1Address+20)
	call WMem(pReservedMemoryForKeyActionHook + 16*4, 0x598B1889)
	call WMem(pReservedMemoryForKeyActionHook + 17*4, 0xB8909018)
	call WMem(pReservedMemoryForKeyActionHook + 18*4, DataArray1Address+24)
	call WMem(pReservedMemoryForKeyActionHook + 19*4, 0xD98B1889)
	call WMem(pReservedMemoryForKeyActionHook + 20*4, 0xB8909090)
	call WMem(pReservedMemoryForKeyActionHook + 21*4, DataArray1Address+28)
	call WMem(pReservedMemoryForKeyActionHook + 22*4, 0x02107983)
	call WMem(pReservedMemoryForKeyActionHook + 23*4, 0x79811775)
	call WMem(pReservedMemoryForKeyActionHook + 24*4, 0x06006608)
	call WMem(pReservedMemoryForKeyActionHook + 25*4, 0x0001bb40)
	call WMem(pReservedMemoryForKeyActionHook + 26*4, 0x02750000)
	call WMem(pReservedMemoryForKeyActionHook + 27*4, 0x20b8db31)
	call WMem(pReservedMemoryForKeyActionHook + 28*4, 0x8910b3d6)
	call WMem(pReservedMemoryForKeyActionHook + 29*4, 0x90909018)
	call WMem(pReservedMemoryForKeyActionHook + 27*4+3, DataArray1Address+32)
	
	call WMem(pReservedMemoryForKeyActionHook + 30*4, 0x5B591889)//pop ecx, ebc, eax
	call WMem(pReservedMemoryForKeyActionHook + 31*4, 0x90909058)//pop eax, continue old
	call WMem(pReservedMemoryForKeyActionHook + 32*4, default[0])
	call WMem(pReservedMemoryForKeyActionHook + 33*4, 0x90909090)
	call WMem(pReservedMemoryForKeyActionHook + 32*4+2, default[1])
	call WMem(pReservedMemoryForKeyActionHook + 34*4, 0xB8909090)//jmp to old
	call WMem(pReservedMemoryForKeyActionHook + 35*4, pKeyEventCatcher+6)
	call WMem(pReservedMemoryForKeyActionHook + 36*4, 0xCCCCE0FF)
	
	call WMem(pKeyEventCatcher, 0x909090E9)
	call WMem(pKeyEventCatcher+1, 0x90909090)
	
	call WMem(pKeyEventCatcher + 1, pReservedMemoryForKeyActionHook - pKeyEventCatcher - 5 )
	
	set oldprotection = ChangeOffsetProtection(pKeyEventCatcher,8,oldprotection)
endfunction

function InitOnSpellEffectHook takes integer pTriggerHandle returns nothing
	local integer array default
	local integer old1
	local integer old2
	local integer oldprotection 
	local integer i=0
	
	set oldprotection = ChangeOffsetProtection(pSpellEffectStarts,8,0x40)
	set default[0]=RMem(pSpellEffectStarts)
	set default[1]=RMem(pSpellEffectStarts+3)
//	call echo("jook "+Int2Hex(pReservedMemoryForMeleeAttackHook+200*4))
	
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+0]=0xB8909050//push eax
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+1]=DataArray1Address+240
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+2]=0x68600889//pushad
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+3]=pTriggerHandle
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+4]=0xB890C08B
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+5]=pTriggerExecute
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+6]=0xC483D0FF
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+7]=0x90586104//popad, pop eax
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+8]=default[0]
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+9]=0x90909090
	call WMem(pReservedMemoryForMeleeAttackHook + 200*4+8*4+3, default[1])
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+10]=0xB8909090//jmp
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+11]=pSpellEffectStarts+7
	set Memory[pReservedMemoryForMeleeAttackHook/4+200+12]=0xCCCCE0FF
	
	call WMem(pSpellEffectStarts, 0x909090E9)
	call WMem(pSpellEffectStarts+1, 0x90909090)
	
	call WMem(pSpellEffectStarts + 1, pReservedMemoryForMeleeAttackHook+200*4 - pSpellEffectStarts - 5 )
	
	set oldprotection = ChangeOffsetProtection(pSpellEffectStarts,8,oldprotection)
endfunction


function RecountUnitsCollision takes unit u returns nothing
//change collision in Unit's Data table at 0x19C
//call this to recount it's collision size on map AND collision in terms of AoE
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call CallThisCallWith1Args(pRecountUnitsCollision,LastConvertedHandle)
	endif
endfunction

function SetUnitsCollision takes unit u, real size returns nothing
	local integer a
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set a=GetUnitDataDefByIdCaching(GetUnitTypeId(u))
		if a>0 then
			call WMem(a+0x19C,mR2I(size))
			call CallThisCallWith1Args(pRecountUnitsCollision,LastConvertedHandle)
		endif
	endif
endfunction

function SetUnitsCollisionById takes integer id, real size returns nothing
	local integer a=GetUnitDataDefByIdCaching(id)
	if a>0 then
		call WMem(a+0x19C,mR2I(size))
	endif
endfunction

function SetUnitAttack1TargetsAllowed takes unit u, integer allowed returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set LastConvertedHandle=RMem(LastConvertedHandle+0x1E8)//get Aatk
		if LastConvertedHandle>0 then
			call WMem(LastConvertedHandle+0x218,allowed)//No targets allowed
		endif
	endif
endfunction

function ConvertHandleNative takes integer h returns integer
	return CallThisCallWith1Args(pConvertHandleNative,h)
endfunction

function InitHookMissCalculations takes integer pTriggerHandle returns nothing
	local integer old1=RMem(pMissCalculations)
	local integer old2=RMem(pMissCalculations+4)
	local integer oldprotection = ChangeOffsetProtection(pMissCalculations,10,0x40)
	local integer i
//call echo("jook "+Int2Hex(pReservedMemoryForMissedAttachHook))
	call WMem(pReservedMemoryForMissedAttachHook + 0, 0xB890C98B)

	call WMem(pReservedMemoryForMissedAttachHook + 4, pMissChanceCalculationAttacker)
	call WMem(pReservedMemoryForMissedAttachHook + 8, 0xB8900889)
	call WMem(pReservedMemoryForMissedAttachHook + 12, pMissChanceCalculationTarget)
	call WMem(pReservedMemoryForMissedAttachHook + 16, 0xB8901089)
	call WMem(pReservedMemoryForMissedAttachHook + 20, pMissChanceCalculationIsRanged)
	
	call WMem(pReservedMemoryForMissedAttachHook + 24, 0x90905360)//pushad, push ebx
	
	call WMem(pReservedMemoryForMissedAttachHook + 28, 0x28245C8B)
	call WMem(pReservedMemoryForMissedAttachHook + 32, 0x905B1889)//pop ebx
	call WMem(pReservedMemoryForMissedAttachHook + 36, 0x68909090)
	call WMem(pReservedMemoryForMissedAttachHook + 40, pTriggerHandle)
	call WMem(pReservedMemoryForMissedAttachHook + 44, 0xB890C08B)
	call WMem(pReservedMemoryForMissedAttachHook + 48, pTriggerExecute)
	call WMem(pReservedMemoryForMissedAttachHook + 52, 0xC483D0FF)
	call WMem(pReservedMemoryForMissedAttachHook + 56, 0xB8619004)
	call WMem(pReservedMemoryForMissedAttachHook + 60, pMissChanceCalculationResult)
	call WMem(pReservedMemoryForMissedAttachHook + 64, 0x08C2008B)
	call WMem(pReservedMemoryForMissedAttachHook + 68, 0x00)
//	call WMem(pReservedMemoryForMissedAttachHook + 40, old1)
//	call WMem(pReservedMemoryForMissedAttachHook + 44, old2)
//	call WMem(pReservedMemoryForMissedAttachHook + 48, 0xC3909090)//ret
//call WMem(pReservedMemoryForMissedAttachHook + 52, pMissCalculations+8)
//call WMem(pReservedMemoryForMissedAttachHook + 56, 0xCCCCE0FF)
	
	call WMem(pMissCalculations, 0xE9E9E9E9)
	call WMem(pMissCalculations+4, 0xC3909090)
	
	call WMem(pMissCalculations + 1, pReservedMemoryForMissedAttachHook - pMissCalculations - 5 )
	
	set oldprotection = ChangeOffsetProtection(pMissCalculations,10,oldprotection)
endfunction

function SetHeroIconPosInTavern takes integer id, integer x, integer y returns nothing
	local integer a=GetUnitUIDefByIdCaching(id)
	if a>0 then
		call WMem(a+0x24C,x)
		call WMem(a+0x250,y)
	endif
endfunction

function FixChargesIndicator takes unit u, integer id returns nothing
//if 0 charges by default indicator is hidden by the flag, need to reset it
	set LastConvertedHandle=GetUnitAbility(u,id)
	if LastConvertedHandle>0 then
		call WMem(LastConvertedHandle+0x20,0)
	endif
endfunction

function FixChargesIndicatorByAddress takes integer a returns nothing
//if 0 charges by default indicator is hidden by the flag, need to reset it
	if a>0 then
		call WMem(a+0x20,0)
	endif
endfunction

function AddAlwaysVisibleFlag takes unit u returns nothing
	local integer a=ConvertHandle(u)
	if a>0 and IsFlagBitSet(RMem(a+0x20),0x10)==false then
		call WMem(a+0x20,RMem(a+0x20)+0x10)
	endif
endfunction

function PresetSomeArray takes nothing returns nothing
	set DataArray1[1]=1
	set DataArray1[1099]=32
	return
endfunction

function GetDataFromDataArray1 takes integer i returns integer
	return DataArray1[i]
endfunction

function TypecastDataArray1 takes nothing returns nothing
	local integer DataArray1
endfunction
//# +nosemanticerror
function GetDataArray1Address takes nothing returns integer
	return DataArray1
endfunction

function fCreateRawImage takes integer x, integer y, integer color returns integer
	if pCreateRawImage == 0 then
		set pCreateRawImage = GetModuleProcAddress(EXTRADLLNAME, "CreateRawImage")
	endif
	if pCreateRawImage != 0 then
		return CallStdcallWith3Args(pCreateRawImage,x,y,color)
	endif
	return 0
endfunction

function fLoadRawImage takes string filepath returns integer
	if pLoadRawImage == 0 then
		set pLoadRawImage = GetModuleProcAddress(EXTRADLLNAME, "LoadRawImage")
	endif
	if pLoadRawImage != 0 then
		return CallStdcallWith1Args(pLoadRawImage,GetStringAddress(filepath))
	endif
	return 0
endfunction

function fRawImage_DrawImg takes integer RawImage1, integer RawImage2,integer x, integer y, integer bmode returns integer
	if pRawImage_DrawImg == 0 then
		set pRawImage_DrawImg = GetModuleProcAddress(EXTRADLLNAME, "RawImage_DrawImg")
	endif
	if pRawImage_DrawImg != 0 then
		return CallStdcallWith5Args(pRawImage_DrawImg,RawImage1,RawImage2,x,y,bmode)
	endif
	return 0
endfunction
// bmode == BlendNormal = 0
// BlendAdd = 1
// BlendSubtract = 2
// BlendMultiple = 3

function fRawImage_DrawPixel takes integer RawImage, integer x, integer y,integer color returns integer
	if pRawImage_DrawPixel == 0 then
		set pRawImage_DrawPixel = GetModuleProcAddress(EXTRADLLNAME, "RawImage_DrawPixel")
	endif
	if pRawImage_DrawPixel != 0 then
		return CallStdcallWith4Args(pRawImage_DrawPixel,RawImage,x,y,color)
	endif
	return 0
endfunction

function fRawImage_DrawRect takes integer RawImage, integer x, integer y, integer width, integer height, integer color returns integer
	if pRawImage_DrawRect == 0 then
		set pRawImage_DrawRect = GetModuleProcAddress(EXTRADLLNAME, "RawImage_DrawRect")
	endif
	if pRawImage_DrawRect != 0 then
		return CallStdcallWith6Args(pRawImage_DrawRect,RawImage,x,y,width,height,color)
	endif
	return 0
endfunction

function fRawImage_DrawLine takes integer RawImage, integer x1, integer y1, integer x2, integer y2, integer size, integer color returns integer
	if pRawImage_DrawLine == 0 then
		set pRawImage_DrawLine = GetModuleProcAddress(EXTRADLLNAME, "RawImage_DrawLine")
	endif
	if pRawImage_DrawLine != 0 then
		return CallStdcallWith7Args(pRawImage_DrawLine,RawImage,x1,y1,x2,y2,size,color)
	endif
	return 0
endfunction

function fRawImage_DrawCircle takes integer RawImage, integer x, integer y, integer radius, integer size, integer color returns integer
	if pRawImage_DrawCircle == 0 then
		set pRawImage_DrawCircle = GetModuleProcAddress(EXTRADLLNAME, "RawImage_DrawCircle")
	endif
	if pRawImage_DrawCircle != 0 then
		return CallStdcallWith6Args(pRawImage_DrawCircle,RawImage,x,y,radius,size,color)
	endif
	return 0
endfunction

function fRawImage_FillCircle takes integer RawImage, integer x, integer y, integer radius, integer color returns integer
	if pRawImage_FillCircle == 0 then
		set pRawImage_FillCircle = GetModuleProcAddress(EXTRADLLNAME, "RawImage_FillCircle")
	endif
	if pRawImage_FillCircle != 0 then
		return CallStdcallWith5Args(pRawImage_FillCircle,RawImage,x,y,radius,color)
	endif
	return 0
endfunction

function fRawImage_EraseCircle takes integer RawImage, integer x, integer y, integer radius, boolean inverse returns integer
	if pRawImage_EraseCircle == 0 then
		set pRawImage_EraseCircle = GetModuleProcAddress(EXTRADLLNAME, "RawImage_EraseCircle")
	endif
	if pRawImage_EraseCircle != 0 then
		return CallStdcallWith5Args(pRawImage_EraseCircle,RawImage,x,y,radius,B2I(inverse))
	endif
	return 0
endfunction

function fRawImage_EraseColor takes integer RawImage, integer color, integer power returns integer
	if pRawImage_EraseColor == 0 then
		set pRawImage_EraseColor = GetModuleProcAddress(EXTRADLLNAME, "RawImage_EraseColor")
	endif
	if pRawImage_EraseColor != 0 then
		return CallStdcallWith3Args(pRawImage_EraseColor,RawImage,color,power)
	endif
	return 0
endfunction

function fRawImage_LoadFontFromResource takes string filepath returns integer
	if pRawImage_LoadFontFromResource == 0 then
		set pRawImage_LoadFontFromResource = GetModuleProcAddress(EXTRADLLNAME, "RawImage_LoadFontFromResource")
	endif
	if pRawImage_LoadFontFromResource != 0 then
		return CallStdcallWith1Args(pRawImage_LoadFontFromResource,GetStringAddress(filepath))
	endif
	return 0
endfunction

function fRawImage_SetFontSettings takes string fontname, integer fontsize, integer flags returns integer
	if pRawImage_SetFontSettings == 0 then
		set pRawImage_SetFontSettings = GetModuleProcAddress(EXTRADLLNAME, "RawImage_SetFontSettings")
	endif
	if pRawImage_SetFontSettings != 0 then
		return CallStdcallWith3Args(pRawImage_SetFontSettings,GetStringAddress(fontname),fontsize,flags)
	endif
	return 0
endfunction

function fRawImage_DrawText takes integer RawImage, string text, integer x, integer y, integer color returns integer
	if pRawImage_DrawText == 0 then
		set pRawImage_DrawText = GetModuleProcAddress(EXTRADLLNAME, "RawImage_DrawText")
	endif
	if pRawImage_DrawText != 0 then
		return CallStdcallWith5Args(pRawImage_DrawText,RawImage,GetStringAddress(text),x,y,color)
	endif
	return 0
endfunction

function fSaveRawImageToGameFile takes integer RawImage, string filepath, boolean IsTga, boolean enabled returns integer
	if pSaveRawImageToGameFile == 0 then
		set pSaveRawImageToGameFile = GetModuleProcAddress(EXTRADLLNAME, "SaveRawImageToGameFile")
	endif
	if pSaveRawImageToGameFile != 0 then
		return CallStdcallWith4Args(pSaveRawImageToGameFile,RawImage,GetStringAddress(filepath),B2I(IsTga),B2I(enabled))
	endif
	return 0
endfunction

function fDumpRawImageToFile takes integer RawImage, string filepath returns integer
	if pDumpRawImageToFile == 0 then
		set pDumpRawImageToFile = GetModuleProcAddress(EXTRADLLNAME, "DumpRawImageToFile")
	endif
	if pDumpRawImageToFile != 0 then
		return CallStdcallWith2Args(pDumpRawImageToFile,RawImage,GetStringAddress(filepath))
	endif
	return 0
endfunction
//find RawImage of list of all rawimages by name
function fGetRawImageByFile takes string filename returns integer
	if pGetRawImageByFile == 0 then
		set pGetRawImageByFile = GetModuleProcAddress(EXTRADLLNAME, "GetRawImageByFile")
	endif
	if pGetRawImageByFile != 0 then
		return CallStdcallWith1Args(pGetRawImageByFile, GetStringAddress(filename))
	endif
	return 0
endfunction
//
function fRawImage_GetWidth takes integer RawImage returns integer
	if pRawImage_GetWidth == 0 then
		set pRawImage_GetWidth = GetModuleProcAddress(EXTRADLLNAME, "RawImage_GetWidth")
	endif
	if pRawImage_GetWidth != 0 then
		return CallStdcallWith1Args(pRawImage_GetWidth,RawImage)
	endif
	return 0
endfunction
//
function fRawImage_GetHeight takes integer RawImage returns integer
	if pRawImage_GetHeight == 0 then
		set pRawImage_GetHeight = GetModuleProcAddress(EXTRADLLNAME, "RawImage_GetHeight")
	endif
	if pRawImage_GetHeight != 0 then
		return CallStdcallWith1Args(pRawImage_GetHeight,RawImage)
	endif
	return 0
endfunction
//
function fRawImage_Resize takes integer RawImage,integer newwidth, integer newheight returns integer
	if pRawImage_Resize == 0 then
		set pRawImage_Resize = GetModuleProcAddress(EXTRADLLNAME, "RawImage_Resize")
	endif
	if pRawImage_Resize != 0 then
		return CallStdcallWith3Args(pRawImage_Resize,RawImage,newwidth,newheight)
	endif
	return 0
endfunction
//draw raw image, x/y from 0. to 1.0 (overlay)
function fRawImage_DrawOverlay takes integer RawImage,boolean enabled, real xpos, real ypos returns integer
	if pRawImage_DrawOverlay == 0 then
		set pRawImage_DrawOverlay = GetModuleProcAddress(EXTRADLLNAME, "RawImage_DrawOverlay")
	endif
	if pRawImage_DrawOverlay != 0 then
		return CallStdcallWith4Args(pRawImage_DrawOverlay,RawImage,B2I(enabled),mR2I(xpos),mR2I(ypos))
	endif
	return 0
endfunction
//allows to setup BASE screen size for drawning
function fImages_SetDefaultSceenSize takes real width, real height returns integer
	if pSetDefaultSceenSize == 0 then
		set pSetDefaultSceenSize = GetModuleProcAddress(EXTRADLLNAME, "SetDefaultSceenSize")
	endif
	if pSetDefaultSceenSize != 0 then
		return CallStdcallWith2Args(pSetDefaultSceenSize,mR2I(width),mR2I(height))
	endif
	return 0
endfunction

function fRawImage_MoveTimed takes integer RawImage, real xpos, real ypos, integer time1, integer time2, integer SleepTime returns integer
	if pRawImage_MoveTimed == 0 then
		set pRawImage_MoveTimed = GetModuleProcAddress(EXTRADLLNAME, "RawImage_MoveTimed")
	endif
	if pRawImage_MoveTimed != 0 then
		return CallStdcallWith6Args(pRawImage_MoveTimed,RawImage,mR2I(xpos),mR2I(ypos),time1,time2,SleepTime)
	endif
	return 0
endfunction


function GetEventStringById takes integer id returns string
	if id == 1 then 
		return "MouseUp"
	endif
	if id == 2 then 
		return "MouseDown"
	endif
	if id == 4 then 
		return "MouseClick"
	endif
	if id == 8 then 
		return "MouseEnter"
	endif
	if id == 16 then 
		return "MouseLeave"
	endif
	return "Unknown"
endfunction

function SuperCallbackTest takes nothing returns nothing
	call echo("RawImage:" + I2S(RMem(pCallbackSuperData)) + ", Event:" + GetEventStringById(RMem(pCallbackSuperData+4)))
//	if RMem(pCallbackSuperData+4) == 1 then 
//		call fRawImage_DrawOverlay(RMem(pCallbackSuperData), true, mI2R(RMem(pCallbackSuperData+8)), mI2R(RMem(pCallbackSuperData+12)))
//	endif
//fRawImage_DrawOverlay
	
endfunction

function fRawImage_AddCallback takes integer RawImage,string callbackfunc,integer callbackdata, integer events returns integer
	if pRawImage_AddCallback == 0 then
		set pRawImage_AddCallback = GetModuleProcAddress(EXTRADLLNAME, "RawImage_AddCallback")
	endif
	if pRawImage_AddCallback != 0 then
		return CallStdcallWith4Args(pRawImage_AddCallback,RawImage,GetStringAddress(callbackfunc),callbackdata,events)
	endif
	return 0
endfunction
//event: 
// MouseUp = 1U,
// MouseDown = 2U,
// MouseClick = 4U,
// MouseEnter = 8U,
// MouseLeave = 16U,
// MouseMove = 32U,
// ALL = 63U
//callbackdata array: int RawImage;0x00
// RawImageEventType EventType;;0x04
// float mousex;;0x08
// float mousey;;0x0C
// BOOL IsAltPressed;;0x10
// BOOL IsCtrlPressed;;0x14
// BOOL IsLeftButton;;0x18
// int offsetx;;0x1c
// int offsety;;0x20

function fGetJassStringCount takes nothing returns integer
	if pGetJassStringCount == 0 then
		set pGetJassStringCount = GetModuleProcAddress(EXTRADLLNAME, "GetJassStringCount")
	endif
	if pGetJassStringCount != 0 then
		return CallStdcallWith1Args(pGetJassStringCount,GetFirstJassStringAddress())
	endif
	return 0
endfunction

function fScanJassStringForErrors takes nothing returns integer
	if pScanJassStringForErrors == 0 then
		set pScanJassStringForErrors = GetModuleProcAddress(EXTRADLLNAME, "ScanJassStringForErrors")
	endif
	if pScanJassStringForErrors != 0 then
		return CallStdcallWith1Args(pScanJassStringForErrors,GetFirstJassStringAddress())
	endif
	return 0
endfunction

function fScanJassStringForErrorsWrap takes nothing returns nothing
	call BJDebugMsg(I2S(fScanJassStringForErrors()))
endfunction

function fReplayDesyncScan takes boolean scan returns integer
	if pReplayDesyncScan == 0 then
		set pReplayDesyncScan = GetModuleProcAddress(EXTRADLLNAME, "ReplayDesyncScan")
	endif
	if pReplayDesyncScan != 0 then
		return CallStdcallWith1Args(pReplayDesyncScan,B2I(scan))
	endif
	return 0
endfunction

function defaultB2I takes boolean b returns integer
	if b then
		return 1
	endif
	return 0
endfunction

function fFileHelperReleaseStorm takes boolean enable returns integer
	if pFileHelperReleaseStorm == 0 then
		set pFileHelperReleaseStorm = GetModuleProcAddress(EXTRADLLNAME, "FileHelperReleaseStorm")
	endif
	if pFileHelperReleaseStorm != 0 then
		return CallStdcallWith1Args(pFileHelperReleaseStorm,defaultB2I(enable))
	endif
	return 0
endfunction

function fUpdatePlayerCache takes nothing returns integer
	if pUpdatePlayerCache == 0 then
		set pUpdatePlayerCache = GetModuleProcAddress(EXTRADLLNAME, "UpdatePlayerCache")
	endif
	if pUpdatePlayerCache != 0 then
		return CallStdcallWith1Args(pUpdatePlayerCache,0)
	endif
	return 0
endfunction

function GetUnitCurrentOrderAddress takes unit u returns integer
	local integer x=0
	local integer y=0
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set x=RMem(LastConvertedHandle+0x19C)
		set y=RMem(LastConvertedHandle+0x1A0)
		if x!=-1 and y!=-1 then
			return GetSomeAddressForAbility(x,y)
		endif
	endif
	return 0
endfunction

function GetOrderingPlayerId takes integer orderAddress returns integer
	return RMem(orderAddress+0x28)
endfunction

function GetOrderingPlayerIdByUnit takes unit u returns integer
	if GetUnitCurrentOrderAddress(u)>0 then
		return RMem(GetUnitCurrentOrderAddress(u)+0x28)
	endif
	return 0
endfunction

function GetLastOrderingPlayerId takes nothing returns integer//designed to use on ISSUED_ORDER event
	return RMem(GetUnitCurrentOrderAddress(GetTriggerUnit())+0x28)
endfunction

function IsUnitDetectedByEnemy takes unit u returns boolean
	local integer i=0
	local integer a=GetUnitVisibilityClass(u)
	if a<1 then
		return false
	endif
	if RMem(a+0x24)==0 then
		return false
	endif
	loop
		if IsUnitEnemy(u,Players[i]) then
			if RMem(a+0x2C+i*4)>0 then
				return true
			endif
		endif
		set i=i+1
		exitwhen i>11
	endloop
	return false
endfunction

function GetUnitFaceArt takes integer id returns string
	return GetUnitUIStringParam(id,1,0x248)
endfunction

function GetAuraProviderByBuff takes unit u, integer buffid returns unit
	return GetBuffOwner(GetUnitAbility(u,buffid))
endfunction

function SetupUnitSelling takes integer shopID, integer hkey returns nothing
	local integer c=0
	local integer array itemsIds
	local integer a
	loop
		set itemsIds[c]=LoadInteger(TempHash,hkey,c)
		call SetHeroIconPosInTavern(itemsIds[c],ModuloInteger(c,4),c/4)
		set c=c+1
		exitwhen not HaveSavedInteger(TempHash,hkey,c)
	endloop
	call FlushChildHashtable(TempHash,hkey)
	set a=GetUnitUIDefByIdCaching(shopID)
	if a>0 then
		
	endif
endfunction



function InitOnExitHook takes integer pTriggerHandle returns nothing
	local integer oldprotection = ChangeOffsetProtection(pOnExitHookAddress,8,0x40)
	
	call WMem(pOnExitHookAddress, 0xE9E9E9E9)
	
	call WMem(pOnExitHookAddress + 1, pReservedMemoryForMissileHandler + 500 - (pOnExitHookAddress) - 5 )
	
	call WMem(pReservedMemoryForMissileHandler + 500 + 0, 0x68609090 )
	call WMem(pReservedMemoryForMissileHandler + 500 + 4, pTriggerHandle )
	call WMem(pReservedMemoryForMissileHandler + 500 + 8, 0xB890C08B )
	call WMem(pReservedMemoryForMissileHandler + 500 + 12, pTriggerExecute )
	call WMem(pReservedMemoryForMissileHandler + 500 + 16, 0xC483D0FF )
	call WMem(pReservedMemoryForMissileHandler + 500 + 20, 0xB8906104 )
	call WMem(pReservedMemoryForMissileHandler + 500 + 24, pOnExitHookAddress )
	call WMem(pReservedMemoryForMissileHandler + 500 + 28, 0xCCCCE0FF )
//call BJDebugMsg(Int2Hex(pReservedMemoryForMissileHandler + 500))
	
	set oldprotection = ChangeOffsetProtection(pOnExitHookAddress,8,oldprotection)
//-------------------
	set oldprotection = ChangeOffsetProtection(pOnExitHookAddressOnRestart,8,0x40)
	
	call WMem(pOnExitHookAddressOnRestart, 0xE9E9E9E9)
	
	call WMem(pOnExitHookAddressOnRestart + 1, pReservedMemoryForMissileHandler + 600 - (pOnExitHookAddressOnRestart) - 5 )
	
	call WMem(pReservedMemoryForMissileHandler + 600 + 0, 0x68609090 )
	call WMem(pReservedMemoryForMissileHandler + 600 + 4, pTriggerHandle )
	call WMem(pReservedMemoryForMissileHandler + 600 + 8, 0xB890C08B )
	call WMem(pReservedMemoryForMissileHandler + 600 + 12, pTriggerExecute )
	call WMem(pReservedMemoryForMissileHandler + 600 + 16, 0xC483D0FF )
	call WMem(pReservedMemoryForMissileHandler + 600 + 20, 0xB8906104 )
	call WMem(pReservedMemoryForMissileHandler + 600 + 24, pOnExitHookAddressOnRestart )
	call WMem(pReservedMemoryForMissileHandler + 600 + 28, 0xCCCCE0FF )
//call BJDebugMsg(Int2Hex(pReservedMemoryForMissileHandler + 500))
	
	set oldprotection = ChangeOffsetProtection(pOnExitHookAddressOnRestart,8,oldprotection)
endfunction

function RestoreAllMemory takes nothing returns nothing
	local integer i=OffsetsToRestoreC
	local integer oldprotection 
	set GameIsClosing=true
//	call ExeFunc("Offsets to restore: "+I2S(i))
	loop
		exitwhen i<1
		set oldprotection= ChangeOffsetProtection(OffsetsToRestore[i],4,0x40)
		call WMem(OffsetsToRestore[i],OffsetsToRestoreVals[i])
		call ChangeOffsetProtection(OffsetsToRestore[i],4,oldprotection)
		set i=i-1
	endloop
	
endfunction

function OnExitActions takes nothing returns nothing
	call RestoreAllMemory()
endfunction

//pointer to 'Amov' is located at offset 123 of unit object, Aatk is at offset 122, and AInv is offset 124
//Hides all command buttons and sets the Ward flag. Unit will keep its current order, and player cant give new orders
//Notice the the unit cant be ordered with triggers as well. To issue an order you need to temporarily reenable control
function DisableUnitControl takes unit u returns nothing
	local integer pUnit = ConvertHandle(u)
	local integer flags
	local integer Amov
	local integer Aatk
	local integer AInv
	if not LoadBoolean(HY,GetHandleId(u),'cntd') then
		call SaveBoolean(HY,GetHandleId(u),'cntd',true)
		if pUnit > 0 then
			set flags = RMem(pUnit+0x248)
			set Amov = RMem(pUnit+0x1EC)
			set Aatk = RMem(pUnit+0x1E8)
			set AInv = RMem(pUnit+0x1F8)
	//	call echo("disabled on "+GetUnitName(u))
			if not IsFlagBitSet(flags,512) then
				call WMem(pUnit+0x248, flags + 512)
			endif
			if Amov >0 then
	//causes unit to stop turning, changing height, etc, so can't be used
	//			call CallThisCallWith3Args(pAddSilenceOnAbility,Amov,1,1)
				call WMem(Amov+0x40, RMem(Amov+0x40) + 1)
			endif
			if Aatk >0 then
	//causes unit to stop attacking, while mechanically hiding ability doesnt stop current attacks
	//			call CallThisCallWith3Args(pAddSilenceOnAbility,Aatk,0,1)
				call WMem(Aatk+0x40, RMem(Aatk+0x40) + 1)
			endif
			if AInv >0 then
	//for some reason applying this technically causes unit to being unable to drop item, so have to use proper way
				call CallThisCallWith3Args(pAddSilenceOnAbility,AInv,1,1)
	//			call WMem(AInv+0x3C, RMem(AInv+0x3C) + 1)
			endif
			
		endif
	endif
endfunction

//Removes the Ward flag and reenables Amov and Aatk
function EnableUnitControl takes unit u returns nothing
	local integer pUnit = ConvertHandle(u)
	local integer flags
	local integer Amov
	local integer Aatk
	local integer AInv
	if LoadBoolean(HY,GetHandleId(u),'cntd') then
		if pUnit > 0 then
			set flags = RMem(pUnit+0x248)
			set Amov = RMem(pUnit+0x1EC)
			set Aatk = RMem(pUnit+0x1E8)
			set AInv = RMem(pUnit+0x1F8)
	//	call echo("disabled on "+GetUnitName(u))
			if IsFlagBitSet(flags,512) then
				call WMem(pUnit+0x248, flags - 512)
			endif
			if Amov >0 then
				if RMem(Amov+0x40)>0 then
					call WMem(Amov+0x40, RMem(Amov+0x40) - 1)
				endif
	//			call CallThisCallWith3Args(pRemoveSilenceFromAbility,Amov,1,1)
			endif
			if Aatk >0 then
				if RMem(Aatk+0x40)>0 then
					call WMem(Aatk+0x40, RMem(Aatk+0x40) - 1)
				endif
	//			call CallThisCallWith3Args(pRemoveSilenceFromAbility,Aatk,0,1)
			endif
			if AInv >0 then
				call CallThisCallWith3Args(pRemoveSilenceFromAbility,AInv,1,1)
	//			call WMem(AInv+0x3C, RMem(AInv+0x3C) - 1)
			endif
		endif
		call SaveBoolean(HY,GetHandleId(u),'cntd',false)
	endif
endfunction

function ResetUnitControlToZero takes unit u returns nothing
	local integer pUnit = ConvertHandle(u)
	local integer flags
	local integer Amov
	local integer Aatk
	local integer AInv
	if pUnit > 0 then
		call SaveBoolean(HY,GetHandleId(u),'cntd',false)
		set flags = RMem(pUnit+0x248)
		set Amov = RMem(pUnit+0x1EC)
		set Aatk = RMem(pUnit+0x1E8)
		set AInv = RMem(pUnit+0x1F8)
//	call echo("disabled on "+GetUnitName(u))
		if IsFlagBitSet(flags,512) then
			call WMem(pUnit+0x248, flags - 512)
		endif
		if Amov >0 then
			call WMem(Amov+0x40, 0)
		endif
		if Aatk >0 then
			call WMem(Aatk+0x40, 0)
		endif
		if AInv >0 then
			call WMem(AInv+0x3C, 0)
		endif
	endif
endfunction

function DisjointAllMissilesHardcoded takes unit u returns nothing
	call AddUnitFlags0x20(u,0x800000)
	call CallThisCallWith3Args(pDisjoingHardcodedMissiles,ConvertHandle(u),-1,-1)
	call AddUnitFlags0x20(u,-0x800000)
endfunction

function MakeUnitImmortal takes unit u returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set LastConvertedHandle=GetUnitAddressFloatsRelated(LastConvertedHandle,0xA0)
		if LastConvertedHandle>0 then
			call WMem(LastConvertedHandle+0x80,0x3F800000)
		endif
	endif
endfunction

function MakeUnitMortal takes unit u returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		set LastConvertedHandle=GetUnitAddressFloatsRelated(LastConvertedHandle,0xA0)
		if LastConvertedHandle>0 then
			call WMem(LastConvertedHandle+0x80,0)
		endif
	endif
endfunction

function SetObjectTimeScale takes handle obj, real speed returns nothing
	set LastConvertedHandle=ConvertHandle(obj)
	if LastConvertedHandle>0 then
		call WMem(RMem(LastConvertedHandle+0x28)+0x190,mR2I(speed))
	endif
endfunction

function GetObjectTimeScale takes handle obj returns real
	set LastConvertedHandle=ConvertHandle(obj)
	if LastConvertedHandle>0 then
		return mI2R(RMem(RMem(LastConvertedHandle+0x28)+0x190))
	endif
	return 0.
endfunction

function ShowObserverSkillPanelF takes boolean enabled returns nothing
	if pShowObserverSkillPanel == 0 then
		set pShowObserverSkillPanel = GetModuleProcAddress(EXTRADLLNAME, "ShowObserverSkillPanel")
	endif
	if pShowObserverSkillPanel != 0 then 
		call CallStdcallWith1Args(pShowObserverSkillPanel,defaultB2I(enabled))
	endif
endfunction

function fShowSkillPanelForAllUnits takes boolean enabled returns nothing
	if pShowSkillPanelForAllUnits == 0 then
		set pShowSkillPanelForAllUnits = GetModuleProcAddress(EXTRADLLNAME, "ShowSkillPanelForAllUnits")
	endif
	if pShowSkillPanelForAllUnits != 0 then 
		call CallStdcallWith1Args(pShowSkillPanelForAllUnits,defaultB2I(enabled))
	endif
endfunction

function fInitHPBars takes boolean enabled returns nothing
	if pInitHPBars == 0 then
		set pInitHPBars = GetModuleProcAddress(EXTRADLLNAME, "InitHpBar")
	endif
	if pInitHPBars != 0 then 
		call CallStdcallWith1Args(pInitHPBars,defaultB2I(enabled))
	endif
endfunction

function fInitMPBars takes boolean enabled returns nothing
	if pInitMPBars == 0 then
		set pInitMPBars = GetModuleProcAddress(EXTRADLLNAME, "InitManaBar")
	endif
	if pInitMPBars != 0 then 
		call CallStdcallWith1Args(pInitMPBars,defaultB2I(enabled))
	endif
endfunction


function SetManabarEnabledF takes nothing returns nothing
	if pSetManabarEnabled == 0 then
		set pSetManabarEnabled = GetModuleProcAddress(EXTRADLLNAME, "SetManabarEnabled")
	endif
	if pSetManabarEnabled != 0 then 
		call CallStdcallWith1Args(pSetManabarEnabled,B2I(ManabarDisplayStatus))
	endif
endfunction

function IsUltimate takes integer id returns boolean
	return GetAbilityLevelRequired(id)==6
endfunction

function GetUltimateNum takes unit u, integer id returns integer
	local integer sid=PlayerSkillNumber[GetPlayerId(GetOwningPlayer(u))*PlayerSkillOffset+4]
	if not Mode_S6 then
		return 1
	else
		if id==SkillID[sid] or id==AlternateSkillID[sid] then
			return 1
		else
			return 2
		endif
	endif
	return 1
endfunction

function StartUltimateTimer takes unit u, integer id, real cd returns nothing
	if GetUltimateNum(u,id)==1 then
		call TimerStart(PrimUltiTimer[GetPlayerId(GetOwningPlayer(u))],cd,false,null)
	else
		call TimerStart(SecUltiTimer[GetPlayerId(GetOwningPlayer(u))],cd,false,null)
	endif
endfunction

function InitItemIDsTable takes nothing returns nothing
	call SaveBoolean(SpellsDB,'itid',0,true)
	call SaveBoolean(SpellsDB,'itid','A0K5',true)
//	call SaveBoolean(SpellsDB,'itid','A2WI',true)//wards
//	call SaveBoolean(SpellsDB,'itid','A2WH',true)
	call SaveBoolean(SpellsDB,'itid','A0HU',true)
	call SaveBoolean(SpellsDB,'itid','A0HX',true)
	call SaveBoolean(SpellsDB,'itid','A14A',true)//pt
	call SaveBoolean(SpellsDB,'itid','A269',true)//aquila
	call SaveBoolean(SpellsDB,'itid','A2KG',true)
	call SaveBoolean(SpellsDB,'itid','AIxk',true)//mom
	call SaveBoolean(SpellsDB,'itid','A017',true)//lothar
	call SaveBoolean(SpellsDB,'itid','A39C',true)//silver
	call SaveBoolean(SpellsDB,'itid','A1IO',true)//radiance
	call SaveBoolean(SpellsDB,'itid','A0T8',true)//armlet
	call SaveBoolean(SpellsDB,'itid','A0T7',true)
	call SaveBoolean(SpellsDB,'itid','A0T9',true)//shiva
	call SaveBoolean(SpellsDB,'itid','A12W',true)//phase boots
//	call SaveBoolean(SpellsDB,'itid','A3U7',true)//tom of knowledge
//	call SaveBoolean(SpellsDB,'itid','A3UF',true)//POTM agh
endfunction

function IsItemAbility takes integer i returns boolean
	return HaveSavedBoolean(SpellsDB,'itid',i)
endfunction

function OnSpellCDStarts takes ability a, integer ch, unit u, real cd, integer id, integer h returns nothing
//	call echo("spell cd cast, cd = "+R2S(GetAbilityCurrentCooldownConverted(ch))+" ch="+Int2Hex(ch*4)+" ha="+Int2Hex(ConvertHandle(a)))
//	call SaveAbilityHandle(AbilitiesHashtable,GetHandleId(u),id,a)
	local integer pid=GetPlayerId(GetOwningPlayer(u))
	local integer sid=PlayerSkillNumber[pid*PlayerSkillOffset+4]
	call SaveInteger(AbilitiesHashtable,GetHandleId(u),id,ch)
	if ch==0 or cd==0 or GetHandleId(u)==0 or (h==0 and GetHandleId(a)==0) or id=='A3S2' then
		return
	endif
	if id=='A141' or id=='A1WI' then
		call AdjustCooldownModel1000(ch)
		return
	endif
	call AdjustCooldownModel(ch)
	if GetUnitAbilityLevel(u,'A39S')>0 then
//		call echo("octarine cd")
		call AddAbilityCooldownConverted(ch,-cd*ROCTARINECOOLDOWNREDUCE)
	endif
	if GetUnitAbilityLevel(u,'A3R4')>0 then
//		call echo("arcane rune cd")
		call AddAbilityCooldownConverted(ch,-cd*RARCANERUNECOOLDOWNREDUCE)
	endif
	if not IsItemAbility(id) and GetUnitAbilityLevel(u,'B3DU')==1 then//B3DU -> Chakra Magic, NOT ECHO SABRE// KOTLInGame and 
		if GetUnitAbilityLevel(u,'A3DX')==1 then
			call AddAbilityCooldownConverted(ch,-6.)
			call UnitRemoveAbility(u,'A3DX')
		elseif GetUnitAbilityLevel(u,'A3DV')==1 then
			call AddAbilityCooldownConverted(ch,-4.)
			call UnitRemoveAbility(u,'A3DV')
		elseif GetUnitAbilityLevel(u,'A3DW')==1 then
			call AddAbilityCooldownConverted(ch,-5.)
			call UnitRemoveAbility(u,'A3DW')
		elseif GetUnitAbilityLevel(u,'A3DU')==1 then
			call AddAbilityCooldownConverted(ch,-3.)
			call UnitRemoveAbility(u,'A3DU')
		endif
		call UnitRemoveAbility(u,'B3DU')//B3DU -> Chakra Magic
	endif
	set LastMemReadAccess="spellCast"
	set LastMemWriteAccess="spellCast"
	set cd=GetAbilityCurrentCooldownConverted(ch)
	if cd<=0 then//remove cooldown
		set LastConvertedHandle=RMem(ch+0x20)
		if IsFlagBitSet(LastConvertedHandle,0x200) then
			set LastConvertedHandle=LastConvertedHandle-0x200
			call WMem(ch+0x20,LastConvertedHandle)
		endif
		if IsFlagBitSet(LastConvertedHandle,0x08000080) and not IsFlagBitSet(LastConvertedHandle,0x80000) then
			set LastConvertedHandle=LastConvertedHandle+0x80000
			call WMem(ch+0x20,LastConvertedHandle)
		endif
	endif
	if id=='A02W' then//A02W -> Item Cooldown Reset
		call TimerStart(PrimUltiTimer[pid],0,false,null)
		call TimerStart(SecUltiTimer[pid],0,false,null)
	elseif cd>0 and IsUltimate(id) and IsUnitType(u,UNIT_TYPE_HERO) then
		call StartUltimateTimer(u,id,cd)
	endif
	set LastMemReadAccess=""
	set LastMemWriteAccess=""
	
endfunction

function SpecialAbilityCasted takes unit u, integer id returns nothing
//call echo("caster")
	local integer a=GetUnitAbility(u,id)
	if a>0 then
		call OnSpellCDStarts(null,a,u,GetAbilityCD(id,GetUnitAbilityLevel(u,id)),id,1)
	endif
endfunction

function SpecialAbilityCastedPre takes nothing returns nothing
	local integer h=GetHandleId(GetExpiredTimer())
	call SpecialAbilityCasted(LoadUnitHandle(HY,h,0),LoadInteger(HY,h,0))
	call CleanExpiredTimer()
endfunction

function SpecialAbilityCastedWrapper takes unit u, integer id returns nothing
	local integer h
	local integer a=GetUnitAbility(u,id)
	if a>0 then
		set h=DelayedCallback(0.,function SpecialAbilityCastedPre)
		call SaveUnitHandle(HY,h,0,u)
		call SaveInteger(HY,h,0,id)
	endif
endfunction

function WrapperOnSpellCDStarts takes nothing returns nothing
	local integer h=GetHandleId(GetExpiredTimer())
	if GetHandleId(LoadAbilityHandle(HY,h,0))>0 then
		call OnSpellCDStarts(LoadAbilityHandle(HY,h,0),ConvertHandle(LoadAbilityHandle(HY,h,0)),LoadUnitHandle(HY,h,1),LoadReal(HY,h,0),LoadInteger(HY,h,0),0)
	endif
	call CleanExpiredTimer()
endfunction

function InitOnSpellCDStarts takes integer lvl returns nothing
	local integer h=DelayedCallback(0,function WrapperOnSpellCDStarts)
	call SaveAbilityHandle(HY,h,0,GetSpellAbility())
	call SaveReal(HY,h,0,GetAbilityCD(GetSpellAbilityId(),lvl))
	call SaveInteger(HY,h,0,GetSpellAbilityId())
	call SaveUnitHandle(HY,h,1,GetTriggerUnit())
endfunction

function ResetCooldownForAbilityAddress takes integer cid returns nothing
	if IsFlagBitSet(RMem(cid+0x20),0x200) then
		call WMem(cid+0x20,RMem(cid+0x20)-0x200)
	endif
endfunction

function ResetCooldownForAbility takes unit u, integer id returns nothing
	local integer cid=GetUnitAbility(u,id)
	if cid>1 then
		if IsFlagBitSet(RMem(cid+0x20),0x200) then
			call WMem(cid+0x20,RMem(cid+0x20)-0x200)
			if IsUltimate(id) then
				call StartUltimateTimer(u,id,0.)
			endif
		endif
	endif
endfunction

function ToggleTeleportHelper takes boolean enabled returns nothing
	if bTeleportationCanOnlyBeStopped then
		if pTeleportHelper == 0 then 
			set pTeleportHelper = GetModuleProcAddress(EXTRADLLNAME, "TeleportHelper")
		endif
		if pTeleportHelper != 0 then
			call CallStdcallWith1Args(pTeleportHelper,B2I(enabled))
		endif
	endif
endfunction

function AddTeleportWhiteListKey takes integer key returns nothing
	if pAddTeleportWhiteListKey == 0 then 
		set pAddTeleportWhiteListKey = GetModuleProcAddress(EXTRADLLNAME, "TeleportWhiteListKey")
	endif
	if pAddTeleportWhiteListKey != 0 then 
		call CallStdcallWith1Args(pAddTeleportWhiteListKey,key)
	endif
endfunction

function FuncEnableAutoFPSlimit takes boolean enabled returns nothing
	if pEnableAutoFPSlimit == 0 then 
		set pEnableAutoFPSlimit = GetModuleProcAddress(EXTRADLLNAME, "EnableAutoFPSlimit")
	endif
	
	if pEnableAutoFPSlimit != 0 then 
		call CallStdcallWith1Args(pEnableAutoFPSlimit,B2I(enabled))
	endif
	set AutoFPSLimitEnabled=enabled
endfunction

function FuncLockMouseInWindow takes boolean enabled returns nothing
	if pLockMouseInWindow == 0 then 
		set pLockMouseInWindow = GetModuleProcAddress(EXTRADLLNAME, "LockMouseInWindow")
	endif
	
	if pLockMouseInWindow != 0 then 
		call CallStdcallWith1Args(pLockMouseInWindow,B2I(enabled))
	endif
	set LockMouseCursorWindowed=enabled
endfunction

function FuncSetMaxFps takes integer maxfps returns nothing
	if pSetMaxFps == 0 then 
		set pSetMaxFps = GetModuleProcAddress(EXTRADLLNAME, "SetMaxFps")
	endif
	
	if pSetMaxFps != 0 then 
		call CallStdcallWith1Args(pSetMaxFps,maxfps)
	endif
endfunction

function AlwaysDisplayRegeneration takes boolean enabled returns nothing
	if pDrawRegenAllways == 0 then 
		set pDrawRegenAllways = GetModuleProcAddress(EXTRADLLNAME, "DrawRegenAllways")
	endif
	if pDrawRegenAllways != 0 then 
		call CallStdcallWith1Args(pDrawRegenAllways,B2I(enabled))
	endif
endfunction

function FixFPSbyAbso takes boolean enabled returns nothing
	if pFixFPSbyAbso == 0 then 
		set pFixFPSbyAbso = GetModuleProcAddress(EXTRADLLNAME, "EnableFPSfix1")
	endif
	if pFixFPSbyAbso != 0 then 
		call CallStdcallWith1Args(pFixFPSbyAbso,B2I(enabled))
	endif
endfunction

function UpdateFogDensitySettings takes integer i returns nothing
	if pMinimapData>0 then
		call WMem(pMinimapData+0x7E8,i)
	endif
endfunction

function DirectSetManabarStatus takes boolean b returns nothing
	set ManabarDisplayStatus=b
	call SetManabarEnabledF()
endfunction

function MorphUnitIntoAnother takes unit u, integer targetID returns nothing
	set LastConvertedHandle=ConvertHandle(u)
	if LastConvertedHandle>0 then
		call CallThisCallWith11Args(pMorphUnitIntoAnother,LastConvertedHandle,targetID,0x522,0,0,0,0,1,1,0,0)
	endif
endfunction

function ToggleShopHelper takes boolean enabled returns nothing
	if pShopHelper == 0 then 
		set pShopHelper = GetModuleProcAddress(EXTRADLLNAME, "ShopHelper")
	endif
	if pShopHelper != 0 then 
		call CallStdcallWith1Args(pShopHelper,B2I(enabled))
	endif
endfunction


//MEMHACK END


function GetEvasionOrderIdFunctionData takes nothing returns nothing
	local integer a
	local integer oldprotection
	call UnitAddAbility(SentFountain,'AEev')
	set a=GetUnitAbility(SentFountain,'AEev')
	if a>0 then
		set pEvasionOrderIdFunction=RMem(RMem(a)+0x30C)
		if pEvasionOrderIdFunction>GameDLL then
			call UnitAddAbility(SentFountain,'Afla')
			set a=GetUnitAbility(SentFountain,'Afla')
			if a>0 then
				set a=RMem(a)+0x30C
				set oldprotection=ChangeOffsetProtection(a,4,0x40)
				call WMem(a,pEvasionOrderIdFunction)
				call ChangeOffsetProtection(a,4,oldprotection)
			endif
			call UnitRemoveAbility(SentFountain,'Afla')
		endif
	else
		call MinorErrorNote("Counters fix fail")
//port value from AEev to Afla to disable icons
	endif
	call UnitRemoveAbility(SentFountain,'AEev')
endfunction

function ParseConfigGetModifier takes string s returns integer
	local string s2
	local integer i=0
	local integer b=0
	local integer res
	if StringCase(s,false)=="space" then
		return 0x20
	endif
	if StringLength(s)==1 then
		if s==" " then
			set res=0x20
			call echo("space")
		else
			set res=Char2Ascii(StringCase(s,true))
		endif
		return res
	elseif StringLength(s)==2 then
		set s2=StringCase(s,false)
		if SubString(s2,0,1)=="f" and S2I(SubString(s,1,2))>0 then
			set res=0x6F+S2I(SubString(s,1,2))
			return res
		endif
		return 0
	endif
	set s2=StringCase(SubString(s,0,3),false)
	if s2=="alt"then
		set b=0x10000
		set i=3
	elseif s2=="ctr"then
		set b=0x20000
		set i=4
	elseif s2=="shi" then
		set b=0x40000
		set i=5
	endif
	if SubString(s,i,i+2)=="0x"then
		return b+Hex2Int(SubString(s,i+2,i+70))
	endif
	return b+Char2Ascii(StringCase(SubString(s,i,i+1),true))
endfunction

function InitHotkeysBinding takes boolean firsttime returns nothing
	local string s=""
	local integer modifier=0
	local integer res=0
	if not firsttime then
		call FuncAddKeyButtonAction(0,0,true)
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","SkillSlot1","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,2,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","SkillSlot2","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,5,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","SkillSlot3","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,8,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","SkillSlot4","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,11,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","SkillSlot5","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,4,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","SkillSlot6","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,7,true)
		endif
	endif
	
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ASkillSlot1","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res+0x80000,2,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ASkillSlot2","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res+0x80000,5,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ASkillSlot3","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res+0x80000,8,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ASkillSlot4","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res+0x80000,11,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","aSkillSlot5","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res+0x80000,4,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ASkillSlot6","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res+0x80000,7,true)
		endif
	endif
	
	
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","BindMove","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,0,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","BindStop","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,3,true)
			call AddTeleportWhiteListKey(res)
		endif
	else
		call AddTeleportWhiteListKey('S')
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","BindHold","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,6,true)
			call AddTeleportWhiteListKey(res)
		endif
	else
		call AddTeleportWhiteListKey('H')
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","BindAttack","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,9,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","BindPatrol","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,1,true)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","BindOpenHeroSkills","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,10,true)
		endif
	endif
	
	
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ItemSlot1","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,0,false)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ItemSlot2","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,1,false)
		endif
	endif
	
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ItemSlot3","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,2,false)
		endif
	endif
	
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ItemSlot4","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,3,false)
		endif
	endif
	
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ItemSlot5","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,4,false)
		endif
	endif
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ItemSlot6","")
	if s!="" then
		set res=ParseConfigGetModifier(s)
		if res>0 then
			call FuncAddKeyButtonAction(res,5,false)
		endif
	endif
	
	set s=ReadStringFromFile(DotaConfigFile,"HOTKEYS","ShopsQWERTY","")
	if s=="true" then
		call ToggleShopHelper(true)
	endif
	
endfunction

function InitNonChatOptions takes integer part returns nothing
	local string s
	local integer i
	local boolean array b
	if part==1 then
		set s=ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","MaxFPS","0")
		set i=S2I(s)
		if i>0 and i<1000 then
			call FuncSetMaxFps(i)
		endif
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","AutoFPSLimit","false"),false)
		if s=="true" then
			call FuncEnableAutoFPSlimit(true)
		endif
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","LockMouseAtWindow","false"),false)
		if s=="true" then
			call FuncLockMouseInWindow(true)
		endif
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","AutoselectHero","true"),false)
		if s=="false" then
			call FuncToggleForcedSubSelection(true)
		endif
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","AutoselectSummonedUnitsRadius","2500"),false)
		if s!="2500" then
			set AUTOSELECTION_MAX_DISTANCE=S2I(s)*1.
		endif
//	set s=StringCase(ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","CaptionsOverCreeps","true"),false)
//	if s=="false" then
//		call ToggleCaptions(GetLocalPlayer())
//	endif
//	
//	set s=StringCase(ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","DotA2HPBars","false"),false)
//	if s=="true" then
//		call SwitchHPBarsStatus(GetLocalPlayer())
//	endif
	elseif part==2 then
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","DisplayManabars","true"),false)
		call DirectSetManabarStatus(s=="true")
		
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","WideScreen","false"),false)
		call FuncSetWidescreenFixState(s=="true")
		
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","TeleportationCanOnlyBeStoppedSoft","false"),false)
		if s=="true" then
			set bTeleportationCanOnlyBeStoppedSoft=true
		endif
		
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"GAMEOPTIONS","TeleportationCanOnlyBeStopped","false"),false)
		if s=="true" then
			set bTeleportationCanOnlyBeStopped=true
		endif
		
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"VISUALS","AdvancedTooltips","true"),false)
		if s=="false" then
			call DisableLibFeatures(LIB_Feature_AttackSpeed+LIB_Feature_MoveSpeed+LIB_Feature_ItemText)
		endif
		
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"VISUALS","DisplayRegeneration","true"),false)
		if s=="false" then
			call DisableLibFeatures(LIB_Feature_UnitHP_MP)
		endif
		
	elseif part==3 then
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"VISUALS","CustomFPSInfo","true"),false)
		if s=="false" then
			call DisableLibFeatures(LIB_Feature_CUSTOM_FPS_INFO)
		endif
		
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"VISUALS","AlwaysDisplayRangeMarkers","false"),false)
		if s=="true" then
			set AlwaysDisplayRangeMarkers=true
		endif
		
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"VISUALS","AlwaysDisplayHPRegen","false"),false)
		if s=="true" then
			call AlwaysDisplayRegeneration(true)
		endif
		
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"VISUALS","SameSelectionCircleForEveryone","false"),false)
		if s=="true" then
			set UnifiedSelectionCircleForEveryHero=true
		endif
		
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"VISUALS","ChatMessageDuration","10.0"),false)
		if s!="10.0" and S2R(s)!=10. and S2R(s)>0 then
			call SaveUnlockWriteMemory(pChatMessageDurationDefault,mR2I(S2R(s)),true,true)
			if pChatMessageDurationDefault2>0 then
				call SaveUnlockWriteMemory(pChatMessageDurationDefault2,mR2I(S2R(s)),true,true)
			endif
//set UnifiedSelectionCircleForEveryHero=true
		endif
		
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"VISUALS","FogDensity","92"),false)
		set i=S2I(s)
		if i>-1 and i<256 then
			call UpdateFogDensitySettings(i)
		endif
	endif
	if part==1 then
		set s=StringCase(ReadStringFromFile(DotaConfigFile,"VISUALS","Weather","none"),false)
		if s=="snow" then
			set b[1]=true
		elseif s=="rain" then
			set b[2]=true
		elseif s=="moonlight" then
			set b[3]=true
		elseif s=="wind" then
			set b[4]=true
		elseif s=="random"then
			set b[5]=true
		endif
		call EnableWeatherEffect(Weather_Snow,b[1])
		call EnableWeatherEffect(Weather_Rain,b[2])
		call EnableWeatherEffect(Weather_Moonlight,b[3])
		call EnableWeatherEffect(Weather_Wind,b[4])
		call EnableWeatherEffect(Weather_Random,b[5])
	endif
	
	
	
endfunction

function RunDotAConfigSettings takes nothing returns nothing
	local integer c=GetTriggerEvalCount(GetTriggeringTrigger())
	local string s=""
	if c==1 then
		call TestIsReplayB()
//		set IsVideomakerDisabled=GetObjectName('SPCL')=="normal"
		call GetEvasionOrderIdFunctionData()
//		set DotaConfigFileNoDots=PlayerNames2[LocalPlayerId]+"_config.dota"
//		set DotaConfigFile=".\\"+PlayerNames2[LocalPlayerId]+"_config.dota"
//call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,DotaConfigFileNoDots)
		if not FileExists(DotaConfigFile) then
			call ExportFileFromMpq(DotaConfigFileNoDots, DotaConfigFile)
		endif
		call InitHotkeysBinding(true)
		call InitNonChatOptions(1)
	elseif c==2 then
		call InitNonChatOptions(2)
	elseif c==3 then
		call InitNonChatOptions(3)
	endif
	set s=ReadStringFromFile(DotaConfigFile,"DEBUG","SyncChecker","false")
	if s=="true" then
		set ReplayDesyncCheckNeeded=true
		set s=ReadStringFromFile(DotaConfigFile,"DEBUG","SyncCheckerState","")
		if s=="true" then
			set Status_ReplayDesyncCheck=true
		endif
	endif
	
	set s=ReadStringFromFile(DotaConfigFile,"ONSTART","StartChatString"+I2S(c),"")//PlayerNames2[LocalPlayerId]+
	
	
	if GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2 then
		set s=""
	endif
	if s!="" and s!=null then
//		call echo("["+s+"]")
		call FuncSendMessageToChat(GetStringAddress(s),false)
	endif
//call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,10,"["+s+"] preloaded")
	if c>20 then
//		call FuncSendMessageToChat(GetStringAddress("-sleep"),false)
		call DisableTrigger(GetTriggeringTrigger())
	elseif c==1 then
		set s=ReadStringFromFile(DotaConfigFile,"GAME_OPTIONS_ASYNC","DisableCaptionsOverCreeps","false")
		if s!="false" then
			
		endif
	endif
endfunction

function EvasionSourceDeactivate takes nothing returns nothing
	local integer id=LoadInteger(HY,GetHandleId(GetExpiredTimer()),0)
	set EvasionSourcesActive[id]=false
endfunction

function EvasionSourceActivate takes integer evsourceid, real dur returns nothing
	if EvasionSourcesTimers[evsourceid]==null then
		set EvasionSourcesTimers[evsourceid]=CreateTimer()
		call SaveInteger(HY,GetHandleId(EvasionSourcesTimers[evsourceid]),0,evsourceid)
	endif
	if TimerGetRemaining(EvasionSourcesTimers[evsourceid]) < dur then
		call TimerStart(EvasionSourcesTimers[evsourceid],dur,false,function EvasionSourceDeactivate)
	endif
	set EvasionSourcesActive[evsourceid]=true
endfunction

function IMinIF takes integer a,integer b returns integer
	if(a<b)then
		return a
	else
		return b
	endif
endfunction

function RMinIF takes real a,real b returns real
	if(a<b)then
		return a
	else
		return b
	endif
endfunction

function RMaxIF takes real a,real b returns real
	if(a<b)then
		return b
	else
		return a
	endif
endfunction

function CleanTimer takes timer t returns nothing
	call PauseTimer(t)
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTimer(t)
endfunction

function UnitChannelingSomething takes unit u, boolean b returns nothing
	call SaveBoolean(HY,GetHandleId(u),'CHNL',b)
endfunction

function IsUnitChannelsSomething takes unit u returns boolean
	return LoadBoolean(HY,GetHandleId(u),'CHNL')
endfunction

function DelayedInstantOrderAct takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call IssueImmediateOrderById(LoadUnitHandle(HY,h,0),LoadInteger(HY,h,0))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function DelayedInstantOrder takes unit u, integer order, real delay returns nothing
	local timer t=CreateTimer()
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call SaveInteger(HY,GetHandleId(t),0,order)
	call TimerStart(t,delay,false,function DelayedInstantOrderAct)
	set t=null
endfunction

function RemoveUnitDelayedFinish takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call RemoveUnit(LoadUnitHandle(HY,h,0))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function RemoveUnitDelayed takes unit u, real delay returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,u)
	call TimerStart(t,delay,false,function RemoveUnitDelayedFinish)
	set t=null
endfunction

function UnitRemoveAbilityDelayedFinish takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call UnitRemoveAbility(LoadUnitHandle(HY,h,0),LoadInteger(HY,h,0))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function UnitRemoveAbilityDelayed takes unit u, integer i, real delay returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,u)
	call SaveInteger(HY,h,0,i)
	call TimerStart(t,delay,false,function UnitRemoveAbilityDelayedFinish)
	set t=null
endfunction

function WriteImageOnGround takes string S,real SizeX,real SizeY,real PosX,real PosY,real PosZ,boolean Show returns nothing
	set tt_image1=CreateImage(S,SizeX,SizeY,0,PosX-(SizeX/ 2),PosY-(SizeY/ 2),PosZ,0,0,0,2)
	call SetImageRenderAlways(tt_image1,true)
	call ShowImage(tt_image1,true)
endfunction

function AddWrapper takes string s, integer lvl returns nothing
	local integer i=0
	loop
		exitwhen HaveSavedString(UTable,'DMGE'+lvl,i)==false
		if LoadStr(UTable,'DMGE'+lvl,i)==s then
			return
		endif
		set i=i+1
	endloop
	call SaveStr(UTable,'DMGE'+lvl,i,s)
endfunction

function RectF takes real x1, real y1, real x2, real y2 returns rect
	call AddLightning("FORK",false,x1,y2,x1,y1)
	call AddLightning("FORK",false,x1,y1,x2,y1)
	call AddLightning("FORK",false,x2,y1,x2,y2)
	call AddLightning("FORK",false,x1,y2,x2,y2)
	set bj_lastCreatedTextTag = CreateTextTag()
	call SetTextTagText(bj_lastCreatedTextTag,I2S(tt_int1),0.025)
	call SetTextTagPos(bj_lastCreatedTextTag, (x1+x2)/2,(y1+y2)/2, 64)
	call SetTextTagColor(bj_lastCreatedTextTag, 255, 255, 255, 255)
	set tt_int1=tt_int1+1
	return Rect(x1,y1,x2,y2)
endfunction

function StunFor001 takes unit u returns nothing
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A0R9')//A0R9 -> Generic_Ministun
	call IssueTargetOrder(d,"thunderbolt",u)
	set d=null
endfunction

function DummyDamageTrackingDisable takes nothing returns nothing
	set DummyDamageState=false
endfunction

function DummyDamageTracking takes real r returns nothing
	if DummyDamageTimer==null then
		set DummyDamageTimer=CreateTimer()
	endif
	if r > TimerGetRemaining(DummyDamageTimer) then
		call TimerStart(DummyDamageTimer,r,false,function DummyDamageTrackingDisable)
	endif
	set DummyDamageState=true
endfunction

function IssueTargetOrderVis takes unit d, string order, unit t returns boolean
	local boolean b=IssueTargetOrder(d,order,t)
	if b==false then
		call UnitShareVision(t,GetOwningPlayer(d),true)
		set b=IssueTargetOrder(d,order,t)
		call UnitShareVision(t,GetOwningPlayer(d),false)
	endif
	return b
endfunction

function HideAbility takes integer id returns nothing
	call SetPlayerAbilityAvailable(Player(1),id,false)
	call SetPlayerAbilityAvailable(Player(2),id,false)
	call SetPlayerAbilityAvailable(Player(3),id,false)
	call SetPlayerAbilityAvailable(Player(4),id,false)
	call SetPlayerAbilityAvailable(Player(5),id,false)
	call SetPlayerAbilityAvailable(Player(7),id,false)
	call SetPlayerAbilityAvailable(Player(8),id,false)
	call SetPlayerAbilityAvailable(Player(9),id,false)
	call SetPlayerAbilityAvailable(Player(10),id,false)
	call SetPlayerAbilityAvailable(Player(11),id,false)
endfunction

function PRD_Get takes unit u, integer abilId, real chance returns boolean
	local integer h=GetHandleId(u)
	local real fxdchance=R2I(chance/5.)*5.
	local real add=LoadReal(PRDtable,-1,R2I(fxdchance/5.)-1)
	local real curchance=LoadReal(PRDtable,h,abilId)
	local real rnd=GetRandomReal(0.0,1.0)
	if IsUnitType(u,UNIT_TYPE_HERO)==false then
		return GetRandomInt(1,100)<chance
	endif
	if rnd<curchance+add then
		call SaveReal(PRDtable,h,abilId,0.0)
		return true
	else
		call SaveReal(PRDtable,h,abilId,curchance+add)
		return false
	endif
endfunction

function TriggerRegisterPlayersChat takes trigger t, string s, boolean strict returns nothing
	call TriggerRegisterPlayerChatEvent(t,Sentinels[1],s,strict)
	call TriggerRegisterPlayerChatEvent(t,Sentinels[2],s,strict)
	call TriggerRegisterPlayerChatEvent(t,Sentinels[3],s,strict)
	call TriggerRegisterPlayerChatEvent(t,Sentinels[4],s,strict)
	call TriggerRegisterPlayerChatEvent(t,Sentinels[5],s,strict)
	call TriggerRegisterPlayerChatEvent(t,Scourges[1],s,strict)
	call TriggerRegisterPlayerChatEvent(t,Scourges[2],s,strict)
	call TriggerRegisterPlayerChatEvent(t,Scourges[3],s,strict)
	call TriggerRegisterPlayerChatEvent(t,Scourges[4],s,strict)
	call TriggerRegisterPlayerChatEvent(t,Scourges[5],s,strict)
endfunction

function IsUnitVisibleLoD takes unit u, player p returns boolean
	return IsUnitVisible(u,p) and (GetUnitAbilityLevel(u,'A1HX')==0 or IsUnitAlly(u,p))//A1HX -> Shadow Dance 2
endfunction

function UnitAddAbility2 takes unit Hero,integer aid returns boolean
	return UnitAddAbility(Hero,aid) and UnitMakeAbilityPermanent(Hero,true,aid)
endfunction

function UnitAddAbility3 takes unit u,integer id,integer lvl returns nothing
	if GetUnitAbilityLevel(u,id)==0 then
		call UnitAddAbility2(u,id)
	endif
	call SetUnitAbilityLevel(u,id,lvl)
endfunction

function GetProperAttachPoint_Weapon takes unit u returns string
	local integer i=GetUnitTypeId(u)
	if i=='EC57' or i=='Hamg' or i=='E01Y' or i=='H00K' or i=='N0HP' or i=='Ucrl'  then//EC57 -> Venomancer, Hamg -> Treant Protector, E01Y -> Templar Assassin, H00K -> Goblin Techies, N0HP -> Ancient Apparition, Ucrl -> Stone Giant
		return "hand"
	endif//veno Treant lanaya techies aa tony
	return "weapon"
endfunction

function GetProperAttachPoint_Foot takes unit u returns string
	local integer i=GetUnitTypeId(u)
	if i=='UC76' or i=='N0HP' or i=='Ulic' or i=='O016' or i=='O017' then//UC76 -> Death Prophet, N0HP -> Ancient Apparition, Ulic -> Lich, O016 -> Batrider, O017 -> Batrider
		return "origin"
	endif//Krobelus, aa, lich, bat rider
	return "foot"
endfunction

function LotusOrbFX takes unit u returns nothing
	call DestroyEffect(AddSpecialEffectTarget(GetAbilityEffectById('A3E9',EFFECT_TYPE_EFFECT,0),u,GetAbilityEffectById('A3E9',EFFECT_TYPE_EFFECT,1)))
endfunction

function ExeFunc takes string s returns nothing
//	call PreloadEndEx()
//	call PreloadGenClear()
//	call PreloadGenStart()
//	call Preload(s)
//	call PreloadGenEnd("exec"+R2S(GetRandomReal(0,500))+".txt")
//	call PreloadGenClear()
	call ExecuteFunc(s)
endfunction

function PidToChar takes integer i returns string
	if i==10 then
		return ":"
	elseif i==11 then
		return ";"
	endif
	return I2S(i)
endfunction

// RMD - SyncInteger Functions
function Traffic_RegisterCustomData takes string parent, string child, integer value returns nothing
	call StoreInteger(RGCGC,parent,child,value)
	call SyncStoredInteger(RGCGC,parent,child)
endfunction

function Traffic_RegisterCustomMetaData takes string parent, string child, integer value returns nothing
	call StoreInteger(RGCGC2,parent,child,value)
	call SyncStoredInteger(RGCGC2,parent,child)
endfunction

function Traffic_RegisterCustomGlobalData takes string parent, string child, integer value returns nothing
	call StoreInteger(RGCGC3,parent,child,value)
	call SyncStoredInteger(RGCGC3,parent,child)
endfunction

// RMD - Count players
function IsSomeTeamEmpty takes nothing returns boolean
	local integer n=0
	local integer i=1
	local player p
	local boolean b=false
	loop
		set p = Player(i)
		if GetPlayerController(p)==MAP_CONTROL_USER and GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING then
			set n=n+1
		endif
		
		set i=i+1
		if i==6 then
			if(n==0)then
				set b=true
			endif
			set i=7
			set n=0
		elseif i==12 then
			if(n==0)then
				set b=true
			endif
		endif
		exitwhen i>11 or b
	endloop
	return b
endfunction

// RMD SendStats
function RMD_SendStats takes nothing returns nothing
	local integer i=0
	local integer n=1
	
	if RMD_StatsSent then
		return
	endif
 
	// Toggle Sent
	set RMD_StatsSent=true//RGC accept stats only once
	// Loop
	loop
		call Traffic_RegisterCustomData("a",PidToChar(i),Kills[n])
		call Traffic_RegisterCustomData("b",PidToChar(i),Deaths[n])
		call Traffic_RegisterCustomData("c",PidToChar(i),Assists[n])//assists
		call Traffic_RegisterCustomData("d",PidToChar(i),PlayerCS[n])//cs
		call Traffic_RegisterCustomData("e",PidToChar(i),CSDenies[n])
		call Traffic_RegisterCustomData("f",PidToChar(i),LoadInteger(HY,(400+n),79))//neutrals

		// Iterate
		set n=n+1
		set i=i+1

		// DotA Exception		
		if n==6 then
			set n=7
		endif

		exitwhen i==10
	endloop
endfunction

// RMD - A player left the game
function RMD_LeaveAction takes nothing returns nothing
	set RGCFFed[GetPlayerId(GetTriggerPlayer())]=true
	if IsSomeTeamEmpty()  then
		call RMD_SendStats()
	endif
endfunction
 
// RMD - Init Function (( call this asap ))
function RMD_Init takes nothing returns nothing
	local integer i=1
	local trigger t=CreateTrigger()
	local player p

	loop
		set p = Player(i)
		if GetPlayerController(p)==MAP_CONTROL_USER and GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING then
			call TriggerRegisterPlayerEventLeave(t,p)
		endif

		set i=i+1
		if i==6 then
			set i=7
		endif	
		exitwhen i==12
	endloop
 
	call TriggerAddAction(t,function RMD_LeaveAction)
	set t=null
endfunction
/////////////////////////
// RMD - Functions GetBottleWithRuneId //
/////////////////////////

//greatest function ever!
function herp takes nothing returns nothing
	call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"herp")
endfunction

function Char2Id takes string c returns integer
	local integer i=0
	local string abc="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
	local string t
	loop
		set t=SubString(abc,i,i+1)
		exitwhen t==null or t==c
		set i=i+1
	endloop
	if i<10 then
		return i+48
	elseif i<36 then
		return i+65-10
	endif
	return i+97-36
endfunction

function PreloadQuery takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local integer id
	local integer i=LoadInteger(HY,h,-1)
	local integer max=LoadInteger(HY,h,0)
	if i < max then
		set id=LoadInteger(HY,h,i+1)
		call UnitAddAbility(PreloaderUnit,id)
		call UnitRemoveAbility(PreloaderUnit,id)
		//call echo(Id2String(id)+" preloaded, i="+I2S(i)+", max="+I2S(max))
		call RemoveSavedInteger(HY,h,i+1)
		call SaveInteger(HY,h,-1,i+1)
	else
		//call echo("Query done, go 2 sleep")
		call PauseTimer(t)
		call SaveBoolean(HY,GetHandleId(PreloaderUnit),0,false)
		call SaveInteger(HY,h,0,0)
		call SaveInteger(HY,h,-1,0)
	endif
	set t=null
endfunction

function PreloadQueryAdd takes integer id returns nothing
	local integer hu=GetHandleId(PreloaderUnit)
	local timer t=LoadTimerHandle(HY,hu,0)
	local integer h=GetHandleId(t)
	local integer i
	if LoadBoolean(HY,hu,0) then//timer ticks
		set i=LoadInteger(HY,h,0)+1
		//call echo(Id2String(id)+" added to query")
	else
		//call echo("Query initialized")
		call TimerStart(t,0.1,true,function PreloadQuery)
		call SaveBoolean(HY,hu,0,true)
		set i=1
	endif
	call SaveInteger(HY,h,i,id)
	call SaveInteger(HY,h,0,i)
	set t=null
endfunction

function PreloadAbilityInstant takes integer id returns nothing
	call UnitAddAbility(PreloaderUnit,id)
	call UnitRemoveAbility(PreloaderUnit,id)
endfunction

function ThrowLog takes nothing returns nothing
	local string s=""
	local integer i=1
	local integer k=1
	loop
		set k=1
		set s=s+"\n"+I2S(i)+" :"
		loop
			if SkillID[PlayerSkillNumber[i*PlayerSkillOffset+k]]!=0 then
				set s=s+Id2String(SkillID[PlayerSkillNumber[i*PlayerSkillOffset+k]])+" "
			endif
			set k=k+1
			exitwhen k>PlayerSkillOffset
		endloop
		set i=i+1
		if i==6 then
			set i=7
		endif
		
		exitwhen i>11
	endloop
	call PreloadEndEx()
	call PreloadGenClear()
	call PreloadGenStart()
	call Preload(s)
	//call PreloadGenEnd("LoD/exec"+R2S(GetRandomReal(0,5000000))+".txt")
	if GetObjectName('TEST')=="L1ch" then//TEST -> L1ch2
		call PreloadGenEnd("exec"+R2S(GetRandomReal(0,5000000))+".txt")
	endif
	call PreloadGenClear()
endfunction

function HaveBonusEffect takes string s returns boolean
	return false// or s=="df" or s=="zloy_xex" or s=="grief-code"
endfunction

function BonusEffectWrapper takes unit u, unit origin returns nothing
	local integer pid=GetPlayerId(GetOwningPlayer(u))
	local integer aid
	if IsUnitIllusion(u) then
		if GetUnitAbilityLevel(origin,LoadInteger(UMD,GetUnitTypeId(origin),5))>0 then
			call UnitAddAbility2(u,LoadInteger(UMD,GetUnitTypeId(origin),5))
		endif
	else
	endif
endfunction

//Systems:
//
//  Timer
//   - deals with timer recycling
//   - pretty simple, just use CreateTimer() instead of CreateTimer(), and Timer_End() instead of DestroyTimer()
//   - Timer_End() both stops the timer, and flushes the timers handle from the hashtable MHT
//   - note it does NOT flush hashtable HY
//
//
//  Movement
//   - can add both constant or percentage movespeed bonuses
//   - isnt really that useful, but is used for a few things
//   - is best for used for providing a movespeed increase without a buff
//   - can only increase movespeed, i didn't feel like adding another 100 abilities to deal with negative speeds as well, especially considering it probably wont be used \:3
//
//
//  Stats
//   - Deals with adding bonus damage, armour, regen, mana regen, or attack speed
//   - Use LoDStat_Set to set the value of one of these properties of a unit. Protip: dont use LoDStat_Set() since then you have to manually keep track of the bonuses a unit has
//	 instead use LoDStat_Add() and LoDStat_Sub() to add and subtract any bonuses, since these will not overide other bonuses the unit already has
//   - uses bitflagging to add the correct amount
//   - damage, armour, and attack speed can also add negative amounts
//
//
//  Buffs
//   - Adds a buff to a unit
//   - Can set the buff to last to certain amount of time, or forever if the duration passed is less than 0
//
//
//  Passive Cooldown
//   - Causes a skill to go into cooldown
//   - note that while the original passive skill is actually removed from the unit, while the dummy skill is on cooldown
//   - I'm not sure if this will cause issues with illusions \:3/
//
//
//  Other things to note:
//   - Movement, Buffs, Cooldown, and Stats systems all make the abilities they add permenant, to prevent bugs with transformation
//
//
//  Events
//   - uses only 2 triggers to register events, instead of a new trigger for every spell
//   - GAME_TRIGGER registers all spell, damage, attack, order events
//   - CHAT_TRIGGER registers chat events :3
//   - this only applies to spell I recoded, the older spells still use their own triggers to register events
//   - all setup is done in LoDEvent_Init()
//   - specific events such as orders, spells or damage are added when the hero enters the map
//
//==================================================================================================================================================

function Timer_End takes timer t returns nothing
	call PauseTimer(t)
	call FlushChildHashtable(MHT,GetHandleId(t))
	call DestroyTimer(t)
endfunction

function SaveCourierState takes unit u, string s returns nothing
	call SaveStr(HeroStats,GetHandleId(u),'ORDR',s)
endfunction

function IsTriggeredOrder takes unit u returns boolean
	return LoadBoolean(HeroStats,GetHandleId(u),'ORDR')
endfunction

function CourierIssuePointOrder takes unit u, integer orderid, real x, real y returns boolean
	local boolean b
	call SaveBoolean(HeroStats,GetHandleId(u),'ORDR',true)
	set b=IssuePointOrderById(u,orderid,x,y)
	call SaveBoolean(HeroStats,GetHandleId(u),'ORDR',false)
	return b
endfunction

function GetIndex takes item B38 returns integer
	local integer ZF8
	local integer i=1
	if B38==null then
		return-2
	endif
	set ZF8=GetItemTypeId(B38)
	loop
		if Item_Dummy[i]==ZF8 or Item_Real[i]==ZF8 or Item_Mute[i]==ZF8 then
			return i
		endif
		set i=i+1
		exitwhen i>ITC
	endloop
	return-1
endfunction

function Func0404 takes unit u,integer id returns boolean
	local item it
	local boolean invAdded=false
	local boolean added=true
	set it=CreateItem(id,GetUnitX(u),GetUnitY(u))
	if GetUnitAbilityLevel(u,'AInv')==0 then//AInv -> Inventory
		set invAdded=true
		call UnitAddAbility2(u,'AInv')//AInv -> Inventory
	endif
	if UnitAddItem(u,it)==false then
		set added=false
	elseif GetWidgetLife(it)>0 then
		set added=false
	endif
	call RemoveItem(it)
	if invAdded then
		call UnitRemoveAbility(u,'AInv')//AInv -> Inventory
	endif
	set it=null
	return added
endfunction

function IssueTargetOrderNoLinken takes unit d, integer order, unit u returns boolean
	local boolean b=UnitRemoveAbility(u,'B0BI')//B0BI -> Linken Sphere
	local boolean res=IssueTargetOrderById(d,order,u)
	if b and res then
		call Func0404(u,'I0HM')//I0HM -> Linken's Sphere
	endif
	return res
endfunction

function GetUnitOffsetSpeed takes unit u returns integer
	local integer lvl = GetUnitAbilityLevel(u,'EUL1') //euls
	local integer lvl2 = GetUnitAbilityLevel(u,'EUL2') //euls
	local integer movespeed
	if GetUnitAbilityLevel(u,'A33W')>0 then
		return 1000
	endif
	if lvl > 0 then
		if lvl==1 then
			set movespeed=40
		elseif lvl==2 then
			set movespeed=90
		elseif lvl==4 then
			set movespeed=95
		else
			set movespeed=100
		endif
	endif
	if lvl2>0 then
		if lvl2==1 then
			set movespeed=125
		elseif lvl2==2 then
			set movespeed=140
		endif
	endif
	if lvl+lvl2>0 then
		return movespeed
	endif
	if GetUnitAbilityLevel(u,'A00D')>0 then //travels//A00D -> Boots of travel speed
		return 100
	elseif GetUnitAbilityLevel(u,'A2HR')>0 then //tranquil boots//A2HR -> Iron Boots Speed Bonus
		return 85
	elseif GetUnitAbilityLevel(u,'A1VR')>0 then //mana boots//A1VR -> Arcane Boots Speed Bonus
		return 55
	elseif GetUnitAbilityLevel(u,'A05U')>0 or GetUnitAbilityLevel(u,'A12V')>0 then //power treads and phase boots//A05U -> Item Move Power Treads, A12V -> Phase Boots Speed Bonus
		return 50
	elseif GetUnitAbilityLevel(u,'AIms')>0 then //boots of speed//AIms -> Item Move Speed Bonus
		return 50
	elseif GetUnitAbilityLevel(u,'A2I9')>0 then //broken tranquil boots//A2I9 -> Iron Boots Speed Bonus Broken
		return 60
	endif
	return 0
endfunction

function GetUnitMoveSpeedLOD takes unit u returns real
	if LoadReal(HeroStats,GetHandleId(u),99)>0 then
		return LoadReal(HeroStats,GetHandleId(u),99)+GetUnitMoveSpeed(u)
	endif
	return GetUnitMoveSpeed(u)
endfunction

function LodStat_Count takes string s returns integer
	if s == "damage" then
		return LoDDamageAbilityCount
	elseif s == "damageneg" then
		return LoDDamageNegAbilityCount
	elseif s == "armour" then
		return LoDArmourAbilityCount
	elseif s == "armourneg" then
		return LoDArmourNegAbilityCount
	elseif s == "regen" then
		return LoDRegenAbilityCount
	elseif s == "manaregen" then
		return LoDManaRegenAbilityCount
	elseif s == "attack" then
		return LoDAttackAbilityCount
	elseif s == "attackneg" then
		return LoDAttackNegAbilityCount
	else
		call BJDebugMsg("Derp, invalid stat: "+s)
		return 0
	endif
endfunction

function LodStat_Base takes string s returns integer
	set s=StringCase(s,false)
	if s == "damage" then
		return LoDDamageAbilityBase
	elseif s == "damageneg" then
		return LoDDamageNegAbilityBase
	elseif s == "armour" then
		return LoDArmourAbilityBase
	elseif s == "armourneg" then
		return LoDArmourNegAbilityBase
	elseif s == "regen" then
		return LoDRegenAbilityBase
	elseif s == "manaregen" then
		return LoDManaRegenAbilityBase
	elseif s == "attack" then
		return LoDAttackAbilityBase
	elseif s == "attackneg" then
		return LoDAttackNegAbilityBase
	else
		call BJDebugMsg("Derp, invalid stat: "+s)
		return 0
	endif
endfunction

function LoDStat_Set takes unit u, integer i, string s returns integer
	local integer loopA = 0
	local integer base = LodStat_Base(s)	   //lowest ability ID of the set of abilities
	local integer total = LodStat_Count(s)	 //number of abilities there are in the system
	local integer limit= R2I(Pow(2,total) - 1) //max amount a unit can have from the system
	local integer r = i
	local real temp
	if i > limit then
		loop
			call UnitAddAbility(u,base+loopA)
			set loopA = loopA + 1
			exitwhen loopA > limit
		endloop
		return limit
	elseif 1>i then
		loop
			call UnitRemoveAbility(u,base+loopA)
			set loopA = loopA + 1
			exitwhen loopA > limit
		endloop
		return 0
	endif
	set temp = i/2.
	set i = i/2
	loop
		if i == temp or 0 > i then
			call UnitRemoveAbility(u,base + loopA)
		else
			call UnitAddAbility(u,base + loopA)
			//call BJDebugMsg(I2S(loopA)+"   "+B2S(UnitAddAbility(u,base + loopA)))
			call UnitMakeAbilityPermanent(u, true, base + loopA)
		endif
		set temp = i/2.
		set i = i/2
		set loopA = loopA + 1
		exitwhen loopA == total
	endloop
	return r
endfunction

function LoDStat_Get takes unit u, string s returns integer
	local integer loopA = 0
	local integer base = LodStat_Base(s)	   //lowest ability ID of the set of abilities
	local integer total = LodStat_Count(s)	 //number of abilities there are in the system
	local real current = 0
	loop
		if GetUnitAbilityLevel(u,base+loopA)==1then
			set current = current + Pow(2,loopA)
		endif
		set loopA = loopA + 1
		exitwhen loopA > total
	endloop
	return R2I(current)
endfunction

function LoDStat_Add takes unit u, integer i, string s returns integer
	return LoDStat_Set(u,LoDStat_Get(u,s)+i,s)
endfunction

function LoDStat_Sub takes unit u, integer i, string s returns integer
	local integer i2 = LoDStat_Set(u,LoDStat_Get(u,s)-i,s)

	if s=="manaregen" and 1>i2 then
		call UnitRemoveAbility(u,'Barm') //hidden buff for mana regen \:3///Barm -> Mana Regeneration Aura
	endif

	return i
endfunction

function LoDStat_Modify takes unit u, integer i, string s returns integer
	return LoDStat_Set(u,LoDStat_Get(u,s)+i,s)
endfunction

function LoDStat_Init takes nothing returns nothing
	//isnt needed, just used for preloading
	local unit u = CreateUnit(Player(15),'H00Y',0,0,270)//H00Y -> Preloader Hero
	call LoDStat_Set(u,2000,"damage")
	call LoDStat_Set(u,2000,"damageneg")
	call LoDStat_Set(u,2000,"armour")
	call LoDStat_Set(u,2000,"armourneg")
	call LoDStat_Set(u,2000,"regen")
	call LoDStat_Set(u,2000,"manaregen")
	call LoDStat_Set(u,2000,"attack")
	call LoDStat_Set(u,2000,"attackneg")
	call RemoveUnit(u)
	set u = null
endfunction

function Buff_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer id_b = LoadInteger(HY,info,1)
	local unit u = LoadUnitHandle(HY,info,0)

	call RemoveSavedHandle(HY,GetHandleId(u),id_b)
	call UnitRemoveAbility(u,LoadInteger(HY,info,0))
	call UnitRemoveAbility(u,id_b)
	call FlushChildHashtable(HY,info)
	call DestroyTimer(t)

	set t = null
	set u = null
endfunction

function Buff_Remove takes unit u, integer id_b returns nothing
	if GetUnitAbilityLevel(u,id_b)==0 and(IsUnitType(u,UNIT_TYPE_STRUCTURE) and GetUnitAbilityLevel(u,LoadInteger(HY,GetHandleId(LoadTimerHandle(HY,GetHandleId(u),id_b)),0))==0)then
		return
	endif

	call TimerStart(LoadTimerHandle(HY,GetHandleId(u),id_b),0.,false,function Buff_End)
	call UnitRemoveAbility(u,id_b)
endfunction

function Buff_Add takes unit u, integer id_a, integer id_b, real duration returns nothing
	local timer t = null
	local integer info
	set IsRealDamage = false
	if GetUnitAbilityLevel(u,id_b)==0then
		set t = CreateTimer()
	else
		set t = LoadTimerHandle(HY,GetHandleId(u),id_b)
	endif
	set info = GetHandleId(t)
	if HaveSavedInteger(HY,info,0)and LoadInteger(HY,info,0)!=id_a then //prevents permanently having an ability :S
		call UnitRemoveAbility(u,LoadInteger(HY,info,0))
	endif
	call SaveTimerHandle(HY,GetHandleId(u),id_b,t)
	call UnitAddAbility2(u,id_a)
	set IsRealDamage = true
	call SaveUnitHandle(HY,info,0,u)
	call SaveInteger(HY,info,0,id_a)
	call SaveInteger(HY,info,1,id_b)
	if duration>0then
		call TimerStart(t,duration,false,function Buff_End)
	endif
	set t = null
endfunction

function isMorphedUnit takes unit u returns boolean
	local integer uid=GetUnitTypeId(u)
	set Lich_MorphedSkillId=0
	if uid=='N01J' or uid=='N01T' or uid=='N0HT' or uid=='H600' or uid=='H601' or uid=='H602' then //alchemist//N01J -> Alchemist, N01T -> Alchemist, N0HT -> Alchemist, H600 -> Alchemist, H601 -> Alchemist, H602 -> Alchemist
		if Mode_BO then
			set Lich_MorphedSkillId='ANcr'//ANcr -> Chemical Rage
		else
			set Lich_MorphedSkillId='QB0K'//QB0K -> Chemical Rage
		endif
	elseif uid=='N017' or uid=='N02B' or uid=='QTW2' or uid=='QTW3' then//troll//N017 -> Troll Warlord, N02B -> Troll Warlord, QTW2 -> Troll Warlord, QTW3 -> Troll Warlord
		set Lich_MorphedSkillId='A0BE'//A0BE -> Berserker Rage
	elseif uid=='N013' or uid=='N014' or uid=='N015' then //bear//N013 -> Lone Druid, N014 -> Lone Druid, N015 -> Lone Druid
		set Lich_MorphedSkillId='A0AG'//A0AG -> True Form
	elseif uid=='H00F' or uid=='H00E' or uid=='H00F' then //dk//H00F -> Dragon Knight, H00E -> Dragon Knight, H00F -> Dragon Knight
		set Lich_MorphedSkillId='QM00'//QM00 -> Elder Dragon Form
	elseif uid=='E015' then//lycan//E015 -> Lycanthrope
		set Lich_MorphedSkillId='QM02'//QM02 -> Shapeshift
	elseif uid=='H06X' or uid=='H06Y' or uid=='H06W' then//ezalor//H06X -> Keeper of the Light, H06Y -> Keeper of the Light 2, H06W -> Keeper of the Light 3
		set Lich_MorphedSkillId='QM01'//QM01 -> Spirit Form
	elseif uid=='H07I' then//flesh golem//H07I -> Flesh Golem
		set Lich_MorphedSkillId='QM03'//QM03 -> Flesh Golem
	elseif uid=='O017' then//firefly//O017 -> Batrider
		set Lich_MorphedSkillId='QM04'//QM04 -> Firefly
	elseif uid=='H08D' or uid=='H08C' or uid=='H08B' or uid=='H084' then//splitshot//H08D -> Gorgon, H08C -> Gorgon, H08B -> Gorgon, H084 -> Gorgon
		return true
	elseif uid=='N0MA' or uid=='N0MB' or uid=='N0MC' or uid=='N0MO' then//arctic burn//N0MA -> Winter Wyvern, N0MB -> Winter Wyvern, N0MC -> Winter Wyvern, N0MO -> Winter Wyvern
		return true
		
	endif
	return Lich_MorphedSkillId>0
endfunction

function IsBackMorph takes nothing returns boolean
	local integer id=GetSpellAbilityId()
	if id=='QM00' or id=='QM01' or id=='QB0K' or id=='QM02' or id=='QM03' or id=='QM04' or id=='A1RI' or id=='A332' then
		return isMorphedUnit(GetTriggerUnit())
	endif
	return false
endfunction

function Passive_Cooldown_Finish takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer spell = LoadInteger(MHT,info,0)
	local unit u = LoadUnitHandle(MHT,info,0)
	local integer level = GetUnitAbilityLevel(u,LoadInteger(MHT,info,2))
	local boolean b = UnitRemoveAbility(u,LoadInteger(MHT,info,1))==false
	local integer PlayerId=GetPlayerId(GetOwningPlayer(u))
	if spell=='A065' and SkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+6]]=='A065' then//A065 -> Rearm, A065 -> Rearm
		set level=ExtraAbilityLevel[GetPlayerId(GetOwningPlayer(u))*2+2]
	endif
	set IsRealDamage = false
	call UnitAddAbility(u,spell)
	if GetUnitAbilityLevel(u,spell)==0 or b then //detects if the unit has the agha version, or had it and then dropped it
		if b then
			call UnitRemoveAbility(u,spell) //removes the agha version, if the unit no longer has agha
			set spell = LoadInteger(MHT,info,3)
			call UnitAddAbility(u,spell)
		else
			set spell = LoadInteger(MHT,info,3)
		endif
		call UnitRemoveAbility(u,LoadInteger(MHT,info,4))
		set level = GetUnitAbilityLevel(u,LoadInteger(MHT,info,5))
	endif
	call UnitMakeAbilityPermanent(u,true,spell)
	call SetUnitAbilityLevel(u,spell,level)
	set IsRealDamage = true
	if LoadBoolean(MHT,info,0)then
		call SaveBoolean(MHT,GetHandleId(u),spell,LoadBoolean(MHT,spell,1))
	endif
	call Timer_End(t)
	set t = null
	set u = null
endfunction

function Passive_Cooldown takes unit u, integer spell, integer level returns nothing
	local unit d = CreateUnit(Player(14),'e00E',0,0,0)//e00E -> Spellcaster
	local timer t = CreateTimer()
	local integer info = GetHandleId(t)
	local integer new = LoadInteger(MHT,spell,0)
	local integer dummy = LoadInteger(MHT,spell,1)
	local integer save = GetHandleId(u)
	call SaveUnitHandle(MHT,info,0,u)
	call SaveInteger(MHT,info,0,spell)
	call SaveInteger(MHT,info,1,new)
	call SaveInteger(MHT,info,2,dummy)
	call SaveInteger(MHT,info,3,LoadInteger(MHT,dummy,2))
	call SaveInteger(MHT,info,4,LoadInteger(MHT,spell,2))
	call SaveInteger(MHT,info,5,LoadInteger(MHT,spell,3))
	set IsRealDamage = false
	call UnitRemoveAbility(u,spell)
	call UnitAddAbility(u,new)
	call SetUnitAbilityLevel(u,new,level)
	call UnitMakeAbilityPermanent(u,true,new)
	call SaveTimerHandle(MHT,save,spell,t)
	if LoadBoolean(MHT,spell,0)then
		call SaveBoolean(MHT,info,0,true)
		call SaveBoolean(MHT,save,spell,LoadBoolean(MHT,spell,1)==false)
	endif
	call UnitAddAbility(u,'A04R') //adds marker so the spell shield ability won't proc any triggered gudnes : 3//
	call UnitAddAbility(d,'A502')
	call IssueTargetOrder(d,"creepheal",u)
	call UnitRemoveAbility(u,'A04R') //remove marker after so the unit doesnt suddenly become supa stronk! :O//
	set IsRealDamage = true
	call TimerStart(t,LoadReal(MHT,spell,level),false,function Passive_Cooldown_Finish)
	set d = null
	set t = null
endfunction

function Passive_Cooldown_Learn takes unit u, integer spell, integer level returns nothing
	local integer check = LoadInteger(MHT,spell,0)
	if level==1then
		call UnitAddAbility(u,check)
		call UnitMakeAbilityPermanent(u,true,check)
		return
	endif
	call SetUnitAbilityLevel(u,check,level)
	call SetUnitAbilityLevel(u,LoadInteger(MHT,spell,1),level)
	call SetUnitAbilityLevel(u,LoadInteger(MHT,spell,2),level)
endfunction

//game code, its downhill from here...
//====================================================================================================================


function Passive_Cooldown_Init takes nothing returns nothing
	//Rearm
	call SaveBoolean(MHT,'A065',0,false)  //does the spell have additional data//A065 -> Rearm
	call SaveInteger(MHT,'A065',0,'A528') //dummy spell1, used to show the cooldown//A065 -> Rearm, A528 -> |cffffcc00R|rearm - [|cffffcc00Level 1|r]","|cffffcc00R|rearm - [|cffffcc00Level 2|r]","|cffffcc00R|rearm - [|cffffcc00Level 3|r]
	call SaveInteger(MHT,'A065',1,'A527') //dummy spell2, used for learning//A065 -> Rearm
	call SaveInteger(MHT,'A527',0,'A065') //lets the dummy spell know what spell should be leveled//A065 -> Rearm
	call SaveInteger(MHT,'A527',1,'A528') //lets the dummy spell know what dummy spell should be leveled//A528 -> |cffffcc00R|rearm - [|cffffcc00Level 1|r]","|cffffcc00R|rearm - [|cffffcc00Level 2|r]","|cffffcc00R|rearm - [|cffffcc00Level 3|r]
	call SaveReal(MHT,'A065',1,9)//A065 -> Rearm
	call SaveReal(MHT,'A065',2,6)//A065 -> Rearm
	call SaveReal(MHT,'A065',3,3)//A065 -> Rearm

	//Tidebringer
	call SaveBoolean(MHT,'A13T',0,false)  //does the spell have additional data//A13T -> Tidebringer
	call SaveInteger(MHT,'A13T',0,'A523') //dummy spell1//A13T -> Tidebringer, A523 -> Tidebringer
	call SaveInteger(MHT,'A13T',1,'A522') //dummy spell2//A13T -> Tidebringer, A522 -> Tidebringer
	call SaveInteger(MHT,'A522',0,'A13T')//A522 -> Tidebringer, A13T -> Tidebringer
	call SaveInteger(MHT,'A522',1,'A523')//A522 -> Tidebringer, A523 -> Tidebringer
	call SaveReal(MHT,'A13T',1,13)//A13T -> Tidebringer
	call SaveReal(MHT,'A13T',2,10)//A13T -> Tidebringer
	call SaveReal(MHT,'A13T',3,7)//A13T -> Tidebringer
	call SaveReal(MHT,'A13T',4,4)//A13T -> Tidebringer
endfunction

function LoDEvent_Init takes nothing returns nothing
	//EVENT_UNIT_SPELL_EFFECT
	call SaveStr(MHT,'A2NT',0,"Silencer_LastWord")//A2NT -> Last Word
	call SaveStr(MHT,'A0ES',0,"Spiritbreaker_EmpoweringHaste_Act")//A0ES -> Empowering Haste
	call SaveStr(MHT,'A0MT',0,"Netherblast_Start")//A0MT -> Nether Blast
	call SaveStr(MHT,'A09D',0,"Pugna_NetherWardSummon")//A0MT -> Nether Blast
	call SaveStr(MHT,'A1P8',0,"Spiritbreaker_Charge_StartWrap")//A1P8 -> Charge of Darkness
	call SaveStr(MHT,'A01I',0,"Pitlord_Firestorm_Start")//A01I -> Firestorm
	call SaveStr(MHT,'A1YY',0,"Phoenix_Sunray_Start")//A1YY -> Sun Ray
	call SaveStr(MHT,'A0O6',0,"Jakiro_Icepath_Start")//A0O6 -> Ice Path
	call SaveStr(MHT,'A0IL',0,"Alchemist_Acidspray_Start")//A0IL -> Acid Spray
	call SaveStr(MHT,'A1A8',0,"Tauren_Spirit_Start")//A1A8 -> Ancestral Spirit
	call SaveStr(MHT,'A21J',0,"Tauren_Spirit_Stop")//A21J -> Ancestral Spirit
	call SaveStr(MHT,'A2KZ',0,"Terrorblade_Reflection_Start")//A2KZ -> Reflection
	call SaveStr(MHT,'A04V',0,"Bane_Enfeeble_Condition")//A04V -> Enfeeble
	call SaveStr(MHT,'A0LV',0,"Chen_TestOfFaith_Wrapper")//A0LV -> Test of Faith
	call SaveStr(MHT,'A2MC',0,"Chen_Teleport_Condition")//A2MC -> Test of Faith
	call SaveStr(MHT,'A0NS',0,"Abbadon_Time_Start")//A0NS -> Borrowed Time
	call SaveStr(MHT,'A1DA',0,"Abbadon_Time_Start")//A1DA -> Borrowed Time Upgrade
	call SaveStr(MHT,'A1DP',0,"Razor_StaticLink_Start")//A1DP -> Static Link
	call SaveStr(MHT,'A2IS',0,"mySven_Warcry")//A2IS -> Warcry
	call SaveStr(MHT,'A0RP',0,"Templar_Trap_Place")//A0RP -> Psionic Trap
	call SaveStr(MHT,'A449',0,"Templar_Trap_Place")//A449 -> Psionic Trap
	
	call SaveStr(MHT,'A0RT',0,"Templar_Trap_Start")//A0RT -> Psionic Trap
	call SaveStr(MHT,'A0RQ',0,"Templar_Trap_Start")//A0RQ -> Psionic Trap
	call SaveStr(MHT,'A2ML',0,"Treant_LivingArmor")//A2ML -> Living Armor
	call SaveStr(MHT,'A2M1',0,"Gnoll_Flux_Start")//A2M1 -> Flux
	call SaveStr(MHT,'A2LM',0,"Gnoll_Field_Start")//A2LM -> Magnetic Field
	call SaveStr(MHT,'A2LL',0,"Gnoll_Spark_Start")//A2LL -> Spark Wraith
	call SaveStr(MHT,'A332',0,"Wyvern_Burn_Start")//A332 -> Arctic Burn
	call SaveStr(MHT,'DRKN',0,"Nightstalker_Darkness_Start")//DRKN -> Darkness
	call SaveStr(MHT,'DRKU',0,"Nightstalker_Darkness_Start")//DRKU -> Darkness upgrade
	call SaveStr(MHT,'A2LA',0,"Wyvern_SplinterBlast_StartWrapper")//A2LA -> Splinter Blast
	call SaveStr(MHT,'A2M0',0,"Zet_Tempest_Start")//A2M0 -> Tempest Double
	call SaveStr(MHT,'A136',0,"Admiral_Torrent")//A136 -> Torrent
	call SaveStr(MHT,'A11K',0,"Admiral_GhostShip")//A11K -> Ghost Ship
	call SaveStr(MHT,'A1NI',0,"Alchemist_UnstableConcoction")//A1NI -> Unstable Concoction
	call SaveStr(MHT,'A0E3',0,"AM_ManaVoidWrap")//A0E3 -> Mana Void
	call SaveStr(MHT,'AEbl',0,"AM_Blink")//AEbl -> Blink
	call SaveStr(MHT,'QB08',0,"AM_Blink")//QB08 -> Blink
	call SaveStr(MHT,'A0O1',0,"Beastmaster_WildAxes")//A0O1 -> Wild Axes
	call SaveStr(MHT,'A0O2',0,"Beastmaster_PrimalRoar")//A0O2 -> Primal Roar
	call SaveStr(MHT,'A289',0,"Beastmaster_PrimalRoar")//A289 -> Primal Roar
	call SaveStr(MHT,'A13Z',0,"Beastmaster_HawkInvis")//A13Z -> Invisibility
	call SaveStr(MHT,'A0B4',0,"Bounty_Track")//A0B4 -> Track
	call SaveStr(MHT,'QB0D',0,"Bounty_Track")//QB0D -> Track
	call SaveStr(MHT,'A07A',0,"Bounty_Windwalk")//A07A -> Wind Walk
	call SaveStr(MHT,'QB09',0,"Bounty_Windwalk")//QB09 -> Wind Walk
	call SaveStr(MHT,'QB0A',0,"SkeletonWalk")//
	call SaveStr(MHT,'A0FW',0,"BB_Goo")//A0FW -> Viscous Nasal Goo
	call SaveStr(MHT,'A0GP',0,"myBB_Spray")//A0GP -> Quill Spray
	
	call SaveStr(MHT,'A2O6',0,"Stampede_Cast")//A2O6 -> Stampede
	call SaveStr(MHT,'A384',0,"Stampede_Cast")//A384 -> Stampede
	call SaveStr(MHT,'A00L',0,"Double_Edge_StartWrapper")//A00L -> Double Edge
	call SaveStr(MHT,'A00S',0,"Centaur_HoofStomp")//A00S -> Hoof Stomp
	call SaveStr(MHT,'A0KM',0,"Chen_Penitence")//A0KM -> Penitence
	call SaveStr(MHT,'A28T',0,"Chen_HolyPersuation")//A28T -> Holy Persuasion
	call SaveStr(MHT,'A361',0,"Chen_HolyPersuation")//A361 -> Holy Persuasion
	call SaveStr(MHT,'A0LT',0,"Chen_HandOfGod")//A0LT -> Hand of God
	//call SaveStr(MHT,'A034',0,"Slardar_AmplifyDamage")//A034 -> Amplify Damage
	//call SaveStr(MHT,'QB0C',0,"Slardar_AmplifyDamage")//QB0C -> Amplify Damage
	call SaveStr(MHT,'A0DL',0,"EnchantedTotemCasting")//A0DL -> Enchant Totem
	call SaveStr(MHT,'A1CS',0,"Chen_HandOfGod")//A1CS -> Hand of God upgraded
	call SaveStr(MHT,'A0Z6',0,"Clockwerk_RocketFlare")//A0Z6 -> Rocket Flare
	call SaveStr(MHT,'A0Z5',0,"Clockwerk_PowerCogs_Start")//A0Z5 -> Power Cog
	call SaveStr(MHT,'A0Z8',0,"Clockwerk_Hookshot")//A0Z8 -> Hookshot
	call SaveStr(MHT,'A1CV',0,"Clockwerk_Hookshot")//A1CV -> Hookshot Upgrade
	call SaveStr(MHT,'A0Z4',0,"Clockwerk_BatteryAssault")//A0Z4 -> Battery Assault
	call SaveStr(MHT,'A03R',0,"CM_FreezingField")//A03R -> Freezing Field
	call SaveStr(MHT,'A0AV',0,"CM_FreezingField")//A0AV -> Freezing Field
	call SaveStr(MHT,'A1E9',0,"CM_Nova")//A1E9 -> Crystal Nova
	call SaveStr(MHT,'A14P',0,"Storm_StaticRemnant")//A14P -> Static Remnant
	call SaveStr(MHT,'A14R',0,"Storm_ElectricVortex")//A14R -> Electric Vortex
	call SaveStr(MHT,'A14O',0,"Storm_BallLightning")//A14O -> Ball Lightning
	call SaveStr(MHT,'A3FJ',0,"Storm_BallLightning")//A14O -> Ball Lightning
	call SaveStr(MHT,'A0AR',0,"DK_DragonTail")//A0AR -> Dragon Tail
	call SaveStr(MHT,'QB0G',0,"DK_DragonTail")//QB0G -> Dragon Tail
	call SaveStr(MHT,'A03G',0,"DK_DragonForm_Act")//A03G -> Elder Dragon Form
	call SaveStr(MHT,'QM00',0,"DK_DragonForm_Act")//QM00 -> Elder Dragon Form
	call SaveStr(MHT,'A03F',0,"DK_BreatheFire")//A03F -> Breathe Fire
	call SaveStr(MHT,'A2QI',0,"Kaolin_GeomagneticGrip_Effect")//A2QI -> Geomagnetic Grip
	call SaveStr(MHT,'A2TH',0,"Kaolin_Stones_SummonStart")//A2TH -> Stone Caller
	call SaveStr(MHT,'A2QM',0,"Kaolin_BoulderSmash_InitSup")//A2QM -> Boulder Smash
	call SaveStr(MHT,'A2QT',0,"Oracle_FortunesEnd_Sup")//A2QT -> Fortune's End
	call SaveStr(MHT,'A2T5',0,"Oracle_FatesEdict_Sup")//A2T5 -> Fate's Edict
	call SaveStr(MHT,'A2SG',0,"Oracle_PurifingFlames_InitSup")//A2SG -> Purifying Flames
	call SaveStr(MHT,'A2TF',0,"Oracle_FalsePromise_Start")//A2TF -> False Promise
	call SaveStr(MHT,'QB11',0,"Oracle_FalsePromise_Start")//QB11 -> False Promise
	call SaveStr(MHT,'A0SK',0,"ES_Fissure")//A0SK -> Fissure
	call SaveStr(MHT,'A0DH',0,"ES_EchoSlam_Act")//A0DH -> Echo Slam
	call SaveStr(MHT,'A1OB',0,"ES_EchoSlam_Act")//A1OB -> Echo Slam
	call SaveStr(MHT,'A01B',0,"Enchantress_NaturesAttendants")//A01B -> Nature's Attendants
	call SaveStr(MHT,'A0DX',0,"Enchantress_Enchant")//A0DX -> Enchant
	call SaveStr(MHT,'A0B1',0,"Enigma_MidnightPulse")//A0B1 -> Midnight Pulse
	call SaveStr(MHT,'A0I7',0,"Enigma_Malefice_InitSup")//A0I7 -> Malefice
	call SaveStr(MHT,'A180',0,"Enigma_DemonicConversion")//A180 -> Demonic Conversion
	call SaveStr(MHT,'A1BX',0,"Enigma_BlackHole")//A1BX -> Black Hole
	call SaveStr(MHT,'A30L',0,"Enigma_BlackHole")//A30L -> Black Hole
	call SaveStr(MHT,'A09W',0,"Lion_FingerOfDeath_Splash")//A09W -> Finger of Death
	call SaveStr(MHT,'A0SC',0,"Puck_WaningRift")//A0SC -> Waning Rift
	call SaveStr(MHT,'A1QP',0,"Puck_DreamCoil")//A1QP -> Dream Coil
	call SaveStr(MHT,'A0S8',0,"Puck_DreamCoil")//A0S8 -> Dream Coil
	call SaveStr(MHT,'A0S9',0,"Puck_IllusoryOrb")//A0S9 -> Illusory Orb
	call SaveStr(MHT,'A0SA',0,"Puck_EtherealJaunt")//A0SA -> Ethereal Jaunt
	call SaveStr(MHT,'A21E',0,"Prophet_Sprout")//A21E -> Sprout
	call SaveStr(MHT,'A1W8',0,"Prophet_WrathOfNature")//A1W8 -> Wrath of Nature
	call SaveStr(MHT,'A1W9',0,"Prophet_WrathOfNature")//A1W9 -> Wrath of Nature upgrade
	call SaveStr(MHT,'A0QR',0,"Huskar_LifeBreakWrapper")//A0QR -> Life Break
	call SaveStr(MHT,'A1B3',0,"Huskar_LifeBreakWrapper")//A1B3 -> Life Break upgrade
	call SaveStr(MHT,'A0QP',0,"Huskar_InnerVitality")//A0QP -> Inner Vitality
	call SaveStr(MHT,'A0O5',0,"THD_Macropyre")//A0O5 -> Macropyre
	call SaveStr(MHT,'A30T',0,"THD_LiquidFire")//A30T -> Liquid Fire
	call SaveStr(MHT,'A1B1',0,"THD_Macropyre")//A1B1 -> Macropyre upgrade
	call SaveStr(MHT,'ANLS',0,"LinkenSphere_Share")
	call SaveStr(MHT,'A0O7',0,"DualBreathRecodedInit")//A0O7 -> Dual Breath
	call SaveStr(MHT,'A0M1',0,"Juggernaut_OmnislashWrapper")//A0M1 -> Omnislash
	call SaveStr(MHT,'A1AX',0,"Juggernaut_OmnislashWrapper")//A1AX -> Omnislash upgrade
	call SaveStr(MHT,'A05G',0,"Juggernaut_Bladefury")//A05G -> Blade Fury
	call SaveStr(MHT,'A2S8',0,"Omni_GuardianAngelUpg")//A2S8 -> Guardian Angel
	call SaveStr(MHT,'A10U',0,"Kotl_Recall")//A10U -> Recall
	call SaveStr(MHT,'A10X',0,"Kotl_ManaLeak")//A10X -> Mana Leak
	call SaveStr(MHT,'A112',0,"Kotl_ChakraMagic")//A112 -> Chakra Magic
	call SaveStr(MHT,'QM01',0,"Kotl_SpiritForm")//QM01 -> Spirit Form
	call SaveStr(MHT,'A11X',0,"Kotl_BlindingLight")//A11X -> Blinding Light
	call SaveStr(MHT,'QB0E',0,"LoDLightStrikeArray_Cast")//QB0E -> Light Strike Array
	call SaveStr(MHT,'A01F',0,"Lina_DragonSlave")
	call SaveStr(MHT,'A09Z',0,"Lina_LagunaBladeUpg")//A09Z -> Laguna Blade
	call SaveStr(MHT,'A01P',0,"Lina_LagunaBladeUpg")
	call SaveStr(MHT,'A054',0,"Luna_Eclipse")//A054 -> Eclipse
	call SaveStr(MHT,'A00U',0,"Luna_Eclipse")//A00U -> Eclipse
	call SaveStr(MHT,'A042',0,"LucentBeamWrapper")//A00U -> Eclipse
	call SaveStr(MHT,'A0KV',0,"Potm_Starfall")//A0KV -> Starfall
	call SaveStr(MHT,'A0KU',0,"Potm_MoonlightShadows")//A0KU -> Moonlight Shadow
	call SaveStr(MHT,'A0LN',0,"Potm_Leap")//A0LN -> Leap
	call SaveStr(MHT,'A0L8',0,"PotM_EluneArrow_Start")//A0L8 -> Elune's Arrow
	call SaveStr(MHT,'A33U',0,"StormOld_LightningGrapple")//A33U -> Lightning Grapple
	call SaveStr(MHT,'A0FN',0,"Morphling_Waveform")//A0FN -> Waveform
	call SaveStr(MHT,'QB02',0,"Morphling_Waveform")//QB02 -> Waveform
	call SaveStr(MHT,'A0G8',0,"Morphling_Replicate")//A0G8 -> Replicate
	call SaveStr(MHT,'A0GC',0,"Morphling_ReplicateReplace")//A0GC -> Morph Replicate
	call SaveStr(MHT,'A0G6',0,"Morphling_AdaptiveStrike")//A0G6 -> Adaptive Strike
	call SaveStr(MHT,'A07U',0,"Naga_SongOfSiren")//A07U -> Song of the Siren
	call SaveStr(MHT,'A38E',0,"Naga_SongOfSiren")//A38E -> Song of the Siren
	
	call SaveStr(MHT,'A2KU',0,"Naga_RipTide")//A2KU -> Rip Tide
	call SaveStr(MHT,'A24D',0,"Naga_Ensnare")//A24D -> Ensnare
	call SaveStr(MHT,'A08N',0,"Omni_Purification")//A08N -> Purification
	call SaveStr(MHT,'A10D',0,"PL_SpiritLance")//A10D -> Spirit Lance
	call SaveStr(MHT,'A46H',0,"PLDoppelganger")//A46H -> Doppelganger
	call SaveStr(MHT,'QB0B',0,"PL_Doppelwalk")//QB0B -> Doppelwalk
	call SaveStr(MHT,'A0D7',0,"PL_Doppelwalk")//A0D7 -> Doppelwalk
	call SaveStr(MHT,'A26N',0,"Treant_LeechSeed")//A26N -> Leech Seed
	call SaveStr(MHT,'A14L',0,"Silencer_CurseOfSilence")//A14L -> Curse of the Silent
	call SaveStr(MHT,'A0L3',0,"Silencer_GlobalSilence_Start")//A0L3 -> Global Silence
	call SaveStr(MHT,'A2QC',0,"Silencer_GlobalSilence_Start")//A2QC -> Global Silence
	call SaveStr(MHT,'A064',0,"Sniper_Shrapnel")//A064 -> Shrapnel
	call SaveStr(MHT,'A0RG',0,"Riki_SmokeScreen")//A0RG -> Smoke Screen
	call SaveStr(MHT,'A0K9',0,"Riki_BlinkStrikePre")//A0K9 -> Blink Strike
	call SaveStr(MHT,'A0WP',0,"myGodStrength")//A0WP -> God's Strength
	call SaveStr(MHT,'A43D',0,"myGodStrength")//A43D -> God's Strength Agh
	call SaveStr(MHT,'A190',0,"Sven_StormBoltWrapper")//A190 -> Storm Bolt
	call SaveStr(MHT,'A1EG',0,"LoneDruid_Rabid")//A1EG -> Rabid
	call SaveStr(MHT,'A0A5',0,"LoneDruid_SpiritBear")//A0A5 -> Summon Spirit Bear
	call SaveStr(MHT,'A0AG',0,"LoneDruid_TrueForm")//A0AG -> True Form
	call SaveStr(MHT,'A1A1',0,"Chieftain_SplitEarth")//A1A1 -> Earth Splitter
	call SaveStr(MHT,'A43J',0,"Chieftain_SplitEarth")//A43J -> Earth Splitter
	
	call SaveStr(MHT,'A0BQ',0,"Tinker_MarchOfMachines")//A0BQ -> March of the Machines
	call SaveStr(MHT,'A049',0,"Tinker_Laser")//A049 -> Laser
	call SaveStr(MHT,'A33G',0,"Tinker_Laser")//A33G -> Laser
	call SaveStr(MHT,'A33F',0,"Tinker_Rockets")//A33F -> Heat Seeking Missile
	call SaveStr(MHT,'A05E',0,"Tinker_Rockets")//A05E -> Heat Seeking Missile
	
	call SaveStr(MHT,'A0BZ',0,"Tiny_TossWrapper")//A0BZ -> Toss
	call SaveStr(MHT,'A0LL',0,"Tiny_Avalanche")//A0LL -> Avalanche
	call SaveStr(MHT,'A1EJ',0,"Troll_BattleTrance")//A1EJ -> Battle Trance
	call SaveStr(MHT,'A0BE',0,"TrollRageMorph")//A0BE -> Berserker Rage
	call SaveStr(MHT,'A21M',0,"Troll_AxesRanged")//A21M -> Whirling Axes
	call SaveStr(MHT,'A21N',0,"Troll_AxesMelee")//A21N -> Whirling Axes
	call SaveStr(MHT,'A1N4',0,"Ursa_Overpower")//A1N4 -> Overpower
	call SaveStr(MHT,'QB0P',0,"Ursa_Overpower")//QB0P -> Overpower
	call SaveStr(MHT,'A03Y',0,"Ursa_EarthShockWrapper")
	
	call SaveStr(MHT,'A0LC',0,"Ursa_Enrage")//A0LC -> Enrage
	call SaveStr(MHT,'A443',0,"Ursa_Enrage")//A443 -> Enrage
	call SaveStr(MHT,'A17O',0,"VS_WaveOfTerror")//A17O -> Wave of Terror
	call SaveStr(MHT,'A0IN',0,"VS_NetherSwap")//A0IN -> Nether Swap
	call SaveStr(MHT,'A1AW',0,"VS_NetherSwap")//A1AW -> Nether Swap upgrade
	call SaveStr(MHT,'A1EA',0,"TA_Refraction")//A1EA -> Refraction
	call SaveStr(MHT,'QB03',0,"TA_Refraction")//QB03 -> Refraction
	call SaveStr(MHT,'A0RV',0,"TA_Meld")//A0RV -> Meld
	call SaveStr(MHT,'A14I',0,"WR_Windrun")//A14I -> Windrunner
	call SaveStr(MHT,'A12J',0,"WR_ShacleshotWrapper")//A12J -> Shackleshot
	call SaveStr(MHT,'A12K',0,"WR_Powershot")//A12K -> Powershot
	call SaveStr(MHT,'A12P',0,"WR_FocusFire")//A12P -> Focus Fire
	call SaveStr(MHT,'A1D6',0,"WR_FocusFire")//A1D6 -> Focus Fire Upgraded
	call SaveStr(MHT,'A29G',0,"Zeus_WrathOfGod")//A29G -> Thundergod's Wrath
	call SaveStr(MHT,'A29H',0,"Zeus_WrathOfGod")//A29H -> Thundergod's Wrath
	call SaveStr(MHT,'A0JC',0,"Zeus_LightningBoltWrapper")//A0JC -> Lightning Bolt
	call SaveStr(MHT,'A020',0,"Zeus_ChainLightning")//A020 -> Arc Lightning
	call SaveStr(MHT,'A0I3',0,"Abaddon_DeathCoilWrapper")//A0I3 -> Death Coil
	call SaveStr(MHT,'A0MF',0,"Abaddon_AphoticShield")//A0MF -> Aphotic Shield
	call SaveStr(MHT,'A0S1',0,"Axe_BattleHunger")//A0S1 -> Battle Hunger
	call SaveStr(MHT,'A0I6',0,"Axe_BerserkerCall")//A0I6 -> Berserker's Call
	call SaveStr(MHT,'A0E2',0,"Axe_CullingBladeWrapper")//A0E2 -> Culling Blade
	call SaveStr(MHT,'A1MR',0,"Axe_CullingBladeWrapper")//A1MR -> Culling Blade
	call SaveStr(MHT,'A04Y',0,"Bane_NightmareWrapper")//A04Y -> Nightmare
	call SaveStr(MHT,'A02Q',0,"Bane_GripWrapper")//A02Q -> Fiend's Grip
	call SaveStr(MHT,'A1D9',0,"Bane_GripWrapper")//A1D9 -> Fiend's Grip Upgrade
	call SaveStr(MHT,'A1EL',0,"Batrider_StickyNapalm")//A1EL -> Sticky Napalm
	call SaveStr(MHT,'A19V',0,"Batrider_FlameBreak")//A19V -> Flamebreak
	call SaveStr(MHT,'QM04',0,"Batrider_Firefly")//QM04 -> Firefly
	call SaveStr(MHT,'A19O',0,"Batrider_FlamingLassoWrapper")//A19O -> Flaming Lasso
	call SaveStr(MHT,'A1MV',0,"Batrider_FlamingLassoWrapper")//A19O -> Flaming Lasso
	call SaveStr(MHT,'A0LH',0,"BS_Rupture")//A0LH -> Rupture
	call SaveStr(MHT,'A0EC',0,"BS_Bloodrage_Action")//A0EC -> Bloodrage
	call SaveStr(MHT,'Z234',0,"LoDSpinWeb_Cast")//Z234 -> Spin Web
	call SaveStr(MHT,'A0WQ',0,"Brood_Hunger")//A0WQ -> Insatiable Hunger
	call SaveStr(MHT,'A0BH',0,"Brood_SpawnSpiderlingsWrapper")//A0BH -> Spawn Spiderlings
	call SaveStr(MHT,'A0RW',0,"CK_RealityRiftPreWrapper")//A0RW -> Reality Rift
	call SaveStr(MHT,'A03O',0,"CK_Phantasm")//A03O -> Phantasm
	call SaveStr(MHT,'A04Q',0,"BoneFletcher_DeathPact")//A04Q -> Death Pact
	call SaveStr(MHT,'A0OJ',0,"OD_AstralImprisonmentWrapper")//A0OJ -> Astral Imprisonment
	call SaveStr(MHT,'A0OK',0,"OD_SanityEclipse")//A0OK -> Sanity's Eclipse
	call SaveStr(MHT,'A1VW',0,"OD_SanityEclipse")//A1VW -> Sanity's Eclipse
	call SaveStr(MHT,'A0QG',0,"DS_IonShell")//A0QG -> Ion Shell
	call SaveStr(MHT,'A0QE',0,"DS_Vacuum")//A0QE -> Vacuum
	call SaveStr(MHT,'A0R7',0,"DS_Surge")//A0R7 -> Surge
	call SaveStr(MHT,'A21Q',0,"DS_WallOfReplica")//A21Q -> Wall of Replica
	call SaveStr(MHT,'A0QK',0,"DS_WallOfReplica")//A0QK -> Wall of Replica
	call SaveStr(MHT,'A15S',0,"Undying_Decay")//A15S -> Decay
	call SaveStr(MHT,'A3JX',0,"Undying_Decay")//A15S -> Decay
	call SaveStr(MHT,'A0R5',0,"Undying_SoulRip")//A0R5 -> Soul Rip
	call SaveStr(MHT,'A15V',0,"Undying_TombStone")//A15V -> Tombstone
	call SaveStr(MHT,'QM03',0,"Undying_FleshGolem")//QM03 -> Flesh Golem
	call SaveStr(MHT,'A0LK',0,"Void_Timewalk")//A0LK -> Time Walk
	call SaveStr(MHT,'A0J1',0,"Void_Chronosphere")//A0J1 -> Chronosphere
	call SaveStr(MHT,'A1D7',0,"Void_Chronosphere")//A1D7 -> Chronosphere Upgraded
	call SaveStr(MHT,'A333',0,"Furion_ForceOfNature")//A333 -> Force of Nature
	call SaveStr(MHT,'Z610',0,"Lod_DeafeningBlast_EffectWrap")//Z610 -> Deafening Blast
	call SaveStr(MHT,'A3K5',0,"Lod_DeafeningBlast_EffectWrap")//Z610 -> Deafening Blast
	call SaveStr(MHT,'Z609',0,"Lod_EMP_Effect")//Z609 -> EMP
	call SaveStr(MHT,'Z608',0,"Lod_Tornado_Effect")//Z608 -> Tornado
	call SaveStr(MHT,'Z607',0,"Lod_Alacrity_Effect")//Z607 -> Alacrity
	call SaveStr(MHT,'Z606',0,"Lod_IceWall_Effect")//Z606 -> Ice Wall
	call SaveStr(MHT,'Z605',0,"Lod_GhostWalk_Effect")//Z605 -> Ghost Walk
	call SaveStr(MHT,'Z604',0,"Lod_ColdSnap_Effect")//Z604 -> Cold Snap
	call SaveStr(MHT,'Z603',0,"Lod_ForgeSpirit_Effect")//Z603 -> Forge Spirit
	call SaveStr(MHT,'Z602',0,"Lod_ChaosMeteor_Effect")//Z602 -> Chaos Meteor
	call SaveStr(MHT,'Z601',0,"Lod_SunStrike_Effect")//Z601 -> Sun Strike
	//call SaveStr(MHT,'QF89',0,"MARKSMANSHIP_EFFECT_sup")
	call SaveStr(MHT,'A33A',0,"Traxex_Gust_Start")//A33A -> Gust
	
	call SaveStr(MHT,'AHtb',0,"SkeletonKing_HellfireBlastWrapper")//AHtb -> Hellfire Blast
	call SaveStr(MHT,'QB0H',0,"SkeletonKing_HellfireBlastWrapper")//QB0H -> Hellfire Blast
	call SaveStr(MHT,'A2S0',0,"SkeletonKing_MortalStrike_RegSup")//A2S0 -> Mortal Strike
	call SaveStr(MHT,'A0N8',0,"Meepo_Poof")//A0N8 -> Poof
	call SaveStr(MHT,'A0NB',0,"Meepo_Earthbind")//A0NB -> Earthbind
	call SaveStr(MHT,'Z397',0,"Leshrak_SplitEarth")//Z397 -> Split Earth
	call SaveStr(MHT,'QB0F',0,"Leshrak_SplitEarth")//QB0F -> Split Earth
	call SaveStr(MHT,'A06V',0,"Leshrak_Lightnings")//A06V -> Lightning Storm
	
	call SaveStr(MHT,'A20T',0,"Leshrak_DiabolicEdict")//A20T -> Diabolic Edict
	call SaveStr(MHT,'A21G',0,"Leshrak_PulseNova")//A21G -> Pulse Nova
	call SaveStr(MHT,'A21F',0,"Leshrak_PulseNova")//A21F -> Pulse Nova
	call SaveStr(MHT,'A05T',0,"Lich_ChainFrostWrapper")//A05T -> Chain Frost
	call SaveStr(MHT,'A08H',0,"Lich_ChainFrostWrapper")//A08H -> Chain Frost
	call SaveStr(MHT,'A0X5',0,"Lion_Impale")//A0X5 -> Impale
	call SaveStr(MHT,'A053',0,"Lich_DarkRitual")//A053 -> Dark Ritual
	call SaveStr(MHT,'QM02',0,"Lycan_Shapeshift")//QM02 -> Shapeshift
	call SaveStr(MHT,'A03D',0,"Lycan_SpiritWolves")//A03D -> Summon Wolves
	call SaveStr(MHT,'A0ZF',0,"Lycan_Howl")//A0ZF -> Howl
	call SaveStr(MHT,'A094',0,"Doom_LvlDeath")//A094 -> LVL? Death
	call SaveStr(MHT,'A10R',0,"Doom_Devour")//A10R -> Devour
	call SaveStr(MHT,'A1OP',0,"Doom_ScorchedEarth")//A1OP -> Scorched Earth
	call SaveStr(MHT,'A0A2',0,"DoomAghActStart")//A0A2 -> Doom
	call SaveStr(MHT,'A0MU',0,"Doom_DoomCast")//A0MU -> Doom
	call SaveStr(MHT,'A29L',0,"Magnus_ReversePolarity")//A29L -> Reverse Polarity
	call SaveStr(MHT,'A447',0,"Magnus_ReversePolarity")//A447 -> Reverse Polarity
	call SaveStr(MHT,'A037',0,"Magnus_Empower")//A037 -> Empower
	call SaveStr(MHT,'A1RD',0,"Magnus_Skewer")//A1RD -> Skewer
	call SaveStr(MHT,'A02S',0,"Magnus_Shockwave")//A1RD -> Skewer
	call SaveStr(MHT,'A0G2',0,"Medusa_MysticSnakeStart")//A0G2 -> Mystic Snake
	call SaveStr(MHT,'A1C0',0,"Medusa_SplitShot")//A1C0 -> Splitshot
	call SaveStr(MHT,'A418',0,"Medusa_SplitShotOff")//A418 -> Splitshot
	call SaveStr(MHT,'A1AT',0,"Medusa_StoneGaze_Start")//A1AT -> Stone Gaze
	call SaveStr(MHT,'QB10',0,"Medusa_StoneGaze_Start")//QB10 -> Stone Gaze
	call SaveStr(MHT,'A194',0,"Lifestealer_OpenWounds")//A194 -> Open Wounds
	call SaveStr(MHT,'A0SW',0,"Lifestealer_Infest")//A0SW -> Infest
	call SaveStr(MHT,'A0T2',0,"Lifestealer_Rage")//A0T2 -> Rage
	call SaveStr(MHT,'A05V',0,"Necrolyte_DeathPulse")//A05V -> Death Pulse
	call SaveStr(MHT,'A067',0,"Necrolyte_ReapersScythe")//A067 -> Reaper's Scythe
	call SaveStr(MHT,'A08P',0,"Necrolyte_ReapersScythe")//A08P -> Reaper's Scythe
	call SaveStr(MHT,'A0X7',0,"NA_Impale")//A0X7 -> Impale
	call SaveStr(MHT,'A1H5',0,"NA_Manaburn")//A1H5 -> Mana Burn
	call SaveStr(MHT,'A2KO',0,"NA_SpikedCarapace")//A2KO -> Spiked Carapace
	call SaveStr(MHT,'A0FH',0,"Shadowraze_Cast")//A0FH -> Shadowraze
	call SaveStr(MHT,'A0F0',0,"Shadowraze_Cast")//A0F0 -> Shadowraze
	call SaveStr(MHT,'A0EY',0,"Shadowraze_Cast")//A0EY -> Shadowraze
	
	call SaveStr(MHT,'A344',0,"TrueForm_BattleRoar")//A344 -> Battle Cry
	call SaveStr(MHT,'A34C',0,"TrueForm_BattleRoar")//A34C -> Battle Cry
	
	call SaveStr(MHT,'A02H',0,"NightHunter_Void")//A02H -> Void
	call SaveStr(MHT,'A0YM',0,"PA_StiflingDagger")//A0YM -> Stifling Dagger
	call SaveStr(MHT,'A0PL',0,"PA_Blink_PreWrapper")//A0PL -> Phantom Strike
	call SaveStr(MHT,'A0RA',0,"PitLord_PitOfMalice")//A0RA -> Pit of Malice
	call SaveStr(MHT,'A06I',0,"Pudge_MeatHook")//A06I -> Meat Hook
	call SaveStr(MHT,'A1CX',0,"Pudge_Dismember")//A1CX -> Dismember Upgraded
	call SaveStr(MHT,'A0FL',0,"Pudge_DismemberBasicWrap")
	call SaveStr(MHT,'A2TD',0,"Oblivion_Decripify_Act")//A2TD -> Decrepify
	call SaveStr(MHT,'A1E7',0,"Razor_PlasmaField")//A1E7 -> Plasma Field
	call SaveStr(MHT,'A1AO',0,"Razor_EyeOfTheStorm")//A1AO -> Eye of the Storm
	call SaveStr(MHT,'A1UV',0,"Razor_EyeOfTheStorm")//A1UV -> Eye of the Storm
	call SaveStr(MHT,'A06O',0,"SK_Burrowstrike")//A06O -> Burrowstrike
	call SaveStr(MHT,'A0H0',0,"SK_Sandstorm")//A0H0 -> Sand Storm
	call SaveStr(MHT,'A05C',0,"SlardarSprintAct")//A29K -> Slithereen Crush
	call SaveStr(MHT,'A29K',0,"Slardar_SlithereenCrush")//A29K -> Slithereen Crush
	call SaveStr(MHT,'QB0I',0,"Slardar_SlithereenCrush")//QB0I -> Slithereen Crush
	call SaveStr(MHT,'A0HW',0,"Spectre_SpectralDaggerWrap")//A0HW -> Spectral Dagger
	call SaveStr(MHT,'A0H9',0,"Spectre_Haunt")//A0H9 -> Haunt
	call SaveStr(MHT,'A0HA',0,"Spectre_Reality")//A0HA -> Reality
	call SaveStr(MHT,'A0G4',0,"Spiritbreaker_NetherStrike")//A0G4 -> Nether Strike
	call SaveStr(MHT,'A1D8',0,"Spiritbreaker_NetherStrike")//A1D8 -> Nether Strike Upgrade
	call SaveStr(MHT,'A07Q',0,"TB_SunderWrapper")//A07Q -> Sunder
	call SaveStr(MHT,'A0H4',0,"TB_ConjureImage")//A0H4 -> Conjure Image
	call SaveStr(MHT,'A046',0,"Tidehunter_Gush")//A046 -> Gush
	call SaveStr(MHT,'A29I',0,"Tidehunter_Ravage")//A29I -> Ravage
	call SaveStr(MHT,'A226',0,"Tidehunter_AnchorSmash")//A226 -> Anchor Smash
	call SaveStr(MHT,'A0OR',0,"Dazzle_ShadowWave")//A0OR -> Shadow Wave
	call SaveStr(MHT,'A0NQ',0,"Dazzle_PoisonTouch")//A0NQ -> Poison Touch
	call SaveStr(MHT,'A10Q',0,"Dazzle_Weave")//A10Q -> Weave
	call SaveStr(MHT,'A1DB',0,"Dazzle_Weave")//A1DB -> Weave Upgrade
	call SaveStr(MHT,'A10L',0,"Dazzle_Grave")//A10L -> Shallow Grave
	call SaveStr(MHT,'A173',0,"Venomancer_VenomousGale")//A173 -> Venomous Gale
	call SaveStr(MHT,'A013',0,"Venomancer_PoisonNova")//A013 -> Poison Nova
	call SaveStr(MHT,'A0A6',0,"Venomancer_PoisonNova")//A0A6 -> Poison Nova Upg
	call SaveStr(MHT,'A1UZ',0,"ViperStrikeUpgWrapper")//A1UZ -> Viper Strike
	call SaveStr(MHT,'A080',0,"ViperStrikeBaseWrapper")//A080 -> Viper Strike
	call SaveStr(MHT,'A08X',0,"Visage_GraveChillWrapper")//A08X -> Grave Chill
	call SaveStr(MHT,'A1NE',0,"Visage_Familiars")//A1NE -> Familiars
	call SaveStr(MHT,'A2IG',0,"Visage_Familiars")//A2IG -> Familiars
	call SaveStr(MHT,'A1NA',0,"Visage_SoulAssumptionWrapper")//A1NA -> Soul Assumption
	call SaveStr(MHT,'A06P',0,"WL_Upheaval")//A06P -> Upheaval
	call SaveStr(MHT,'A0J5',0,"WL_FatalBounds")//A0J5 -> Fatal Bonds
	call SaveStr(MHT,'A0AS',0,"WL_ShadowWord")//A0AS -> Shadow Word
	call SaveStr(MHT,'S00U',0,"WL_Infernal")//S00U -> Rain of Chaos
	call SaveStr(MHT,'A0CT',0,"Weaver_TimeLapse")//A0CT -> Time Lapse
	call SaveStr(MHT,'A3DM',0,"Weaver_TimeLapse")//A3DM -> Time Lapse
	call SaveStr(MHT,'A1QW',0,"Weaver_TheSwarm")//A1QW -> The Swarm
	call SaveStr(MHT,'A0NM',0,"WD_ParalyzingCask")//A0NM -> Paralyzing Cask
	call SaveStr(MHT,'A0NE',0,"WD_VoodooRestoration")//A0NE -> Voodoo Restoration
	call SaveStr(MHT,'A0NO',0,"WD_Maledict")//A0NO -> Maledict
	call SaveStr(MHT,'A0NT',0,"WD_DeathWard")//A0NT -> Death Ward
	call SaveStr(MHT,'A0NX',0,"WD_DeathWard")//A0NX -> Death Ward
	call SaveStr(MHT,'A1HS',0,"AA_IceVortex")//A1HS -> Ice Vortex
	call SaveStr(MHT,'A1MG',0,"AA_ColdFeet")//A1MG -> Cold Feet
	call SaveStr(MHT,'A1MI',0,"AA_IceBlast")//A1MI -> Ice Blast
	call SaveStr(MHT,'A2QE',0,"AA_IceBlast")//A2QE -> Ice Blast
	call SaveStr(MHT,'A1HQ',0,"AA_ChillingTouch")//A1HQ -> Chilling Touch
	call SaveStr(MHT,'A1IM',0,"Slark_DarkPact")//A1IM -> Dark Pact
 	call SaveStr(MHT,'A1IN',0,"Slark_ShadowDance")//A1IN -> Shadow Dance
	call SaveStr(MHT,'A1J7',0,"Slark_Pounce")//A1J7 -> Pounce
	call SaveStr(MHT,'A04A',0,"QoP_ScreamOfPain")//A04A -> Scream of Pain
	call SaveStr(MHT,'A28R',0,"MyQoPSWBasic")//A28R -> Sonic Wave
	call SaveStr(MHT,'A28S',0,"MyQoPSW")//A28S -> Sonic Wave
	call SaveStr(MHT,'A45W',0,"Queen_VitalStrike")//A45W -> Vital Strike
	call SaveStr(MHT,'A45X',0,"Queen_ArrowShower")//A45X -> Arrow Shower
	call SaveStr(MHT,'A3FA',0,"CompleteItemReceipeClick")
	
	
	call SaveStr(MHT,'A00P',0,"ShadowShaman_Shackles")//A00P -> Shackles
	call SaveStr(MHT,'A010',0,"EtherShockWrapper")//A010 -> Ether shock
	call SaveStr(MHT,'A1RJ',0,"Phoenix_Dive")//A1RJ -> Icarus Dive
	call SaveStr(MHT,'A461',0,"Queen_Snatch")//A461 -> Swoop Down
	call SaveStr(MHT,'A1RK',0,"Phoenix_Supernova")//A1RK -> Supernova
	call SaveStr(MHT,'A43H',0,"Phoenix_Supernova")//A43H -> Supernova
	
	call SaveStr(MHT,'A1YX',0,"Phoenix_FireSpirits")//A1YX -> Fire Spirits
	call SaveStr(MHT,'A1S4',0,"SD_ShadowPoison")//A1S4 -> Shadow Poison
	call SaveStr(MHT,'A1S8',0,"SD_Disruption")//A1S8 -> Disruption
	call SaveStr(MHT,'A1SB',0,"SD_SoulCatcher")//A1SB -> Soul Catcher
	call SaveStr(MHT,'A343',0,"SD_DemonicPurge")//A343 -> Demonic Purge
	call SaveStr(MHT,'A34J',0,"SD_DemonicPurgeAgh")//A34J -> Demonic Purge
	call SaveStr(MHT,'A1SO',0,"Gyro_RocketBarrage")//A1SO -> Rocket Barrage
	call SaveStr(MHT,'A1SQ',0,"Gyro_HomingMissile")//A1SQ -> Homing Missile
	call SaveStr(MHT,'A1T5',0,"Gyro_Calldown")//A1T5 -> Call Down
	call SaveStr(MHT,'A235',0,"Gyro_Calldown")//A235 -> Call Down
	call SaveStr(MHT,'A229',0,"Gyro_FlakCannon")//A229 -> Flak Cannon
	call SaveStr(MHT,'A1SU',0,"Disruptor_KineticField")//A1SU -> Kinetic Field
	call SaveStr(MHT,'A1SW',0,"Disruptor_Glimpse")//A1SW -> Glimpse
	call SaveStr(MHT,'A1TV',0,"Disruptor_ThunderStrike_Wrapper")//A1TV -> Thunder Strike
	call SaveStr(MHT,'A1U6',0,"Disruptor_StaticField")//A1U6 -> Static Storm
	call SaveStr(MHT,'A30N',0,"Disruptor_StaticField")//A30N -> Static Storm
	call SaveStr(MHT,'A2KQ',0,"UnrefinedFireblast")//A2KQ -> Fireblast
	call SaveStr(MHT,'A1PH',0,"TB_SoulSteal")//A1PH -> Soul Steal
	
	call SaveStr(MHT,'A1T8',0,"Wisp_Spirits")//A1T8 -> Spirits
	call SaveStr(MHT,'A1TA',0,"Wisp_Tether")//A1TA -> Tether
	call SaveStr(MHT,'A1TB',0,"Wisp_Relocate")//A1TB -> Relocate
	call SaveStr(MHT,'A3FQ',0,"Wisp_Relocate")//A1TB -> Relocate
	call SaveStr(MHT,'A1YO',0,"Tuskar_IceShards")//A1YO -> Ice Shards
	call SaveStr(MHT,'A1YQ',0,"Tuskar_WalrusPunch")//A1YQ -> Walrus Punch
	call SaveStr(MHT,'A3DF',0,"WalrusKickEffect")//A3DF -> Walrus Kick
	call SaveStr(MHT,'A3DE',0,"Tuskar_WalrusPunch")//A3DE -> Walrus Punch
	call SaveStr(MHT,'A1S7',0,"Tuskar_SnowballWrapper")//A1S7 -> Snowball
	call SaveStr(MHT,'A27F',0,"Rubick_Telekinesis")//A27F -> Telekinesis
	call SaveStr(MHT,'A27G',0,"Rubick_Fadebolt")//A27G -> Fade Bolt
	call SaveStr(MHT,'A27H',0,"Rubick_SpellSteal")//A27H -> Spell Steal
	call SaveStr(MHT,'A30J',0,"Rubick_SpellSteal")//A30J -> Spell Steal
	call SaveStr(MHT,'QB06',0,"Banshee_CarrionSwarm")//A073 -> Exorcism
	call SaveStr(MHT,'A078',0,"Banshee_CarrionSwarm")//A073 -> Exorcism
	call SaveStr(MHT,'A04N',0,"Banshee_Exorcism")//A04N -> Exorcism
	call SaveStr(MHT,'A2HS',0,"Xin_FlameGuard")//A2HS -> Flame Guard
	call SaveStr(MHT,'A2H0',0,"Xin_SleightOfFistWrap")//A2H0 -> Sleight of Fist
	call SaveStr(MHT,'QB0L',0,"Xin_SleightOfFistWrap")//QB0L -> Sleight of Fist
	call SaveStr(MHT,'A2H3',0,"Xin_SearingChains")//A2H3 -> Searing Chains
	call SaveStr(MHT,'A2JO',0,"Xin_FireRemnants")//A2JO -> Fire Remnant
	call SaveStr(MHT,'A2JQ',0,"Xin_FireRemnants")//A2JQ -> Fire Remnant
	call SaveStr(MHT,'A2JP',0,"Xin_FireRemnants")//A2JP -> Fire Remnant
	call SaveStr(MHT,'A2JR',0,"Xin_FireRemnants")//A2JR -> Fire Remnant
	call SaveStr(MHT,'A2JL',0,"Xin_FireRemnantsB")//A2JL -> Fire Remnant
	call SaveStr(MHT,'A2CI',0,"LegionCommander_DuelWrap")//A2CI -> Duel
	call SaveStr(MHT,'A38C',0,"LegionCommander_DuelWrap")//A38C -> Duel
	call SaveStr(MHT,'A2J2',0,"LegionCommander_PressTheAttack")//A2J2 -> Press The Attack
	call SaveStr(MHT,'A2JB',0,"LegionCommander_OverhelmingOdds")//A2JB -> Overwhelming Odds
	call SaveStr(MHT,'A2BG',0,"Skywrath_MysticFlare")//A2BG -> Mystic Flare
	call SaveStr(MHT,'A30H',0,"Skywrath_MysticFlare")//A30H -> Mystic Flare
	call SaveStr(MHT,'A2BE',0,"Skywrath_ArcaneBolt")//A2BE -> Arcane Bolt
	call SaveStr(MHT,'A2HN',0,"Skywrath_AncientSeal")//A2HN -> Ancient Seal
	call SaveStr(MHT,'A2IT',0,"Skywrath_ConcussiveShot")//A2IT -> Concussive Shot
	call SaveStr(MHT,'A2FK',0,"Shredder_WhirlingDeath")//A2FK -> Whirling Death
	call SaveStr(MHT,'A2E3',0,"Shredder_Timberchain")//A2E3 -> Timber Chain
	call SaveStr(MHT,'A2E5',0,"Shredder_Chakram")//A2E5 -> Chakram
	call SaveStr(MHT,'A43Q',0,"Shredder_Chakram")//A43Q -> Chakram Second
	call SaveStr(MHT,'A43S',0,"Shredder_Chakram")//A43S -> Chakram
	
	
	call SaveStr(MHT,'A11N',0,"Admiral_XMark_Effectsup")//A11N -> X Marks The Spot
	call SaveStr(MHT,'A300',0,"Beastmaster_CallHawk")//A300 -> Summon Hawk
	call SaveStr(MHT,'A301',0,"Beastmaster_CallBeast")//A301 -> Summon Quilbeast
	call SaveStr(MHT,'A07F',0,"Lich_FrostNova_Start")//A07F -> Frost Nova
	call SaveStr(MHT,'A0CC',0,"Oblivion_LifeDrain_Start")//A0CC -> Life Drain
	call SaveStr(MHT,'A02Z',0,"Oblivion_LifeDrain_Start")//A02Z -> Life Drain
	call SaveStr(MHT,'A32A',0,"Kodo_Spit")//A32A -> Spit
	call SaveStr(MHT,'A32C',0,"Kodo_Trample")//A32C -> Trample
	call SaveStr(MHT,'A32E',0,"Kodo_Digest")//A32E -> Digest
	call SaveStr(MHT,'A32D',0,"Kodo_DigestSpitEffectSup")//A32D -> Digest Spit
	call SaveStr(MHT,'A32G',0,"Kodo_DrumWars")//A32G -> Drums of War
	call SaveStr(MHT,'A004',0,"Bounty_ShurikenToss")//A004 -> Shuriken Toss
	call SaveStr(MHT,'A0GK',0,"Bane_BrainSapWrapper")//A0GK -> Brain Sap
	call SaveStr(MHT,'A0R0',0,"PitLord_DarkRift")//A0R0 -> Dark Rift
	call SaveStr(MHT,'A04C',0,"CM_FrostBiteWrapper")//A04C -> Frostbite
	call SaveStr(MHT,'A44U',0,"OgreLord_AnteUpWrap")//A44U -> Ante Up
	call SaveStr(MHT,'A44X',0,"BloodrageNewStart")//A44X -> Bloodrage New
	call SaveStr(MHT,'A44Z',0,"BloodRite")//A44Z -> Blood Rite
	
	call SaveStr(MHT,'A451',0,"FirewallAct")//A451 -> Firewall
	call SaveStr(MHT,'A456',0,"InfernoAct")//A456 -> Inferno
	call SaveStr(MHT,'A454',0,"FireStompActEffect")//A454 -> Fire Stomp
	
	call SaveStr(MHT,'A06B',0,"TechiesSuicideWrapper")//A06B -> Suicide Squad, Attack!
	call SaveStr(MHT,'A471',0,"TechiesSuicideWrapper")//A06B -> Suicide Squad, Attack!
	
	call SaveStr(MHT,'A2LB',0,"Wyvern_Embrace_Start")//A2LB -> Cold Embrace
	call SaveStr(MHT,'A0Z0',0,"Wyvern_Curse_Real_Start")//A0Z0 -> Winter's Curse
	call SaveStr(MHT,'A01Z',0,"Tree_Invis_Start")//A01Z -> Nature's Guise
	call SaveStr(MHT,'A0CA',0,"Weaver_Shukuchi_Start")//A0CA -> Shukuchi
	call SaveStr(MHT,'A2N1',0,"Shadow_Amulet_Condition")//A2N1 -> Shadow Amulet
	call SaveStr(MHT,'A055',0,"Chaos_Bolt_Wrap")//A055 -> Chaos Bolt
	call SaveStr(MHT,'A085',0,"Keeper_Illuminate_Start")//A085 -> Illuminate
	call SaveStr(MHT,'A121',0,"Keeper_Illuminate_End")//A121 -> Illuminate End
	call SaveStr(MHT,'A07Z',0,"Tree_Overgrowth_Start")//A07Z -> Overgrowth
	call SaveStr(MHT,'A44S',0,"Tree_Overgrowth_Start")//A44S -> Overgrowth Upgrade
	call SaveStr(MHT,'A01V',0,"EyeInTheForest")//A01V -> Eyes in the Forest
	call SaveStr(MHT,'A1HH',0,"UrnaSwarmInfestB")//A1HH -> Infestation
	
	
	
	
	call SaveStr(MHT,'QB00',0,"Chaos_Bolt_Wrap")//QB00 -> Chaos Bolt
	call SaveStr(MHT,'QB01',0,"Weaver_Shukuchi_Start")//QB01 -> Shukuchi
	call SaveStr(MHT,'QB04',0,"Silencer_LastWord")//QB04 -> Last Word
	
	call SaveStr(MHT,'A2O2',0,"Drow_Trueshot_Toggling")//A2O2 -> Trueshot Aura
	//call SaveStr(MHT,'A528',0,"Tinker_Rearm_DummySpell")//A528 -> |cffffcc00R|rearm - [|cffffcc00Level 1|r]","|cffffcc00R|rearm - [|cffffcc00Level 2|r]","|cffffcc00R|rearm - [|cffffcc00Level 3|r]
	call SaveStr(MHT,'A34A',0,"CheatDeath_Use")//A34A -> Cheat Death
	call SaveStr(MHT,'A40K',0,"Formless_SpellCast")//A40K -> Unus
	call SaveStr(MHT,'A40L',0,"Formless_SpellCast")//A40L -> Duos
	call SaveStr(MHT,'A40M',0,"Formless_SpellCast")//A40M -> Tertius
	call SaveStr(MHT,'A40N',0,"Formless_SpellCast")//A40N -> Denique
	call SaveStr(MHT,'A2TI',0,"Kaolin_Magnetize_Init")//A2TI -> Magnetize
	call SaveStr(MHT,'A29J',0,"RequiemWrapper")//A29J -> Requiem of Souls
	call SaveStr(MHT,'A02A',0,"VS_MagicMissile_Wrap")//A02A -> Magic Missile
	call SaveStr(MHT,'A06M',0,"Brewmaster_Stomp")
	
	call SaveStr(MHT,'A08V',0,"Omni_Repel")//A08V -> Repel
	call SaveStr(MHT,'A1AU',0,"Sniper_Agh")//A1AU -> Assassinate upgrade
	
	call SaveStr(MHT,'QB0J',0,"Ogre_Fireblast_Wrap")//QB0J -> Fireblast
	call SaveStr(MHT,'A04W',0,"Ogre_Fireblast_Wrap")//A04W -> Fireblast
	call SaveStr(MHT,'A011',0,"IgniteWrapper")
	call SaveStr(MHT,'A44V',0,"OgreLord_CashIn")//A44V -> Cash In
	call SaveStr(MHT,'A46J',0,"OgreLord_MindControl")//A46J -> Mind Control
	
	 
	call SaveStr(MHT,'A42I',0,"CrimsonGuard_Act")
	call SaveStr(MHT,'A42W',0,"Butterfly_Flutter")//A42W -> Inventory for couriers (cant be used)
	call SaveStr(MHT,'A38R',0,"MangoUsed")
	call SaveStr(MHT,'A38V',0,"GlimmerCapeUsed")
	call SaveStr(MHT,'A3BP',0,"LotusOrbAct")
	call SaveStr(MHT,'A39K',0,"SolarCrestStart")
	call SaveStr(MHT,'A395',0,"GuardianGreavesStart")
	call SaveStr(MHT,'A39C',0,"SilverEdge_SpellEffect")
	
	
	call SaveStr(MHT,'A2K4',0,"Halberd_Start")//A2K4 -> Prudence
	//ITEMS store: they are called via different trigger but still its more useful to keep here
	call SaveStr(MHT,'A02X',12,"NewWards")//A02X -> Observer Ward
	call SaveStr(MHT,'AIsw',12,"NewWards")//AIsw -> Sentry Ward
	call SaveStr(MHT,'A0H6',12,"EOD")//A0H6 -> Bottle Empty
	call SaveStr(MHT,'A0B6',12,"EBD")//A0B6 -> Item Summon Courier
	call SaveStr(MHT,'A0JT',12,"E3D")//A0JT -> Item Summon Flying Courier
	call SaveStr(MHT,'A0OT',12,"FSD")//A0OT -> Change Courier Type
	call SaveStr(MHT,'Aeat',12,"TangoUsed")//Aeat -> Eat Tree
	call SaveStr(MHT,'ANTG',12,"TangoUsed")
	call SaveStr(MHT,'A231',12,"BootsOfTravelUsed")//A231 -> Boots of Travel (fixed)
	call SaveStr(MHT,'A3AG',12,"BootsOfTravelUsed")
	call SaveStr(MHT,'A1R5',12,"BootsOfTravelUsed")//A1R5 -> Scroll of Teleporation (fixed)
	call SaveStr(MHT,'A0HB',12,"NecronomiconSummoning")//A0HB -> Item Skeleton Summon lvl 1
	call SaveStr(MHT,'A0D3',12,"NecronomiconSummoning")//A0D3 -> Item Skeleton Summon lvl 2
	call SaveStr(MHT,'A0DF',12,"NecronomiconSummoning")//A0DF -> Item Skeleton Summon lvl 3
	call SaveStr(MHT,'ACch',12,"GWDb")//ACch -> Helm of the Dominator
	call SaveStr(MHT,'A11F',12,"GBD")//A11F -> Avatar
	call SaveStr(MHT,'A11E',12,"GBD")//A11E -> Avatar
	call SaveStr(MHT,'A0S3',12,"GBD")//A0S3 -> Avatar
	call SaveStr(MHT,'A11D',12,"GBD")//A11D -> Avatar
	call SaveStr(MHT,'A11G',12,"GBD")//A11G -> Avatar
	call SaveStr(MHT,'A11H',12,"GBD")//A11H -> Avatar
	call SaveStr(MHT,'A0CK',12,"G3D")//A0CK -> Mekansm Armor + Heal
	call SaveStr(MHT,'A1FP',12,"GVD")//A1FP -> Satanic this
	call SaveStr(MHT,'A02W',12,"G5D")//A02W -> Item Cooldown Reset
	call SaveStr(MHT,'A0FD',12,"H8D")//A0FD -> Orchid Malevolence
	call SaveStr(MHT,'A0JL',12,"Func0821")//A0JL -> Static Charge
	call SaveStr(MHT,'A0T9',12,"HPD")//A0T9 -> ICEARMORNEW (NEW)
	call SaveStr(MHT,'A0VR',12,"HID")//A0VR -> Mana Upgrade
	call SaveStr(MHT,'A0JY',12,"HUD")//A0JY -> Magic Stick
	call SaveStr(MHT,'A138',12,"LZ9")//A138 -> Drop Items
	call SaveStr(MHT,'A14C',12,"LZ9")//A14C -> Drop Items
	call SaveStr(MHT,'A14D',12,"LX9")//A14D -> Pickup Items
	call SaveStr(MHT,'A141',12,"H5D")//A141 -> Glyph of Fortification Sentinel
	call SaveStr(MHT,'A1WI',12,"H5D")//A1WI -> Glyph of Fortification Scourge
	call SaveStr(MHT,'A12W',12,"I4D")//A12W -> Phase Boots - Phase
	call SaveStr(MHT,'A15W',12,"BladeMailSpell")//A15W -> Blademail
	call SaveStr(MHT,'A19M',12,"ForceStaffAct")//A19M -> Force Staff
	call SaveStr(MHT,'AIpg',12,"DiffusalBladePurgeTriggered")//A19M -> Force Staff
	call SaveStr(MHT,'A1AC',12,"IRD")//A1AC -> Ghost Potion
	call SaveStr(MHT,'A1AS',12,"I3D")//A1AS -> Return Home
	call SaveStr(MHT,'A2KS',12,"BSO")//A2KS -> Find Secret Shop
	call SaveStr(MHT,'A0GD',12,"FAD")//A0GD -> Flying Courier Morph
	call SaveStr(MHT,'A1EW',12,"G1D")//A1EW -> Khadgar's Pipe of Insight
	call SaveStr(MHT,'A0B8',12,"I1D")//A0B8 -> Manta Image
	call SaveStr(MHT,'A1WE',12,"I1D")//A1WE -> Manta Image (ranged)
	call SaveStr(MHT,'A1MO',12,"J4D")//A1MO -> Urn of shadows
	call SaveStr(MHT,'A1Q8',12,"IAD")//A1Q8 -> Soul Ring
	call SaveStr(MHT,'A1QD',12,"IOD")//A1QD -> Ether Blast
	call SaveStr(MHT,'A1T7',12,"KID")//A1T7 -> Eul Cyclone
	call SaveStr(MHT,'A0K7',12,"KHD")//A0K7 -> Arcane Ring
	call SaveStr(MHT,'A28Y',12,"KDD")//A28Y -> Hand of Midas
	call SaveStr(MHT,'A1ZI',12,"J5D")//A1ZI -> Medallion of Courage
	call SaveStr(MHT,'A1ZW',12,"JDD")//A1ZW -> Ancient Jangoo
	call SaveStr(MHT,'A206',12,"JMD")//A206 -> Smoke of Deceit
	call SaveStr(MHT,'A28D',12,"JPD")//A28D -> Veil of Discord
	call SaveStr(MHT,'A2EA',12,"JUD")//A2EA -> Rod of atos
	call SaveStr(MHT,'A2HQ',12,"J3D")//A2HQ -> Blade of the Reaper
	call SaveStr(MHT,'A02O',12,"JBD")//A02O -> Finger of Death
	call SaveStr(MHT,'A08Y',12,"JBD")//A08Y -> Finger of Death
	call SaveStr(MHT,'A08Z',12,"JBD")//A08Z -> Finger of Death
	call SaveStr(MHT,'A090',12,"JBD")//A090 -> Finger of Death
	call SaveStr(MHT,'A092',12,"JBD")//A092 -> Finger of Death
	call SaveStr(MHT,'A3K7',12,"AlchemistScepterUse")//Alch Aghanim
	call SaveStr(MHT,'A2TK',12,"Item_Bloodstone_Init")
	call SaveStr(MHT,'AItb',12,"Item_Dust_Init")//AItb -> Dust of Appearance
	call SaveStr(MHT,'A1FD',12,"Item_QuellingBlade_Reg")
	call SaveStr(MHT,'A0JZ',12,"Courier_Burst")//A0JZ -> Courier Burst
	call SaveStr(MHT,'Adsm',0,"PandarenSpiritDispell")
	call SaveStr(MHT,'Acdh',0,"DrunkenHaze_SpellEffect")
	
	
	//EVENT_UNIT_SPELL_ENDCAST
	call SaveStr(MHT,'A1P8',1,"Spiritbreaker_Charge_Stop")//A1P8 -> Charge of Darkness
	call SaveStr(MHT,'A085',1,"Keeper_Illuminate_Check")//A085 -> Illuminate
	call SaveStr(MHT,'A2QT',1,"Oracle_FortunesEnd_PreEnd")//A2QT -> Fortune's End
	
	

	//EVENT_UNIT_SPELL_FINISH
	call SaveStr(MHT,'A1AA',2,"Tauren_Stomp_Effect")//A1AA -> Echo Stomp
	call SaveStr(MHT,'A2LK',2,"Tauren_Stomp_Effect")//A2LK -> Echo Stomp
	call SaveStr(MHT,'A065',2,"Rearm_Effect")//A065 -> Rearm
	call SaveStr(MHT,'A0BE',2,"TrollRageMorph")//A0BE -> Berserker Rage
	//call SaveStr(MHT,'A44V',2,"OgreLord_CashInWrap")//A44V -> Cash In

	//EVENT_UNIT_SPELL_CAST
	call SaveStr(MHT,'A064',3,"Sniper_Shrapnel_OnCast")//A064 -> Shrapnel
	call SaveStr(MHT,'A0AM',3,"RemoteMineActivation")//A0AM -> Detonate
	call SaveStr(MHT,'A0A3',3,"RemoteMineActivation")//A0A3 -> Detonate
	call SaveStr(MHT,'A0A4',3,"RemoteMineActivation")//A0A4 -> Detonate
	call SaveStr(MHT,'A1FZ',3,"RemoteMineActivation")//A1FZ -> Detonate
	call SaveStr(MHT,'A1WF',3,"RemoteMineFocused")//A1WF -> Focused Detonate
	call SaveStr(MHT,'A451',3,"FirewallOnCast")//A451 -> Firewall
	call SaveStr(MHT,'A0AS',3,"WL_ShadowWordOnCast")//A0AS -> Shadow Word
	//call SaveStr(MHT,'A0BQ',3,"Tinker_MarchOfMachines_OnCast")//A0BQ -> March of the Machines
	call SaveStr(MHT,'A0SW',3,"Lifestealer_Infest_OnCast")//A0SW -> Infest
	call SaveStr(MHT,'A0EC',3,"BS_Bloodrage_StopCastInit")//A0EC -> Bloodrage
	call SaveStr(MHT,'A2QM',3,"Kaolin_BoulderSmash_OnCast_Wrap")//A2QM -> Boulder Smash
	call SaveStr(MHT,'A04Y',3,"Bane_Nightmare_OnCast")//A04Y -> Nightmare
	call SaveStr(MHT,'A34A',3,"CheatDeath_Cast")//A34A -> Cheat Death
	call SaveStr(MHT,'A34J',3,"SD_DemonicPurgeAghCast")//A34J -> Demonic Purge
	call SaveStr(MHT,'A1AA',3,"Tauren_Stomp_Check")//A1AA -> Echo Stomp
	call SaveStr(MHT,'A3DM',3,"Weaver_TimeLapse_Check")//A3DM -> Time Lapse
	call SaveStr(MHT,'A2LK',3,"Tauren_Stomp_Check")//A2LK -> Echo Stomp
	call SaveStr(MHT,'A11N',3,"Admiral_XMark_OnCastsup")//A11N -> X Marks The Spot
	call SaveStr(MHT,'AEbl',3,"AM_Blink_OnCast")//AEbl -> Blink
	call SaveStr(MHT,'QB08',3,"AM_Blink_OnCast")//QB08 -> Blink
	call SaveStr(MHT,'A3DF',3,"WalrusKickCheck")//A3DF -> Walrus Kick
	call SaveStr(MHT,'A00L',3,"Double_Edge_Condtionsup")//A00L -> Double Edge
	call SaveStr(MHT,'A361',3,"Chen_HolyPersuation_OnCast")//A361 -> Holy Persuasion
	call SaveStr(MHT,'A14O',3,"Storm_BallLightning_OnCast")//A14O -> Ball Lightning
	call SaveStr(MHT,'A3FJ',3,"Storm_BallLightning_OnCast")//A14O -> Ball Lightning
	call SaveStr(MHT,'A2QI',3,"Kaolin_GeomagneticGrip_Cast")//A2QI -> Geomagnetic Grip
	call SaveStr(MHT,'A2QT',3,"Oracle_FortunesEnd_OnCastSup")//A2QT -> Fortune's End
	call SaveStr(MHT,'A180',3,"Enigma_DemonicConversion_OnCast")//A180 -> Demonic Conversion
	call SaveStr(MHT,'A1BX',3,"Enigma_BlackHole_OnCast")//A1BX -> Black Hole
	call SaveStr(MHT,'A30L',3,"Enigma_BlackHole_OnCast")//A30L -> Black Hole
	call SaveStr(MHT,'A21E',3,"Prophet_NaturesWrath_OnCast")//A21E -> Sprout
	call SaveStr(MHT,'A0M1',3,"Juggernaut_Omnislash_OnCast")//A0M1 -> Omnislash
	call SaveStr(MHT,'A1AX',3,"Juggernaut_Omnislash_OnCast")//A1AX -> Omnislash upgrade
	call SaveStr(MHT,'A10U',3,"Kotl_Recall_OnCast")//A10U -> Recall
	//call SaveStr(MHT,'A11Y',3,"Kotl_Recall_OnCast")
	//call SaveStr(MHT,'A11Z',3,"Kotl_Recall_OnCast")
	call SaveStr(MHT,'A01P',3,"Lina_LagunaBlade_OnCast")//A01P -> Laguna Blade
	//call SaveStr(MHT,'A09Z',3,"Lina_LagunaBlade_OnCast")//A09Z -> Laguna Blade
	call SaveStr(MHT,'A24D',3,"Naga_Ensnare_OnCast")//A24D -> Ensnare
	call SaveStr(MHT,'A10D',3,"PL_SpiritLance_OnCast")//A10D -> Spirit Lance
	call SaveStr(MHT,'A0K9',3,"Rikimaru_BlinkStrike_OnCast")//A0K9 -> Blink Strike
	call SaveStr(MHT,'A190',3,"Sven_StormBolt_OnCast")//A190 -> Storm Bolt
	call SaveStr(MHT,'A0BZ',3,"Tiny_Toss_OnCast")//A0BZ -> Toss
	call SaveStr(MHT,'A0IN',3,"VS_NetherSwap_OnCast")//A0IN -> Nether Swap
	call SaveStr(MHT,'A1AW',3,"VS_NetherSwap_OnCast")//A1AW -> Nether Swap upgrade
	call SaveStr(MHT,'A02A',3,"VS_MagicMissile_OnCast")//A02A -> Magic Missile
	call SaveStr(MHT,'A0RW',3,"CK_RealityRift_OnCast")//A0RW -> Reality Rift
	call SaveStr(MHT,'A0OJ',3,"OD_AstralImprisonment_OnCast")//A0OJ -> Astral Imprisonment
	call SaveStr(MHT,'A0QE',3,"DS_Vacuum_OnCast")//A0QE -> Vacuum
	call SaveStr(MHT,'AHtb',3,"SkeletonKing_HellfireBlast_OnCast")//AHtb -> Hellfire Blast
	call SaveStr(MHT,'QB0H',3,"SkeletonKing_HellfireBlast_OnCast")//QB0H -> Hellfire Blast
	call SaveStr(MHT,'A0R0',3,"Pitlord_DarkRift_OnCast")//A0R0 -> Dark Rift
	call SaveStr(MHT,'A226',3,"Tidehunter_AnhorSmash_OnCast")//A226 -> Anchor Smash
	call SaveStr(MHT,'A32D',3,"Kodo_DigestSpitCast")//A32D -> Digest Spit
	call SaveStr(MHT,'A08C',3,"Fear_Night_OnCast")//A08C -> Crippling Fear
	call SaveStr(MHT,'A2TD',3,"Oblivion_Decripify_OnCast")//A2TD -> Decrepify
	call SaveStr(MHT,'A095',3,"Lion_Finger_OnCast")//A095 -> Finger of Death
	call SaveStr(MHT,'A09W',3,"Lion_Finger_OnCast")//A09W -> Finger of Death
	call SaveStr(MHT,'A12K',3,"WR_Powershot_OnCast")//A12K -> Powershot
	call SaveStr(MHT,'A12P',3,"FocusFire_OnCast")//A12P -> Focus Fire
	call SaveStr(MHT,'A1D6',3,"FocusFire_OnCast")//A1D6 -> Focus Fire Upgraded
	call SaveStr(MHT,'A1S8',3,"SD_Disruption_OnCast")//A1S8 -> Disruption
	call SaveStr(MHT,'A1TB',3,"Wisp_Relocate_OnCast")//A1TB -> Relocate
	call SaveStr(MHT,'A3FQ',3,"Wisp_Relocate_OnCast")//A1TB -> Relocate
	call SaveStr(MHT,'QB0L',3,"SleightOfFistAbuseStop")//QB0L -> Sleight of Fist
	call SaveStr(MHT,'A2H0',3,"SleightOfFistAbuseStop")//A2H0 -> Sleight of Fist
	call SaveStr(MHT,'A0B1',3,"Enigma_MidnightPulse_OnCast")//A0B1 -> Midnight Pulse
	
	//EVENT_UNIT_HERO_SKILL   // only called the first time the spell is leveled
	
	call SaveStr(MHT,'A064',4,"Sniper_Shrapnel_Learn")//A064 -> Shrapnel
	call SaveStr(MHT,'A1P8',4,"Spiritbreaker_Charge_Learn")//A1P8 -> Charge of Darkness
	call SaveStr(MHT,'A21L',4,"Warlord_WhirlingAxes_Learn")//A21L -> Whirling Axes
	call SaveStr(MHT,'A0I8',4,"Bloodseeker_Thrist_Learn")//A0I8 -> Strygwyr's Thirst
	call SaveStr(MHT,'A0CZ',4,"Void_Backtrack_Init")//A0CZ -> Backtrack
	call SaveStr(MHT,'A0AK',4,"HCF")//A0AK -> Remote Mines
	call SaveStr(MHT,'A1FY',4,"HCF")//A1FY -> Remote Mines
	call SaveStr(MHT,'A0S1',4,"PHF")//A0S1 -> Battle Hunger
	
	call SaveStr(MHT,'A0MB',4,"Riki_PermanentInvis_Learnd")//A0MB -> Permanent Invisibility
	call SaveStr(MHT,'A0MX',4,"Brewmaster_Brawler")//A0MX -> Drunken Brawler
	call SaveStr(MHT,'A34J',4,"SD_DemonicPurgeAgh_Learn")//A34J -> Demonic Purge
	call SaveStr(MHT,'A32G',4,"Kodo_DigestBonuses")//A32G -> Drums of War
	call SaveStr(MHT,'AIcd',4,"Pitlord_Atrophy_Init")//AIcd -> Atrophy Aura
	//call SaveStr(MHT,'A0O3',4,"Alchemist_Greed_Learn")//A0O3 -> Goblin's Greed
	call SaveStr(MHT,'A0NS',4,"Abbadon_Time_Learn")//A0NS -> Borrowed Time
	call SaveStr(MHT,'A1DA',4,"Abbadon_Time_Learn")//A1DA -> Borrowed Time Upgrade
	call SaveStr(MHT,'A517',4,"Abbadon_Time_Learn")
	call SaveStr(MHT,'A518',4,"Abbadon_Time_Learn")
	call SaveStr(MHT,'A0RP',4,"Templar_Trap_Learn")//A0RP -> Psionic Trap
	call SaveStr(MHT,'A449',4,"Templar_Trap_Learn")//A449 -> Psionic Trap
	
	call SaveStr(MHT,'A34A',4,"CheatDeath_Learn")//A34A -> Cheat Death
	call SaveStr(MHT,'A2O2',4,"MyTrueshotLearning")//A2O2 -> Trueshot Aura
	call SaveStr(MHT,'QF88',4,"Trax_Marksmanship_learn")//QF88 -> Marksmanship
	call SaveStr(MHT,'A0VC',4,"Trax_Marksmanship_learn")//QF88 -> Marksmanship
	call SaveStr(MHT,'A062',4,"Luna_Aura_Learn")//A062 -> Lunar Blessing
	call SaveStr(MHT,'A524',4,"Bounty_Jinada_LearnTrigger")//A524 -> Jinada
	call SaveStr(MHT,'A0M3',4,"BB_BB_Learn")//A0M3 -> Bristleback
	call SaveStr(MHT,'A06B',4,"Techies_SuicideSquad_Learn")//A06B -> Suicide Squad, Attack!
	call SaveStr(MHT,'A471',4,"Techies_SuicideSquad_Learn")//A06B -> Suicide Squad, Attack!
	call SaveStr(MHT,'A01N',4,"Necrolyte_Heartstopper_Learn")//A01N -> Heartstopper Aura
	call SaveStr(MHT,'A0BR',4,"SF_Necromastery_Learn")//A0BR -> Necromastery
	call SaveStr(MHT,'A03P',4,"PhantomAssassin_Blur_Learn")//A03P -> Blur
	call SaveStr(MHT,'A06D',4,"Butcher_FleshHeap_Learn")//A06D -> Flesh Heap
	call SaveStr(MHT,'A04E',4,"Tidehunter_KrakenShell_Learn")//A04E -> Kraken Shell
	call SaveStr(MHT,'A0MM',4,"Viper_CorrosiveSkin_Reg2")//A0MM -> Corrosive Skin
	call SaveStr(MHT,'A1NA',4,"Visage_SoulAssumption_Learn")//A1NA -> Soul Assumption
	call SaveStr(MHT,'A0NA',4,"Spectre_Dispersion_Learn")//A0NA -> Dispersion
	call SaveStr(MHT,'A0H9',4,"Spectre_AddHaunt")//A0H9 -> Haunt
	call SaveStr(MHT,'A1E6',4,"Razor_UnstableCurrent_Learn")//A1E6 -> Unstable Current
	call SaveStr(MHT,'A0QQ',4,"Huskar_BerserkerBlood_Learn")//A0QQ -> Berserker's Blood
	call SaveStr(MHT,'A0QW',4,"StormSpirit_Overload_Learn")//A0QW -> Overload
	call SaveStr(MHT,'A1EA',4,"TemplarAssassin_Refraction_Learn")//A1EA -> Refraction
	call SaveStr(MHT,'QB03',4,"TemplarAssassin_Refraction_Learn")//QB03 -> Refraction
	call SaveStr(MHT,'A01Y',4,"Leoric_Reincarnation_Learn")//A01Y -> Reincarnation
	call SaveStr(MHT,'A1AZ',4,"Leoric_Reincarnation_Learn")//A1AZ -> Reincarnation upgrade
	call SaveStr(MHT,'A18X',4,"Lina_FierySoul_Learn")//A18X -> Fiery Soul
	call SaveStr(MHT,'A1CD',4,"Chieftain_NaturalOrder_Learning")//A1CD -> Natural Order
	call SaveStr(MHT,'A1IN',4,"Slark_ShadowDance_Learn")//A1IN -> Shadow Dance
	call SaveStr(MHT,'A28Q',4,"Wisp_Overcharge_Learn")//A28Q -> Overcharge
	call SaveStr(MHT,'A27V',4,"Rubick_NullField_Learn")//A27V -> Null Field
	
	
//Called everytime as 5th or 6th skill obtained FIRST time. They have no Learn trigger, so u have to list functions here
	call SaveStr(MHT,'A064',1000,"Sniper_Shrapnel_Learn")//A064 -> Shrapnel
	call SaveStr(MHT,'A0K9',1000,"Rikimaru_BlinkStrike_Learn")//A0K9 -> Blink Strike
	call SaveStr(MHT,'A46E',1000,"PLPhantomRushLearn")//A46E -> Phantom Rush
	call SaveStr(MHT,'A0CG',1000,"GeminateAttack_Learn")//A0CG -> Geminate Attack
	call SaveStr(MHT,'A086',1000,"HunterInTheNight_Leveling")//A086 -> Hunter in the Night
	call SaveStr(MHT,'A43S',1000,"ChakramLevelup")//A43S -> Chakram
	call SaveStr(MHT,'A0BR',1000,"SF_Necromastery_Learn")//A0BR -> Necromastery
	call SaveStr(MHT,'A0EY',1000,"SF_Shadowrazes_Learn")//A0EY -> Shadowraze
	call SaveStr(MHT,'A03E',1000,"Lycan_FeralImpulse_Leveling")//A03E -> Feral Impulse
	call SaveStr(MHT,'A32G',1000,"Kodo_DigestBonuses")//A32G -> Drums of War
	call SaveStr(MHT,'A0MX',1000,"Brewmaster_Brawler")//A0MX -> Drunken Brawler
	call SaveStr(MHT,'A21M',1000,"Warlord_WhirlingAxes_Learn")//A21M -> Whirling Axes
	call SaveStr(MHT,'A34A',1000,"CheatDeath_Learn")//A34A -> Cheat Death
	
	call SaveStr(MHT,'A40B',1000,"Ogre_Bloodlust_Learn")//A40B -> Bloodlust
	call SaveStr(MHT,'A2O2',1000,"MyTrueshotLearning")//A2O2 -> Trueshot Aura
	call SaveStr(MHT,'A34J',1000,"SD_DemonicPurgeAgh_Learn")//A34J -> Demonic Purge
	call SaveStr(MHT,'A0MB',1000,"Riki_PermanentInvis_Learnd")//A0MB -> Permanent Invisibility
	call SaveStr(MHT,'P019',1000,"Maiden_Brilliance_Learn")//P019 -> Brilliance Aura
	//call SaveStr(MHT,'A0O3',1000,"Alchemist_Greed_Learn")//A0O3 -> Goblin's Greed
	call SaveStr(MHT,'A1P8',1000,"Spiritbreaker_Charge_Learn")//A1P8 -> Charge of Darkness
	call SaveStr(MHT,'A0RP',1000,"Templar_Trap_Learn")//A0RP -> Psionic Trap
	call SaveStr(MHT,'A449',1000,"Templar_Trap_Learn")//A449 -> Psionic Trap
	call SaveStr(MHT,'AIcd',1000,"Pitlord_Atrophy_Init")//AIcd -> Atrophy Aura
	call SaveStr(MHT,'A0VC',1000,"Trax_Marksmanship_learn")//QF88 -> Marksmanship
	call SaveStr(MHT,'QF88',1000,"Trax_Marksmanship_learn")//QF88 -> Marksmanship
	call SaveStr(MHT,'A1IN',1000,"Slark_ShadowDance_Learn")//A1IN -> Shadow Dance
	call SaveStr(MHT,'A13T',1000,"Kunka_Tidebringer_Learn")//A13T -> Tidebringer
	call SaveStr(MHT,'A522',1000,"Kunka_Tidebringer_Learn")//A522 -> Tidebringer
	call SaveStr(MHT,'A19Q',1000,"Tiny_CraggyExterior_Learning")//A19Q -> Craggy Exterior
	call SaveStr(MHT,'A0CY',1000,"Tiny_Grow_Learning")//A0CY -> Grow
	call SaveStr(MHT,'A1CD',1000,"Chieftain_NaturalOrder_Learning")//A1CD -> Natural Order
	
	call SaveStr(MHT,'A0QQ',1000,"Huskar_BerserkerBlood_Learn")//A0QQ -> Berserker's Blood
	call SaveStr(MHT,'A0M3',1000,"Bristleback_Bristleback_Learn")//A0M3 -> Bristleback
	call SaveStr(MHT,'A03U',1000,"Sniper_TakeAim_Learn")//A03U -> Take Aim
	
	call SaveStr(MHT,'A062',1000,"Luna_Aura_Learn")//A062 -> Lunar Blessing
	call SaveStr(MHT,'A0KX',1000,"Morphling_Morph_Learn")//A0KX -> Morph
	call SaveStr(MHT,'A0A5',1000,"LoneDruid_SpiritBear_Leveling")//A0A5 -> Summon Spirit Bear
	call SaveStr(MHT,'A27V',1000,"Rubick_NullField_Learn")//A27V -> Null Field
	call SaveStr(MHT,'A28Q',1000,"Wisp_Overcharge_Learn")//A28Q -> Overcharge
	call SaveStr(MHT,'A18X',1000,"Lina_FierySoul_Learn")//A18X -> Fiery Soul
	call SaveStr(MHT,'A11N',1000,"Admiral_XMark_Learn")//A11N -> X Marks The Spot
	call SaveStr(MHT,'A01Y',1000,"Leoric_Reincarnation_Learn")//A01Y -> Reincarnation
	call SaveStr(MHT,'A1AZ',1000,"Leoric_Reincarnation_Learn")//A1AZ -> Reincarnation upgrade
	
	call SaveStr(MHT,'A0RO',1000,"TemplarAssassin_PsiBlades_Leveling")//A0RO -> Psi Blades
	call SaveStr(MHT,'A0QW',1000,"StormSpirit_Overload_Learn")//A0QW -> Overload
	call SaveStr(MHT,'A1E6',1000,"Razor_UnstableCurrent_Learn")//A1E6 -> Unstable Current
	call SaveStr(MHT,'A0NA',1000,"Spectre_Dispersion_Learn")//A0NA -> Dispersion
	call SaveStr(MHT,'A0NS',1000,"Abbadon_Time_Learn")//A0NS -> Borrowed Time
	call SaveStr(MHT,'A0VX',1000,"Visage_GravekeeperCloak_Leveling")//A0VX -> Gravekeeper's Cloak
	call SaveStr(MHT,'A1NA',1000,"Visage_SoulAssumption_Learn")//A1NA -> Soul Assumption
	call SaveStr(MHT,'A04E',1000,"Tidehunter_KrakenShell_Learn")//A04E -> Kraken Shell
	
	call SaveStr(MHT,'A06D',1000,"Butcher_FleshHeap_Learn")//A06D -> Flesh Heap
	
	call SaveStr(MHT,'A03P',1000,"PhantomAssassin_Blur_Learn")//A03P -> Blur
	call SaveStr(MHT,'A01N',1000,"Necrolyte_Heartstopper_Learn")//A01N -> Heartstopper Aura
	call SaveStr(MHT,'A0I8',1000,"Bloodseeker_Thrist_Learn")//A0I8 -> Strygwyr's Thirst
	call SaveStr(MHT,'A06B',1000,"Techies_SuicideSquad_Learn")//A06B -> Suicide Squad, Attack!
	call SaveStr(MHT,'A1IQ',1000,"Bounty_Jinada_Learn")//A1IQ -> Jinada
	call SaveStr(MHT,'A524',1000,"Bounty_Jinada_Learn")//A524 -> Jinada
	call SaveStr(MHT,'A0IF',1000,"Destroyer_EssenceAura_Leveling")//A0IF -> Essence Aura
	call SaveStr(MHT,'A1EA',1000,"TemplarAssassin_Refraction_Learn")//A1EA -> Refraction
	call SaveStr(MHT,'QB03',1000,"TemplarAssassin_Refraction_Learn")//QB03 -> Refraction
	call SaveStr(MHT,'A0AK',1000,"HCF")//A0AK -> Remote Mines
	call SaveStr(MHT,'A0LV',1000,"Chen_Test_Learn")//A0LV -> Test of Faith
	call SaveStr(MHT,'A2AI',1000,"DragonKnight_DragonTail_Leveling")//A2AI -> Dragon Tail
	call SaveStr(MHT,'A0CZ',1000,"Void_Backtrack_Init")//A0CZ -> Backtrack
	call SaveStr(MHT,'A2S0',1000,"SkeletonKing_MortalStrike_AddCrit")//A2S0 -> Mortal Strike
	call SaveStr(MHT,'A0MM',1000,"Viper_CorrosiveSkin_Reg2")//A0MM -> Corrosive Skin
	call SaveStr(MHT,'A0CL',1000,"DK_DragonBlood_Act")//A0CL -> Dragon Blood
	call SaveStr(MHT,'A0OO',1000,"Beastmaster_CallOfTheWild_Learned")//A0OO -> Call of the Wild
	call SaveStr(MHT,'A303',1000,"Bone_SearingArrows_Learn")//A303 -> Searing Arrows
	call SaveStr(MHT,'A0H4',1000,"TB_ConjureImage_Leveled")//A0H4 -> Conjure Image
	call SaveStr(MHT,'Q0BK',1000,"IncapacitatingBite_Learn")//Q0BK -> Incapacitating Bite
	call SaveStr(MHT,'A2JK',1000,"Xin_FireRemnants_Learn")//A2JK -> Fire Remnant
	call SaveStr(MHT,'A1C0',1000,"Medusa_SplitShot_Learn")//A1C0 -> Splitshot
	call SaveStr(MHT,'A440',1000,"Adaptiveness_Learn")//A440 -> Adaptiveness
	call SaveStr(MHT,'A0A8',1000,"LoneDruid_Synergy")
	
	//EVENT_UNIT_HERO_SKILL   // called everytime the spell is leveled, including lvl 1
	call SaveStr(MHT,'A0K9',5,"Rikimaru_BlinkStrike_Learn")//A0K9 -> Blink Strike
	call SaveStr(MHT,'A46E',5,"PLPhantomRushLearn")//A46E -> Phantom Rush
	call SaveStr(MHT,'A43S',5,"ChakramLevelup")//A43S -> Chakram
	call SaveStr(MHT,'A440',5,"Adaptiveness_Learn")//A440 -> Adaptiveness
	call SaveStr(MHT,'A2E5',5,"ChakramLevelup")//A2E5 -> Chakram
	call SaveStr(MHT,'Q0BK',5,"IncapacitatingBite_Learn")//Q0BK -> Incapacitating Bite
	call SaveStr(MHT,'A2JK',5,"Xin_FireRemnants_Learn")//A2JK -> Fire Remnant
	call SaveStr(MHT,'A1C0',5,"Medusa_SplitShot_Learn")//A1C0 -> Splitshot
	call SaveStr(MHT,'A2S0',5,"SkeletonKing_MortalStrike_AddCrit")//A2S0 -> Mortal Strike
	call SaveStr(MHT,'A11N',5,"Admiral_XMark_Learn")//A11N -> X Marks The Spot
	 
	call SaveStr(MHT,'A2AI',5,"DragonKnight_DragonTail_Leveling")//A2AI -> Dragon Tail
	call SaveStr(MHT,'A03E',5,"Lycan_FeralImpulse_Leveling")//A03E -> Feral Impulse
	
	call SaveStr(MHT,'A0VX',5,"Visage_GravekeeperCloak_Leveling")//A0VX -> Gravekeeper's Cloak
	call SaveStr(MHT,'A0IF',5,"Destroyer_EssenceAura_Leveling")//A0IF -> Essence Aura
	
	call SaveStr(MHT,'A086',5,"HunterInTheNight_Leveling")//A086 -> Hunter in the Night
	call SaveStr(MHT,'A08E',5,"Stalker_Fear_Leveling")//A08E -> Crippling Fear (Learn)
	
	call SaveStr(MHT,'A0A5',5,"LoneDruid_SpiritBear_Leveling")//A0A5 -> Summon Spirit Bear
	call SaveStr(MHT,'A0CY',5,"Tiny_Grow_Learning")//A0CY -> Grow
	call SaveStr(MHT,'A19Q',5,"Tiny_CraggyExterior_Learning")//A19Q -> Craggy Exterior
	call SaveStr(MHT,'A0EY',5,"SF_Shadowrazes_Learn")//A0EY -> Shadowraze
	
	
	
	call SaveStr(MHT,'A0KX',5,"Morphling_Morph_Learn")//A0KX -> Morph
	call SaveStr(MHT,'A0CG',5,"GeminateAttack_Learn")//A0CG -> Geminate Attack
	call SaveStr(MHT,'A0OO',5,"Beastmaster_CallOfTheWild_Learned")//A0OO -> Call of the Wild
	call SaveStr(MHT,'A03U',5,"Sniper_TakeAim_Learn")//A03U -> Take Aim
	
	call SaveStr(MHT,'P019',5,"Maiden_Brilliance_Learn")//P019 -> Brilliance Aura
	call SaveStr(MHT,'A0H4',5,"TB_ConjureImage_Leveled")//A0H4 -> Conjure Image
	call SaveStr(MHT,'A0CL',5,"DK_DragonBlood_Act")//A0CL -> Dragon Blood
	call SaveStr(MHT,'A0RO',5,"TemplarAssassin_PsiBlades_Leveling")//A0RO -> Psi Blades
	call SaveStr(MHT,'A40B',5,"Ogre_Bloodlust_Learn")//A40B -> Bloodlust
	
	call SaveStr(MHT,'A13T',5,"Kunka_Tidebringer_Learn")//A13T -> Tidebringer
	call SaveStr(MHT,'A0LV',5,"Chen_Test_Learn")//A0LV -> Test of Faith
	call SaveStr(MHT,'A522',5,"Kunka_Tidebringer_Learn")//A522 -> Tidebringer
	call SaveStr(MHT,'A32Y',5,"Kodo_DigestLeveling")//A32Y -> Digest
	call SaveStr(MHT,'A32Z',5,"Doom_Devour_Leveling")//A32Z -> Devour
	call SaveStr(MHT,'A331',5,"Phoenix_Spirits_Leveling")//A331 -> Fire Spirits
	call SaveStr(MHT,'A303',5,"Bone_SearingArrows_Learn")//A303 -> Searing Arrows
	call SaveStr(MHT,'A0A8',5,"LoneDruid_Synergy")
	 
	
	// Used for s5-s6 support, called everytime unit obtains next level of ability, but not 1st
	call SaveStr(MHT,'A440',1001,"Adaptiveness_Learn")//A440 -> Adaptiveness
	call SaveStr(MHT,'A0K9',1001,"Rikimaru_BlinkStrike_Learn")//A0K9 -> Blink Strike
	call SaveStr(MHT,'A46E',1001,"PLPhantomRushLearn")//A46E -> Phantom Rush
	call SaveStr(MHT,'A0CG',1001,"GeminateAttack_Learn")//A0CG -> Geminate Attack
	call SaveStr(MHT,'A2E5',1001,"ChakramLevelup")//A2E5 -> Chakram
	call SaveStr(MHT,'A1C0',1001,"Medusa_SplitShot_Learn")//A1C0 -> Splitshot
	call SaveStr(MHT,'A2JK',1001,"Xin_FireRemnants_Learn")//A2JK -> Fire Remnant
	call SaveStr(MHT,'A11N',1001,"Admiral_XMark_Learn")//A11N -> X Marks The Spot
	call SaveStr(MHT,'A086',1001,"HunterInTheNight_Leveling")//A086 -> Hunter in the Night
	call SaveStr(MHT,'A0EY',1001,"SF_Shadowrazes_Learn")//A0EY -> Shadowraze
	call SaveStr(MHT,'A331',1001,"Phoenix_Spirits_Leveling")//A331 -> Fire Spirits
	call SaveStr(MHT,'A40B',1001,"Ogre_Bloodlust_Learn")//A40B -> Bloodlust
	call SaveStr(MHT,'A0H4',1001,"TB_ConjureImage_Leveled")//A0H4 -> Conjure Image
	call SaveStr(MHT,'A32Z',1001,"Doom_Devour_Leveling")//A32Z -> Devour
	call SaveStr(MHT,'A0KX',1001,"Morphling_Morph_Learn")//A0KX -> Morph
	call SaveStr(MHT,'A32Y',1001,"Kodo_DigestLeveling")//A32Y -> Digest
	call SaveStr(MHT,'Q0BK',1001,"IncapacitatingBite_Learn")//Q0BK -> Incapacitating Bite
	call SaveStr(MHT,'A303',1001,"Bone_SearingArrows_Learn")//A303 -> Searing Arrows
	call SaveStr(MHT,'P019',1001,"Maiden_Brilliance_Learn")//P019 -> Brilliance Aura
	call SaveStr(MHT,'A0OO',1001,"Beastmaster_CallOfTheWild_Learned")//A0OO -> Call of the Wild
	call SaveStr(MHT,'A2S0',1001,"SkeletonKing_MortalStrike_AddCrit")//A2S0 -> Mortal Strike
	call SaveStr(MHT,'A0LV',1001,"Chen_Test_Learn")//A0LV -> Test of Faith
	call SaveStr(MHT,'A0RO',1001,"TemplarAssassin_PsiBlades_Leveling")//A0RO -> Psi Blades
	call SaveStr(MHT,'A13T',1001,"Kunka_Tidebringer_Learn")//A13T -> Tidebringer
	call SaveStr(MHT,'A522',1001,"Kunka_Tidebringer_Learn")//A522 -> Tidebringer
	call SaveStr(MHT,'A19Q',1001,"Tiny_CraggeExterior_Leveling")//A19Q -> Craggy Exterior
	call SaveStr(MHT,'A03U',1001,"Sniper_TakeAim_Learn")//A03U -> Take Aim
	call SaveStr(MHT,'A0A5',1001,"LoneDruid_SpiritBear_Leveling")//A0A5 -> Summon Spirit Bear
	call SaveStr(MHT,'A03E',1001,"Lycan_FeralImpulse_Leveling")//A03E -> Feral Impulse
	call SaveStr(MHT,'A0VX',1001,"Visage_GravekeeperCloak_Leveling")//A0VX -> Gravekeeper's Cloak
	call SaveStr(MHT,'A2AI',1001,"DragonKnight_DragonTail_Leveling")//A2AI -> Dragon Tail
	call SaveStr(MHT,'A0CY',1001,"Tiny_Grow_Learning")//A0CY -> Grow
	call SaveStr(MHT,'A0IF',1001,"Destroyer_EssenceAura_Leveling")//A0IF -> Essence Aura
	call SaveStr(MHT,'A0CL',1001,"DK_DragonBlood_Act")//A0CL -> Dragon Blood
	call SaveStr(MHT,'A0A8',1001,"LoneDruid_Synergy")
	//EVENT_UNIT_SPELL_CHANNEL
	call SaveStr(MHT,'A01O',7,"VKE")//A01O -> Teleportation
	call SaveStr(MHT,'A04P',7,"Sniper_Assassinate")//A04P -> Assassinate
	call SaveStr(MHT,'A1AU',7,"Sniper_Assassinate")//A1AU -> Assassinate upgrade
	call SaveStr(MHT,'A454',7,"FireStompAct")//A454 -> Fire Stomp
	//EVENT_UNIT_ATTACKED


	//EVENT_UNIT_ISSUED_ORDER
	//EVENT_UNIT_ISSUED_POINT_ORDER
	//EVENT_UNIT_ISSUED_TARGET_ORDER


	//EVENT_PLAYER_UNIT_SUMMON
	call SaveStr(MHT,'A24K',9,"Terrorblase_Reflection_Illusion")//A24K -> Reflection Image


	//EVENT_PLAYER_CHAT
	call SaveStr(MHT,StringHash("-display"),10,"Psi_Blades_Display_Toggle")
	//call SaveStr(MHT,StringHash("-stats"),10,"Display_Stats")
	//call SaveStr(MHT,StringHash("-st"),10,"Display_Stats")
	//call SaveStr(MHT,StringHash("derp"),10,"herp")//for imbaness \:D/
endfunction


function Cooldown_Init takes nothing returns nothing
	//satanic
	call SaveBoolean(MHT,1,'A1FP',true)	 //is an item spell (Doesn't use the ItemsActiveAbilities[] array since the item Id has to be indexed anyway)//A1FP -> Satanic this
	call SaveInteger(MHT,2,'A1FP','I0AB')   //real item id//A1FP -> Satanic this, I0AB -> Satanic
	call SaveInteger(MHT,1,'I0AB','J000')   //dummy item id//I0AB -> Satanic, J000 -> Satanic
	call SaveReal(MHT,0,'I0AB',35)		  //cooldown duration//I0AB -> Satanic
	call SaveInteger(MHT,0,'J000','I0AB')   //real item id//J000 -> Satanic, I0AB -> Satanic
	//manta melee
	call SaveBoolean(MHT,1,'A0B8',true)	 //is an item spell//A0B8 -> Manta Image
	call SaveInteger(MHT,2,'A0B8','I09F')   //real item id//A0B8 -> Manta Image, I09F -> Manta Style
	call SaveInteger(MHT,1,'I09F','J001')   //dummy item id//I09F -> Manta Style, J001 -> Manta Style
	call SaveReal(MHT,0,'I09F',35)		  //cooldown duration//I09F -> Manta Style
	call SaveReal(MHT,0,'J001',35)		  //dummy cooldown duration (only needed for delayed items)//J001 -> Manta Style
	call SaveInteger(MHT,0,'J001','I09F')   //real item id//J001 -> Manta Style, I09F -> Manta Style
	//manta range
	call SaveBoolean(MHT,1,'A1WE',true)	 //is an item spell//A1WE -> Manta Image (ranged)
	call SaveInteger(MHT,2,'A1WE','I0MU')   //real item id//A1WE -> Manta Image (ranged), I0MU -> Manta Style (ranged)
	call SaveInteger(MHT,1,'I0MU','J002')   //dummy item id//I0MU -> Manta Style (ranged), J002 -> Manta Style (ranged)
	call SaveReal(MHT,0,'I09F',50)		  //cooldown duration//I09F -> Manta Style
	call SaveReal(MHT,0,'J002',50)		  //dummy cooldown duration (only needed for delayed items)//J002 -> Manta Style (ranged)
	call SaveInteger(MHT,0,'J002','I0MU')   //real item id//J002 -> Manta Style (ranged), I0MU -> Manta Style (ranged)
	call SaveInteger(MHT,0,'I09F','A0B8') //manta (melee)//I09F -> Manta Style, A0B8 -> Manta Image
	call SaveInteger(MHT,0,'I0MU','A1WE') //manta (ranged)//I0MU -> Manta Style (ranged), A1WE -> Manta Image (ranged)
	call SaveInteger(MHT,0,'I00Z','A0T9') //shiva//I00Z -> Shiva's Guard, A0T9 -> ICEARMORNEW (NEW)
	call SaveInteger(MHT,0,'I0AL','AChx') //guinsoo//I0AL -> Guinsoo's Scythe of Vyse, AChx -> Guinsoo's Scythe
	call SaveInteger(MHT,0,'I012','A0FD') //orchid//I012 -> Orchid Malevolence, A0FD -> Orchid Malevolence
	call SaveInteger(MHT,0,'I08O','A15W') //blademail//I08O -> Blade Mail, A15W -> Blademail
	call SaveInteger(MHT,0,'I08Z','A1T7') //euls//I08Z -> Eul's Scepter of Divinity, A1T7 -> Eul Cyclone
	call SaveInteger(MHT,0,'I0HI','A19M') //forcestaff//I0HI -> Force Staff, A19M -> Force Staff
	call SaveInteger(MHT,0,'I09M','A02O') //dagon1//I09M -> Dagon Level 1, A02O -> Finger of Death
	call SaveInteger(MHT,0,'I09P','A08Y') //dagon2//I09P -> Dagon Level 2, A08Y -> Finger of Death
	call SaveInteger(MHT,0,'I09N','A08Z') //dagon3//I09N -> Dagon Level 3, A08Z -> Finger of Death
	call SaveInteger(MHT,0,'I09O','A090') //dagon4//I09O -> Dagon Level 4, A090 -> Finger of Death
	call SaveInteger(MHT,0,'I09L','A092') //dagon5//I09L -> Dagon Level 5, A092 -> Finger of Death
	call SaveInteger(MHT,0,'I0O3','A28D') //veil//I0O3 -> Veil of Discord, A28D -> Veil of Discord
	call SaveInteger(MHT,0,'I0OL','A2EA') //rod//I0OL -> Rod of Atos, A2EA -> Rod of atos
	call SaveInteger(MHT,0,'I093','A0CK') //mek//I093 -> Mekansm, A0CK -> Mekansm Armor + Heal
	call SaveInteger(MHT,0,'I066','AIda') //buckler//I066 -> Nathrezim Buckler, AIda -> Item Temporary Area Armor Bonus
	call SaveInteger(MHT,0,'I0K6','A1EW') //pipe//I0K6 -> Khadgar's Pipe of Insight, A1EW -> Khadgar's Pipe of Insight
	call SaveInteger(MHT,0,'I0KY','A1MO') //urn//I0KY -> Urn of Shadows, A1MO -> Urn of shadows
	call SaveInteger(MHT,0,'I0N0','A1ZI') //medallion//I0N0 -> Medallion of Courage, A1ZI -> Medallion of Courage
	call SaveInteger(MHT,0,'I0NE','A1ZW') //Djangoe (the D's silent motherfucker)//I0NE -> Ancient Janggo of Endurance, A1ZW -> Ancient Jangoo
	call SaveInteger(MHT,0,'I0OX','A2K7') //abyssal//I0OX -> Abyssal Blade, A2K7 -> Annihilator Stun
	call SaveInteger(MHT,0,'I09H','A017') //lothar//I09H -> Lothar's Edge, A017 -> Wind Walk
	call SaveInteger(MHT,0,'I0JI','A1AC') //ghost//I0JI -> Ghost Scepter, A1AC -> Ghost Potion
	call SaveInteger(MHT,0,'I0LT','A1QD') //ethereal blade//I0LT -> Ethereal Blade, A1QD -> Ether Blast
	call SaveInteger(MHT,0,'I0BE','A0JL') //mjollnir//I0BE -> Mjollnir, A0JL -> Static Charge
	call SaveInteger(MHT,0,'I08Y','AIxk') //mask of madness//I08Y -> Mask of Madness, AIxk -> Berserk
	call SaveInteger(MHT,0,'I08R','AIpg') //diffusal 1//I08R -> Diffusal Blade Level 1, AIpg -> Item Purge
	call SaveInteger(MHT,0,'I0J9','AIpg') //diffusal 2//I0J9 -> Diffusal Blade Level 2, AIpg -> Item Purge
	call SaveInteger(MHT,0,'I0OV','A2K4') //halberd//I0OV -> Heaven's Halberd, A2K4 -> Prudence
	call SaveInteger(MHT,0,'I06B','A231') //boots of travel//I06B -> Boots of Travel, A231 -> Boots of Travel (fixed)
	call SaveInteger(MHT,0,'I0GJ','A12W') //phase boots//I0GJ -> Phase Boots, A12W -> Phase Boots - Phase
	call SaveInteger(MHT,0,'I0LL','A1Q8') //soul ring//I0LL -> Soul Ring, A1Q8 -> Soul Ring
	call SaveInteger(MHT,0,'I0GC','A0JY') //magic stick//I0GC -> Magic Stick, A0JY -> Magic Stick
	call SaveInteger(MHT,0,'I0HB','A0JY') //magic wand//I0HB -> Magic Wand, A0JY -> Magic Stick
endfunction

//Initilizes any stuff needed for LoD
function LoD_Init takes nothing returns nothing
	local player p
	local integer loopA = 0
	set CanAddTime[0] = 2
	set CanAddTime[1] = 2
  // RMD Init
	call RMD_Init()
	call LoDEvent_Init()
	call Cooldown_Init()
	//call LoDStat_Init()
	call Passive_Cooldown_Init()
	call HideAbility('A509')
	call HideAbility('A515')
	call HideAbility('A521')//A521 -> Nethertoxin
	call HideAbility('A147')//A147 -> Water Sword Container 1
	call HideAbility('A228')//A228 -> Anchor Smash Container
	call HideAbility('A0B8')//A0B8 -> Manta Image
	call HideAbility('A1WE')//A1WE -> Manta Image (ranged)
	call ExecuteFunc("InitPreloadingSkills")
	loop
		set p = Player(loopA)
		call TriggerRegisterPlayerUnitEvent(GAME_TRIGGER,p,EVENT_PLAYER_UNIT_ATTACKED,null)
		call TriggerRegisterPlayerUnitEvent(GAME_TRIGGER,p,EVENT_PLAYER_UNIT_DEATH,null)
		//call TriggerRegisterPlayerChatEvent(CHAT_TRIGGER,p,"derp",true) //awww D:
		//call TriggerRegisterPlayerUnitEvent(GAME_TRIGGER, Player(loopA),EVENT_PLAYER_UNIT_SUMMON,null)
		set loopA = loopA + 1
		exitwhen loopA == 15
	endloop
	set p=null
endfunction

function SetPlayerAbilityAvailable2 takes player p, integer spell, boolean b returns nothing
	//by default set to false, so it saves to true when the ability is disabled
//	call echo(Id2String(spell)+" disabled="+B2S(b)+" for "+GetPlayerName(p))
	call SaveBoolean(MHT,GetHandleId(p),spell,b==false)
	call SetPlayerAbilityAvailable(p,spell,b)
endfunction

function GetHeroIndexFromId takes integer id returns integer
	local integer i=0
	loop
		if HeroID[i]==id then
			return i
		endif
		set i=i+1
	endloop
	return -1
endfunction

//true if collision detected
function CheckStacking takes integer id1, integer id2, string searchfor,string Except returns boolean
	local integer i
	local integer k
	local string array s1
	local string array s2
	local integer j
	local integer o
	if id2>-1 then // if skill passed
		if HaveSavedString(UTable,id1,0)==false or HaveSavedString(UTable,id2,0)==false then//no limits => fine
			return false
		endif
		set i=0
		loop
			exitwhen HaveSavedString(UTable,id1,i)==false
			set s1[i]=LoadStr(UTable,id1,i)
			set i=i+1
		endloop
		set k=0
		loop
			exitwhen HaveSavedString(UTable,id2,k)==false
			set s2[k]=LoadStr(UTable,id2,k)
			set k=k+1
		endloop
		if i==0 or k==0 then//double check?
			return false
		endif
		set j=0
		loop
			set o=0
			exitwhen j>=i
			loop
				exitwhen o>=k
				if s1[j]==s2[o] and s1[j]!=Except then
					return true
				endif
				set o=o+1
			endloop
			set j=j+1
		endloop
		return false
	else // if string passed
		set i=0
		loop
			exitwhen HaveSavedString(UTable,id1,i)==false
			if LoadStr(UTable,id1,i)==searchfor then
				return true
			endif
			set i=i+1
		endloop
		return false
	endif
	return true
endfunction

function GetAghaIdByBase takes integer id returns integer
	local integer i=1
	loop
		if AghaBaseSpellID[i]==id then
			return i
		endif
		set i=i+1
		exitwhen i>AghaCounter
	endloop
	return -1
endfunction

function F49 takes item it returns integer
	local integer id
	local integer i=1
	if it==null then
		return-2
	endif
	set id=GetItemTypeId(it)
	loop
		if Item_Dummy[i]==id or Item_Real[i]==id then
			return i
		endif
		set i=i+1
		exitwhen i>ITC
	endloop
	return-1
endfunction

function UnitAddItemByIdLoD takes unit u, integer id, player p, boolean b, integer i returns nothing
	local item it=UnitAddItemById(u,id)
	call SetItemPlayer(it,p,b)
	call SetItemUserData(it,i)
	set it=null
endfunction

function RefreshItemsWithBalance takes unit u returns nothing
	local player p = GetOwningPlayer(u)
	local integer i=0
	local integer k=5
	local integer array iids
	local player array ips
	local integer id
	local item it
	set iids[0]=0
	set iids[1]=0
	set iids[2]=0
	set iids[3]=0
	set iids[4]=0
	set iids[5]=0
	call DisableTrigger(t_manipulateitem)
	loop
		set it=UnitItemInSlot(u,i)
		set id=F49(it)
		if id==BKB10 or id==BKB09 or id==BKB08 or id==BKB07 or id==BKB06 or id==BKB05 or id==HelmOfTheDominator or id==Necronomicon1 or id==Necronomicon2 or id==Necronomicon3 or id==HandOfMidas or id==RefresherOrb or id==ArcaneRing or id==ArcaneBoots then
			set iids[i]=GetItemTypeId(it)
			set ips[i]=GetItemPlayer(it)
			call RemoveItem(it)
		endif
		set i=i+1
		exitwhen i>k
	endloop
	call UnitResetCooldown(u)
	call TimerStart(PrimUltiTimer[GetPlayerId(p)],0,false,null)
	call TimerStart(SecUltiTimer[GetPlayerId(p)],0,false,null)
	call FlushChildHashtable(CooldownStorage,GetHandleId(u))
	set i=0
	set k=5
	loop
		if iids[i]>0 then
			set it=CreateItem(iids[i],0,0)
			call SetItemPlayer(it,ips[i],false)
			call SetItemUserData(it,1)
			call UnitAddItem(u,it)
		endif
		set i=i+1
		exitwhen i>k
	endloop
	call EnableTrigger(t_manipulateitem)
	set it=null
	set p=null
endfunction

function RelearnAbility takes unit u, integer id returns nothing
	local integer lvl=GetUnitAbilityLevel(u,id)
	local real abilCD
	local integer pid=GetPlayerId(GetOwningPlayer(u))
	local integer sid=PlayerSkillNumber[pid*PlayerSkillOffset+4]
	if lvl>0 then
		if HaveSavedHandle(CooldownStorage,GetHandleId(u),id) then
			call RemoveSavedHandle(CooldownStorage,GetHandleId(u),id)
		endif
		if id=='A02N' and lvl==4 then//A02N -> Mana Drain
			return
		endif
		call UnitRemoveAbility(u,id)
		call UnitAddAbility3(u,id,lvl)
		if LoadBoolean(CooldownStorage,-id,1) then
			if id==SkillID[sid] or (AlternateSkillID[sid]!=null and id==AlternateSkillID[sid]) then
				call TimerStart(PrimUltiTimer[pid],0,false,null)
			elseif Mode_S6 then
				call TimerStart(SecUltiTimer[pid],0,false,null)
			endif
//			if (id=='A0NS' or id=='A1DA') and HaveSavedInteger(HY,GetHandleId(u),4251) then
//				call RemoveSavedInteger(HY,GetHandleId(u),4251)
		endif
		if (id=='A0SB') and HaveSavedInteger(HY,GetHandleId(u),4266) then
			call RemoveSavedInteger(HY,GetHandleId(u),4266)
		endif
//		call echo("cd reset for "+Id2String(id))
	endif
endfunction

function RefreshWithBalance takes unit u, boolean items returns nothing
	local integer sid
	local integer lvl
	local integer iid
	local integer pid
	local integer xx
	local integer i
	set pid=GetPlayerId(GetOwningPlayer(u))
	set xx=1
	if items then
		call RefreshItemsWithBalance(u)
		return
	endif
	loop
			set iid=PlayerSkillNumber[pid*PlayerSkillOffset+xx]
			set sid=SkillID[iid]
			set i=GetAghaIdByBase(sid)
			if i>0 and GetUnitAbilityLevel(u,AghaUpgradeID[i])>0 then
				set sid=AghaUpgradedSpellID[i]
			endif
			if IsPassiveAbility[iid]==false and LoadBoolean(MHT,0,sid)==false and sid!='A1RK' and sid!='A43H' and sid!='A065' then//A1RK -> Supernova, A43H -> Supernova, A065 -> Rearm
				call RelearnAbility(u,sid)
			endif
			if sid=='A0OO' then
				call RelearnAbility(u,'A300')
				call RelearnAbility(u,'A301')
			elseif sid=='A0EY'then
				call RelearnAbility(u,'A0F0')
				call RelearnAbility(u,'A0FH')
			elseif sid=='A21M'then
				call RelearnAbility(u,'A21N')
			elseif sid=='A088'then
				call RelearnAbility(u,'A2KQ')
			endif
		set xx=xx+1
		exitwhen xx>PlayerSkillOffset
	endloop
	if LoadInteger(HeroStats,GetHandleId(u),'DEVR')!=0 then
		set tt_unit1=u
		call ExecuteFunc("Devour_Refresh_Wrap")
	endif
	set u=null
endfunction

function QS8 takes nothing returns nothing
	call DisplayTimedTextToPlayer(Player(1),.0,.0,20.,"Selected unit id: "+Id2String(GetUnitTypeId(GetTriggerUnit()))+" ("+I2S(GetUnitTypeId(GetTriggerUnit()))+")")
endfunction

function QT8 takes nothing returns nothing
	call DisplayTimedTextToPlayer(GetOwningPlayer(GetTriggerUnit()),.0,.0,20.,"You used skill # "+Id2String(GetSpellAbilityId())+" ("+I2S(GetSpellAbilityId())+")")
endfunction

function QU8 takes nothing returns nothing
	if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
		if OrderId2StringBJ(GetIssuedOrderId())!="smart" then
			call DisplayTimedTextToPlayer(GetOwningPlayer(GetTriggerUnit()),.0,.0,20.,"Skill order: "+OrderId2StringBJ(GetIssuedOrderId())+" ("+I2S(GetIssuedOrderId())+")")
		endif
	endif
endfunction

function IMaxIF takes integer a,integer b returns integer
	if(a<b)then
		return b
	else
		return a
	endif
endfunction

function QV8 takes integer PlayerId returns boolean
	if Mode_Debug then
		return true
	endif
	return((GetPlayerController(Player(PlayerId))==MAP_CONTROL_USER)and(GetPlayerSlotState(Player(PlayerId))==PLAYER_SLOT_STATE_PLAYING))
endfunction

function QX8 takes player p,boolean b returns nothing
	local sound s=CreateSoundFromLabel("InterfaceError",false,false,false,10,10)
	if b then
		if(GetLocalPlayer()==p)then
			call StartSound(s)
		endif
	endif
	call KillSoundWhenDone(s)
endfunction

function QA8 takes player p,boolean b,string s returns nothing
	if not(b)then
		return
	endif
	if(GetLocalPlayer()==p)then
		if(s!="")and(s!=null)then
			call ClearTextMessages()
			call DisplayTimedTextToPlayer(p,0,0,5,"|c00FF0000[LoD]|r|c006699CC"+" "+s+"|r")
		endif
	endif
endfunction

function DisplayWithoutClear takes player p,boolean QY8,string s returns nothing
	if not(QY8)then
		return
	endif
	if(GetLocalPlayer()==p)then
		if(s!="")and(s!=null)then
			call DisplayTimedTextToPlayer(p,0,0,5,"|c00FF0000[LoD]|r|c006699CC"+" "+s+"|r")
		endif
	endif
endfunction

function QB8 takes player p,boolean QY8,string s returns nothing
	if not(QY8)then
		return
	endif
	call QX8(p,QY8)
	call QA8(p,QY8,s)
endfunction

function AdjustHeroNumber takes integer num returns integer
	return num
endfunction

function QC8 takes nothing returns integer
	local integer rnd
	local integer i
	loop
		set rnd=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
		set i=0
		if IsHeroIngame[rnd]==false then
			return HeroID[rnd]
		endif
		exitwhen false
	endloop
	return HeroID[1]
endfunction

function GetIndexNoMute takes item it returns integer
	local integer id
	local integer i=1
	if it==null then
		return-2
	endif
	set id=GetItemTypeId(it)
	loop
		exitwhen i>ITC
		if Item_Dummy[i]==id or Item_Real[i]==id then
			return i
		endif
		set i=i+1
	endloop
	return-1
endfunction

function GetUnitsEvasion takes unit u returns integer
	local real chance=1
	local integer invcount
	local integer i=0
	local item it
	local integer lvl
	local integer bfine
	local integer break
	if EvasionSourcesActive[EVASION_SOURCE_BLUR] then
		set lvl=GetUnitAbilityLevel(u,'A03P') * (1-GetUnitAbilityLevel(u,'A36D'))//A03P -> Blur
		if lvl>0 then
			set chance=chance*(0.9-0.1*lvl)
		endif
	endif
	if EvasionSourcesActive[EVASION_SOURCE_DRUNKENBRAWLER] then
		set lvl=GetUnitAbilityLevel(u,'A0MX') * (1-GetUnitAbilityLevel(u,'A36D'))//A0MX -> Drunken Brawler
		if lvl>0 then
			set chance=chance*(0.95-0.05*lvl)
		endif
	endif
	if EvasionSourcesActive[EVASION_SOURCE_BUTTERFLY] or EvasionSourcesActive[EVASION_SOURCE_HALBERD] or EvasionSourcesActive[EVASION_SOURCE_TALISMAN] then
		set bfine=LoadInteger(HY,GetHandleId(u),'BFLY')
		set invcount=UnitInventorySize(u)
		loop
			exitwhen i>invcount
			set it=UnitItemInSlot(u,i)
			if it!=null then
				if GetIndexNoMute(it)==Butterfly then
					if bfine<=0 then
						set chance=chance*0.65
					else
						set bfine=bfine-1
					endif
				elseif GetIndexNoMute(it)==TalismanOfEvasion or GetIndexNoMute(it)==HeavensHalberd  then
					set chance=chance*0.75
				else
				endif
			endif
			set i=i+1
		endloop
	endif
	if EvasionSourcesActive[EVASION_SOURCE_SOLARCREST] then
		if GetUnitAbilityLevel(u,'A39G')==1 then//solar crest self evasion
			set chance=chance*0.75
		endif
		if GetUnitAbilityLevel(u,'A39M')==1 then//solar crest
			set chance=chance*0.75
		endif
	endif
	return 100-R2I(chance*100)//chance of evasion proc
endfunction

function MultChance takes integer c, integer c2 returns integer
	if c==0 then
		return c2
	endif
	return 100-(100-c)*(100-c2)/100
endfunction

function GetUnitsMissChance takes unit u returns integer
	local integer c=0
	local integer ch
	if EvasionSourcesActive[EVASION_DEBUFF_LASER] then
		
		if GetUnitAbilityLevel(u,'B02P')==1 then//laser
			set c=100
		endif
	endif
	if c!=100 then
		if EvasionSourcesActive[EVASION_DEBUFF_DRUNKENHAZE] then
			if GetUnitAbilityLevel(u,'BNdh')==1 then
				if GetUnitAbilityLevel(u,'A3PU')==1 then//beer
					set c=75
				elseif GetUnitAbilityLevel(u,'A3PR')==1 then//beer
					set c=45
				elseif GetUnitAbilityLevel(u,'A3PS')==1 then//beer
					set c=55
				elseif GetUnitAbilityLevel(u,'A3PT')==1 then//beer
					set c=65
				endif
			endif
		endif
		if EvasionSourcesActive[EVASION_DEBUFF_BITE] then
			if GetUnitAbilityLevel(u,'B01D')==1 then//brood
				if GetUnitAbilityLevel(u,'A3PY')==1 then//beer
					set c=MultChance(c,60)
				elseif GetUnitAbilityLevel(u,'A3PV')==1 then//beer
					set c=MultChance(c,30)
				elseif GetUnitAbilityLevel(u,'A3PW')==1 then//beer
					set c=MultChance(c,40)
				elseif GetUnitAbilityLevel(u,'A3PX')==1 then//beer
					set c=MultChance(c,50)
				endif
			endif
		endif
		if EvasionSourcesActive[EVASION_DEBUFF_SMOKE] then
			if GetUnitAbilityLevel(u,'Bhea')==1 then//smoke screen, cloud
				set c=MultChance(c,30+10*SmokeScreenLevel)
			endif
		endif
		if EvasionSourcesActive[EVASION_DEBUFF_BLINDINGLIGHT] then
			if GetUnitAbilityLevel(u,'B09K')==1 then//bliding light
				set c=MultChance(c,80)
			endif
		endif
		if EvasionSourcesActive[EVASION_DEBUFF_FEAR] then
			if GetUnitAbilityLevel(u,'B02M')==1 then//crippling fear, beer!
				set c=MultChance(c,50)
			endif
		endif
		if EvasionSourcesActive[EVASION_DEBUFF_RADIANCE] then
			if GetUnitAbilityLevel(u,'B3DJ')==1 then//radiance
				set c=MultChance(c,17)
			endif
		endif
		if EvasionSourcesActive[EVASION_DEBUFF_SOLARCREST] then
			if GetUnitAbilityLevel(u,'B39I')==1 then//solar crest debuff
				set c=MultChance(c,25)
			endif
		endif
		if EvasionSourcesActive[EVASION_DEBUFF_WHIRLINGAXE] then
			if GetUnitAbilityLevel(u,'B00C')==1 then//whirling axes debuff
				set c=MultChance(c,60)
			endif
		endif
	endif
	
	return c
endfunction

function ItsEvasionItem takes integer itemid returns boolean
	return itemid=='I0OV' or itemid=='I0J6' or itemid=='I0AI'//I0OV -> Heaven's Halberd, I0J6 -> Talisman of Evasion, I0AI -> The Butterfly
endfunction

function ItsEvasionAbility takes integer itemid returns boolean
	return itemid=='A0MX' or itemid=='QP0H' or itemid=='A03P' or itemid=='QP0R'//A0MX -> Drunken Brawler, QP0H -> Drunken Brawler, A03P -> Blur, QP0R -> Blur
endfunction

function CountEvasionItems takes unit whichUnit, integer itemid returns integer
	local integer i=0
	local integer n=0
	local integer c=UnitInventorySize(whichUnit)-1
	loop
		
		if GetItemTypeId(UnitItemInSlot(whichUnit,i))==itemid  then
			if GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM or GetTriggerEventId()==EVENT_PLAYER_UNIT_PAWN_ITEM then
				if  UnitItemInSlot(whichUnit,i)!=GetManipulatedItem() then
					set n=n+1
				endif
			else
				set n=n+1
			endif
		endif
		set i=i+1
		exitwhen i>c
	endloop
	return n
endfunction

function AddEvasionSumAbility takes unit u, integer percent returns nothing
	local integer i=0
	local integer spellbook
	local integer level
	local integer total
	set percent=percent-28
	loop
		call UnitRemoveAbility(u,EvasionContainers[i])
		set i=i+1
		exitwhen i>8
	endloop
	if percent<=0 then
		return
	endif
	set total=R2I(percent/2)+1
	set spellbook=R2I(total/4)
	set level=total-(spellbook*4)+1
	call UnitAddAbility2(u,EvasionContainers[spellbook])
	call UnitMakeAbilityPermanent(u,true,'EVA0'+spellbook)
endfunction

function DisableEvasionList takes player p, boolean dis returns nothing
	set dis=not dis
	call SetPlayerAbilityAvailable(p,'EVA1',dis)
	call SetPlayerAbilityAvailable(p,'EVA2',dis)
	call SetPlayerAbilityAvailable(p,'EVA3',dis)
	call SetPlayerAbilityAvailable(p,'EVA4',dis)
	call SetPlayerAbilityAvailable(p,'EVA5',dis)
	call SetPlayerAbilityAvailable(p,'EVA6',dis)
	call SetPlayerAbilityAvailable(p,'EVA7',dis)
	call SetPlayerAbilityAvailable(p,'EVA8',dis)
	call SetPlayerAbilityAvailable(p,'P119',dis)//drunken
	call SetPlayerAbilityAvailable(p,'P239',dis)//blur
	call SetPlayerAbilityAvailable(p,'P239',dis)//blur
	call SetPlayerAbilityAvailable(p,'A1BZ',dis)//talisman//A1BZ -> Evasion
	call SetPlayerAbilityAvailable(p,'A2K6',dis)//halberd//A2K6 -> Halberd Evasion
	call SetPlayerAbilityAvailable(p,'AIev',dis)//bfly//AIev -> Evasion
	call SetPlayerAbilityAvailable(p,'ACes',dis)//windrun+magnetic field//ACes -> Evasion
endfunction

function DisableEvasionTick takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local real time=TimerGetElapsed(GlobalTimer)
	if LoadReal(HY,h,0)<time then
		call RemoveSavedHandle(HY,GetHandleId(LoadUnitHandle(HY,h,0)),'EVAS')
		call DisableEvasionList(GetOwningPlayer(LoadUnitHandle(HY,h,0)),false)
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	endif
	set t=null
endfunction

function DisableEvasion takes unit u, real dur returns nothing
	local timer t
	local integer h
	local integer hu=GetHandleId(u)
	if HaveSavedHandle(HY,hu,'EVAS')==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveTimerHandle(HY,hu,'EVAS',t)
		call TimerStart(t,0.1,true,function DisableEvasionTick)
		call SaveUnitHandle(HY,h,0,u)
		call DisableEvasionList(GetOwningPlayer(u),true)
	else
		set t=LoadTimerHandle(HY,hu,'EVAS')
		set h=GetHandleId(t)
	endif
	if dur+TimerGetElapsed(GlobalTimer) > LoadReal(HY,h,0) then
		call SaveReal(HY,h,0,dur+TimerGetElapsed(GlobalTimer))
	endif
	set t=null
endfunction

function UnitRecountEvasion takes unit u returns nothing
	local real ev=1
	local integer i
	if GetUnitAbilityLevel(u,'A36D')==0 then
		if(GetUnitAbilityLevel(u,'A0MX'))>0 then//A0MX -> Drunken Brawler, QP0H -> Drunken Brawler
			set ev=ev*(1-(((GetUnitAbilityLevel(u,'A0MX'))*5+5)*0.01))//A0MX -> Drunken Brawler, QP0H -> Drunken Brawler
		endif
		if(GetUnitAbilityLevel(u,'A03P'))>0 then//A03P -> Blur, QP0R -> Blur
			set ev=ev*(1-0.1-(GetUnitAbilityLevel(u,'A03P'))*0.1)//A03P -> Blur, QP0R -> Blur
		endif
	endif
	if(GetUnitAbilityLevel(u,'A39M'))==1 then
		set ev=ev*0.75
	endif
	if GetUnitAbilityLevel(u,'A2K6')>0 then//halberd//A2K6 -> Halberd Evasion
		set i=CountEvasionItems(u,'I0OV')//I0OV -> Heaven's Halberd
		loop
			set ev=ev*(1-0.25)
			set i=i-1
			exitwhen i==0
		endloop
	endif
	if GetUnitAbilityLevel(u,'A1BZ')>0 then//talisman//A1BZ -> Evasion
		set i=CountEvasionItems(u,'I0J6')//I0J6 -> Talisman of Evasion
		loop
			set ev=ev*(1-0.25)
			set i=i-1
			exitwhen i==0
		endloop
	endif
	if GetUnitAbilityLevel(u,'AIev')>0 then//bfly//AIev -> Evasion
		set i=CountEvasionItems(u,'I0AI')//I0AI -> The Butterfly
		loop
			set i=i-1
			set ev=ev*(1-0.35)
			exitwhen i <= 0
		endloop
	endif
	
	call AddEvasionSumAbility(u,R2I((1-ev)*100))
	set u=null
endfunction

function EvasionStacking takes nothing returns nothing
	local eventid EID=GetTriggerEventId()
	if EID==EVENT_PLAYER_UNIT_PICKUP_ITEM or EID==EVENT_PLAYER_UNIT_DROP_ITEM or EID==EVENT_PLAYER_UNIT_PAWN_ITEM then
		if (ItsEvasionItem(GetItemTypeId(GetManipulatedItem())))then
			call UnitRecountEvasion(GetTriggerUnit())
		endif
	elseif EID==EVENT_PLAYER_HERO_SKILL then
		if ItsEvasionAbility(GetLearnedSkill())then
			call UnitRecountEvasion(GetTriggerUnit())
		endif
	else//called by 5th skill
		if ItsEvasionAbility(TempInteger)then
			call UnitRecountEvasion(GetTriggerUnit())
		endif
	endif
endfunction

function GetPassiveLearnNumber takes integer RealID returns integer
	local integer i=1
	loop
		if RealID==PassivesLearningSkill[i] then
			return i
		endif
		set i=i+1
		exitwhen i>PassivesCount
	endloop
	return 0
endfunction

function IsDead takes unit u returns boolean
	return GetUnitTypeId(u)<1 or IsUnitType(u,UNIT_TYPE_DEAD) or 0.405>GetWidgetLife(u)
endfunction

function AttackOrderDelayedB takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	if IsDead(caster)==false and IsDead(target)==false then
		call IssueTargetOrder(caster,"attack",target)
	endif
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set caster=null
	set target=null
	set t=null
endfunction

function AttackOrderDelayed takes unit caster, unit target returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0,false,function AttackOrderDelayedB)
	call SaveUnitHandle(HY,h,0,caster)
	call SaveUnitHandle(HY,h,1,target)
	set t=null
endfunction

function DelayedSelectionB takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	if IsDead(u)==false then
		if IsUnitHidden(u)==false then
			call SelectUnitAddForPlayer(u,GetOwningPlayer(u))
			call RemoveSavedHandle(HY,GetHandleId(t),0)
			call DestroyTimer(t)
		endif
	else
		call RemoveSavedHandle(HY,GetHandleId(t),0)
		call DestroyTimer(t)
	endif
	set t=null
	set u=null
endfunction

function DelayedSelection takes unit u returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.05,true,function DelayedSelectionB)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	set t=null
endfunction

function DistanceBetweenUnits takes unit Source,unit Target returns real
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real TargetX=GetUnitX(Target)
	local real TargetY=GetUnitY(Target)
	if Source==null or Target==null then
		return I2R(9999999999)
	else
		return SquareRoot((SourceX-TargetX)*(SourceX-TargetX)+(SourceY-TargetY)*(SourceY-TargetY))
	endif
	return 1.
endfunction

function SelectSummons takes unit u returns nothing
	if SelectionHelperEnabled[GetPlayerId(GetOwningPlayer(u))] and GetUnitAbilityLevel(u,'B06L')==0 and GetUnitAbilityLevel(u,'B098')==0 and DistanceBetweenUnits(udg_Hero[GetPlayerId(GetOwningPlayer(u))],u)<1000 then
		if IsUnitHidden(u)==false then
			call SelectUnitAddForPlayer(u,GetOwningPlayer(u))
		else
			call DelayedSelection(u)
		endif
	endif
endfunction

function DelayedLearnB takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer k=LoadInteger(HY,h,0)
	local integer lvl=LoadInteger(HY,h,1)
	if IsDead(u)==false then
		if GetUnitAbilityLevel(u,PassivesRealID[k]) < lvl then
			call SetUnitAbilityLevel(u,PassivesRealID[k],lvl)
			call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[k],lvl)
		endif
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	endif
	set u=null
	set t=null
endfunction

function DelayedLearn takes unit u, integer k, integer lvl returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,u)
	call SaveInteger(HY,h,0,k)
	call SaveInteger(HY,h,1,lvl)
	call TimerStart(t,1,true,function DelayedLearnB)
	set t=null
endfunction

function GeneralLearnA takes integer id returns nothing
	local unit u=GetTriggerUnit()
	local player p=GetOwningPlayer(u)
	local integer k=GetPassiveLearnNumber(id)
	local integer lvl
	if k>0 then
		set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[k])
		if lvl==1 then
			call UnitAddAbility2(u,PassivesSpellbookID[k])
			call UnitMakeAbilityPermanent(u,true,PassivesRealID[k])
			call UnitAddAbility2(u,PassivesLearningSkillUpg[k])
		else
			if IsDead(u)==false then
				call SetUnitAbilityLevel(u,PassivesRealID[k],lvl)
				call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[k],lvl)
				if PassivesLearningSkill[k]=='Q0BK'then
					call SetUnitAbilityLevel(u,'A0BM',lvl)
				endif
			elseif Mode_DM==false then
				call DelayedLearn(u,k,lvl)
			endif
		endif
	endif
	set u=null
	set p=null
endfunction

function GeneralLearnC takes nothing returns nothing
	local integer id=GetLearnedSkill()
	local unit u=GetTriggerUnit()
	local player p=GetOwningPlayer(u)
	local integer k=GetPassiveLearnNumber(id)
	local integer lvl
	if k>0 then
		set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[k])
		if lvl==1 then
			if id!='A086' then//A086 -> Hunter in the Night
				call UnitAddAbility2(u,PassivesSpellbookID[k])
				call UnitMakeAbilityPermanent(u,true,PassivesRealID[k])
				call UnitAddAbility2(u,PassivesLearningSkillUpg[k])
			endif
		elseif lvl>0 then
			if id!='A086' then//A086 -> Hunter in the Night
				call SetUnitAbilityLevel(u,PassivesRealID[k],lvl)
				call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[k],lvl)
				if PassivesLearningSkill[k]=='Q0BK'then
					call SetUnitAbilityLevel(u,'A0BM',lvl)
				endif
			endif
		endif
	endif
	set u=null
endfunction

function KindaWrapperFor5thSkill takes unit u, integer id returns nothing
	if id=='A1IQ' then//A1IQ -> Jinada
		if GetHeroLevel(u)>4 and GetUnitAbilityLevel(u,'A524')==0 then//A524 -> Jinada
			call UnitAddAbility2(u,'A524')//A524 -> Jinada
		endif
		if GetHeroLevel(u)>13 then
			call SetUnitAbilityLevel(u,'A524',4)//A524 -> Jinada
		elseif GetHeroLevel(u)>10 then
			call SetUnitAbilityLevel(u,'A524',3)//A524 -> Jinada
		elseif GetHeroLevel(u)>7 then
			call SetUnitAbilityLevel(u,'A524',2)//A524 -> Jinada
		endif
	elseif id=='QB0G' or id=='A0AR' then//QB0G -> Dragon Tail, A0AR -> Dragon Tail
		if GetHeroLevel(u)>13 then
			call SetUnitAbilityLevel(u,'A2AI',4)//A2AI -> Dragon Tail
		elseif GetHeroLevel(u)>10 then
			call SetUnitAbilityLevel(u,'A2AI',3)//A2AI -> Dragon Tail
		elseif GetHeroLevel(u)>7 then
			call SetUnitAbilityLevel(u,'A2AI',2)//A2AI -> Dragon Tail
		elseif GetHeroLevel(u)>4 then
			call UnitAddAbility2(u,'A2AI')//A2AI -> Dragon Tail
		endif
	elseif id=='A13T' then//A13T -> Tidebringer
		if GetHeroLevel(u)>4 and GetUnitAbilityLevel(u,'A522')==0 then//A522 -> Tidebringer
			call UnitAddAbility(u,'A522')//A522 -> Tidebringer
			call UnitMakeAbilityPermanent(u,true,'A522')//A522 -> Tidebringer
			call UnitAddAbility2(u,'A13T')//A13T -> Tidebringer
		endif
		if GetHeroLevel(u)>13 then
			call SetUnitAbilityLevel(u,'A13T',4)//A13T -> Tidebringer
		elseif GetHeroLevel(u)>10 then
			call SetUnitAbilityLevel(u,'A13T',3)//A13T -> Tidebringer
		elseif GetHeroLevel(u)>7 then
			call SetUnitAbilityLevel(u,'A13T',2)//A13T -> Tidebringer
		endif
	endif
endfunction

function QL8 takes integer id returns integer
	call KindaWrapperFor5thSkill(GetTriggerUnit(),id)
	if id=='A2JR' then//A2JR -> Fire Remnant
		return 'A2JK'//A2JK -> Fire Remnant
	elseif id=='Z318' then//Z318 -> Necromastery
		return 'A0BR'//A0BR -> Necromastery
	elseif id=='QF87' then//QF87 -> Morph
		return 'A0KX'//A0KX -> Morph
	elseif id=='P247' then//P247 -> Hunter in the Night
		return 'A086'//A086 -> Hunter in the Night
	elseif id=='A13T' then//A13T -> Tidebringer
		return 'A522'//A522 -> Tidebringer
	endif
	return id
endfunction

function GetPassiveID takes integer learnid returns integer
	local integer i=1
	local integer k=0
	loop
		if learnid==PassivesLearningSkill[i] or learnid==PassivesLearningSkillUpg[i] or learnid==PassivesRealID[i] or learnid==PassivesSpellbookID[i] then	
			set k=i
		endif
		set i=i+1
		exitwhen k>0 or i>PassivesCount
	endloop
	return k
endfunction

function ChangeAbilityVision takes unit u, integer oldid, integer newid returns nothing
	local integer lvl=GetUnitAbilityLevel(u,oldid)
	call UnitRemoveAbility(u,oldid)
	call UnitAddAbility2(u,newid)
	call SetUnitAbilityLevel(u,newid,lvl)
endfunction

function IsRangedUnit takes unit u, integer pid returns boolean
	return IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false or CheckStacking(PlayerSkillNumber[pid+1],-1,"range morph",null) or CheckStacking(PlayerSkillNumber[pid+2],-1,"range morph",null) or CheckStacking(PlayerSkillNumber[pid+3],-1,"range morph",null) or CheckStacking(PlayerSkillNumber[pid+4],-1,"range morph",null) or CheckStacking(PlayerSkillNumber[pid+5],-1,"range morph",null) or CheckStacking(PlayerSkillNumber[pid+6],-1,"range morph",null)
endfunction

function IsMeleeUnit takes unit u, integer pid returns boolean
	return IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) or CheckStacking(PlayerSkillNumber[pid+1],-1,"melee morph",null) or CheckStacking(PlayerSkillNumber[pid+2],-1,"melee morph",null) or CheckStacking(PlayerSkillNumber[pid+3],-1,"melee morph",null) or CheckStacking(PlayerSkillNumber[pid+4],-1,"melee morph",null) or CheckStacking(PlayerSkillNumber[pid+5],-1,"melee morph",null) or CheckStacking(PlayerSkillNumber[pid+6],-1,"melee morph",null)
endfunction

function Q08 takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetHeroLevel(u)
	local integer PlayerId=GetPlayerId(GetOwningPlayer(u))
	local integer sid
	local integer i
	local integer k=0
	local integer passiveIndex
	local boolean b=false
	local integer j=0
	local boolean bb=false
	if NumberOfExtraAbilities>=1 then
		if lvl>=5 then
			set sid=SkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+5]]
			set sid=QL8(sid)
			set passiveIndex=GetPassiveID(sid)
			set i=GetAghaIdByBase(sid)
		endif
		if lvl>=5 and ExtraAbilityLevel[PlayerId*2+1]==0 then
			call UnitAddAbility2(u,sid)
			set b=true
			set j=1
		endif
		if lvl>=8 and ExtraAbilityLevel[PlayerId*2+1]==1 then
			set b=true
			set j=2
		endif
		if lvl>=11 and ExtraAbilityLevel[PlayerId*2+1]==2 then
			set b=true
			set j=3
		endif
		if lvl>=14 and ExtraAbilityLevel[PlayerId*2+1]==3 then
			set b=true
			set j=4
		endif
		if b then
			if j>1 then
				call SetUnitAbilityLevel(u,sid,j)
				if i>0 and GetUnitAbilityLevel(u,AghaUpgradeID[i])>0 then
					set sid=AghaUpgradedSpellID[i]
				endif
				call SetUnitAbilityLevel(u,sid,j)
				if (sid=='A1C0' and GetUnitAbilityLevel(u,'A418')>0) then//A1C0 -> Splitshot, A418 -> Splitshot
					call SetUnitAbilityLevel(u,AlternateSkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+5]],j)
				endif
				if passiveIndex>0 then
					call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[passiveIndex],j)
				endif
			endif
			if sid>='A40K' and sid<='A40N' then//A40K -> Unus, A40N -> Denique
				if GetUnitAbilityLevel(u,sid+8)>0 then
					call SetUnitAbilityLevel(u,sid+8,j)
				endif
			endif
			call SaveInteger(HY,'0GAL',1488,j)//get ability lvl
			call SaveUnitHandle(HY,'0GTU',1488,u)//get trigger unit
			call SaveInteger(HY,'0GLS',1488,sid)//get learned skill
			set ExtraAbilityLevel[PlayerId*2+1]=j
			
			if j==1 then
				if HaveSavedString(MHT,sid,1000) then
					call ExecuteFunc(LoadStr(MHT,sid,1000))
				endif
			else
				if HaveSavedString(MHT,sid,1001) then
					call ExecuteFunc(LoadStr(MHT,sid,1001))
				endif
			endif
			if sid!='A1IQ' then//not jinada//A1IQ -> Jinada
				call Passive_Cooldown_Learn(u,sid,j)
			endif
			call GeneralLearnA(sid)
//			if(ItsEvasionAbility(sid))then
//				set TempInteger=sid
//				call EvasionStacking()
//			endif
		endif
	endif
	set bb=b
	set b=false
	set j=0
	if NumberOfExtraAbilities>=2 then
		if lvl>=8 then
			set sid=SkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+6]]
			set passiveIndex=GetPassiveID(sid)
			set sid=QL8(sid)
			set i=GetAghaIdByBase(sid)
		endif
		
		if lvl>=8 and ExtraAbilityLevel[PlayerId*2+2]==0 then
			call UnitAddAbility2(u,sid)
			if i>0 then
				call UnitMakeAbilityPermanent(u,true,AghaUpgradedSpellID[i])
			endif
			set b=true
			set j=1
		endif
		if i>0 and GetUnitAbilityLevel(u,AghaUpgradeID[i])>0 then
			set sid=AghaUpgradedSpellID[i]
		endif
		if lvl>=13 and ExtraAbilityLevel[PlayerId*2+2]==1 then
			set b=true
			set j=2
		endif
		if lvl>=18 and ExtraAbilityLevel[PlayerId*2+2]==2 then
			set b=true
			set j=3
		endif
		if b then
			if j>1 then
				call SetUnitAbilityLevel(u,sid,j)
				if passiveIndex>0 then
					call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[passiveIndex],j)
				endif
			endif
			call SetUnitAbilityLevel(u,sid,j)
			if i>0 and GetUnitAbilityLevel(u,AghaUpgradeID[i])>0 then
				set sid=AghaUpgradedSpellID[i]
			endif
			call SetUnitAbilityLevel(u,sid,j)
				
			if sid>='A40K' and sid<='A40N' and GetUnitAbilityLevel(u,sid+8)>0 then//A40K -> Unus, A40N -> Denique
				call SetUnitAbilityLevel(u,sid+8,j)
			endif
			
			call SaveInteger(HY,'0GAL',1488,j)
			call SaveUnitHandle(HY,'0GTU',1488,u)
			call SaveInteger(HY,'0GLS',1488,sid)
			set ExtraAbilityLevel[PlayerId*2+2]=j
			if j==1 then
				if HaveSavedString(MHT,sid,1000) then
					call ExecuteFunc(LoadStr(MHT,sid,1000))
				endif
			else
				if HaveSavedString(MHT,sid,1001) then
					call ExecuteFunc(LoadStr(MHT,sid,1001))
				endif
			endif
			if sid!='A065' then//-rearm//A065 -> Rearm
				call Passive_Cooldown_Learn(u,sid,j)
			endif
			call GeneralLearnA(sid)
		endif
	endif
	set bb=bb or b
//	if bb and HidePassivesForPlayer[PlayerId] then
//		set TEMPUNIT=u
//		call ExecuteFunc("HidePassivesOnLearn")
//	endif
	set u=null
endfunction

function InterruptUnit takes unit u returns nothing
	call PauseUnit(u,true)
	call IssueImmediateOrder(u,"stop")
	call PauseUnit(u,false)
endfunction

function SpellPickingPreventOrders takes nothing returns nothing
	local integer id=GetIssuedOrderId()
	if(GetUnitTypeId(GetTriggerUnit())=='hfoo')then//hfoo ->  
		if (id==851996 or id==851995 or id==851997 or id==852467 or id==851973 or id==851972)==false then
			call DisableTrigger(GetTriggeringTrigger())
			call InterruptUnit(GetTriggerUnit())
			call EnableTrigger(GetTriggeringTrigger())
		endif
	endif
	if b_isPickTime==false then
		call DestroyTrigger(GetTriggeringTrigger())
	endif
endfunction

function R98 takes nothing returns nothing
	local unit u=GetEnumUnit()
	call CreateUnit(GetOwningPlayer(u),'n00C',GetUnitX(u),GetUnitY(u),.0)//n00C -> Zone Indicator
	call PanCameraToTimed(GetUnitX(u),GetUnitY(u),.0)
	call KillUnit(u)
	set u=null
endfunction

function PlacePickDummies takes player p returns nothing
	call CreateUnit(p,'n00C',-7252,6993,bj_UNIT_FACING)//n00C -> Zone Indicator
	call CreateUnit(p,'n00C',-7252,6666,bj_UNIT_FACING)//n00C -> Zone Indicator
	call CreateUnit(p,'n00C',-7252,6340,bj_UNIT_FACING)//n00C -> Zone Indicator
	call CreateUnit(p,'n00C',-6775,6993,bj_UNIT_FACING)//n00C -> Zone Indicator
	call CreateUnit(p,'n00C',-6775,6340,bj_UNIT_FACING)//n00C -> Zone Indicator
	call CreateUnit(p,'n00C',-6775,6666,bj_UNIT_FACING)//n00C -> Zone Indicator
	call CreateUnit(p,'n00C',-6412,6993,bj_UNIT_FACING)//n00C -> Zone Indicator
	call CreateUnit(p,'n00C',-6412,6666,bj_UNIT_FACING)//n00C -> Zone Indicator
	call CreateUnit(p,'n00C',-6412,6340,bj_UNIT_FACING)//n00C -> Zone Indicator
endfunction

function RD8 takes nothing returns boolean
	return GetUnitTypeId(GetFilterUnit())=='etol'//etol -> The World Tree
endfunction

function RE8 takes nothing returns boolean
	return GetUnitTypeId(GetFilterUnit())=='unpl'//unpl -> The Frozen Throne
endfunction

function RF8 takes integer RG8 returns nothing
	local group g=CreateGroup()
	set GameWasFFed=true
	if RG8==1 then
		call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function RD8))
	else
		call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function RE8))
	endif
	call ForGroup(g,function R98)
	call DestroyGroup(g)
	set g=null
endfunction

function RH8 takes integer PlayerId returns integer
	local integer xx=0
	loop
		if PlayersId[xx]==PlayerId then
			return xx
		endif
		set xx=xx+1
		exitwhen xx>12
	endloop
	return 0
endfunction

function PlayerLeave_CheckFF takes nothing returns nothing
	local integer i=0
	local boolean b=true
	local boolean bb=false
	loop
		if(GetPlayerController(Player(PlayersId[i]))==MAP_CONTROL_USER)and(GetPlayerSlotState(Player(PlayersId[i]))==PLAYER_SLOT_STATE_PLAYING)then
			set bb=true//if player exist
			if not PlayerFFed[PlayersId[i]]then
				set b=false//not ffed yet
				exitwhen true
			endif
		endif
		set i=i+1
		exitwhen i>5
	endloop
	if b and bb then
		call RF8(1)
	endif
	set i=6
	set b=true
	set bb=false
	loop
		if(GetPlayerController(Player(PlayersId[i]))==MAP_CONTROL_USER)and(GetPlayerSlotState(Player(PlayersId[i]))==PLAYER_SLOT_STATE_PLAYING)then
			set bb=true
			if not PlayerFFed[PlayersId[i]]then
				set b=false
				exitwhen true
			endif
		endif
		set i=i+1
		exitwhen i>11
	endloop
	if b and bb then
		call RF8(2)
	endif
endfunction

function RN8 takes integer PlayerId, boolean b returns nothing
	local player p=Player(PlayerId)
	if not(GameWasFFed) and Mode_FF then
		if b then //for leavers
			set PlayerFFed[PlayerId]=true
			call PlayerLeave_CheckFF()
			return
		endif
		if GetPlayerState(p,PLAYER_STATE_RESOURCE_LUMBER)>=20 then
			if not(PlayerFFed[PlayerId])then
				call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,10.,"|c00FF0000[FF] |r"+"|c006699CC"+"Player "+udg_Colors[PlayerId]+PlayerNames[PlayerId]+"|r"+"|c006699CC"+" has voted to fast finish."+"|r")
				set PlayerFFed[PlayerId]=true
				call PlayerLeave_CheckFF()
			else
				call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c00FF0000[FF] |r"+"|c006699CC"+"You have already voted."+"|r")
			endif
		else
			call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c00FF0000[FF] |r"+"|c006699CC"+"You can only vote to fast finish after 20 minutes."+"|r")
		endif
	endif
	set p=null
endfunction

function AddGold takes player p, integer gold returns integer
	if LoadReal(HeroStats,GetHandleId(p),25)>TimerGetElapsed(GlobalTimer) then
		set gold=R2I(gold*BUYBACKBOUNTYFACTOR)
	endif
	call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,gold + GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD))
	return gold
endfunction

function RO8 takes player p returns nothing
	local integer RJ8=0
	if not(GameWasFFed)then
		call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c00FF0000[FF] |r"+"|c006699CC"+"Who is FF."+"|r")
		loop
			if((GetPlayerController(Player(PlayersId[RJ8]))==MAP_CONTROL_USER)and(GetPlayerSlotState(Player(PlayersId[RJ8]))==PLAYER_SLOT_STATE_PLAYING))then
				if PlayerFFed[PlayersId[RJ8]]then
					call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c006699CC[|r"+"|c0066FF66Y|r"+"|c006699CC]|r"+" "+TabTab+udg_Colors[PlayersId[RJ8]]+PlayerNames[PlayersId[RJ8]]+"|r")
				else
					call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c006699CC[|r"+"|c00C83264N|r"+"|c006699CC]|r"+" "+TabTab+udg_Colors[PlayersId[RJ8]]+PlayerNames[PlayersId[RJ8]]+"|r")
				endif
			elseif RJ8==0 then
				call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c00ff0303The Sentinel|r")
			elseif RJ8==6 then
				call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c0020c000The Scourge|r")
			endif
			set RJ8=RJ8+1
			exitwhen RJ8>12
		endloop
	endif
endfunction

function RP8 takes nothing returns nothing
	local integer xx=0
	loop
		set PlayersId[xx]=xx
		set xx=xx+1
		exitwhen xx>12
	endloop
endfunction

function IsPlayer takes player p returns boolean
	return GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING and GetPlayerController(p)==MAP_CONTROL_USER
endfunction

function SuspendXP_Fix takes nothing returns boolean
	call SuspendHeroXP(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2),true)
	return false
endfunction

function FixOverexp takes nothing returns nothing
	local trigger t
	local integer h
	local unit Source=GetTriggerUnit()
	local integer SkillPoints=GetHeroSkillPoints(Source)
	if GetHeroLevel(Source)>=MaximumLevel then
		call SuspendHeroXP(Source,true)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(GetTriggerUnit()))
		call TriggerRegisterTimerEvent(t,0.1,true)
		call TriggerAddCondition(t,Condition(function SuspendXP_Fix))
		set t=null
	endif
	set Source=null
endfunction

function DistanceBetweenXY takes real x1,real y1,real x2,real y2 returns real
	return SquareRoot(((x1-x2)*(x1-x2))+((y1-y2)*(y1-y2)))
endfunction

function ShakeCamDur takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call CameraClearNoiseForPlayer(LoadPlayerHandle(HY,h,0))
	call RemoveSavedHandle(HeroStats,GetHandleId(LoadPlayerHandle(HY,h,0)),'CAMS')
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	
	set t=null
endfunction

function ShakeCam takes unit u, real dmg returns nothing
	local timer t
	local integer h
	local player p=GetOwningPlayer(u)
	local integer hp=GetHandleId(p)
	local real power=RMinIF(dmg,1000)/100
	if HaveSavedHandle(HeroStats,hp,'CAMS') then
		set t=LoadTimerHandle(HeroStats,hp,'CAMS')
		set h=GetHandleId(t)
		if LoadReal(HY,h,0)<power then
			call CameraClearNoiseForPlayer(p)
		endif
		call CameraSetEQNoiseForPlayer(p,power)
	else
		set t=CreateTimer()
		call TimerStart(t,0.3,false,function ShakeCamDur)
		set h=GetHandleId(t)
		call SavePlayerHandle(HY,h,0,p)
		call SaveReal(HY,h,0,power)
		call CameraSetEQNoiseForPlayer(p,power)
		call SaveTimerHandle(HeroStats,hp,'CAMS',t)
	endif
	
	set t=null
endfunction

function SG8 takes nothing returns nothing
	local texttag tt=null
	local string d=I2S(R2I(GetEventDamage()))
	local player t=GetOwningPlayer(GetTriggerUnit())
	local player a=GetOwningPlayer(GetEventDamageSource())
	if IsPlayer(t) and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) and GetEventDamage()>=5 and ShakingOn[GetPlayerId(t)] then
		call ShakeCam(GetTriggerUnit(),GetEventDamage())
	endif
	if d=="0" or (b_isDamageShowed[GetPlayerId(t)]==false and b_isDamageShowed[GetPlayerId(a)]==false) then
		return
	endif
	call CreateTextTagUnitBJ(d,GetTriggerUnit(),zOffsetDebug,12.,100.,100.,100.,.0)
	set zOffsetDebug=zOffsetDebug+20
	set tt=bj_lastCreatedTextTag
	call SetTextTagVelocityBJ(tt,10.,90)
	call SetTextTagPermanentBJ(tt,false)
	call SetTextTagLifespanBJ(tt,3)
	call SetTextTagFadepointBJ(tt,2)
	call SetTextTagVisibility(tt,false)
	if b_isDamageShowed[GetPlayerId(t)]and GetLocalPlayer()==t then
		call SetTextTagColor(tt,250,0,0,255)
		call SetTextTagVisibility(tt,true)
	endif
	if b_isDamageShowed[GetPlayerId(a)]and GetLocalPlayer()==a and IsUnitVisibleLoD(GetTriggerUnit(),a)then
		call SetTextTagColor(tt,0,0,250,255)
		call SetTextTagVisibility(tt,true)
	endif
	set tt=null
	set t=null
	set a=null
endfunction

function SH8 takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local trigger t
	if (IsUnitType(u,UNIT_TYPE_HERO) and b_isPickTime)==false then
		if quest_test then
			set t=CreateTrigger()
			call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
			call TriggerAddAction(t,function SG8)
			set t=null
		endif
		if IsUnitType(u,UNIT_TYPE_HERO) and GetUnitAbilityLevel(u,'A04R')==0 then//
			call ExecuteFunc("LoDEvent_Add")
		endif
	endif

	set u = null
	//set t = null
endfunction

function isPlayerPickedAbility takes player p,integer SJ8 returns boolean
	local integer PlayerId=GetPlayerId(p)
	local integer xx=1
	loop
		if(PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]==SJ8)then
			return true
		endif
		set xx=xx+1
		exitwhen xx>4+NumberOfExtraAbilities
	endloop
	return false
endfunction

function IsRearmPicked takes unit u returns boolean
	//call echo(B2S(GetUnitAbilityLevel(u,'Y076')==1)+B2S(GetUnitAbilityLevel(u,'A065')>0)+B2S(GetUnitAbilityLevel(u,'A527')>0)+B2S(GetUnitAbilityLevel(u,'A528')>0)+B2S(isPlayerPickedAbility(GetOwningPlayer(u),76)))//A065 -> Rearm, A528 -> |cffffcc00R|rearm - [|cffffcc00Level 1|r]","|cffffcc00R|rearm - [|cffffcc00Level 2|r]","|cffffcc00R|rearm - [|cffffcc00Level 3|r]
	return GetUnitAbilityLevel(u,'Y076')==1 or GetUnitAbilityLevel(u,'A065')>0 or GetUnitAbilityLevel(u,'A527')>0 or GetUnitAbilityLevel(u,'A528')>0 or isPlayerPickedAbility(GetOwningPlayer(u),76)//A065 -> Rearm, A528 -> |cffffcc00R|rearm - [|cffffcc00Level 1|r]","|cffffcc00R|rearm - [|cffffcc00Level 2|r]","|cffffcc00R|rearm - [|cffffcc00Level 3|r]
endfunction

function SK8 takes integer PlayerId,integer Q28 returns integer
	local integer xx=1
	loop
		set Q28=QL8(Q28)
		if(SkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]]==Q28)then
			return PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]
		endif
		set xx=xx+1
		exitwhen xx>4+NumberOfExtraAbilities
	endloop
	return 0
endfunction

function GetHeroAbilityLevel takes unit Hero, integer id returns integer
	local integer i=GetPlayerId(GetOwningPlayer(Hero))
	local integer aid1=AlternateSkillID[PlayerSkillNumber[i*PlayerSkillOffset+id]]
	local integer aid2=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+id]]
	if aid1!=null then
		if GetUnitAbilityLevel(Hero,aid1)>0 then
			return GetUnitAbilityLevel(Hero,aid1)
		endif
	endif
	return GetUnitAbilityLevel(Hero,aid2)
endfunction



//returns 1st if true, else 2nd
function Switcher takes boolean switch, integer ifBalance, integer ifImbalance returns integer
	if switch then
		return ifBalance
	endif
	return ifImbalance
endfunction

function ST takes integer id, string s returns string
	local integer i=0
	if s==null or s=="" then
		return null
	endif
	loop
		exitwhen HaveSavedString(UTable,id,i)==false
		set i=i+1
	endloop
	call SaveStr(UTable,id,i,s)
	return null
endfunction

function BalanceOffStackSwitch takes integer id, string BO_off returns nothing
	if Mode_BO==false then
		call ST(id,BO_off)
	endif
endfunction

function ExBalanceStackSwitch takes integer id, string stack returns nothing
	if Mode_BO==false then
		call ST(id,stack)
	endif
endfunction

function GetSkillIndex takes integer id returns integer
	local integer i=1
	loop
		if SkillID[i]==id then
			return i
		endif
		set i=i+1
		exitwhen i>maxSkillId
	endloop
	return -1
endfunction

function ConvertSkillData takes integer id, string StackLim, integer RSkillId, integer ASkillId, integer USkillId, string hotkey returns nothing
	if RSkillId>0 then
		set SkillIcon[id]=GetAbilitySoundById(RSkillId,SOUND_TYPE_EFFECT_LOOPED)
//		if StringLength(SkillIcon[id])<20 then
//			call echo(Id2String(RSkillId)+" - len")
//		endif
//	else
//		call echo(Id2String(RSkillId))
	endif
//	call Preload(Id2String(RSkillId))
	set SkillID[id]=RSkillId
	set AlternateSkillID[id]=ASkillId
	set EngineeringUpgradeSkillID[id]=USkillId
	if hotkey!="_" and hotkey!="" and hotkey!=null then
		call SaveStr(UTable,RSkillId,HOTKEY,hotkey)
	endif
	set maxSkillId=id
endfunction

function S38 takes location l,real d,real a returns location
	return Location(GetLocationX(l)+d*Cos(a*bj_DEGTORAD),GetLocationY(l)+d*Sin(a*bj_DEGTORAD))
endfunction

function S08 takes nothing returns boolean
	local real dx=GetDestructableX(GetFilterDestructable())-.0
	local real dy=GetDestructableY(GetFilterDestructable())-.0
	return(dx*dx+dy*dy<=bj_enumDestructableRadius)
endfunction

function S58 takes player whichPlayer returns force
	set P68=CreateForce()
	call ForceEnumEnemies(P68,whichPlayer,PL8)
	return P68
endfunction

function T48 takes itemtype T78,integer T88 returns nothing
	local group g
	set bj_stockPickedItemType=T78
	set bj_stockPickedItemLevel=T88
	set g=CreateGroup()
	call GroupEnumUnitsOfType(g,"marketplace",PL8)
	call ForGroup(g,function UpdateEachStockBuildingEnum)
	call DestroyGroup(g)
	set g=null
endfunction

function T98 takes nothing returns nothing
	local integer pickedItemId
	local itemtype TD8
	local integer TE8=0
	local integer TF8=0
	local integer T88
	set T88=1
	loop
		if(bj_stockAllowedPermanent[T88])then
			set TF8=TF8+1
			if(GetRandomInt(1,TF8)==1)then
				set TD8=ITEM_TYPE_PERMANENT
				set TE8=T88
			endif
		endif
		if(bj_stockAllowedCharged[T88])then
			set TF8=TF8+1
			if(GetRandomInt(1,TF8)==1)then
				set TD8=ITEM_TYPE_CHARGED
				set TE8=T88
			endif
		endif
		if(bj_stockAllowedArtifact[T88])then
			set TF8=TF8+1
			if(GetRandomInt(1,TF8)==1)then
				set TD8=ITEM_TYPE_ARTIFACT
				set TE8=T88
			endif
		endif
		set T88=T88+1
		exitwhen T88>10
	endloop
	if(TF8==0)then
		set TD8=null
		return
	endif
	call T48(TD8,TE8)
	set TD8=null
endfunction

function TG8 takes nothing returns nothing
	call T98()
	call TimerStart(bj_stockUpdateTimer,bj_STOCK_RESTOCK_INTERVAL,true,function T98)
endfunction

function TK8 takes nothing returns nothing
	local integer i
	local integer j
	local integer h
	local integer v
	local string TM8="abcdefghijklmnopqrstuvwxyz0123456789 -=,."
	local integer array TN8
	local boolean array TO8
	set TO8[0]=true
	set TO8[50]=true
	set TO8[60]=true
	set TO8[70]=true
	set TO8[80]=true
	set TO8[90]=true
	set TO8[100]=true
	set i=0
	set j=0
	loop
		if TO8[j]then
			set j=j+1
		endif
		exitwhen j>=256
		set TN8[j]=i
		set i=i+1
		set j=j+1
	endloop
	set i=0
	loop
		exitwhen i>=12
		set h=R2I(100*GetPlayerHandicap(Player(i)))
		if not TO8[h]then
			set h=TN8[h]
			set v=h/ 6
			set h=h-v*6
			call SetPlayerHandicap(Player(i),1)
			set HCLstring=HCLstring+SubString(TM8,v,v+1)
		endif
		set i=i+1
	endloop
endfunction

function MBSetText takes multiboard mb,integer c,integer r,string s returns nothing
	local multiboarditem mbitem=null
	set mbitem=MultiboardGetItem(mb,r-1,c-1)
	call MultiboardSetItemValue(mbitem,s)
	call MultiboardReleaseItem(mbitem)
	set mbitem=null
endfunction

function MBSetIcon takes multiboard mb,integer c,integer r,string s returns nothing
	local multiboarditem mbitem=null
	set mbitem=MultiboardGetItem(mb,r-1,c-1)
	call MultiboardSetItemIcon(mbitem,s)
	call MultiboardReleaseItem(mbitem)
	set mbitem=null
endfunction

function MBSetStyle takes multiboard mb,integer c,integer r,boolean val,boolean icon returns nothing
	local multiboarditem mbitem=null
	set mbitem=MultiboardGetItem(mb,r-1,c-1)
	call MultiboardSetItemStyle(mbitem,val,icon)
	call MultiboardReleaseItem(mbitem)
	set mbitem=null
endfunction

function MBSetColor takes multiboard mb,integer c,integer r,real red,real g,real b,real a returns nothing
	local multiboarditem mbitem=null
	set mbitem=MultiboardGetItem(mb,r-1,c-1)
	call MultiboardSetItemValueColor(mbitem,PercentTo255(red),PercentTo255(g),PercentTo255(b),PercentTo255(100.-a))
	call MultiboardReleaseItem(mbitem)
	set mbitem=null
endfunction

function MBSetWidth takes multiboard mb,integer c,integer r,real w returns nothing
	local multiboarditem mbitem=null
	set mbitem=MultiboardGetItem(mb,r-1,c-1)
	call MultiboardSetItemWidth(mbitem,w/ 100)
	call MultiboardReleaseItem(mbitem)
	set mbitem=null
endfunction

function DaI_Load takes integer i returns destructable
	if i>16000 then
		return LY[i-16000]
	elseif i>8000 then
		return KY[i-8000]
	else
		return JY[i]
	endif
	return JY[i]
endfunction

function DaI_Clear takes integer i returns nothing
	if i>16000 then
		set LY[i-16000]=null
	elseif i>8000 then
		set KY[i-8000]=null
	else
		set JY[i]=null
	endif
endfunction

function DaI_Save takes destructable d returns integer
	set MY=MY+1
	if MY>24000 then
		set LY[MY-16000]=d
	elseif MY>8000 then
		set KY[MY-8000]=d
	else
		set JY[MY]=d
	endif
	return MY
endfunction

function IsBlocked takes unit u returns boolean
	return GetUnitAbilityLevel(u,'B0BI')>0 or GetUnitAbilityLevel(u,'BNss')>0 or GetUnitAbilityLevel(u,'B0EV')>0//B0BI -> Linken Sphere, BNss -> Spell Shield, B0EV -> Retaliation
endfunction

function KillGroup takes group g returns nothing
	local integer i=GetHandleId(g)-GroupsFirstHandle
	//call echo("Group killed: "+I2S(GetHandleId(g))+" , trigger h="+I2S(GetHandleId(GetTriggeringTrigger())))
	if i<0 or i>240 then
	else
		call GroupClear(g)
		set GroupTaken[i]=false
		set GroupsInt=i
	endif
endfunction

function GetAvailableGroup takes nothing returns group
	local integer i=GroupsInt
	loop
		exitwhen i==GroupsInt-1
		if GroupTaken[i]==false then
			set GroupsInt=i+1
			if GroupsInt==240 then
				set GroupsInt=1
			endif
			set GroupTaken[i]=true
//			call echo("Group allocated: "+I2S(GetHandleId(groups[i]))+" , trigger h="+I2S(GetHandleId(GetTriggeringTrigger()))+", i="+I2S(i))
			return groups[i]
		endif
		set i=i+1
		if i==240 then
			set i=0
		endif
	endloop
	set GroupErrorCounter=GroupErrorCounter+1
	if ModuloInteger(GroupErrorCounter,100)==1 then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,20,"|c00ff0303Running out of groups!|r This may be not a big glitch but still dangerous. Report it please.")
	endif
	
	//call BJDebugMsg("|c00ff0303Running out of groups!|r This may be not a big glitch but still dangerous. Report it please.")
	return CreateGroup()
endfunction

function GroupsClose takes nothing returns boolean
	local integer Count=0
	local integer i=0
	loop
		exitwhen i==240
		if GroupTaken[i] then
			set Count=Count+1
		endif
		set i=i+1
	endloop
	return false
endfunction

function InitGroups takes nothing returns nothing
	local integer i=0
	set groups[i]=CreateGroup()
	set i=i+1
	set GroupsFirstHandle=GetHandleId(groups[0])
	loop
		exitwhen i==240
		set groups[i]=CreateGroup()
		set i=i+1
	endloop
endfunction

function GetClosestOfGroup takes group g, real x, real y returns unit
	local group g2=GetAvailableGroup()
	local real dist=99999
	local unit u
	local unit closest=null
	local real r=0.
	call GroupAddGroup(g,g2)
	loop
		set u=FirstOfGroup(g2)
		exitwhen u==null
		set r=DistanceBetweenXY(GetUnitX(u),GetUnitY(u),x,y)
		if r < dist then
			set closest=u
			set dist=r
		endif
		call GroupRemoveUnit(g2,u)
	endloop
	set tt_unit1=closest
	call KillGroup(g2)
	set u=null
	set closest=null
	set g2=null
	return tt_unit1
endfunction

function UG8 takes string s returns nothing
	if GameEnded==false and ZN7==false then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,120,"|c00ff0303An internal checksum has failed|r")
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,120,"|c00ff0303This might not be a serious glitch, but it is important for me to get it|r")
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,120,"|c00ff0303Error code: "+s+"|r")
		set ZN7=true
	endif
endfunction

function CleanTrigger takes trigger t returns nothing
	call DisableTrigger(t)
	set IJ=IJ+1
	set QY[IJ]=t
	set UY[IJ]=(TimerGetElapsed(GlobalTimer))+60
	if IJ>8000 then
		call UG8("8k")
	endif
endfunction

function UI8 takes integer i returns nothing
	if i!=IJ then
		set QY[i]=QY[IJ]
		set UY[i]=UY[IJ]
	endif
	set QY[IJ]=null
	set UY[IJ]=0
	set IJ=IJ-1
endfunction

function UJ8 takes nothing returns boolean
	local real UK8=(TimerGetElapsed(GlobalTimer))
	local integer i
	set i=1
	loop
		exitwhen i>IJ
		if UY[i]<UK8 then
			if QY[i]==null or IsTriggerEnabled(QY[i]) then
				if QY[i]==null then
					call UG8("nil")
				else
					call UG8(I2S(GetHandleId(QY[i])))
				endif
			else
				call DestroyTrigger(QY[i])
			endif
			call UI8(i)
		else
			set i=i+1
		endif
	endloop
	return false
endfunction

function UM8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	call SaveInteger(HY,GetHandleId(LoadTriggerHandle(HY,h,35)),LoadInteger(HY,h,33),2)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	return false
endfunction

function AddTimedKeyForTrigger takes trigger t,integer UP8,real SB8 returns nothing
	local trigger t2=CreateTrigger()
	call TriggerAddCondition(t2,Condition(function UM8))
	call TriggerRegisterTimerEvent(t2,SB8,false)
	call SaveInteger(HY,GetHandleId(t),UP8,1)
	call SaveTriggerHandle(HY,GetHandleId(t2),35,t)
	call SaveInteger(HY,GetHandleId(t2),33,UP8)
	set t2=null
endfunction

function UQ8 takes unit u returns string
	if u==null then
		return GetObjectName('n09T')//n09T -> No Hero
	endif
	return GetObjectName(HeroID[GetUnitPointValue(u)])
endfunction

function UR8 takes integer i returns string
	if i==0 then
		return GetObjectName('n09T')//n09T -> No Hero
	endif
	return GetObjectName(HeroID[i])
endfunction

function US8 takes unit u returns string
	if u==null then
		return EmptySlotPath
	endif
	return HeroIcon[LoadInteger(HY,GetPlayerId(GetOwningPlayer(u)),'hHid')]
endfunction

function UT8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	call SaveInteger(HY,GetHandleId(LoadUnitHandle(HY,h,14)),LoadInteger(HY,h,33),2)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	return false
endfunction

function AddTimedKeyToUnit takes unit UV8,integer UP8,real SB8 returns nothing
	local trigger t=CreateTrigger()
	call TriggerAddCondition(t,Condition(function UT8))
	call TriggerRegisterTimerEvent(t,SB8,false)
	call SaveInteger(HY,GetHandleId(UV8),UP8,1)
	call SaveUnitHandle(HY,GetHandleId(t),14,UV8)
	call SaveInteger(HY,GetHandleId(t),33,UP8)
	set t=null
endfunction

function AddTimedValueToUnitEnd takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local integer hu=LoadInteger(HY,h,1)
	local integer key=LoadInteger(HY,h,0)
	call RemoveSavedHandle(HY,hu,key)
	call RemoveSavedInteger(HY,hu,key)
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function AddTimedValueToUnit takes unit u,integer key, integer val,real dur returns nothing
	local timer t
	local integer h
	local integer hu=GetHandleId(u)
	if HaveSavedHandle(HY,hu,key) then
		set t=LoadTimerHandle(HY,hu,key)
		set h=GetHandleId(t)
	else
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveInteger(HY,h,0,key)
		call SaveInteger(HY,h,1,hu)
		call SaveInteger(HY,hu,key,val)
		call SaveTimerHandle(HY,hu,key,t)
	endif
	call TimerStart(t,dur,false,function AddTimedValueToUnitEnd)
	set t=null
endfunction

function AddEffectTargetTimed_clean takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call DestroyEffect(LoadEffectHandle(HY,h,1))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function AddEffectTargetTimed takes string path, unit u, string where, real dur returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local effect e=AddSpecialEffectTarget(path,u,where)
	call TimerStart(t,dur,false,function AddEffectTargetTimed_clean)
	call SaveEffectHandle(HY,h,1,e)
	set e=null
	set t=null
endfunction

function AddEffectPointTimed_clean takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call DestroyEffect(LoadEffectHandle(HY,h,1))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function AddEffectPointTimed takes string path, real x, real y, real dur returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local effect e=AddSpecialEffect(path,x,y)
	call TimerStart(t,dur,false,function AddEffectPointTimed_clean)
	call SaveEffectHandle(HY,h,1,e)
	set e=null
	set t=null
endfunction

function GetUnitPrimaryAttribute takes unit Hero returns integer
	//1 == int
	//2 == agi
	//3 == str
	local integer x
	local integer id=GetUnitTypeId(Hero)
	if IsUnitType(Hero,UNIT_TYPE_HERO)==false then
		return 0
	endif
	if HeroTypeId[GetPlayerId(GetOwningPlayer(Hero))]!=id then
		set id=HeroTypeId[GetPlayerId(GetOwningPlayer(Hero))]
	endif
	set x=1
	loop
		exitwhen x>AgilityHeroesAmount
		if id==AgiHeroesArray[x]then
			return 2
		endif
		set x=x+1
	endloop
	set x=1
	loop
		exitwhen x>StrHeroesAmount
		if id==StrHeroesArray[x]then
			return 3
		endif
		set x=x+1
	endloop
	set x=1
	loop
		exitwhen x>IntHeroesAmount
		if id==IntHeroesArray[x]then
			return 1
		endif
		set x=x+1
	endloop
	if id=='Eevm' or id=='E02V' or id=='E02W' or id=='E02U' or id=='N02B' or id=='N017' or id=='H08D' or id=='H08C' or id=='H084' or id=='H08B' or id=='N013' or id=='N014' or id=='N015' or id=='E02O' or id=='QTW2' or id=='QTW3' then//Eevm -> Soul Keeper, E02V -> Soul Keeper, E02W -> Soul Keeper, E02U -> Soul Keeper, N02B -> Troll Warlord, N017 -> Troll Warlord, H08D -> Gorgon, H08C -> Gorgon, H084 -> Gorgon, H08B -> Gorgon, N013 -> Lone Druid, N014 -> Lone Druid, N015 -> Lone Druid, E02O -> Gyrocopter, QTW2 -> Troll Warlord, QTW3 -> Troll Warlord
		return 2
	endif
	if id=='N01H' or id=='N01T' or id=='N01J' or id=='H600' or id=='H601' or id=='H602' or id=='H00E' or id=='H00G' or id=='H00F' or id=='H07I' or id=='E015' or id=='H0CQ' or id=='H0E3' or id=='H0E4' or id=='H0E5' or id=='U01X' or id=='N0MB' or id=='N0MC' or id=='N0MO' or id=='N0MA'then//N01H -> Alchemist, N01T -> Alchemist, N01J -> Alchemist, H600 -> Alchemist, H601 -> Alchemist, H602 -> Alchemist, H00E -> Dragon Knight, H00G -> Dragon Knight, H00F -> Dragon Knight, H07I -> Flesh Golem, E015 -> Lycanthrope, H0CQ -> Rogue Knight, H0E3 -> Mortar Team, H0E4 -> Mortar Team, H0E5 -> Mortar Team, U01X -> Stone Giant, N0MB -> Winter Wyvern, N0MC -> Winter Wyvern, N0MO -> Winter Wyvern, N0MA -> Winter Wyvern
		return 3
	endif
	if id=='H06X' or id=='H06Y' or id=='H06W' or id=='H0BC' or id=='O017' or id=='N0M7' or id=='N0MA' or id=='N0MB' or id=='N0MC' or id=='N0MO' then//H06X -> Keeper of the Light, H06Y -> Keeper of the Light 2, H06W -> Keeper of the Light 3, H0BC -> Keeper of the Light, O017 -> Batrider, N0M7 -> Winter Wyvern, N0MA -> Winter Wyvern, N0MB -> Winter Wyvern, N0MC -> Winter Wyvern, N0MO -> Winter Wyvern
		return 1
	endif
	return 0
endfunction

function GetHeroHighestStatValue takes unit u returns integer
	local integer int=GetHeroInt(u,true)
	local integer agi=GetHeroAgi(u,true)
	local integer str=GetHeroStr(u,true)
	return IMaxIF(IMaxIF(str,int),agi)
endfunction

function GetHeroMainStatValue takes unit u returns integer
	local integer i=GetUnitPrimaryAttribute(u)
	if i==1 then
		return GetHeroInt(u,true)
	endif
	if i==2 then
		return GetHeroAgi(u,true)
	endif
	if i==3 then
		return GetHeroStr(u,true)
	endif
	return 0
endfunction

function UA8 takes unit whichUnit returns boolean
	return GetWidgetLife(whichUnit)<1 or IsHeroDead[GetPlayerId(GetOwningPlayer(whichUnit))]
endfunction

function SaveUnitModelScale takes integer U38,real U68,integer UL8 returns nothing
	set DJ=DJ+1
	set AJ[DJ]=U68
	set BJ[DJ]=U38
	set CJ[DJ]=UL8
endfunction

function U18 takes unit u returns real
	local integer U38=GetUnitTypeId(u)
	local integer i=1
	loop
		exitwhen i>DJ
		if BJ[i]==U38 or CJ[i]==U38 then
			return AJ[i]
		endif
		set i=i+1
	endloop
	return 1.
endfunction

function SaveUnitWinAnimation takes integer U58,string U28 returns nothing
	set GJ=GJ+1
	set EJ[GJ]=U28
	set FJ[GJ]=U58
endfunction

function V48 takes unit u returns string
	local integer U58=GetUnitTypeId(u)
	local integer i=1
	loop
		exitwhen i>GJ
		if FJ[i]==U58 then
			return EJ[i]
		endif
		set i=i+1
	endloop
	return"stand"
endfunction

function V78 takes unit u returns nothing
	if GetUnitTypeId(u)=='N01I' then//N01I -> Alchemist
		call SetUnitAnimationByIndex(u,6)
	else
		call SetUnitAnimation(u,V48(u))
	endif
endfunction

function IsSentinel takes player p returns boolean
	return(p==Sentinels[0])or(p==Sentinels[1])or(p==Sentinels[2])or(p==Sentinels[3])or(p==Sentinels[4])or(p==Sentinels[5])
endfunction

function IsScourge takes player p returns boolean
	return(p==Scourges[0])or(p==Scourges[1])or(p==Scourges[2])or(p==Scourges[3])or(p==Scourges[4])or(p==Scourges[5])
endfunction

function IsPlayerBelongToTeams takes player p returns boolean
	return p==Sentinels[1]or p==Sentinels[2]or p==Sentinels[3]or p==Sentinels[4]or p==Sentinels[5]or p==Scourges[1]or p==Scourges[2]or p==Scourges[3]or p==Scourges[4]or p==Scourges[5]
endfunction

function IsPlayerExisted takes player p returns boolean
	return ((GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING or GetPlayerSlotState(p)==PLAYER_SLOT_STATE_LEFT) and GetPlayerController(p)==MAP_CONTROL_USER) or (Mode_Debug and p!=Sentinels[0] and p!=Scourges[0])
endfunction

function IsPlayerLeaver takes player p returns boolean
	return GetPlayerSlotState(p)==PLAYER_SLOT_STATE_LEFT and GetPlayerController(p)==MAP_CONTROL_USER
endfunction

function CountPlayersInForceSub takes nothing returns nothing
	if(IsPlayer(GetEnumPlayer()))then
		set bj_forceCountPlayers=bj_forceCountPlayers+1
	endif
endfunction

function CountPlayersInForce takes force f returns integer
	set bj_forceCountPlayers=0
	call ForForce(f,function CountPlayersInForceSub)
	return bj_forceCountPlayers
endfunction

function VN8 takes nothing returns nothing
	if GetPlayerSlotState(GetEnumPlayer())==PLAYER_SLOT_STATE_PLAYING then
		if GetEnumPlayer()!=Player(13)and GetEnumPlayer()!=Player(14)then
			set bj_forceCountPlayers=bj_forceCountPlayers+1
		endif
	endif
endfunction

function VO8 takes force f returns integer
	set bj_forceCountPlayers=0
	call ForForce(f,function VN8)
	return bj_forceCountPlayers
endfunction


function Id2S takes integer value returns string
	local string charMap = ".................................!.#$%&'()*+,-./0123456789:;<=>.@ABCDEFGHIJKLMNOPQRSTUVWXYZ[.]^_`abcdefghijklmnopqrstuvwxyz{|}~................................................................................................................................."
	local string result = ""
	local integer remainingValue = value
	local integer charValue
	local integer byteno

	set byteno = 0
	loop
		set charValue = ModuloInteger(remainingValue, 256)
		set remainingValue = remainingValue / 256
		set result = SubString(charMap, charValue, charValue + 1) + result

		set byteno = byteno + 1
		exitwhen byteno == 4
	endloop
	return result
endfunction

function RemoveHeroFromTavernForPlayer takes integer hid,player p returns nothing
	if NoHeroLimitOff then
		call SetPlayerTechMaxAllowed(p,hid,0)
		set b_isHeroPicked[GetUnitPointValueByType(hid)]=true
	endif
endfunction

function TechHeroForAll takes integer hid returns nothing
	call RemoveHeroFromTavernForPlayer(hid,Sentinels[1])
	call RemoveHeroFromTavernForPlayer(hid,Sentinels[2])
	call RemoveHeroFromTavernForPlayer(hid,Sentinels[3])
	call RemoveHeroFromTavernForPlayer(hid,Sentinels[4])
	call RemoveHeroFromTavernForPlayer(hid,Sentinels[5])
	call RemoveHeroFromTavernForPlayer(hid,Scourges[1])
	call RemoveHeroFromTavernForPlayer(hid,Scourges[2])
	call RemoveHeroFromTavernForPlayer(hid,Scourges[3])
	call RemoveHeroFromTavernForPlayer(hid,Scourges[4])
	call RemoveHeroFromTavernForPlayer(hid,Scourges[5])
endfunction

function VR8 takes integer hid returns nothing
	if NoHeroLimitOff then
		call SetPlayerTechMaxAllowed(Sentinels[1],hid,0)
		call SetPlayerTechMaxAllowed(Sentinels[2],hid,0)
		call SetPlayerTechMaxAllowed(Sentinels[3],hid,0)
		call SetPlayerTechMaxAllowed(Sentinels[4],hid,0)
		call SetPlayerTechMaxAllowed(Sentinels[5],hid,0)
		call SetPlayerTechMaxAllowed(Scourges[1],hid,0)
		call SetPlayerTechMaxAllowed(Scourges[2],hid,0)
		call SetPlayerTechMaxAllowed(Scourges[3],hid,0)
		call SetPlayerTechMaxAllowed(Scourges[4],hid,0)
		call SetPlayerTechMaxAllowed(Scourges[5],hid,0)
	endif
endfunction

function VS8 takes player p returns nothing
	local integer i=FirstSentinelHeroIndexid
	local integer k=LastSentinelHeroIndexid
	if NoHeroLimitOff then
		loop
			exitwhen i>k
			call SetPlayerTechMaxAllowed(p,HeroID[i],0)
			set i=i+1
		endloop
		set i=FirstScourgeHeroIndexid
		set k=LastScourgeHeroIndexid
		loop
			exitwhen i>k
			call SetPlayerTechMaxAllowed(p,HeroID[i],0)
			set i=i+1
		endloop
	endif
endfunction

function TechAll takes nothing returns nothing
	call VS8(Sentinels[1])
	call VS8(Sentinels[2])
	call VS8(Sentinels[3])
	call VS8(Sentinels[4])
	call VS8(Sentinels[5])
	call VS8(Scourges[1])
	call VS8(Scourges[2])
	call VS8(Scourges[3])
	call VS8(Scourges[4])
	call VS8(Scourges[5])
endfunction

function FillTaverns takes player p returns nothing
	local integer i=FirstSentinelHeroIndexid
	local integer k=LastSentinelHeroIndexid
	if NoHeroLimitOff then
		loop
			exitwhen i>k
			call SetPlayerTechMaxAllowed(p,HeroID[i],999)
			set i=i+1
		endloop
		set i=FirstScourgeHeroIndexid
		set k=LastScourgeHeroIndexid
		loop
			exitwhen i>k
			call SetPlayerTechMaxAllowed(p,HeroID[i],999)
			set i=i+1
		endloop
	endif
endfunction

function UnTechAll takes nothing returns nothing
	call FillTaverns(Sentinels[1])
	call FillTaverns(Sentinels[2])
	call FillTaverns(Sentinels[3])
	call FillTaverns(Sentinels[4])
	call FillTaverns(Sentinels[5])
	call FillTaverns(Scourges[1])
	call FillTaverns(Scourges[2])
	call FillTaverns(Scourges[3])
	call FillTaverns(Scourges[4])
	call FillTaverns(Scourges[5])
endfunction

function VX8 takes nothing returns nothing
	local integer i
	local integer k
	local integer a=0
	//set ZO=FirstSentinelHeroIndexid
	set i=FirstSentinelHeroIndexid
	set k=LastSentinelHeroIndexid
	loop
		exitwhen i>k
		set a=a+1
		set WO[a]=i
		set i=i+1
	endloop
	set i=FirstScourgeHeroIndexid
	set k=LastScourgeHeroIndexid
	loop
		exitwhen i>k
		set a=a+1
		set WO[a]=i
		set i=i+1
	endloop
	set VO=a
endfunction

function GetSetElement takes nothing returns integer
	local integer VA8=GetRandomInt(FirstSentinelHeroIndexid,VO)
	local integer VB8=WO[VA8]
	set VB8=WO[VA8]
	if(FirstSentinelHeroIndexid==VO)then
		set WO[VA8]=0
		return VB8
	endif
	if(VA8==VO)then
		set VO=VO-1
		return VB8
	endif
	set WO[VA8]=WO[VO]
	set VO=VO-1
	return VB8
endfunction

function IsUnitSilenced takes unit u returns boolean
	return GetUnitAbilityLevel(u,'B01T')>0 or GetUnitAbilityLevel(u,'BNsi')>0 or GetUnitAbilityLevel(u,'B01X')>0 or GetUnitAbilityLevel(u,'BNdo')>0 or GetUnitAbilityLevel(u,'B02M')>0 or GetUnitAbilityLevel(u,'Bhea')>0 or GetUnitAbilityLevel(u,'B07V')>0 or GetUnitAbilityLevel(u,'B0BY')>0 or GetUnitAbilityLevel(u,'B08O')>0 or GetUnitAbilityLevel(u,'B07U')>0 or GetUnitAbilityLevel(u,'B0DL')>0 or GetUnitAbilityLevel(u,'B08V')>0 or GetUnitAbilityLevel(u,'B031')>0 or GetUnitAbilityLevel(u,'B0FT')>0 or GetUnitAbilityLevel(u,'B0FG')>0 or GetUnitAbilityLevel(u,'B450')>0 or GetUnitAbilityLevel(u,'B463')>0//B01T -> Silencer, BNsi -> Silence, B01X -> Bloodrage, BNdo -> Doom, B02M -> Crippling Fear, Bhea -> Smoke Screen, B07V -> Silence, B0BY -> Infestation, B08O -> Silence, B07U -> Silence, B0DL -> Static Storm, B08V -> Black Hole, B031 -> Orchid Malevolence, B0FT -> Ancient Seal, B0FG -> Duel, B450 -> Blood Rite, B463 -> Sealed
endfunction

function IsRangedUnitHasOverAS takes unit u returns boolean
	return IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false and (GetUnitAbilityLevel(u,'A1N3')>0 or GetUnitAbilityLevel(u,'A12Q')==1 or LoDStat_Get(u,"attack")>200)//A1N3 -> Overpower, A12Q -> Focus Fire AS
endfunction

function V38 takes string s returns integer
	if s=="a"then
		return 10
	elseif s=="b"then
		return 11
	elseif s=="c"then
		return 12
	elseif s=="d"then
		return 13
	elseif s=="e"then
		return 14
	elseif s=="f"then
		return 15
	else
		return S2I(s)
	endif
endfunction

function VL8 takes string s returns integer
	return V38(SubString(s,0,1))*16+V38(SubString(s,1,2))
endfunction

function isAintItemAbility takes integer aid returns boolean
	local integer i=1
	loop
		exitwhen i>ItemsAbilitiesMax2
		if aid==ItemsAbilities2[i]then
			return false
		endif
		set i=i+1
	endloop
	return true
endfunction

function GetTowerLevel takes unit W48 returns integer
	local integer W78=GetUnitTypeId(W48)
	if W78=='e00R' or W78=='u00M' then//e00R -> Ancient Protector - level 1, u00M -> Spirit Tower - level 1
		return 1
	elseif W78=='e011' or W78=='u00D' then//e011 -> Ancient Protector - level 2, u00D -> Spirit Tower - level 2
		return 2
	elseif W78=='e00S' or W78=='u00N' then//e00S -> Ancient Protector - level 3, u00N -> Spirit Tower - level 3
		return 3
	elseif W78=='e019' or W78=='u00T' then//e019 -> Ancient Protector - level 4, u00T -> Spirit Tower - level 4
		return 4
	endif
	return 0
endfunction

function IsPoisonArrowSkill takes integer id returns boolean
	return id=='A0DY' or id=='A1WB' or id=='A026' or id=='A09V' or id=='AHfa' or id=='A0LZ' or id=='A0OI'//A0DY -> Impetus, A1WB -> Impetus, A026 -> Frost Arrows, A09V -> Poison Attack, AHfa -> Searing Arrows, A0LZ -> Glaives of Wisdom, A0OI -> Arcane Orb
endfunction

function IsDisjointSpell takes integer id returns boolean
	return id=='A0ME' or id=='AEbl'  or id=='AIbk' or id=='QB08' or id=='A3FJ' or id=='A01O' or id=='A0FN' or id=='A14O'//A0ME -> Blink QoP, AEbl -> Blink, AIbk -> Blink (Item Version), QB08 -> Blink, A01O -> Teleportation, A0FN -> Waveform, QB07 -> Blink QoP, A14O -> Ball Lightning
endfunction

function TextTagWithGold takes player whichPlayer,integer gold returns nothing
	local texttag t
	if gold>0 then
		set gold=AddGold(whichPlayer,gold)
		set t=CreateTextTag()
		call SetTextTagText(t,"+"+I2S(gold),.025)
		call SetTextTagPosUnit(t,udg_Hero[GetPlayerId(whichPlayer)],0)
		call SetTextTagColor(t,255,220,0,255)
		call SetTextTagVelocity(t,0,.03)
		call SetTextTagVisibility(t,GetLocalPlayer()==whichPlayer)
		call SetTextTagFadepoint(t,2)
		call SetTextTagLifespan(t,3)
		call SetTextTagPermanent(t,false)
		set t=null
	endif
endfunction

function GoldForKillingEnemyStructures takes player p, integer gold returns nothing
	call TextTagWithGold(p,gold)
	set ReliableGold[GetPlayerId(p)]=ReliableGold[GetPlayerId(p)]+gold
endfunction

function GoldForKillingEnemyStructuresWrap takes integer team, integer gold returns nothing
	if team==0 then
		call GoldForKillingEnemyStructures(Sentinels[1],gold)
		call GoldForKillingEnemyStructures(Sentinels[2],gold)
		call GoldForKillingEnemyStructures(Sentinels[3],gold)
		call GoldForKillingEnemyStructures(Sentinels[4],gold)
		call GoldForKillingEnemyStructures(Sentinels[5],gold)
	else
		call GoldForKillingEnemyStructures(Scourges[1],gold)
		call GoldForKillingEnemyStructures(Scourges[2],gold)
		call GoldForKillingEnemyStructures(Scourges[3],gold)
		call GoldForKillingEnemyStructures(Scourges[4],gold)
		call GoldForKillingEnemyStructures(Scourges[5],gold)
	endif
endfunction

function RaxKill takes unit u,boolean ranged returns nothing//barracks killed
	local integer gold
	if ranged then
		set gold=225
	else
		set gold=275
	endif
	if IsUnitAlly(GetDyingUnit(),GetOwningPlayer(u))then
		set gold=gold/2
	endif
	if GetOwningPlayer(GetDyingUnit())==Scourges[0]then
		call GoldForKillingEnemyStructuresWrap(0,gold)
	else
		call GoldForKillingEnemyStructuresWrap(1,gold)
	endif
endfunction

function TowerKill takes unit whichUnit,integer Level returns nothing
	local integer gold
	set gold=120+40*Level
	call UnitAddAbility(GetDyingUnit(),'A3C9')
	if IsUnitAlly(GetDyingUnit(),GetOwningPlayer(whichUnit))then
		set gold=gold/2
	endif
	if GetOwningPlayer(GetDyingUnit())==Scourges[0]then
		call GoldForKillingEnemyStructuresWrap(0,gold)
	else
		call GoldForKillingEnemyStructuresWrap(1,gold)
	endif
endfunction

function GetRandomHeroByAttr takes player p, integer at returns nothing
	local integer i
	local integer k
	local location spawnLoc
	local integer rnd
	local integer pid=GetPlayerId(p)
	local boolean int=at==1
	local boolean agi=at==2
	local boolean str=at==3
	set HasUsedRandom[pid]=true
	if IsSentinel(p) then
		set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_NE)
	else
		set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_UD)
	endif
	loop
		if int then
			set rnd=GetHeroIndexFromId(IntHeroesArray[GetRandomInt(1,IntHeroesAmount)])
		elseif agi then
			set rnd=GetHeroIndexFromId(AgiHeroesArray[GetRandomInt(1,AgilityHeroesAmount)])
		elseif str then
			set rnd=GetHeroIndexFromId(StrHeroesArray[GetRandomInt(1,StrHeroesAmount)])
		endif
		exitwhen IsHeroIngame[rnd]==false and (MeleeOrRangedRestricted[pid]==0 or (IsUnitIdType(HeroID[rnd],UNIT_TYPE_RANGED_ATTACKER) and MeleeOrRangedRestricted[pid]==2) or (IsUnitIdType(HeroID[rnd],UNIT_TYPE_MELEE_ATTACKER) and MeleeOrRangedRestricted[pid]==1))
	endloop
	if Mode_DU==false then
		call VR8(HeroID[rnd])
		set b_isHeroPicked[rnd]=true
		set IsHeroIngame[rnd]=true
	endif
	call CreateUnitAtLoc(p,HeroID[rnd],spawnLoc,0)
	call RemoveLocation(spawnLoc)
	set spawnLoc=null
endfunction

function GetRandomHeroByAttack takes player p, integer class returns nothing
	local integer i
	local integer k
	local location spawnLoc
	local integer rnd=0
	local integer j=0
	
	set HasUsedRandom[GetPlayerId(p)]=true
	if IsSentinel(p) then
		set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_NE)
	else
		set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_UD)
	endif
	loop
		if class==1 then//melee
			set rnd=GetHeroIndexFromId(MeleeHeroesArray[GetRandomInt(1,MeleeHeroesAmount)])
		elseif class==2 then//range
			set rnd=GetHeroIndexFromId(RangeHeroesArray[GetRandomInt(1,RangeHeroesAmount)])
		endif
		exitwhen IsHeroIngame[rnd]==false or j>400
		set j=j+1
	endloop
	if j>400 and IsHeroIngame[rnd] then
		if class==1 then
			call DisplayTimedTextToPlayer(p,0,0,10,"No melee heroes left.")
		elseif class==2 then
			call DisplayTimedTextToPlayer(p,0,0,10,"No range heroes left.")
		endif
		call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)+150)
		set HasUsedRandom[GetPlayerId(p)]=false
	else
		if Mode_DU==false then
			call VR8(HeroID[rnd])
			set b_isHeroPicked[rnd]=true
			set IsHeroIngame[rnd]=true
		endif
		call CreateUnitAtLoc(p,HeroID[rnd],spawnLoc,0)
	endif
	call RemoveLocation(spawnLoc)
	set spawnLoc=null
endfunction

function WT8 takes player p returns nothing
	local integer i
	local integer k
	local location spawnLoc
	local integer rnd
	local integer pid=GetPlayerId(p)
	set HasUsedRandom[GetPlayerId(p)]=true
	if IsSentinel(p) then
		set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_NE)
	else
		set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_UD)
	endif
	loop
		set rnd=GetRandomInt(FirstSentinelHeroIndexid,LastScourgeHeroIndexid)
		exitwhen IsHeroIngame[rnd]==false and (MeleeOrRangedRestricted[pid]==0 or (IsUnitIdType(HeroID[rnd],UNIT_TYPE_RANGED_ATTACKER) and MeleeOrRangedRestricted[pid]==2) or (IsUnitIdType(HeroID[rnd],UNIT_TYPE_MELEE_ATTACKER) and MeleeOrRangedRestricted[pid]==1))
	endloop
	if Mode_DU==false then
		call VR8(HeroID[rnd])
		set b_isHeroPicked[rnd]=true
		set IsHeroIngame[rnd]=true
	endif
	call CreateUnitAtLoc(p,HeroID[rnd],spawnLoc,0)
	call RemoveLocation(spawnLoc)
	set spawnLoc=null
endfunction

function InitProPlayers takes nothing returns nothing
	call SaveBoolean(ProPlayersList,0,-107681000,true)
	call SaveBoolean(ProPlayersList,0,-1526589116,true)
endfunction

function IsProPlayer takes player p returns boolean
	return LoadBoolean(ProPlayersList,0,PlayerNamesHashes[GetPlayerId(p)])
endfunction

function IsValidTree takes destructable d returns boolean
	return GetDestructableTypeId(d)=='CTtr' or GetDestructableTypeId(d)=='NTtc' or GetDestructableTypeId(d)=='NTtw' or GetDestructableTypeId(d)=='ATtr' or GetDestructableTypeId(d)=='B002' or GetDestructableTypeId(d)=='B003' or GetDestructableTypeId(d)=='B005' or GetDestructableTypeId(d)=='ITtw' or GetDestructableTypeId(d)=='CTtr'//B003 -> Haste, B005 -> Haste
endfunction

function IsMagicImmune takes unit u returns boolean
	return IsUnitType(u,UNIT_TYPE_MAGIC_IMMUNE) or LoadInteger(HY,GetHandleId(u),4252)==1//A0S6 -> Spell Immunity, A179 -> Spell Immunity, ACmi -> Spell Immunity, A0SU -> Spell Immunity, B014 -> Repel, A0H3 -> Necronomicon Spell Immunityor GetUnitAbilityLevel(u,'A0S6')>0 or GetUnitAbilityLevel(u,'A179')>0 or GetUnitAbilityLevel(u,'ACmi')>0 or GetUnitAbilityLevel(u,'A0SU')>0 or GetUnitAbilityLevel(u,'B014')>0 or GetUnitAbilityLevel(u,'A0H3')>0 
endfunction

function IsUnitHPFreezed takes unit u returns boolean
	return HaveSavedHandle(HY,GetHandleId(u),'FRZH')
endfunction

function WC8 takes unit W38 returns boolean
	return GetUnitAbilityLevel(W38,'A04R')>0 and IsPlayerBelongToTeams(GetOwningPlayer(W38))//
endfunction

function IsBuggyFlying takes unit u returns boolean
	local integer i=GetUnitTypeId(u)
	return i=='H00F' or i=='H00E' or i=='H00G' or i=='O017' or i=='N0MA' or i=='N0MB' or i=='N0MC' or i=='N0MO'//H00F -> Dragon Knight, H00E -> Dragon Knight, H00G -> Dragon Knight, O017 -> Batrider, N0MA -> Winter Wyvern, N0MB -> Winter Wyvern, N0MC -> Winter Wyvern, N0MO -> Winter Wyvern, N0M7 -> Winter Wyvern
endfunction

function IsDamageReal takes real d returns boolean
	return 2<d and d<3000
endfunction

function W18 takes nothing returns nothing
	local integer VT8=1
	set PlayerModeTyper=Sentinels[1]
	loop
		exitwhen IsPlayer(PlayerModeTyper)or VT8>5
		set VT8=VT8+1
		set PlayerModeTyper=Sentinels[VT8]
	endloop
	if IsPlayer(PlayerModeTyper)==false then
		set PlayerModeTyper=Scourges[1]
		set VT8=1
		loop
			exitwhen IsPlayer(PlayerModeTyper)or VT8>5
			set VT8=VT8+1
			set PlayerModeTyper=Scourges[VT8]
		endloop
	endif
endfunction

function IsRealHero takes unit Hero returns boolean
	return IsUnitType(Hero,UNIT_TYPE_HERO) and IsUnitIllusion(Hero)==false and GetUnitTypeId(Hero)!='H00M' and GetUnitTypeId(Hero)!='H00Y' and GetUnitTypeId(Hero)!='H07G' and GetUnitTypeId(Hero)!='H0B8' and GetUnitTypeId(udg_Hero[GetPlayerId(GetOwningPlayer(Hero))])!=GetUnitTypeId(Hero)//H00M -> Bloodrune, H00Y -> Preloader Hero, H07G -> Storm Spirit unused, H0B8 -> Ice Blast
endfunction

function W28 takes integer U38 returns integer
	local integer i=1
	loop
		exitwhen i>LastScourgeHeroIndexid
		if U38==HeroID[i]then
			return i
		endif
		set i=i+1
	endloop
	return 0
endfunction

function IsDayTime takes nothing returns boolean
	return GetTimeOfDay()>6. and GetTimeOfDay()<18.
endfunction

function RemoveAbilsForUnit takes unit u returns nothing
	local integer i=1
	local integer lvl
	loop
		set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[i])
		if lvl==0 then
			call UnitRemoveAbility(u,PassivesRealID[i])
			call UnitRemoveAbility(u,PassivesSpellbookID[i])
			call UnitRemoveAbility(u,PassivesBuffID[i])
			call UnitRemoveAbility(u,PassivesLearningSkillUpg[i])
		endif
		set i=i+1
		exitwhen i>PassivesCount
	endloop
endfunction

function RemoveAbilsConst takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer i=1
	local integer lvl
//	call echo("fired")
	if IsDead(u)==false then
		loop
			set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[i])
			if lvl==0 and (GetUnitAbilityLevel(u,PassivesRealID[i])>0 or GetUnitAbilityLevel(u,PassivesSpellbookID[i])>0 or GetUnitAbilityLevel(u,PassivesBuffID[i])>0) then
				call UnitRemoveAbility(u,PassivesRealID[i])
				call UnitRemoveAbility(u,PassivesSpellbookID[i])
				call UnitRemoveAbility(u,PassivesBuffID[i])
				call UnitRemoveAbility(u,PassivesLearningSkillUpg[i])
			endif
			set i=i+1
			exitwhen i>PassivesCount
		endloop
	endif
	if LoadBoolean(HY,h,0) or GetTriggerEvalCount(t)>125 or (GetTriggerEvalCount(t)>30 and isMorphedUnit(u)!=LoadBoolean(HY,h,3)) then
		//call echo(I2S(GetTriggerEvalCount(t)))
		if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) then
			if GetUnitAbilityLevel(u,'A1WE')>0 then//ranged manta
				call UnitRemoveAbility(u,'A3FH')
			endif
			if GetUnitAbilityLevel(u,'A1WE')>0 then//ranged manta
				call UnitAddAbility2(u,'A3FH')
				call HideAbility('A3FH')
			endif
		else
			if GetUnitAbilityLevel(u,'A0B8')>0 then//melee manta
				call UnitRemoveAbility(u,'A3FI')
			endif
			if GetUnitAbilityLevel(u,'A0B8')>0 then//melee manta
				call UnitAddAbility2(u,'A3FI')
				call HideAbility('A3FI')
			endif
		endif
		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)
		call TriggerEvaluate(MeleeRangeItemsSwitcher)
		set tt_unit1=u
		call ExecuteFunc("RikiResetInvisOnMorph")
	endif
	set TEMPUNIT=u
	set t=null
	set u=null
endfunction

function IsMorphSkillId takes integer id returns boolean
	return id=='A0AG' or id=='QM01' or id=='A0BE' or id=='QM00' or id=='QB0K' or id=='ANcr' or id=='QB0L' or id=='A2H0' or id=='QM02' or id=='QM03' or id=='QM04' or id=='A1RI' or id=='A332' or id=='A2M0' or id=='A2H1'
	//A0AG -> True Form, QM01 -> Spirit Form, A0BE -> Berserker Rage, QM00 -> Elder Dragon Form, QB0K -> Chemical Rage, ANcr -> Chemical Rage, QB0L -> Sleight of Fist, A2H0 -> Sleight of Fist, QM02 -> Shapeshift, QM03 -> Flesh Golem, QM04 -> Firefly, A1RI -> Metamorphosis, A332 -> Arctic Burn, A2M0 -> Tempest Double, A2H1 -> Slight of Fist In
endfunction

function Wait0SecPlz takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local trigger tt
	local integer hh
	local integer id=GetSpellAbilityId()
	if IsMorphSkillId(id) then
		set tt=CreateTrigger()
		set hh=GetHandleId(tt)
		call SaveUnitHandle(HY,hh,0,LoadUnitHandle(HY,h,0))
		call SaveInteger(HY,hh,0,id)
		call SaveBoolean(HY,hh,3,isMorphedUnit(LoadUnitHandle(HY,h,0)))
		call TriggerRegisterTimerEvent(tt,0.02,GetTriggerEventId()!=EVENT_UNIT_SPELL_ENDCAST)
		call TriggerAddCondition(tt,Condition(function RemoveAbilsConst))
		call SaveBoolean(HY,hh,0,GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST)
		set tt=null
	endif
	set t=null
endfunction

function GetMorphId takes integer UnitID returns integer
	local integer id=W28(UnitID)
	local string MorphString=I2S(2*id-2)
	local integer l=StringLength(MorphString)
	if UnitID=='N01H' or UnitID=='H600' then//N01H -> Alchemist, H600 -> Alchemist
		return 'M500'
	elseif UnitID=='N01T' or UnitID=='H601' then//N01T -> Alchemist, H601 -> Alchemist
		return 'M502'
	elseif UnitID=='N01J' or UnitID=='H602' then//N01J -> Alchemist, H602 -> Alchemist
		return 'M504'
	elseif UnitID=='H00F' then//H00F -> Dragon Knight
		return 'M506'
	elseif UnitID=='H00E' then//H00E -> Dragon Knight
		return 'M508'
	elseif UnitID=='H00G' then//H00G -> Dragon Knight
		return 'M510'
	elseif UnitID=='O017' then//O017 -> Batrider
		return 'M512'
	elseif UnitID=='H06X' then//H06X -> Keeper of the Light
		return 'M514'
	elseif UnitID=='H06Y' then//H06Y -> Keeper of the Light 2
		return 'M516'
	elseif UnitID=='H06W' then//H06W -> Keeper of the Light 3
		return 'M518'
	elseif UnitID=='N013' then//N013 -> Lone Druid
		return 'M520'
	elseif UnitID=='N014' then//N014 -> Lone Druid
		return 'M522'
	elseif UnitID=='N015' then//N015 -> Lone Druid
		return 'M524'
	elseif UnitID=='E015' then//E015 -> Lycanthrope
		return 'M526'
	elseif UnitID=='H07I' then//H07I -> Flesh Golem
		return 'M528'
	elseif UnitID=='Eevm' then//Eevm -> Soul Keeper
		return 'M530'
	elseif UnitID=='E02V' then//E02V -> Soul Keeper
		return 'M532'
	elseif UnitID=='E02W' then//E02W -> Soul Keeper
		return 'M534'
	elseif UnitID=='E02U' then//E02U -> Soul Keeper
		return 'M536'
	elseif UnitID=='H08D' then//H08D -> Gorgon
		return 'M538'
	elseif UnitID=='H08C' then//H08C -> Gorgon
		return 'M540'
	elseif UnitID=='H084' then//H084 -> Gorgon
		return 'M542'
	elseif UnitID=='H08B' then//H08B -> Gorgon
		return 'M544'
	elseif UnitID=='N017' then//N017 -> Troll Warlord
		return 'M546'
	elseif UnitID=='N02B' then//N02B -> Troll Warlord
		return 'M548'
	elseif UnitID=='N0MB' then//N0MB -> Winter Wyvern
		return 'M550'
	elseif UnitID=='N0MC' then//N0MC -> Winter Wyvern
		return 'M552'
	elseif UnitID=='N0MO' then//N0MO -> Winter Wyvern
		return 'M554'
	elseif UnitID=='N0MA' then//N0MA -> Winter Wyvern
		return 'M556'
	elseif UnitID=='U01X' then//U01X -> Stone Giant
		return 'M558'
	elseif UnitID=='QTW2' then//QTW2 -> Troll Warlord
		return 'M562'
	elseif UnitID=='QTW3' then//QTW3 -> Troll Warlord
		return 'M564'
	elseif UnitID=='KODO' then//KODO -> Chakk
		return 'M566'
	elseif UnitID=='H00U' then//H00U -> Invoker
		return 'M186'
	elseif UnitID=='H500' then//H500 -> Formless
		return 'M568'
	elseif UnitID=='H501' then//H501 -> Sieger
		return 'M570'
	elseif UnitID=='H502' then//H502 -> Sorceress
		return 'M572'
	elseif UnitID=='H503' then
		return 'M574'
	elseif UnitID=='H504' then
		return 'M576'
	elseif UnitID=='H505' then
		return 'M578'
	elseif UnitID=='H506' then
		return 'M57A'
	elseif UnitID=='H507' then
		return 'M57C'
	endif
	if id==0 then
		return 0
	endif
	if l==1 then
		set MorphString="M00"+MorphString
	elseif l==2 then
		set MorphString="M0"+MorphString
	elseif l==3 then
		set MorphString="M"+MorphString
	else
		return 0
	endif
	return String2Id(MorphString)
endfunction

function MorphUnit takes unit u returns integer
	//local integer morph = GetMorphId(HeroTypeId[GetPlayerId(GetOwningPlayer(u))])
	local integer morph = GetMorphId(GetUnitTypeId(u))

	//call BJDebugMsg("xin: "+Id2String('M106'))
	//call BJDebugMsg("morfid: "+Id2String(morph))
	//call BJDebugMsg(B2S(morph!='M106'))

	if morph!='M106'then //prevents the unit from transforming into itself \:3/
		call UnitAddAbility(u,'A04R')//adds marker so the morph ability cant be stolen//
		call UnitAddAbility(u,morph)
		call UnitRemoveAbility(u,morph)
		call UnitRemoveAbility(u,'A04R')//
	endif
	call RemoveAbilsForUnit(u)
	return morph
endfunction

function UnMorphUnit takes unit u, integer morph returns nothing

	//call BJDebugMsg("xin: "+Id2String('M106'))
	//call BJDebugMsg("unmorfid: "+Id2String(morph))
	//call BJDebugMsg(B2S(morph!='M106'))

	if morph!='M107'then //prevents the unit from transforming into itself \:3/
		call UnitAddAbility(u,'A04R')//adds marker so the morph ability cant be stolen//
		call UnitAddAbility(u,morph)
		call UnitRemoveAbility(u,morph)
		call UnitRemoveAbility(u,'A04R')//
	endif
	call RemoveAbilsForUnit(u)
endfunction

function GetHeroExpReward takes unit Hero returns integer
	local integer Level=GetHeroLevel(Hero)
	if Level==1 then
		return 100
	elseif Level==2 then
		return 120
	elseif Level==3 then
		return 140
	elseif Level==4 then
		return 160
	elseif Level==5 then
		return 180
	else
		return 100*Level - 320
	endif
	return 0
endfunction

function IsObserver takes player p returns boolean
	return udg_ObserverMode and(udg_Observer1==p or udg_Observer2==p)
endfunction

function IsUnitCycloned takes unit u returns boolean
	return GetUnitAbilityLevel(u,'Bcyc')>0 or GetUnitAbilityLevel(u,'Bcy2')>0//Bcyc -> Cyclone, Bcy2 -> Cyclone
endfunction

function IsUnitSleeping takes unit u returns boolean
	return (GetUnitAbilityLevel(u,('B02F'))>0) or (GetUnitAbilityLevel(u,('BUsp'))>0) or (GetUnitAbilityLevel(u,('BUst'))>0)
endfunction

//function IsUnitInvulnerable takes unit u returns boolean
//	return GetUnitAbilityLevel(u,'B02J')>0 or IsUnitCycloned(u) or IsUnitSleeping(u) or GetUnitAbilityLevel(u,'Avul')>0 //B02J -> Song of the Siren
//endfunction

function FamiliarIncLevel takes unit u, integer lvl returns nothing
	call SetUnitAbilityLevel(u,'A1NB',lvl)
	call SetUnitAbilityLevel(u,'A1NC',lvl)
	call SetUnitAbilityLevel(u,'A1ND',lvl)
	call SetUnitAbilityLevel(u,'A1NL',lvl)
	call SetUnitAbilityLevel(u,'A1NN',lvl)
	call SetUnitAbilityLevel(u,'A1NM',lvl)
	call SetUnitAbilityLevel(u,'A2IZ',lvl)
	call SetUnitAbilityLevel(u,'A2J0',lvl)
	call SetUnitAbilityLevel(u,'A2J1',lvl)
endfunction

function IsFamiliarId takes integer id returns boolean
	return id=='u014' or id=='u015' or id=='u016' or id=='u01D' or id=='u01E' or id=='u01F' or id=='u01R' or id=='u01S' or id=='u01T' or id=='u017' or id=='u019' or id=='u018' or id=='u01A' or id=='u01B' or id=='u01C' or id=='u01U' or id=='u01V' or id=='u01W'//u014 -> Familiar, u015 -> Familiar, u016 -> Familiar, u01D -> Familiar, u01E -> Familiar, u01F -> Familiar, u01R -> Familiar, u01S -> Familiar, u01T -> Familiar, u017 -> Stone Form, u019 -> Stone Form, u018 -> Stone Form, u01A -> Stone Form, u01B -> Stone Form, u01C -> Stone Form, u01U -> Stone Form, u01V -> Stone Form, u01W -> Stone Form
endfunction

function IsFamiliar takes unit u returns boolean
	return IsFamiliarId(GetUnitTypeId(u))
endfunction

function IsTombstoneId takes integer id returns boolean
	return id=='n0FJ' or id=='n0FI' or id=='n0F6' or id=='n0FH'
endfunction

function IsTombstone takes unit u returns boolean
	return IsTombstoneId(GetUnitTypeId(u))
endfunction

function IsRemoteMine takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='o018' or id=='o002' or id=='o00B' or id=='o01B'//o018 -> Remote Mine, o002 -> Remote Mine, o00B -> Remote Mine, o01B -> Remote Mine
endfunction

function IsTechiesLandMine takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='n00Q' or id=='n00O' or id=='n00P'  or id=='n00N'//n00Q -> Goblin Land Mine, n00O -> Goblin Land Mine, n00P -> Goblin Land Mine, n00N -> Goblin Land Mine, n01L -> Goblin Land Mine
endfunction

function IsTechiesMine takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return IsRemoteMine(u) or IsTechiesLandMine(u)  or id=='otot'//n00Q -> Goblin Land Mine, n00O -> Goblin Land Mine, n00P -> Goblin Land Mine, n00N -> Goblin Land Mine, n01L -> Goblin Land Mine, otot -> Stasis Trap
endfunction

function IsNetherWardId takes integer id returns boolean
	return id=='o00L' or id=='o00M' or id=='o00N' or id=='o00O'//o00L -> Nether Ward 2, o00M -> Nether Ward 1, o00N -> Nether Ward 4, o00O -> Nether Ward 3
endfunction

function IsNetherWard takes unit u returns boolean
	return IsNetherWardId(GetUnitTypeId(u))
endfunction

function IsSupernovaSunId takes integer id returns boolean
	return id=='h0CV' or id=='h0CX' or id=='h0CW'
endfunction

function IsSupernovaSun takes unit u returns boolean
	return IsSupernovaSunId(GetUnitTypeId(u))
endfunction

function IsPlagueWard takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='o00V' or id=='o00T' or id=='o00W' or id=='o00U'//o00V -> Plague Ward, o00T -> Plague Ward, o00W -> Plague Ward, o00U -> Plague Ward
endfunction

function IsDeathWard takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='o000' or id=='o001' or id=='o00A' or id=='o00X' or id=='n12O'
endfunction

function IsSerpentWard takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='o01C' or id=='o01D' or id=='o01E' or id=='osp4' or id=='o008' or id=='o009'
endfunction

function IsSpiders takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='n01E' or id=='n019'
endfunction

function IsLycanWolves takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='o005' or id=='o006' or id=='o007' or id=='o00F'
endfunction

function IsFurionTreant takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='efon' or id=='efo2'
endfunction

function IsSiegeUnit takes unit u returns boolean
	local integer i=GetUnitTypeId(u)
	return i=='umtw' or i=='ebal' or i=='u00R' or i=='e026'//u00R -> Meat Wagon, umtw -> Meat Wagon, e026 -> Glaive Thrower, ebal -> Glaive Thrower
endfunction

function IsWardUnit takes unit u returns boolean
	return IsNetherWard(u) or IsPlagueWard(u) or IsDeathWard(u) or IsSerpentWard(u) or IsTechiesMine(u)
endfunction

function IsFlyingUnit takes unit u returns boolean
	local integer i=GetUnitTypeId(u)
	return i=='O017' or i=='QTW8' or i=='N0MA' or i=='N0MB' or i=='N0MC' or i=='N0MO' or IsFamiliarId(i) or IsFlyingCourier(u)//O017 -> Batrider, N0M7 -> Winter Wyvern, N0MA -> Winter Wyvern, N0MB -> Winter Wyvern, N0MC -> Winter Wyvern, N0MO -> Winter Wyvern
endfunction

function IsPowerCogId takes integer i returns boolean
	return i=='u00S'
endfunction

function IsPowerCog takes unit u returns boolean
	return IsPowerCogId(GetUnitTypeId(u))
endfunction

function IsSwarmBeetleId takes integer i returns boolean
	return i=='u01K' or i=='u01H' or i=='u01J' or i=='u01L'
endfunction

function IsSwarmBeetle takes unit u returns boolean
	return IsSwarmBeetleId(GetUnitTypeId(u))
endfunction

function IsHomingMissileId takes integer i returns boolean
	return i=='h0CH' or i=='h0CF' or i=='h0C1' or i=='h0CG'//h0CH -> Seeking Missle - 4, h0CF -> Seeking Missle - 3, h0C1 -> Seeking Missle - 2, h0CG -> Seeking Missle - 1
endfunction

function IsHomingMissile takes unit u returns boolean
	return IsHomingMissileId(GetUnitTypeId(u))
endfunction

function IsUnitWard takes unit u returns boolean
	return IsUnitType(u,UNIT_TYPE_SUMMONED) and IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false and IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER)==false 
endfunction

function IsHexed takes unit u returns boolean
	return GetUnitAbilityLevel(u,'BOhx')>0 or GetUnitAbilityLevel(u,'B00H')>0//BOhx -> Hex
endfunction

function OctarineHealing takes boolean isHero, unit attacker, real dmg returns nothing
	if isHero then
		call SetWidgetLife(attacker,dmg*0.25+GetWidgetLife(attacker))
	else
		call SetWidgetLife(attacker,dmg*0.05+GetWidgetLife(attacker))
	endif
	call DestroyEffect(AddSpecialEffectTarget("SpellFizzle.mdx",attacker,"overhead"))
endfunction

function DamageTarget takes unit u,unit target,integer DT,real dmg returns nothing
	if DT==0 or dmg<0 then
		return
	endif
	set IsFakeDamage=IsFakeDamage+1
	set FakeDamageType=DT
	if DT==1 then//magic
		call UnitDamageTarget(u,target,dmg,true,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_FIRE,WEAPON_TYPE_WHOKNOWS)//magic
	elseif DT==2 then//physical
		call UnitDamageTarget(u,target,dmg,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)//physic
	elseif DT==3 then//pure
		if IsSiegeUnit(target)then
			set dmg=dmg*2
		endif
		call UnitDamageTarget(u,target,dmg,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)//pure
	elseif DT==4 then//??
		call UnitDamageTarget(u,target,dmg,true,true,ATTACK_TYPE_PIERCE,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)//physical
	elseif DT==5 then//mixed
		call UnitDamageTarget(u,target,dmg,true,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
	elseif DT==6 or DT==11 then//DHR
		call SetWidgetLife(target,RMaxBJ(GetWidgetLife(target)-dmg,1))
		if IsUnitType(target,UNIT_TYPE_HERO) then
			call UnitDamageTarget(u,target,0,true,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_FIRE,WEAPON_TYPE_WHOKNOWS)//magic
		endif
		//this damage required to register DHR for assists
		if DT==6 or GetUnitAbilityLevel(target,'B07D')==0 and GetWidgetLife(target)<2 and IsUnitInvulnerable(target)==false then//B07D -> |cff00ff00Shallow Grave|r
			if IsUnitType(target,UNIT_TYPE_SUMMONED)==false then
				call UnitRemoveBuffs(target,true,true)
			endif
			call UnitRemoveAbility(target,'Aetl')//Aetl -> Ethereal
			call UnitDamageTarget(CreateUnit(GetOwningPlayer(u),'e00E',0,0,0),target,100000000.00,true,false,ATTACK_TYPE_MELEE,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)//e00E -> Spellcaster
		endif
	elseif DT==7 then//pure, magic immune penetrate
		if GetUnitAbilityLevel(target,'Aetl')>0 or GetUnitAbilityLevel(target,'B01N')>0 then//Aetl -> Ethereal, B01N -> Decrepify
			call UnitDamageTarget(u,target,dmg,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
		else
			call UnitDamageTarget(u,target,dmg,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_UNIVERSAL,WEAPON_TYPE_WHOKNOWS)
		endif
	elseif DT==8 then//magic, magic immune penetrate, resistance affects
		call UnitDamageTarget(u,target,dmg,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_ENHANCED,WEAPON_TYPE_WHOKNOWS)
	elseif DT==9 then//magic, magic immune penetrate
		call UnitDamageTarget(u,target,dmg,true,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_UNIVERSAL,WEAPON_TYPE_WHOKNOWS)
	elseif DT==10 then//enhanced physical: no armor decreasing but physical
		call UnitDamageTarget(u,target,dmg,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_ENHANCED,WEAPON_TYPE_WHOKNOWS)
	endif
	set FakeDamageType=0
	set IsFakeDamage=IsFakeDamage-1
endfunction

function DamageTargetWithDelay_Go takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,30)
	local integer XH8=LoadInteger(HY,h,36)
	local real Damage=LoadReal(HY,h,20)
	call DamageTarget(Source,Target,XH8,Damage)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function DamageTargetDelayed takes unit Source,unit Target,integer DT,real Damage,real delay returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,30,(Target))
	call SaveInteger(HY,h,36,DT)
	call SaveReal(HY,h,20,Damage*1.)
	call TriggerRegisterTimerEvent(t,delay,false)
	call TriggerAddCondition(t,Condition(function DamageTargetWithDelay_Go))
	set t=null
endfunction

function SoundForPlayer takes player whichPlayer,string path returns nothing
	local sound s=CreateSound(path,false,false,false,10,10,"DefaultEAXON")
	if(GetLocalPlayer()==whichPlayer)then
		call StartSound(s)
	endif
	call KillSoundWhenDone(s)
	set s=null
endfunction

function Error takes player p,string txt returns nothing
	local sound s=CreateSoundFromLabel("InterfaceError",false,false,false,10,10)
	if(txt!="")and(txt!=null)then
		call ErrorMsg(txt,p)
	endif
	if(GetLocalPlayer()==p)then
		call StartSound(s)
	endif
	call KillSoundWhenDone(s)
	set s=null
endfunction

function RunIfTrue takes string f,boolean b returns nothing
	if b and f!="" and f!=null then
		call ExecuteFunc(f)
	endif
endfunction

function SafeX50 takes real x returns real
	local real dx=GetRectMinX(bj_mapInitialPlayableArea)+50
	if(x<dx)then
		return dx
	endif
	set dx=GetRectMaxX(bj_mapInitialPlayableArea)-50
	if(x>dx)then
		return dx
	endif
	return x
endfunction

function SafeX75 takes real x returns real
	local real dx=GetRectMinX(bj_mapInitialPlayableArea)+75
	if(x<dx)then
		return dx
	endif
	set dx=GetRectMaxX(bj_mapInitialPlayableArea)-75
	if(x>dx)then
		return dx
	endif
	return x
endfunction

function SafeY50 takes real y returns real
	local real dy=GetRectMinY(bj_mapInitialPlayableArea)+50
	if(y<dy)then
		return dy
	endif
	set dy=GetRectMaxY(bj_mapInitialPlayableArea)-50
	if(y>dy)then
		return dy
	endif
	return y
endfunction

function SafeY75 takes real y returns real
	local real dy=GetRectMinY(bj_mapInitialPlayableArea)+75
	if(y<dy)then
		return dy
	endif
	set dy=GetRectMaxY(bj_mapInitialPlayableArea)-75
	if(y>dy)then
		return dy
	endif
	return y
endfunction

function RemoveHero takes unit Hero returns nothing
	call SaveBoolean(HY,(GetHandleId(Hero)),38,(false))
	call FlushChildHashtable(HY,(GetHandleId(Hero)))
	call RemoveUnit(Hero)
endfunction

function YK8 takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(GetExpiredTimer())
	local unit u=LoadUnitHandle(HY,h,26)
	call SetWidgetLife(u,GetWidgetLife(u)+LoadReal(HY,h,20))
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	set u=null
	set t=null
endfunction

function YM8 takes unit u,real Damage returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveReal(HY,h,20,Damage*1.)
	call SaveUnitHandle(HY,h,26,u)
	call TimerStart(t,0,false,function YK8)
	set t=null
endfunction

function DebugTextTagForObs takes string s,real dur,unit u,real height,real offset,integer r,integer g,integer b,integer a returns nothing
	local texttag tt=CreateTextTag()
	call SetTextTagText(tt,s,height)
	call SetTextTagPosUnit(tt,u,offset)
	call SetTextTagColor(tt,r,g,b,a)
	call SetTextTagVelocity(tt,0,0.0355)
	call SetTextTagFadepoint(tt,2)
	call SetTextTagPermanent(tt,false)
	call SetTextTagLifespan(tt,dur)
	if IsObserver(GetLocalPlayer())then
		call SetTextTagVisibility(tt,true)
	else
		call SetTextTagVisibility(tt,false)
	endif
	set tt=null
endfunction

function HealUnitFor takes unit u,real Damage returns nothing
	local real maxlife=GetUnitState(u,UNIT_STATE_MAX_LIFE)
	local real curlife=GetWidgetLife(u)
	if Damage<0.1 then
		return
	endif
	if(GetWidgetLife(u)>0.5)then
		if Damage>(maxlife-curlife)then
			if Damage>=curlife then
				call SetWidgetLife(u,maxlife)
				call YM8(u,Damage-(maxlife-curlife))
			else
				call YM8(u,Damage)
			endif
		else
			call SetWidgetLife(u,GetWidgetLife(u)+Damage)
		endif
	endif
	if udg_ObserverMode then
		call DebugTextTagForObs("+"+I2S(R2I(Damage)),4,u,0.028,128,0,216,0,216)
	endif
endfunction

function DummyDamagerDeath takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer hu=LoadInteger(HY,h,0)
	call RemoveSavedHandle(HY,hu,'DmgD')
	call RemoveSavedInteger(HY,h,0)
	call DestroyTrigger(t)
	set t=null
endfunction

function AddDamagerDummy takes unit u returns unit
	local trigger t
	local integer h
	local unit d
	set tt_unit1=null
	if IsUnitType(u,UNIT_TYPE_HERO)==false then
		if udg_Hero[GetPlayerId(GetOwningPlayer(u))]!=null then
			set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
		else
			return CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
		endif
	endif
	if HaveSavedHandle(HY,GetHandleId(u),'DmgD') then
		call SetUnitX(LoadUnitHandle(HY,GetHandleId(u),'DmgD'), GetUnitX(u))
		call SetUnitY(LoadUnitHandle(HY,GetHandleId(u),'DmgD'), GetUnitY(u))
		return LoadUnitHandle(HY,GetHandleId(u),'DmgD')
	else
		set d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
		call UnitPauseTimedLife(d,true)
		call SaveUnitHandle(HY,GetHandleId(u),'DmgD',d)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterUnitEvent(t,d,EVENT_UNIT_DEATH)
		call TriggerAddCondition(t,Condition(function DummyDamagerDeath))
		call SaveInteger(HY,h,0,GetHandleId(u))
		set tt_unit1=d
		set d=null
		set t=null
	endif
	return tt_unit1
endfunction

function ReCreateInvulDamager takes integer i returns unit
	call DisableTrigger(DummyUtilizator)
	set InvulDamagers[i]=CreateUnit(Player(i),'e00E',0,0,0)
	call EnableTrigger(DummyUtilizator)
	return InvulDamagers[i]
endfunction

function GetPersonalCaster takes unit source returns unit
	local integer pid=GetPlayerId(GetOwningPlayer(source))
	if GetWidgetLife(InvulDamagers[pid])>1 then
		return InvulDamagers[pid]
	endif
	return ReCreateInvulDamager(pid)
endfunction

function GetInvulDamager takes unit u returns unit
	return AddDamagerDummy(u)
endfunction

function YX8 takes unit Source,location Target returns real
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real TargetX=GetLocationX(Target)
	local real TargetY=GetLocationY(Target)
	if Source==null then
		return I2R(9999999999)
	else
		return SquareRoot((SourceX-TargetX)*(SourceX-TargetX)+(SourceY-TargetY)*(SourceY-TargetY))
	endif
	return 1.
endfunction

function fif_CreateLightningOnUnits takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer h = GetHandleId(t)
	local lightning l = LoadLightningHandle(HY,h,1)
	local real life = LoadReal(HY,h,3)
	local real ad = LoadReal(HY,h,2)
	local real totalLife = LoadReal(HY,h,4)
	local unit u = LoadUnitHandle(HY,h,5)
	local unit targ = LoadUnitHandle(HY,h,6)
	local real time = LoadReal(HY,h,8)+.04
	local location ul = GetUnitLoc(u)
	local location targl = GetUnitLoc(targ)
	local real x = GetUnitX(u)
	local real y = GetUnitY(u)
	local real z = GetUnitFlyHeight(u)+LoadReal(HY,h,7)
	local real x2 = GetUnitX(targ)
	local real y2 = GetUnitY(targ)
	local real z2 = GetUnitFlyHeight(targ)+85
	local real l1 = GetLocationZ(ul)
	local real l2 = GetLocationZ(targl)
	local real alpha
	call MoveLightningEx(l,true,x,y,z+l1,x2,y2,z2+l2)
	call SaveReal(HY,h,8,time)
	if time > life then
		set alpha = GetLightningColorA(l)-ad
		if alpha < 0 then
			set alpha = 0
		endif
		call SetLightningColor(l,GetLightningColorR(l),GetLightningColorG(l),GetLightningColorB(l),alpha)
		if time > totalLife then
			call DestroyLightning(l)
			call CleanTimer(t)
		endif
	endif
	call RemoveLocation(ul)
	call RemoveLocation(targl)
	set ul = null
	set targl = null
	set u = null
	set targ = null
	set t = null
	set l = null
endfunction	

function CreateLightningOnUnits takes string codeName, unit u, unit targ, real zOffset, real r, real g, real b, real alpha, real life, real fadeTime returns integer
	local lightning l
	local timer t = CreateTimer()
	local integer h = GetHandleId(t)
	local real x = GetUnitX(u)
	local real y = GetUnitY(u)
	local real z = GetUnitFlyHeight(u)+zOffset
	local real x2 = GetUnitX(targ)
	local real y2 = GetUnitY(targ)
	local real z2 = GetUnitFlyHeight(targ)+85
	local location ul = GetUnitLoc(u)
	local location targl = GetUnitLoc(targ)
	local real l1 = GetLocationZ(ul)
	local real l2 = GetLocationZ(targl)
	local real ad = alpha/(fadeTime/.04)
	set l = AddLightningEx(codeName,true,x,y,z+l1,x2,y2,z2+l2)
	call SetLightningColor(l,r,g,b,alpha)
	call TimerStart(t,.04,true,function fif_CreateLightningOnUnits)
	call SaveLightningHandle(HY,h,1,l)
	call SaveReal(HY,h,2,ad)
	call SaveReal(HY,h,3,life)
	call SaveReal(HY,h,4,life+fadeTime)
	call SaveUnitHandle(HY,h,5,u)
	call SaveUnitHandle(HY,h,6,targ)
	call SaveReal(HY,h,7,zOffset)
	call RemoveLocation(ul)
	call RemoveLocation(targl)
	set ul = null
	set targl = null
	set l = null
	set t = null
	return h
endfunction

function CustomSpeed_Moveunit takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local real bonus=I2R(LoadInteger(HY,h,0))
	local integer limit=LoadInteger(HY,h,1)
	local real x
	local real y
	local real dx
	local real dy
	local real angle
	local real ms
	local real d
	local real currentspeed=GetUnitDefaultMoveSpeed(u)+I2R(GetUnitOffsetSpeed(u))
	local real bonusfixed
	local integer ord
	local integer c=LoadInteger(HY,h,-1)+1
	if limit==0 then
		set limit=9999
	endif
	set bonusfixed=RMinIF(currentspeed*(100.0+bonus)/100.0,limit)-GetUnitMoveSpeed(u)
	call SaveInteger(HY,h,-1,c)
	//if ModuloInteger(c,50)==0 then
	//	call echo(R2S(bonusfixed))
	//endif
	call SaveReal(HeroStats,GetHandleId(u),99,R2I(bonusfixed))
	if bonusfixed>0 and IsDead(u)==false then
		set x=GetUnitX(u)
		set y=GetUnitY(u)
		set dx=LoadReal(HY,h,10)
		set dy=LoadReal(HY,h,11)
		set d=DistanceBetweenXY(dx,dy,x,y)
		if LoadBoolean(HeroStats,GetHandleId(u),99)==false then//not triggered
			set ord=GetUnitCurrentOrder(u)
			if (d<100 and d>1) and ord!=851993 and ord!=851972 and ord!=851973 then//not holded, stopped or stunned
				set angle=Atan2(y-dy,x-dx)
				set ms=bonusfixed*ThirstInterval
				call SaveReal(HeroStats,GetHandleId(u),99,R2I(ms/ThirstInterval))
				call SetUnitX(u,SafeX50(x+ms*Cos(angle)))
				call SetUnitY(u,SafeY50(y+ms*Sin(angle)))
			endif
		else
			call SaveBoolean(HeroStats,GetHandleId(u),99,false)
		endif
		call SaveReal(HY,h,10,GetUnitX(u))
		call SaveReal(HY,h,11,GetUnitY(u))
	endif
	set t=null
	set u=null
endfunction

//bonus - %% bonus, limit - max speed

function CustomSpeed takes unit u, integer bonus, integer limit returns nothing
	local timer t
	local integer h
	if HaveSavedHandle(HeroStats,GetHandleId(u),'MVSP')==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,ThirstInterval,true,function CustomSpeed_Moveunit)
		set movespeedactive=movespeedactive+1
		call SaveUnitHandle(HY,h,0,u)
		call SaveReal(HY,h,10,GetUnitX(u))
		call SaveReal(HY,h,11,GetUnitY(u))
		call SaveBoolean(HY,h,100,true)
		call SaveTimerHandle(HeroStats,GetHandleId(u),'MVSP',t)
	else
		set t=LoadTimerHandle(HeroStats,GetHandleId(u),'MVSP')
		set h=GetHandleId(t)
	endif
	if bonus==LoadInteger(HY,h,0) and limit==LoadInteger(HY,h,1) then
		set t=null
		return
	endif
	call SaveInteger(HY,h,1,limit)
	call SaveInteger(HY,h,0,bonus)
	if bonus==0 then
		call PauseTimer(t)
		set movespeedactive=movespeedactive-1
		call SaveReal(HeroStats,GetHandleId(u),99,0)
		call SaveBoolean(HY,h,100,false)
	elseif LoadBoolean(HY,h,100)==false then
		call TimerStart(t,ThirstInterval,true,function CustomSpeed_Moveunit)
		set movespeedactive=movespeedactive+1
		call SaveBoolean(HY,h,100,true)
	endif
	set t=null
endfunction

function UnitRefillMana takes unit whichUnit returns nothing
	call SetUnitState(whichUnit,UNIT_STATE_MANA,GetUnitState(whichUnit,UNIT_STATE_MAX_MANA))
endfunction

function YA8 takes nothing returns nothing
	call DisplayTimedTextToPlayer(GetEnumPlayer(),0,0,ZJ,HJ)
endfunction

function DisplayTimedTextToForceEx takes force YC8,real SB8,string Y38 returns nothing
	if YC8==AllPlayers or YC8==bj_FORCE_ALL_PLAYERS then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,SB8,Y38)
		return
	endif
	set HJ=Y38
	set ZJ=SB8
	call ForForce(YC8,function YA8)
endfunction

function Y68 takes nothing returns nothing
	if ShowRollNumbers[GetPlayerId(GetEnumPlayer())]then
		call DisplayTimedTextToPlayer(GetEnumPlayer(),0,0,ZJ,HJ)
	endif
endfunction

function RollDisplaying takes force YC8,real SB8,string Y38 returns nothing
	if ShowRollNumbers[GetPlayerId(GetLocalPlayer())]then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,SB8,Y38)
	endif
endfunction

function Y28 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	call DestroyEffect((LoadEffectHandle(HY,h,32)))
	call FlushChildHashtable(HY,h)
	call CleanTrigger((t))
	set t=null
	return false
endfunction

function Z48 takes string Z78,unit whichUnit,string Z88,real SB8 returns nothing
	local effect fx=AddSpecialEffectTarget(Z78,whichUnit,Z88)
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveEffectHandle(HY,h,32,(fx))
	call TriggerRegisterDeathEvent(t,whichUnit)
	call TriggerRegisterTimerEvent(t,SB8,false)
	call TriggerAddCondition(t,Condition(function Y28))
	set fx=null
	set t=null
endfunction

function Z98 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	call DestroyEffect((LoadEffectHandle(HY,h,32)))
	call FlushChildHashtable(HY,h)
	call CleanTrigger((t))
	set t=null
	return false
endfunction

function ZD8 takes string Z78,real x,real y,real SB8 returns nothing
	local effect fx=AddSpecialEffect(Z78,x,y)
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveEffectHandle(HY,h,32,(fx))
	call TriggerRegisterTimerEvent(t,SB8,false)
	call TriggerAddCondition(t,Condition(function Z98))
	set fx=null
	set t=null
endfunction

function ZE8 takes unit whichUnit,integer ZF8 returns item
	local integer ZG8=0
	local item ZH8
	loop
		exitwhen ZG8==6
		set ZH8=UnitItemInSlot(whichUnit,ZG8)
		if ZH8!=null and GetItemTypeId(ZH8)==ZF8 then
			return ZH8
		endif
		set ZG8=ZG8+1
	endloop
	set ZH8=null
	return null
endfunction

function AngleBetweenUnits takes unit a,unit b returns real
	return bj_RADTODEG*Atan2(GetUnitY(b)-GetUnitY(a),GetUnitX(b)-GetUnitX(a))
endfunction

function AngleBetweenXY takes real x1,real y1,real x2,real y2 returns real
	return bj_RADTODEG*Atan2(y2-y1,x2-x1)
endfunction

function ZN8 takes nothing returns nothing
	call DestroyLightning((LoadLightningHandle(HY,(GetHandleId(GetExpiredTimer())),41)))
endfunction

function ZO8 takes string ZP8,real x1,real y1,real x2,real y2,real r,real g,real b,real a,real SB8 returns nothing
	local timer t=CreateTimer()
	local lightning ZQ8=AddLightning(ZP8,true,x1,y1,x2,y2)
	call SetLightningColor(ZQ8,r,g,b,a)
	call SaveLightningHandle(HY,(GetHandleId(t)),41,(ZQ8))
	call TimerStart(t,SB8,false,function ZN8)
	set t=null
	set ZQ8=null
endfunction

function TextTagOnUnitEx takes string s,real dur,unit u,real height,real offset,integer r,integer g,integer b,integer a returns nothing
	local texttag tt=CreateTextTag()
	call SetTextTagText(tt,s,height)
	call SetTextTagPosUnit(tt,u,offset)
	call SetTextTagColor(tt,r,g,b,a)
	call SetTextTagVelocity(tt,0,0.0355)
	call SetTextTagFadepoint(tt,2)
	call SetTextTagPermanent(tt,false)
	call SetTextTagLifespan(tt,dur)
	if IsUnitVisibleLoD(u,GetLocalPlayer())or IsObserver(GetLocalPlayer())then
		call SetTextTagVisibility(tt,true)
	else
		call SetTextTagVisibility(tt,false)
	endif
	set tt=null
endfunction

function TextTagOnUnit takes string ZS8,real SB8,unit ZT8,real ZV8,integer r,integer g,integer b,integer a returns nothing
	local texttag tt=CreateTextTag()
	call SetTextTagText(tt,ZS8,ZV8)
	call SetTextTagPosUnit(tt,ZT8,64)
	call SetTextTagColor(tt,r,g,b,a)
	call SetTextTagVelocity(tt,0,.0355)
	call SetTextTagFadepoint(tt,2)
	call SetTextTagPermanent(tt,false)
	call SetTextTagLifespan(tt,SB8)
	call SetTextTagVisibility(tt,IsUnitVisibleLoD(ZT8,GetLocalPlayer())or IsObserver(GetLocalPlayer()))
	set tt=null
endfunction

function ZW8 takes player p,string ZS8,real SB8,unit ZT8,real ZV8,integer r,integer g,integer b,integer a returns nothing
	local texttag tt=CreateTextTag()
	call SetTextTagText(tt,ZS8,ZV8)
	call SetTextTagPosUnit(tt,ZT8,64)
	call SetTextTagColor(tt,r,g,b,a)
	call SetTextTagVelocity(tt,0,.0355)
	call SetTextTagFadepoint(tt,2)
	call SetTextTagPermanent(tt,false)
	call SetTextTagLifespan(tt,SB8)
	call SetTextTagVisibility(tt,IsPlayerAlly(GetLocalPlayer(),p) or IsObserver(GetLocalPlayer()))
	set tt=null
endfunction

function ReturnTrue takes nothing returns boolean
	return true
endfunction

function TriggerRegisterAnyUnitEvent takes trigger t,playerunitevent pue returns nothing
	local integer i=0
	loop
		call TriggerRegisterPlayerUnitEvent(t,Player(i),pue,Condition(function ReturnTrue))
		set i=i+1
		exitwhen i==16
	endloop
endfunction

function TriggerRegisterHumanUnitEvent takes trigger t,playerunitevent pue returns nothing
	local integer i=1
	loop
		exitwhen i>5
		call TriggerRegisterPlayerUnitEvent(t,Sentinels[i],pue,Condition(function ReturnTrue))
		call TriggerRegisterPlayerUnitEvent(t,Scourges[i],pue,Condition(function ReturnTrue))
		set i=i+1
	endloop
endfunction

function ZC8 takes nothing returns nothing
	if IsValidTree(GetEnumDestructable())and IsDestructableAliveBJ(GetEnumDestructable())then
		set TreesKilled=TreesKilled+1
		call KillDestructable(GetEnumDestructable())
	endif
endfunction

function KillTrees takes real x,real y,real d returns integer
	local rect r=Rect(x-d,y-d,x+d,y+d)
	set TreesKilled=0
	call EnumDestructablesInRect(r,Condition(function ReturnTrue),function ZC8)
	call RemoveRect(r)
	set r=null
	return TreesKilled
endfunction

function IsTerrainPathableFixed takes real x,real y returns boolean
	return( not(IsTerrainPathable(x,y,PATHING_TYPE_WALKABILITY)))
endfunction

function PlaySoundAtPos takes sound Z18,real x,real y returns nothing
	call SetSoundPosition(Z18,x,y,0)
	call SetSoundVolume(Z18,127)
	set bj_lastPlayedSound=Z18
	if(Z18!=null)then
		call StartSound(Z18)
	endif
endfunction

function TimedReveal_End takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local fogmodifier f=(LoadFogModifierHandle(HY,h,42))
	call FogModifierStop(f)
	call DestroyFogModifier(f)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set f=null
	return false
endfunction

function TimedReveal takes player p,real SB8,real x,real y,real r returns nothing
	local trigger t=CreateTrigger()
	local fogmodifier fm=CreateFogModifierRadius(p,FOG_OF_WAR_VISIBLE,x,y,r,true,true)
	call FogModifierStart(fm)
	call SaveFogModifierHandle(HY,(GetHandleId(t)),42,(fm))
	call TriggerRegisterTimerEvent(t,SB8,false)
	call TriggerAddCondition(t,Condition(function TimedReveal_End))
	set fm=null
	set t=null
endfunction

function A88 takes nothing returns nothing
	call PauseUnit(GetEnumUnit(),true)
endfunction

function A98 takes nothing returns boolean
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,0,0,16000,Condition(function ReturnTrue))
	call ForGroup(g,function A88)
	call KillGroup(g)
	set g=null
	return false
endfunction

function AD8 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function A98))
	call TriggerEvaluate(t)
	set t=null
endfunction

function FixPassivesPlz takes nothing returns nothing
	local integer pid=GetPlayerId(GetTriggerPlayer())
	local integer i=1
	local integer lvl
	local unit u=udg_Hero[pid]
	if u!=null and IsDead(u)==false then
		loop
			set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[i])
			if lvl==0 then
				set lvl=GetUnitAbilityLevel(u,PassivesLearningSkillUpg[i])
			endif
			if lvl==0 and (GetUnitAbilityLevel(u,PassivesRealID[i])>0 or GetUnitAbilityLevel(u,PassivesSpellbookID[i])>0) then
				call UnitRemoveAbility(u,PassivesRealID[i])
				call UnitRemoveAbility(u,PassivesSpellbookID[i])
				call UnitRemoveAbility(u,PassivesBuffID[i])
				call UnitRemoveAbility(u,PassivesLearningSkillUpg[i])
			endif
			set i=i+1
			exitwhen i>PassivesCount
		endloop
		endif
	set u=null
endfunction

function AH8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target
	local unit Source
	local real AJ8
	local unit Projectile
	local real x
	local real y
	local real TargetX
	local real TargetY
	local real AM8
	local real AN8
	local real AO8
	local real AP8
	local boolean disjointed
	local real lastX
	local real lastY
	if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if IsDisjointSpell(GetSpellAbilityId()) then
			call SaveBoolean(HY,h,-1,true)
			call SaveReal(HY,h,-1,GetUnitX(GetTriggerUnit()))
			call SaveReal(HY,h,-2,GetUnitY(GetTriggerUnit()))
		endif
	else
		set Target=LoadUnitHandle(HY,h,30)
		set Source=LoadUnitHandle(HY,h,43)
		set AJ8=(LoadReal(HY,h,44))
		set Projectile=(LoadUnitHandle(HY,h,45))
		set x=GetUnitX(Projectile)
		set y=GetUnitY(Projectile)
		set TargetX=GetUnitX(Target)
		set TargetY=GetUnitY(Target)
		set AM8=AJ8*.03
		if(LoadBoolean(HY,h,-1))then
			set TargetX=LoadReal(HY,h,-1)
			set TargetY=LoadReal(HY,h,-2)
		endif
		set AN8=AngleBetweenXY(x,y,TargetX,TargetY)
		set AO8=x+AM8*Cos(AN8*bj_DEGTORAD)
		set AP8=y+AM8*Sin(AN8*bj_DEGTORAD)
		call SetUnitX(Projectile,AO8)
		call SetUnitY(Projectile,AP8)
		call SetUnitFacing(Projectile,AN8)
		if IsDead(Target)then
			call KillUnit(Projectile)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		elseif DistanceBetweenXY(TargetX,TargetY,AO8,AP8)<=AM8 then
			call KillUnit(Projectile)
			set tt_unit1=Source
			set tt_unit2=Target
			if LoadBoolean(HY,h,-1)==false then
				if HaveSavedString(HY,h,46) then
					call ExecuteFunc(LoadStr(HY,h,46))
				endif
			endif
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set Target=null
	set Source=null
	set Projectile=null
	return false
endfunction

function AddProjectile takes unit Source,unit Target,integer AR8,string AS8,real AJ8, boolean CanBeDisjoined returns trigger
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real AT8=GetUnitFacing(Source)
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function AH8))
	call SaveReal(HY,h,44,((AJ8)*1.))
	call SaveUnitHandle(HY,h,30,((Target)))
	call SaveStr(HY,h,46,(AS8))
	call SaveUnitHandle(HY,h,43,((Source)))
	call SaveBoolean(HY,h,-1,false)
	if CanBeDisjoined then
		
		call SaveReal(HY,h,-1,0)
		call SaveReal(HY,h,-2,0)
		call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
	endif
	call SaveUnitHandle(HY,h,45,(CreateUnit(GetOwningPlayer(Source),AR8,SourceX,SourceY,AT8)))
	set AddProjectileTrigger=t
	set t=null
	return AddProjectileTrigger
endfunction

function AU8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=GetTriggerEvalCount(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local real AV8=(LoadReal(HY,h,49))
	local real U68=AV8-(AV8-U18(Hero))*Count/ 40
	if Count>40 or IsDead(Hero)then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SetUnitScale(Hero,U68,U68,U68)
	endif
	set t=null
	set Hero=null
	return false
endfunction

function AW8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local real AX8=(LoadReal(HY,h,50))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.025,true)
	call TriggerAddCondition(t,Condition(function AU8))
	set h=GetHandleId(t)
	call SaveReal(HY,h,49,((AX8)*1.))
	call SaveUnitHandle(HY,h,14,(Hero))
	set t=null
	set Hero=null
	return false
endfunction

function AY8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=GetTriggerEvalCount(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local real AZ8=((LoadReal(HY,h,51))-U18(Hero))*Count/ 40
	local real U68=U18(Hero)+AZ8
	if Count>40 or IsDead(Hero)then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SetUnitScale(Hero,U68,U68,U68)
	endif
	set t=null
	set Hero=null
	return false
endfunction

function AA8 takes unit Hero,real SB8,real U68 returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real AB8=U68*U18(Hero)
	local real AX8=AB8
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveReal(HY,h,50,((AX8)*1.))
	call TriggerRegisterTimerEvent(t,SB8,false)
	call TriggerAddCondition(t,Condition(function AW8))
	if SB8>3 then
		set t=CreateTrigger()
		call TriggerRegisterTimerEvent(t,.025,true)
		call TriggerAddCondition(t,Condition(function AY8))
		set h=GetHandleId(t)
		call SaveReal(HY,h,51,((AB8)*1.))
		call SaveUnitHandle(HY,h,14,(Hero))
	else
		call SetUnitScale(Hero,AX8,AX8,AX8)
	endif
	set t=null
endfunction

function AC8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer A38=(LoadInteger(HY,h,52))
	if Hero!=null then
		call UnitRemoveAbility(Hero,A38)
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	return false
endfunction

function A68 takes unit u,integer A38,real SB8 returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call UnitAddAbility2(u,A38)
	call TriggerRegisterTimerEvent(t,SB8,false)
	call TriggerAddCondition(t,Condition(function AC8))
	call SaveUnitHandle(HY,h,14,(u))
	call SaveInteger(HY,h,52,(A38))
	set t=null
endfunction

function DummyProjectileMoving takes nothing returns boolean
 local trigger t=GetTriggeringTrigger()
 local integer h=GetHandleId(t)
 local unit target=LoadUnitHandle(HY,h,30)
 local unit caster=LoadUnitHandle(HY,h,43)
 local real speed=LoadReal(HY , h , 44)
 local unit projectile=LoadUnitHandle(HY , h , 45)
 local real xp=GetUnitX(projectile)
 local real yp=GetUnitY(projectile)
 local real xt=GetUnitX(target)
 local real yt=GetUnitY(target)
 local real Distance=speed * 0.03
 local real angle=AngleBetweenXY(xp , yp , xt , yt)
 local real dx=xp + Distance * Cos(angle * bj_DEGTORAD)
 local real dy=yp + Distance * Sin(angle * bj_DEGTORAD)
	call SetUnitX(projectile , dx)
	call SetUnitY(projectile , dy)
	call SetUnitFacing(projectile , angle)
	if IsDead(target) then
		call KillUnit(projectile)
		call FlushChildHashtable(HY , h)
		call DestroyTrigger(t)
	elseif DistanceBetweenXY(xt , yt , dx , dy) <= Distance then
		call KillUnit(projectile)
		set TempCaster = caster
		set TempTarget = target
		call ExecuteFunc(LoadStr(HY , h , 46))
		call FlushChildHashtable(HY , h)
		call DestroyTrigger(t)
	endif
	set t = null
	set target = null
	set projectile = null
	set caster = null
	return false
endfunction

function CreateDummyProjectile takes unit caster,unit target,integer projectile,string callback,real speed returns trigger
 local trigger t=CreateTrigger()
 local integer h=GetHandleId(t)
 local real x=GetUnitX(caster)
 local real y=GetUnitY(caster)
 local real face=GetUnitFacing(caster)
	call TriggerRegisterTimerEvent(t , 0.03 , true)
	call TriggerAddCondition(t , Condition(function DummyProjectileMoving))
	call SaveReal(HY , h , 44 , speed)
	//call SaveInteger(HY , h , 30 , SaveUnitAsInteger(target))
	call SaveUnitHandle(HY,h,30,target)
	call SaveStr(HY , h , 46 , callback)
	call SaveUnitHandle(HY,h,43,caster)
	//call SaveInteger(HY , h , 43 , SaveUnitAsInteger(caster))
	call SaveUnitHandle(HY , h , 45 , CreateUnit(GetOwningPlayer(caster) , projectile , x , y , face))
	set TempTrigger = t
	set t = null
	return TempTrigger
endfunction

function A18 takes nothing returns nothing
	set bj_groupCountUnits=bj_groupCountUnits+1
endfunction

function A08 takes group g returns integer
	set bj_groupCountUnits=0
	call ForGroup(g,function A18)
	return bj_groupCountUnits
endfunction

function A58 takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local fogmodifier fm=(LoadFogModifierHandle(HY,h,42))
	call FogModifierStop(fm)
	call DestroyFogModifier(fm)
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	set t=null
	set fm=null
endfunction

function A28 takes fogmodifier fm,real SB8 returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call FogModifierStart(fm)
	call SaveFogModifierHandle(HY,h,42,fm)
	call TimerStart(t,SB8,false,function A58)
	set t=null
endfunction

function B48 takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local integer B78=LoadInteger(HY,h,55)
	local destructable d=DaI_Load(B78)
	if d!=null then
		call RemoveDestructable(d)
	endif
	call DaI_Clear(B78)
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	set d=null
	set t=null
endfunction

function B88 takes destructable d,real delay returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,delay,false,function B48)
	call SaveInteger(HY,h,55,DaI_Save(d))
	set t=null
endfunction

function BE8 takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call SetUnitAnimation(LoadUnitHandle(HY,h,53),"stand")
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	set t=null
endfunction

function BF8 takes unit u,real SB8 returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,53,u)
	call TimerStart(t,SB8,false,function BE8)
	set t=null
endfunction

function BG8 takes real SB8,boolean BH8,real x,real y,real BI8,real BJ8,real BK8,real BM8,real BN8 returns nothing
	local real BO8
	local real BP8
	local real BQ8
	if(BJ8<=0 or BN8<=0 or BM8<=0)then
		return
	endif
	set BP8=2.*SB8/ BM8
	set BO8=2.*BJ8/ BN8
	set BQ8=BI8/ BJ8
	call TerrainDeformRipple(x,y,BJ8,BK8,R2I(SB8*1000),1,BO8,BP8,BQ8,BH8)
endfunction

function ImitateBountyGain takes player p,unit u,integer g returns nothing
	local texttag t
	local string s = ""
	local boolean b = GetLocalPlayer()==p
	local boolean bb=IsObserver(GetLocalPlayer())
	set g=AddGold(p,g)
	set t=CreateTextTag()
	if GetHandleId(t)>0 then
		call SetTextTagText(t,"+"+I2S(g),.025)
		call SetTextTagPosUnit(t,u,-0.4)
		if bb then
			call SetTextTagColorBJ(t,PlayerColors_R[GetPlayerId(p)],PlayerColors_G[GetPlayerId(p)],PlayerColors_B[GetPlayerId(p)],15)
		else
			call SetTextTagColor(t,255,220,0,255)
		endif
		call SetTextTagVelocity(t,0,.03)
		call SetTextTagVisibility(t,b)
		call SetTextTagFadepoint(t,2)
		call SetTextTagLifespan(t,3)
		call SetTextTagPermanent(t,false)
	else
		call DestroyTextTag(t)
	endif
	if b or bb then
		set s = "UI\\Feedback\\GoldCredit\\GoldCredit.mdl"
	endif
	call DestroyEffect(AddSpecialEffectTarget(s,u,"overhead"))
	set t=null
endfunction

function BS8 takes nothing returns boolean
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call FlushChildHashtable(HY,(GetHandleId((LoadUnitHandle(HY,h,26)))))
	call ShowUnit(LoadUnitHandle(HY,h,26),false)
	call RemoveUnit(LoadUnitHandle(HY,h,26))
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	set t=null
	return false
endfunction

function BT8 takes unit u,real d returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,d,false,function BS8)
	call SaveUnitHandle(HY,h,26,u)
	set t=null
endfunction

function BU8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	call RemoveUnit((LoadUnitHandle(HY,h,26)))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	return false
endfunction

function BV8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	call KillUnit((LoadUnitHandle(HY,h,26)))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	return false
endfunction

function BW8 takes unit u,real d returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,d,false)
	call TriggerAddCondition(t,Condition(function BV8))
	call SaveUnitHandle(HY,h,26,(u))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,d+.01,false)
	call TriggerAddCondition(t,Condition(function BU8))
	call SaveUnitHandle(HY,h,26,(u))
	set t=null
endfunction

function BX8 takes sound Z18 returns nothing
	if Z18!=null then
		if SoundsMuted[GetPlayerId(GetLocalPlayer())]==false then
			call StartSound(Z18)
		endif
	endif
endfunction

function BY8 takes sound Z18,player XS8 returns nothing
	if GetLocalPlayer()==XS8 and SoundsMuted[GetPlayerId(XS8)]==false then
		call StartSound(Z18)
	endif
endfunction

function BZ8 takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false)!=null
endfunction

function BA8 takes nothing returns nothing
	call BY8(WJ,GetOwningPlayer(GetEnumUnit()))
endfunction

function BB8 takes unit Source,sound Z18,real x,real y,real r returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	set WJ=Z18
	call GroupEnumUnitsInRange(g,x,y,r,Condition(function BZ8))
	call GroupRemoveUnit(g,Source)
	call ForGroup(g,function BA8)
	call KillGroup(g)
	set g=null
endfunction

function GetItemSlot takes unit whichUnit,item B38 returns integer
	local integer i=0
	loop
		exitwhen i>5
		if UnitItemInSlot(whichUnit,i)==B38 then
			return i
		endif
		set i=i+1
	endloop
	return-1
endfunction

function B68 takes real n1,real n2 returns integer
	if n1/ n2-R2I(n1/ n2)>=.5 then
		return R2I(n1/ n2)+1
	endif
	return R2I(n1/ n2)
endfunction

function BL8 takes player p returns nothing
	if GetLocalPlayer()==p then
		call ClearTextMessages()
	endif
endfunction

function B18 takes unit u,real d returns nothing
	call SetWidgetLife(u,RMaxIF(GetWidgetLife(u)-d,1))
endfunction

function PreloadUnit takes integer B58 returns nothing
	call RemoveUnit(CreateUnit(Player(15),B58,0,0,0))
endfunction

function DistribGoldToPlayerForUnit takes player p,integer gold,unit u returns nothing
	local texttag t=CreateTextTag()
	local string s="UI\\Feedback\\GoldCredit\\GoldCredit.mdl"
	set gold=AddGold(p,gold)
	call SetTextTagText(t,"+"+I2S(gold),.025)
	call SetTextTagPosUnit(t,u,0)
	call SetTextTagColor(t,255,220,0,255)
	call SetTextTagVelocity(t,0,.03)
	if GetLocalPlayer()!=p then
		set s=""
	endif
	call SetTextTagVisibility(t,GetLocalPlayer()==p)
	if GetWidgetLife(u)>.5 then
		call DestroyEffect(AddSpecialEffectTarget(s,u,"overhead"))
	endif
	call SetTextTagFadepoint(t,2)
	call SetTextTagLifespan(t,3)
	call SetTextTagPermanent(t,false)
	set t=null
endfunction

function CF8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer CG8=(LoadInteger(HY,h,59))
	if UnitRemoveAbility(Target,CG8) or GetUnitAbilityLevel(Target,CG8)==0 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	return false
endfunction

function CH8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer CG8=(LoadInteger(HY,h,59))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	if UnitRemoveAbility(Target,CG8)==false then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddCondition(t,Condition(function CF8))
		call SaveUnitHandle(HY,h,17,(Target))
		call SaveInteger(HY,h,59,(CG8))
	endif
	set t=null
	set Target=null
	return false
endfunction

function AddTimedAbility takes unit Target,integer CG8,integer Level,real SB8 returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call UnitAddAbility2(Target,CG8)
	call SetUnitAbilityLevel(Target,CG8,Level)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterTimerEvent(t,SB8,false)
	call TriggerAddCondition(t,Condition(function CH8))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,59,(CG8))
	set t=null
endfunction

function CJ8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer CG8=(LoadInteger(HY,h,59))
	local integer CK8=(LoadInteger(HY,h,59))
	call UnitRemoveAbility(Target,CK8)
	if UnitRemoveAbility(Target,CG8) or GetUnitAbilityLevel(Target,CG8)==0 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	return false
endfunction

function CM8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer aid=(LoadInteger(HY,h,59))
	local integer bid=(LoadInteger(HY,h,60))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call UnitRemoveAbility(Target,bid)
	if UnitRemoveAbility(Target,aid)==false then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddCondition(t,Condition(function CJ8))
		call SaveUnitHandle(HY,h,17,(Target))
		call SaveInteger(HY,h,59,(aid))
		call SaveInteger(HY,h,60,(bid))
	endif
	set t=null
	set Target=null
	return false
endfunction

function UnitAddAbilityTimedEx takes unit Target,integer aid,integer lvl,real dur,integer bid returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call UnitAddAbility2(Target,aid)
	call SetUnitAbilityLevel(Target,aid,lvl)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterTimerEvent(t,dur,false)
	call TriggerAddCondition(t,Condition(function CM8))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,59,(aid))
	call SaveInteger(HY,h,60,(bid))
	set t=null
endfunction

function UnitAddAbilityTimedEx_RemoveFix takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,17)
	local integer bid=LoadInteger(HY,h,60)
	local integer aid=LoadInteger(HY,h,59)
	call UnitRemoveAbility(u,aid)
	if UnitRemoveAbility(u,bid) or GetUnitAbilityLevel(u,bid)==0 then
		call RemoveSavedHandle(MHT,GetHandleId(u),0-aid)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set u=null
	return false
endfunction

function UnitAddAbilityTimedEx_Remove takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,17)
	local integer aid=LoadInteger(HY,h,59)
	local integer bid=LoadInteger(HY,h,60)
	local timer tt=LoadTimerHandle(HY,h,10)
	call SaveBoolean(HY,h,0,true)//destroying
	call UnitRemoveAbility(u,bid)
	call UnitRemoveAbility(u,aid)
	if GetUnitAbilityLevel(u,aid)==0 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call DestroyTimer(tt)
		call RemoveSavedHandle(MHT,GetHandleId(u),0-aid)
	else
		call TimerStart(tt,1,true,null)
	endif
	set u=null
	set t=null
	return false
endfunction

function UnitAddAbilityTimedExF takes unit u,integer aid,integer lvl,real dur,integer bid returns nothing
	local trigger t
	local integer h
	local real cdur
	local real ndur=TimerGetElapsed(GlobalTimer)+dur
	local timer tt
	if IsDead(u) then
		return
	endif
	if HaveSavedHandle(MHT,GetHandleId(u),0-aid) then
		set t=LoadTriggerHandle(MHT,GetHandleId(u),0-aid)
		set h=GetHandleId(t)
		set tt=LoadTimerHandle(HY,h,10)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		set tt=CreateTimer()
		call FlushChildHashtable(HY,h)
		call SaveUnitHandle(HY,h,17,u)
		call SaveInteger(HY,h,59,aid)
		call SaveInteger(HY,h,60,bid)
		call SaveReal(HY,h,0,0)
		call TriggerRegisterDeathEvent(t,u)
		call SaveTimerHandle(HY,h,10,tt)
		call TriggerRegisterTimerExpireEvent(t,tt)
		//call TriggerRegisterTimerEvent(t,0.1,true)
		call TriggerAddCondition(t,Condition(function UnitAddAbilityTimedEx_Remove))
		call SaveTriggerHandle(MHT,GetHandleId(u),0-aid,t)
	endif
	
	call RemoveSavedBoolean(HY,h,0)
	set cdur=TimerGetRemaining(tt)
	if cdur < dur then
		call TimerStart(tt,dur,false,null)
		//call echo("old dur= "+R2S(cdur)+"; new dur= "+R2S(dur))
	endif
	set t=null
	set tt=null
	call UnitAddAbility3(u,aid,lvl)
endfunction

function DelayedAnimEnd takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if IsDead(u)==false then
		call SetUnitAnimationByIndex(u,LoadInteger(HY,h,0))
	endif
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set u=null
endfunction

function DelayedAnim takes unit u, real delay, integer id returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,delay,false,function DelayedAnimEnd)
	call SaveUnitHandle(HY,h,0,u)
	call SaveInteger(HY,h,0,id)
	set t=null
endfunction

function CO8 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u1=LoadUnitHandle(HY,h,61)
	local unit u2=LoadUnitHandle(HY,h,62)
	local real SB8=(LoadReal(HY,h,57))
	local lightning ZQ8=(LoadLightningHandle(HY,h,41))
	if I2R(GetTriggerEvalCount(t))*.025>SB8 then
		call DestroyLightning(ZQ8)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call MoveLightning(ZQ8,true,GetUnitX(u1),GetUnitY(u1),GetUnitX(u2),GetUnitY(u2))
	endif
	set t=null
	set u1=null
	set u2=null
	set ZQ8=null
	return false
endfunction

function CR8 takes string ZP8,unit u1,unit u2,real r,real g,real b,real a,real SB8 returns nothing
	local real x1=GetUnitX(u1)
	local real y1=GetUnitY(u1)
	local real x2=GetUnitX(u2)
	local real y2=GetUnitY(u2)
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local lightning ZQ8=AddLightning(ZP8,true,x1,y1,x2,y2)
	call SetLightningColor(ZQ8,r,g,b,a)
	call SaveLightningHandle(HY,h,41,(ZQ8))
	call SaveUnitHandle(HY,h,61,((u1)))
	call SaveUnitHandle(HY,h,62,((u2)))
	call SaveReal(HY,h,57,((SB8)*1.))
	call TriggerRegisterTimerEvent(t,.025,true)
	call TriggerAddCondition(t,Condition(function CO8))
	set t=null
	set ZQ8=null
endfunction

function CS8 takes string CT8 returns nothing
	local sound CU8=CreateSound(CT8,false,false,false,10,10,"")
	call SetSoundVolume(CU8,0)
	call StartSound(CU8)
	call KillSoundWhenDone(CU8)
	set CU8=null
endfunction

function IsFrozenSigilId takes integer i returns boolean
	return i=='o01J' or i=='o01K' or i=='o01L' or i=='o01M'
endfunction

function IsFrozenSigil takes unit u returns boolean
	return IsFrozenSigilId(GetUnitTypeId(u))
endfunction

function isNecronomiconWarriors takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='n00J' or id=='n00H' or id=='n00A' or id=='n00G' or id=='n006' or id=='n00K'//n00J -> Necronomicon Warrior 1, n00H -> Necronomicon Archer 1, n00A -> Necronomicon Warrior 2, n00G -> Necronomicon Archer 2, n006 -> Necronomicon Warrior 3, n00K -> Necronomicon Archer 3
endfunction

function IsSpiritBear takes unit u returns boolean
	local integer i=GetUnitTypeId(u)
	return i=='n004' or i=='n018' or i=='n01C' or i=='n01G'//n004 -> Spirit Bear, n018 -> Spirit Bear, n01C -> Spirit Bear, n01G -> Spirit Bear
endfunction

function IsInfernalGolem takes unit u returns boolean
	local integer i=GetUnitTypeId(u)
	return i=='n00U' or i=='n0KU' or i=='n00Y' or i=='n0KV' or i=='n00Z' or i=='n0KW'//n00U -> Infernal, n0KU -> Infernal, n00Y -> Infernal, n0KV -> Infernal, n00Z -> Infernal, n0KW -> Infernal
endfunction

function IsEidolon takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='hwat' or id=='hwt2' or id=='hwt3' or id=='h006'
endfunction

function IsPrimalSplitEarth takes integer i returns boolean
	return i=='npn3' or i=='npn6' or i=='n010' or i=='n0GZ'
endfunction

function IsPrimalSplitStorm takes integer i returns boolean
	return i=='npn2' or i=='npn5' or i=='n012' or i=='n0H1'
endfunction

function IsPrimalSplitFire takes integer i returns boolean
	return i=='npn1' or i=='npn4' or i=='n011' or i=='n0H0'
endfunction

function IsPandarenSpirit takes unit u returns boolean
	local integer i=GetUnitTypeId(u)
	return IsPrimalSplitEarth(i) or IsPrimalSplitStorm(i) or IsPrimalSplitFire(i)
endfunction

//primal spirit pandas
function IsPrimalSplitUnit takes integer i returns boolean
	return IsPrimalSplitFire(i) or IsPrimalSplitStorm(i) or IsPrimalSplitEarth(i)
endfunction

function IsForbiddenAncientTarget takes unit u returns boolean
	local integer i=GetUnitTypeId(u)
	return IsSpiritBear(u) or IsFamiliarId(i) or IsCourier(u) or u==Roshan or IsInfernalGolem(u) or IsPandarenSpirit(u)
endfunction

function IsSuperCreepUnit takes unit u returns boolean
	return IsSpiritBear(u) or IsInfernalGolem(u) or IsPandarenSpirit(u) or u==Roshan
endfunction

function CL8 takes player p returns nothing
	local unit Hero=udg_Hero[GetPlayerId(p)]
	local integer i=0
	local item Item
	loop
		exitwhen i>5
		set Item=UnitItemInSlot(Hero,i)
		call SetItemDroppable(Item,false)
		set i=i+1
	endloop
	set Hero=null
	set Item=null
endfunction

function C08 takes player p returns nothing
	local unit Hero=udg_Hero[GetPlayerId(p)]
	local integer i=0
	local item Item
	loop
		exitwhen i>5
		set Item=UnitItemInSlot(Hero,i)
		call SetItemDroppable(Item,true)
		set i=i+1
	endloop
	set Hero=null
	set Item=null
endfunction

function C58 takes unit u returns boolean
	return GetUnitAbilityLevel(u,'Aetl')>0 or GetUnitAbilityLevel(u,'Bcyc')>0 or GetUnitAbilityLevel(u,'Bcy2')>0 or GetUnitAbilityLevel(u,'B01N')>0//Aetl -> Ethereal, Bcyc -> Cyclone, Bcy2 -> Cyclone, B01N -> Decrepify
endfunction

function IsUnitEntangled takes unit u returns boolean
	return GetUnitAbilityLevel(u,'B0C1')>0 or GetUnitAbilityLevel(u,'BEer')>0 or GetUnitAbilityLevel(u,'Beng')>0 or GetUnitAbilityLevel(u,'Bena')>0 or GetUnitAbilityLevel(u,'B017')>0 or GetUnitAbilityLevel(u,'B078')>0 or GetUnitAbilityLevel(u,'B08F')>0 or GetUnitAbilityLevel(u,'B08E')>0 or GetUnitAbilityLevel(u,'B0ER')>0 or GetUnitAbilityLevel(u,'B0FN')>0//B0C1 -> Entangling Roots, BEer -> Entangling Roots, Beng -> Ensnare, Bena -> Ensnare, B017 -> Frostbite, B078 -> Earthbind, B08F -> Pit of Malice, B08E -> Pit of Malice, B0ER -> Overgrowth, B0FN -> Searing Chains
endfunction

function IsUnitUnableToAttack takes unit u returns boolean
	return IsAttackDisabled(u) or IsUnitEntangled(u)or GetUnitAbilityLevel(u,'B01N')>0 or GetUnitAbilityLevel(u,'Aetl')>0 or GetUnitAbilityLevel(u,'Abun')>0 or GetUnitAbilityLevel(u,'B033')>0
//B01N -> Decrepify, Aetl -> Ethereal, B033 -> Deafening Blast
endfunction

function IsUnitDisabled takes unit u returns boolean
	return GetUnitAbilityLevel(u,'B00H')>0 or GetUnitAbilityLevel(u,'BOhx')>0 or GetUnitAbilityLevel(u,'BPSE')>0 or GetUnitAbilityLevel(u,'B099')>0 or GetUnitAbilityLevel(u,'BSTN')>0 or GetUnitAbilityLevel(u,'B0CF')>0 or GetUnitAbilityLevel(u,'B0BM')>0 or GetUnitAbilityLevel(u,'B07N')>0 or GetUnitAbilityLevel(u,'B08S')>0 or GetUnitAbilityLevel(u,'B00Q')>0 or GetUnitAbilityLevel(u,'B04V')>0 or GetUnitAbilityLevel(u,'B072')>0 or GetUnitAbilityLevel(u,'BUan')>0 or GetUnitAbilityLevel(u,'B095')>0 or GetUnitAbilityLevel(u,'B03I')>0 or GetUnitAbilityLevel(u,'B0AD')>0 or GetUnitAbilityLevel(u,'B0AE')>0 or GetUnitAbilityLevel(u,'B0BE')>0 or GetUnitAbilityLevel(u,'B0BF')>0 or GetUnitAbilityLevel(u,'B008')>0 or GetUnitAbilityLevel(u,'B04B')>0 or GetUnitAbilityLevel(u,'B02F')>0 or GetUnitAbilityLevel(u,'BUsp')>0 or GetUnitAbilityLevel(u,'BUst')>0 or GetUnitAbilityLevel(u,'B0DD')>0 or GetUnitAbilityLevel(u,'B0C2')>0 or GetUnitAbilityLevel(u,'B06S')>0 or GetUnitAbilityLevel(u,'B02S')>0 or GetUnitAbilityLevel(u,'B00Q')>0 or LoadInteger(HY,GetHandleId(u),4293)==1 or LoadInteger(HY,GetHandleId(u),4303)==1
	//BOhx -> Hex, BPSE -> Stunned, B099 -> Stunned, BSTN -> Stunned, B0CF -> Cold Feet, B0BM -> Echo Stomp, B06M -> Stunned, B07N -> Ministun, B08S -> Open Wounds, B00Q -> Stunned, B04V -> Stunned, B072 -> Unstable Concoction, BUan -> Malefice, B095 -> Stunned, B03I -> Dismember, B0AD -> Electric Vortex, B0BE -> Flaming Lasso, B008 -> Shackles, B04B -> Fiend's Grip, B02F -> Nightmare, B0DD -> Chain Freeze, B0C2 -> Stunned, B06S -> Iced, B02S -> Reaper's Scythe, B07E -> Poison Touch, B00Q -> Stunned
endfunction

function IsUnitDisabledAny takes unit u returns boolean
	return IsUnitDisabled(u)or IsUnitEntangled(u)or IsUnitPaused(u)or IsUnitCycloned(u)
endfunction

function SetTime takes integer Minutes,integer Seconds,boolean extraColor returns nothing
	local integer x=0
	loop
		exitwhen x>15
		call SetPlayerState(Player(x),PLAYER_STATE_RESOURCE_LUMBER,Minutes)
		call SetPlayerState(Player(x),PLAYER_STATE_RESOURCE_FOOD_USED,Seconds)
		set x=x+1
	endloop
endfunction

function IsUnitBADWithSpellbooks takes unit u returns boolean
	return false
//	local integer id=GetUnitTypeId(u)
//	return id=='n027' or id=='u014' or id=='u015' or id=='u016' or id=='u01D' or id=='u01E' or id=='u01F' or id=='u017' or id=='u019' or id=='u018' or id=='u01A' or id=='u01B' or id=='u01C'//n027 -> Forged Spirit, u014 -> Familiar, u015 -> Familiar, u016 -> Familiar, u01D -> Familiar, u01E -> Familiar, u01F -> Familiar, u017 -> Stone Form, u019 -> Stone Form, u018 -> Stone Form, u01A -> Stone Form, u01B -> Stone Form, u01C -> Stone Form
endfunction

function LI8 takes real x,real y returns location
	local real AO8
	local real AP8
	local integer i=0
	loop
		exitwhen i>40
		set AO8=x+i*20
		set AP8=y+i*20
		if IsPointInRegion(RestrictedRegion,AO8,AP8)==false then
			return Location(AO8,AP8)
		endif
		set AO8=x+i*20
		set AP8=y-i*20
		if IsPointInRegion(RestrictedRegion,AO8,AP8)==false then
			return Location(AO8,AP8)
		endif
		set AO8=x-i*20
		set AP8=y+i*20
		if IsPointInRegion(RestrictedRegion,AO8,AP8)==false then
			return Location(AO8,AP8)
		endif
		set AO8=x-i*20
		set AP8=y-i*20
		if IsPointInRegion(RestrictedRegion,AO8,AP8)==false then
			return Location(AO8,AP8)
		endif
		set i=i+1
	endloop
	return Location(x,y)
endfunction

function IsUnitInvisibleNeutrals takes unit u returns boolean
	return IsUnitVisible(u,Neutrals)==false
endfunction

function GenericCondition_IsDotAInvis takes unit u returns boolean
	return GetUnitAbilityLevel(u,'B068')>0 or GetUnitAbilityLevel(u,'B07T')>0 or GetUnitAbilityLevel(u,'B076')>0 or GetUnitAbilityLevel(u,'BOwk')>0 or GetUnitAbilityLevel(u,'B04R')>0 or GetUnitAbilityLevel(u,'B0A5')>0 or GetUnitAbilityLevel(u,'B01Q')>0 or GetUnitAbilityLevel(u,'B006')>0 or GetUnitAbilityLevel(u,'Binv')>0 or GetUnitAbilityLevel(u,'Apiv')>0 or GetUnitAbilityLevel(u,'A021')>0 or GetUnitAbilityLevel(u,'A0K4')>0 or GetUnitAbilityLevel(u,'A0XB')>0 or GetUnitAbilityLevel(u,'A0Z2')>0 or GetUnitAbilityLevel(u,'A1GA')>0 or GetUnitAbilityLevel(u,'A1HW')>0 or GetUnitAbilityLevel(u,'A1HX')>0 or GetUnitAbilityLevel(u,'A00J')>0 or GetUnitAbilityLevel(u,'B08K')>0 or GetUnitAbilityLevel(u,'B08X')>0 or GetUnitAbilityLevel(u,'B039')>0 or GetUnitAbilityLevel(u,'B00K')>0 or GetUnitAbilityLevel(u,'BHfs')>0 or GetUnitAbilityLevel(u,'A140')>0 or GetUnitAbilityLevel(u,'B021')>0 or GetUnitAbilityLevel(u,'A0ZD')>0 or GetUnitAbilityLevel(u,'A0KT')>0//B068 -> Wind Walk, B07T -> Wind Walk, B076 -> Wind Walk, BOwk -> Wind Walk, B04R -> Sand Storm Invisibility, B0A5 -> Invisibility, B01Q -> |c0000ff00Invisibility|r, B006 -> Permanent Invisibility, Binv -> Invisibility, Apiv -> Permanent Invisibility, A021 -> Permanent Invisibility, A0K4 -> Permanent Invisibility, A0XB -> Permanent Invisibility, A0Z2 -> Permanent Invisibility (Wraith), A1GA -> Permanent Invisibility, A1HW -> Shadow Dance 1, A1HX -> Shadow Dance 2, A00J -> Permanent Invisibility, B08K -> Meld, B08X -> Ghost Walk, B039 -> Doppelwalk, B00K -> Vendetta, BHfs -> Shukuchi, A140 -> Permanent Invisibility (rexxar), B021 -> Nature's Guise, A0ZD -> Permanent Invisibility Wolves, A0KT -> Moonlight Shadow
endfunction

function IsUnitSpiritBear takes unit whichUnit returns boolean
	local integer LM8=GetUnitTypeId(whichUnit)
	return LM8=='n004' or LM8=='n01G' or LM8=='n01C' or LM8=='n018'//n004 -> Spirit Bear, n01G -> Spirit Bear, n01C -> Spirit Bear, n018 -> Spirit Bear
endfunction

function AliveNonBuildOrMarker takes unit u returns boolean
	return IsUnitType(u,UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(u,'A04R')==0 and IsDead(u)==false//
endfunction

function LO8 takes nothing returns boolean
	return AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function IsNonAncient takes unit u returns boolean
	return IsUnitType(u,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(u)
endfunction

function LP8 takes nothing returns boolean
	return(IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false)and IsNonAncient(GetFilterUnit()))!=null//
endfunction

function LR8 takes nothing returns boolean
	return(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))and( AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function LS8 takes nothing returns boolean
	return(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))and( AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function LT8 takes nothing returns boolean
	return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and( AliveNonBuildOrMarker(GetFilterUnit()))and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1)))!=null
endfunction

function DefaultEnemyFilterWithAncients takes nothing returns boolean
	return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit())) and AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function DefaultEnemyFilterWithAncientsNonImmune takes nothing returns boolean
	return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and AliveNonBuildOrMarker(GetFilterUnit()) and IsMagicImmune(GetFilterUnit())==false
endfunction

function DefaultEnemyFilter takes nothing returns boolean
	return DefaultEnemyFilterWithAncients() and IsNonAncient(GetFilterUnit())
endfunction

function LV8 takes nothing returns boolean
	return(((IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and( AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)))!=null
endfunction

function LW8 takes nothing returns boolean
	return((IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())))!=null
endfunction

function NonImmuneEnemyFilterWithAncients takes nothing returns boolean
	return IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and (AliveNonBuildOrMarker(GetFilterUnit()))
endfunction

function NonImmuneEnemyFilter takes nothing returns boolean
	return NonImmuneEnemyFilterWithAncients() and IsNonAncient(GetFilterUnit())
endfunction

function NonImmuneVisibleEnemyFilter takes nothing returns boolean
	return(IsMagicImmune(GetFilterUnit())==false and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function LZ8 takes nothing returns boolean
	return(IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function LA8 takes nothing returns boolean
	return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function LB8 takes nothing returns boolean
	return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false)and IsNonAncient(GetFilterUnit()))!=null//
endfunction

function LC8 takes nothing returns boolean
	return((IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false)and IsNonAncient(GetFilterUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false)!=null//
endfunction

function L38 takes nothing returns boolean
	return(IsMagicImmune(GetFilterUnit())==false and(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false)and IsNonAncient(GetFilterUnit())))!=null//
endfunction

function L68 takes nothing returns boolean
	return(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function LL8 takes nothing returns boolean
	return(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and IsPlayerBelongToTeams(GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function L18 takes nothing returns boolean
	return(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function L08 takes nothing returns boolean
	return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function L58 takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function D79 takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function D89 takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function DD9 takes nothing returns boolean
	return((GenericCondition_IsDotAInvis(GetFilterUnit())==false or IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))) and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())))!=null
endfunction

function DE9 takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function DF9 takes nothing returns boolean
	return(IsMagicImmune(GetFilterUnit())==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())))!=null
endfunction

function DG9 takes nothing returns boolean
	return(((AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())))!=null
endfunction

function DH9 takes nothing returns boolean
	return(AliveNonBuildOrMarker(GetFilterUnit()))!=null
endfunction

function DI9 takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and (AliveNonBuildOrMarker(GetFilterUnit())) and IsNonAncient(GetFilterUnit()))!=null
endfunction

function Juggernaut_Omnislash_Filter takes nothing returns boolean
	return DefaultEnemyFilterWithAncients() and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))and GetUnitTypeId(GetFilterUnit())!='n0F5'//n0F5 -> Living Dead
endfunction

function DN9 takes nothing returns boolean
	return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and GetTowerLevel(GetFilterUnit())>0
endfunction

function RemoveFakeDust takes unit u returns nothing
	if LoadReal(HY,GetHandleId(u),'AItb')+12 < TimerGetElapsed(GlobalTimer) then
		call UnitRemoveAbility(u,'Bdet')
	endif
endfunction

function AddFakeDust takes unit caster, unit target returns nothing
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(target),GetUnitY(target),0)
	call UnitAddAbility(d,'A2VW')//dust
	call IssueImmediateOrderById(d,852625)
	call KillUnit(d)
	set d=null
endfunction

function SetNapalmFactory takes unit Source,integer Level,integer E89 returns nothing
	local integer i
	if HZ8[1]==0 then
		return
	endif
	set i=1
	loop
		exitwhen i>10
		call UnitRemoveAbility(Source,HZ8[i])
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>10
		call UnitRemoveAbility(Source,HA8[i])
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>10
		call UnitRemoveAbility(Source,HB8[i])
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>10
		call UnitRemoveAbility(Source,HC8[i])
		set i=i+1
	endloop
	call UnitRemoveAbility(Source,'B0BS')//B0BS -> Sticky Napalm
	if Level==0 and E89==0 then
		call SaveInteger(HY,GetHandleId(Source),281,0)
	endif
	if Level==1 then
		call UnitAddAbility(Source,HZ8[E89])
	elseif Level==2 then
		call UnitAddAbility(Source,HA8[E89])
	elseif Level==3 then
		call UnitAddAbility(Source,HB8[E89])
	elseif Level==4 then
		call UnitAddAbility(Source,HC8[E89])
	endif
endfunction

function IsTwoSidePurge takes integer id returns boolean
	return id=='A0XK' or id=='A3G5' or id=='A13V' or id=='A3G2' or id=='A2TN'
endfunction

function IsPurge takes integer id returns boolean
	return IsTwoSidePurge(id) or id=='AIpg' or id=='A1SA' or id=='A594' or id=='A595' or id=='A02V' or id=='ACpu' or id=='A18D' or id=='A1OU'  //AIpg -> Item Purge, A1SA -> Demonic Purge purge, A02V -> Purge, ACpu -> Purge, A18D -> Shock, A1OU -> Purge, AIcy -> Cyclone
endfunction

function AddToPurgeList takes integer id, integer Bclass returns nothing
	call SaveInteger(UTable,Bclass,LoadInteger(UTable,Bclass,0)+1,id)
	call SaveInteger(UTable,Bclass,0,LoadInteger(UTable,Bclass,0)+1)
	//call echo("added "+Id2String(id))
endfunction

function PurgeEntangles takes unit u returns nothing
	local integer i=1
	loop
		//call echo("debuff "+Id2String(LoadInteger(UTable,PURGEENTANGLE,i)))
		exitwhen HaveSavedInteger(UTable,PURGEENTANGLE,i)==false
		call UnitRemoveAbility(u,LoadInteger(UTable,PURGEENTANGLE,i))
		set i=i+1
	endloop
endfunction

function PurgingTriggeredSpellImmune takes unit u returns nothing
	local integer i=1
	loop
		//call echo("debuff "+Id2String(LoadInteger(UTable,PURGEENTANGLE,i)))
		exitwhen HaveSavedInteger(UTable,PURGEDEBUFFIDHIGH,i)==false
		call UnitRemoveAbility(u,LoadInteger(UTable,PURGEDEBUFFIDHIGH,i))
		set i=i+1
	endloop
endfunction

function PurgingTriggered takes unit u, boolean isEnemy returns nothing
	local integer i=1
	//call echo("cleaning "+GetUnitName(u)+" "+B2S(isEnemy))
	loop
		exitwhen HaveSavedInteger(UTable,PURGECOMMONID,i)==false
		call UnitRemoveAbility(u,LoadInteger(UTable,PURGECOMMONID,i))
		//call echo("common "+Id2String(LoadInteger(UTable,PURGECOMMONID,i)))
		set i=i+1
	endloop
	if isEnemy then
		set i=1
		loop
			//call echo("buff "+Id2String(LoadInteger(UTable,PURGEBUFFID,i)))
			exitwhen HaveSavedInteger(UTable,PURGEBUFFID,i)==false
			call UnitRemoveAbility(u,LoadInteger(UTable,PURGEBUFFID,i))
			set i=i+1
		endloop
		call RemoveSavedInteger(HY,GetHandleId(u),'A2SG')//purifing flames clean
	else//ally purge
		set i=1
		loop
			//call echo("debuff "+Id2String(LoadInteger(UTable,PURGEDEBUFFID,i)))
			exitwhen HaveSavedInteger(UTable,PURGEDEBUFFID,i)==false
			call UnitRemoveAbility(u,LoadInteger(UTable,PURGEDEBUFFID,i))
			set i=i+1
		endloop
		set i=1
		loop
			//call echo("debuff "+Id2String(LoadInteger(UTable,PURGESILENCE,i)))
			exitwhen HaveSavedInteger(UTable,PURGESILENCE,i)==false
			call UnitRemoveAbility(u,LoadInteger(UTable,PURGESILENCE,i))
			set i=i+1
		endloop
		set i=1
		loop
			//call echo("debuff "+Id2String(LoadInteger(UTable,PURGESLOW,i)))
			exitwhen HaveSavedInteger(UTable,PURGESLOW,i)==false
			call UnitRemoveAbility(u,LoadInteger(UTable,PURGESLOW,i))
			set i=i+1
		endloop
		set i=1
		loop
			//call echo("debuff "+Id2String(LoadInteger(UTable,PURGEENTANGLE,i)))
			exitwhen HaveSavedInteger(UTable,PURGEENTANGLE,i)==false
			call UnitRemoveAbility(u,LoadInteger(UTable,PURGEENTANGLE,i))
			set i=i+1
		endloop
		
		call SetNapalmFactory(u,0,0)
		call RemoveSavedReal(HY,GetHandleId(u),'AItb')//remove Dust debuff timer
		if LoadInteger(HY,GetHandleId(u),627)>0 then//shadow poison
			call SaveInteger(HY,GetHandleId(u),627,0)
		endif
	endif
	
	
endfunction

function StunTarget_GetId takes real dur returns integer
	if dur < 0.5 then
		return stuns[0]
	elseif dur < 0.9 then
		return stuns[1]
	elseif dur < 1.3 then
		return stuns[2]
	elseif dur < 1.7 then
		return stuns[3]
	elseif dur < 2.1 then
		return stuns[4]
	elseif dur < 2.5 then
		return stuns[5]
	elseif dur < 2.9 then
		return stuns[6]
	elseif dur < 3.3 then
		return stuns[7]
	elseif dur < 3.7 then
		return stuns[8]
	elseif dur < 4.1 then
		return stuns[9]
	elseif dur < 4.5 then
		return stuns[10]
	elseif dur < 4.9 then
		return stuns[11]
	elseif dur < 5.3 then
		return stuns[12]
	endif
	return 0
endfunction

function StunTarget_GetLvl takes real dur returns integer
	set dur=dur*1.0
	if dur < 0.5 then
		return R2I(dur*10)
	elseif dur < 0.9 then
		return R2I((dur-0.4)*10)
	elseif dur < 1.3 then
		return R2I((dur-0.8)*10)
	elseif dur < 1.7 then
		return R2I((dur-1.2)*10)
	elseif dur < 2.1 then
		return R2I((dur-1.6)*10)
	elseif dur < 2.5 then
		return R2I((dur-2.0)*10)
	elseif dur < 2.9 then
		return R2I((dur-2.4)*10)
	elseif dur < 3.3 then
		return R2I((dur-2.8)*10)
	elseif dur < 3.7 then
		return R2I((dur-3.2)*10)
	elseif dur < 4.1 then
		return R2I((dur-3.6)*10)
	elseif dur < 4.5 then
		return R2I((dur-4.0)*10)
	elseif dur < 4.9 then
		return R2I((dur-4.4)*10)
	elseif dur < 5.3 then
		return R2I((dur-4.8)*10)
	endif
	return 0
endfunction

function StunTarget_GetNerfed takes unit u, real dur returns real
	local integer h
	local real newdur
	local integer c
	local real mult
	if IsUnitType(u,UNIT_TYPE_HERO)==false or Mode_BO then
		return dur
	endif
	set h=GetHandleId(u)
	set c=LoadInteger(HeroStats,h,32)
	set mult=1
	if TimerGetElapsed(GlobalTimer)-LoadReal(HeroStats,h,32) < 6 and LoadReal(HeroStats,h,32)!=0 then
		if c==1 then
			set mult=0.75
		elseif c==2 then
			set mult=0.5
		else
			set mult=0.25
		endif
		call SaveInteger(HeroStats,h,32,c+1)
	else
		call SaveInteger(HeroStats,h,32,1)
	endif
	call SaveReal(HeroStats,h,32,TimerGetElapsed(GlobalTimer))
	set newdur=RMaxIF( R2I(dur*1.0*mult*10)*1.0/10 , 0.01)
	return newdur
endfunction

function StunTargetLoD takes unit target, real dur returns real
	local unit d
	local integer id
	local integer lvl
	local real realdur=StunTarget_GetNerfed(target,dur)
	if realdur>0 then
		set id=StunTarget_GetId(realdur)
		set lvl=StunTarget_GetLvl(realdur)
		set d=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
		call UnitAddAbility(d,id)
		call SetUnitAbilityLevel(d,id,lvl)
		call IssueTargetOrder(d,"thunderbolt",target)
		set d=null
	endif
//	call echo("Stun called on "+GetUnitName(target)+", dur="+R2S(dur)+", nerfed dur="+R2S(realdur))
	return realdur
endfunction

function BashTargetLoD takes unit target, real dur returns real
	local unit d
	local integer id
	local integer lvl
	local real realdur=dur
	if IsDead(target) then
		return 0.
	endif
	if realdur>0 then
		if realdur==0.01 then
			set id='A3L0'
			set lvl=4
		elseif realdur==0.1 then
			set id='A3L0'
			set lvl=1
		elseif realdur==1 then
			set id='A3L0'
			set lvl=2
		elseif realdur==1.4 then
			set id='A3L0'
			set lvl=3
		else
			set id='A3L1'
			if realdur==0.8 then
				set lvl=1
			elseif realdur==1.2 then
				set lvl=2
			elseif realdur==1.6 then
				set lvl=3
			else
				set lvl=4
			endif
		endif
		set d=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
		call UnitAddAbility(d,id)
		call SetUnitAbilityLevel(d,id,lvl)
		call IssueTargetOrder(d,"thunderbolt",target)
		set d=null
	endif
//	call echo("Stun called on "+GetUnitName(target)+", dur="+R2S(dur)+", nerfed dur="+R2S(realdur))
	return realdur
endfunction

function DS9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,73)
	local integer Count=GetTriggerEvalCount(t)
	local real y=(Count-13)*(Count-13)
	if Count<26 then
		if IsBuggyFlying(Hero)==false then
			call SetUnitFlyHeight(Hero,375-y,0)
		endif
	else
		call PauseUnit(Hero,false)
		if IsBuggyFlying(Hero)==false then
			call SetUnitFlyHeight(Hero,GetUnitDefaultFlyHeight(Hero),0)
		endif
		call DamageTarget((LoadUnitHandle(HY,h,2)),Hero,1,(LoadReal(HY,h,20)))
		call StunTargetLoD(Hero,(LoadReal(HY,h,57)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Hero=null
	return false
endfunction

function DU9 takes unit Hero,unit Source,real SB8,real DV9,real DW9 returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call PauseUnit(Hero,true)
	if IsBuggyFlying(Hero)==false then
		call UnitAddAbility(Hero,'Amrf')//Amrf -> Crow Form
		call UnitRemoveAbility(Hero,'Amrf')//Amrf -> Crow Form
	endif
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\Impale\\ImpaleHitTarget.mdl",GetUnitX(Hero),GetUnitY(Hero)))
	call SaveUnitHandle(HY,h,73,((Hero)))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveReal(HY,h,20,((DV9)*1.))
	call SaveReal(HY,h,57,((SB8)*1.))
	call TriggerRegisterTimerEvent(t,.02/ .52*DW9,true)
	call TriggerAddCondition(t,Condition(function DS9))
	set t=null
endfunction

function DX9 takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),DK)==false and LoadInteger(HY,GetHandleId(GetEnumUnit()),4253)!=1 then
		call GroupAddUnit(DK,GetEnumUnit())
		call DU9(GetEnumUnit(),tt_unit1,TJ,tt_real1,RJ)
	endif
endfunction

function DY9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real DV9=(LoadReal(HY,h,20))
	local real SB8=(LoadReal(HY,h,57))
	local real x1=(LoadReal(HY,h,64))
	local real y1=(LoadReal(HY,h,65))
	local real x2=(LoadReal(HY,h,66))
	local real y2=(LoadReal(HY,h,67))
	local real w=(LoadReal(HY,h,68))
	local real DZ9=(LoadReal(HY,h,44))
	local real a=Atan2(y2-y1,x2-x1)
	local group g=(LoadGroupHandle(HY,h,22))
	local group DA9=GetAvailableGroup()
	local real offset=DZ9*.0625
	local real DC9=(LoadReal(HY,h,71))
	local real D39=(LoadReal(HY,h,72))
	local real D69=(LoadReal(HY,h,70))
	local real DL9=(LoadReal(HY,h,63))
	if offset>DistanceBetweenXY(x1,y1,x2,y2)then
		set x1=x2
		set y1=y2
	else
		set x1=x1+offset*Cos(a)
		set y1=y1+offset*Sin(a)
	endif
	set tt_unit1=Source
	set tt_real1=DV9
	set TJ=SB8
	set RJ=DL9
	set DK=g
	call GroupEnumUnitsInRange(DA9,x1,y1,w,Condition(function NonImmuneEnemyFilterWithAncients))
	call ForGroup(DA9,function DX9)
	call KillGroup(DA9)
	if DistanceBetweenXY(x1,y1,DC9,D39)>=D69 then
		call SaveReal(HY,h,71,((x1)*1.))
		call SaveReal(HY,h,72,((y1)*1.))
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\Impale\\ImpaleMissTarget.mdl",x1,y1))
	endif
	call SaveReal(HY,h,64,((x1)*1.))
	call SaveReal(HY,h,65,((y1)*1.))
	if x1==x2 and y1==y2 then
		if(LoadBoolean(HY,h,69)) then
			call KillGroup(g)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set g=null
	set DA9=null
	set Source=null
	set t=null
	return false
endfunction

function ImpaleFactory takes unit Source,unit target,real dmg,real stun,real pause,real x1,real y1,real x2,real y2,real w,group alreadyAffected,boolean D29,real speed returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real YR8=DistanceBetweenXY(x1,y1,x2,y2)
	local integer E49=B68(YR8,ZN)
	local real D69=YR8/ E49
	local group g
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveReal(HY,h,20,((dmg)*1.))
	call SaveReal(HY,h,57,((stun)*1.))
	call SaveReal(HY,h,63,((pause)*1.))
	call SaveReal(HY,h,64,((x1)*1.))
	call SaveReal(HY,h,65,((y1)*1.))
	call SaveReal(HY,h,66,((x2)*1.))
	call SaveReal(HY,h,67,((y2)*1.))
	call SaveReal(HY,h,68,((w)*1.))
	call SaveReal(HY,h,44,((speed)*1.))
	if alreadyAffected==null then
		set g=GetAvailableGroup()
		if target!=null and IsUnitIllusion(target)==false then
			call GroupAddUnit(g,target)
		endif
		call SaveGroupHandle(HY,h,22,(g))
		call SaveBoolean(HY,h,69,(D29))
		set g=null
	else
		call SaveGroupHandle(HY,h,22,(alreadyAffected))
		call SaveBoolean(HY,h,69,(D29))
	endif
	call SaveReal(HY,h,70,((D69)*1.))
	call SaveReal(HY,h,71,((x1)*1.))
	call SaveReal(HY,h,72,((y1)*1.))
	call TriggerRegisterTimerEvent(t,.0625,true)
	call TriggerAddCondition(t,Condition(function DY9))
	set t=null
	set g=null
endfunction

function AddDispellableBuff takes integer id returns nothing
	set DispellableBuffs_i=DispellableBuffs_i+1
	set DispellableBuffs[DispellableBuffs_i]=id
endfunction

function RemoveDispellableBuffs takes unit u returns nothing
	local integer i=1
	loop
		exitwhen i>DispellableBuffs_i
		call UnitRemoveAbility(u,DispellableBuffs[i])
		set i=i+1
	endloop
	call PurgingTriggered(u,false)
endfunction

function RemovePositiveBuffs takes unit u returns nothing
	call PurgingTriggered(u,true)
endfunction

function ShareVisionTic takes nothing returns nothing
	//A1HX shadow dance
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer buffid=LoadInteger(HY,h,0)
	local player p=LoadPlayerHandle(HY,h,1)
	local boolean needchange=LoadBoolean(HY,h,'0NEW')
	local player np=LoadPlayerHandle(HY,h,'0NEW')
	local unit dummy=LoadUnitHandle(HY,h,'DUMM')
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call RemoveUnit(dummy)
		call UnitShareVision(u,p,false)
		call FlushChildHashtable(HY,h)
		call RemoveSavedHandle(MHT,GetHandleId(u),buffid)
		call CleanTrigger(t)
	else
		if GetUnitAbilityLevel(u,buffid)>0 then//buff in
			if needchange then
				call UnitShareVision(u,p,false)
				call SetUnitOwner(dummy,np,false)
				set p=np
				call SavePlayerHandle(HY,h,0,p)
				call SaveBoolean(HY,h,'0NEW',false)
			endif
			if GetUnitAbilityLevel(u,'A1HX')==0 then//A1HX -> Shadow Dance 2
				call UnitShareVision(u,p,true)
				call SetUnitPosition(dummy,GetUnitX(u),GetUnitY(u))
			else
				call UnitShareVision(u,p,false)
			endif
		else
			call RemoveUnit(dummy)
			call UnitShareVision(u,p,false)
			call FlushChildHashtable(HY,h)
			call RemoveSavedHandle(MHT,GetHandleId(u),buffid)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set u=null
	set dummy=null
endfunction

function ShareVision takes unit u,unit toWho,integer buffId returns nothing
	local trigger t=LoadTriggerHandle(MHT,GetHandleId(u),buffId)
	local integer hu=GetHandleId(u)
	local integer h
	local unit dummy
	if t==null then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.02,true)
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
		call TriggerAddCondition(t,Condition(function ShareVisionTic))
		call SaveUnitHandle(HY,h,0,u)
		call SavePlayerHandle(HY,h,1,GetOwningPlayer(toWho))
		call SaveInteger(HY,h,0,buffId)
		call SaveTriggerHandle(MHT,hu,buffId,t)
		set dummy=CreateUnit(GetOwningPlayer(toWho),'hFFD',GetUnitX(u),GetUnitY(u),0)
		call SaveUnitHandle(HY,h,'DUMM',dummy)
		call UnitAddAbility(dummy,'A30X')
		set dummy=null
	else
		set h=GetHandleId(t)
		if IsPlayerEnemy(GetOwningPlayer(toWho),LoadPlayerHandle(HY,h,1))then
			call SaveBoolean(HY,h,'0NEW',true)
			call SavePlayerHandle(HY,h,'0NEW',GetOwningPlayer(toWho))
		endif
	endif
	set t=null
endfunction

function IsMagicSelfDispell takes integer id returns boolean
	return id=='A1WE' or id=='A0B8' or id=='A063' or id=='A03O' or id=='A0T2' or id=='QB0Q' or id=='A0MQ' or id=='A1B6' or id=='A11F' or id=='A11E' or id=='A0S3' or id=='A11D'  or id=='A11G' or id=='A11H'  or id=='A2LI' or id=='A0NS' or id=='A1DA'//A1WE -> Manta Image (ranged), A0B8 -> Manta Image, A063 -> Mirror Image, A03O -> Phantasm, A0T2 -> Rage, QB0Q -> Rage, A0MQ -> Primal Split, A1B6 -> Primal Split upgrade, A11F -> Avatar, A11E -> Avatar, A0S3 -> Avatar, A11D -> Avatar, A11G -> Avatar, A11H -> Avatar, A2LI -> Avatar, A0NS -> Borrowed Time, A1DA -> Borrowed Time Upgrade
	//mantas, phantasm, mirror image, rage, primal split, BKB, borrowed time
endfunction

function IsMagicDispell takes integer id returns boolean
	return id=='A08V' or id=='QB05' or id=='A2TF' or id=='QB11' or id=='A0MF' or id=='Aprg' or id=='ACpu' or id=='AIpg' or id=='A02E' or id=='A02V' or id=='A0QH' or id=='A0QX' or id=='A18D' or id=='A1OU' or id=='A1SA' or id=='A594'  or id=='A595' or id=='A2TN' or id=='Acyc' or id=='ACcy' or id=='AIcy' or id=='A0XK' or id=='A12L' or id=='A13V' or id=='A1RL'//A08V -> Repel, QB05 -> Repel, A2TF -> False Promise, QB11 -> False Promise, A0MF -> Aphotic Shield, Aprg -> Purge, ACpu -> Purge, AIpg -> Item Purge, A02E -> Battle Purge, A02V -> Purge, A0QH -> Surge, A0QX -> Overload purge, A18D -> Shock, A1OU -> Purge, A1SA -> Demonic Purge purge, Acyc -> Cyclone, ACcy -> Cyclone, AIcy -> Cyclone, A0XK -> Invoke Tornado Cyclone, A12L -> Windrunner Cyclone, A13V -> Cyclone
	//repel, false promise, aphotic shield, purges, cyclones
endfunction

function MagicDispellCheck takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer id=LoadInteger(HY,h,0)
	local integer buffid=LoadInteger(HY,h,1)
	local integer sid
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call UnitRemoveAbility(u,id)
		call UnitRemoveAbility(u,buffid)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
		if GetUnitAbilityLevel(u,id)==0 then//ability was removed somehow
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		else
			set sid=GetSpellAbilityId()
			if GetTriggerUnit()==u then//selfcasts
				if IsMagicSelfDispell(sid)then
					call UnitRemoveAbility(u,id)
					call UnitRemoveAbility(u,buffid)
					call FlushChildHashtable(HY,h)
					call CleanTrigger(t)
				endif
			else
				if GetSpellTargetUnit()==u and (IsPlayerAlly(GetOwningPlayer(GetTriggerUnit()),GetOwningPlayer(u)) or IsBlocked(u)==false) and IsMagicDispell(sid) then
					call UnitRemoveAbility(u,id)
					call UnitRemoveAbility(u,buffid)
					call FlushChildHashtable(HY,h)
					call CleanTrigger(t)
				endif
			endif
		endif
	endif
	set t=null
	set u=null
endfunction

//Will take unit and awaits till he'll get under dispellng stuff
//takes Which unit and which ability to remove on dispell
function DetectMagicDispell takes unit u, integer id, integer buffid returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function MagicDispellCheck))
	call SaveUnitHandle(HY,h,0,u)
	call SaveInteger(HY,h,0,id)
	call SaveInteger(HY,h,1,buffid)
	set t=null
endfunction

function FindRealIndexId takes integer indexId returns integer
	if Item_SideShops[indexId]==0 then
		return indexId
	else
		return Item_SideShops[indexId]
	endif
endfunction

function Bottle_IsIndexRune takes integer id returns boolean
	return id==BottleIllusion or id==BottleHaste or id==BottleDD or id==BottleRegen or id==BottleInvis or id==BottleBounty
endfunction

function GetRuneFromBottle takes integer id returns integer
	if id==BottleIllusion then
		return 'I007'//I007 -> |c00fffc01Illusion|r
	elseif id==BottleHaste then
		return 'I006'//I006 -> |c00ff0303Haste|r
	elseif id==BottleDD then
		return 'I00K'//I00K -> |c000042ffDouble Damage|r
	elseif id==BottleRegen then
		return 'I008'//I008 -> |cff00ff00Regeneration|r
	elseif id==BottleInvis then
		return 'I00J'//I00J -> |cff99ccffInvisibility|r
	elseif id==BottleBounty then
		return 'I0QA'//I0QA -> |c00ffff01Bounty|r
	endif
	return -1
endfunction

function EM9 takes unit u,integer id returns boolean
	local integer i
	local item it
	set i=0
	loop
		exitwhen i>5
		set it=UnitItemInSlot(u,i)
		if it!=null and GetItemTypeId(it)==id then
			set it=null
			return true
		endif
		set i=i+1
	endloop
	set it=null
	return false
endfunction

function FindItemOfTypeEx takes unit u,integer id,item it returns item
	local integer i
	local item cit
	set i=0
	loop
		exitwhen i>5
		set cit=UnitItemInSlot(u,i)
		if cit!=null and cit!=it and GetItemTypeId(cit)==id then
			set cit=null
			return UnitItemInSlot(u,i)
		endif
		set i=i+1
	endloop
	set cit=null
	return null
endfunction

function FindItemOfType takes unit u,integer id returns item
	local integer i
	local item it
	set i=0
	loop
		exitwhen i>5
		set it=UnitItemInSlot(u,i)
		if it!=null and GetItemTypeId(it)==id then
			set it=null
			return UnitItemInSlot(u,i)
		endif
		set i=i+1
	endloop
	set it=null
	return null
endfunction

function FindItemOfIndexExForPlayer takes player p,unit u,integer indexId,item cit returns item
	local integer i
	local item it
	set i=0
	loop
		exitwhen i>5
		set it=UnitItemInSlot(u,i)
		if it!=null and it!=cit and GetIndex(it)==indexId and(GetItemPlayer(it)==p or indexId==ObserverWards or indexId==SentryWards)then
			set it=null
			return UnitItemInSlot(u,i)
		endif
		set i=i+1
	endloop
	set it=null
	return null
endfunction

function FindItemOfIndexForPlayer takes player p,unit u,integer indexId returns item
	local integer i
	local item it
	set i=0
	loop
		exitwhen i>5
		set it=UnitItemInSlot(u,i)
		if(it!=null)and GetIndex(it)==indexId and(GetItemPlayer(it)==p or indexId==ObserverWards or indexId==SentryWards)then
			set it=null
			return UnitItemInSlot(u,i)
		endif
		set i=i+1
	endloop
	set it=null
	return null
endfunction

function FindItemByIndex takes unit u,integer indexId returns item
	local integer i
	local item it
	set i=0
	loop
		exitwhen i>5
		set it=UnitItemInSlot(u,i)
		if(it!=null)and GetIndex(it)==indexId then
			set it=null
			return UnitItemInSlot(u,i)
		endif
		set i=i+1
	endloop
	set it=null
	return null
endfunction

function FindItemByIndexNoMute takes unit u,integer indexId returns item
	local integer i
	local item it
	set i=0
	loop
		exitwhen i>5
		set it=UnitItemInSlot(u,i)
		if(it!=null)and GetIndexNoMute(it)==indexId then
			set it=null
			return UnitItemInSlot(u,i)
		endif
		set i=i+1
	endloop
	set it=null
	return null
endfunction

function IsUnitHasAghanim takes unit u returns boolean
	local item it
	local integer i=0
	local integer id
	if GetUnitAbilityLevel(u,'A3E7')==1 then
		return true
	endif
	loop
		set it=UnitItemInSlot(u,i)
		if it!=null then
			set id=GetIndexNoMute(it)
			if (id==AghanimBasic or id==AghanimUpgrader or id==AghanimUpgraderGiftable) and GetItemUserData(it)!=-2 then
				set it=null
				return true
			endif
		endif
		set i=i+1
		exitwhen i>5
	endloop
	set it=null
	return false
endfunction

function UndroppableAghaSold_Refund takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local player p=LoadPlayerHandle(HY,h,0)
	local integer gold=LoadInteger(HY,h,0)
	if GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-gold >= 2100 then
		call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-2100)
	endif
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	set t=null
endfunction

function UndroppableAghaSold takes player p returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0,false,function UndroppableAghaSold_Refund)
	call SavePlayerHandle(HY,GetHandleId(t),0,p)
	call SaveInteger(HY,GetHandleId(t),0,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD))
	set t=null
endfunction

function SpecialAghanimBonuses takes integer id, unit u, boolean drop returns nothing
	local item it
	if drop==false then
		//if IsUnitHasAghanim(u)==false then
			if id=='A0CY' then//grow//A0CY -> Grow
				call UnitAddAbility2(u,'A2KK')//A2KK -> Tiny Aghanim Container
				call UnitMakeAbilityPermanent(u,true,'A1W0')//A1W0 -> Warclub Cleave
				call UnitMakeAbilityPermanent(u,true,'A1W4')//A1W4 -> Warclub Demolish Damage
				call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A2KK',false)//A2KK -> Tiny Aghanim Container
				if GetUnitTypeId(u)=='Ucrl' then//Ucrl -> Stone Giant
					call UnitAddAbility(u,'A2KB')//A2KB -> Tiny Aghanim - To alt
					call UnitRemoveAbility(u,'A2KB')//A2KB -> Tiny Aghanim - To alt
					call RemoveAbilsForUnit(u)
					set HeroTypeId[GetPlayerId(GetOwningPlayer(u))]='U01X'//U01X -> Stone Giant
					call AddUnitAnimationProperties(u,"upgrade",true)
				endif
			elseif id=='A0DY' then//ench//A0DY -> Impetus
				//call SetPlayerTechResearched(GetOwningPlayer(u),'R00J',1)
			endif
		//endif
	else
		if IsUnitHasAghanim(u)==false then
//			if id=='A0CY' or id=='A0DY' then//A0CY -> Grow, A0DY -> Impetus
//				if(IsPlayerLeaver(GetOwningPlayer(u))==false) then
//					call Error(GetOwningPlayer(u),"You can't drop last Aghanim if it provides you with bonus attack range.")
//					set it=tt_item1
//					if it!=null then
//						call SetItemUserData(it,-500)
//						set it=UnitAddItemById(u,Item_Real[AghanimUpgrader])
//						call SetItemPlayer(it,GetOwningPlayer(u),false)
//						call SetItemUserData(it,1)
//						call UndroppableAghaSold(GetOwningPlayer(u))
//					endif
//				set it=null
//				endif
//			endif
		endif
	endif
endfunction

function AddAghanim takes integer k, unit u, integer ultnum returns boolean
	local player p=GetOwningPlayer(u)
	if Mode_RC==false then
		if (AghaUpgradeID[k]=='A2S7' or AghaUpgradeID[k]=='A236') then//guardian angel or calldown?
			if IsRearmPicked(u) then//rearm?
				return false
			endif
		endif
	else
		if AghaUpgradeID[k]=='A236' then//calldown?
			if IsRearmPicked(u) then//rearm?
				return false
			endif
		endif
	endif
//	if (isPlayerPickedAbility(p,74) or isPlayerPickedAbility(p,73)) and GetUnitAbilityLevel(u,'A33H')==0 then//rockets/laser
//		call UnitAddAbility2(u,'A33H')
//		call SetPlayerAbilityAvailable(p,'A33H',false)
//	endif
//	if (isPlayerPickedAbility(p,(Techies-1)*4+3)) and GetUnitAbilityLevel(u,'A472')==0 then//suicide
//		call UnitAddAbility2(u,'A472')
//		call SetPlayerAbilityAvailable(p,'A472',false)
//	endif
//	if (isPlayerPickedAbility(p,(Chen-1)*4+3)) and GetUnitAbilityLevel(u,'A3JA')==0 then//holy persuatino
//		call UnitAddAbility2(u,'A3JA')
//		call SetPlayerAbilityAvailable(p,'A3JA',false)
//	endif
	if AghaBaseSpellID[k]=='A343'then//A343 -> Demonic Purge
		set tt_unit1=u
		call ExecuteFunc("SD_DemonicPurgeAgh_Pickup")
	elseif AghaBaseSpellID[k]=='A088' then//A088 -> Multi Cast
		set tt_unit1=u
		call ExecuteFunc("AghaFireblast_Add")
	elseif AghaBaseSpellID[k]=='A2E5' then//A2E5 -> Chakram
		set tt_unit1=u
		call ExecuteFunc("AghaChakram_Add")
	elseif AghaBaseSpellID[k]=='A07Z' then//A07Z -> Overgrowth
		set tt_unit1=u
		call ExecuteFunc("EyesInTheForest_Add")
	elseif AghaBaseSpellID[k]=='A1YQ' then//A1YQ -> Walrus Punch
		set tt_unit1=u
		call ExecuteFunc("WalrusKick_Add")
	elseif AghaBaseSpellID[k]=='A01Y' then//A01Y -> Reincarnation
		set tt_unit1=u
		call ExecuteFunc("LeoricPickupAgh")
	elseif AghaBaseSpellID[k]=='A0DY' then//A0DY -> Impetus
		if LoadBoolean(HY,GetHandleId(GetOwningPlayer(u)),'R00J')==false then
			call SetPlayerTechResearched(GetOwningPlayer(u),'R00J',GetPlayerTechCount(GetOwningPlayer(u),'R00J',true)+1)
			call SaveBoolean(HY,GetHandleId(GetOwningPlayer(u)),'R00J',true)
		endif
	elseif AghaBaseSpellID[k]=='A0CY' then//A0CY -> Grow
		if LoadBoolean(HY,GetHandleId(GetOwningPlayer(u)),'R0L3')==false then
			call SetPlayerTechResearched(GetOwningPlayer(u),'R0L3',GetPlayerTechCount(GetOwningPlayer(u),'R0L3',true)+1)
			call SaveBoolean(HY,GetHandleId(GetOwningPlayer(u)),'R0L3',true)
			call UnitAddAbility2(u,'A2KK')//A2KK -> Tiny Aghanim Container
			call UnitMakeAbilityPermanent(u,true,'A1W0')//A1W0 -> Warclub Cleave
			call UnitMakeAbilityPermanent(u,true,'A1W4')//A1W4 -> Warclub Demolish Damage
			call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A2KK',false)//A2KK -> Tiny Aghanim Container
			if GetUnitTypeId(u)=='Ucrl' then//Ucrl -> Stone Giant
				call UnitAddAbility(u,'A2KB')//A2KB -> Tiny Aghanim - To alt
				call UnitRemoveAbility(u,'A2KB')//A2KB -> Tiny Aghanim - To alt
				call RemoveAbilsForUnit(u)
				set HeroTypeId[GetPlayerId(GetOwningPlayer(u))]='U01X'//U01X -> Stone Giant
				call AddUnitAnimationProperties(u,"upgrade",true)
			endif
		endif
	endif
	if AghaUpgradeID[k]>0 then
		call UnitAddAbility2(u,AghaUpgradeID[k])
		call UnitMakeAbilityPermanent(u,true,AghaUpgradedSpellID[k])
	endif
	call SaveInteger(HeroStats,GetHandleId(u),'AGH0'+ultnum,AghaBaseSpellID[k])
	return true
endfunction

function RemoveAghanim takes integer k, unit u, integer ultnum returns nothing
	local player p=GetOwningPlayer(u)
	if IsUnitHasAghanim(u) then
		return
	endif
	if AghaBaseSpellID[k]=='A088' then//A088 -> Multi Cast
		set tt_unit1=u
		call ExecuteFunc("AghaFireblast_Remove")
	elseif AghaBaseSpellID[k]=='A2E5' then//A2E5 -> Chakram
		set tt_unit1=u
		call ExecuteFunc("AghaChakram_Remove")
	elseif AghaBaseSpellID[k]=='A07Z' then//A07Z -> Overgrowth
		set tt_unit1=u
		call ExecuteFunc("EyesInTheForest_Remove")
	elseif AghaBaseSpellID[k]=='A1YQ' then//A1YQ -> Walrus Punch
		set tt_unit1=u
		call ExecuteFunc("WalrusKick_Remove")
	elseif AghaBaseSpellID[k]=='A0DY' then//A0DY -> Impetus
		if LoadBoolean(HY,GetHandleId(GetOwningPlayer(u)),'R00J') then
			call SetPlayerTechResearched(GetOwningPlayer(u),'R0L2',GetPlayerTechCount(GetOwningPlayer(u),'R0L2',true)+1)
			call SaveBoolean(HY,GetHandleId(GetOwningPlayer(u)),'R00J',false)
		endif
	elseif AghaBaseSpellID[k]=='A0CY' then//A0CY -> Grow
		if LoadBoolean(HY,GetHandleId(GetOwningPlayer(u)),'R0L3') then
			call SetPlayerTechResearched(GetOwningPlayer(u),'R0L4',GetPlayerTechCount(GetOwningPlayer(u),'R0L4',true)+1)
			call SaveBoolean(HY,GetHandleId(GetOwningPlayer(u)),'R0L3',false)
			call UnitRemoveAbility(u,'A2KK')//A2KK -> Tiny Aghanim Container
			if GetUnitTypeId(u)=='U01X' then//U01X -> Stone Giant
				call UnitAddAbility(u,'A2KC')//A2KB -> Tiny Aghanim - To alt
				call UnitRemoveAbility(u,'A2KC')//A2KB -> Tiny Aghanim - To alt
				call RemoveAbilsForUnit(u)
				set HeroTypeId[GetPlayerId(GetOwningPlayer(u))]='Ucrl'//Ucrl -> Stone Giant
				call AddUnitAnimationProperties(u,"upgrade",false)
			endif
		endif
	endif
	call UnitRemoveAbility(u,AghaUpgradeID[k])
	if AghaUpgradedSpellID[k]!=AghaBaseSpellID[k] then
		call UnitRemoveAbility(u,AghaUpgradedSpellID[k])
	endif
	call SaveInteger(HeroStats,GetHandleId(u),'AGH0'+ultnum,0)
endfunction

function HeroAghanim takes unit u,boolean drop returns boolean
	local integer pid=GetPlayerId(GetOwningPlayer(u))
	local integer k
	local integer z
	local integer aid//ability id
	local boolean b=false
	local integer i=1
	if IsUnitType(u,UNIT_TYPE_HERO)==false or (drop and IsUnitHasAghanim(u)) then
		return false
	endif
	loop
		set k=GetAghaIdByBase(SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+i]])
		if k>0 then
			if drop then
				call RemoveAghanim(k,u,1)
			else
				//call echo("adding agh for i="+I2S(i)+" skil = "+GetObjectName(SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+i]]))
				set b=AddAghanim(k,u,1) or b
			endif
			call SpecialAghanimBonuses(SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+i]],u,drop)
//		else
//			call echo("agh not found for i="+I2S(i)+" ttal="+I2S(AghaCounter))
		endif
		set i=i+1
		exitwhen i>4+NumberOfExtraAbilities
	endloop
	return b
endfunction

function IsAghanim takes item it returns boolean
	local integer i=GetIndex(it)
	local integer id=GetItemTypeId(it)
	if id==Item_Real[AghanimUpgrader] or id==Item_Real[AghanimBasic] or id==Item_Real[AghanimUpgraderGiftable] then
		return true
	endif
	return false
endfunction

function IsIndexIdConsumable takes integer indexId returns boolean
	return indexId==FlyingCourier or indexId==Cheese or indexId==dustofappearance or indexId==ClarityPotion or indexId==HealingSalve or indexId==Tango or indexId==ObserverWards or indexId==SentryWards or indexId==ScrollOfTownPortal or indexId==ghostpotion or indexId==wandofillusions or indexId==Smoke
endfunction

function IsIndexIdCharged takes integer indexId returns boolean
	return (indexId)==UrnOfShadows or indexId==janggo or (indexId)==DiffusalBlade or (indexId)==DiffusalBlade_upg or indexId==bloodstone or indexId==Aegis or (indexId)==MagicStick or (indexId)==MagicWand or indexId==BladeOfTheReaper 
endfunction

function GetBestCourier takes player p returns unit
	local unit u
	local group g=GetAvailableGroup()
	local unit fitting=null
	local boolean worst=false
	call GroupAddGroup(CouriersSummoned,g)
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if IsBasicCourier(u) and IsDead(u)==false then
			if GetOwningPlayer(u)==p then
				set fitting=u
				exitwhen true
			elseif GetPlayerAlliance(GetOwningPlayer(u),p,ALLIANCE_SHARED_CONTROL) then
				if fitting==null or worst then
					set fitting=u
				endif
			elseif IsUnitAlly(u,p) then
				if fitting==null then
					set fitting=u
					set worst=true
				endif
			endif
		endif
		call GroupRemoveUnit(g,u)
	endloop
	set u=null
	call KillGroup(g)
	set tt_unit1=fitting
	set fitting=null
	return tt_unit1
endfunction

function MakeFlyingCourier takes item it, player p returns nothing
	local unit u=GetBestCourier(p)
	if u==null then
		return
	endif
	if UnitItemInSlot(u,0)==null or UnitItemInSlot(u,1)==null or UnitItemInSlot(u,2)==null or UnitItemInSlot(u,3)==null or UnitItemInSlot(u,4)==null or UnitItemInSlot(u,5)==null then
		call UnitAddItem(u,it)
	else
		set tt_unit1=u
		call RemoveItem(it)
		call ExecuteFunc("LongCourierUp")
	endif
	set u=null
endfunction

function IsRapierOrGem takes item B38 returns boolean
	return GetIndex(B38)==DivineRapier or GetIndex(B38)==DivineRapierFree or GetIndex(B38)==Gem or GetIndex(B38)==GemCourier
endfunction

function EW9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer ZF8=(LoadInteger(HY,h,74))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local player p=(LoadPlayerHandle(HY,h,54))
	local boolean consumable=(LoadBoolean(HY,h,75))
	local integer charges=(LoadInteger(HY,h,76))
	local item newItem=CreateItem(ZF8,x,y)
	call SetItemPlayer(newItem,p,true)
	call SetItemUserData(newItem,0)
	if IsRapierOrGem(newItem) then
		call SetItemInvulnerable(newItem,true)
	endif
	if consumable then
		call SetItemCharges(newItem,charges)
	endif
	if ZF8==Item_Dummy[RecipeFlyingCourier] then
		call MakeFlyingCourier(newItem,p)
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set p=null
	set newItem=null
	return false
endfunction

function DelayedItemCreation takes integer ZF8,real x,real y,player p,boolean consumable,integer charges returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveInteger(HY,h,74,(ZF8))
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	call SavePlayerHandle(HY,h,54,(p))
	call SaveBoolean(HY,h,75,(consumable))
	call SaveInteger(HY,h,76,(charges))
	call TriggerAddCondition(t,Condition(function EW9))
	call TriggerRegisterTimerEvent(t,0,false)
	set t=null
endfunction

function DestroyItem takes item B38 returns nothing
	call DisableTrigger(t_manipulateitem)
	call RemoveItem(B38)
	call EnableTrigger(t_manipulateitem)
endfunction

function GetEmptyInventorySlots takes unit whichUnit returns integer
	local integer i=0
	local integer n=0
	local integer E29=UnitInventorySize(whichUnit)-1
	loop
		exitwhen i>E29
		if UnitItemInSlot(whichUnit,i)==null then
			set n=n+1
		endif
		set i=i+1
	endloop
	return n
endfunction

function F79 takes item B38 returns integer
	local integer ZF8
	local integer i=1
	if B38==null then
		return-2
	endif
	set ZF8=GetItemTypeId(B38)
	loop
		exitwhen i>ITC
		if Item_Mute[i]==ZF8 then
			return i
		endif
		set i=i+1
	endloop
	return-1
endfunction

function MuteToRealId takes item B38 returns integer
	local integer ZF8
	local integer i=1
	if B38==null then
		return-2
	endif
	set ZF8=GetItemTypeId(B38)
	loop
		exitwhen i>ITC
		if Item_Mute[i]==ZF8 then
			return Item_Real[i]
		endif
		set i=i+1
	endloop
	return-1
endfunction

function UnitToIndex takes unit whichUnit returns integer
	local integer unitId
	local integer i=0
	if whichUnit==null then
		return-2
	endif
	set unitId=GetUnitTypeId(whichUnit)
	loop
		exitwhen i>ITC
		if Item_SellerUnit[i]==unitId then
			return i
		endif
		set i=i+1
	endloop
	return-1
endfunction

function GetItemIcon takes item FE9 returns string
	if FE9==null then
		return EmptySlotPath
	endif
	return Item_Icon[GetIndex(FE9)]
endfunction

function FG9 takes integer indexId returns integer
	if Tango==indexId then
		return 4
	endif
	if SentryWards==indexId or dustofappearance==indexId then
		return 2
	endif
	return 1
endfunction

function IsItemTemporary takes item B38 returns boolean
	return GetItemType(B38)==ITEM_TYPE_POWERUP or GetItemType(B38)==ITEM_TYPE_PURCHASABLE or GetItemType(B38)==ITEM_TYPE_MISCELLANEOUS
endfunction

function FI9 takes unit Hero returns real
	local real result
	if IsSentinel(GetOwningPlayer(Hero))then
		set result=GetRectCenterX(gg_rct_Hero_Creation_NE)
	else
		set result=GetRectCenterX(gg_rct_Hero_Creation_UD)
	endif
	return result
endfunction

function FK9 takes unit Hero returns real
	local real result
	if IsSentinel(GetOwningPlayer(Hero))then
		set result=GetRectCenterY(gg_rct_Hero_Creation_NE)
	else
		set result=GetRectCenterY(gg_rct_Hero_Creation_UD)
	endif
	return result
endfunction

function AddItemInSlot takes unit Hero,item Item,integer slot returns nothing
	local real x=FI9(Hero)
	local real y=FK9(Hero)
	local integer i=0
	local boolean array b
	local item ttitem
	call DisableTrigger(t_manipulateitem)
	loop
		exitwhen i>(UnitInventorySize(Hero)-1)
		if UnitItemInSlot(Hero,i)==null and i!=slot then
			set ttitem=CreateItem('I02M',x,y)//I02M -> Dummy Item Scourge
			call UnitAddItem(Hero,ttitem)
			set b[i]=true
		else
			set b[i]=false
		endif
		if i==slot then
			call EnableTrigger(t_manipulateitem)
			call UnitAddItem(Hero,Item)
			call DisableTrigger(t_manipulateitem)
		endif
		set i=i+1
	endloop
	set i=0
	loop
		exitwhen i>5
		if b[i] then
			call RemoveItem(UnitItemInSlot(Hero,i))
		endif
		set i=i+1
	endloop
	call EnableTrigger(t_manipulateitem)
	set tt_item1=Item
	set Item=null
	set ttitem=null
endfunction

function AddItemByIdInSlot takes unit Hero,integer FN9,integer FO9 returns item
	local real x=FI9(Hero)
	local real y=FK9(Hero)
	local item Item=CreateItem(FN9,x,y)
	local integer i=0
	local boolean array FP9
	local item FQ9
	call DisableTrigger(t_manipulateitem)
	if FN9>0 then
		loop
			exitwhen i>(UnitInventorySize(Hero)-1)
			if UnitItemInSlot(Hero,i)==null and i!=FO9 then
				set FQ9=CreateItem('I02M',x,y)//I02M -> Dummy Item Scourge
				call UnitAddItem(Hero,FQ9)
				set FP9[i]=true
			else
				set FP9[i]=false
			endif
			if i==FO9 then
				call EnableTrigger(t_manipulateitem)
				call UnitAddItem(Hero,Item)
				call DisableTrigger(t_manipulateitem)
			endif
			set i=i+1
		endloop
		set i=0
		loop
			exitwhen i>5
			if FP9[i] then
				call RemoveItem(UnitItemInSlot(Hero,i))
			endif
			set i=i+1
		endloop
	endif
	call EnableTrigger(t_manipulateitem)
	set tt_item1=Item
	set Item=null
	set FQ9=null
	return tt_item1
endfunction

function FR9 takes integer U58,integer r,integer g,integer b returns nothing
	set Tints_C=Tints_C+1
	set Tints_R[Tints_C]=r
	set Tints_G[Tints_C]=g
	set Tints_B[Tints_C]=b
	set Tints_ID[Tints_C]=U58
endfunction


//METADATA TABLE
//Keys data:
//INT 0-2 for R G B
function ApplyFrostColor takes unit u returns nothing
	local integer uid=GetUnitTypeId(u)
	local integer a=255
	if HaveSavedInteger(MHT,GetHandleId(u),'ALPH') then
		set a=LoadInteger(MHT,GetHandleId(u),'ALPH')
	endif
	call SetUnitVertexColor(u,128,192,192,a)
	call SaveInteger(MHT,GetHandleId(u),COLOR+0,128)
	call SaveInteger(MHT,GetHandleId(u),COLOR+1,192)
	call SaveInteger(MHT,GetHandleId(u),COLOR+2,192)
	call SaveInteger(MHT,GetHandleId(u),'ALPH',a)
endfunction

function RestoreTint takes unit u returns nothing
	local integer uid=GetUnitTypeId(u)
	local integer r=255
	local integer g=255
	local integer b=255
	local integer a=255
	if HaveSavedInteger(UMD,uid,0) then
		set r=LoadInteger(UMD,uid,0)
	endif
	if HaveSavedInteger(UMD,uid,1) then
		set g=LoadInteger(UMD,uid,1)
	endif
	if HaveSavedInteger(UMD,uid,2) then
		set b=LoadInteger(UMD,uid,2)
	endif
	if HaveSavedInteger(MHT,GetHandleId(u),'ALPH') then
		set a=LoadInteger(MHT,GetHandleId(u),'ALPH')
	endif
	call SetUnitVertexColor(u,r,g,b,a)
	call SaveInteger(MHT,GetHandleId(u),COLOR+0,r)
	call SaveInteger(MHT,GetHandleId(u),COLOR+1,g)
	call SaveInteger(MHT,GetHandleId(u),COLOR+2,b)
	call SaveInteger(MHT,GetHandleId(u),'ALPH',a)
endfunction

function SetTint takes unit u, integer r, integer g, integer b, integer a returns nothing
	local integer uid=GetUnitTypeId(u)
	local integer h=GetHandleId(u)
	if r==-1 then
		if HaveSavedInteger(MHT,h,COLOR+0) then
			set r=LoadInteger(MHT,h,COLOR+0)
		elseif HaveSavedInteger(UMD,uid,0) then
			set r=LoadInteger(UMD,uid,0)
		else
			set r=255
		endif
	endif
	if g==-1 then
		if HaveSavedInteger(MHT,h,COLOR+1) then
			set g=LoadInteger(MHT,h,COLOR+1)
		elseif HaveSavedInteger(UMD,uid,1) then
			set g=LoadInteger(UMD,uid,1)
		else
			set g=255
		endif
	endif
	if b==-1 then
		if HaveSavedInteger(MHT,h,COLOR+2) then
			set b=LoadInteger(MHT,h,COLOR+2)
		elseif HaveSavedInteger(UMD,uid,2) then
			set b=LoadInteger(UMD,uid,2)
		else
			set b=255
		endif
	endif
	if a==-1 then
		if HaveSavedInteger(MHT,h,'ALPH') then
			set a=LoadInteger(MHT,h,'ALPH')
		else
			set a=255
		endif
	endif
	call SetUnitVertexColor(u,r,g,b,a)
	call SaveInteger(MHT,h,COLOR+0,r)
	call SaveInteger(MHT,h,COLOR+1,g)
	call SaveInteger(MHT,h,COLOR+2,b)
	call SaveInteger(MHT,h,'ALPH',a)
endfunction

function UMD_SaveTints takes integer uid, integer r, integer g, integer b returns nothing
//store unit's tint. Use -1 to not store value (empty will be converted into 255)
	if r>-1 and r<256 then
		call SaveInteger(UMD,uid,0,r)
	endif
	if g>-1 and g<256 then
		call SaveInteger(UMD,uid,1,g)
	endif
	if b>-1 and b<256 then
		call SaveInteger(UMD,uid,2,b)
	endif
endfunction

function RestoreUnitColor takes unit u returns nothing
	local integer id=GetUnitTypeId(u)
	local integer i=1
	local integer a=255
	local boolean found=false
	if id=='Ewar' then//Ewar -> Phantom Assassin
		set a=R2I(2.55*(100-18+20*GetUnitAbilityLevel(u,'P239'))) //A03P
	endif
	loop
		exitwhen i>Tints_C or found
		if Tints_ID[i]==id then
			set found=true
			call SetUnitVertexColor(u,Tints_R[i],Tints_G[i],Tints_B[i],a)
		endif
		set i=i+1
	endloop
	if found==false then
		call SetUnitVertexColor(u,255,255,255,255)
	endif
endfunction

function FU9 takes unit u returns nothing
	local integer id=GetUnitTypeId(u)
	local integer i=1
	local boolean found=false
	loop
		exitwhen i>Tints_C or found
		if Tints_ID[i]==id then
			set found=true
			call SetUnitVertexColor(u,Tints_R[i],Tints_G[i],Tints_B[i],0)
		endif
		set i=i+1
	endloop
	if found==false then
		call SetUnitVertexColor(u,255,255,255,0)
	endif
endfunction

function Traffic_RegisterPlayerData takes player p,string FW9,integer Y08 returns nothing
	local string id=I2S(GetPlayerId(p))
	call StoreInteger(GCM,id,FW9,Y08)
	if IsPlayer(PlayerModeTyper)==false then
		call W18()
	endif
	if GetLocalPlayer()==PlayerModeTyper then
		call SyncStoredInteger(GCM,id,FW9)
	endif
endfunction

function Traffic_RegisterData takes string FY9,integer Y08 returns nothing
	call StoreInteger(GCM,"Data",FY9,Y08)
	if IsPlayer(PlayerModeTyper)==false then
		call W18()
	endif
	if GetLocalPlayer()==PlayerModeTyper then
		call SyncStoredInteger(GCM,"Data",FY9)
	endif
endfunction

function str_replace takes string s,string FB9,string FC9 returns string
	local string F39=""
	local integer i=0
	local integer F69=StringLength(s)
	local string FL9
	local integer F19=StringLength(FB9)
	local boolean found=false
	loop
		exitwhen i+1>F69
		set FL9=SubString(s,i,i+F19)
		if FL9!=FB9 or found then
			set F39=F39+SubString(s,i,i+1)
			set i=i+1
		else
			set F39=F39+FC9
			set i=i+F19
			set found=true
		endif
	endloop
	return F39
endfunction

function F09 takes player F59,player F29 returns string
	local string s=GetObjectName('n0C8')//n0C8 -> $dead has been killed by his teammate $killer!
	set s=str_replace(s,"$dead",udg_Colors[GetPlayerId(F59)]+(PlayerNames[GetPlayerId((F59))])+"|r")
	set s=str_replace(s,"$killer",udg_Colors[GetPlayerId(F29)]+(PlayerNames[GetPlayerId((F29))])+"|r")
	return s
endfunction

function SetBonusMSPercent takes unit u,integer d returns nothing
	local integer array b
	local integer a=d
	local integer c=1
	local integer i=0
	local integer k
	if d<1 then
		call UnitRemoveAbility(u,BonusMSPercentSystem[0])
		call UnitRemoveAbility(u,BonusMSPercentSystem[1])
		call UnitRemoveAbility(u,BonusMSPercentSystem[2])
		call UnitRemoveAbility(u,BonusMSPercentSystem[3])
		call UnitRemoveAbility(u,BonusMSPercentSystem[4])
		call UnitRemoveAbility(u,BonusMSPercentSystem[5])
		call UnitRemoveAbility(u,BonusMSPercentSystem[6])
		call UnitRemoveAbility(u,BonusMSPercentSystem[7])
		call UnitRemoveAbility(u,BonusMSPercentSystem[8])
		call UnitRemoveAbility(u,BonusMSPercentSystem[9])
		return
	endif
	loop
		exitwhen c==0
		set c=a/ 2
		set b[i]=a-c*2
		set a=c
		set i=i+1
	endloop
	set k=9
	set i=0
	loop
		exitwhen i>k
		if b[i]==1 then
			call UnitAddAbility2(u,BonusMSPercentSystem[i])
		else
			call UnitRemoveAbility(u,BonusMSPercentSystem[i])
		endif
		set i=i+1
	endloop
endfunction

function AddBonusMSPercent takes unit u, integer d returns nothing
	local integer h=GetHandleId(u)
	local integer curBonus=LoadInteger(MHT,h,'MSPC')
	if IsUnitType(u,UNIT_TYPE_HERO) then
		call SetBonusMSPercent(u,d+curBonus)
		call SaveInteger(MHT,h,'MSPC',d+curBonus)
	endif
endfunction

function SubBonusMSPercent takes unit u, integer d returns nothing
	local integer h=GetHandleId(u)
	local integer curBonus=LoadInteger(MHT,h,'MSPC')
	if IsUnitType(u,UNIT_TYPE_HERO) then
		call SetBonusMSPercent(u,curBonus-d)
		call SaveInteger(MHT,h,'MSPC',curBonus-d)
	endif
endfunction

function AddBonusDamage takes unit u,integer d returns nothing
	local integer array b
	local integer a=d
	local integer c=1
	local integer i=0
	local integer k
	if d<1 then
		call UnitRemoveAbility(u,BonusDamageSystemCont[0])
		call UnitRemoveAbility(u,BonusDamageSystemCont[1])
		call UnitRemoveAbility(u,BonusDamageSystemCont[2])
		call UnitRemoveAbility(u,BonusDamageSystemCont[3])
		call UnitRemoveAbility(u,BonusDamageSystemCont[4])
		call UnitRemoveAbility(u,BonusDamageSystemCont[5])
		call UnitRemoveAbility(u,BonusDamageSystemCont[6])
		call UnitRemoveAbility(u,BonusDamageSystemCont[7])
		call UnitRemoveAbility(u,BonusDamageSystemCont[8])
		call UnitRemoveAbility(u,BonusDamageSystemCont[9])
		call UnitRemoveAbility(u,BonusDamageSystemCont[10])
		call UnitRemoveAbility(u,BonusDamageSystemCont[11])
		return
	endif
	loop
		exitwhen c==0
		set c=a/ 2
		set b[i]=a-c*2
		set a=c
		set i=i+1
	endloop
	set k=11
	set i=0
	loop
		exitwhen i>k
		if b[i]==1 then
			call UnitAddAbility2(u,BonusDamageSystemCont[i])
		else
			call UnitRemoveAbility(u,BonusDamageSystemCont[i])
		endif
		set i=i+1
	endloop
endfunction

function BonusDamageSystem takes unit u returns nothing
	local integer h=GetHandleId(u)
	local integer i=0
	set i=i+LoadInteger(HY,h,'a068')
	set i=i+LoadInteger(HY,h,'a272')
	set i=i+LoadInteger(HY,h,'a430')
	set i=i+LoadInteger(HY,h,'axxx')
	set i=i+LoadInteger(HeroStats,GetHandleId(GetOwningPlayer(u)),'DDUE')//duel
	call AddBonusDamage(u,i)
endfunction

function AddBonusHP takes unit u,integer d returns nothing
	local integer array b
	local integer a=d
	local integer c=1
	local integer i=0
	local integer E29
	if d<1 then
		call UnitRemoveAbility(u,HPBonusSystem[0])
		call UnitRemoveAbility(u,HPBonusSystem[1])
		call UnitRemoveAbility(u,HPBonusSystem[2])
		call UnitRemoveAbility(u,HPBonusSystem[3])
		call UnitRemoveAbility(u,HPBonusSystem[4])
		call UnitRemoveAbility(u,HPBonusSystem[5])
		call UnitRemoveAbility(u,HPBonusSystem[6])
		call UnitRemoveAbility(u,HPBonusSystem[7])
		call UnitRemoveAbility(u,HPBonusSystem[8])
		call UnitRemoveAbility(u,HPBonusSystem[9])
		call UnitRemoveAbility(u,HPBonusSystem[10])
		return
	endif
	loop
		exitwhen c==0
		set c=a/ 2
		set b[i]=a-c*2
		set a=c
		set i=i+1
	endloop
	set E29=10
	set i=0
	loop
		exitwhen i>E29
		if b[i]==1 then
			call UnitAddAbility2(u,HPBonusSystem[i])
		else
			call UnitRemoveAbility(u,HPBonusSystem[i])
		endif
		set i=i+1
	endloop
endfunction

function ManageBonusHP takes unit u, integer hp returns nothing
	local integer hu=GetHandleId(u)
	local integer stored=LoadInteger(MHT,hu,'BHPS')
	//call echo(I2S(hp)+" requested to manage, with stored = "+I2S(hp+stored))
	if hp > 0 then
		call AddBonusHP(u,hp+stored)
	elseif hp < 0 then
		call AddBonusHP(u,IMaxIF(stored + hp, 0))
		//call echo(I2S(IMaxIF(stored + hp, 0)) + " final bonus hp")
	endif
	call SaveInteger(MHT,hu,'BHPS',IMaxIF(stored + hp,0))
endfunction

function SetNegativeArmorSystem takes unit u,integer d returns nothing
	local integer array b
	local integer a=d
	local integer c=1
	local integer i=0
	local integer E29
	if d<1 then
		call UnitRemoveAbility(u,NegativeArmorSystem[0])
		call UnitRemoveAbility(u,NegativeArmorSystem[1])
		call UnitRemoveAbility(u,NegativeArmorSystem[2])
		call UnitRemoveAbility(u,NegativeArmorSystem[3])
		call UnitRemoveAbility(u,NegativeArmorSystem[4])
		call UnitRemoveAbility(u,NegativeArmorSystem[5])
		return
	endif
	loop
		exitwhen c==0
		set c=a/ 2
		set b[i]=a-c*2
		set a=c
		set i=i+1
	endloop
	set E29=i
	set i=0
	loop
		exitwhen i>E29
		if b[i]==1 then
			call UnitAddAbility2(u,NegativeArmorSystem[i])
		else
			call UnitRemoveAbility(u,NegativeArmorSystem[i])
		endif
		set i=i+1
	endloop
endfunction

function GG9 takes unit Source returns integer
	local integer W78=GetUnitTypeId(Source)
	local integer GH9='o01P'//o01P -> Vision Dummy (1800/800)
	if W78=='Udre' or W78=='H071' then//Udre -> Night Stalker, H071 -> Murloc Nightcrawler
		set GH9='o01N'//o01N -> Vision Dummy (1200/1800)
	endif
	return GH9
endfunction

function GI9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call KillUnit(Caster)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SetUnitX(Caster,GetUnitX(Source))
		call SetUnitY(Caster,GetUnitY(Source))
	endif
	set t=null
	set Source=null
	set Caster=null
	return false
endfunction

function GJ9 takes unit Source returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),GG9(Source),GetUnitX(Source),GetUnitY(Source),0)
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function GI9))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,19,(Caster))
	set t=null
	set Caster=null
endfunction

function GK9 takes integer unitId returns boolean
	local integer i=0
	loop
		exitwhen i>59
		if unitId==BuybackUnitId[i]then
			return true
		endif
		set i=i+1
	endloop
	return false
endfunction

function DefineBuybackUnitIndex takes integer Level returns integer
	local real Time=TimerGetElapsed(GlobalTimer)-GameStartsTime
	local real Minutes=(R2I(Time)/ 60)-(1/ 2)
	local real GO9=100+Level*Level*1.5+Minutes*15
	local integer ZG8
	set ZG8=R2I(GO9/ 50)
	set ZG8=IMinBJ(ZG8,59)
	set ZG8=IMaxBJ(ZG8,0)
	return ZG8
endfunction

function FixVisionGlitch_DefineDummy takes unit hero returns integer
	local integer uid=GetUnitTypeId(hero)
	local integer did='o01P'//o01P -> Vision Dummy (1800/800)
	if uid=='Udre' or uid=='H071' then//Udre -> Night Stalker, H071 -> Murloc Nightcrawler
		set did='o01N'//o01N -> Vision Dummy (1200/1800)
	endif
	return did
endfunction

function FixVisionGlitch_CorrectXY takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit hero=(LoadUnitHandle(HY,h,2))
	local unit dummy=(LoadUnitHandle(HY,h,19))
	if GetTriggerEventId()==EVENT_UNIT_DEATH or hero==null then
		call KillUnit(dummy)
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	else
		call SetUnitX(dummy,GetUnitX(hero))
		call SetUnitY(dummy,GetUnitY(hero))
	endif
	set t=null
	set hero=null
	set dummy=null
	return false
endfunction

function FixVisionGlitchOnBuyBack takes unit u returns nothing
	local trigger t
	local integer h
	local unit d
	if IsDead(LoadUnitHandle(HY,GetHandleId(u),'VisD'))==false then
		return
	endif
	set t=CreateTrigger()
	set h=GetHandleId(t)
	set d=CreateUnit(GetOwningPlayer(u),FixVisionGlitch_DefineDummy(u),GetUnitX(u),GetUnitY(u),0)
	call TriggerRegisterTimerEvent(t,0.1,true)
	call SaveUnitHandle(HY,GetHandleId(u),'VisD',d)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function FixVisionGlitch_CorrectXY))
	call SaveUnitHandle(HY,h,2,(u))
	call SaveUnitHandle(HY,h,19,(d))
	set t=null
	set d=null
endfunction

function GP9 takes player p returns nothing
	local integer id=GetPlayerId(p)
	local unit GQ9=CirclesOfPower[id]
	local unit Hero=udg_Hero[id]
	local integer Level=GetHeroLevel(Hero)
	local integer i=0
	call FixVisionGlitchOnBuyBack(Hero)
	loop
		exitwhen i>59
		call RemoveUnitFromStock(GQ9,BuybackUnitId[i])
		set i=i+1
	endloop
	if Mode_DM then
		return
	endif
	if YL7==false then
		return
	endif
	call AddUnitToStock(GQ9,BuybackUnitId[DefineBuybackUnitIndex(Level)],1,1)
	set BuybackID[id]=BuybackUnitId[DefineBuybackUnitIndex(Level)]
	set Hero=null
	set GQ9=null
endfunction

function GR9 takes player p returns nothing
	local integer id=GetPlayerId(p)
	local unit c=CirclesOfPower[id]
	local unit Hero=udg_Hero[id]
	local integer lvl=GetHeroLevel(Hero)
	local integer i=0
	if Mode_DM then
		return
	endif
	if YL7==false then
		return
	endif
	if BuybackID[id]=='h0D4' then//h0D4 -> Revive Hero - Cooldown
		return
	endif
	if BuybackID[id]!=0 then
		call RemoveUnitFromStock(c,BuybackID[id])
	endif
	call AddUnitToStock(c,BuybackUnitId[DefineBuybackUnitIndex(lvl)],1,1)
	set BuybackID[id]=BuybackUnitId[DefineBuybackUnitIndex(lvl)]
	set Hero=null
	set c=null
endfunction

function GS9 takes nothing returns boolean
	if Mode_DM then
		return false
	endif
	call GR9(Sentinels[1])
	call GR9(Sentinels[2])
	call GR9(Sentinels[3])
	call GR9(Sentinels[4])
	call GR9(Sentinels[5])
	call GR9(Scourges[1])
	call GR9(Scourges[2])
	call GR9(Scourges[3])
	call GR9(Scourges[4])
	call GR9(Scourges[5])
	return false
endfunction

function GT9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer id=(LoadInteger(HY,h,34))
	local unit GQ9=CirclesOfPower[id]
	local unit Hero=udg_Hero[id]
	local integer Level=GetHeroLevel(Hero)
	local integer i=0
	call UnitRemoveAbility(GQ9,'A20U')//A20U -> Buyback Cooldown
	call AddUnitToStock(GQ9,BuybackUnitId[DefineBuybackUnitIndex(Level)],1,1)
	set BuybackID[id]=BuybackUnitId[DefineBuybackUnitIndex(Level)]
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set GQ9=null
	set Hero=null
	return false
endfunction

function GU9 takes player p returns nothing
	local integer id=GetPlayerId(p)
	local unit GQ9=CirclesOfPower[id]
	local unit Hero=udg_Hero[id]
	local integer Level=GetHeroLevel(Hero)
	local integer i=0
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call GJ9(Hero)
	loop
		exitwhen i>59
		call RemoveUnitFromStock(GQ9,BuybackUnitId[i])
		set i=i+1
	endloop
	call TriggerAddCondition(t,Condition(function GT9))
	call TriggerRegisterTimerEvent(t,420,false)
	call SaveInteger(HY,h,34,(id))
	set BuybackID[id]='h0D4'//h0D4 -> Revive Hero - Cooldown
	call UnitAddAbility(GQ9,'A20U')//A20U -> Buyback Cooldown
	call IssueImmediateOrderById(GQ9,852526)
	set Hero=null
	set GQ9=null
	set t=null
endfunction

function StorePlayersColorValues takes nothing returns nothing
	set PlayerColors_R[GetPlayerId(Sentinels[1])]=0
	set PlayerColors_G[GetPlayerId(Sentinels[1])]=66
	set PlayerColors_B[GetPlayerId(Sentinels[1])]=255
	set PlayerColors_R[GetPlayerId(Sentinels[2])]=48
	set PlayerColors_G[GetPlayerId(Sentinels[2])]=230
	set PlayerColors_B[GetPlayerId(Sentinels[2])]=185
	set PlayerColors_R[GetPlayerId(Sentinels[3])]=50
	set PlayerColors_G[GetPlayerId(Sentinels[3])]=0
	set PlayerColors_B[GetPlayerId(Sentinels[3])]=129
	set PlayerColors_R[GetPlayerId(Sentinels[4])]=255
	set PlayerColors_G[GetPlayerId(Sentinels[4])]=252
	set PlayerColors_B[GetPlayerId(Sentinels[4])]=1
	set PlayerColors_R[GetPlayerId(Sentinels[5])]=255
	set PlayerColors_G[GetPlayerId(Sentinels[5])]=50
	set PlayerColors_B[GetPlayerId(Sentinels[5])]=0
	set PlayerColors_R[GetPlayerId(Scourges[1])]=220
	set PlayerColors_G[GetPlayerId(Scourges[1])]=50
	set PlayerColors_B[GetPlayerId(Scourges[1])]=50
	set PlayerColors_R[GetPlayerId(Scourges[2])]=50
	set PlayerColors_G[GetPlayerId(Scourges[2])]=50
	set PlayerColors_B[GetPlayerId(Scourges[2])]=50
	set PlayerColors_R[GetPlayerId(Scourges[3])]=75
	set PlayerColors_G[GetPlayerId(Scourges[3])]=150
	set PlayerColors_B[GetPlayerId(Scourges[3])]=190
	set PlayerColors_R[GetPlayerId(Scourges[4])]=16
	set PlayerColors_G[GetPlayerId(Scourges[4])]=60
	set PlayerColors_B[GetPlayerId(Scourges[4])]=18
	set PlayerColors_R[GetPlayerId(Scourges[5])]=68
	set PlayerColors_G[GetPlayerId(Scourges[5])]=42
	set PlayerColors_B[GetPlayerId(Scourges[5])]=4
endfunction

function HK9 takes nothing returns nothing
	local integer VT8
	local integer VU8
	local integer i
	set udg_Colors[GetPlayerId(Sentinels[0])]="|c00ff0303"
	set udg_Colors[GetPlayerId(Sentinels[1])]="|c000042ff"
	set udg_Colors[GetPlayerId(Sentinels[2])]="|c001ce6b9"
	set udg_Colors[GetPlayerId(Sentinels[3])]="|c00540081"
	set udg_Colors[GetPlayerId(Sentinels[4])]="|c00fffc01"
	set udg_Colors[GetPlayerId(Sentinels[5])]="|c00ff8000"
	set udg_Colors[GetPlayerId(Scourges[0])]="|c0020c000"
	set udg_Colors[GetPlayerId(Scourges[1])]="|c00e55bb0"
	set udg_Colors[GetPlayerId(Scourges[2])]="|c00959697"
	set udg_Colors[GetPlayerId(Scourges[3])]="|c007ebff1"
	set udg_Colors[GetPlayerId(Scourges[4])]="|c00106246"
	set udg_Colors[GetPlayerId(Scourges[5])]="|c004e2a04"
	call SetPlayerColor(Sentinels[0],PLAYER_COLOR_RED)
	call SetPlayerColor(Sentinels[1],PLAYER_COLOR_BLUE)
	call SetPlayerColor(Sentinels[2],PLAYER_COLOR_CYAN)
	call SetPlayerColor(Sentinels[3],PLAYER_COLOR_PURPLE)
	call SetPlayerColor(Sentinels[4],PLAYER_COLOR_YELLOW)
	call SetPlayerColor(Sentinels[5],PLAYER_COLOR_ORANGE)
	call SetPlayerColor(Scourges[0],PLAYER_COLOR_GREEN)
	call SetPlayerColor(Scourges[1],PLAYER_COLOR_PINK)
	call SetPlayerColor(Scourges[2],PLAYER_COLOR_LIGHT_GRAY)
	call SetPlayerColor(Scourges[3],PLAYER_COLOR_LIGHT_BLUE)
	call SetPlayerColor(Scourges[4],PLAYER_COLOR_AQUA)
	call SetPlayerColor(Scourges[5],PLAYER_COLOR_BROWN)
	set VT8=1
	set VU8=5
	loop
		if GetPlayerSlotState(Sentinels[VT8])==PLAYER_SLOT_STATE_EMPTY then
			call SetPlayerName(Sentinels[VT8],GetObjectName('n0DH')+" "+I2S(VT8))//n0DH -> Player
		endif
		if GetPlayerSlotState(Scourges[VT8])==PLAYER_SLOT_STATE_EMPTY then
			call SetPlayerName(Scourges[VT8],GetObjectName('n0DH')+" "+I2S(5+VT8))//n0DH -> Player
		endif
		set VT8=VT8+1
		exitwhen VT8>VU8
	endloop
endfunction

function HM9 takes nothing returns nothing
	local integer i
	local integer k
	local integer HI9=125
	call SetUnitOwner(CirclesOfPower_1,Sentinels[1],false)
	call SetUnitOwner(CirclesOfPower_2,Sentinels[2],false)
	call SetUnitOwner(CirclesOfPower_3,Sentinels[3],false)
	call SetUnitOwner(CirclesOfPower_4,Sentinels[4],false)
	call SetUnitOwner(CirclesOfPower_5,Sentinels[5],false)
	call SetUnitOwner(CirclesOfPower_7,Scourges[1],false)
	call SetUnitOwner(CirclesOfPower_8,Scourges[2],false)
	call SetUnitOwner(CirclesOfPower_9,Scourges[3],false)
	call SetUnitOwner(CirclesOfPower_10,Scourges[4],false)
	call SetUnitOwner(CirclesOfPower_11,Scourges[5],false)
	set CirclesOfPower[GetPlayerId(Sentinels[1])]=CirclesOfPower_1
	set CirclesOfPower[GetPlayerId(Sentinels[2])]=CirclesOfPower_2
	set CirclesOfPower[GetPlayerId(Sentinels[3])]=CirclesOfPower_3
	set CirclesOfPower[GetPlayerId(Sentinels[4])]=CirclesOfPower_4
	set CirclesOfPower[GetPlayerId(Sentinels[5])]=CirclesOfPower_5
	set CirclesOfPower[GetPlayerId(Scourges[1])]=CirclesOfPower_7
	set CirclesOfPower[GetPlayerId(Scourges[2])]=CirclesOfPower_8
	set CirclesOfPower[GetPlayerId(Scourges[3])]=CirclesOfPower_9
	set CirclesOfPower[GetPlayerId(Scourges[4])]=CirclesOfPower_10
	set CirclesOfPower[GetPlayerId(Scourges[5])]=CirclesOfPower_11
	set i=1
	if GetLocalPlayer()==Player(i)then
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
	else
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
	endif
	set i=2
	if GetLocalPlayer()==Player(i)then
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
	else
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
	endif
	set i=3
	if GetLocalPlayer()==Player(i)then
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
	else
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
	endif
	set i=4
	if GetLocalPlayer()==Player(i)then
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
	else
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
	endif
	set i=5
	if GetLocalPlayer()==Player(i)then
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
	else
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
	endif
	set i=7
	if GetLocalPlayer()==Player(i)then
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
	else
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
	endif
	set i=8
	if GetLocalPlayer()==Player(i)then
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
	else
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
	endif
	set i=9
	if GetLocalPlayer()==Player(i)then
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
	else
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
	endif
	set i=10
	if GetLocalPlayer()==Player(i)then
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
	else
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
	endif
	set i=11
	if GetLocalPlayer()==Player(i)then
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
	else
		call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
	endif
	set i=1
	loop
		set k=GetPlayerId(Sentinels[i])
		set ItemSpawnX[k]=GetUnitX(CirclesOfPower[k])
		set ItemSpawnY[k]=GetUnitY(CirclesOfPower[k])
		set k=GetPlayerId(Scourges[i])
		set ItemSpawnX[k]=GetUnitX(CirclesOfPower[k])
		set ItemSpawnY[k]=GetUnitY(CirclesOfPower[k])
		set i=i+1
		exitwhen i>5
	endloop
endfunction

function HN9 takes unit XX8 returns boolean
	local integer ID=GetUnitTypeId(XX8)
	if ID=='n00V' or ID=='n00W' or ID=='n002' or ID=='n00X' or ID=='nC38' or ID=='n01K' or ID=='n009' then//n00V -> Arcane Sanctum, n00W -> Ancient Weaponry, n002 -> Supportive Vestments, n00X -> Enchanted Artifacts, nC38 -> Sena The Accessorizer, n01K -> Weapons Dealer, n009 -> Gateway Relics
		return true
	endif
	return false
endfunction

function HO9 takes nothing returns nothing
	if(GetOwningPlayer(GetEnumUnit())==Player(0))then
		call SetUnitOwner(GetEnumUnit(),Sentinels[0],false)
		if HN9(GetEnumUnit())==false then
			call SetUnitColor(GetEnumUnit(),ConvertPlayerColor(0))
		endif
	else
		call SetUnitOwner(GetEnumUnit(),Scourges[0],false)
		if HN9(GetEnumUnit())==false then
			call SetUnitColor(GetEnumUnit(),ConvertPlayerColor(6))
		endif
	endif
endfunction

function HP9 takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,Player(0),Condition(function ReturnTrue))
	call ForGroup(g,function HO9)
	call GroupClear(g)
	call GroupEnumUnitsOfPlayer(g,Player(6),Condition(function ReturnTrue))
	call ForGroup(g,function HO9)
	call KillGroup(g)
	set g=null
endfunction

function HR9 takes player p returns nothing
	local integer i=0
	local string HS9=GetPlayerName(p)
	local integer F69=StringLength(HS9)
	local integer HT9=F69
	loop
		exitwhen i==F69
		if SubString(HS9,i,i+1)=="("and SubString(HS9,i-1,i)==" "then
			set HT9=i-1
			call SetPlayerName(p,SubString(HS9,0,HT9))
			set i=F69
		else
			set i=i+1
		endif
	endloop
endfunction

function RemoveTrashFromNick takes string s returns string
	local integer i=0
	local integer length=StringLength(s)
	local string ss=""
	local string p
	loop
		exitwhen i==length
		set p=SubString(s,i,i+1)
		if i+1==length and p=="|" then
			set ss=ss+"||"
		else
			set ss=ss+p
		endif
		set i=i+1
	endloop
	return ss
endfunction

function InitForces takes nothing returns nothing
	local integer HV9
	local integer HW9
	local integer VT8
	local integer VU8
	local integer x=0
	local integer y=0
	local integer i
	local trigger t=null
	local location SpawnSent=GetRectCenter(gg_rct_Allpick_Sent)
	local location SpawnScourge=GetRectCenter(gg_rct_Allpick_Scourge)
	if GetPlayerState(Sentinels[0],PLAYER_STATE_OBSERVER)!=0 or GetPlayerState(Scourges[0],PLAYER_STATE_OBSERVER)!=0 then
		set udg_ObserverMode=true
		set Sentinels[0]=Player(13)
		set Scourges[0]=Player(14)
		set udg_Observer1=Player(0)
		set udg_Observer2=Player(6)
		set advancedTracking=GetPlayerName(udg_Observer1)=="ohsystem.net"
		call SetAllyColorFilterState(0)
		loop
			exitwhen x>5
			call SetPlayerAlliance(Player(0),Sentinels[x],ConvertAllianceType(0),true)
			call SetPlayerAlliance(Player(0),Sentinels[x],ConvertAllianceType(4),true)
			call SetPlayerAlliance(Player(0),Scourges[x],ConvertAllianceType(0),false)
			call SetPlayerAlliance(Player(0),Scourges[x],ConvertAllianceType(4),false)
			set x=x+1
		endloop
	endif
	call ForceAddPlayer(Force_Elfs,Sentinels[0])
	call ForceAddPlayer(Force_Elfs,Sentinels[1])
	call ForceAddPlayer(Force_Elfs,Sentinels[2])
	call ForceAddPlayer(Force_Elfs,Sentinels[3])
	call ForceAddPlayer(Force_Elfs,Sentinels[4])
	call ForceAddPlayer(Force_Elfs,Sentinels[5])
	call ForceAddPlayer(Force_Unds,Scourges[0])
	call ForceAddPlayer(Force_Unds,Scourges[1])
	call ForceAddPlayer(Force_Unds,Scourges[2])
	call ForceAddPlayer(Force_Unds,Scourges[3])
	call ForceAddPlayer(Force_Unds,Scourges[4])
	call ForceAddPlayer(Force_Unds,Scourges[5])
	call ForceAddPlayer(AllPlayers,Sentinels[1])
	call ForceAddPlayer(AllPlayers,Sentinels[2])
	call ForceAddPlayer(AllPlayers,Sentinels[3])
	call ForceAddPlayer(AllPlayers,Sentinels[4])
	call ForceAddPlayer(AllPlayers,Sentinels[5])
	call ForceAddPlayer(AllPlayers,Scourges[1])
	call ForceAddPlayer(AllPlayers,Scourges[2])
	call ForceAddPlayer(AllPlayers,Scourges[3])
	call ForceAddPlayer(AllPlayers,Scourges[4])
	call ForceAddPlayer(AllPlayers,Scourges[5])
	if udg_ObserverMode then
		call ForceAddPlayer(AllPlayers,Player(0))
		call ForceAddPlayer(AllPlayers,Player(6))
	endif
	set x=0
	set y=0
	loop
		exitwhen x>5
		loop
			exitwhen y>5
			if(x!=y)then
				call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(0),true)
				call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(1),true)
				call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(2),true)
				call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(3),true)
				call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(4),true)
				call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(5),true)
				call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(6),false)
				call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(7),false)
				call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(0),true)
				call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(1),true)
				call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(2),true)
				call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(3),true)
				call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(4),true)
				call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(5),true)
				call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(6),false)
				call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(7),false)
				call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(0),false)
				call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(1),false)
				call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(2),false)
				call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(3),false)
				call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(4),false)
				call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(5),false)
				call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(6),false)
				call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(7),false)
				call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(0),false)
				call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(1),false)
				call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(2),false)
				call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(3),false)
				call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(4),false)
				call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(5),false)
				call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(6),false)
				call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(7),false)
			endif
			set y=y+1
		endloop
		set y=0
		set x=x+1
	endloop
	call SetPlayerTeam(Sentinels[0],0)
	call SetPlayerTeam(Sentinels[1],0)
	call SetPlayerTeam(Sentinels[2],0)
	call SetPlayerTeam(Sentinels[3],0)
	call SetPlayerTeam(Sentinels[4],0)
	call SetPlayerTeam(Sentinels[5],0)
	call SetPlayerTeam(Scourges[0],1)
	call SetPlayerTeam(Scourges[1],1)
	call SetPlayerTeam(Scourges[2],1)
	call SetPlayerTeam(Scourges[3],1)
	call SetPlayerTeam(Scourges[4],1)
	call SetPlayerTeam(Scourges[5],1)
	call SetPlayerName(Sentinels[0],GetObjectName('n03N'))//n03N -> The Sentinel
	call SetPlayerName(Scourges[0],GetObjectName('n03O'))//n03O -> The Scourge
	call SetPlayerName(Neutrals,GetObjectName('n0E8'))//n0E8 -> Neutral Creeps
	call HM9()
	if(Sentinels[0]!=Player(0)or Scourges[0]!=Player(6))then
		call HP9()
	endif
	call HK9()
	set HW9=VO8(Force_Elfs)
	set HV9=VO8(Force_Unds)
	set VT8=1
	set VU8=5
	loop
		exitwhen VT8>VU8
		if(IsPlayer(Sentinels[VT8]))then
			call SetPlayerState(Sentinels[VT8],PLAYER_STATE_RESOURCE_GOLD,(4375/ HW9))
			call SetPlayerState(Sentinels[VT8],PLAYER_STATE_RESOURCE_LUMBER,0)
		endif
		if(IsPlayer(Scourges[VT8]))then
			call SetPlayerState(Scourges[VT8],PLAYER_STATE_RESOURCE_GOLD,(4375/ HV9))
			call SetPlayerState(Scourges[VT8],PLAYER_STATE_RESOURCE_LUMBER,0)
		endif
		set VT8=VT8+1
	endloop
	call SetPlayerHandicapXP(Sentinels[1],1)
	call SetPlayerHandicapXP(Sentinels[2],1)
	call SetPlayerHandicapXP(Sentinels[3],1)
	call SetPlayerHandicapXP(Sentinels[4],1)
	call SetPlayerHandicapXP(Sentinels[5],1)
	call SetPlayerHandicapXP(Scourges[1],1)
	call SetPlayerHandicapXP(Scourges[2],1)
	call SetPlayerHandicapXP(Scourges[3],1)
	call SetPlayerHandicapXP(Scourges[4],1)
	call SetPlayerHandicapXP(Scourges[5],1)
	call SetPlayerState(Sentinels[0],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Sentinels[1],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Sentinels[2],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Sentinels[3],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Sentinels[4],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Sentinels[5],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Scourges[0],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Scourges[1],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Scourges[2],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Scourges[3],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Scourges[4],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Scourges[5],PLAYER_STATE_GIVES_BOUNTY,0)
	call SetPlayerState(Neutrals,PLAYER_STATE_GIVES_BOUNTY,0)
	call W18()
	call StorePlayersColorValues()
	call HR9(Sentinels[1])
	call HR9(Sentinels[2])
	call HR9(Sentinels[3])
	call HR9(Sentinels[4])
	call HR9(Sentinels[5])
	call HR9(Scourges[1])
	call HR9(Scourges[2])
	call HR9(Scourges[3])
	call HR9(Scourges[4])
	call HR9(Scourges[5])
	set x=1
	loop
		exitwhen x>5
		if IsPlayer(Sentinels[x])then
			call PlacePickDummies(Sentinels[x])
		endif
		if IsPlayer(Scourges[x])then
			call PlacePickDummies(Scourges[x])
		endif
		set x=x+1
	endloop
	call RemoveLocation(SpawnSent)
	call RemoveLocation(SpawnScourge)
	set i=0
	loop
		set PlayerNames[i]=RemoveTrashFromNick(GetPlayerName(Player(i)))
		set PlayerNamesHashes[i]=StringHash(PlayerNames[i])
		set i=i+1
		exitwhen i==16
	endloop
	set t=null
	set SpawnSent=null
	set SpawnScourge=null
endfunction

function isDummyAbility takes integer id returns boolean
	return id=='A0ES' or id=='A43P' or id=='A0QN' or id=='A2TH' or id=='A21F' or id=='A21G' or id=='A21H' or id=='A1S9' or id=='A24A' or id=='A24B' or id=='A1S9' or id=='A06K' or id=='A1VG' or id=='A28Q' or id=='A1WF' or id=='A0T8' or id=='A0T7' or id=='A20N' or id=='A1Z2' or id=='A1Z3' or id=='A205' or id=='A14A' or id=='A269' or id=='A2KG' or id=='A21J' or id=='A27X' or id=='A28Y' or id=='A24E' or id=='A1ZH' or id=='A1WO' or id=='A1FQ' or id=='A0TE' or id=='A2JO' or id=='A2FX' or id=='A0MP' or id=='A2KE' or id=='A2KH' or id=='A2K9' or id=='A2JL' or id=='A2O2' or id=='A2MB' or id=='A21J' or id=='A2MC' or id=='A1NH' or id=='A2LI' or id=='A2TK' or id=='A1MO' or id=='A527' or id=='A528'//A0ES -> Empowering Haste, A43P -> Chakram End, A0QN -> Burning Spear, A2TH -> Stone Caller, A21F -> Pulse Nova, A21G -> Pulse Nova, A21H -> Pulse Nova turn off, A1S9 -> Release Poison, A24A -> Oscillate In, A24B -> Oscillate Out, A1S9 -> Release Poison, A06K -> Rot, A1VG -> War Club, A28Q -> Overcharge, A1WF -> Focused Detonate, A0T8 -> BIGHAND2New, A0T7 -> BIGHAND1New, A20N -> Icarus Dive End, A1Z2 -> Target Fire Spirits, A1Z3 -> Sun Ray, A205 -> Sun Ray Movement, A14A -> Power Treads, A269 -> Ring of Basilius, A2KG -> Ring of Aquila, A21J -> Ancestral Spirit, A27X -> Telekinesis Land, A28Y -> Hand of Midas, A24E -> Song of the Siren, A1ZH -> Medallion of Courage Container, A1WO -> Ring of Basilius Container, A1FQ -> MKB Spell Book, A0TE -> Orchid Spell Book, A2JO -> Fire Remnant, A2FX -> Chakram End, A0MP -> Mana Shield, A2KE -> Ring of Aquila Container, A2KH -> Refresher Container, A2K9 -> Linken Sphere Stat Bonus Container, A2JL -> Fire Remnant, A2O2 -> Trueshot Aura, A2MB -> Dark Rift, A21J -> Ancestral Spirit, A2MC -> Test of Faith, A1NH -> Unstable Concoction, A2LI -> Avatar, A1MO -> Urn of shadows, A528 -> |cffffcc00R|rearm - [|cffffcc00Level 1|r]","|cffffcc00R|rearm - [|cffffcc00Level 2|r]","|cffffcc00R|rearm - [|cffffcc00Level 3|r]
endfunction

function InitQuests takes nothing returns nothing
	call CreateQuestBJ(0,"TRIGSTR_50004","TRIGSTR_50005","ReplaceableTextures\\CommandButtons\\BTNSpy.blp")
	call CreateQuestBJ(0,"TRIGSTR_50006","TRIGSTR_50007","ReplaceableTextures\\CommandButtons\\BTNTome.blp")
	call CreateQuestBJ(0,"TRIGSTR_50008","TRIGSTR_50009","ReplaceableTextures\\CommandButtons\\BTNAmbush.blp")
//	call CreateQuestBJ(2,"TRIGSTR_50022","TRIGSTR_50023","ReplaceableTextures\\CommandButtons\\BTNSirenMirrorImage.blp")
//	call CreateQuestBJ(2,"TRIGSTR_50024","TRIGSTR_50025","ReplaceableTextures\\CommandButtons\\BTNTinyGrow.blp")
//	call CreateQuestBJ(2,"TRIGSTR_50020","TRIGSTR_50021","ReplaceableTextures\\CommandButtons\\BTNSlowPoison.blp")
//	call CreateQuestBJ(2,"TRIGSTR_50014","TRIGSTR_50015","ReplaceableTextures\\CommandButtons\\BTNOrbOfFrost.blp")
//	call CreateQuestBJ(2,"TRIGSTR_50016","TRIGSTR_50017","ReplaceableTextures\\CommandButtons\\BTNOrbOfLightning.blp")
//	call CreateQuestBJ(2,"TRIGSTR_50018","TRIGSTR_50019","ReplaceableTextures\\CommandButtons\\BTNOrbOfFire.blp")
//	call CreateQuestBJ(2,"TRIGSTR_50010","TRIGSTR_50011","ReplaceableTextures\\CommandButtons\\BTNSilencerSilence.blp")
//	call CreateQuestBJ(2,"TRIGSTR_50012","TRIGSTR_50013","ReplaceableTextures\\CommandButtons\\BTNSpellSteal2.blp")
endfunction

function GetCooldown takes integer id, integer lvl returns real
	if LoadBoolean(CooldownStorage,-id,0) then
		return LoadReal(CooldownStorage,-id,1)
	else
		return LoadReal(CooldownStorage,-id,lvl)
	endif
	return 0.
endfunction

function CooldownManipulationAct takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer id=LoadInteger(HY,h,0)
	local unit u=LoadUnitHandle(HY,h,0)
	if u!=null and id!=0 then
		if LoadTriggerHandle(CooldownStorage,GetHandleId(u),id)==t then//in case if hardcoded refresh used, there will be different trigger, so no refresh will come
			call RemoveSavedHandle(CooldownStorage,GetHandleId(u),id)
			if (id!='A0H0' or GetUnitCurrentOrder(u)!=852503) and (id!='A0SB' or GetUnitCurrentOrder(u)!=852514) then//not a casted sand storm or phase shift
				call RelearnAbility(u,id)
			endif
		endif
	endif
	call FlushChildHashtable(HY,h)
	call DestroyTrigger(t)
	set u=null
	set t=null
endfunction

function ReduceCooldown takes unit u, integer id, boolean percent, real change returns nothing
	local trigger t
	local integer h
	local integer hu=GetHandleId(u)
	local real firstTimeChanged
	local real currentTime=TimerGetElapsed(GlobalTimer)
	local real adjTime
	local real abilCD=GetCooldown(id,GetUnitAbilityLevel(u,id))
	if percent then
		set change=change*abilCD/100
	endif
	if change==0 then
		return
	endif
	call echo("Cooldown reducing: called for "+GetObjectName(id)+" for "+R2S(change)+" sec")
	if HaveSavedHandle(CooldownStorage,hu,id) then
		set t=LoadTriggerHandle(CooldownStorage,hu,id)
		set h=GetHandleId(t)
		set firstTimeChanged=LoadReal(HY,h,0)
		set adjTime=LoadReal(HY,h,1)
		call TriggerRegisterTimerEvent(t,RMaxIF(firstTimeChanged+adjTime-currentTime-change,0),false)
		call SaveReal(HY,h,1,adjTime+change)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(CooldownStorage,hu,id,t)
		call SaveInteger(HY,h,10,h)
		call TriggerRegisterTimerEvent(t,RMaxIF(abilCD-change,0),false)
		call TriggerAddCondition(t,Condition(function CooldownManipulationAct))
		call SaveInteger(HY,h,0,id)
		call SaveReal(HY,h,0,currentTime)
		call SaveReal(HY,h,1,RMaxIF(abilCD-change,0))
		call SaveUnitHandle(HY,h,0,u)
	endif
	set t=null
endfunction

function IX9 takes nothing returns boolean
	local string s
	if IsUnitIllusion(GetTriggerUnit())==false and GetUnitTypeId(GetTriggerUnit())!='H00J' then//H00J -> Geomancer
		set s=GetUnitName(GetTriggerUnit())+" "+GetObjectName('n0HB')+" "+GetObjectName(GetLearnedSkill())+" ("+GetObjectName('n0HC')+" "+I2S(GetLearnedSkillLevel())+")"//n0HB -> has skilled, n0HC -> level
		call DisplayTimedTextToPlayer(udg_Observer1,0,0,3,s)
		call DisplayTimedTextToPlayer(udg_Observer2,0,0,3,s)
	endif
	return false
endfunction

function IY9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
	call TriggerAddCondition(t,Condition(function IX9))
	set t=null
endfunction

function GetUnitPhysicalResistance_Compute takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=GetTriggerUnit()
	local real Damage=LoadReal(HY,h,20)
	local real RealDamage=GetEventDamage()
	local real ManaShieldRatio
	call HealUnitFor(u,RealDamage)
	if GetUnitAbilityLevel(u,'BNms')>0 then //Mana Shield//BNms -> Mana Shield
		set ManaShieldRatio=GetUnitAbilityLevel(u,'A0MP')*0.5//A0MP -> Mana Shield
		if GetUnitAbilityLevel(u,'A0MP')<3 then//A0MP -> Mana Shield
			set ManaShieldRatio=ManaShieldRatio+.25
		endif
		call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+RealDamage*.5/ManaShieldRatio)
	endif
	set GetUnitPhysicalResistance_Result=RealDamage/Damage
	call DestroyTrigger(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set u=null
	return false
endfunction

function GetUnitPhysicalResistance takes unit u returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real Damage=RMinBJ(20,GetWidgetLife(u)/2)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function GetUnitPhysicalResistance_Compute))
	call SaveReal(HY,h,20,Damage)
	set IsRealDamage=false
	call DamageTarget(u,u,2,Damage)
	set IsRealDamage=true
	set t=null
endfunction

function IZ9 takes nothing returns nothing
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,25.,(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|c00ff0303 "+GetObjectName('n02D')+"|r")//n02D -> has left the game
endfunction

function IA9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local player IB9=(LoadPlayerHandle(HY,h,78))
	local integer VT8=1
	local integer IC9
	local integer W98=GetPlayerState(IB9,PLAYER_STATE_RESOURCE_GOLD)
	if HeroHasBeenUnlocked[GetPlayerId(IB9)]==false and Mode_SO then
		if GetTriggerEvalCount(t)==1 then
			if IsPlayerAlly(GetLocalPlayer(),IB9) then
				call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,6,GetObjectName('n0J3'))//n0J3 -> If you want to utilize the leaver's hero items/gold, use -unlock. 
				call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,6,GetObjectName('n0JG'))//n0JG -> Once you do this you will no longer be able to swap that player slot with the enemy.
			endif
		endif
		return false
	endif
	if W98>20 then
		call SetPlayerState(IB9,PLAYER_STATE_RESOURCE_GOLD,0)
		set ReliableGold[GetPlayerId(IB9)]=0
		if IsSentinel(IB9)then
			set IC9=CountPlayersInForce(Force_Elfs)
		else
			set IC9=CountPlayersInForce(Force_Unds)
		endif
		if IsSentinel(IB9)then
			loop
				exitwhen VT8>5
				if IsPlayer(Sentinels[VT8])then
					call SetPlayerState(Sentinels[VT8],PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Sentinels[VT8],PLAYER_STATE_RESOURCE_GOLD)+W98/ IC9)
				endif
				set VT8=VT8+1
			endloop
		else
			loop
				exitwhen VT8>5
				if IsPlayer(Scourges[VT8])then
					call SetPlayerState(Scourges[VT8],PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Scourges[VT8],PLAYER_STATE_RESOURCE_GOLD)+W98/ IC9)
				endif
				set VT8=VT8+1
			endloop
		endif
	endif
	set t=null
	return false
endfunction

function I39 takes player IB9 returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SavePlayerHandle(HY,h,78,(IB9))
	call TriggerRegisterTimerEvent(t,2,true)
	call TriggerAddCondition(t,Condition(function IA9))
	set t=null
endfunction

function I69 takes player p returns nothing
	local multiboarditem mbitem=MultiboardGetItem(MainMB,XK7[GetPlayerId(p)],XJ7[GetPlayerId(p)])
	call MultiboardSetItemValue(mbitem,"|c00333333"+(PlayerNames[GetPlayerId((p))])+"|r")
	call MultiboardReleaseItem(mbitem)
	set mbitem=null
endfunction

function PlayerLeave_Act1 takes nothing returns nothing
	local integer HW9=CountPlayersInForce(Force_Elfs)
	local integer HV9=CountPlayersInForce(Force_Unds)
	local integer VT8
	local integer VU8
	local string Time
	local string name
	local unit Hero=udg_Hero[GetPlayerId(GetTriggerPlayer())]
	if Hero==null then
		set name=GetObjectName('n0EW')//n0EW -> No Hero
	else
		set name=GetUnitName(Hero)
	endif
	if(SecondsForTime<10)then
		set Time=I2S(MinutesForTime)+":0"+I2S(SecondsForTime)
	else
		set Time=I2S(MinutesForTime)+":"+I2S(SecondsForTime)
	endif
	if GameEnded==false then
		set LeftAt[GetPlayerId(GetTriggerPlayer())]="|c00555555"+Time+"|r"
		call RN8(GetPlayerId(GetTriggerPlayer()),true)
		call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,25.,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+" ("+name+")|r|c00ff0303 "+GetObjectName('n02D')+"|r")//n02D -> has left the game
		if(IsSentinel(GetTriggerPlayer()))then
			set VT8=1
			set VU8=5
			loop
				exitwhen VT8>VU8
				if(Sentinels[VT8]!=GetTriggerPlayer())then
					if(IsPlayer(Sentinels[VT8]))then
						call SetPlayerAllianceStateBJ(GetTriggerPlayer(),Sentinels[VT8],4)
					endif
				endif
				set VT8=VT8+1
			endloop
		else
			set VT8=1
			set VU8=5
			loop
				exitwhen VT8>VU8
				if(Scourges[VT8]!=GetTriggerPlayer())then
					if(IsPlayer(Scourges[VT8]))then
						call SetPlayerAllianceStateBJ(GetTriggerPlayer(),Scourges[VT8],4)
					endif
				endif
				set VT8=VT8+1
			endloop
		endif
		if IsSentinel(GetTriggerPlayer())or IsScourge(GetTriggerPlayer())then
			set LeaversCounter=LeaversCounter+1
		endif
		call Traffic_RegisterData("C"+"K"+I2S(PlayerCS[GetPlayerId(GetTriggerPlayer())])+"D"+I2S(CSDenies[GetPlayerId(GetTriggerPlayer())])+"N"+I2S((LoadInteger(HY,(400+GetPlayerId(GetTriggerPlayer())),79))),GetPlayerId(GetTriggerPlayer()))
		set ZE7=GetTriggerPlayer()
		call ExecuteFunc("I19")
		if Mode_SO then
			call CL8(GetTriggerPlayer())
		endif
		set IsPlayerLeftGame[GetPlayerId(GetTriggerPlayer())]=true
		call I69(GetTriggerPlayer())
		call I39(GetTriggerPlayer())
		if LeaversCounter==2 and udg_ObserverMode==false and BL then
			call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60," ")
			call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60," ")
			call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60,"|c006699CC"+GetObjectName('n0FW')+"|r")//n0FW -> Reminder: The -switch command can be used to rearrange the teams if everyone votes yes
		endif
	else
		set LeftAt[GetPlayerId(GetTriggerPlayer())]="|c00555555End|r"
		call ExecuteFunc("I59")
	endif
	set Hero=null
endfunction

function UnitRemoveAbility2 takes unit u, integer id returns boolean
	if GetUnitAbilityLevel(u,id)>0 then
		return UnitRemoveAbility(u,id)
	endif
	return false
endfunction

function RemoveEndlessFadetime takes unit u returns nothing
	if GetUnitAbilityLevel(u,'A40E')==1 then
		call UnitRemoveAbility(u,'A40E')
	endif
	if GetUnitAbilityLevel(u,'B09Y')==1 then//B09Y -> Phase
		call UnitRemoveAbility(u,'B09Y')//B09Y -> Phase
	endif
	if GetUnitAbilityLevel(u,'B3JQ')==1 then
		call UnitRemoveAbility(u,'B3JQ')
	endif
	
endfunction

function AntiMorphBugChecker takes unit u returns nothing
	local integer i
	if IsSentinel(GetOwningPlayer(u)) then
		call IssueTargetOrderById(u,ORDER_move,SentFountain)
	else
		call IssueTargetOrderById(u,ORDER_move,ScourgeFountain)
	endif
	call IssueImmediateOrderById(u,851972)
	if GetUnitCurrentOrder(u)==ORDER_move then
		call TriggerExecute(RecreationTrigger)
		call RemoveUnit(u)
//		call echo("bug fixed")
//	else
//		call echo("fine")
	endif
endfunction

function RemoveStuffFromHero takes unit Hero returns nothing
	local integer h=GetHandleId(Hero)
	call AntiMorphBugChecker(Hero)
	call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A11X',false)//A11X -> Blinding Light
	call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A10U',false)//A10U -> Recall
	call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A344',false)//A344 -> Battle Cry
	if GetOwningPlayer(Hero)==GetLocalPlayer()then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,1," ")
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,1,"|c006699CC"+GetObjectName('n0GR'))//n0GR -> Your hero has respawned
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,1," ")
	endif
	if LoadBoolean(HY,h,'suic') then
		call RemoveSavedBoolean(HY,h,'suic')
	endif
	call BY8(XE,GetOwningPlayer(Hero))
	call SetUnitState(Hero,UNIT_STATE_MANA,999999)
	if IsUnitHasAghanim(Hero) then
		call HeroAghanim(Hero,false)
	endif
	call SetUnitInvulnerable(Hero,false)
	call SetUnitPathing(Hero,true)
	call PauseUnit(Hero,false)
	call SetUnitFlyHeight(Hero,GetUnitDefaultFlyHeight(Hero),0)
	call SetUnitScale(Hero,U18(Hero),U18(Hero),U18(Hero))
	call RemoveDispellableBuffs(Hero)
	call PurgingTriggered(Hero,true)
	if LoadInteger(MHT,GetHandleId(Hero),'A32D')>0 then//A32D -> Digest Spit
		call SaveInteger(MHT,GetHandleId(Hero),'A32D',0)//A32D -> Digest Spit
		call SaveBoolean(MHT,GetHandleId(Hero),'A32D',false)//A32D -> Digest Spit
		call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A32D',false)//A32D -> Digest Spit
	endif
	call UnitRemoveAbility(Hero,'A3B2')
	call UnitRemoveAbility(Hero,'B3B2')//B3B2 -> Urn of Shadows
	
	
	call UnitRemoveAbility(Hero,'A40F')
	call UnitRemoveAbility(Hero,'A43N')//abun chakram 1
	call UnitRemoveAbility(Hero,'A43O')//abun chakram 2
	
	
	call UnitRemoveAbility(Hero,'A40E')//double hold invis
	call UnitRemoveAbility(Hero,'A349')//fury swipes
	call UnitRemoveAbility(Hero,'A348')//caustic finale
	call UnitRemoveAbility(Hero,'A347')//freezing field slow ?
	
	call UnitRemoveAbility(Hero,'A32H')//kodo drums bonus str
	call UnitRemoveAbility(Hero,'A32I')
	call UnitRemoveAbility(Hero,'A32J')
	call UnitRemoveAbility(Hero,'A32K')
	call UnitRemoveAbility(Hero,'A32L')
	call UnitRemoveAbility(Hero,'A32M')
	
	call UnitRemoveAbility(Hero,'A32N')
	call UnitRemoveAbility(Hero,'A32O')
	call UnitRemoveAbility(Hero,'A32P')
	call UnitRemoveAbility(Hero,'A32Q')
	call UnitRemoveAbility(Hero,'A32R')
	call UnitRemoveAbility(Hero,'A32S')
	
	call UnitRemoveAbility(Hero,'A021')//A021 -> Brood Permanent Invisibility
	call UnitRemoveAbility(Hero,'QINV')//Static storm upg inv
	
	call UnitRemoveAbility(Hero,'A313')//trackable abilities
	call UnitRemoveAbility(Hero,'A314')//trackable abilities
	call UnitRemoveAbility(Hero,'A315')//trackable abilities
	
	call UnitRemoveAbility(Hero,'A0AZ')//A0AZ -> Rot slow
	call UnitRemoveAbility(Hero,'A23F')//A23F -> Split Shot Spell Book
	
	call UnitRemoveAbility(Hero,'A21I')//A21I -> Shallow Grave
	call UnitRemoveAbility(Hero,'A0PV')//A0PV -> Tango Buff
	
	call UnitRemoveAbility(Hero,'A0RF')//A0RF -> Refraction Damage Bonus
	
	call UnitRemoveAbility(Hero,WS7)
	call UnitRemoveAbility(Hero,'A0I5')//A0I5 -> Berserker's Call Armor Bonus
	call UnitRemoveAbility(Hero,'A0IH')//A0IH -> Rupture
	call UnitRemoveAbility(Hero,'B08L')//B08L -> |cffff0000Rupture|r
	call UnitRemoveAbility(Hero,'A0SR')//A0SR -> Rage Attack Speed
	call UnitRemoveAbility(Hero,'A0WO')//A0WO -> God's Strength Container
	call UnitRemoveAbility(Hero,'A0WR')//A0WR -> Insatiable Hunger Container
	
	call UnitRemoveAbility(Hero,'A1CN')//A1CN -> Item Life Steal 175%
	
	call UnitRemoveAbility(Hero,'A147')//A147 -> Water Sword Container 1
	call UnitRemoveAbility(Hero,'A121')//A121 -> Illuminate End
	call UnitRemoveAbility(Hero,'A12D')//A126 -> Captain CoCo's Rum Container
	call UnitRemoveAbility(Hero,'A179')//A179 -> Spell Immunity
	call UnitRemoveAbility(Hero,'Aetl')//Aetl -> Ethereal
	
	call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[0])
	call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[1])
	call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[2])
	call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[3])
	call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[4])
	call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[5])
	
	call SaveBoolean(HY,(GetHandleId(Hero)),80,(false))
	
	
	call UnitRemoveAbility(Hero,'A1CA')//A1CA -> Natural Order 1
	call UnitRemoveAbility(Hero,'A1C9')//A1C9 -> Natural Order 2
	call UnitRemoveAbility(Hero,'A1CB')//A1CB -> Natural Order 3
	call UnitRemoveAbility(Hero,'A1CC')//A1CC -> Natural Order 4
	call UnitRemoveAbility(Hero,'A1GA')//A1GA -> Tree Invis Permanent Invisibility
	
	call UnitRemoveAbility(Hero,'A1UH')//Walrus crit
	
	call UnitRemoveAbility(Hero,'A23O')//A23O -> Nature's Guise Spell Book
	call UnitRemoveAbility(Hero,'B0E9')//B0E9 -> Nature's Guise
	call SetNegativeArmorSystem(Hero,0)
	
	set tt_unit1=Hero
	call ExecuteFunc("DK_DragonForm_ChangeTail")
	if LoadBoolean(MHT,GetHandleId(Hero),StringHash("morphedburn")) then
		call UnMorphUnit(Hero,LoadInteger(MHT,GetHandleId(Hero),StringHash("second")))
		call UnMorphUnit(Hero,LoadInteger(MHT,GetHandleId(Hero),StringHash("first")))
		call SaveBoolean(MHT,GetHandleId(Hero),StringHash("morphedburn"),false)
	endif
endfunction

function J79 takes nothing returns boolean
	if GetPlayerAlliance(GetOwningPlayer(GetFilterUnit()),SharedControlAlliesTempPlayer,ALLIANCE_SHARED_CONTROL) and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false then
		set SharedControlAlliesCount=SharedControlAlliesCount+1
	endif
	return false
endfunction

function J89 takes unit u,player p,real x,real y,boolean J99 returns nothing
	local group g=GetAvailableGroup()
	set SharedControlAlliesCount=0
	set SharedControlAlliesTempPlayer=p
	call GroupEnumUnitsSelected(g,p,Condition(function J79))
	if SharedControlAlliesCount==0 and GetLocalPlayer()==p then
		if J99==false then
			call ClearSelection()
			call SelectUnit(u,true)
		endif
		call PanCameraToTimed(x,y,0)
	endif
	set SharedControlAlliesCount=0
	call KillGroup(g)
	set g=null
endfunction

function IsClonedHero takes integer i returns boolean
	return i=='H00J' or i=='N0MM'//H00J -> Geomancer
endfunction

function IsFakeHero2 takes unit u returns boolean
	local integer i=GetUnitTypeId(u)
	return IsClonedHero(i) or i=='H07G' or i=='H00M' or i=='H0B8' or i=='H0DL' or i=='H00Y'//H00M -> Bloodrune, H0B8 -> Ice Blast, H0DL -> Ghost Revenant, H00Y -> Preloader Hero
endfunction

function JE9 takes unit JF9 returns nothing
	local integer JG9
	if FindItemOfType(JF9,Item_Real[bloodstone])!=null and GetUnitTypeId(JF9)!='H00J' then//H00J -> Geomancer
		set JG9=R2I(GetItemCharges(FindItemOfType(JF9,Item_Real[bloodstone]))*.67)
		if GetItemCharges(FindItemOfType(JF9,Item_Real[bloodstone]))==1 then
			set JG9=0
		endif
//		call SetItemCharges(FindItemOfType(JF9,Item_Real[bloodstone]),JG9)
//		call AddHeroXP(JF9,GetHeroXP(BloodstoneHeroes[GetPlayerId(GetOwningPlayer(JF9))]),true)
//		call RemoveUnit(BloodstoneHeroes[GetPlayerId(GetOwningPlayer(JF9))])
	endif
endfunction

function AntiInvulCheckFinal takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		call TriggerRegisterTimerEvent(t,0,false)
	else
		if GetWidgetLife(u)!=GetUnitState(u,UNIT_STATE_MAX_LIFE) then
			
		else
			call RemoveUnit(u)
		endif
	endif
	set t=null
	return false
endfunction

function AntiInvulCheck takes unit u returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function AntiInvulCheckFinal))
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call DamageTarget(u,u,1,1)
	set t=null
endfunction

function HeroRespawn takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local player p=GetOwningPlayer(u)
	local real x
	local real y
	local integer c
	local integer lvl
	set IsImpossibleToBuyback[GetPlayerId(GetOwningPlayer(u))]=false
	set IsHeroDead[GetPlayerId(GetOwningPlayer(u))]=false
	if IsSentinel(GetOwningPlayer(u))then
		set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
		set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
	else
		set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
		set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
	endif
	
	if advancedTracking then
		if TimerGetRemaining(HeroRespawnTimer[GetPlayerId(p)])>2 then
			call Traffic_RegisterData("LoD_HeroResp_"+I2S(GetPlayerId(p)),1)
		else
			call Traffic_RegisterData("LoD_HeroResp_"+I2S(GetPlayerId(p)),0)
		endif
	endif
	
	call TimerStart(HeroRespawnTimer[GetPlayerId(p)],.0,false,null)
	
	call J89(u,p,x,y,false)
	call SetUnitX(u,x)
	call SetUnitY(u,y)
	
	call RemoveStuffFromHero(u)//remove stuff from respawnd hero
	if FindItemOfType(u,Item_Real[bloodstone])!=null and GetUnitTypeId(u)!='H00J' then//H00J -> Geomancer
		set c=R2I(GetItemCharges(FindItemOfType(u,Item_Real[bloodstone]))*.67*1.)
		if GetItemCharges(FindItemOfType(u,Item_Real[bloodstone]))==1 then
			set c=0
		endif
		call SetItemCharges(FindItemOfType(u,Item_Real[bloodstone]),c)
		//call AddHeroXP(u,GetHeroXP(BloodstoneHeroes[GetPlayerId(GetOwningPlayer(u))]),true)
		//call RemoveUnit(BloodstoneHeroes[GetPlayerId(GetOwningPlayer(u))])
	endif
	if GetUnitAbilityLevel(u,'A2AI')>0 then//A2AI -> Dragon Tail
		call UnitRemoveAbility(u,'QF0O')
		call SetUnitAbilityLevel(u,'QB0G',GetUnitAbilityLevel(u,'A2AI'))//QB0G -> Dragon Tail, A2AI -> Dragon Tail
	endif
	call LoDStat_Set(u,0,"armourneg")
	call RemoveAbilsForUnit(u)
	//call AntiInvulCheck(u)
	set u=null
endfunction

function InitHeroAndSkillsRelated takes integer i, integer k returns nothing
	if(i==indexid_AM)then
		call PreloadUnit('h06K')//h06K -> Magina Dummy
	elseif i==Formless then
		call HideAbility('A40O')
		call HideAbility('A40P')
		call HideAbility('A40Q')
		call HideAbility('A40R')
	elseif i==Kotl then
		call HideAbility('A10U')//A10U -> Recall
		call HideAbility('A11X')//A11X -> Blinding Light
	elseif i==Bala then
		call ExecuteFunc("NIghtstalker_Passive_Global")
	elseif i==BS then
		set HeroInGame_BS=true
	elseif i==Earth then
		call ExecuteFunc("Kaolin_Stones_Reg")
	elseif(i==THD)then
		call ExecuteFunc("THD_DualBreath_Preload")
	elseif(i==Centaur)then
		call ExecuteFunc("Stampede_Init")
	elseif(i==ES)then
		call ExecuteFunc("ES_EchoSlam_Reg")
		call ExecuteFunc("AfterShock_Orbs") //This actually deals with Enchanted Totem, not aftershock... \:3/
	elseif(i==Enchantress)then
		call ExecuteFunc("KU9")
	elseif(i==Enigma)then
		call ExecuteFunc("KV9")
	elseif(i==Juggernaut)then
		call ExecuteFunc("K39")
	elseif i==BB then
		call HideAbility('A30P')
	elseif i==Medusa then
		call HideAbility('A419')
	elseif(i==Morphling)then
		call ExecuteFunc("MD9")
		call ExecuteFunc("MH9")
	elseif(i==OgreMagi)then
		call ExecuteFunc("MM9")//Multicast enemies
		call ExecuteFunc("MN9")//Multicast allies
	elseif i==Pugna then
		call HideAbility('A30D')
		call HideAbility('A30E')
		//call ExecuteFunc("Oblivion_Ward_Summon")
	elseif(i==PL)then
		call ExecuteFunc("MP9")
		call ExecuteFunc("MR9")
		call ExecuteFunc("PLPhantomRushReg")
	elseif(i==Sniper)then
		call ExecuteFunc("MB9")
	elseif(i==LoneDruid)then
		call ExecuteFunc("SpiritBear_Return_Init")
	elseif(i==Techies)then
		call ExecuteFunc("NF9")
		call ExecuteFunc("NG9")
	elseif(i==Bane)then
		call ExecuteFunc("N59")
	elseif(i==Brood)then
		call ExecuteFunc("OE9")
		call ExecuteFunc("Brood_RegisterSpinWebAppears")
	elseif(i==Pudge)then
		call ExecuteFunc("PG9")
	
	elseif(i==SK)then
		call ExecuteFunc("SK_Epicenter")
	elseif(i==Veno)then
		call ExecuteFunc("Venomancer_PlagueWard_Init")
	elseif(i==Visage)then
		call AddWrapper("FamiliarDamagedWrapper",0)
		call ExecuteFunc("Visage_Familiar_StoneForm")
		call ExecuteFunc("Visage_SoulAssumption_Reg")
		call ExecuteFunc("Visage_GravekeeperClock_Reg")
	elseif(i==Weaver)then
		call ExecuteFunc("Weaver_Swarm_Preload")
	elseif(i==Spectre)then
		call ExecuteFunc("Spectre_Dagger_Preload")
		call ExecuteFunc("Spectre_HauntReg")
	elseif(i==WD)then
		call ExecuteFunc("WD_DeathWard_Summon")
	elseif(i==indexid_DK)then
		call ExecuteFunc("DK_Tail_Preload")
	elseif(i==WL)then
		call ExecuteFunc("WL_Upheaval_Preload")
		call ExecuteFunc("WL_ShadowWord_Preload")
		call ExecuteFunc("WL_Infernal_Detect")
	elseif i==Dazzle then
		call ExecuteFunc("Dazzle_PoisonTouch_Preload")
	elseif i==Razor then
		call ExecuteFunc("Razor_EyeOfStorm_Init")
	elseif i==Pit then
		call ExecuteFunc("Pit_DarkRift_Preload")
	elseif i==Puck then
		call ExecuteFunc("Puck_PhaseShift_Init")
	elseif i==Queen then
		set HeroInGame_Queen=true
	elseif i==Slark then
		call ExecuteFunc("Slark_ShadowDance_Init")
	elseif i==Barathum then
		call ExecuteFunc("Spiritbreaker_EmpoweringHaste")
	elseif i==Lifestealer then
		call ExecuteFunc("Lifestealer_OpenWounds_Preload")
	elseif i==Admiral then
		call ExecuteFunc("Kunkka_Torrent_Preload")
	elseif i==WR then
		call ExecuteFunc("WR_Powershot_Endcast")
	elseif i==Batrider then
		call ExecuteFunc("Bat_Napalm_Preload")
	elseif i==indexid_AA then
		call ExecuteFunc("AA_Ulti_Preload")
	elseif i==Phoenix then
		call ExecuteFunc("Phoenix_Supernova_Preload")
	elseif i==Disruptor then
		call ExecuteFunc("Disruptor_Glimpse_Init")
	elseif i==Wisp then
		call ExecuteFunc("Wisp_Relocate_Init")
	elseif i==Tusk then
		call ExecuteFunc("Tusk_Sigil_Summon")
	elseif i==Pandaren then
		call ExecuteFunc("Pandaren_PrimalSplit_Summon")
	elseif i==Rubick then
		call ExecuteFunc("Rubick_Telekinez_Preload")
		call ExecuteFunc("Rubick_SpellSteal_Init")
	elseif i==Xin then
		call ExecuteFunc("Xin_SleightOfFist_Illusions")
		call ExecuteFunc("Xin_FireRemnantes_Init")
	elseif i==Legion then
//		call ExecuteFunc("Legion_PtA_Init")
	elseif i==Skywrath then
		call ExecuteFunc("Skywrath_Ulti_init")
	elseif i==Timber then
		call ExecuteFunc("Timber_Chakram_Preload")
	endif
endfunction

function V79 takes player whichPlayer,string Y38 returns nothing
	if IsPlayerInForce(GetLocalPlayer(),S58(whichPlayer))then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,40,udg_Colors[GetPlayerId(whichPlayer)]+(PlayerNames[GetPlayerId((whichPlayer))])+"|r "+Y38)
	endif
endfunction

function V89 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	set QM=true
	call CleanTrigger(t)
	call DestroyFogModifier(CreateFogModifierRadius(Sentinels[0],FOG_OF_WAR_MASKED,-6950,6750,700,false,false))
	call DestroyFogModifier(CreateFogModifierRadius(Scourges[0],FOG_OF_WAR_MASKED,-6950,6750,700,false,false))
	set t=null
	return false
endfunction

function V99 takes unit u returns boolean
	return GetUnitTypeId(u)!='H00M' and GetUnitTypeId(u)!='H07G' and GetUnitTypeId(u)!='H00Y' and GetUnitTypeId(u)!='H00J' and GetUnitTypeId(u)!='H0B8'//H00M -> Bloodrune, H07G -> Storm Spirit unused, H00Y -> Preloader Hero, H00J -> Geomancer, H0B8 -> Ice Blast
endfunction

function VD9 takes nothing returns boolean
	return(IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) and LoadBoolean(HY,GetHandleId(GetTriggerUnit()),TEMPEST)==false and HaveSavedBoolean(HY,GetHandleId(GetTriggerUnit()),85)==false and V99(GetTriggerUnit()) and b_isPickTime==false)!=null
endfunction

function VE9 takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())=='n00C' then//n00C -> Zone Indicator
		call KillUnit(GetFilterUnit())
	endif
	return false
endfunction

function VG9 takes player p returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,p,Condition(function VE9))
	call KillGroup(g)
	set g=null
endfunction

function VJ9 takes nothing returns boolean
	return GetUnitTypeId(GetFilterUnit())=='ncop'
endfunction

function VK9 takes nothing returns nothing
	if Mode_SD then
		call UnitRemoveAbility(CirclesOfPower[GetPlayerId(GetOwningPlayer(GetEnumUnit()))],'A14F')
		call UnitRemoveAbility(CirclesOfPower[GetPlayerId(GetOwningPlayer(GetEnumUnit()))],'A14E')
		call UnitRemoveAbility(CirclesOfPower[GetPlayerId(GetOwningPlayer(GetEnumUnit()))],'A14H')
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A0I4')==0 then
		call UnitAddAbility(GetEnumUnit(),'A0I4')
	endif
endfunction

function VM9 takes player p returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,p,Condition(function VJ9))
	call ForGroup(g,function VK9)
	call KillGroup(g)
	set g=null
endfunction

function UpdateSkillPickingMB_Switch takes nothing returns nothing
	local integer i=0
	local integer d=0
	local multiboarditem mi
	local integer add=0
	local string s=""
	local real width=.12
	if SentinelsIngame!=0 then
		set i=4+NumberOfExtraAbilities
		set d=1
		loop
			set mi=MultiboardGetItem(AbilityDraftMultiboard,d,i)
			call MultiboardSetItemValue(mi,TabTab+udg_Colors[GetPlayerId(Sents[d])]+PlayerNames[GetPlayerId(Sents[d])]+"|r")
			call MultiboardReleaseItem(mi)
			set d=d+1
			exitwhen d==SentinelsIngame+1
		endloop
	endif
	if ScourgesIngame!=0 then
		set i=4+NumberOfExtraAbilities
		set d=2+SentinelsIngame
		loop
			set mi=MultiboardGetItem(AbilityDraftMultiboard,d,i)
			call MultiboardSetItemValue(mi,TabTab+udg_Colors[GetPlayerId(Scrgs[d-1-SentinelsIngame])]+PlayerNames[GetPlayerId(Scrgs[d-1-SentinelsIngame])]+"|r")
			set d=d+1
			call MultiboardReleaseItem(mi)
			exitwhen d==SentinelsIngame+ScourgesIngame+2
		endloop
	endif
	set mi=null
endfunction

function VO9 takes nothing returns nothing
	local integer i=0
	local integer d=0
	local multiboarditem mi
	local integer add=0
	local string s=""
	local real width=.12
	set AbilityDraftMultiboard=CreateMultiboard()
	if Mode_Debug then
		set SentinelsIngame=5
		set ScourgesIngame=5
	endif
	
	call MultiboardSetRowCount(AbilityDraftMultiboard,2+SentinelsIngame+ScourgesIngame)
	call MultiboardSetColumnCount(AbilityDraftMultiboard,5+NumberOfExtraAbilities)
	call MultiboardSetItemsWidth(AbilityDraftMultiboard,.015)
	call MultiboardSetTitleText(AbilityDraftMultiboard,"-"+StringCase(ModeForTitle,true))
	call MultiboardSetItemsStyle(AbilityDraftMultiboard,false,true)
	loop
		set mi=MultiboardGetItem(AbilityDraftMultiboard,0,i)
		call MultiboardSetItemStyle(mi,true,false)
		if i==0 then
			call MultiboardSetItemWidth(mi,width)
			call MultiboardSetItemValue(mi,"|c00FF0303The Sentinel|r")
		endif
		call MultiboardReleaseItem(mi)
		set i=i+1
		exitwhen i==MultiboardGetColumnCount(AbilityDraftMultiboard)
	endloop
	set i=0
	loop
		set mi=MultiboardGetItem(AbilityDraftMultiboard,1+SentinelsIngame,i)
		call MultiboardSetItemStyle(mi,true,false)
		if i==0 then
			call MultiboardSetItemWidth(mi,width)
			call MultiboardSetItemValue(mi,"|c0020C000The Scourge|r")
		endif
		call MultiboardReleaseItem(mi)
		set i=i+1
		exitwhen i==MultiboardGetColumnCount(AbilityDraftMultiboard)
	endloop
	if SentinelsIngame!=0 then
		set i=0
		set d=1
		loop
			set mi=MultiboardGetItem(AbilityDraftMultiboard,d,i)
			if i==(4+NumberOfExtraAbilities) then
				call MultiboardSetItemStyle(mi,true,false)
				call MultiboardSetItemWidth(mi,width)
				call MultiboardSetItemValue(mi,TabTab+udg_Colors[GetPlayerId((Sents[d]))]+PlayerNames[GetPlayerId((Sents[d]))]+"|r")
			else
				call MultiboardSetItemStyle(mi,false,true)
				call MultiboardSetItemIcon(mi,SkillIcon[0])
			endif
			set i=i+1
			if i>(5+NumberOfExtraAbilities) then
				set d=d+1
				set i=0
			endif
			call MultiboardReleaseItem(mi)
			exitwhen d==SentinelsIngame+1
		endloop
	endif
	if ScourgesIngame!=0 then
		set i=0
		set d=2+SentinelsIngame
		loop
			set mi=MultiboardGetItem(AbilityDraftMultiboard,d,i)
			if i==4+NumberOfExtraAbilities then
				call MultiboardSetItemStyle(mi,true,false)
				call MultiboardSetItemWidth(mi,width)
				call MultiboardSetItemValue(mi,TabTab+udg_Colors[GetPlayerId((Scrgs[d-1-SentinelsIngame]))]+PlayerNames[GetPlayerId((Scrgs[d-1-SentinelsIngame]))]+"|r")
			else
				call MultiboardSetItemStyle(mi,false,true)
				call MultiboardSetItemIcon(mi,SkillIcon[0])
			endif
			set i=i+1
			if i>(5+NumberOfExtraAbilities) then
				set d=d+1
				set i=0
			endif
			call MultiboardReleaseItem(mi)
			exitwhen d==SentinelsIngame+ScourgesIngame+2
		endloop
	endif
	call MultiboardMinimize(AbilityDraftMultiboard,false)
	call MultiboardDisplay(AbilityDraftMultiboard,true)
	set mi=null
endfunction

function VP9 takes unit u,player p returns nothing
	local integer PlayerId=GetPlayerId(p)
	local integer xx=0
	local integer learn
	local integer picked
	local integer id
	set xx=1
	loop
		if PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]!=0 then
			set picked = PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]
			set id=SkillID[picked]
			set learn = EngineeringUpgradeSkillID[picked]
			call UnitAddAbility2(u,learn)
			call SetPlayerAbilityAvailable(p,learn,false)
		endif
		set xx=xx+1
		exitwhen xx>4
	endloop
endfunction

function GetCorrectIdForVisSkill takes integer id returns integer
	local integer k
	if id=='A343' then
		call PreloadAbilityInstant('A0Z6')
	endif
	if id=='A40B' then//A40B -> Bloodlust
		return 'A083'//A083 -> Bloodlust
	endif
	if id=='A0FU' then//A0FU -> Presence of the Dark Lord
		return 'QF00'//QF00 -> Presence of the Dark Lord
	endif
	if id=='A0KX' then//A0KX -> Morph
		return 'QF87'//QF87 -> Morph
	endif
	if id=='A0OO' then//A0OO -> Call of the Wild
		return 'A302'//A302 -> Call of the wild
	endif
	if id=='A0LV' then//A0LV -> Test of Faith
		return 'A46A'//A46A -> Test of Faith skill pick phase only
	endif
	if id=='Q0BK' then
		return 'QP29'
	endif
	if id=='QF88'then
		return 'A0VC'
	endif
	if id=='A46E' then//A46E -> Phantom Rush
		return 'A46D'//A46D -> Phantom Rush Inactive
	endif
	set k=GetPassiveLearnNumber(id)
	if k>0 and PassivesLearningSkillUpg[k]>0 then
		return PassivesLearningSkillUpg[k]
	endif
	return id
endfunction

function GetColorName takes integer i returns string
 if i==1 then
  return "|c000042FFblue"
 elseif i==2 then
  return "|c001ce6b9teal"
 elseif i==3 then
  return "|c00540081purple"
 elseif i==4 then
  return "|c00fffc01yellow"
 elseif i==5 then
  return "|c00ff8000orange"
 elseif i==7 then
  return "|c00e55bb0pink"
 elseif i==8 then
  return "|c00959697gray"
 elseif i==9 then
  return "|c007ebff1lightblue"
 elseif i==10 then
  return "|c00106246darkgreen"
 elseif i==11 then
  return "|c004e2a04brown"
 endif
 return ""
endfunction

function VQ9 takes unit u,integer pid, unit tavern returns nothing
	local integer VR9=(GetUnitPointValue(u)*4)-4
	local integer xx=0
	local integer RG8
	local integer id1=VR9+1
	local integer id2=VR9+2
	local integer id3=VR9+3
	local integer id4=VR9+4
	local integer fixjump=0
	local integer array ids
	local boolean available=true
	local integer uid=GetUnitTypeId(u)
	set ids[1]=VR9+1
	set ids[2]=VR9+2
	set ids[3]=VR9+3
	set ids[4]=VR9+4
	set SelectedSkillHeroPointValue[pid]=GetUnitPointValue(u)
	call RemoveUnit(u)
	call SetPlayerState(Player(pid),PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Player(pid),PLAYER_STATE_RESOURCE_GOLD)+250)
	if Mode_SD or Mode_MD then
		set available=LoadBoolean(HY,GetHandleId(Player(pid)),uid)
		//b_HeroAvailableForPlayer[pid*NumberOfHeroes+SelectedSkillHeroPointValue[pid]]
		if not available then
			call DisplayWithoutClear(Player(pid),true,"These are your allies' spells, you can't pick them. Your spells are located in the "+GetColorName(pid)+"|c006699CC taverns|r")
			
		endif
//		if b_HeroAvailableForPlayer[pid*NumberOfHeroes+SelectedSkillHeroPointValue[pid]]==false then
//			call Error(Player(pid),"Not your hero.")
//			return
//		endif
	endif
	call FlushChildHashtable(HY,GetHandleId(SpellPickingDummy[pid]))
	call RemoveUnit(SpellPickingDummy[pid])
	set SpellPickingDummy[pid]=CreateUnit(Player(pid),'hfoo',GetRectMaxX(bj_mapInitialPlayableArea),GetRectMinY(bj_mapInitialPlayableArea),.0)//hfoo ->  
	//call IssueImmediateOrderById(SpellPickingDummy[pid],852000)
	call SaveUnitHandle(HY,GetHandleId(SpellPickingDummy[pid]),0,tavern)
	if Mode_Debug then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,20.,"Hero Number: "+I2S(GetUnitPointValue(u)))
		call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,20.,"Skill #1 number: "+I2S(id1))
		call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,20.,"Skill #2 number: "+I2S(id2))
		call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,20.,"Skill #3 number: "+I2S(id3))
		call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,20.,"Skill #4 number: "+I2S(id4))
	endif
	if IsSentinel(Player(pid)) then
		set RG8=1
	else
		set RG8=2
	endif
	set xx=1
	loop
		if IsAbilityDoesNotWork[VR9+xx]==false then
			set fixjump=SkillID[VR9+xx]
			set fixjump=GetCorrectIdForVisSkill(fixjump)
			call UnitAddAbility(SpellPickingDummy[pid],fixjump)
			call SetUnitAbilityLevel(SpellPickingDummy[pid],fixjump,4)
			if CheckStacking(VR9+xx,-1,"melee only",null) then
				call UnitAddAbility(SpellPickingDummy[pid],'Z020'+xx-1)//Z020 -> |c00FF8080Melee Only|r
			elseif CheckStacking(VR9+xx,-1,"range only",null) then
				call UnitAddAbility(SpellPickingDummy[pid],'Z024'+xx-1)//Z024 -> |c0080FF80Ranged Only|r
			elseif CheckStacking(VR9+xx,-1,"melee morph",null) then
				call UnitAddAbility(SpellPickingDummy[pid],'Z030'+xx-1)//Z030 -> |c00FF8000Melee Morph|r
			elseif CheckStacking(VR9+xx,-1,"range morph",null) then
				call UnitAddAbility(SpellPickingDummy[pid],'Z034'+xx-1)//Z034 -> |c00FFFF00Ranged Morph|r
			endif
			if available then
				if(isPlayerPickedAbility(Player(pid),ids[xx])==false)then
					if Mode_OS then
						if OneSkillCheckArray[RG8*OneSkillOffsetCheck+ids[xx]]==0 then
							call UnitAddAbility(SpellPickingDummy[pid],'Z000'+xx-1)//Z000 -> Select skill
						else
							call UnitAddAbility(SpellPickingDummy[pid],'Z010'+xx-1)//Z010 -> Closed skill
						endif
					else
						call UnitAddAbility(SpellPickingDummy[pid],'Z000'+xx-1)//Z000 -> Select skill
					endif
				else
					call UnitAddAbility(SpellPickingDummy[pid],'Z004'+xx-1)//Z004 -> Remove Skill
				endif
			else
				call UnitAddAbility(SpellPickingDummy[pid],'Z01A'+xx-1)
			endif
			
		else
			if available then
				call UnitRemoveAbility(SpellPickingDummy[pid],'Z000'-1+xx)//Z000 -> Select skill
				call UnitAddAbility(SpellPickingDummy[pid],'Z014'-1+xx)//Z014 -> Unavailable skill
			endif
		endif
		set xx=xx+1
		exitwhen xx>4
	endloop
	call ClearSelectionForPlayer(Player(pid))
	call SelectUnitAddForPlayer(SpellPickingDummy[pid],Player(pid))
endfunction

function VS9 takes nothing returns nothing
	call MultiboardDisplay(MainMB,false)
	call VO9()
	call SuspendTimeOfDay(true)
	call DisableTrigger(HeroEnters)
endfunction

function SmoothLvlup_B takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	local integer lvl=LoadInteger(HY,GetHandleId(t),0)
	if lvl>0 then
		call SetHeroLevel(u,GetHeroLevel(u)+1,LoadBoolean(HY,GetHandleId(t),0))
		call SaveInteger(HY,GetHandleId(t),0,lvl-1)
	else
		call AddHeroXP(u,IMaxIF(LoadInteger(HY,GetHandleId(t),1)-GetHeroXP(u),0),LoadBoolean(HY,GetHandleId(t),0))
		call CleanTimer(t)
	endif
	set u=null
	set t=null
endfunction

function SmoothLvlup takes unit u, integer lvl, boolean visuals, integer xp returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.01,true,function SmoothLvlup_B)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call SaveInteger(HY,GetHandleId(t),0,lvl)
	call SaveInteger(HY,GetHandleId(t),1,xp)
	call SaveBoolean(HY,GetHandleId(t),0,visuals)
	set t=null
endfunction

function HidePassivesFunction takes player p, boolean forced returns nothing
	local integer i=1
	local integer k
	local integer lvl
	local boolean b
	if forced==false then
		set b=HidePassivesForPlayer[GetPlayerId(p)]
		set HidePassivesForPlayer[GetPlayerId(p)]=not b
	else
		set b=not HidePassivesForPlayer[GetPlayerId(p)]
	endif
	if forced==false then
		if b==false then
			call DisplayTimedTextToPlayer(p,0,0,TxtDur[GetPlayerId(GetLocalPlayer())],"|cffff0000[SP]|r |c006699CCHiding Passives.|r")
		else
			call DisplayTimedTextToPlayer(p,0,0,TxtDur[GetPlayerId(GetLocalPlayer())],"|cffff0000[SP]|r |c006699CCShowing Passives.|r")
		endif
	endif
	if b_isPickTime then
		return
	endif
	loop
		call SetPlayerAbilityAvailable(p,PassivesLearningSkillUpg[i],b)
		set i=i+1
		exitwhen i>PassivesCount
	endloop
	call SetPlayerAbilityAvailable(p,'A13T',b)//tidebringer//A13T -> Tidebringer
	call SetPlayerAbilityAvailable(p,'A0CQ',b)//necromastery//A0CQ -> Necromastery Effect
	call SetPlayerAbilityAvailable(p,'A1IQ',b)//jinada//A1IQ -> Jinada
	call SetPlayerAbilityAvailable(p,'A0BM',b)//brood bite
	call SetPlayerAbilityAvailable(p,'A46D',b)//phantom rush//A46D -> Phantom Rush Inactive
	call SetPlayerAbilityAvailable(p,'A1O8',b)//visage's stuff
	call SetPlayerAbilityAvailable(p,'A1O7',b)
	call SetPlayerAbilityAvailable(p,'A1O6',b)
	call SetPlayerAbilityAvailable(p,'A1O3',b)
	call SetPlayerAbilityAvailable(p,'A1O2',b)
	call SetPlayerAbilityAvailable(p,'A1O1',b)
	call SetPlayerAbilityAvailable(p,'A1O0',b)
	call SetPlayerAbilityAvailable(p,'A1NZ',b)
	call SetPlayerAbilityAvailable(p,'A1NY',b)
	call SetPlayerAbilityAvailable(p,'A1N9',b)
endfunction

function IsUnitPickingStuff takes nothing returns nothing
	if GetUnitTypeId(GetFilterUnit())=='ntav' then
		if IsSentinel(GetOwningPlayer(GetFilterUnit())) then
			call TimedReveal(Scourges[0],1,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()),400)
		else
			call TimedReveal(Sentinels[0],1,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()),400)
		endif
		call UnitRemoveAbility(GetFilterUnit(),'A1HX')
		call ShowUnit(GetFilterUnit(),false)
	elseif GetUnitTypeId(GetFilterUnit())=='n12C' then
		if GetLocalPlayer()==GetOwningPlayer(GetFilterUnit()) then
			call SetUnitVertexColor(GetFilterUnit(),255,255,255,0)
		endif
	endif
endfunction

function ResetPickTaverns takes player p returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,p,Condition(function IsUnitPickingStuff))
	call KillGroup(g)
endfunction

function DM_TransferItems takes unit from, unit to returns nothing
	call UnitAddItem(to,UnitItemInSlot(from,0))
	call UnitAddItem(to,UnitItemInSlot(from,1))
	call UnitAddItem(to,UnitItemInSlot(from,2))
	call UnitAddItem(to,UnitItemInSlot(from,3))
	call UnitAddItem(to,UnitItemInSlot(from,4))
	call UnitAddItem(to,UnitItemInSlot(from,5))
endfunction

function HeroEntersMap takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local player p=GetOwningPlayer(u)
	local real x
	local real y
	local region r=CreateRegion()
	local player p2=p
	local item it
	local unit Hero=u
	local trigger t
	local integer xx
	local integer pid=GetPlayerId(p)
	local integer id
	local string dbg=""
	if Mode_Debug then
		call SetHeroLevel(u,25,false)
		call SetPlayerState(GetOwningPlayer(u),PLAYER_STATE_RESOURCE_GOLD,100000)
	endif
	call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A11X',false)//A11X -> Blinding Light
	call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A10U',false)//A10U -> Recall
	call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A34C',false)//A34C -> Battle Cry
	call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A344',false)//A344 -> Battle Cry
	
	
	
	if s_MainMode=="ap" then
		call VP9(u,p)
	elseif s_MainMode=="sd" then
		call VP9(u,p)
	elseif s_MainMode=="md" then
		call VP9(u,p)
	elseif s_MainMode=="ar" then
		call SaveUnitHandle(HY,'hRUT',1,u)
		call ExecuteFunc("VV9")
		call DisplayTimedTextToPlayer(p,0,0,15,"|cff99ccff Your spells:|r")
		set xx=1
		set dbg=GetPlayerName(p)+": "
		loop
			set id=PlayerSkillNumber[pid*PlayerSkillOffset+xx]
			if id>600 then
				call DisplayTimedTextToPlayer(p,0,0,15,"	"+GetObjectName(SkillID[id])+"|cffffcc00 (Invoker)|r")
			else
				if xx==4 or xx==6 then
					call DisplayTimedTextToPlayer(p,0,0,15,"	"+"|c00ff0303"+GetObjectName(SkillID[id])+"|r"+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
					set dbg=dbg+GetObjectName(SkillID[id])+", "
				else
					call DisplayTimedTextToPlayer(p,0,0,15,"	"+GetObjectName(SkillID[id])+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
					set dbg=dbg+GetObjectName(SkillID[id])+", "
				endif
			endif
			set xx=xx+1
			exitwhen xx>4+NumberOfExtraAbilities
		endloop
	elseif s_MainMode=="rd"then
		call VP9(u,p)
		call DisplayTimedTextToPlayer(p,0,0,15,"|cff99ccff Your spells:|r")
		set xx=1
		loop
			set id=PlayerSkillNumber[pid*PlayerSkillOffset+xx]
			if xx==4 or xx==6 then
				call DisplayTimedTextToPlayer(p,0,0,15,"	"+"|c00ff0303"+GetObjectName(SkillID[id])+"|r"+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
			else
				call DisplayTimedTextToPlayer(p,0,0,15,"	"+GetObjectName(SkillID[id])+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
			endif
			set xx=xx+1
			exitwhen xx>4+NumberOfExtraAbilities
		endloop
	endif
//	if HidePassivesForPlayer[pid] then
//		call HidePassivesFunction(p)
//	endif
	
	
	set PlayerHaveHero[pid]=true
	if GetUnitAbilityLevel(u,'Y253')>0 then
		call DisplayTimedTextToPlayer(p,0,0,15,"|c00ff0000Passives acquired through Devour are automatically hidden.|r")
	endif
	if Mode_DM==false then
		call GR9(GetOwningPlayer(u))
	endif
	if QM==false and(udg_Hero[GetPlayerId(Sentinels[1])]!=null and udg_Hero[GetPlayerId(Sentinels[2])]!=null and udg_Hero[GetPlayerId(Sentinels[3])]!=null and udg_Hero[GetPlayerId(Sentinels[4])]!=null and udg_Hero[GetPlayerId(Sentinels[5])]!=null and udg_Hero[GetPlayerId(Scourges[1])]!=null and udg_Hero[GetPlayerId(Scourges[2])]!=null and udg_Hero[GetPlayerId(Scourges[3])]!=null and udg_Hero[GetPlayerId(Scourges[4])]!=null and udg_Hero[GetPlayerId(Scourges[5])]!=null)then
		set t=CreateTrigger()
		call TriggerRegisterTimerEvent(t,7,false)
		call TriggerAddCondition(t,Condition(function V89))
		set t=null
	endif
	set IsHeroDead[GetPlayerId(GetOwningPlayer((u)))]=false
	call RegionAddRect(r,Rect(-7584.,6176.,-6304.,7552.))
	if IsSentinel(GetOwningPlayer(u))then
		if IsUnitInRegion(r,u)then
			set x=GetRandomReal(GetRectMinX(gg_rct_Hero_Creation_NE),GetRectMaxX(gg_rct_Hero_Creation_NE))
			set y=GetRandomReal(GetRectMinY(gg_rct_Hero_Creation_NE),GetRectMaxY(gg_rct_Hero_Creation_NE))
		else
			set x=GetUnitX(u)
			set y=GetUnitY(u)
		endif
	else
		if IsUnitInRegion(r,u)then
			set x=GetRandomReal(GetRectMinX(gg_rct_Hero_Creation_UD),GetRectMaxX(gg_rct_Hero_Creation_UD))
			set y=GetRandomReal(GetRectMinY(gg_rct_Hero_Creation_UD),GetRectMaxY(gg_rct_Hero_Creation_UD))
		else
			set x=GetUnitX(u)
			set y=GetUnitY(u)
		endif
	endif
	set HasAlreadyPickedHero[pid]=true
	
	if BB7==false and Mode_CD==false then
		call PanCameraToTimedForPlayer(p,x,y,0)
	endif
	call ClearSelectionForPlayer(p)
	call SelectUnitAddForPlayer(u,p)
	call SetUnitX(u,x)
	call SetUnitY(u,y)
	set udg_Hero[pid]=u
	set HeroTypeId[pid]=GetUnitTypeId(u)
	call SaveInteger(HY,GetPlayerId(GetOwningPlayer(u)),'hHid',GetUnitPointValue(u))
	call Traffic_RegisterPlayerData(p,"9",HeroTypeId[pid])
	call VS8(p)
	call SaveBoolean(HY,(GetHandleId(u)),85,(true))
	if Mode_DU==false and b_isPickTime==false and tt_bool1==false then
		set b_isHeroPicked[GetUnitPointValue(u)]=true
		set IsHeroIngame[GetUnitPointValue(u)]=true
		call TechHeroForAll(GetUnitTypeId(u))
	endif
	if Mode_DM then
		call RemoveStuffFromHero(u)
		if IsSentinel(p)then
			set DM_LivesUsed[0]=DM_LivesUsed[0]+1
		else
			set DM_LivesUsed[1]=DM_LivesUsed[1]+1
		endif
		set OO[pid]=OO[pid]+1
		if OO[GetPlayerId(GetOwningPlayer(u))]>1 and u!=DM_PrevHero[GetPlayerId(GetOwningPlayer(u))]then
			call JE9(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))])
			call SmoothLvlup(u,GetHeroLevel(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))])-1,false,GetHeroXP(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))]))
			call DM_TransferItems(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))],u)
			set IsHeroIngame[GetUnitPointValue(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))])]=false
			if IsSentinel(GetOwningPlayer(u)) then
				call FlushChildHashtable(MHT,'SPL0'+GetPlayerId(GetOwningPlayer(u)))
			else
				call FlushChildHashtable(MHT,'SPLH'+GetPlayerId(GetOwningPlayer(u)))
			endif
			
			call RemoveHero(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))])
		endif
	endif
	if Mode_SH==false or p==PlayerModeTyper then
		if(RepickHasBeenUsed[GetPlayerId(GetOwningPlayer(u))] and Mode_SH==false)then
			call V79(p,GetObjectName('n0D5')+" "+GetUnitName(u)+".")//n0D5 -> has repicked into
		elseif((HasUsedRandom[pid] and Mode_DM==false)or Mode_AR or Mode_TR)then
			call V79(p,GetObjectName('n0D3')+" "+GetUnitName(u)+".")//n0D3 -> has randomed
		else
			call V79(p,GetObjectName('n0D2')+" "+GetUnitName(u)+".")//n0D2 -> has chosen
		endif
	endif
	if NoHeroLimitOff then
		call VG9(p)
	endif
	if(BB7 or Mode_CD)and NoHeroLimitOff then
		call VG9(p)
	endif
	call VM9(p)
	if isPlayerPickedAbility(p,311)or isPlayerPickedAbility(p,263)or isPlayerPickedAbility(p,275)then
		call DisplayTimedTextToPlayer(p,0,0,10.," ")
		call DisplayTimedTextToPlayer(p,0,0,10.,"|c00ff0303"+GetObjectName('n0G3')+"|r")//n0G3 -> Cranium Basher does not stack with your hero's bash
	endif
//	if isPlayerPickedAbility(p,337)then
//		call DisplayTimedTextToPlayer(p,0,0,30.," ")
//		call DisplayTimedTextToPlayer(p,0,0,30.,"|c00ff0303"+GetObjectName('n06P')+" "+GetObjectName('n06U')+"|r")//n06P -> Droppable Items do not drop while phased., n06U -> Activated items on death (like aegis) will not trigger while phased on unpathable terrain.
//	endif
	if HaveSavedBoolean(HY,600+GetUnitPointValue(u),87)==false then
		call SaveBoolean(HY,(600+GetUnitPointValue(u)),87,(true))
	endif
	if hhnActive[GetPlayerId(GetLocalPlayer())]==false then
		call SetPlayerName(p,(PlayerNames[GetPlayerId(p)])+" ("+UQ8(udg_Hero[pid])+")")
	endif
	if Mode_MD or Mode_SD then
		call ResetPickTaverns(p)
	endif
	call BonusDamageSystem(u)
	call RemoveRegion(r)
	set r=null
	set u=null
	set it=null
	set Hero=null
	set t=null
endfunction

function VX9 takes nothing returns boolean
	return(IsUnitType(GetSoldUnit(),UNIT_TYPE_HERO))!=null
endfunction

function TavernHeroSelected takes nothing returns nothing
	local unit Hero=GetSoldUnit()
	local unit tavern=GetSellingUnit()
	local player p=GetOwningPlayer(Hero)
	if b_isPickTime then
		
		call VQ9(Hero,GetPlayerId(p),tavern)
		return
	endif
	call VS8(p)
	set Hero=null
endfunction

function GoldPerSecTrigger takes nothing returns boolean
	local integer i=1
	loop
		call SetPlayerState(Sentinels[i],PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Sentinels[i],PLAYER_STATE_RESOURCE_GOLD)+1)
		set i=i+1
		exitwhen i==6
	endloop
	set i=1
	loop
		call SetPlayerState(Scourges[i],PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Scourges[i],PLAYER_STATE_RESOURCE_GOLD)+1)
		set i=i+1
		exitwhen i==6
	endloop
	return false
endfunction

function UpdateTime takes nothing returns nothing
	local integer offset=R2I(TimerGetElapsed(GlobalTimer)-GameStartsTime)
	local integer Minutes=offset/ 60-1/ 2
	local integer Seconds=ModuloInteger(offset,60)
	if IsGameStartedAnotherBool then
		call SetTime(Minutes,Seconds,false)
	elseif ModePickedBool==false then
		set offset=R2I(16-TimerGetElapsed(GlobalTimer))
		set Minutes=offset/ 60-1/ 2
		set Seconds=ModuloInteger(offset,60)
		call SetTime(Minutes,Seconds,true)
	endif
	set MinutesForTime = Minutes
	set SecondsForTime = Seconds
endfunction

function UltiCooldownTimerCheck takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local integer aid=GetSpellAbilityId()
	local integer pid=GetPlayerId(GetOwningPlayer(Source))
	local integer sid=PlayerSkillNumber[pid*PlayerSkillOffset+4]
	local real cd=0
	//call echo(Id2String(aid)+" "+B2S(LoadBoolean(CooldownStorage,-aid,1)))
	if aid=='A02W' then//refresh//A02W -> Item Cooldown Reset
		call TimerStart(PrimUltiTimer[pid],0,false,null)
		call TimerStart(SecUltiTimer[pid],0,false,null)
	elseif IsUnitType(Source,UNIT_TYPE_HERO) and LoadBoolean(CooldownStorage,-aid,1) then
		set cd=GetCooldown(aid,GetUnitAbilityLevel(Source,aid))
		if cd > 0 then
			if HaveSavedHandle(CooldownStorage,GetHandleId(Source),aid) then
				set cd=LoadReal(HY,GetHandleId(LoadTriggerHandle(CooldownStorage,GetHandleId(Source),aid)),1)
			endif
			if aid==SkillID[sid] or (AlternateSkillID[sid]!=null and aid==AlternateSkillID[sid]) then
				call TimerStart(PrimUltiTimer[pid],cd,false,null)
			elseif Mode_S6 then
				call TimerStart(SecUltiTimer[pid],cd,false,null)
			endif
		endif
	endif
	set Source=null
endfunction

function InitUltiesCD takes nothing returns nothing
	local integer i=0
	loop
		exitwhen(i>13)
		set PrimUltiTimer[i]=CreateTimer()
		set SecUltiTimer[i]=CreateTimer()
		set InvulDamagers[i]=CreateUnit(Player(i),'e00E',0,0,0)
		set i=i+1
	endloop
endfunction

function ReliableGoldHandling takes nothing returns boolean
	local player p
	local integer i
	local integer id
	local integer g
	set i=1
	loop
		exitwhen i>5
		set p=Sentinels[i]
		set id=GetPlayerId(p)
		set g=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
		if g<ReliableGold[id]then
			set ReliableGold[id]=g
		endif
		set p=Scourges[i]
		set id=GetPlayerId(p)
		set g=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
		if g<ReliableGold[id]then
			set ReliableGold[id]=g
		endif
		set i=i+1
	endloop
	return false
endfunction

function VL9 takes integer Source,integer Target returns boolean
	local integer i=Assists_Increment-1
	local real V19=0
	local real UK8=(TimerGetElapsed(GlobalTimer))
	local integer Count=0
	loop
		exitwhen i==Assists_Increment or V19>Assists_MaxTime or Count>200
		if i==0 then
			set i=8000-1
		endif
		set Count=Count+1
		set V19=UK8-Assists_LastTimeDamaged[i]
		if Assists_PlayerID[i]==Source and Assists_PlayerIDDamaged[i]==Target and V19<Assists_MaxTime then
			set Assists_PlayerID[i]=0
			set Assists_PlayerIDDamaged[i]=0
			return true
		endif
		set i=i-1
	endloop
	return false
endfunction

function V09 takes integer Source,integer Target returns boolean
	local integer i=Assists_Increment-1
	local real V19=0
	local real UK8=(TimerGetElapsed(GlobalTimer))
	local integer Count=0
	loop
		exitwhen i==Assists_Increment or V19>Assists_MaxTime or Count>200
		if i==0 then
			set i=8000-1
		endif
		set Count=Count+1
		set V19=UK8-Assists_LastTimeDamaged[i]
		if Assists_PlayerID[i]==Source and Assists_PlayerIDDamaged[i]==Target and V19<Assists_MaxTime then
			return true
		endif
		set i=i-1
	endloop
	return false
endfunction

function V59 takes nothing returns nothing
	local integer Source=GetPlayerId(GetOwningPlayer(GetEventDamageSource()))
	local integer Target=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
	local real Damage=GetEventDamage()
	set Assists_LastTimeDamaged[Assists_Increment]=(TimerGetElapsed(GlobalTimer))
	set Assists_PlayerID[Assists_Increment]=Source
	set Assists_PlayerIDDamaged[Assists_Increment]=Target
	set Assists_Increment=Assists_Increment+1
	if Assists_Increment==8000 then
		set Assists_Increment=1
	endif
endfunction

function V29 takes unit CE8,unit W49 returns string
	local integer i=1
	local integer W79=GetPlayerId(GetOwningPlayer(CE8))
	local integer W89=GetPlayerId(GetOwningPlayer(W49))
	local integer B78
	local string W99=" "+GetObjectName('n0JY')+" "//n0JY -> Assist:
	local boolean WD9=false
	loop
		exitwhen i>5
		if IsSentinel(GetOwningPlayer(W49))then
			set B78=GetPlayerId(Sentinels[i])
		else
			set B78=GetPlayerId(Scourges[i])
		endif
		if W89!=B78 and VL9(B78,W79)then
			set Assists[B78]=Assists[B78]+1
			call Traffic_RegisterData("Assist"+I2S(B78),W79)
			if WD9 then
				set W99=W99+"/"+udg_Colors[B78]+(PlayerNames[GetPlayerId((Player(B78)))])+"|r"
			else
				set W99=W99+udg_Colors[B78]+(PlayerNames[GetPlayerId((Player(B78)))])+"|r"
			endif
			set WD9=true
		endif
		set i=i+1
	endloop
	if WD9 then
		return W99
	endif
	return" "
endfunction

function WE9 takes unit CE8,unit W49 returns string
	local integer i=1
	local integer W79=GetPlayerId(GetOwningPlayer(CE8))
	local integer W89=GetPlayerId(GetOwningPlayer(W49))
	local integer B78
	local string W99=""
	local boolean WD9=false
	loop
		exitwhen i>5
		if IsSentinel(GetOwningPlayer(W49))then
			set B78=GetPlayerId(Sentinels[i])
		else
			set B78=GetPlayerId(Scourges[i])
		endif
		if W89!=B78 and V09(B78,W79)then
			if WD9 then
				set W99=W99+"/"+udg_Colors[B78]+(PlayerNames[GetPlayerId((Player(B78)))])+"|r"
			else
				set W99=W99+udg_Colors[B78]+(PlayerNames[GetPlayerId((Player(B78)))])+"|r"
			endif
			set WD9=true
		endif
		set i=i+1
	endloop
	if WD9 then
		return W99
	endif
	return" "
endfunction

function WF9 takes unit CE8,unit W49 returns integer
	local integer i=1
	local integer W79=GetPlayerId(GetOwningPlayer(CE8))
	local integer W89=GetPlayerId(GetOwningPlayer(W49))
	local integer B78
	local integer Count=0
	loop
		exitwhen i>5
		if IsSentinel(GetOwningPlayer(W49))then
			set B78=GetPlayerId(Sentinels[i])
		else
			set B78=GetPlayerId(Scourges[i])
		endif
		if W89!=B78 and V09(B78,W79)then
			set Count=Count+1
		endif
		set i=i+1
	endloop
	return Count
endfunction

function WG9 takes unit CE8,unit W49 returns boolean
	local integer i=1
	local integer W79=GetPlayerId(GetOwningPlayer(CE8))
	local integer W89=GetPlayerId(GetOwningPlayer(W49))
	local integer B78
	local string W99=" Assists: "
	local boolean WD9=false
	local integer x=1
	set Assists_Assisters[1]=null
	set Assists_Assisters[2]=null
	set Assists_Assisters[3]=null
	set Assists_Assisters[4]=null
	set Assists_Assisters[5]=null
	loop
		exitwhen i>5
		if IsSentinel(GetOwningPlayer(W49))then
			set B78=GetPlayerId(Sentinels[i])
		else
			set B78=GetPlayerId(Scourges[i])
		endif
		if W89!=B78 and V09(B78,W79)then
			set Assists_Assisters[x]=Player(B78)
			set x=x+1
			set WD9=true
		endif
		set i=i+1
	endloop
	return WD9
endfunction

function GetDamageSourceForStickyNapalm takes unit u returns unit
	if GetUnitAbilityLevel(u,'A1EL')>0 then
		return CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
	endif
	return u
endfunction

function WH9 takes unit CE8,unit W49,real W98 returns nothing
	local integer i=1
	local integer Count=0
	call WG9(CE8,W49)
	loop
		exitwhen i>5
		if Assists_Assisters[i]!=null then
			set Count=Count+1
		endif
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>5
		if Assists_Assisters[i]!=null then
			set ReliableGold[GetPlayerId(Assists_Assisters[i])]=ReliableGold[GetPlayerId(Assists_Assisters[i])]+R2I(W98/ Count)
			call DistribGoldToPlayerForUnit(Assists_Assisters[i],R2I(W98/ Count),udg_Hero[GetPlayerId(Assists_Assisters[i])])
		endif
		set i=i+1
	endloop
endfunction

function IsCreepId takes integer id returns boolean
	return id=='ugho' or id=='unec' or id=='esen' or id=='edry' or id=='u001' or id=='u002' or id=='e00V' or id=='e00W' or id=='ebal' or id=='e026' or id=='umtw' or id=='u00R'//ugho -> Ghoul, unec -> Necromancer, esen -> Treant, edry -> Druid of the Talon, u001 -> Ghoul, u002 -> Necromancer, e00V -> Treant, e00W -> Druid of the Talon, ebal -> Glaive Thrower, e026 -> Glaive Thrower, umtw -> Meat Wagon, u00R -> Meat Wagon
endfunction

function CreepKilledObs takes unit u, integer pid returns nothing
	local texttag t=CreateTextTag()
	call SetTextTagText(t,"$",.027)
	call SetTextTagPosUnit(t,u,0)
	call SetTextTagColorBJ(t,PlayerColors_R[pid],PlayerColors_G[pid],PlayerColors_B[pid],15)
	call SetTextTagVelocity(t,0,.035)
	call SetTextTagFadepoint(t,3)
	call SetTextTagLifespan(t,1.5)
	call SetTextTagPermanent(t,false)
	call SetTextTagVisibility(t,GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2)
	set t=null
endfunction

function CreepDenied2 takes unit u,integer pid returns nothing
	local texttag t=CreateTextTag()
	call SetTextTagText(t,"!",.03)
	call SetTextTagPosUnit(t,u,0)
	call SetTextTagColorBJ(t,PlayerColors_R[pid],PlayerColors_G[pid],PlayerColors_B[pid],15)
	call SetTextTagVelocity(t,0,.035)
	call SetTextTagFadepoint(t,3)
	call SetTextTagLifespan(t,1.5)
	call SetTextTagPermanent(t,false)
	call SetTextTagVisibility(t,CSONStatus2[GetPlayerId(GetLocalPlayer())] or(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2)))
	set t=null
endfunction

function CreepDeath takes unit killer, unit victim returns nothing
	local integer id=GetUnitTypeId(victim)
	local integer pid=GetPlayerId(GetOwningPlayer(killer))
	if GetOwningPlayer(victim)==Neutrals then
		set CSNeutrals[pid]=CSNeutrals[pid]+1
		call SaveInteger(HY,400+pid,79,LoadInteger(HY,400+pid,79)+1)
	else
		if IsCreepId(id) and (GetOwningPlayer(victim)==Sentinels[0] or GetOwningPlayer(victim)==Scourges[0]) then
			if IsUnitAlly(victim,GetOwningPlayer(killer)) then
				set CSDenies[pid]=CSDenies[pid]+1
				call CreepDenied2(victim,pid)
			else
				set PlayerCS[pid]=PlayerCS[pid]+1
//				if udg_ObserverMode and IsPlayerBelongToTeams(GetOwningPlayer(killer)) then
//					call CreepKilledObs(victim,pid)
//				endif
			endif
		endif
	endif
endfunction

function WM9 takes unit CE8 returns boolean
	return GetUnitTypeId(CE8)=='H00I' or GetUnitTypeId(CE8)=='H00J'//H00I -> Geomancer, H00J -> Geomancer
endfunction

function WP9 takes unit CE8,location WQ9 returns nothing
	local integer h=GetHandleId(GetOwningPlayer(CE8))
	local unit JJ9=(LoadUnitHandle(HY,h,699))
	local unit JK9=(LoadUnitHandle(HY,h,700))
	local unit JM9=(LoadUnitHandle(HY,h,701))
	local unit JN9=(LoadUnitHandle(HY,h,702))
	local unit JO9=(LoadUnitHandle(HY,h,703))
	if JJ9!=null then
		call ReviveHeroLoc(JJ9,WQ9,true)
		call RemoveStuffFromHero(JJ9)
	endif
	if JK9!=null then
		call ReviveHeroLoc(JK9,WQ9,true)
		call RemoveStuffFromHero(JK9)
	endif
	if JM9!=null then
		call ReviveHeroLoc(JM9,WQ9,true)
		call RemoveStuffFromHero(JM9)
	endif
	if JN9!=null then
		call ReviveHeroLoc(JN9,WQ9,true)
		call RemoveStuffFromHero(JN9)
	endif
	if JO9!=null then
		call ReviveHeroLoc(JO9,WQ9,true)
		call RemoveStuffFromHero(JO9)
	endif
	set JJ9=null
	set JK9=null
	set JM9=null
	set JN9=null
	set JO9=null
endfunction

function RespawnHeroTrig takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local player p
	local real x
	local real y
	if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		set p=GetOwningPlayer(u)
		if IsScourge(p)then
			set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
			set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
		else
			set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
			set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
		endif
		if GameEnded==false and IsDead(u)then
			call J89(u,p,x,y,true)
			call ReviveHero(u,x,y,true)
			call SetUnitState(u,UNIT_STATE_MANA,99999)
		endif
		
	endif
	call FlushChildHashtable(HY,h)
	call DestroyTrigger(t)
	
	set u=null
	set t=null
endfunction

function WR9b takes unit u, real dur returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,u)
	call TriggerRegisterTimerEvent(t,dur,false)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_HERO_REVIVE_FINISH)
	call TriggerAddCondition(t,Condition(function RespawnHeroTrig))
	//call echo("My respawn starts")
	set t=null
endfunction

function ShoppingGarbage takes nothing returns boolean
	if GetItemPlayer(GetFilterItem())==Player(15) then
		call RemoveItem(GetFilterItem())
	endif
	return false
endfunction

function ShoppingClear takes nothing returns nothing
	call EnumItemsInRect(ShoppingSquare,Filter(function ShoppingGarbage),null)
endfunction

function GetItemGoldCostById takes integer id returns integer
	local integer gold
	local integer Diff
	if HaveSavedInteger(ItemCosts,id,'GOLD')==false then
		set gold=GetPlayerState(Player(15),PLAYER_STATE_RESOURCE_GOLD)
		set Diff=50000
		call SetPlayerState(Player(15),PLAYER_STATE_RESOURCE_GOLD,Diff)
		call AddItemToStock(ShoppingUnit,id,1,1)
		call IssueImmediateOrderById(ShoppingUnit,id)
		set Diff = Diff - GetPlayerState(Player(15),PLAYER_STATE_RESOURCE_GOLD)
		call SetPlayerState(Player(15),PLAYER_STATE_RESOURCE_GOLD,gold)
		call SaveInteger(ItemCosts,id,'GOLD',Diff)
		call ShoppingClear()
	else
		set Diff=LoadInteger(ItemCosts,id,'GOLD')
	endif
	return Diff
endfunction

function GetUnitItemsCost takes unit u returns integer
	local integer i=0
	local integer summ=0
	local item it
	loop
		set it=UnitItemInSlot(u,i)
		if it!=null then
			set summ=summ+GetItemGoldCostById(GetItemTypeId(it))
		endif
		set i=i+1
		exitwhen i>5
	endloop
	set it=null
	return summ
endfunction

function NetWorthTT takes integer nw, unit circle returns nothing
	local texttag tt
	local integer h
	local integer hu=GetHandleId(circle)
	local integer id=GetPlayerId(GetOwningPlayer(circle))
	if HaveSavedHandle(HY,hu,'netw') then
		set tt=LoadTextTagHandle(HY,hu,'netw')
	else
		set tt=CreateTextTag()
		call SetTextTagPosUnit(tt,circle,0)
		call SetTextTagVelocity(tt,0,0)
		call SetTextTagPermanent(tt,true)
		call SaveTextTagHandle(HY,hu,'netw',tt)
	endif
	call SetTextTagText(tt,I2S(nw),0.025)
	call SetTextTagVisibility(tt,IsUnitAlly(circle,GetLocalPlayer()) or IsObserver(GetLocalPlayer()))
	if DefineBuybackUnitIndex(GetHeroLevel(udg_Hero[id]))*50+50 > GetPlayerState(GetOwningPlayer(circle),PLAYER_STATE_RESOURCE_GOLD) or IsImpossibleToBuyback[id] or BuybackID[id]=='h0D4' then//h0D4 -> Revive Hero - Cooldown
		call SetTextTagColor(tt,255,75,0,255)
	else
		call SetTextTagColor(tt,255,220,0,255)
	endif
	set tt=null
endfunction

function ShoppingNetworthsCount takes nothing returns nothing
	local integer i=1
	local integer pid
	local player p
	local integer cost
	loop
		set cost=0
		set p=Sentinels[i]
		if IsPlayerExisted(p) then
			set pid=GetPlayerId(p)
			if NetWorthRecount[pid] then
				if udg_Hero[pid]!=null then
					set cost=cost+GetUnitItemsCost(udg_Hero[pid])
					set cost=cost+GetUnitItemsCost(CirclesOfPower[pid])
				endif
				if HaveSavedHandle(HY,GetHandleId(p),333) then//spirit bear exists
					set cost=cost+GetUnitItemsCost(LoadUnitHandle(HY,GetHandleId(p),333))
				endif
				set cost=cost+AlchemistBonus[pid]
				set NetWorthRecount[pid]=false
				set NetWorthsNoGold[pid]=cost
			else
				set cost=NetWorthsNoGold[pid]
			endif
			set NetWorths[pid]=cost+GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
			call NetWorthTT(NetWorths[pid],CirclesOfPower[pid])
		endif
		
		set cost=0
		set p=Scourges[i]
		if IsPlayerExisted(p) then
			set pid=GetPlayerId(p)
			if NetWorthRecount[pid] then
				if udg_Hero[pid]!=null then
					set cost=cost+GetUnitItemsCost(udg_Hero[pid])
					set cost=cost+GetUnitItemsCost(CirclesOfPower[pid])
				endif
				if HaveSavedHandle(HY,GetHandleId(p),333) then//spirit bear exists
					set cost=cost+GetUnitItemsCost(LoadUnitHandle(HY,GetHandleId(p),333))
				endif
				set cost=cost+AlchemistBonus[pid]
				set NetWorthRecount[pid]=false
				set NetWorthsNoGold[pid]=cost
			else
				set cost=NetWorthsNoGold[pid]
			endif
			set NetWorths[pid]=cost+GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
			call NetWorthTT(NetWorths[pid],CirclesOfPower[pid])
		endif
		set i=i+1
		exitwhen i>5
	endloop
endfunction

function InitShopping takes nothing returns nothing
	set ShoppingSquare=Rect(6592,-7872,7392,-7264)
	set ShoppingUnit=CreateUnit(Player(15),'nshe',GetRectCenterX(ShoppingSquare),GetRectCenterY(ShoppingSquare),0)//nshe -> Sheep
	call UnitAddAbility(ShoppingUnit,'Asid')//Asid -> Sell Items
	call UnitRemoveAbility(ShoppingUnit,'Amov')//Amov -> Move
	call UnitAddAbility(ShoppingUnit,'Aloc')//Aloc -> Locust
	call SetUnitX(ShoppingUnit,GetRectCenterX(ShoppingSquare))
	call SetUnitY(ShoppingUnit,GetRectCenterY(ShoppingSquare))
	call ShowUnit(ShoppingUnit,false)
	set ShoppingPeriodic=CreateTimer()
	call TimerStart(ShoppingPeriodic,1,true,function ShoppingNetworthsCount)
endfunction

function WW9 takes unit killer,unit victim returns nothing
	if DistanceBetweenUnits(killer,victim)>1200 or(IsDead(killer)and GetUnitAbilityLevel(killer,'A06B')+GetUnitAbilityLevel(killer,'A471')>0)then//A06B -> Suicide Squad, Attack!
		call AddHeroXP(killer,GetHeroExpReward(victim),true)
	endif
endfunction

function WZ9 takes nothing returns boolean
	if(AliveNonBuildOrMarker(GetFilterUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitIllusion(GetFilterUnit())==false then
		if IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TempUnit_BSCheck))and FindItemOfType(GetFilterUnit(),Item_Real[bloodstone])!=null then
			call SetItemCharges(FindItemOfType(GetFilterUnit(),Item_Real[bloodstone]),GetItemCharges(FindItemOfType(GetFilterUnit(),Item_Real[bloodstone]))+1)
		endif
	endif
	return false
endfunction

function WA9 takes nothing returns boolean
	local item i
	local integer charges
	if TempInt_UrnsCount==0 and(AliveNonBuildOrMarker(GetFilterUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitIllusion(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TempUnit_UrnCheck))then
		set i = FindItemOfType(GetFilterUnit(),Item_Real[UrnOfShadows])
		if i!=null then
			set TempInt_UrnsCount=TempInt_UrnsCount+1
			set charges=GetItemCharges(i)
			if charges==0 then
				set charges=2
			else
				set charges=charges+1
			endif
			call SetItemCharges(i,charges)
		endif
		set i = null
	endif
	set i=null
	return false
endfunction

function WB9 takes unit u returns nothing
	local group g=GetAvailableGroup()
	set TempUnit_BSCheck=u
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1625,Condition(function WZ9))
	call KillGroup(g)
	set g=null
endfunction

function WC9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit W39=(LoadUnitHandle(HY,h,335))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real x
	local real y
	local real a
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if GetTriggerUnit()!=W39 then
			call KillUnit(W39)
		endif
	else
		set a=GetUnitFacing(Target)*bj_RADTODEG
		set x=GetUnitX(Target)+75
		set y=GetUnitY(Target)+75
		call SetUnitX(W39,x)
		call SetUnitY(W39,y)
		call IssueTargetOrderById(W39,ORDER_attack,Target)
	endif
	set t=null
	set W39=null
	set Target=null
	return false
endfunction

function W69 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local unit W39
	if GetSummoningUnit()==Caster then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		set W39=GetSummonedUnit()
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterDeathEvent(t,W39)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerRegisterTimerEvent(t,.05,true)
		call TriggerAddCondition(t,Condition(function WC9))
		call SaveUnitHandle(HY,h,335,(W39))
		call SaveUnitHandle(HY,h,17,(Target))
		call UnitAddAbility(W39,'Aloc')//Aloc -> Locust
		call SetUnitPosition(W39,GetUnitX(Target)+100,GetUnitY(Target)+100)
		call IssueTargetOrderById(W39,ORDER_attack,Target)
		call SetUnitMoveSpeed(W39,522)
	endif
	set t=null
	set Target=null
	set Source=null
	set Caster=null
	set W39=null
	return false
endfunction

function WL9 takes unit Source,unit W19 returns nothing
	local unit Target=W19
	local unit Caster
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	if WC8(Target)then
		set Target=(udg_Hero[GetPlayerId(GetOwningPlayer((Target)))])
	endif
	set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function W69))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveUnitHandle(HY,h,19,(Caster))
	call UnitAddAbility2(Caster,'A2E7')//A2E7 -> Blade of the Reaper
	call IssueTargetOrderById(Caster,852274,Target)
	set t=null
	set Target=null
	set Caster=null
endfunction

function W09 takes nothing returns boolean
	if(AliveNonBuildOrMarker(GetFilterUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitIllusion(GetFilterUnit())==false then
		if IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TempUnit_BSCheck))==false and FindItemOfType(GetFilterUnit(),Item_Real[BladeOfTheReaper])!=null then
		endif
	endif
	return false
endfunction

function W59 takes unit u returns nothing
	local group g=GetAvailableGroup()
	set TempUnit_BSCheck=u
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1625,Condition(function W09))
	call KillGroup(g)
	set g=null
endfunction

function W29 takes unit u returns nothing
	local group g=GetAvailableGroup()
	set TempInt_UrnsCount=0
	set TempUnit_UrnCheck=u
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1425,Condition(function WA9))
	call KillGroup(g)
	set TempInt_UrnsCount=0
	set g=null
endfunction

function X49 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer X79=(LoadInteger(HY,h,88))
	local integer i=1
	local player p
	local string TR8
	loop
		exitwhen i>5
		if X79==0 then
			set p=Sentinels[i]
			set TR8=udg_Colors[GetPlayerId(Sentinels[0])]+GetObjectName('n03N')+"|r "+GetObjectName('n03P')+" "+udg_Colors[GetPlayerId(Sentinels[0])]+GetObjectName('n03Q')+"|r"//n03N -> The Sentinel, n03P -> are, n03Q -> OWNING!!!
		else
			set p=Scourges[i]
			set TR8=udg_Colors[GetPlayerId(Scourges[0])]+GetObjectName('n03O')+"|r "+GetObjectName('n03P')+" "+udg_Colors[GetPlayerId(Scourges[0])]+GetObjectName('n03Q')+"|r"//n03O -> The Scourge, n03P -> are, n03Q -> OWNING!!!
		endif
		call DisplayTimedTextToPlayer(p,0,0,10,TR8)
		call BY8(Sounds_Ownage,p)
		set i=i+1
	endloop
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set p=null
	return false
endfunction

function X89 takes integer X79 returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,1.5,false)
	call TriggerAddCondition(t,Condition(function X49))
	call SaveInteger(HY,h,88,(X79))
	set t=null
endfunction

function X99 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer XD9=(LoadInteger(HY,h,89))
	local string TR8=(LoadStr(HY,h,90))
	local integer PlayerId=LoadInteger(HY,'0SND','0PID')
	if XD9==1 then
		call BX8(Sounds_DK)
	elseif XD9==2 then
		call BX8(Sounds_TrippleKill)
	elseif XD9==3 then
		call BX8(Sounds_UltraKill)
	elseif XD9==4 then
		call BX8(Sounds_Rampage)
	endif
	call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],TR8)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	return false
endfunction

function XE9 takes string TR8,integer XD9 returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,1.5,false)
	call TriggerAddCondition(t,Condition(function X99))
	call SaveStr(HY,h,90,(TR8))
	call SaveInteger(HY,h,89,(XD9))
	set t=null
endfunction

function XF9 takes player C98,integer CD8 returns nothing
	local integer VT8=1
	local integer IC9
	if IsSentinel(C98)then
		set IC9=CountPlayersInForce(Force_Elfs)
	else
		set IC9=CountPlayersInForce(Force_Unds)
	endif
	if IsSentinel(C98)then
		loop
			exitwhen VT8>5
			if IsPlayer(Sentinels[VT8])then
				set ReliableGold[GetPlayerId(Sentinels[VT8])]=ReliableGold[GetPlayerId(Sentinels[VT8])]+CD8/ IC9
				call DistribGoldToPlayerForUnit(Sentinels[VT8],CD8/ IC9,udg_Hero[GetPlayerId(Sentinels[VT8])])
			endif
			set VT8=VT8+1
		endloop
	else
		loop
			exitwhen VT8>5
			if IsPlayer(Scourges[VT8])then
				set ReliableGold[GetPlayerId(Scourges[VT8])]=ReliableGold[GetPlayerId(Scourges[VT8])]+CD8/ IC9
				call DistribGoldToPlayerForUnit(Scourges[VT8],CD8/ IC9,udg_Hero[GetPlayerId(Scourges[VT8])])
			endif
			set VT8=VT8+1
		endloop
	endif
endfunction

function XG9 takes unit CE8,integer XH9 returns nothing
	local player WU9=GetOwningPlayer(CE8)
	call SetPlayerState(WU9,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(WU9,PLAYER_STATE_RESOURCE_GOLD)-XH9)
	set WU9=null
endfunction

function XI9 takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())=='o003' then//o003 -> Spin Web
		call KillUnit(GetFilterUnit())
		return true
	endif
	return false
endfunction

function XJ9 takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function XI9))
	call KillGroup(g)
	set g=null
endfunction

function XM9 takes unit W49,player WU9,player C98 returns boolean
	return W49==null or(IsSentinel(WU9)and IsSentinel(C98))or(IsScourge(WU9)and IsScourge(C98))
endfunction

function GetTeamXP takes integer id returns integer//0 for sent, else for scourges
	local integer i=1
	local integer xp=0
	if id==0 then
		loop
			if udg_Hero[GetPlayerId(Sentinels[i])]!=null then
				set xp=xp+GetHeroXP(udg_Hero[GetPlayerId(Sentinels[i])])
			endif
			set i=i+1
			exitwhen i>5
		endloop
	else
		loop
			if udg_Hero[GetPlayerId(Scourges[i])]!=null then
				set xp=xp+GetHeroXP(udg_Hero[GetPlayerId(Scourges[i])])
			endif
			set i=i+1
			exitwhen i>5
		endloop
	endif
	return xp
endfunction

function GetTeamNW takes integer id returns integer//0 for sent, else for scourges
	local integer i=1
	local integer value=0
	if id==0 then
		loop
			set value=value+NetWorths[GetPlayerId(Sentinels[i])]
			set i=i+1
			exitwhen i>5
		endloop
	else
		loop
			set value=value+NetWorths[GetPlayerId(Scourges[i])]
			set i=i+1
			exitwhen i>5
		endloop
	endif
	return value
endfunction

function GetPlayerNetworthPosition takes player p returns integer
	local integer i=1
	local integer pos=1
	local integer pid=GetPlayerId(p)
	local integer nw=NetWorths[pid]
	if IsSentinel(p) then
		loop
			if GetPlayerId(Sentinels[i])!=pid then
				if NetWorths[GetPlayerId(Sentinels[i])] > nw then
					set pos=pos+1
				endif
			endif
			set i=i+1
			exitwhen i>5
		endloop
	else
		loop
			if GetPlayerId(Scourges[i])!=pid then
				if NetWorths[GetPlayerId(Scourges[i])] > nw then
					set pos=pos+1
				endif
			endif
			set i=i+1
			exitwhen i>5
		endloop
	endif
	return pos
endfunction

function SortAssistTable takes nothing returns nothing
	local integer i=1
	local integer total=LoadInteger(TempHash,'Assi',0)
	local real array r
	local player array p
	local integer k=0
	if total==2 then
		set r[0]=0.75
		set r[1]=1.25
	elseif total==3 then
		set r[0]=0.75
		set r[1]=1.0
		set r[2]=1.25
	elseif total==4 then
		set r[0]=0.75
		set r[1]=0.75
		set r[2]=1.25
		set r[3]=1.25
	elseif total>=5 then
		set r[0]=0.75
		set r[1]=0.75
		set r[2]=1.0
		set r[3]=1.25
		set r[4]=1.25
	endif
	loop
		if HaveSavedHandle(TempHash,'Assi',i) then
			set p[k]=LoadPlayerHandle(TempHash,'Assi',i)
			set k=k+1
		endif
		
		set i=i+1
		exitwhen i>5 or k>total-1
	endloop
	set i=0
	loop
		call SaveReal(TempHash,'Assi',GetPlayerId(p[i]),r[i])
		//call echo("For player #"+I2S(GetPlayerId(p[i]))+" multiplier is "+R2S(r[i]))
		set i=i+1
		exitwhen i>k
	endloop
	
endfunction

function AssistsDefinePersonalMult takes nothing returns nothing
	local group g=LoadGroupHandle(TempHash,'assi',0)
	local group gg=GetAvailableGroup()
	local integer pos
	local unit u2
	local integer i=0
	call FlushChildHashtable(TempHash,'Assi')
	call GroupAddGroup(g,gg)
	loop
		set u2=FirstOfGroup(gg)
		exitwhen u2==null
		set i=i+1
		set pos=GetPlayerNetworthPosition(GetOwningPlayer(u2))
		if HaveSavedHandle(TempHash,'Assi',pos) then
			loop
				set pos=pos+1
				exitwhen HaveSavedHandle(TempHash,'Assi',pos)==false
			endloop
		endif
		call SavePlayerHandle(TempHash,'Assi',pos,GetOwningPlayer(u2))
		call SaveInteger(TempHash,'Assi',i,GetPlayerId(GetOwningPlayer(u2)))
		call SaveInteger(TempHash,'Assi',0,LoadInteger(TempHash,'Assi',0)+1)
		call GroupRemoveUnit(gg,u2)
	endloop
	if i==1 then
		call SaveReal(TempHash,'Assi',LoadInteger(TempHash,'Assi',1),1)
		//call echo("one assister, x1")
	else
		call SortAssistTable()
	endif
	call KillGroup(gg)
	call RemoveSavedHandle(TempHash,'assi',0)
endfunction

function DistanceBetweenUnitsNoRoot takes unit u1,unit u2 returns real
	local real x1=GetUnitX(u1)
	local real y1=GetUnitY(u1)
	local real x2=GetUnitX(u2)
	local real y2=GetUnitY(u2)
	if u1==null or u2==null then
		return I2R(9999999999)
	else
		return (x1-x2)*(x1-x2)+(y1-y2)*(y1-y2)
	endif
	return 1.0
endfunction

function CheckIfHeroInRange_Enemy takes nothing returns nothing
	if IsDead(GetEnumUnit())==false and IsUnitEnemy(GetEnumUnit(),GetOwningPlayer(GlobalKiller)) and DistanceBetweenUnitsNoRoot(GetTriggerUnit(),GetEnumUnit()) <= EXPAOE * EXPAOE then
		call GroupAddUnit(ShareExpGroup,GetEnumUnit())
	endif
endfunction

function CheckIfHeroInRange_Ally takes nothing returns nothing
	if IsDead(GetEnumUnit())==false and IsUnitAlly(GetEnumUnit(),GetOwningPlayer(GlobalKiller)) and DistanceBetweenUnitsNoRoot(GetTriggerUnit(),GetEnumUnit()) <= EXPAOE * EXPAOE then
		call GroupAddUnit(ShareExpGroup,GetEnumUnit())
	endif
endfunction

function CheckIfHeroInRange_Neutrals takes nothing returns nothing
	if IsDead(GetEnumUnit())==false and DistanceBetweenUnitsNoRoot(GetTriggerUnit(),GetEnumUnit()) <= EXPAOE * EXPAOE then
		call GroupAddUnit(ShareExpGroup,GetEnumUnit())
	endif
endfunction

function getHeroesAround takes nothing returns nothing
	local unit u=GetTriggerUnit()
	call GroupClear(ShareExpGroup)
	if GetOwningPlayer(u)==Neutrals then
		if IsUnitType(u,UNIT_TYPE_ANCIENT)==false then
			call ForGroup(AllEnteredHeroesGroup,function CheckIfHeroInRange_Neutrals)
		else
			call ForGroup(AllEnteredHeroesGroup,function CheckIfHeroInRange_Ally)
		endif
	else
		if IsUnitAlly(u,GetOwningPlayer(GetKillingUnit())) and SacrificedByLich==false then
			call ForGroup(AllEnteredHeroesGroup,function CheckIfHeroInRange_Enemy)
		else
			call ForGroup(AllEnteredHeroesGroup,function CheckIfHeroInRange_Ally)
		endif
	endif
	set u=null
endfunction

function getHeroesAroundHeroKill takes nothing returns nothing
	call GroupClear(ShareExpGroup)
	call ForGroup(AllEnteredHeroesGroup,function CheckIfHeroInRange_Ally)
endfunction

function AssistDistribBonuses takes unit killer returns boolean
	local integer Level
	local integer xpbonus=0
	local integer gbonus=0
	local group g
	local integer xpally
	local integer xpenemy
	local real xpdiff
	local real xpfactor
	local integer xp
	local unit u=GetTriggerUnit()
	local integer VictimNW
	local integer EnemyTeamNW
	local integer AlliedTeamNW
	local real NWDifference
	local real a
	local real NWFactor
	local integer count
	local integer victimPos
	local integer heroPos
	local integer counterBonusBase
	local real counterMultBase
	local real counterMultSec
	local integer counterBonusSec
	local integer gbonust
	local integer pid
	local real disadv
	local real disadvMult
	if IsUnitType(u,UNIT_TYPE_HERO) and IsClonedHero(GetUnitTypeId(u))==false then
		set Level=GetHeroLevel(u)
		set xp=GetHeroXP(u)
		set GlobalKiller=killer
		call getHeroesAroundHeroKill()
		if IsUnitType(killer,UNIT_TYPE_HERO) and LoadBoolean(HY,GetHandleId(killer),TEMPEST)==false then
			if IsFakeHero2(killer) then
				if IsDead(udg_Hero[GetPlayerId(GetOwningPlayer(killer))])==false then
					call GroupAddUnit(ShareExpGroup,udg_Hero[GetPlayerId(GetOwningPlayer(killer))])
				endif
			else
				if IsDead(killer)==false then
					call GroupAddUnit(ShareExpGroup,killer)
				endif
			endif
		else
			if udg_Hero[GetPlayerId(GetOwningPlayer(killer))]!=null and IsDead(udg_Hero[GetPlayerId(GetOwningPlayer(killer))])==false then
				call GroupAddUnit(ShareExpGroup,udg_Hero[GetPlayerId(GetOwningPlayer(killer))])
			endif
		endif
		set count=CountUnitsInGroup(ShareExpGroup)
		if count==0 then
			//call KillGroup(g)
			set u=null
			return false
		endif
		if IsScourge(GetOwningPlayer(u)) then
			set xpally=GetTeamXP(0)
			set xpenemy=GetTeamXP(1)
			set AlliedTeamNW=GetTeamNW(0)
			set EnemyTeamNW=GetTeamNW(1)
		else
			set xpally=GetTeamXP(1)
			set xpenemy=GetTeamXP(0)
			set AlliedTeamNW=GetTeamNW(1)
			set EnemyTeamNW=GetTeamNW(0)
		endif
		set disadv=IMaxIF(EnemyTeamNW-AlliedTeamNW,0)*1.
		//AlliedTeam = killer's team, EnemyTeam = fragged unit's team
		set xpdiff=RMaxIF((xpenemy - xpally)*1./(1.*IMaxIF(xpenemy + xpally,1)),0)
		set xpfactor=xpdiff*xp
		if count==1 then
			set xpbonus=20*Level+R2I(xpfactor*0.23*0.6)
		elseif count==2 then
			set xpbonus=15*Level+R2I(xpfactor*0.23*0.6)
		elseif count==3 then
			set xpbonus=10*Level+R2I(xpfactor*0.2*0.6)
		elseif count==4 then
			set xpbonus=7*Level+R2I(xpfactor*0.15*0.6)
		elseif count>=5 then
			set xpbonus=5*Level+R2I(xpfactor*0.12*0.6)
		endif
		//call echo(I2S(xpbonus))
		set victimPos=GetPlayerNetworthPosition(GetOwningPlayer(u))
		set VictimNW=NetWorths[GetPlayerId(GetOwningPlayer(u))]
		set a= (1.* EnemyTeamNW) / ((AlliedTeamNW+1)*1.)-1.
		set NWDifference=RMinIF(RMaxIF(a,0),1)
		set NWFactor=NWDifference
//		call echo("a = "+R2S(a)+"EnemyTeamNW = "+I2S(EnemyTeamNW)+", AlliedTeamNW = "+I2S(AlliedTeamNW))
		if count==1 then
			set counterBonusBase=150
			set counterMultBase=8.0
			set counterMultSec=0.0375
			set counterBonusSec=100
			set disadvMult=100.
		elseif count==2 then
			set counterBonusBase=100
			set counterMultBase=7.0
			set counterMultSec=0.0375
			set counterBonusSec=75
			set disadvMult=75.
		elseif count==3 then
			set counterBonusBase=40
			set counterMultBase=6.0
			set counterMultSec=0.0375
			set counterBonusSec=40
			set disadvMult=50.
		elseif count==4 then
			set counterBonusBase=25
			set counterMultBase=4.0
			set counterMultSec=0.03
			set counterBonusSec=25
			set disadvMult=35.
		elseif count>=5 then
			set counterBonusBase=20
			set counterMultBase=4.0
			set counterMultSec=0.0225
			set counterBonusSec=20
			set disadvMult=25.
		endif
		//call echo("counterBonusBase = "+I2S(counterBonusBase)+", counterMultBase = "+R2S(counterMultBase)+", counterMultSec = "+R2S(counterMultSec)+", VictimNW = "+I2S(VictimNW)+", NWFactor = "+R2S(NWFactor)+", disadvMult = "+R2S(disadvMult)+", RMinIF(disadv / 4000, 1) = "+R2S(RMinIF(disadv / 4000., 1))+", disadv = "+R2S(disadv)+", last="+R2S((1.2 - 0.1 * (victimPos - 1) )))
		set gbonust=R2I((counterBonusBase + counterMultBase * Level + counterMultSec * VictimNW * NWFactor + disadvMult * RMinIF(disadv / 4000., 1) ) * (1.2 - 0.1 * (victimPos - 1) ))
		//call echo(R2S((counterBonusBase + counterMultBase * Level + counterMultSec * VictimNW * NWFactor + disadvMult * RMinIF(disadv / 4000., 1) )))
		
//		call echo("1st: "+R2S((counterBonusBase + counterMultBase * Level + counterMultSec * VictimNW * NWFactor + disadvMult * RMinIF(disadv / 4000., 1) )))
//		call echo(R2S(counterBonusBase))
//		call echo(R2S(counterMultBase))
//		call echo(R2S(Level))
//		call echo(R2S(counterMultSec))
//		call echo(R2S(VictimNW))
//		call echo(R2S(NWFactor))
//		call echo(R2S(disadvMult))
//		call echo(R2S(disadv))
//		call echo(R2S(disadv / 4000.))
//		call echo("2nd: "+R2S((1.2 - 0.1 * (victimPos - 1) )))
		call SaveGroupHandle(TempHash,'assi',0,ShareExpGroup)
		call AssistsDefinePersonalMult()
		set Level=R2I(GetHeroExpReward(u) / count)
		loop
			set u=FirstOfGroup(ShareExpGroup)
			exitwhen u==null
			set pid=GetPlayerId(GetOwningPlayer(u))
			set gbonus=R2I(gbonust * LoadReal(TempHash,'Assi',pid))
			//call echo("Bonus = "+R2S(LoadReal(TempHash,'Assi',pid))+", gbonust = "+I2S(gbonust)+", counterBonusSec = "+I2S(counterBonusSec))
			call SaveInteger(TempHash,'Assi',pid,gbonus)
			if u!=killer or IsDead(u)==false or LoadInteger(HY,GetHandleId(killer),'A06B')==1 then
				call AddHeroXP(u,xpbonus,true)
			endif
			if u==killer and DistanceBetweenUnits(killer,GetTriggerUnit())>EXPAOE then
				if IsDead(u)==false or LoadInteger(HY,GetHandleId(killer),'A06B')==1 then
					call AddHeroXP(u,Level*count,true)
				endif
			else
				if IsDead(u)==false or LoadInteger(HY,GetHandleId(killer),'A06B')==1 then
					call AddHeroXP(u,Level,true)
				endif
			endif
			set AssistsBonusExpCounter[pid]=AssistsBonusExpCounter[pid]+xpbonus
			set AssistsBonusGoldCounter[pid]=AssistsBonusGoldCounter[pid]+gbonus
			set ReliableGold[pid]=ReliableGold[pid]+gbonus
			call DistribGoldToPlayerForUnit(GetOwningPlayer(u),gbonus,u)
			call GroupRemoveUnit(ShareExpGroup,u)
		endloop
	endif
	return false
endfunction

function ResetMultikillTimer takes nothing returns nothing
	set MultikillCounter[LoadInteger(HY,GetHandleId(GetExpiredTimer()),0)]=0
endfunction

function HeroDeath takes nothing returns nothing
	local boolean isNonPvsPKill=false
	local unit Victim=GetDyingUnit()
	local unit Killer=GetKillingUnit()
	local player PKiller=GetOwningPlayer(Killer)
	local player PVictim=GetOwningPlayer(Victim)
	local integer pidk
	local integer pidv
	local integer GoldReward=0
	local integer GoldPenalty=0
	local boolean isKillerBelongToPlayers=false
	local string tmpStoppedStreakString=""
	local string tmpStreakString=""
	local string assistsStringVar=""
	local integer tmpCurStreakOfKiller
	local string DyingPlayerName
	local string KillingPlayerName
	local string resultingStrngOfKill
	local string GoldRewardStr
	local boolean ShallowGraveStatus=false
	local real ShallowGraveRespTimeMultiplier=1
	local real TechiesSuicideRespTimeMultiplier=1
	local real BloodstoneRespTimeBonus=0
	local integer ReaperScytheFine=0
	local trigger t
	local real RespTime
	local integer AssistantCounter
	local integer unittypeId
	local integer DyingUnitOwnerGold=GetPlayerState(PVictim,PLAYER_STATE_RESOURCE_GOLD)
	local integer DyingUnitOwnerUnreliableGold=DyingUnitOwnerGold-ReliableGold[GetPlayerId(PVictim)]
	local unit tmpKillingUnit
	local unit tmpDyingUnit
	local string Y99
	local boolean KilledByReaper=LoadInteger(HY,GetHandleId(Victim),4418)==1 or (LoadInteger(HY,GetHandleId(Victim),4419)==1)
	local item it
	if KilledByReaper then
		set IsImpossibleToBuyback[GetPlayerId(PVictim)]=true
	endif
	if LoadInteger(HY,GetHandleId(Victim),4333)==1 or LoadInteger(HY,GetHandleId(Victim),4334)==1 then
		set Killer=udg_Hero[GetPlayerId(LoadPlayerHandle(HY,GetHandleId(Victim),4333))]
		set PKiller=GetOwningPlayer(Killer)
		set ReaperScytheFine=30
	endif
	if Killer==null and LoadInteger(HY,GetHandleId(Victim),4500)==1 then
		set Killer=OH8
		set PKiller=GetOwningPlayer(Killer)
	endif
	set AssistantCounter=WF9(Victim,Killer)
//	if Killer!=null then
//		set unittypeId=GetUnitTypeId(Killer)
//		call WW9(udg_Hero[GetPlayerId(GetOwningPlayer(Killer))],Victim)
//	endif
	if IsPlayerAlly(PKiller,PVictim) and((LoadInteger(HY,GetHandleId(Killer),4328))==1) and unit_WinterCurseCaster!=null then
		set Killer=unit_WinterCurseCaster
		set PKiller=GetOwningPlayer(Killer)
	endif
	if XM9(Killer,PVictim,PKiller)==false and AssistantCounter==1 and IsPlayerBelongToTeams(PKiller)==false and PKiller!=Neutrals then
		call WG9(Victim,Killer)
		set PKiller=Assists_Assisters[1]
		set Killer=udg_Hero[GetPlayerId(PKiller)]
	endif
	set IsHeroDead[GetPlayerId(GetOwningPlayer(Victim))]=true
	if PKiller==null then
		set PKiller=PVictim
	endif
	if GetUnitAbilityLevel(Killer,'Aloc')>0 then//Aloc -> Locust
		set Killer=udg_Hero[GetPlayerId(PKiller)]
	endif
	if IsPlayerEnemy(PKiller,PVictim) and PKiller!=Player(12) then//if enemy and non-neutrals
		call AssistDistribBonuses(Killer)
	endif
	if Mode_ID and GetUnitTypeId(Victim)!='H00J' then//H00J -> Geomancer
		set it=UnitRemoveItemFromSlot(Victim,GetRandomInt(0,5))
		if GetItemTypeId(it)=='I00K' then//I00K -> |c000042ffDouble Damage|r
			call CreateItem('I00G',GetItemX(it),GetItemY(it))
			call RemoveItem(it)
		endif
		set it=null
	endif
	set pidk=GetPlayerId(PKiller)
	set pidv=GetPlayerId(PVictim)
	if IsSentinel(PVictim)then
		if IsSentinel(PKiller)then
			set isNonPvsPKill=true
			if(PKiller==PVictim)then
				call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pidv]+PlayerNames[pidv]+"|r "+GetObjectName('n03R'))//n03R -> has killed himself!
			else
				call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],F09(PVictim,PKiller))
			endif
		elseif IsScourge(PKiller)then
			set isKillerBelongToPlayers=true
			set Deaths[GetPlayerId(Sentinels[0])]=Deaths[GetPlayerId(Sentinels[0])]+1
			set Kills[GetPlayerId(Scourges[0])]=Kills[GetPlayerId(Scourges[0])]+1
			set OwningCounter[2]=OwningCounter[2]+1
			set OwningCounter[1]=0
			if PKiller!=Scourges[0]then
				set Kills[pidk]=Kills[pidk]+1
				set PlayerKillsStreak[pidk]=PlayerKillsStreak[pidk]+1
			endif
		endif
	elseif IsScourge(PVictim)then
		if IsScourge(PKiller)then
			set isNonPvsPKill=true
			if(PKiller==PVictim)then
				call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pidv]+(PlayerNames[pidv])+"|r "+GetObjectName('n03R'))//n03R -> has killed himself!
			else
				call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],F09(PVictim,PKiller))
			endif
		elseif IsSentinel(PKiller)then
			set isKillerBelongToPlayers=true
			set Deaths[GetPlayerId(Scourges[0])]=Deaths[GetPlayerId(Scourges[0])]+1
			set Kills[GetPlayerId(Sentinels[0])]=Kills[GetPlayerId(Sentinels[0])]+1
			set OwningCounter[1]=OwningCounter[1]+1
			set OwningCounter[2]=0
			if PKiller!=Sentinels[0]then
				set Kills[pidk]=Kills[pidk]+1
				set PlayerKillsStreak[pidk]=PlayerKillsStreak[pidk]+1
			endif
		endif
	endif
	if PKiller==Neutrals then
		set isKillerBelongToPlayers=false
		if GetUnitTypeId(Killer)=='n00L' then//n00L -> Roshan
			call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pidv]+PlayerNames[pidv]+"|r "+GetObjectName('n03T'))//n03T -> has been killed by Roshan
		else
			call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pidv]+PlayerNames[pidv]+"|r "+GetObjectName('n03U'))//n03U -> has been killed by Neutral Creeps
		endif
		set isNonPvsPKill=true
	endif
	if IsRemoteMinesBlast then
		call PlaySoundAtPos(Sound_TechiesLaugh,GetUnitX(Victim),GetUnitY(Victim))
	endif
	call Traffic_RegisterData("Hero"+I2S(pidv),pidk)
	if PlayerKillsStreak[pidk]>PlayerBestStreak[pidk]then
		set PlayerBestStreak[pidk]=PlayerKillsStreak[pidk]
	endif
	set tmpCurStreakOfKiller=PlayerKillsStreak[pidv]
	if tmpCurStreakOfKiller>2 and isNonPvsPKill==false then
		if tmpCurStreakOfKiller==3 then
			set tmpStoppedStreakString="|c0000ff40"+GetObjectName('n04L')+"|r"//n04L -> killing spree
		elseif tmpCurStreakOfKiller==4 then
			set tmpStoppedStreakString="|c00400080"+GetObjectName('n04N')+"|r"//n04N -> dominating
		elseif tmpCurStreakOfKiller==5 then
			set tmpStoppedStreakString="|c00ff0080"+GetObjectName('n04M')+"|r"//n04M -> mega kill
		elseif tmpCurStreakOfKiller==6 then
			set tmpStoppedStreakString="|c00ff8000"+GetObjectName('n04J')+"|r"//n04J -> unstoppable
		elseif tmpCurStreakOfKiller==7 then
			set tmpStoppedStreakString="|c00808000"+GetObjectName('n04I')+"|r"//n04I -> wicked sick
		elseif tmpCurStreakOfKiller==8 then
			set tmpStoppedStreakString="|c00ff80ff"+GetObjectName('n03V')+"|r"//n03V -> monster kill
		elseif tmpCurStreakOfKiller==9 then
			set tmpStoppedStreakString="|c00ff0000"+GetObjectName('n03W')+"|r"//n03W -> GODLIKE
		elseif tmpCurStreakOfKiller>=10 then
			set tmpStoppedStreakString="|c00ff8000"+GetObjectName('n03X')+"|r"//n03X -> beyond GODLIKE
		endif
		set GoldReward=(IMinIF(tmpCurStreakOfKiller,10)-2)*60
	endif
	set tmpCurStreakOfKiller=PlayerKillsStreak[pidk]
	set tmpKillingUnit=Killer
	if IsUnitType(tmpKillingUnit,UNIT_TYPE_HERO)==false then
		set tmpKillingUnit=udg_Hero[GetPlayerId(GetOwningPlayer(tmpKillingUnit))]
	endif
	set tmpDyingUnit=Victim
	if IsUnitType(tmpDyingUnit,UNIT_TYPE_HERO)==false then
		set tmpDyingUnit=udg_Hero[GetPlayerId(GetOwningPlayer(tmpDyingUnit))]
	endif
	if isNonPvsPKill==false and isKillerBelongToPlayers then
	endif
	if tmpCurStreakOfKiller>2 and isNonPvsPKill==false then
		if tmpCurStreakOfKiller==3 then
			call BX8(Sounds_KillingSpree)
			set tmpStreakString=" "+GetObjectName('n04K')+" |c0000ff40"+GetObjectName('n04L')+"|r"+GetObjectName('n049')//n04K -> is on a, n04L -> killing spree, n049 -> !
		elseif tmpCurStreakOfKiller==4 then
			call BX8(Sounds_Dominating)
			set tmpStreakString=" "+GetObjectName('n04H')+" |c00400080"+GetObjectName('n04N')+"|r"+GetObjectName('n049')//n04H -> is, n04N -> dominating, n049 -> !
		elseif tmpCurStreakOfKiller==5 then
			call BX8(Sounds_Megakill)
			set tmpStreakString=" "+GetObjectName('n04G')+" |c00ff0080"+GetObjectName('n04M')+"|r"+GetObjectName('n049')//n04G -> has a, n04M -> mega kill, n049 -> !
		elseif tmpCurStreakOfKiller==6 then
			call BX8(Sounds_Unstoppable)
			set tmpStreakString=" "+GetObjectName('n04H')+" |c00ff8000"+GetObjectName('n04J')+"|r"+GetObjectName('n04A')//n04H -> is, n04J -> unstoppable, n04A -> !!
		elseif tmpCurStreakOfKiller==7 then
			call BX8(Sounds_WickedSick)
			set tmpStreakString=" "+GetObjectName('n04H')+" |c00808000"+GetObjectName('n04I')+"|r"+GetObjectName('n04A')//n04H -> is, n04I -> wicked sick, n04A -> !!
		elseif tmpCurStreakOfKiller==8 then
			call BX8(Sounds_Monsterkill)
			set tmpStreakString=" "+GetObjectName('n04G')+" |c00ff80ff"+GetObjectName('n03V')+"|r"+GetObjectName('n04A')//n04G -> has a, n03V -> monster kill, n04A -> !!
		elseif tmpCurStreakOfKiller==9 then
			call BX8(Sounds_Godlike)
			set tmpStreakString=" "+GetObjectName('n04H')+" |c00ff0000"+GetObjectName('n03W')+"|r"+GetObjectName('n04B')//n04H -> is, n03W -> GODLIKE, n04B -> !!!
		elseif tmpCurStreakOfKiller>=10 then
			call BX8(Sounds_HolyShit)
			set tmpStreakString=" "+GetObjectName('n04H')+" |c00ff8000"+GetObjectName('n03X')+"|r. "+GetObjectName('n04F')+GetObjectName('n04B')//n04H -> is, n03X -> beyond GODLIKE, n04F -> Someone KILL HIM!!!, n04B -> !!!
		endif
	endif
	if isNonPvsPKill==false then
		set GoldReward=GoldReward+100+GetHeroLevel(Victim)*9
		set DyingPlayerName=udg_Colors[pidv]+(PlayerNames[GetPlayerId((PVictim))])+"|r"
		set KillingPlayerName=udg_Colors[pidk]+(PlayerNames[GetPlayerId((PKiller))])+"|r"
		set GoldRewardStr="|c00FFDC00"+I2S(GoldReward)
		if LoadInteger(TempHash,'Assi',GetPlayerId(PKiller))>0 then
			set GoldRewardStr=GoldRewardStr+"(+"+I2S(LoadInteger(TempHash,'Assi',GetPlayerId(PKiller)))+")"
		endif
		set GoldRewardStr=GoldRewardStr+"|r"
		if PKiller==Sentinels[0]or PKiller==Scourges[0]then
			if AssistantCounter==0 then
				if PKiller==Sentinels[0]then
					set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n042')+" "+DyingPlayerName+GetObjectName('n043')+GetObjectName('n049')+" "+GoldRewardStr+" "+GetObjectName('n044')+"."//n042 -> pwned, n043 -> 's head!, n049 -> !, n044 -> gold is split
					call XF9(PKiller,GoldReward)
				elseif PKiller==Scourges[0]then
					set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n042')+" "+DyingPlayerName+GetObjectName('n043')+GetObjectName('n049')+" "+GoldRewardStr+" "+GetObjectName('n044')+"."//n042 -> pwned, n043 -> 's head!, n049 -> !, n044 -> gold is split
					call XF9(PKiller,GoldReward)
				endif
			elseif AssistantCounter>1 then
				set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n042')+" "+DyingPlayerName+GetObjectName('n043')+GetObjectName('n049')+" "+GoldRewardStr+" "+GetObjectName('n044')+"."//n042 -> pwned, n043 -> 's head!, n049 -> !, n044 -> gold is split
				call WH9(Victim,Killer,GoldReward)
			endif
		elseif tmpStoppedStreakString==""and tmpStreakString==""then
			set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n042')+" "+DyingPlayerName+GetObjectName('n043')+" "+GetObjectName('n04C')+" "+GoldRewardStr+" "+GetObjectName('n045')+GetObjectName('n049')//n042 -> pwned, n043 -> 's head!, n04C -> for, n045 -> gold!, n049 -> !
		elseif tmpStoppedStreakString==""and tmpStreakString!=""then
			set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n042')+" "+DyingPlayerName+GetObjectName('n043')+" "+GetObjectName('n04C')+" "+GoldRewardStr+" "+GetObjectName('n045')+GetObjectName('n049')//n042 -> pwned, n043 -> 's head!, n04C -> for, n045 -> gold!, n049 -> !
		elseif tmpStoppedStreakString!=""and tmpStreakString==""then
			set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n048')+" "+DyingPlayerName+GetObjectName('n047')+" "+tmpStoppedStreakString+" "+GetObjectName('n046')+" "+GoldRewardStr+" "+GetObjectName('n045')+GetObjectName('n049')//n048 -> has just ended, n047 -> 's, n046 -> streak for, n045 -> gold!, n049 -> !
		elseif tmpStoppedStreakString!=""and tmpStreakString!=""then
			set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n048')+" "+DyingPlayerName+GetObjectName('n047')+" "+tmpStoppedStreakString+" "+GetObjectName('n046')+" "+GoldRewardStr+" "+GetObjectName('n045')+GetObjectName('n049')//n048 -> has just ended, n047 -> 's, n046 -> streak for, n045 -> gold!, n049 -> !
		endif
		if isKillerBelongToPlayers then
			set assistsStringVar=V29(Victim,Killer)
		endif
		call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],resultingStrngOfKill+assistsStringVar)
		if tmpStreakString!=""then
			call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],KillingPlayerName+tmpStreakString)
		endif
		set ReliableGold[pidk]=ReliableGold[pidk]+GoldReward
		call DistribGoldToPlayerForUnit(PKiller,GoldReward,Victim)
		set GoldEarnedByKills[pidk]=GoldEarnedByKills[pidk]+GoldReward
		if OwningCounter[1]>4 then
			call X89(0)
		endif
		if OwningCounter[2]>4 then
			call X89(1)
		endif
	endif
	set GoldPenalty=GetHeroLevel(Victim)*30
	if FindItemOfType(Victim,Item_Real[bloodstone])!=null then
		if GetItemCharges(FindItemOfType(Victim,Item_Real[bloodstone]))>0 then
			set BloodstoneRespTimeBonus=-1*(3*GetItemCharges(FindItemOfType(Victim,Item_Real[bloodstone])))
		endif
	endif
	if GoldPenalty>DyingUnitOwnerUnreliableGold then
		set GoldPenalty=DyingUnitOwnerUnreliableGold
	endif
	call WB9(Victim)
	 if FindItemOfType(Killer,Item_Real[bloodstone])!=null and DistanceBetweenUnits(Killer,Victim)>1600 then
		call SetItemCharges(FindItemOfType(Killer,Item_Real[bloodstone]),GetItemCharges(FindItemOfType(Killer,Item_Real[bloodstone]))+1)
	endif
	call W29(Victim)
	call W59(Victim)
	set tt_unit1=Victim
	set tt_unit2=Killer
	call ExecuteFunc("FleshHeapDistr")
	if ShallowGraveStatus==false then
		set PlayerGoldLost[pidv]=PlayerGoldLost[pidv]+GoldPenalty
		call XG9(Victim,GoldPenalty)
	endif
	call SaveInteger(HY,(400+pidk),(450+pidv),((LoadInteger(HY,(400+pidk),(450+pidv)))+1))
	call SaveInteger(HY,(400+pidv),(500+pidk),((LoadInteger(HY,(400+pidv),(500+pidk)))+1))
	call TimerStart(MultikillTimers[pidk],18,false,function ResetMultikillTimer)
	if isNonPvsPKill==false and PKiller!=Sentinels[0]and PKiller!=Scourges[0]and PKiller!=Neutrals then
		set MultikillCounter[pidk]=MultikillCounter[pidk]+1
		if MultikillCounter[pidk]==2 then
			set DoubleKills[pidk]=DoubleKills[pidk]+1
			call SaveInteger(HY,'0SND','0PID',pidk)
			set Y99=GetObjectName('n04S')//n04S -> Double Kill
			call XE9(udg_Colors[pidk]+(PlayerNames[GetPlayerId((PKiller))])+"|r "+GetObjectName('n04D')+" |c000000ff"+Y99+"|r"+GetObjectName('n049'),1)//n04D -> just got a, n049 -> !
		endif
		if MultikillCounter[pidk]==3 then
			set TrippleKills[pidk]=TrippleKills[pidk]+1
			call SaveInteger(HY,'0SND','0PID',pidk)
			set Y99=GetObjectName('n04E')//n04E -> Triple Kill
			call XE9(udg_Colors[pidk]+(PlayerNames[GetPlayerId((PKiller))])+"|r "+GetObjectName('n04D')+" |c0000ff40"+Y99+"|r"+GetObjectName('n04B'),2)//n04D -> just got a, n04B -> !!!
		endif
		if MultikillCounter[pidk]==4 then
			set TrippleKills[pidk]=TrippleKills[pidk]+1
			call SaveInteger(HY,'0SND','0PID',pidk)
			set Y99=GetObjectName('n0HJ')//n0HJ -> Ultra Kill
			call XE9(udg_Colors[pidk]+(PlayerNames[GetPlayerId((PKiller))])+"|r "+GetObjectName('n04D')+" |c0000FFFF"+Y99+"|r"+GetObjectName('n04B'),3)//n04D -> just got a, n04B -> !!!
		endif
		if MultikillCounter[pidk]>4 then
			set TrippleKills[pidk]=TrippleKills[pidk]+1
			call SaveInteger(HY,'0SND','0PID',pidk)
			set Y99=GetObjectName('n0HK')//n0HK -> Rampage
			call XE9(udg_Colors[pidk]+(PlayerNames[GetPlayerId((PKiller))])+"|r "+GetObjectName('n04K')+" |c0000AAFF"+Y99+"|r"+GetObjectName('n04B'),4)//n04K -> is on a, n04B -> !!!
		endif
	endif
	if(isNonPvsPKill==false)then
		set PlayerKillsStreak[pidv]=0
	endif
	set PlayerKillsStreak[0]=0
	set PlayerKillsStreak[6]=0
	set Deaths[pidv]=Deaths[pidv]+1
	if ShallowGraveStatus then
		set ShallowGraveRespTimeMultiplier=.4
	endif
	if isNonPvsPKill and (GetUnitAbilityLevel(Victim,'A06B')+GetUnitAbilityLevel(Victim,'A471')>0) then//A06B -> Suicide Squad, Attack!
		if GetUnitAbilityLevel(Victim,'A06B')>0 then
			set TechiesSuicideRespTimeMultiplier=.5
		else
			set TechiesSuicideRespTimeMultiplier=.3
		endif
	else
		if GetUnitAbilityLevel(Victim,'A471')>0 then
			set TechiesSuicideRespTimeMultiplier=.8
			set tt_unit1=Victim
			call ExecuteFunc("TechiesSuicideAghOnDeath")
		endif
	endif
	
	set RespTime=((GetHeroLevel(Victim)*3.8+5+R2I(LoadReal(HeroStats,GetHandleId(Victim),26)))*TechiesSuicideRespTimeMultiplier+ReaperScytheFine)+R2I(BloodstoneRespTimeBonus)
	if Mode_FR then
		set RespTime=RespTime*.5
	endif
	if Mode_NoDeath then
		set PlayerTimeDead[pidv]=0
		call TimerStart(HeroRespawnTimer[pidv],1.,false,null)
	else
		set PlayerTimeDead[pidv]=PlayerTimeDead[pidv]+R2I(RespTime)
		if advancedTracking then
			call Traffic_RegisterData("LoD_DeadFor_"+R2S(RespTime),GetPlayerId(PVictim))
		endif
		call TimerStart(HeroRespawnTimer[pidv],RespTime,false,null)
	endif
	call TriggerExecute(TG)
	if Mode_DM==false then
		call WR9b(Victim,RespTime)
	else
		if(IsSentinel(PVictim))then
			set DM_Counter[0]=DM_Counter[0]+1
		endif
		if IsScourge(PVictim)then
			set DM_Counter[1]=DM_Counter[1]+1
		endif
		set DM_PrevHero[pidv]=Victim
		if GetUnitTypeId(Victim)=='H00J' then//H00J -> Geomancer
			set DM_PrevHero[pidv]=(LoadUnitHandle(HY,(GetHandleId(GetOwningPlayer(Victim))),699))
		endif
		if DM_Counter[0]==ModeDM_MaxLifes then
			call TriggerExecute(JK)
		endif
		if DM_Counter[1]==ModeDM_MaxLifes then
			call TriggerExecute(YK)
		endif
		if(GetUnitAbilityLevel(Victim,'Z234')>0)then//U006 -> Broodmother
			call ExecuteFunc("XJ9")
		elseif GetUnitAbilityLevel(Victim,'Q231')>0 then//U008 -> Lycanthrope, E015 -> Lycanthrope
			set VK=Victim
			call ExecuteFunc("YD9")
		elseif GetUnitAbilityLevel(Victim,'A0CY')>0 then//Ucrl -> Stone Giant
			set VK=Victim
			call ExecuteFunc("YE9")
		endif
	endif
	set Victim=null
	set Killer=null
	set PKiller=null
	set PVictim=null
	set t=null
	set tmpKillingUnit=null
	set tmpDyingUnit=null
endfunction

function FB_Wrap takes unit killer, unit victim returns nothing
	local player p=GetOwningPlayer(killer)
	local string s
	local integer assists=WF9(victim,killer)
	local integer i=1
	local integer pid
	local integer gold=150
	if p==Sentinels[0]or p==Scourges[0]then
		call WH9(victim,killer,gold)
		set s=WE9(victim,killer)+" "+GetObjectName('n04W')+" |c00ff0303"+GetObjectName('n04Y')+GetObjectName('n049')+"|r "//n04W -> just drew, n04Y -> first blood, n049 -> !
		if assists>1 then
			set s=s+"(+"+I2S(gold)+" "+GetObjectName('n044')+")"//n044 -> gold is split
		else
			set s=s+"(+"+I2S(gold)+" "+GetObjectName('n045')+")"//n045 -> gold!
		endif
		loop
			exitwhen i>5
			if IsSentinel(GetOwningPlayer(killer))then
				set pid=GetPlayerId(Sentinels[i])
			else
				set pid=GetPlayerId(Scourges[i])
			endif
			set i=i+1
		endloop
	else
		set pid=GetPlayerId(p)
		set s=udg_Colors[pid]+(PlayerNames[pid])+"|r "+GetObjectName('n04W')+" |c00ff0303"+GetObjectName('n04Y')+GetObjectName('n049')+"|r "//n04W -> just drew, n04Y -> first blood, n049 -> !
		set s=s+"(+"+I2S(gold)+" "+GetObjectName('n045')+")"//n045 -> gold!
		call DistribGoldToPlayerForUnit(p,gold,udg_Hero[pid])
		set ReliableGold[pid]=ReliableGold[pid]+gold
	endif
	call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],s)
	call BX8(Sounds_FB)
	set FBHappened=true
	set p=null
endfunction

function FB_Check takes nothing returns nothing
	local unit killer=GetKillingUnit()
	local unit victim=GetTriggerUnit()
	local player pk=GetOwningPlayer(killer)
	if FBHappened==false then
		if pk!=Neutrals and killer!=null and IsPlayerEnemy(GetOwningPlayer(victim),pk) then
			if pk==Sentinels[0]or pk==Scourges[0]then
				if WF9(victim,killer)>0 then
					call FB_Wrap(killer,victim)
				endif
			else
				call FB_Wrap(killer,victim)
			endif
		endif
	endif
endfunction

function HealHeroForAegisAct takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local player p
	local real heal
	local unit u=(LoadUnitHandle(HY,h,0))
	local integer c=(LoadInteger(HY,h,34))
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		set c=c+1
		call SaveInteger(HY,h,34,(c))
	endif
	if c>5/0.05 or(GetTriggerEventId()==EVENT_UNIT_DAMAGED and GetEventDamage()>20) or GetUnitAbilityLevel(u,'A3KL')==0 then
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	else
		call SetUnitState(u,UNIT_STATE_LIFE,GetUnitState(u,UNIT_STATE_LIFE)+0.2*GetUnitState(u,UNIT_STATE_MAX_LIFE)*0.05)
		call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+0.2*GetUnitState(u,UNIT_STATE_MAX_MANA)*0.05)
	endif
	set t=null
	set u=null
endfunction

function HealHeroForAegis takes unit u returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,0.05,true)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function HealHeroForAegisAct))
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call UnitAddAbilityTimedExF(u,'A3KL',1,5,'B3KL')
	call SaveReal(HY,GetHandleId(t),0,TimerGetElapsed(GlobalTimer)+5)
	set t=null
endfunction

function YN9 takes nothing returns nothing
	local integer i=1
	local unit Hero
	set K27=null
	loop
		exitwhen i>5
		set Hero=udg_Hero[GetPlayerId(Sentinels[i])]
		if Hero!=null and FindItemOfType(Hero,Item_Real[Aegis])!=null then
			call DisableTrigger(t_manipulateitem)
			call Traffic_RegisterData("AegisOff",GetPlayerId(GetOwningPlayer(Hero)))
			call RemoveItem(FindItemOfType(Hero,Item_Real[Aegis]))
			call EnableTrigger(t_manipulateitem)
			call HealHeroForAegis(Hero)
		endif
		set Hero=udg_Hero[GetPlayerId(Scourges[i])]
		if Hero!=null and FindItemOfType(Hero,Item_Real[Aegis])!=null then
			call DisableTrigger(t_manipulateitem)
			call Traffic_RegisterData("AegisOff",GetPlayerId(GetOwningPlayer(Hero)))
			call RemoveItem(FindItemOfType(Hero,Item_Real[Aegis]))
			call EnableTrigger(t_manipulateitem)
			call HealHeroForAegis(Hero)
		endif
		set i=i+1
	endloop
	set Hero=null
endfunction

function YO9 takes string YP9,string YQ9 returns string
	local string s=GetObjectName('n0CA')//n0CA -> Roshan has been slain by the $team! Each $team player receives 200 bonus gold.
	set s=str_replace(s,"$team",YP9)
	set s=str_replace(s,"$team",YQ9)
	return s
endfunction

function RoshanSlamFilter takes nothing returns boolean
	return IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'BCtc')>0//BCtc -> Slam
endfunction

function RoshanSlamDmg takes nothing returns nothing
	call DamageTarget(Roshan,GetEnumUnit(),1, 70+R2I(TimerGetElapsed(GlobalTimer)/240)*20 )
endfunction

function RoshanSlamPost takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(Roshan),GetUnitY(Roshan),375,Condition(function RoshanSlamFilter))
	call ForGroup(g,function RoshanSlamDmg)
	call KillGroup(g)
	set g=null
	set t=null
endfunction

function RoshanSlamAct takes nothing returns nothing
	call TimerStart(CreateTimer(),0,false,function RoshanSlamPost)
endfunction

function RoshanSlam takes nothing returns nothing
	if GetTriggerUnit()==Roshan and GetSpellAbilityId()=='ACtc' then//ACtc -> Slam
		if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
			call RoshanSlamAct()
		else
			//call SetUnitAnimationByIndex(Roshan,1)
		endif
	endif
endfunction

function IsHero takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO))!=null
endfunction

function AddMaxHPFx takes unit u,integer d returns nothing
	local integer array b
	local integer a=d
	local integer c=1
	local integer i=0
	local integer k
	if d<1 then
		return
	endif
	loop
		exitwhen c==0
		set c=a/2
		set b[i]=a-c*2
		set a=c
		set i=i+1
	endloop
	set k=13
	set i=0
	loop
		exitwhen i>k
		if b[i]==1 then
			call UnitAddAbility2(u,MaxHPBonusSystem[i])
			call SetUnitAbilityLevel(u,MaxHPBonusSystem[i],2)
			call UnitRemoveAbility(u,MaxHPBonusSystem[i])
		endif
		set i=i+1
	endloop
endfunction

function RoshanBuffer takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local real time=TimerGetElapsed(GlobalTimer)-GameStartsTime
	local integer level=R2I(time / 600)
	if level>4 then
		set level=4
	endif
	if IsDead(Roshan)==false and level>0 and GameStartsTime>0 then
		call UnitAddAbility2(Roshan,'A43T')
		call UnitAddAbility2(Roshan,'A43U')
		call SetUnitAbilityLevel(Roshan,'A43T',level)
		call SetUnitAbilityLevel(Roshan,'A43U',level)
	endif
	set t=null
endfunction

function RoshanAdjustHP takes nothing returns nothing
	local integer hp=RoshanUpgradesLevel*500
	local integer curhp=LoadInteger(HY,GetHandleId(Roshan),'MXHP')
	if hp!=curhp then
		call AddMaxHPFx(Roshan,IMaxIF(hp-curhp,0))
		call SaveInteger(HY,GetHandleId(Roshan),'MXHP',hp)
	endif
endfunction

function RoshanAddArmor takes nothing returns nothing
	local integer baseId='A3BA'
	local integer lvl=0
	local integer offset=0
	local integer reqlvl=IMinIF(RoshanUpgradesLevel,20)
	if RoshanUpgradesLevel==0 then
		return
	endif
	set offset=R2I((reqlvl-1)/4)
	set lvl=reqlvl-offset*4
	call UnitAddAbility3(Roshan,baseId+offset,lvl)
	
endfunction

function YM9 takes nothing returns boolean
	set RoshanUpgradesLevel=GetTriggerEvalCount(GetTriggeringTrigger())
	if Roshan!=null and GetUnitState(Roshan,UNIT_STATE_LIFE)>1 then
		call RoshanAdjustHP()
		call SetPlayerTechResearched(GetOwningPlayer(Roshan),'R00F',RoshanUpgradesLevel)
		call RoshanAddArmor()
	endif
	return false
endfunction

function Func0573 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call ExecuteFunc("YU9")
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	else
		if GetUnitAbilityLevel(Roshan,'B0BI')==0 then
			call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
		endif
		if LoadInteger(HY,h,0)==15 or GetTriggerEvalCount(t)==1 then
			call SaveInteger(HY,h,0,0)
			set u=CreateUnit(Neutrals,'e00E',GetUnitX(Roshan),GetUnitY(Roshan),0)
			call UnitAddAbility(u,'A3KM')
			call IssueTargetOrderById(u,852572,Roshan)
			set u=null
		endif
		if ModuloInteger(GetTriggerEvalCount(t),10)==0 then
			if RectContainsUnit(RoshanCanWalkHere,Roshan)==false then
				if(LoadBoolean(HY,(h),91)) then
					call SaveBoolean(HY,(h),91,(false))
				else
					call SetUnitPosition(Roshan,GetRectCenterX(RoshanSpawnRect),GetRectCenterY(RoshanSpawnRect))
					call SaveBoolean(HY,(h),91,(true))
				endif
			endif
		endif
	endif
	set t=null
	return false
endfunction

function Func0574 takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterUnitEvent(t,Roshan,EVENT_UNIT_DEATH)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function Func0573))
	call SaveBoolean(HY,(h),91,(true))
	set t=null
endfunction

function RoshanSetups takes nothing returns nothing
	set Roshan=CreateUnit(Player(12),'n00L',GetRectCenterX(RoshanSpawnRect),GetRectCenterY(RoshanSpawnRect),180.0)//n00L -> Roshan
	call SetUnitAcquireRange(Roshan,150)
	call Func0574()
	if RoshanCounter>1 then
		call UnitRemoveAbility(Roshan,'A0K2')//A0K2 -> Inventory (1 SLOT)
		call UnitAddAbility(Roshan,'A0Q6')//A0Q6 -> Inventory (2 SLOT ROSHAN)
		call UnitAddItem(Roshan,CreateItem(Item_Real[FakeCheese],0,0))
	endif
	call UnitAddItem(Roshan,CreateItem(Item_Real[FakeAegis],0,0))
	call RoshanAddArmor()
	
endfunction

function YS9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local real U68
	local integer RespTime=LoadInteger(HY,GetHandleId(t),0)
	if GetTriggerEvalCount(t)==RespTime or ZM7 then
		set ZM7=false
		call YN9()
		set RoshanCounter=RoshanCounter+1
		call RoshanSetups()
		call RoshanAdjustHP()
		call SetPlayerTechResearched(GetOwningPlayer(Roshan),'R00F',RoshanUpgradesLevel)
		call CleanTrigger(t)
	elseif GetTriggerEvalCount(t)==300 then
		call YN9()
	endif
	set t=null
	return false
endfunction

function YU9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	local item it
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function YS9))
	if IsL1ch then
		call SaveInteger(HY,GetHandleId(t),0,GetRandomInt(4,6))
	else
		call SaveInteger(HY,GetHandleId(t),0,GetRandomInt(480,660))
	endif
//	call echo(I2S(LoadInteger(HY,GetHandleId(t),0)))
	set ZM7=false
	set M47=false
	set it=CreateItem(Item_Dummy[Aegis],GetUnitX(Roshan),GetUnitY(Roshan))
	call SetItemCharges(it,1)
	if GetUnitAbilityLevel(Roshan,'A0Q6')==1 then
		set it=CreateItem(Item_Dummy[Cheese],GetUnitX(Roshan),GetUnitY(Roshan))
		call SetItemCharges(it,1)
	endif
	call RemoveItem(UnitRemoveItemFromSlot(Roshan,0))
	call RemoveItem(UnitRemoveItemFromSlot(Roshan,1))
	call CreateUnitAtLoc(Player(12),'e01V',GetRectCenter(RoshanSpawnRect),0)//e01V -> Spellcaster #3
	if(IsSentinel(GetOwningPlayer(GetKillingUnit())))then
		call Traffic_RegisterData("Roshan",0)
		call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())],YO9("|c00ff0000"+GetObjectName('n065')+"|r",GetObjectName('n065')))//n065 -> Sentinel, n065 -> Sentinel
		set LastRoshanSlayer=0
		call AddGold(Sentinels[1],200)
		call AddGold(Sentinels[2],200)
		call AddGold(Sentinels[3],200)
		call AddGold(Sentinels[4],200)
		call AddGold(Sentinels[5],200)
	endif
	if(IsScourge(GetOwningPlayer(GetKillingUnit())))then
		call Traffic_RegisterData("Roshan",1)
		call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())],YO9("|c00004000"+GetObjectName('n06C')+"|r",GetObjectName('n06C')))//n06C -> Scourge, n06C -> Scourge
		set LastRoshanSlayer=1
		call AddGold(Scourges[1],200)
		call AddGold(Scourges[2],200)
		call AddGold(Scourges[3],200)
		call AddGold(Scourges[4],200)
		call AddGold(Scourges[5],200)
	endif
	set t=null
endfunction

function RoshanDeath takes unit victim returns nothing
	if GetUnitTypeId(victim)=='n00L' then//n00L -> Roshan
		call YU9()
	endif
endfunction

function Y39 takes player victim,player killer returns string
	local string s=GetObjectName('n0AP')//n0AP -> $dead's courier has been killed!
	set s=str_replace(s,"$dead",PlayerNames[GetPlayerId(victim)])
	//call echo(GetPlayerName(killer))
	//set s=s+" by "+udg_Colors[GetPlayerId(killer)]+PlayerNames[GetPlayerId(killer)]+" !"
	return s
endfunction

function Y69 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,false)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	return false
endfunction

function YL9 takes unit Source returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,true)
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function Y69))
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	set Source=null
	set t=null
endfunction

function Y19 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit courier=(LoadUnitHandle(HY,h,2))
	local integer Count=GetTriggerEvalCount(t)
	local integer Y59=LoadInteger(HY,h,0)-Count
	local integer i=1
	local integer id
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	loop
		exitwhen i>5
		if IsPlayerAlly(GetOwningPlayer(courier),Sentinels[0])then
			set id=GetPlayerId(Sentinels[i])
		else
			set id=GetPlayerId(Scourges[i])
		endif
		set i=i+1
		if Y59==0 then
			if IsPlayerAlly(Sentinels[0],Player(id))then
				set CourierDead[GetPlayerId(Sentinels[0])]=false
			endif
			if IsPlayerAlly(Scourges[0],Player(id))then
				set CourierDead[GetPlayerId(Scourges[0])]=false
			endif
		endif
	endloop
	if Y59==2 then
		call SetUnitPosition(courier,x,y)
	endif
	if Y59==0 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set courier=null
	return false
endfunction

function GiveRealExpToUnitsAround takes nothing returns nothing
	if(GetUnitLevel(GetEnumUnit())<25 or Mode_UL)then	
		call AddHeroXP(GetEnumUnit(),GlobalKillerExp,true)
	endif
endfunction

function ProvideExp takes integer xp, player p, unit killer returns nothing
	if(xp>0 and p!=Neutrals and p!=null) then
		if IsUnitType(GetTriggerUnit(),UNIT_TYPE_SUMMONED) then
			set xp=R2I(xp*0.5)
		endif
		set GlobalKiller=killer
		call getHeroesAround()
		if(FirstOfGroup(ShareExpGroup)!=null)then
			set GlobalKillerExp=R2I(xp/CountUnitsInGroup(ShareExpGroup))
			call ForGroup(ShareExpGroup,function GiveRealExpToUnitsAround)
		endif
		set GlobalKiller=null
	endif
endfunction

function Z49 takes nothing returns boolean
	local real x
	local real y
	local unit courier=GetTriggerUnit()
	local integer i=1
	local integer WE8=175
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	
	if IsBasicCourier(courier) then
		set WE8=150
		call SaveInteger(HY,h,0,140)
		call SaveReal(HY,GetHandleId(courier),'DEAD',TimerGetElapsed(GlobalTimer)+140)
	else
		call SaveInteger(HY,h,0,180)
		call SaveReal(HY,GetHandleId(courier),'DEAD',TimerGetElapsed(GlobalTimer)+180)
	endif
	call Traffic_RegisterData("Courier"+I2S(GetPlayerId(GetOwningPlayer(courier))),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call DisplayTimedTextToForceEx(AllPlayers,10.,Y39(GetOwningPlayer(courier),GetOwningPlayer(GetKillingUnit())))
	call ProvideExp(349,GetOwningPlayer(LoadUnitHandle(HY,GetHandleId(courier),'lstd')),LoadUnitHandle(HY,GetHandleId(courier),'lstd'))
	call PingMinimapEx(GetUnitX(courier),GetUnitY(courier),6,255,0,0,false)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function Y19))
	call SaveUnitHandle(HY,h,2,(courier))
	
	if IsPlayerAlly(GetOwningPlayer(courier),Sentinels[0]) and CourierDead[GetPlayerId(Sentinels[0])]==false then
		set CourierDead[GetPlayerId(Sentinels[0])]=true
		loop
			exitwhen i>5
			call TextTagWithGold(Scourges[i],WE8)
			set i=i+1
		endloop
	endif
	set i=1
	if IsPlayerAlly(GetOwningPlayer(courier),Scourges[0]) and CourierDead[GetPlayerId(Scourges[0])]==false then
		set CourierDead[GetPlayerId(Scourges[0])]=true
		loop
			exitwhen i>5
			call TextTagWithGold(Sentinels[i],WE8)
			set i=i+1
		endloop
	endif
	if IsSentinel(GetOwningPlayer(courier))then
		set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
		set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
	else
		set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
		set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
	endif
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	if IsTerrainPathable(GetUnitX(courier),GetUnitY(courier),PATHING_TYPE_WALKABILITY)then
		call YL9(courier)
	endif
	set t=null
	set courier=null
	return false
endfunction

function Z79 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real x=HS
	local real y=ZS
	if IsScourge(GetOwningPlayer(Source))then
		set x=EC7
		set y=E37
	endif
	if IsDead(Source)==false then
		if DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),x,y)<800 then
			call SaveCourierState(Source,"At home")
		endif
	endif
	set t=null
	set Source=null
	return false
endfunction

function DefineMainCourier takes unit u returns nothing
	local player p=GetOwningPlayer(u)
	if HaveSavedHandle(HeroStats,GetHandleId(p),'COUR')==false then
		call SaveUnitHandle(HeroStats,GetHandleId(p),'COUR',u)
	endif
endfunction

function DefineCourierForPlayer takes player p returns nothing
	if HaveSavedHandle(HeroStats,GetHandleId(p),'COUR') then
		if GetPlayerAlliance(GetOwningPlayer(LoadUnitHandle(HeroStats,GetHandleId(p),'COUR')),p,ALLIANCE_SHARED_CONTROL) then
			return
		endif
	endif
	call SaveUnitHandle(HeroStats,GetHandleId(p),'COUR',GetBestCourier(p))
endfunction

function CourierConstantMovespeed takes unit c returns nothing
	if IsDead(c)==false then
		call UnitRemoveAbility(c,'A00D')
		call UnitRemoveAbility(c,'A2HR')
		call UnitRemoveAbility(c,'A1VR')
		call UnitRemoveAbility(c,'A38Z')
		call UnitRemoveAbility(c,'A12V')
		call UnitRemoveAbility(c,'A05U')
		call UnitRemoveAbility(c,'AIms')
		call UnitRemoveAbility(c,'A2I9')
		call UnitRemoveAbility(c,'EUL1')
		call UnitRemoveAbility(c,'EUL2')
		call SetUnitState(c,UNIT_STATE_MANA,0)
		call UnitRemoveAbility(c,'AImb')
	endif
endfunction

function CourierOrder takes nothing returns nothing
	local integer id
	local unit u
	local integer h=GetHandleId(GetTriggeringTrigger())
	local integer c
	local real x
	local real y
	if GetTriggerEventId()!=EVENT_GAME_TIMER_EXPIRED then
		set id=GetIssuedOrderId()
		if id>=852008 and id<=852013then
			set id=GetIndex(UnitItemInSlot(GetTriggerUnit(),id-852008))
			if id!=HealingSalve and id!=ClarityPotion and id!=Mango and id!=Smoke then
				call InterruptUnit(GetTriggerUnit())
			endif
		elseif id!='h085' and id!=852663 and id!=851973 and id!='h0DE' and id!='h0BV' and id!=852252 and id!=852247 and id!=852246 and id!=852100 and (GetIssuedOrderId()< 852002 or GetIssuedOrderId()>852013) then//all default buttons//h085 -> Transfer Items, h0DE -> Resume Delivery, h0BV -> Collect Your Items
			if IsTriggeredOrder(GetTriggerUnit())==false then
				call SaveCourierState(GetTriggerUnit(),"Manual control")
			endif
		endif
	else
		set u=LoadUnitHandle(HY,h,0)
		if IsDead(u) then
			set u=null
			return
		endif
		set id=GetUnitCurrentOrder(u)
		
		set x=HS
		set y=ZS
		if IsScourge(GetOwningPlayer(u))then
			set x=EC7
			set y=E37
		endif
		if DistanceBetweenXY(GetUnitX(u),GetUnitY(u),x,y)<800 then
			call SaveCourierState(GetTriggerUnit(),"At home")
		elseif id==852001 then//dropitem
			call SaveCourierState(GetTriggerUnit(),"Manual control")
		elseif LoadReal(HY,h,0)==GetUnitX(u) and LoadReal(HY,h,1)==GetUnitY(u) then
			call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
			if LoadInteger(HY,h,0)>=5 then
				call SaveCourierState(u,"Stand still")
			endif
		else
			if LoadInteger(HY,h,0)>0 then
				call SaveInteger(HY,h,0,0)
				call SaveCourierState(u,"Going somewhere")
			endif
			call SaveReal(HY,h,0,GetUnitX(u))
			call SaveReal(HY,h,1,GetUnitY(u))
		endif
		if ModuloInteger(GetTriggerEvalCount(GetTriggeringTrigger()),10)==1 then
			call CourierConstantMovespeed(u)
		endif
	endif
endfunction

function CourierDamageTrackerFunc takes nothing returns nothing
	local unit target=GetTriggerUnit()
	local unit attacker=GetEventDamageSource()
	if GetEventDamage()>0 then
		call SaveUnitHandle(HY,GetHandleId(target),'lstd',attacker)
		if IsFakeDamage<1 and IsUnitType(attacker,UNIT_TYPE_MELEE_ATTACKER) and IsUnitIdType(GetUnitTypeId(attacker),UNIT_TYPE_HERO) then
			call DamageTargetDelayed(attacker,target,10,GetEventDamage()*0.5,0.)
		endif
	endif
	set target=null
	set attacker=null
endfunction

function Z89 takes unit u returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterDeathEvent(t,u)
	call TriggerAddCondition(t,Condition(function Z49))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddCondition(t,Condition(function Z79))
	call SaveUnitHandle(HY,h,2,(u))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_ORDER)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterTimerEvent(t,0.1,true)
	call TriggerAddCondition(t,Condition(function CourierOrder))
	call SaveUnitHandle(HY,h,0,u)
	call DefineMainCourier(u)
	set t=null
	if CourierDamageTracker==null then
		set CourierDamageTracker=CreateTrigger()
		call TriggerAddCondition(CourierDamageTracker,Condition(function CourierDamageTrackerFunc))
	endif
	call TriggerRegisterUnitEvent(CourierDamageTracker,u,EVENT_UNIT_DAMAGED)
endfunction

function CourierDeath takes unit u returns nothing
	local player p=GetOwningPlayer(u)
	local integer pid=GetPlayerId(p)
	if IsCourier(u)and IsUnitIllusion(u)==false then
		call DisplayTimedTextToForceEx(AllPlayers,10.,udg_Colors[pid]+PlayerNames[pid]+"|r's courier has been |c00ff0000PERMANENTLY|r killed. It won't respawn.")
		call PingMinimapEx(GetUnitX(u),GetUnitY(u),6,255,0,0,false)
	endif
endfunction

function GetFakeRune takes integer id returns integer
	if id=='I006' then//I006 -> |c00ff0303Haste|r
		return 'I0QB'//I0QB -> |c00ff0303Haste|r
	elseif id=='I007' then//I007 -> |c00fffc01Illusion|r
		return 'I0QC'//I0QC -> |c00fffc01Illusion|r
	elseif id=='I00K' then//I00K -> |c000042ffDouble Damage|r
		return 'I0QD'//I0QD -> |c000042ffDouble Damage|r 
	elseif id=='I008' then//I008 -> |cff00ff00Regeneration|r
		return 'I0QE'//I0QE -> |cff00ff00Regeneration|r
	elseif id=='I00J' then//I00J -> |cff99ccffInvisibility|r
		return 'I0QF'//I0QF -> |cff99ccffInvisibility|r
	elseif id=='I0QA' then//I0QA -> |c00ffff01Bounty|r
		return 'I0QG'//I0QG -> |c00ffff01Bounty|r
	endif
	return 0
endfunction

function GetRealRune takes integer id returns integer
	if id=='I0QB' then//I0QB -> |c00ff0303Haste|r
		return 'I006'//I006 -> |c00ff0303Haste|r
	elseif id=='I0QC' then//I0QC -> |c00fffc01Illusion|r
		return 'I007'//I007 -> |c00fffc01Illusion|r
	elseif id=='I0QD' then//I0QD -> |c000042ffDouble Damage|r 
		return 'I00K'//I00K -> |c000042ffDouble Damage|r
	elseif id=='I0QE' then//I0QE -> |cff00ff00Regeneration|r
		return 'I008'//I008 -> |cff00ff00Regeneration|r
	elseif id=='I0QF' then//I0QF -> |cff99ccffInvisibility|r
		return 'I00J'//I00J -> |cff99ccffInvisibility|r
	elseif id=='I0QG' then//I0QG -> |c00ffff01Bounty|r
		return 'I0QA'//I0QA -> |c00ffff01Bounty|r
	endif
	return 0
endfunction

function IsFakeRune takes integer i returns boolean
	return i=='I0QB' or i=='I0QC' or i=='I0QD' or i=='I0QE' or i=='I0QF' or i=='I0QG'//I0QB -> |c00ff0303Haste|r, I0QC -> |c00fffc01Illusion|r, I0QD -> |c000042ffDouble Damage|r , I0QE -> |cff00ff00Regeneration|r, I0QF -> |cff99ccffInvisibility|r, I0QG -> |c00ffff01Bounty|r
endfunction

function IsRune takes integer i returns boolean
	return i=='I006' or i=='I008' or i=='I00J' or i=='I00K' or i=='I007' or i=='I0QA'//I006 -> |c00ff0303Haste|r, I008 -> |cff00ff00Regeneration|r, I00J -> |cff99ccffInvisibility|r, I00K -> |c000042ffDouble Damage|r, I007 -> |c00fffc01Illusion|r, I0QA -> |c00ffff01Bounty|r
endfunction

function ZG9 takes nothing returns nothing
	if GetWidgetLife(GetEnumItem())>0 and IsFakeRune(GetItemTypeId(GetEnumItem()))then
		set tt_item1=GetEnumItem()
	endif
endfunction

function ZH9 takes nothing returns integer
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=T77
		set i=GetRandomInt(1,5)
	endloop
	set T77=i
	return i
endfunction

function FirstBountyFuckers takes nothing returns nothing
	set doubledBounty=false
endfunction

function RuneSpawn takes nothing returns boolean
	local boolean ZJ9=false
	local boolean ZK9=false
	local real x
	local real y
	local real dx
	local real dy
	local real x1
	local real y1
	local real x2
	local real y2
	local integer ZM9
	set x1=GetLocationX(TopRuneSpawn)
	set y1=GetLocationY(TopRuneSpawn)
	set x2=GetLocationX(BottomRuneSpawn)
	set y2=GetLocationY(BottomRuneSpawn)
	set tt_item1=null
	call EnumItemsInRect(TopRuneSpawnRect,Condition(function ReturnTrue),function ZG9)
	set ZJ9=true
	if tt_item1!=null then
		call RemoveItem(tt_item1)
	endif
	set tt_item1=null
	call EnumItemsInRect(BottomRuneSpawnRect,Condition(function ReturnTrue),function ZG9)
	set ZK9=true
	if tt_item1!=null then
		call RemoveItem(tt_item1)
	endif
	set ZM9=ZH9()
	if GetRandomInt(1,2)==1 then
		set x=x1
		set y=y1
		set dx=x2
		set dy=y2
	else
		set x=x2
		set y=y2
		set dx=x1
		set dy=y1
	endif
	if IsRuneFirstSpawn then
		set IsRuneFirstSpawn=false
		call CreateItem(GetFakeRune('I0QA'),dx,dy)//I0QA -> |c00ffff01Bounty|r
		call CreateItem(GetFakeRune('I0QA'),x,y)//I0QA -> |c00ffff01Bounty|r
		call TimerStart(CreateTimer(),120,false,function FirstBountyFuckers)
	else
		if ZM9==1 then
			call CreateItem(GetFakeRune('I007'),x,y)//I007 -> |c00fffc01Illusion|r
		elseif ZM9==2 then
			call CreateItem(GetFakeRune('I006'),x,y)//I006 -> |c00ff0303Haste|r
		elseif ZM9==3 then
			call CreateItem(GetFakeRune('I00K'),x,y)//I00K -> |c000042ffDouble Damage|r
		elseif ZM9==4 then
			call CreateItem(GetFakeRune('I008'),x,y)//I008 -> |cff00ff00Regeneration|r
		elseif ZM9==5 then
			call CreateItem(GetFakeRune('I00J'),x,y)//I00J -> |cff99ccffInvisibility|r
		endif
		call CreateItem(GetFakeRune('I0QA'),dx,dy)//I0QA -> |c00ffff01Bounty|r
	endif
	return false
endfunction

function ZP9 takes unit Source returns nothing
	local real x
	local real y
	if IsSentinel(GetOwningPlayer(Source))then
		set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
		set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
	else
		set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
		set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
	endif
	call CourierIssuePointOrder(Source,ORDER_move,x,y)
	call SaveCourierState(Source,"Going home")
endfunction

function ZQ9 takes nothing returns nothing
	local item Item=GetEnumItem()
	if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==U07 and V47==0 then
		set V47=V47+1
		call UnitAddItem(U57,Item)
	endif
	set Item=null
endfunction

function ZR9 takes nothing returns nothing
	local item Item=GetEnumItem()
	if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==U07 then
		call UnitAddItem(U27,Item)
	endif
	set Item=null
endfunction

function ZS9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,2))
	local unit Courier=(LoadUnitHandle(HY,h,92))
	local player p=(LoadPlayerHandle(HY,h,54))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local rect r=Rect(x-300,y-300,x+300,y+300)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		set U07=p
		set U57=Hero
		set U27=Courier
		call EnumItemsInRect(r,Condition(function ReturnTrue),function ZR9)
	else
		if GetTriggerEvalCount(t)>9 then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			set U07=p
			set U57=Hero
			set U27=Courier
			call EnumItemsInRect(r,Condition(function ReturnTrue),function ZR9)
		else
			set U07=p
			set U57=Hero
			set V47=0
			call EnumItemsInRect(r,Condition(function ReturnTrue),function ZQ9)
		endif
	endif
	call RemoveRect(r)
	set t=null
	set Hero=null
	set Courier=null
	set r=null
	return false
endfunction

function ZT9 takes unit Courier,unit Hero returns nothing
	local player p=GetOwningPlayer(Hero)
	local integer i
	local item Item
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real x=GetUnitX(Courier)
	local real y=GetUnitY(Courier)
	local integer indexId
	if IsTerrainPathable(x,y,PATHING_TYPE_WALKABILITY)then
		set x=GetUnitX(Hero)
		set y=GetUnitY(Hero)
	endif
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerRegisterTimerEvent(t,.01,true)
	call TriggerAddCondition(t,Condition(function ZS9))
	call SaveUnitHandle(HY,h,2,(Hero))
	call SaveUnitHandle(HY,h,92,(Courier))
	call SavePlayerHandle(HY,h,54,(p))
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	set i=0
	loop
		exitwhen i>5
		set Item=UnitItemInSlot(Courier,i)
		set indexId=GetIndex(Item)
		if Item!=null and GetItemPlayer(Item)==p and (indexId!=BottleInvis and indexId!=BottleDD and indexId!=BottleHaste and indexId!=BottleRegen and indexId!=BottleIllusion)then
			call UnitRemoveItem(Courier,Item)
			call SetItemPosition(Item,x,y)
		endif
		set i=i+1
	endloop
	set t=null
	set Item=null
endfunction

function IsCourierStunned takes unit Unit returns boolean
	local integer i=GetUnitCurrentOrder(Unit)
	return(i==0)or(i==851975)or(i==851987)or(i==851993)
endfunction

function CourierReissueDeliveryXY takes integer h returns nothing
	local unit courier=LoadUnitHandle(HY,h,92)
	local unit target=LoadUnitHandle(HY,h,2)
	local real x
	local real y
	local real dist
	local real ms
	local real angle
	local real oldX
	local real oldY
	local real left
	local real anglediff
	local real hx=GetUnitX(target)
	local real hy=GetUnitY(target)
	if(IsCourierStunned(target)==false)then
		set x=GetUnitX(target)
		set y=GetUnitY(target)
		set oldX=LoadReal(HY,h,677)
		set oldY=LoadReal(HY,h,678)
		call SaveReal(HY,h,677,x*1.)
		call SaveReal(HY,h,678,y*1.)
		set angle=Atan2(y-oldY,x-oldX)
		set dist=SquareRoot((x-oldX)*(x-oldX)+(y-oldY)*(y-oldY))/ .2
		set ms=GetUnitMoveSpeedLOD(courier)
		set left=DistanceBetweenXY(GetUnitX(target),GetUnitY(target),GetUnitX(courier),GetUnitY(courier))
		set anglediff=RAbsBJ(angle*bj_RADTODEG-GetUnitFacing(courier))
		if(left < ms-dist and ms > dist)or(left < RMaxBJ(ms,dist)and anglediff >= 90)then
		else
			set hx=x+dist*Cos(angle)
			set hy=y+dist*Sin(angle)
		endif
	endif
	call SaveInteger(HY,h,679,1)
	call CourierIssuePointOrder(courier,ORDER_move,hx,hy)
	set courier=null
	set target=null
endfunction

function RemoveSavedI takes hashtable h, integer pk, integer ck returns boolean
	call RemoveSavedInteger(h,pk,ck)
	return true
endfunction

function ReceiveItems takes unit courier, unit hero, boolean light, integer desired returns nothing
	local integer i=0
	local item it
	local integer k=0
	local integer lim=0
	local integer j
	local player p=GetOwningPlayer(hero)
	local integer parts
	local integer partsfound
	local string s
	call FlushChildHashtable(HY,'ITEM')
	loop
		set it=UnitItemInSlot(courier,i)
		if it!=null and (GetItemPlayer(it)==p or GetPlayerSlotState(GetItemPlayer(it))==PLAYER_SLOT_STATE_LEFT) then
			call SaveItemHandle(HY,'ITEM',k,it)
			call SaveInteger(HY,'ITEM',k,GetIndex(it))
			set k=k+1
		endif
		set it=UnitItemInSlot(hero,i)
		if it!=null and (GetItemPlayer(it)==p or GetPlayerSlotState(GetItemPlayer(it))==PLAYER_SLOT_STATE_LEFT) then
			call SaveItemHandle(HY,'ITEM',k,it)
			call SaveInteger(HY,'ITEM',k,GetIndex(it))
			set k=k+1
		endif
		set i=i+1
		exitwhen i>5
	endloop
	set it=null
	if light==false and k<=6 then
		return
	endif
	set lim=k
	set k=1
	if light then
		set k=desired
	endif
	loop
		call SaveInteger(HY,'ITEM',51,Rec_Comp_1[k])
		call SaveInteger(HY,'ITEM',52,Rec_Comp_2[k])
		call SaveInteger(HY,'ITEM',53,Rec_Comp_3[k])
		call SaveInteger(HY,'ITEM',54,Rec_Comp_4[k])
		call SaveInteger(HY,'ITEM',55,Rec_Comp_5[k])
		set partsfound=0
		set parts=0
		set i=0
		if Rec_Comp_1[k]!=0 then
			set parts=parts+1
		endif
		if Rec_Comp_2[k]!=0 then
			set parts=parts+1
		endif
		if Rec_Comp_3[k]!=0 then
			set parts=parts+1
		endif
		if Rec_Comp_4[k]!=0 then
			set parts=parts+1
		endif
		if Rec_Comp_5[k]!=0 then
			set parts=parts+1
		endif
		loop
			set j=LoadInteger(HY,'ITEM',i)
			if j>0 and LoadBoolean(HY,'ITEM',i)!=true then
				if (j==LoadInteger(HY,'ITEM',51) and RemoveSavedI(HY,'ITEM',51)) or (j==LoadInteger(HY,'ITEM',52) and RemoveSavedI(HY,'ITEM',52)) or (j==LoadInteger(HY,'ITEM',53) and RemoveSavedI(HY,'ITEM',53)) or (j==LoadInteger(HY,'ITEM',54) and RemoveSavedI(HY,'ITEM',54)) or (j==LoadInteger(HY,'ITEM',55) and RemoveSavedI(HY,'ITEM',55)) then
					call SaveItemHandle(HY,'ITEM',100+partsfound,LoadItemHandle(HY,'ITEM',i))
					call SaveBoolean(HY,'ITEM',i,true)//taken
					call SaveInteger(HY,'ITEM',200+partsfound,i)
					set partsfound=partsfound+1
				endif
			endif
			set i=i+1
			exitwhen i>=lim
		endloop
		if partsfound>0 then
			set i=100
			loop
				if partsfound==parts then
					set it=LoadItemHandle(HY,'ITEM',i)
					if Rec_Final[k]==bloodstone then
						call SaveInteger(HY,'ITEM',300,8)
					elseif Rec_Final[k]==DiffusalBlade then
						call SaveInteger(HY,'ITEM',300,8)
					elseif Rec_Final[k]==DiffusalBlade_upg then
						call SaveInteger(HY,'ITEM',300,8)
					elseif Rec_Final[k]==MagicWand then
						if GetIndex(it)==MagicStick then
							call SaveInteger(HY,'ITEM',300,GetItemCharges(it))
						endif
					endif
					call RemoveItem(it)
				else
					call RemoveSavedBoolean(HY,'ITEM',LoadInteger(HY,'ITEM',100+i))
				endif
				call RemoveSavedHandle(HY,'ITEM',i)
				set i=i+1
				exitwhen HaveSavedHandle(HY,'ITEM',i)==false
			endloop
		endif
		if partsfound==parts then
			if light==false then
				set it=UnitAddItemById(hero,Item_Real[Rec_Final[k]])
				if Rec_Final[k]==bloodstone or Rec_Final[k]==MagicWand or Rec_Final[k]==DiffusalBlade or Rec_Final[k]==DiffusalBlade_upg then
					if HaveSavedInteger(HY,'ITEM',300) then
						call SetItemCharges(it,LoadInteger(HY,'ITEM',300))
						call RemoveSavedInteger(HY,'ITEM',300)
					endif
				endif
				call SetItemPlayer(it,p,true)
				call SetItemUserData(it,0)
				call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIem\\AIemTarget.mdl",hero,"origin"))
				set it=null
			else
				set it=CreateItem(Item_Dummy[Rec_Final[k]],GetUnitX(hero),GetUnitY(hero))
				if Rec_Final[k]==bloodstone or Rec_Final[k]==MagicWand or Rec_Final[k]==DiffusalBlade or Rec_Final[k]==DiffusalBlade_upg then
					if HaveSavedInteger(HY,'ITEM',300) then
						call SetItemCharges(it,LoadInteger(HY,'ITEM',300))
						call RemoveSavedInteger(HY,'ITEM',300)
					endif
				endif
				call SetItemPlayer(it,p,true)
				call SetItemUserData(it,0)
				call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIem\\AIemTarget.mdl",hero,"origin"))
				call UnitAddItem(hero,it)
				set it=null
				
			endif
			
			
		endif
		exitwhen k>=Recipe_Max
		set k=k+1
	endloop
endfunction

function ZL9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Courier=(LoadUnitHandle(HY,h,92))
	local unit Hero=(LoadUnitHandle(HY,h,2))
	local real x
	local real y
	local integer i
	local player p=GetOwningPlayer(Hero)
	local item Item
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		if GetTriggerUnit()==Hero then
			call ZP9(Courier)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER then
		set i=GetIssuedOrderId()
		if(LoadInteger(HY,h,679))==1 then
			call SaveInteger(HY,h,679,0)
		elseif i!=852100 and i!=852090 and i!=851973 and not (i>=852002 and i<=852013) then
			call CleanTrigger(t)
			call SaveCourierState(Courier,"Interrupted")
		endif
	else
		if DistanceBetweenUnits(Courier,Hero)<350 then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call ReceiveItems(Courier,Hero,false,0)
			call ZT9(Courier,Hero)
			call ZP9(Courier)
			call SaveCourierState(Courier,"Going home")
		else
			call CourierReissueDeliveryXY(GetHandleId(t))
			call SaveCourierState(Courier,"Deliver to "+udg_Colors[GetPlayerId(GetOwningPlayer(Hero))]+PlayerNames[GetPlayerId(GetOwningPlayer(Hero))]+"|r")
		endif
	endif
	set t=null
	set Courier=null
	set Hero=null
	set Item=null
	return false
endfunction

function Z19 takes unit Hero,boolean Z09 returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit courier=GetSellingUnit()
	local integer Z59=(LoadInteger(HY,(GetHandleId(courier)),8000))
	if Hero!=null then
		if Hero!=(LoadUnitHandle(HY,(GetHandleId(courier)),(8002+Z59)))and Z09 then
			set Z59=Z59+1
			call SaveInteger(HY,(GetHandleId(courier)),8000,(Z59))
			call SaveUnitHandle(HY,(GetHandleId(courier)),(8002+Z59),(Hero))
		endif
		call SaveReal(HY,h,677,((GetUnitX(Hero))*1.))
		call SaveReal(HY,h,678,((GetUnitY(Hero))*1.))
		call IssueTargetOrderById(courier,ORDER_move,Hero)
		call TriggerRegisterDeathEvent(t,courier)
		call TriggerRegisterDeathEvent(t,Hero)
		call TriggerRegisterUnitEvent(t,courier,EVENT_UNIT_ISSUED_ORDER)
		call TriggerRegisterUnitEvent(t,courier,EVENT_UNIT_ISSUED_TARGET_ORDER)
		call TriggerRegisterUnitEvent(t,courier,EVENT_UNIT_ISSUED_POINT_ORDER)
		call TriggerRegisterTimerEvent(t,.2,true)
		call TriggerAddCondition(t,Condition(function ZL9))
		call SaveUnitHandle(HY,h,2,(Hero))
		call SaveUnitHandle(HY,h,92,(courier))
		
	endif
	set t=null
	set courier=null
endfunction

function Z29 takes nothing returns nothing
	local item Item=GetEnumItem()
	local player p=tt_player3
	local integer id=GetPlayerId(p)
	if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==p and IsItemVisible(Item) then
		call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
		call UnitAddItem(V87,Item)
	endif
	set Item=null
	set p=null
endfunction

function A49 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,h,53))
	local unit Source=(LoadUnitHandle(HY,h,2))
	local player p=LoadPlayerHandle(HY,h,50)
	set tt_player3=p
	set V87=Source
	if IsSentinel(p)then
		call EnumItemsInRect(FountainRectFrogSent,Condition(function ReturnTrue),function Z29)
	else
		call EnumItemsInRect(FountainRectFrogScourge,Condition(function ReturnTrue),function Z29)
	endif
	if GetTriggerEvalCount(t)==3 then
		call KillUnit(u)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set u=null
	set Source=null
	return false
endfunction

function A79 takes unit Hero returns nothing
	local unit u=GetSoldUnit()
	local integer i=0
	local item Item
	local integer id=GetPlayerId(GetOwningPlayer(u))
	local region r=CreateRegion()
	local trigger t
	local integer h
	local unit Source=GetSellingUnit()
	local player p=GetOwningPlayer(u)
	if IsSentinel(GetOwningPlayer(u))then
		call RegionAddRect(r,FountainRectFrogSent)
	else
		call RegionAddRect(r,FountainRectFrogScourge)
	endif
	if IsUnitInRegion(r,Source)then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,.05,true)
		call TriggerAddCondition(t,Condition(function A49))
		call SaveUnitHandle(HY,h,53,(u))
		call SavePlayerHandle(HY,h,50,p)
		call SaveUnitHandle(HY,h,2,(Source))
		loop
			exitwhen i>5
			set Item=UnitItemInSlot(Source,i)
			if Bottle_IsIndexRune(GetIndex(Item))==false and GetIndex(Item)!=Aegis then
				call UnitRemoveItemFromSlot(Source,i)
				if IsUnitInRegion(r,Source)and IsPlayerAlly(GetItemPlayer(Item),GetOwningPlayer(Source)) then
					set id=GetPlayerId(GetItemPlayer(Item))
					call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
				endif
			endif
			set i=i+1
		endloop
	endif
	call RemoveRegion(r)
	set u=null
	set r=null
	set t=null
	set Item=null
	set Source=null
endfunction

function A89 takes unit u returns string
	local string s=GetObjectName('n0FO')//n0FO -> $hero has revived (buy back)
	set s=str_replace(s,"$hero",udg_Colors[GetPlayerId(GetOwningPlayer(u))]+GetUnitName(u)+"|r")
	return s
endfunction

function A99 takes unit Source returns boolean
	if GetOwningPlayer(Source)!=GetLocalPlayer() or IsL1ch then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15," ")
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,A89(udg_Hero[GetPlayerId(GetOwningPlayer(Source))]))
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15," ")
	endif
	return false
endfunction

function RemoveBuybackVisuals takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call UnitRemoveAbility(LoadUnitHandle(HY,h,0),'A336')
	call UnitRemoveAbility(LoadUnitHandle(HY,h,0),'B0GU')//B0GU -> |c00ff0000Buyback gold restriction|r
	call PauseTimer(t)
	call DestroyTimer(t)
	set t=null
endfunction

function AddBuybackVisuals takes unit u,real r returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,r,false,function RemoveBuybackVisuals)
	call UnitAddAbility2(u,'A336')
	call SaveUnitHandle(HY,h,0,u)
	set t=null
endfunction

function DeliverItems_Main takes nothing returns nothing
	local unit u=GetSoldUnit()
	local player p=GetOwningPlayer(u)
	local integer pid=GetPlayerId(p)
	local real r=0
	if GetUnitTypeId(u)=='h085' then//h085 -> Transfer Items
		if udg_Hero[pid]!=null and IsDead(udg_Hero[pid])==false then
			call Z19(udg_Hero[pid],true)
		endif
		call KillUnit(u)
	elseif GetUnitTypeId(u)=='h0BV' then//h0BV -> Collect Your Items
		if udg_Hero[pid]!=null then
			call A79(udg_Hero[pid])
		endif
		call KillUnit(u)
	elseif GetUnitTypeId(u)=='h0DE' then//h0DE -> Resume Delivery
		if udg_Hero[pid]!=null then
			call Z19(LoadUnitHandle(HY,GetHandleId(GetSellingUnit()),8002+LoadInteger(HY,GetHandleId(GetSellingUnit()),8000)-1),false)
		endif
		call KillUnit(u)
	elseif GK9(GetUnitTypeId(u))then
		if udg_Hero[pid]!=null then
			if IsDead(udg_Hero[pid]) and p==GetOwningPlayer(GetSellingUnit()) and LoadInteger(HY,GetHandleId(udg_Hero[pid]),4304)!=1 and IsImpossibleToBuyback[pid]==false then
				set r=TimerGetRemaining(HeroRespawnTimer[pid])
				call SaveReal(HeroStats,GetHandleId(p),25,r+TimerGetElapsed(GlobalTimer))//buyback penalty duration
				call SaveReal(HeroStats,GetHandleId(p),26,r*0.25)
				call A99(udg_Hero[pid])
				//set V77=true
				call ReviveHero(udg_Hero[pid],GetUnitX(u),GetUnitY(u),true)
				call AddBuybackVisuals(udg_Hero[pid],r)
				//set V77=false
				call SetUnitState(udg_Hero[pid],UNIT_STATE_MANA,10000)
				set ReliableGold[pid]=IMaxBJ(0,ReliableGold[pid]-BuybackUnitCost[DefineBuybackUnitIndex(GetHeroLevel(udg_Hero[GetPlayerId(GetOwningPlayer(GetSellingUnit()))]))])
				call GU9(p)
			else
				call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)+BuybackUnitCost[DefineBuybackUnitIndex(GetHeroLevel(udg_Hero[GetPlayerId(GetOwningPlayer(GetSellingUnit()))]))])
				if IsImpossibleToBuyback[pid] then
					call Error(p,"Cannot buy back due to Reaper's Scythe")
				endif
			endif
		endif
		call KillUnit(u)
	endif
	set u=null
endfunction

function Fuse_Helper takes player whichPlayer,unit whichUnit,integer resultitem,integer i0,integer i1,integer i2,integer i3,integer i4,integer i5 returns nothing
	local item Item
	call DisableTrigger(GenericItemActionTrigger)
	if i0>0 then
		set Item=UnitItemInSlot(whichUnit,0)
		call DestroyItem(Item)
	endif
	if i1>0 then
		set Item=UnitItemInSlot(whichUnit,1)
		call DestroyItem(Item)
	endif
	if i2>0 then
		set Item=UnitItemInSlot(whichUnit,2)
		call DestroyItem(Item)
	endif
	if i3>0 then
		set Item=UnitItemInSlot(whichUnit,3)
		call DestroyItem(Item)
	endif
	if i4>0 then
		set Item=UnitItemInSlot(whichUnit,4)
		call DestroyItem(Item)
	endif
	if i5>0 then
		set Item=UnitItemInSlot(whichUnit,5)
		call DestroyItem(Item)
	endif
	set Item=UnitAddItemById(whichUnit,Item_Real[resultitem])
	call SetItemPlayer(Item,whichPlayer,true)
	call SetItemUserData(Item,0)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIem\\AIemTarget.mdl",whichUnit,"origin"))
	if GetIndex(Item)==bloodstone then
		call SetItemCharges(Item,8)
	endif
	call EnableTrigger(GenericItemActionTrigger)
	if IsPlayerAlly(GetLocalPlayer(),whichPlayer) then
		if resultitem==Mekansm then
			call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,4,udg_Colors[GetPlayerId(whichPlayer)]+(PlayerNames[GetPlayerId((whichPlayer))])+"|r |c00ffff00"+GetObjectName('n0LX')+"|r")//n0LX -> has purchased Mekansm
		elseif resultitem==DivineRapier then
			call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,4,udg_Colors[GetPlayerId(whichPlayer)]+(PlayerNames[GetPlayerId((whichPlayer))])+"|r |c00ffff00"+GetObjectName('n0LY')+"|r")//n0LY -> has purchased Divine Rapier
		endif
	endif
	set Item=null
endfunction

function Fuse takes player p,unit whichUnit,integer indexId returns boolean
	local integer i
	local integer x
	local integer y
	local integer array searchItems
	local boolean array searchItems_Active
	local integer array recipeItems
	local boolean array recipeItems_Active
	local boolean array found
	local integer array result
	local player whichPlayer
	local integer MaxSearch=1
	local integer k
	local player array PlayerSearches
	local integer m
	local item Inventory0
	local item Inventory1
	local item Inventory2
	local item Inventory3
	local item Inventory4
	local item Inventory5
	local player InventoryPlayer0
	local player InventoryPlayer1
	local player InventoryPlayer2
	local player InventoryPlayer3
	local player InventoryPlayer4
	local player InventoryPlayer5
	local integer InventoryUserData0
	local integer InventoryUserData1
	local integer InventoryUserData2
	local integer InventoryUserData3
	local integer InventoryUserData4
	local integer InventoryUserData5
	local integer InventoryIndex0
	local integer InventoryIndex1
	local integer InventoryIndex2
	local integer InventoryIndex3
	local integer InventoryIndex4
	local integer InventoryIndex5
	local boolean extrasearch=false
	local boolean resetvars=true
	set Inventory0=UnitItemInSlot(whichUnit,0)
	set Inventory1=UnitItemInSlot(whichUnit,1)
	set Inventory2=UnitItemInSlot(whichUnit,2)
	set Inventory3=UnitItemInSlot(whichUnit,3)
	set Inventory4=UnitItemInSlot(whichUnit,4)
	set Inventory5=UnitItemInSlot(whichUnit,5)
	set InventoryPlayer0=GetItemPlayer(Inventory0)
	set InventoryPlayer1=GetItemPlayer(Inventory1)
	set InventoryPlayer2=GetItemPlayer(Inventory2)
	set InventoryPlayer3=GetItemPlayer(Inventory3)
	set InventoryPlayer4=GetItemPlayer(Inventory4)
	set InventoryPlayer5=GetItemPlayer(Inventory5)
	set InventoryUserData0=GetItemUserData(Inventory0)
	set InventoryUserData1=GetItemUserData(Inventory1)
	set InventoryUserData2=GetItemUserData(Inventory2)
	set InventoryUserData3=GetItemUserData(Inventory3)
	set InventoryUserData4=GetItemUserData(Inventory4)
	set InventoryUserData5=GetItemUserData(Inventory5)
	set InventoryIndex0=GetIndex(Inventory0)
	set InventoryIndex1=GetIndex(Inventory1)
	set InventoryIndex2=GetIndex(Inventory2)
	set InventoryIndex3=GetIndex(Inventory3)
	set InventoryIndex4=GetIndex(Inventory4)
	set InventoryIndex5=GetIndex(Inventory5)
	if(GetPlayerSlotState((p))==PLAYER_SLOT_STATE_LEFT)then
		set MaxSearch=5
		set extrasearch=true
	endif
	set PlayerSearches[1]=p
	if extrasearch then
		set k=2
		set m=1
		loop
			exitwhen k>MaxSearch
			if IsSentinel(p)then
				if p!=Sentinels[m]then
					set PlayerSearches[k]=Sentinels[m]
					set k=k+1
				endif
			else
				if p!=Scourges[m]then
					set PlayerSearches[k]=Scourges[m]
					set k=k+1
				endif
			endif
			set m=m+1
		endloop
	endif
	set k=1
	loop
		exitwhen k>MaxSearch
		set whichPlayer=PlayerSearches[k]
		set i=0
		if Inventory0!=null and InventoryUserData0==1 and(InventoryPlayer0==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer0))==PLAYER_SLOT_STATE_LEFT))then
			set searchItems[i+1]=InventoryIndex0
		else
			set searchItems[i+1]=0
		endif
		set i=1
		if Inventory1!=null and InventoryUserData1==1 and(InventoryPlayer1==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer1))==PLAYER_SLOT_STATE_LEFT))then
			set searchItems[i+1]=InventoryIndex1
		else
			set searchItems[i+1]=0
		endif
		set i=2
		if Inventory2!=null and InventoryUserData2==1 and(InventoryPlayer2==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer2))==PLAYER_SLOT_STATE_LEFT))then
			set searchItems[i+1]=InventoryIndex2
		else
			set searchItems[i+1]=0
		endif
		set i=3
		if Inventory3!=null and InventoryUserData3==1 and(InventoryPlayer3==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer3))==PLAYER_SLOT_STATE_LEFT))then
			set searchItems[i+1]=InventoryIndex3
		else
			set searchItems[i+1]=0
		endif
		set i=4
		if Inventory4!=null and InventoryUserData4==1 and(InventoryPlayer4==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer4))==PLAYER_SLOT_STATE_LEFT))then
			set searchItems[i+1]=InventoryIndex4
		else
			set searchItems[i+1]=0
		endif
		set i=5
		if Inventory5!=null and InventoryUserData5==1 and(InventoryPlayer5==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer5))==PLAYER_SLOT_STATE_LEFT))then
			set searchItems[i+1]=InventoryIndex5
		else
			set searchItems[i+1]=0
		endif
		set searchItems[0]=indexId
		set i=1
		loop
			exitwhen i>(Recipe_Max)
			set recipeItems[0]=Rec_Comp_1[i]
			set recipeItems[1]=Rec_Comp_2[i]
			set recipeItems[2]=Rec_Comp_3[i]
			set recipeItems[3]=Rec_Comp_4[i]
			set recipeItems[4]=Rec_Comp_5[i]
			if resetvars then
				set recipeItems_Active[0]=true
				set recipeItems_Active[1]=true
				set recipeItems_Active[2]=true
				set recipeItems_Active[3]=true
				set recipeItems_Active[4]=true
				set recipeItems_Active[5]=true
				set recipeItems_Active[6]=true
				set searchItems_Active[0]=true
				set searchItems_Active[1]=true
				set searchItems_Active[2]=true
				set searchItems_Active[3]=true
				set searchItems_Active[4]=true
				set searchItems_Active[5]=true
				set searchItems_Active[6]=true
				set result[0]=0
				set result[1]=0
				set result[2]=0
				set result[3]=0
				set result[4]=0
				set result[5]=0
				set result[6]=0
				set resetvars=false
			endif
			set found[0]=false
			set found[1]=false
			set found[2]=false
			set found[3]=false
			set found[4]=false
			set x=0
			loop
				exitwhen x==5
				if recipeItems[x]==0 then
					set found[x]=true
				else
					set y=0
					loop
						if searchItems[y]==recipeItems[x]and searchItems_Active[y]and recipeItems_Active[x]then
							set searchItems_Active[y]=false
							set recipeItems_Active[x]=false
							set found[x]=true
							set result[y]=1
							set y=7
							set resetvars=true
						else
							set y=y+1
						endif
						exitwhen y==7
					endloop
				endif
				if found[x] then
					set x=x+1
				else
					set x=5
				endif
			endloop
			if found[0]and found[1]and found[2]and found[3]and found[4]then
				call Fuse_Helper(whichPlayer,whichUnit,Rec_Final[i],result[1],result[2],result[3],result[4],result[5],result[6])
				set i=Recipe_Max+2
			else
				set i=i+1
			endif
		endloop
		set tt_bool1=result[0]==1
		if i==(Recipe_Max+2)then
			set Inventory0=null
			set Inventory1=null
			set Inventory2=null
			set Inventory3=null
			set Inventory4=null
			set Inventory5=null
			return true
		endif
		set k=k+1
	endloop
	set Inventory0=null
	set Inventory1=null
	set Inventory2=null
	set Inventory3=null
	set Inventory4=null
	set Inventory5=null
	set InventoryPlayer0 =null
	set InventoryPlayer1 =null
	set InventoryPlayer2 =null
	set InventoryPlayer3 =null
	set InventoryPlayer4 =null
	set InventoryPlayer5 =null
	set whichPlayer=null
	return false
endfunction

function AttemptFuse takes player whichPlayer,unit whichUnit,integer indexId returns boolean
	local integer i=1
	local boolean result
	set tt_bool1=false
	set result=Fuse(whichPlayer,whichUnit,indexId)
	return result
endfunction

function FindDestination_Which2 takes nothing returns boolean
	if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and UnitInventorySize(GetFilterUnit())>1 and GetUnitTypeId(GetFilterUnit())!='ncop' and GetPlayerAlliance(GetOwningPlayer(GetFilterUnit()),GetOwningPlayer(tt_unit1),ALLIANCE_SHARED_CONTROL)and GetOwningPlayer(tt_unit1)!=GetOwningPlayer(GetFilterUnit())and IsUnitIllusion(GetFilterUnit())==false and IsDead(GetFilterUnit())==false then//Aloc -> Locust, ncop -> Circle of Power
		if IsCourier(GetFilterUnit()) then
			set tt_int1=tt_int1+1
			set tt_unit2=GetFilterUnit()
		endif
	endif
	return false
endfunction

function FindDestination_Which takes nothing returns boolean
	if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and UnitInventorySize(GetFilterUnit())>1 and GetUnitTypeId(GetFilterUnit())!='ncop' and IsUnitIllusion(GetFilterUnit())==false and IsDead(GetFilterUnit())==false then//Aloc -> Locust, ncop -> Circle of Power
		if GetOwningPlayer(tt_unit1)==GetOwningPlayer(GetFilterUnit())then
			if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) then
				if GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 then//
					set tt_unit2=GetFilterUnit()
				endif
			elseif IsUnitType(tt_unit2,UNIT_TYPE_HERO)==false then
				set tt_unit2=GetFilterUnit()
			endif
		endif
	endif
	return false
endfunction

function FindDestination takes unit whichUnit,integer BonusRange returns unit
	local group g=GetAvailableGroup()
	set tt_unit1=whichUnit
	set tt_unit2=null
	call GroupEnumUnitsInRange(g,GetUnitX(tt_unit3),GetUnitY(tt_unit3),1300+BonusRange,Condition(function FindDestination_Which))
	if tt_unit2==null then
		set tt_int1=0
		call KillGroup(g)
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(tt_unit3),GetUnitY(tt_unit3),1100+BonusRange,Condition(function FindDestination_Which2))
		if tt_int1>1 then
			set tt_unit2=null
		endif
	endif
	call KillGroup(g)
	set g=null
	return tt_unit2
endfunction

function CheckFuse takes player whichPlayer,unit whichUnit,unit sellingUnit,integer indexId,real x,real y,integer charges,integer userdata returns nothing
	local unit Destination
	local item newItem
	set tt_unit3=sellingUnit
//	call echo(I2S(indexId)+" "+Id2String(Item_Real[indexId]))
	if indexId<0 then
		return
	endif
	if GetUnitPointValue(whichUnit)==200 then
		set Destination=FindDestination(whichUnit,0)
		if Destination==null then
			set Destination=FindDestination(whichUnit,300)
		endif
	else
		set Destination=whichUnit
	endif
	if Destination==null or AttemptFuse(whichPlayer,Destination,FindRealIndexId(indexId))==false or tt_bool1==false then
		if IsIndexIdCharged(FindRealIndexId(indexId))then
			if GetEmptyInventorySlots(Destination)==0 or Destination==null then
				if Destination==null then
					call DelayedItemCreation(Item_Dummy[indexId],x,y,whichPlayer,true,charges)
				else
					if DistanceBetweenXY(GetUnitX(Destination),GetUnitY(Destination),x,y)>2000 then
						set x=GetUnitX(Destination)
						set y=GetUnitY(Destination)
						call Error(whichPlayer,"Inventory is full!")
					endif
					call DelayedItemCreation(Item_Dummy[indexId],x,y,whichPlayer,true,charges)
				endif
			else
				set newItem=UnitAddItemById(Destination,Item_Real[indexId])
				call SetItemCharges(newItem,charges)
				call SetItemPlayer(newItem,whichPlayer,true)
				call SetItemUserData(newItem,userdata)
			endif
		elseif IsIndexIdConsumable(FindRealIndexId(indexId))then
			if Destination==null or(GetEmptyInventorySlots(Destination)==0 and FindItemOfType(Destination,Item_Real[indexId])==null)then
				call DelayedItemCreation(Item_Dummy[indexId],x,y,whichPlayer,true,FG9(indexId))
			else
				set newItem=CreateItem(Item_Dummy[indexId],x,y)
				call SetItemPlayer(newItem,whichPlayer,true)
				call SetItemUserData(newItem,userdata)
				call SetItemCharges(newItem,FG9(indexId))
				call UnitAddItem(Destination,newItem)
			endif
		else
			if GetEmptyInventorySlots(Destination)==0 or Destination==null then
				if Destination==null then
					call DelayedItemCreation(Item_Dummy[indexId],x,y,whichPlayer,true,0)
				else
					if DistanceBetweenXY(GetUnitX(Destination),GetUnitY(Destination),x,y)>2000 then
						set x=GetUnitX(Destination)
						set y=GetUnitY(Destination)
						call Error(whichPlayer,"Inventory is full!")
					endif
					call DelayedItemCreation(Item_Dummy[indexId],x,y,whichPlayer,true,0)
				endif
			else
				if indexId!=FlyingCourier then
					set newItem=UnitAddItemById(Destination,Item_Real[indexId])
					call SetItemPlayer(newItem,whichPlayer,true)
					call SetItemUserData(newItem,0)
				else
					call MakeFlyingCourier(newItem,whichPlayer)
				endif
			endif
		endif
	else
		if IsUnitType(Destination,UNIT_TYPE_HERO) then
			if userdata==0 then
				call Traffic_RegisterData("PUI_"+I2S(GetPlayerId(GetOwningPlayer(Destination))),Item_Real[FindRealIndexId(indexId)])
			endif
		endif
	endif
	set Destination=null
	set newItem=null
endfunction

function ItemStats_Track takes player p,integer indexId returns nothing
	local integer i=GetPlayerId(p)
	if indexId==ClarityPotion then
		set ItemStats_Consumables[i]=ItemStats_Consumables[i]+1
	elseif indexId==HealingSalve then
		set ItemStats_Consumables[i]=ItemStats_Consumables[i]+1
	elseif indexId==Tango then
		set ItemStats_Consumables[i]=ItemStats_Consumables[i]+4
	elseif indexId==ObserverWards then
		set ItemStats_Consumables[i]=ItemStats_Consumables[i]+1
		set ItemStats_Wards[i]=ItemStats_Wards[i]+1
	elseif indexId==SentryWards then
		set ItemStats_Consumables[i]=ItemStats_Consumables[i]+2
		set ItemStats_Wards[i]=ItemStats_Wards[i]+2
	elseif indexId==ScrollOfTownPortal then
		set ItemStats_Consumables[i]=ItemStats_Consumables[i]+1
	elseif indexId==dustofappearance then
		set ItemStats_Consumables[i]=ItemStats_Consumables[i]+2
	elseif indexId==ghostpotion then
		set ItemStats_Consumables[i]=ItemStats_Consumables[i]+2
	elseif indexId==wandofillusions then
		set ItemStats_Consumables[i]=ItemStats_Consumables[i]+2
	endif
endfunction

function UnitItem_RestrictBuying takes unit store,unit buyer returns boolean
	local integer indexId
	if(store==ScourgeBuilding_ShopGraveyard or store==ScourgeBuilding_ShopGateway)and IsUnitAlly(buyer,Scourges[0])then
		return false
	elseif(store==SentinelBuilding_ShopChimaera or store==SentinelBuilding_ShopCache)and IsUnitAlly(buyer,Sentinels[0])then
		return false
	endif
	set indexId=UnitToIndex(buyer)
	if indexId==ObserverWards or indexId==Gem or indexId==Smoke then
		return true
	endif
	return false
endfunction

function IsSentinelShop takes unit u returns boolean
	return u==SentinelBuilding_ShopCache or u==SentinelBuilding_ShopWeapon or u==SentinelBuilding_ShopAccessorizer or u==SentinelBuilding_ShopChimaera or u==SentinelBuilding_Shop1 or u==SentinelBuilding_Shop2 or u==SentinelBuilding_Shop3 or u==SentinelBuilding_Shop4 or u==SentinelBuilding_Shop5 or u==SentinelBuilding_Shop6 or u==SentinelBuilding_BlackMarket1 or u==SentinelBuilding_BlackMarket2
endfunction

function IsScourgeShop takes unit u returns boolean
	return u==ScourgeBuilding_ShopGateway or u==ScourgeBuilding_ShopWeapon or u==ScourgeBuilding_ShopAccessorizer or u==ScourgeBuilding_ShopGraveyard or u==ScourgeBuilding_Shop1 or u==ScourgeBuilding_Shop2 or u==ScourgeBuilding_Shop3 or u==ScourgeBuilding_Shop4 or u==ScourgeBuilding_Shop5 or u==ScourgeBuilding_Shop6 or u==ScourgeBuilding_BlackMarket1 or u==ScourgeBuilding_BlackMarket2
endfunction

function IsSideShopTop takes unit u returns boolean
	return u==GoblinShop_Top or u==GoblinMerch_Top or u==FurbolgHut_Top
endfunction

function IsSideShopBot takes unit u returns boolean
	return u==GoblinShop_Bot or u==GoblinMerch_Bot or u==FurbolgHut_Bot
endfunction

function UnitItem_GetBestX takes unit sellingUnit,unit soldUnit returns real
	if IsSentinelShop(sellingUnit) or IsScourgeShop(sellingUnit) then
		return ItemSpawnX[GetPlayerId(GetOwningPlayer(soldUnit))]
	elseif IsSideShopTop(sellingUnit) then
		return -7133.
	elseif IsSideShopBot(sellingUnit) then
		return 7207.
	endif
	return GetUnitX(soldUnit)
endfunction

function UnitItem_GetBestY takes unit sellingUnit,unit soldUnit returns real
	if IsSentinelShop(sellingUnit) or IsScourgeShop(sellingUnit) then
		return ItemSpawnY[GetPlayerId(GetOwningPlayer(soldUnit))]
	elseif IsSideShopTop(sellingUnit) then
		return 4317.
	elseif IsSideShopBot(sellingUnit) then
		return -4243.
	endif
	return GetUnitY(soldUnit)
endfunction

function UnitItem_GetBestXOld takes unit sellingUnit,unit soldUnit returns real
	if IsSentinelShop(sellingUnit) then
		return GetRectCenterX(gg_rct_Hero_Creation_NE)
	elseif IsScourgeShop(sellingUnit) then
		return GetRectCenterX(gg_rct_Hero_Creation_UD)
	endif
	return GetUnitX(soldUnit)
endfunction

function UnitItem_GetBestYOld takes unit sellingUnit,unit soldUnit returns real
	if IsSentinelShop(sellingUnit) then
		return GetRectCenterY(gg_rct_Hero_Creation_NE)
	elseif IsScourgeShop(sellingUnit) then
		return GetRectCenterY(gg_rct_Hero_Creation_UD)
	endif
	return GetUnitY(soldUnit)
endfunction

function UnitDropAllItems takes unit u returns nothing
	local integer i=0
	local item it
	local integer pid=GetPlayerId(GetOwningPlayer(u))
	local region r=CreateRegion()
	local boolean b=IsCourier(u) or GetUnitTypeId(u)=='ncop'
	if IsSentinel(GetOwningPlayer(u))then
		call RegionAddRect(r,FountainRectFrogSent)
	else
		call RegionAddRect(r,FountainRectFrogScourge)
	endif
	//call echo("drop all items")
	loop
		exitwhen i>5
		set it=UnitItemInSlot(u,i)
		if it!=null and GetIndex(it)!=Aegis then
//			call echo(GetPlayerName(GetItemPlayer(it)))
			
			set it=UnitRemoveItemFromSlot(u,i)
			if b==false then
				call DisplayTimedTextToPlayer(GetOwningPlayer(u),0,0,8,"|c00ffff00"+GetItemName(it)+"|r has been dropped onto your Circle of Power")
			endif
			
//			call echo(GetPlayerName(GetItemPlayer(it)))
			if(GetUnitTypeId(u)=='ncop' or IsUnitInRegion(r,u))and IsPlayerAlly(GetItemPlayer(it),GetOwningPlayer(u)) then//ncop -> Circle of Power
				set pid=GetPlayerId(GetItemPlayer(it))
				call SetItemPosition(it,ItemSpawnX[pid],ItemSpawnY[pid])
			endif
		endif
		set i=i+1
	endloop
	call RemoveRegion(r)
	set it=null
	set r=null
endfunction

function AddMissingItems takes unit u, integer id returns nothing
	local player p=GetOwningPlayer(u)
	local real x
	local real y
//	if IsIndexIdConsumable(id)==false and Item_Real[id]!=0 then
//		call SaveInteger(MHT,'ITEM',GetPlayerId(p),Item_Real[id])
//		call SaveReal(MHT,'ITEM',GetPlayerId(p),TimerGetElapsed(GlobalTimer))
//	endif
	set x=GetUnitX(u)
	set y=GetUnitY(u)
	call CheckFuse(p,u,GetSellingUnit(),FindRealIndexId(id),x,y,0,0)
	set u=null
	set p=null
endfunction

function GetBuyingDummy takes unit u returns unit
	local unit d
	local player p=GetOwningPlayer(u)
	if HaveSavedHandle(HeroStats,GetHandleId(p),'COUR'+1)==false or IsDead(LoadUnitHandle(HeroStats,GetHandleId(p),'COUR'+1)) then
		set d=CreateUnit(p,'e00E',GetUnitX(CirclesOfPower[GetPlayerId(p)]),GetUnitY(CirclesOfPower[GetPlayerId(p)]),0)//e00E -> Spellcaster
		call UnitAddAbility2(d,'AInv')//AInv -> Inventory
		call SaveUnitHandle(HeroStats,GetHandleId(p),'COUR'+1,d)
		call UnitPauseTimedLife(d,true)
		set d=null
	elseif HaveSavedHandle(HeroStats,GetHandleId(p),'COUR'+1) then
		set d=LoadUnitHandle(HeroStats,GetHandleId(p),'COUR'+1)
		if p!=GetOwningPlayer(d) then
			call SetUnitOwner(d,p,true)
			call SetUnitPosition(d,GetUnitX(CirclesOfPower[GetPlayerId(p)]),GetUnitY(CirclesOfPower[GetPlayerId(p)]))
		endif
		set d=null
	endif
	return LoadUnitHandle(HeroStats,GetHandleId(p),'COUR'+1)
endfunction

function IsSecretShopItem takes integer id returns boolean
	return id==ArcaneBoots or id==SoulBooster or id==DemonEdge or id==Eaglehorn or id==MesserschmidtReaver or id==SacredRelic or id==Hyperstone or id==PlateMail or id==TalismanOfEvasion or id==MysticStaff or id==EnergyBooster or id==PointBooster or id==VitalityBooster or id==UltimateOrb
endfunction

function ImitateBuying takes unit u,integer id returns boolean
	local unit d=GetBuyingDummy(u)
	local integer cost=GetItemGoldCostById(Item_Real[id])
	local player p=GetOwningPlayer(u)
	local boolean b=false
	if IsSecretShopItem(id) then
		call DisplayTimedTextToPlayer(p,0,0,10,str_replace(GetObjectName('TX1A'),"$item","|c00ffff00"+GetObjectName(Item_Real[id])+"|r"))//TX1A -> Required item $item can be only bought from |c00ffff00Secret Shop|r.
		set d=null
		return false
	endif
	if GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)>=cost then
		set b=true
		call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-cost)
		//call AnnounceSomeItems(p,id)
		call AddMissingItems(d,id)
	else
		call DisplayTimedTextToPlayer(p,0,0,10,str_replace(GetObjectName('TX1B'),"$item","|c00ffff00"+GetObjectName(Item_Real[id])+"|r"))//TX1B -> Not enough gold for $item
	endif
	set d=null
	return b
endfunction

function IsItemOwnedBy takes nothing returns boolean
	if tt_int1<6 and GetItemPlayer(GetFilterItem())==tt_player1 and GetItemUserData(GetFilterItem())>=0 and GetWidgetLife(GetFilterItem())>1 then
		set tt_int1=tt_int1+1
		//call echo("item found "+I2S(tt_int1)+" name="+GetItemName(GetFilterItem())+" hp="+R2S(GetWidgetLife(GetFilterItem())))
		return true
	endif
	return false
endfunction

function AddDetectedItemsToCount takes nothing returns nothing
	call SaveItemHandle(TempHash,'ITEM',tt_int1,GetEnumItem())
	//call echo("item handl saved "+I2S(tt_int1))
	
endfunction

function IsUnitNextToSideShop takes unit u returns boolean
	return IsUnitInRange(u,FurbolgHut_Top,800) or IsUnitInRange(u,FurbolgHut_Bot,800)
endfunction

function IsSideShopItem takes item it returns boolean
	local integer id=GetIndex(it)
	return id==StoutShield or id==UltimateOrb or id==GlovesOfHaste or id==BootsOfElvenskin or id==BeltOfStrength or id==BladesOfAttack or id==HelmOfIronWill or id==KelensDagger or id==MaskOfDeath or id==Quarterstaff or id==RingOfHealth or id==RingOfRegeneration or id==RobeOfMagi or id==SlippersOfAgility or id==SobiMask or id==MagicStick or id==QuellingBlade or id==TalismanOfEvasion or id==VoidStone or id==ScrollOfTownPortal or id==EnergyBooster or id==BootsOfSpeed or id==OrbOfVenom or id==Chainmail or id==Broadsword or id==PlaneswalkerCloak
endfunction

function GetMissingItems takes unit hero, integer recipeId, player p returns nothing
	local integer i=0
	local item it
	local integer k=0
	local integer lim=0
	local integer j
	local integer parts
	local integer partsfound
	local string s
	local unit courier=LoadUnitHandle(HeroStats,GetHandleId(p),'COUR')
	local integer id
	local unit d
	local real x
	local real y
	if recipeId==-1 or GetPlayerSlotState(p)==PLAYER_SLOT_STATE_LEFT then
		return
	endif
	if courier==null then
		set courier=GetBestCourier(p)
	endif
	call FlushChildHashtable(HY,'ITEM')
	loop
		if courier!=null then
			set it=UnitItemInSlot(courier,i)
			if it!=null and GetItemPlayer(it)==p then
				call SaveItemHandle(HY,'ITEM',k,it)
				call SaveInteger(HY,'ITEM',k,GetIndex(it))
				set k=k+1
			endif
		endif
		set it=UnitItemInSlot(hero,i)
		if it!=null and GetItemPlayer(it)==p then
			call SaveItemHandle(HY,'ITEM',k,it)
			call SaveInteger(HY,'ITEM',k,GetIndex(it))
			set k=k+1
		endif
		if hero!=udg_Hero[GetPlayerId(p)] then
			set it=UnitItemInSlot(udg_Hero[GetPlayerId(p)],i)
			if it!=null and GetItemPlayer(it)==p then
				call SaveItemHandle(HY,'ITEM',k,it)
				call SaveInteger(HY,'ITEM',k,GetIndex(it))
				set k=k+1
			endif
		endif
		set i=i+1
		exitwhen i>5
	endloop
	
	set tt_player1=p
	set tt_int1=0
	if IsSentinel(p) then
		call EnumItemsInRect(FountainRectSent,Condition(function IsItemOwnedBy),function AddDetectedItemsToCount)
	else
		call EnumItemsInRect(FountainRectScourge,Condition(function IsItemOwnedBy),function AddDetectedItemsToCount)
	endif
	
	set i=tt_int1
	loop
		exitwhen i<0
		if HaveSavedHandle(TempHash,'ITEM',i) then
			call SaveItemHandle(HY,'ITEM',k,LoadItemHandle(TempHash,'ITEM',i))
			call SaveInteger(HY,'ITEM',k,GetIndex(LoadItemHandle(TempHash,'ITEM',i)))
			call RemoveSavedHandle(TempHash,'ITEM',i)
			//call echo(GetItemName(LoadItemHandle(HY,'ITEM',k))+" on ground "+I2S(i))
			set k=k+1
		endif
		set i=i-1
	endloop
	
	set it=null
	set lim=k
	set k=recipeId
	
	
	call SaveInteger(HY,'ITEM',51,Rec_Comp_1[k])
	call SaveInteger(HY,'ITEM',52,Rec_Comp_2[k])
	call SaveInteger(HY,'ITEM',53,Rec_Comp_3[k])
	call SaveInteger(HY,'ITEM',54,Rec_Comp_4[k])
	call SaveInteger(HY,'ITEM',55,Rec_Comp_5[k])
	//call echo(GetObjectName(Item_Real[recipeId])+" running: "+I2S(recipeId))
	
	set partsfound=0
	set parts=0
	set i=0
	if Rec_Comp_1[k]!=0 then
		set parts=parts+1
	endif
	if Rec_Comp_2[k]!=0 then
		set parts=parts+1
	endif
	if Rec_Comp_3[k]!=0 then
		set parts=parts+1
	endif
	if Rec_Comp_4[k]!=0 then
		set parts=parts+1
	endif
	if Rec_Comp_5[k]!=0 then
		set parts=parts+1
	endif
	loop
		set j=LoadInteger(HY,'ITEM',i)
		if j>0 and LoadBoolean(HY,'ITEM',i)==false then
			if (j==LoadInteger(HY,'ITEM',51) and RemoveSavedI(HY,'ITEM',51)) or (j==LoadInteger(HY,'ITEM',52) and RemoveSavedI(HY,'ITEM',52)) or (j==LoadInteger(HY,'ITEM',53) and RemoveSavedI(HY,'ITEM',53)) or (j==LoadInteger(HY,'ITEM',54) and RemoveSavedI(HY,'ITEM',54)) or (j==LoadInteger(HY,'ITEM',55) and RemoveSavedI(HY,'ITEM',55)) then
				call SaveItemHandle(HY,'ITEM',100+partsfound,LoadItemHandle(HY,'ITEM',i))
				call SaveBoolean(HY,'ITEM',i,true)//taken
				call SaveInteger(HY,'ITEM',200+partsfound,i)
				set partsfound=partsfound+1
			endif
		endif
		set i=i+1
		exitwhen i>=lim
	endloop
	//call echo(I2S(partsfound)+" "+I2S(parts))
	if partsfound!=parts then
		set id=LoadInteger(HY,'ITEM',51)
		if id!=0 then
			//call echo("not found: "+GetObjectName(Item_Real[id]))
			//call echo(I2S(GetItemGoldCostById(Item_Real[id])))
			if ImitateBuying(hero,id) then
				set parts=parts+1
			endif
		endif
		set id=LoadInteger(HY,'ITEM',52)
		if id!=0 then
			//call echo("not found: "+GetObjectName(Item_Real[id]))
			//call echo(I2S(GetItemGoldCostById(Item_Real[id])))
			if ImitateBuying(hero,id) then
				set parts=parts+1
			endif
		endif
		set id=LoadInteger(HY,'ITEM',53)
		if id!=0 then
			//call echo("not found: "+GetObjectName(Item_Real[id]))
			//call echo(I2S(GetItemGoldCostById(Item_Real[id])))
			if ImitateBuying(hero,id) then
				set parts=parts+1
			endif
		endif
		set id=LoadInteger(HY,'ITEM',54)
		if id!=0 then
			//call echo("not found: "+GetObjectName(Item_Real[id]))
			//call echo(I2S(GetItemGoldCostById(Item_Real[id])))
			if ImitateBuying(hero,id) then
				set parts=parts+1
			endif
		endif
		set id=LoadInteger(HY,'ITEM',55)
		if id!=0 then
			//call echo("not found: "+GetObjectName(Item_Real[id]))
			//call echo(I2S(GetItemGoldCostById(Item_Real[id])))
			if ImitateBuying(hero,id) then
				set parts=parts+1
			endif
		endif
		if partsfound==parts then
			set i=100
			loop
				call UnitAddItem(LoadUnitHandle(HeroStats,GetHandleId(GetOwningPlayer(hero)),'COUR'+1),LoadItemHandle(HY,'ITEM',i))
				call RemoveSavedHandle(HY,'ITEM',i)
				set i=i+1
				exitwhen HaveSavedHandle(HY,'ITEM',i)==false
			endloop
		endif
		set d=LoadUnitHandle(HeroStats,GetHandleId(GetOwningPlayer(hero)),'COUR'+1)
		//call echo(I2S(i))
		if true then
			//call echo("try to hero")
			set x=GetUnitX(d)
			set y=GetUnitY(d)
			call SetUnitX(d,GetUnitX(hero))
			call SetUnitY(d,GetUnitY(hero))
			if IsDead(hero)==false and IsUnitInRange(hero,SentFountain,1600) or IsUnitInRange(hero,ScourgeFountain,1600) then
				call ReceiveItems(d,hero,true,k)
				//call echo(Id2String(GetItemTypeId(UnitItemInSlot(d,0))))
				if GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,0),hero)
				endif
				if GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,1),hero)
				endif
				if GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,2),hero)
				endif
				if GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,3),hero)
				endif
				if GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,4),hero)
				endif
				if GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,5),hero)
				endif
				//call Func0612(d,hero)
			elseif IsDead(hero)==false and IsUnitNextToSideShop(hero) then
				//call echo(Id2String(GetItemTypeId(UnitItemInSlot(d,0))))
				if IsSideShopItem(UnitItemInSlot(d,0)) and GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,0),hero)
				endif
				if IsSideShopItem(UnitItemInSlot(d,1)) and GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,1),hero)
				endif
				if IsSideShopItem(UnitItemInSlot(d,2)) and GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,2),hero)
				endif
				if IsSideShopItem(UnitItemInSlot(d,3)) and GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,3),hero)
				endif
				if IsSideShopItem(UnitItemInSlot(d,4)) and GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,4),hero)
				endif
				if IsSideShopItem(UnitItemInSlot(d,5)) and GetEmptyInventorySlots(hero)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,5),hero)
				endif
			elseif courier!=null and IsDead(courier)==false and (IsUnitInRangeXY(courier,GetRectCenterX(FountainRectSent),GetRectCenterY(FountainRectSent),1600) or IsUnitInRangeXY(courier,GetRectCenterX(FountainRectScourge),GetRectCenterY(FountainRectScourge),1600)) then
				
				call SetUnitX(d,GetUnitX(courier))
				call SetUnitY(d,GetUnitY(courier))
				call ReceiveItems(d,courier,true,k)
				//call echo(Id2String(GetItemTypeId(UnitItemInSlot(d,0))))
				if GetEmptyInventorySlots(courier)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,0),courier)
				endif
				if GetEmptyInventorySlots(courier)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,1),courier)
				endif
				if GetEmptyInventorySlots(courier)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,2),courier)
				endif
				if GetEmptyInventorySlots(courier)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,3),courier)
				endif
				if GetEmptyInventorySlots(courier)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,4),courier)
				endif
				if GetEmptyInventorySlots(courier)>0 then
					call UnitDropItemTarget(d,UnitItemInSlot(d,5),courier)
				endif
			endif
			call SetUnitX(d,x)
			call SetUnitY(d,y)
			
		endif
		call UnitDropAllItems(d)
		set d=null
	endif
	call UnitRemoveAbility(LoadUnitHandle(HeroStats,GetHandleId(GetOwningPlayer(hero)),'COUR'+1),'AInv')//AInv -> Inventory
	call UnitAddAbility(LoadUnitHandle(HeroStats,GetHandleId(GetOwningPlayer(hero)),'COUR'+1),'AInv')//AInv -> Inventory
	set courier=null
	
endfunction

function GetItemReceiptIndex takes integer id, boolean isReceipe returns integer
	local integer i=0
	//call echo(I2S(id)+" "+I2S(LoadInteger(HY,'ITDB',id)))
	loop
		if (isReceipe==false and Rec_Final[i]==LoadInteger(HY,'ITDB',id)) or (isReceipe and (Rec_Comp_1[i]==id or Rec_Comp_2[i]==id or Rec_Comp_3[i]==id or Rec_Comp_4[i]==id or Rec_Comp_5[i]==id)) then
			return i
		endif
		set i=i+1
		exitwhen i>Recipe_Max
	endloop
	//call echo("none")
	return -1
endfunction

function UnitItem_Main takes nothing returns nothing
	local unit u=GetSoldUnit()
	local player p=GetOwningPlayer(u)
	local integer indexId=UnitToIndex(u)
	local real x
	local real y
	local integer i
	call UnitAddAbility(u,'Aloc')//Aloc -> Locust
	call ShowUnit(u,false)
	call UnitApplyTimedLife(u,'BTLF',2)
	if GetUnitTypeId(u)=='h03Q' and not FlyingCourierAllowed then//h03Q -> Flying Courier
		call Error(p,"You can't buy Flying courier until 3 minutes mark.")
		call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)+220)
		set u=null
		return
	endif
	if IsIndexIdConsumable(indexId)==false and Item_Real[indexId]!=0 then
		call SaveInteger(MHT,'ITEM',GetPlayerId(p),Item_Real[indexId])
		call SaveReal(MHT,'ITEM',GetPlayerId(p),TimerGetElapsed(GlobalTimer))
	endif
	if UnitItem_RestrictBuying(GetSellingUnit(),u)then
		call Error(p,GetObjectName('n02G'))//n02G -> You are not allowed to carry Observer Wards from enemy stores
		if IsUnitAlly(u,Sentinels[0])then
			set p=Scourges[0]
		else
			set p=Sentinels[0]
		endif
		set x=UnitItem_GetBestXOld(GetSellingUnit(),u)
		set y=UnitItem_GetBestYOld(GetSellingUnit(),u)
		call DelayedItemCreation(Item_Dummy[UnitToIndex(u)],x,y,p,true,FG9(UnitToIndex(u)))
	else
		call ItemStats_Track(p,FindRealIndexId(indexId))
		if Item_Real[indexId]==0 then
			set i=GetItemReceiptIndex(indexId,false)
			if i==-1 then
				call Error(p,GetObjectName('n02H'))//n02H ->  You do not need to purchase a recipe for this item//n02H -> You do not need to purchase a recipe for this item
			else
				call GetMissingItems(udg_Hero[GetPlayerId(p)],i,p)
			endif
		else
			set x=UnitItem_GetBestX(GetSellingUnit(),u)
			set y=UnitItem_GetBestY(GetSellingUnit(),u)
			if indexId==dustofappearance then
				call CheckFuse(p,u,GetSellingUnit(),FindRealIndexId(indexId),x,y,2,0)
			else
				call CheckFuse(p,u,GetSellingUnit(),FindRealIndexId(indexId),x,y,0,0)
			endif
		endif
	endif
	
	set u=null
	set p=null
endfunction

function CompleteItemReceipeClick takes nothing returns nothing
	set ISRECIPECLICK=true
endfunction

function AddPickTimeWrapper takes nothing returns nothing
	if b_isPickTime and TimerGetRemaining(NK)>0 and ((IsSentinel(GetTriggerPlayer()) and CanAddTime[0]>0) or (IsScourge(GetTriggerPlayer()) and CanAddTime[1]>0))then
		if IsSentinel(GetTriggerPlayer())then
			set CanAddTime[0]=CanAddTime[0]-1
			if IsDead(AddTime1) then
				call KillUnit(AddTime2)
			else
				call KillUnit(AddTime1)
			endif
		else
			set CanAddTime[1]=CanAddTime[1]-1
			if IsDead(AddTime3) then
				call KillUnit(AddTime4)
			else
				call KillUnit(AddTime3)
			endif
		endif
		call ExecuteFunc("AddTimeToTimer")
		call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[GetPlayerId(GetTriggerPlayer())]+GetPlayerName(GetTriggerPlayer())+"|r"+" has added 1 minute to the picking time.")
	endif
endfunction

function AddTimeBought takes player p returns nothing
	if b_isPickTime and TimerGetRemaining(NK)>0 and ((IsSentinel(p) and CanAddTime[0]>0) or (IsScourge(p) and CanAddTime[1]>0))then
		if IsSentinel(p)then
			set CanAddTime[0]=CanAddTime[0]-1
		else
			set CanAddTime[1]=CanAddTime[1]-1
		endif
		call ExecuteFunc("AddTimeToTimer")
		call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[GetPlayerId(p)]+GetPlayerName(p)+"|r has added 1 minute to the picking time.")
	endif
endfunction

function UnitItem_Enter takes nothing returns boolean
	local unit u=GetSoldUnit()
	local player p=GetLocalPlayer()
	local player buyer=GetOwningPlayer(u)
	local integer pid=GetPlayerId(buyer)
	local integer uid=UnitToIndex(u)
	if GetUnitTypeId(u)=='h304' or GetUnitTypeId(u)=='h305' then//h304 -> Add time, h305 -> Add time
		if (IsSentinel(buyer) and GetUnitTypeId(u)=='h304') or (IsScourge(buyer) and GetUnitTypeId(u)=='h305') then//h304 -> Add time, h305 -> Add time
			call KillUnit(GetSellingUnit())
			call AddTimeBought(GetOwningPlayer(u))
		else
			call Error(buyer,"It's up to enemy to decide. Use Altars placed on your side.")
		endif
		call RemoveUnit(u)
	elseif GetUnitTypeId(u)=='h307' then//h307 -> R|cffffcc00e|rady
		set tt_player1=GetOwningPlayer(u)
		call ExecuteFunc("ReadyCMDAltar")
		call RemoveUnit(u)
	endif
	if GetUnitPointValue(u)>=200 then
		call UnitItem_Main()
		if IsPlayerAlly(p,buyer)or(udg_ObserverMode and(p==udg_Observer1 or p==udg_Observer2))then
			if uid==AnimalCourier then
				call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
				call DisplayTimedTextToPlayer(p,0,0,20,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0HU')+"|r")//n0HU -> has purchased a courier.
			elseif uid==RecipeFlyingCourier and FlyingCourierAllowed then
				call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
				call DisplayTimedTextToPlayer(p,0,0,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0KG')+"|r")//n0KG -> has purchased a flying courier.
			elseif uid==dustofappearance then
				call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0KO')+"|r")//n0KO -> has purchased Dust of Appearance
			elseif uid==ObserverWards then
				call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
				call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0KP')+"|r")//n0KP -> has purchased Observer Wards
			elseif uid==SentryWards then
				call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
				call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0KQ')+"|r")//n0KQ -> has purchased Sentry Wards
			elseif uid==RecipeUrnOfShadows then
				call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
				call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0KT')+"|r")//n0KT -> has purchased Urn of Shadows
			elseif uid==Gem then
				call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
				call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0LB')+"|r")//n0LB -> has purchased Gem of Truesight
			elseif uid==Smoke then
				call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
				call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0LP')+"|r")//n0LP -> has purchased Smoke of Deceit
			endif
		endif
		if uid==Bottle0Shop then
			if BottlePickupRunesOldfashion[pid]==false then
				call DisplayTimedTextToPlayer(buyer,0,0,TxtDur[GetPlayerId(GetLocalPlayer())],"|c00FF0000Note|r: you can disable or enable righ-click rune picking using '-orp' chat command. It's enabled by default.")
			endif
		endif
	else
		call DeliverItems_Main()
	endif
	set u=null
	return false
endfunction


function IsDoubleFacedItem takes integer iit returns boolean
	return iit==EyeOfSkadiRanged or iit==EyeOfSkadi or iit==QuellingBladeRanged or iit==QuellingBlade or iit==StoutShieldRanged or iit==StoutShield or iit==PoormansShieldRanged or iit==PoormansShield or iit==VanguardRanged or iit==Vanguard or iit==OrbOfVenomRanged or iit==OrbOfVenom or iit==MantaStyleRanged or iit==MantaStyle
endfunction

function RestrictedItems_UpdateMeleeRange takes unit u,item it returns nothing
	local integer uid=GetUnitTypeId(u)
	local integer iid=GetIndexNoMute(it)
	local player p
	if IsDoubleFacedItem(iid)==false then
		return
	endif
	if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) or IsUnitType(u,UNIT_TYPE_HERO)==false then
		if iid==EyeOfSkadiRanged then
			set p=GetItemPlayer(it)
			call DestroyItem(it)
			call UnitAddItemByIdLoD(u,Item_Real[EyeOfSkadi],p,false,1)
//		elseif iid==QuellingBladeRanged then
//			set p=GetItemPlayer(it)
//			call DestroyItem(it)
//			call UnitAddItemByIdLoD(u,Item_Real[QuellingBlade],p,false,1)
		elseif iid==StoutShieldRanged then
			set p=GetItemPlayer(it)
			call DestroyItem(it)
			call UnitAddItemByIdLoD(u,Item_Real[StoutShield],p,false,1)
		elseif iid==PoormansShieldRanged then
			set p=GetItemPlayer(it)
			call DestroyItem(it)
			call UnitAddItemByIdLoD(u,Item_Real[PoormansShield],p,false,1)
		elseif iid==VanguardRanged then
			set p=GetItemPlayer(it)
			call DestroyItem(it)
			call UnitAddItemByIdLoD(u,Item_Real[Vanguard],p,false,1)
		elseif iid==OrbOfVenomRanged then
			set p=GetItemPlayer(it)
			call DestroyItem(it)
			call UnitAddItemByIdLoD(u,Item_Real[OrbOfVenom],p,false,1)
//		elseif iid==MantaStyleRanged then
//			set p=GetItemPlayer(it)
//			call DestroyItem(it)
//			call UnitAddItemByIdLoD(u,Item_Real[MantaStyle],p,false,1)
		endif
	else
		if iid==EyeOfSkadi then
			set p=GetItemPlayer(it)
			call DestroyItem(it)
			call UnitAddItemByIdLoD(u,Item_Real[EyeOfSkadiRanged],p,false,1)
//		elseif iid==QuellingBlade then
//			set p=GetItemPlayer(it)
//			call DestroyItem(it)
//			call UnitAddItemByIdLoD(u,Item_Real[QuellingBladeRanged],p,false,1)
		elseif iid==StoutShield then
			set p=GetItemPlayer(it)
			call DestroyItem(it)
			call UnitAddItemByIdLoD(u,Item_Real[StoutShieldRanged],p,false,1)
		elseif iid==PoormansShield then
			set p=GetItemPlayer(it)
			call DestroyItem(it)
			call UnitAddItemByIdLoD(u,Item_Real[PoormansShieldRanged],p,false,1)
		elseif iid==Vanguard then
			set p=GetItemPlayer(it)
			call DestroyItem(it)
			call UnitAddItemByIdLoD(u,Item_Real[VanguardRanged],p,false,1)
		elseif iid==OrbOfVenom then
			set p=GetItemPlayer(it)
			call DestroyItem(it)
			call UnitAddItemByIdLoD(u,Item_Real[OrbOfVenomRanged],p,false,1)
//		elseif iid==MantaStyle then
//			set p=GetItemPlayer(it)
//			call DestroyItem(it)
//			call UnitAddItemByIdLoD(u,Item_Real[MantaStyleRanged],p,false,1)
		endif
	endif
endfunction

function RestrictedItems takes unit Hero,item Item returns boolean
	local unit u=Hero
	local integer unitId=GetUnitTypeId(u)
	local integer indexId=GetIndex(Item)
	local real x
	local real y
	local integer i
	local boolean continue=true
	set x=GetUnitX(u)
	set y=GetUnitY(u)
	if indexId==Bottle0Shop then
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"overhead"))
		call SoundForPlayer(GetOwningPlayer(u),"Abilities\\Spells\\Human\\Heal\\HealTarget.wav")
		set tt_player1=GetItemPlayer(Item)
		call DestroyItem(Item)
		call UnitAddItemByIdLoD(Hero,Item_Real[Bottle3],tt_player1,false,1)
		call UnitRemoveAbility(u,'B0GI')//B0GI -> Empty Bottle Slow
	endif
	if (indexId)==DiffusalBlade and GetItemCharges(Item)==0 then
		set tt_player1=GetItemPlayer(Item)
		call DestroyItem(Item)
		call UnitAddItemByIdLoD(Hero,Item_Real[DiffusalBlade_empty],tt_player1,false,1)
	endif
	if indexId==janggo and GetItemCharges(Item)==0 then
		set tt_player1=GetItemPlayer(Item)
		call DestroyItem(Item)
		call UnitAddItemByIdLoD(Hero,Item_Real[janggoempty],tt_player1,false,1)
	endif
	call DisableTrigger(t_manipulateitem)
	if(indexId==PowerTreadsStrength or indexId==PowerTreadsAgility or indexId==PowerTreadsIntelligence)and(FindItemOfTypeEx(u,Item_Real[PowerTreadsStrength],Item)!=null or FindItemOfTypeEx(u,Item_Real[PowerTreadsAgility],Item)!=null or FindItemOfTypeEx(u,Item_Real[PowerTreadsIntelligence],Item)!=null)then
		call Error(GetOwningPlayer(u),GetObjectName('n02L'))//n02L -> You are only allowed to carry one Power Treads
		set tt_player1=GetItemPlayer(Item)
		call RemoveItem(Item)
		set tt_item1=CreateItem(Item_Dummy[indexId],x,y)
		call SetItemPlayer(tt_item1,tt_player1,false)
		call SetItemUserData(tt_item1,1)
	endif
	if(indexId==ArmletOff or indexId==ArmletOn or indexId==ArmletOffCourier or indexId==ArmletOnCourier)and(FindItemOfTypeEx(u,Item_Real[ArmletOff],Item)!=null or FindItemOfTypeEx(u,Item_Real[ArmletOn],Item)!=null or FindItemOfTypeEx(u,Item_Real[ArmletOffCourier],Item)!=null or FindItemOfTypeEx(u,Item_Real[ArmletOnCourier],Item)!=null)then
		call Error(GetOwningPlayer(u),GetObjectName('n02C'))//n02C -> You are only allowed to carry one Armlet of Mordiggian
		set tt_player1=GetItemPlayer(Item)
		call RemoveItem(Item)
		set tt_item1=CreateItem(Item_Dummy[indexId],x,y)
		call SetItemPlayer(tt_item1,tt_player1,false)
		call SetItemUserData(tt_item1,1)
	endif
	if(indexId==BKB10 or indexId==BKB09 or indexId==BKB08 or indexId==BKB07 or indexId==BKB06 or indexId==BKB05)then
		set i=LoadInteger(HeroStats,GetHandleId(GetOwningPlayer(u)),'0BKB')
		if i==0 and indexId!=BKB10 then
			set tt_player1=GetItemPlayer(Item)
			call DestroyItem(Item)
			call UnitAddItemByIdLoD(Hero,Item_Real[BKB10],tt_player1,false,1)
		elseif i==9 and indexId!=BKB09 then
			set tt_player1=GetItemPlayer(Item)
			call DestroyItem(Item)
			call UnitAddItemByIdLoD(Hero,Item_Real[BKB09],tt_player1,false,1)
		elseif i==8 and indexId!=BKB08 then
			set tt_player1=GetItemPlayer(Item)
			call DestroyItem(Item)
			call UnitAddItemByIdLoD(Hero,Item_Real[BKB08],tt_player1,false,1)
		elseif i==7 and indexId!=BKB07 then
			set tt_player1=GetItemPlayer(Item)
			call DestroyItem(Item)
			call UnitAddItemByIdLoD(Hero,Item_Real[BKB07],tt_player1,false,1)
		elseif i==6 and indexId!=BKB06 then
			set tt_player1=GetItemPlayer(Item)
			call DestroyItem(Item)
			call UnitAddItemByIdLoD(Hero,Item_Real[BKB06],tt_player1,false,1)
		elseif i==5 and indexId!=BKB05 then
			set tt_player1=GetItemPlayer(Item)
			call DestroyItem(Item)
			call UnitAddItemByIdLoD(Hero,Item_Real[BKB05],tt_player1,false,1)
		endif
	endif
	if(indexId==DivineRapier and IsPlayerEnemy(GetItemPlayer(Item),GetOwningPlayer(u)))then
		set tt_player1=GetItemPlayer(Item)
		call DestroyItem(Item)
		set tt_item1=UnitAddItemById(u,Item_Real[DivineRapierFree])
		call SetItemPlayer(tt_item1,tt_player1,false)
		call SetItemUserData(tt_item1,1)
	endif
	if(indexId==Aegis)and(IsCourier(u)or IsSpiritBear(u))then
		if IsCourier(u)then
			call Error(GetOwningPlayer(u),GetObjectName('n02K'))//n02K -> Your crow is not allowed to wield this item
		endif
		set tt_player1=GetItemPlayer(Item)
		set tt_int1=GetItemCharges(Item)
		call RemoveItem(Item)
		if indexId==Aegis then
			set tt_item1=CreateItem(Item_Dummy[indexId],GetRectCenterX(RoshanSpawnRect),GetRectCenterY(RoshanSpawnRect))
			call SetItemCharges(tt_item1,tt_int1)
		endif
		call SetItemPlayer(tt_item1,tt_player1,false)
		call SetItemUserData(tt_item1,1)
	endif
	call EnableTrigger(t_manipulateitem)
	if continue then
		call RestrictedItems_UpdateMeleeRange(Hero,Item)
	endif
	set u=null
	set Item=null
	return false
endfunction

function B69 takes integer indexId returns boolean
	return indexId==HelmOfTheDominatorCourier or indexId==ArmletOnCourier or indexId==ArmletOffCourier or indexId==ShivasGuardCourier or indexId==HelmOfTheDominator or indexId==ArmletOn or indexId==ArmletOff or indexId==ShivasGuard or indexId==Gem or indexId==GemCourier or indexId==HandOfMidas or indexId==HandOfMidasCourier
endfunction

function BL9 takes integer indexId returns boolean
	return indexId==Gem or indexId==GemCourier
endfunction

function B19 takes unit Hero,item Item returns boolean
	local integer FN9=0
	local item B38=Item
	local integer indexId=F49(B38)
	local integer B09=0
	local boolean result=false
	local integer B59=F79(B38)
	local boolean B29=false
	if IsUnitType(Hero,UNIT_TYPE_HERO) then
		if indexId==HelmOfTheDominatorCourier then
			set B09=HelmOfTheDominator
		elseif indexId==HandOfMidasCourier then
			set B09=HandOfMidas
		elseif indexId==ArmletOnCourier then
			set B09=ArmletOn
		elseif indexId==ArmletOffCourier then
			set B09=ArmletOff
		elseif indexId==ShivasGuardCourier then
			set B09=ShivasGuard
		elseif indexId==GemCourier then
			set B09=Gem
		endif
		if B59==GemCourier then
			set B09=Gem
			set B29=true
		endif
		if B09!=0 then
			set tt_player1=GetItemPlayer(B38)
			call DestroyItem(B38)
			if B29 then
				set tt_item1=UnitAddItemById(Hero,Item_Mute[B09])
			else
				set tt_item1=UnitAddItemById(Hero,Item_Real[B09])
			endif
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
			set result=true
		endif
	else
//		if indexId==HelmOfTheDominator then
//			set B09=HelmOfTheDominatorCourier
//		endif
//		if IsSpiritBear(Hero)==false then
//			if indexId==HandOfMidas then
//				set B09=HandOfMidasCourier
//			endif
//		else
//			if indexId==HandOfMidasCourier then
//				set B09=HandOfMidas
//			endif
//		endif
//		if indexId==ArmletOn then
//			set B09=ArmletOnCourier
//		endif
//		if indexId==ArmletOff then
//			set B09=ArmletOffCourier
//		endif
//		if indexId==ShivasGuard then
//			set B09=ShivasGuardCourier
//		endif
		if indexId==Gem then
			set B09=GemCourier
		endif
		if B59==Gem then
			set B09=GemCourier
			set B29=true
		endif
		if B09!=0 then
			set tt_player1=GetItemPlayer(B38)
			call DestroyItem(B38)
			if B29 then
				set tt_item1=UnitAddItemById(Hero,Item_Mute[B09])
			else
				set tt_item1=UnitAddItemById(Hero,Item_Real[B09])
			endif
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
			set result=true
		endif
	endif
	set B38=null
	return result
endfunction

function CourierFakedItems_Main takes unit Hero,item Item returns boolean
	if B69(F49(Item))or BL9(F79(Item))then
		return B19(Hero,Item)
	endif
	return false
endfunction

function C79 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Unit=(LoadUnitHandle(HY,h,26))
	local integer EventType=(LoadInteger(HY,h,97))
	local integer indexId=(LoadInteger(HY,h,93))
	local boolean temporary=(LoadBoolean(HY,h,95))
	local item Item
	local player p=GetOwningPlayer(Unit)
	local player owner
	local integer charges
	local boolean consumable=false
	local item newItem
	local integer scepter_indexid
	local integer scepter_abilityid
	local integer scepter_hiddenabilityid
	local integer newCharges
	local item targetItem
	local integer targetCount
	local item FinalItem
	local boolean finished=false
	local integer i
	local integer k
	local real tt
	local boolean scepterWorks
	call DisableTrigger(GenericItemActionTrigger)
	if temporary then
		set FinalItem=null
		set owner=(LoadPlayerHandle(HY,h,54))
		set charges=(LoadInteger(HY,h,76))
	else
		set Item=(LoadItemHandle(HY,h,96))
		set FinalItem=Item
		set owner=GetItemPlayer(Item)
		set charges=GetItemCharges(Item)
	endif
	if temporary==false and Item==null then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call EnableTrigger(GenericItemActionTrigger)
		set t=null
		set Unit=null
		set p=null
		return false
	endif
	if EventType==1 then
		if p!=owner and GetUnitTypeId(Unit)=='ncop' then//ncop -> Circle of Power
			if IsIndexIdConsumable(FindRealIndexId(indexId))or IsIndexIdCharged(FindRealIndexId(indexId))then
				set consumable=true
			endif
			if IsPlayerEnemy(p,owner)then
				call DelayedItemCreation(Item_Dummy[indexId],ItemSpawnX[GetPlayerId(p)],ItemSpawnY[GetPlayerId(p)],owner,consumable,charges)
			else
				call DelayedItemCreation(Item_Dummy[indexId],ItemSpawnX[GetPlayerId(owner)],ItemSpawnY[GetPlayerId(owner)],owner,consumable,charges)
			endif
			call Error(p,GetObjectName('n0DR'))//n0DR -> You cannot pickup items you don't own with your Cicle of Power
			if temporary==false then
				set finished=true
				call DestroyItem(Item)
			endif
		elseif Mode_PM==false and temporary==false and GetItemType(Item)==ITEM_TYPE_CAMPAIGN and MuteToRealId(Item)!=0 and(p==owner or(GetPlayerSlotState(owner)==PLAYER_SLOT_STATE_LEFT))then
			if IsIndexIdCharged(indexId)then
				set consumable=true
			else
				set consumable=false
			endif
			if not(GetPlayerSlotState(owner)==PLAYER_SLOT_STATE_LEFT and Bottle_IsIndexRune(indexId))then
				call DestroyItem(Item)
				set finished=true
				set newItem=UnitAddItemById(Unit,Item_Real[indexId])
				set FinalItem=newItem
				call SetItemPlayer(newItem,owner,false)
				call SetItemUserData(newItem,0)
				if consumable or indexId==Tango or indexId==HealingSalve or indexId==ClarityPotion then
					call SetItemCharges(newItem,charges)
				endif
			endif
		elseif Mode_PM==false and temporary==false and GetItemType(Item)==ITEM_TYPE_PERMANENT and p!=owner and Item_Mute[GetIndex(Item)]!=0 and(GetPlayerSlotState(owner)==PLAYER_SLOT_STATE_LEFT)==false then
			if IsIndexIdCharged(indexId)then
				set consumable=true
			else
				set consumable=false
			endif
			call DestroyItem(Item)
			set finished=true
			set newItem=UnitAddItemById(Unit,Item_Mute[indexId])
			set FinalItem=newItem
			call SetItemPlayer(newItem,owner,false)
			call SetItemUserData(newItem,0)
			if consumable then
				call SetItemCharges(newItem,charges)
			endif
		elseif temporary==false and GetItemType(Item)==ITEM_TYPE_PERMANENT and IsAghanim(Item)and IsUnitType(Unit,UNIT_TYPE_HERO) then
			if HeroAghanim(Unit,false) then
				if indexId==AghanimBasic or (isPlayerPickedAbility(owner,(Alchemist-1)*4+3) and indexId!=AghanimUpgraderGiftable) then
					call DestroyItem(Item)
					if isPlayerPickedAbility(owner,(Alchemist-1)*4+3) then
						set newItem=UnitAddItemById(Unit,Item_Real[AghanimUpgraderGiftable])
					else
						set newItem=UnitAddItemById(Unit,Item_Real[AghanimUpgrader])
					endif
					set FinalItem=newItem
					call SetItemPlayer(newItem,owner,false)
					call SetItemUserData(newItem,1)
				endif
			else
				if indexId!=AghanimBasic then
					call DestroyItem(Item)
					set newItem=UnitAddItemById(Unit,Item_Real[AghanimBasic])
					set FinalItem=newItem
					call SetItemPlayer(newItem,owner,false)
					call SetItemUserData(newItem,1)
				endif
			endif
		elseif temporary==false and GetItemType(Item)==ITEM_TYPE_ARTIFACT then
			if (p!=owner and IsPlayerLeaver(owner)==false and (indexId==Tango or indexId==HealingSalve or indexId==ClarityPotion)) then
				call DisableTrigger(t_manipulateitem)
				call DestroyItem(Item)
				set newItem=UnitAddItemById(Unit,Item_Mute[indexId])
				set FinalItem=newItem
				call SetItemPlayer(newItem,owner,false)
				call SetItemUserData(newItem,1)
				call SetItemCharges(newItem,charges)
				call EnableTrigger(t_manipulateitem)
			else
				call DisableTrigger(t_manipulateitem)
				set targetItem=FindItemOfIndexExForPlayer(owner,Unit,indexId,Item)
				if targetItem==null then
				else
					call SetItemCharges(targetItem,charges+GetItemCharges(targetItem))
					call DestroyItem(Item)
					set FinalItem=null
				endif
				call EnableTrigger(t_manipulateitem)
			endif
		elseif temporary and IsIndexIdConsumable(FindRealIndexId(indexId))then
			if (p==owner) then
				call DisableTrigger(t_manipulateitem)
				if GetEmptyInventorySlots(Unit)==0 and FindItemOfIndexForPlayer(owner,Unit,indexId)==null then
					call Error(p,GetObjectName('n02O'))//n02O -> Inventory is full
					call DelayedItemCreation(Item_Dummy[(indexId)],(((LoadReal(HY,h,6)))*1.),(((LoadReal(HY,h,7)))*1.),(owner),(true),(charges))
				else
					set targetItem=FindItemOfIndexForPlayer(owner,Unit,indexId)
					if targetItem==null then
						call DisableTrigger(t_manipulateitem)
						set newItem=UnitAddItemById(Unit,Item_Real[indexId])
						set FinalItem=newItem
						call SetItemPlayer(newItem,owner,false)
						call SetItemUserData(newItem,1)
						call SetItemCharges(newItem,charges)
					else
						call SetItemCharges(targetItem,charges+GetItemCharges(targetItem))
					endif
				endif
				call EnableTrigger(t_manipulateitem)
			else
				if Item_Mute[indexId]>0 then
					set tt_int1=Item_Mute[indexId]
				else
					set tt_int1=Item_Real[indexId]
				endif
				call DisableTrigger(t_manipulateitem)
				set targetItem=FindItemOfIndexForPlayer(owner,Unit,indexId)
				if targetItem==null and GetEmptyInventorySlots(Unit)!=0 then
					set newItem=UnitAddItemById(Unit,tt_int1)
					set FinalItem=newItem
					call SetItemPlayer(newItem,owner,false)
					call SetItemUserData(newItem,1)
					call SetItemCharges(newItem,charges)
				elseif targetItem==null and GetEmptyInventorySlots(Unit)==0 then
					call Error(p,GetObjectName('n02O'))//n02O -> Inventory is full
					call DelayedItemCreation(Item_Dummy[(indexId)],(((LoadReal(HY,h,6)))*1.),(((LoadReal(HY,h,7)))*1.),(owner),(true),(charges))
				else
					call SetItemCharges(targetItem,charges+GetItemCharges(targetItem))
				endif
				call EnableTrigger(t_manipulateitem)
			endif
		elseif temporary then
			call CheckFuse(owner,Unit,null,indexId,LoadReal(HY,h,6),LoadReal(HY,h,7),charges,1)
		elseif temporary==false and(GetItemType(Item)==ITEM_TYPE_PERMANENT or GetItemType(Item)==ITEM_TYPE_CAMPAIGN)then
			call SetItemUserData(Item,1)
			set finished=AttemptFuse(owner,Unit,0)
		endif
		if finished==false and FinalItem!=null and IsItemTemporary(FinalItem)==false then
			set finished=CourierFakedItems_Main(Unit,FinalItem)
		endif
		if finished==false and FinalItem!=null and IsItemTemporary(FinalItem)==false then
			call RestrictedItems(Unit,FinalItem)
		endif
	else
		if GetWidgetLife(Item)>0 then
			set tt_item1=Item
			if IsAghanim(Item) then
				call HeroAghanim(Unit,true)
			endif
			if GetItemUserData(Item)==-500 then
				call RemoveItem(Item)
			elseif IsItemOwned(Item)==false then
				if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(indexId) or indexId==HealingSalve or indexId==ClarityPotion or indexId==Tango then
					set consumable=true
				endif
				call DelayedItemCreation(Item_Dummy[indexId],GetItemX(Item),GetItemY(Item),owner,consumable,charges)
				call DestroyItem(Item)
			endif
		endif
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call EnableTrigger(GenericItemActionTrigger)
	set t=null
	set Item=null
	set Unit=null
	set p=null
	set owner=null
	set newItem=null
	set targetItem=null
	set FinalItem=null
	return false
endfunction


function IsEnemyTower takes unit u, unit t returns boolean
	local integer id=GetUnitTypeId(t)
	if IsSentinel(GetOwningPlayer(u)) then
		return id=='u00M' or id=='u00D' or id=='u00N' or id=='u00T'//u00M -> Spirit Tower - level 1, u00D -> Spirit Tower - level 2, u00N -> Spirit Tower - level 3, u00T -> Spirit Tower - level 4
	else
		return id=='e00R' or id=='e011' or id=='e00S' or id=='e019'//e00R -> Ancient Protector - level 1, e011 -> Ancient Protector - level 2, e00S -> Ancient Protector - level 3, e019 -> Ancient Protector - level 4
	endif
endfunction


function TranquilsRegister takes nothing returns nothing
	if tranquilsExists==false then
		call AddWrapper("TranquilBootsWrapper",0)
		set tranquilsExists=true
	endif
endfunction

function MjollnirRegister takes nothing returns nothing
	if MjollnirsExists==false then
		call AddWrapper("MjollnirsWrapper",1)
		set MjollnirsExists=true
	endif
endfunction

function QuellingBladeRegister takes nothing returns nothing
	if QuellingBladeExists==false then
		call AddWrapper("QuellingBladeWrapper",0)
		set QuellingBladeExists=true
	endif
endfunction

function DiffusalBladeRegister takes nothing returns nothing
	if DiffusalBladeExists==false then
		call AddWrapper("DiffusalBladeWrapper",0)
		set DiffusalBladeExists=true
	endif
endfunction

function DesolatorExistsRegister takes nothing returns nothing
	if DesolatorExists==false then
		call AddWrapper("DesolatorExistsWrapper",1)
		set DesolatorExists=true
	endif
endfunction

function OrbOfVenomRegister takes nothing returns nothing
	if OrbOfVenomExists==false then
		call AddWrapper("OrbOfVenomWrapper",0)
		set OrbOfVenomExists=true
	endif
endfunction

function SkadiRegister takes nothing returns nothing
	if SkadiExists==false then
		call AddWrapper("SkadiWrapper",2)
		set SkadiExists=true
	endif
endfunction

function SilverEdgeRegister takes nothing returns nothing
	if SilverEdgeExists==false then
		call AddWrapper("SilverEdgeWrapper",2)
		set SilverEdgeExists=true
	endif
endfunction

function VladmirOfferingRegister takes nothing returns nothing
	if VladmirOfferingInGame==false then
		call AddWrapper("VladmirOfferingWrapper",0)
		set VladmirOfferingInGame=true
	endif
endfunction

function ItemSoldPost takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local player p=LoadPlayerHandle(HY,h,0)
	local integer pid=GetPlayerId(p)
	local integer goldold=LoadInteger(HY,h,0)
	local integer gold=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
	local integer diff=GetItemGoldCostById(LoadInteger(HY,h,1)) / 2
	if diff>0 then
		call DisplayTimedTextToPlayer(p,0,0,5,"Newly bought item sold, |cfffffa00"+I2S(diff)+"|r gold refunded.")
		call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)+diff)
		call SaveInteger(MHT,'ITEM',pid,0)
		call SaveReal(MHT,'ITEM',pid,0.0)
	endif
	call PauseTimer(t)
	call DestroyTimer(t)
	call RemoveSavedHandle(TempHash,'ITEM',GetPlayerId(p))
	set t=null
endfunction

function IsHealingItem takes item it returns boolean
	return Item_Real[GetIndex(it)]==Item_Real[RingOfHealth]
endfunction

function ItemSold takes player p, item it returns nothing
	local timer t
	local integer gold
	local integer pid=GetPlayerId(p)
	if Item_Real[GetIndex(it)]==LoadInteger(MHT,'ITEM',pid) and TimerGetElapsed(GlobalTimer)-LoadReal(MHT,'ITEM',pid) < 10.0 and IsHealingItem(it)==false and HaveSavedHandle(TempHash,'ITEM',GetPlayerId(p))==false then
		set t=CreateTimer()
		set gold=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
		call TimerStart(t,0,false,function ItemSoldPost)
		call SavePlayerHandle(HY,GetHandleId(t),0,p)
		call SaveInteger(HY,GetHandleId(t),0,gold)
		call SaveTimerHandle(TempHash,'ITEM',GetPlayerId(p),t)
		call SaveInteger(HY,GetHandleId(t),1,GetItemTypeId(it))
		set t=null
	endif
endfunction


function CM9 takes nothing returns boolean
	local item Item
	local integer EventType
	local unit Unit=GetTriggerUnit()
	local trigger t
	local integer h
	local integer scepter_indexid
	local integer scepter_abilityid
	local integer id
	local integer k
	local item it
	local integer i=GetItemTypeId(GetManipulatedItem())
	set NetWorthRecount[GetPlayerId(GetOwningPlayer(Unit))]=true
	set id=GetPlayerId(GetOwningPlayer(Unit))
	if(IsUnitType(Unit,UNIT_TYPE_HERO) or IsSpiritBear(Unit))and IsUnitIllusion(Unit)==false then
		if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
			if i==Item_Real[Butterfly] or i==Item_Real[TalismanOfEvasion] or i==Item_Real[MKBOn] or i==Item_Real[HeavensHalberd] or i==Item_Real[SolarCrest] then
				if i==Item_Real[Butterfly]then
					call EvasionSourceActivate(EVASION_SOURCE_BUTTERFLY,99999)
				elseif i==Item_Real[TalismanOfEvasion]then
					call EvasionSourceActivate(EVASION_SOURCE_TALISMAN,99999)
				elseif i==Item_Real[HeavensHalberd]then
					call EvasionSourceActivate(EVASION_SOURCE_HALBERD,99999)
				elseif i==Item_Real[SolarCrest]then
					call EvasionSourceActivate(EVASION_SOURCE_SOLARCREST,99999)
				elseif i==Item_Real[MKBOn]then
					call EvasionSourceActivate(EVASION_BUFF_MKB,99999)
				endif
			endif
			if i==Item_Real[javelin]then
				set HasItem_Javelin[id]=HasItem_Javelin[id]+1
			elseif i==Item_Real[KelensDagger]then
				set TotalCount_Dagger=TotalCount_Dagger+1
				set HasItem_Dagger[id]=HasItem_Dagger[id]+1
			elseif i==Item_Real[MKBOn] or i==Item_Real[MKBOff] then
				call ExecuteFunc("Preload_CalculatePossibleBashes")
			elseif i==Item_Real[bloodstone]then
				set TotalCount_Bloodstone=TotalCount_Bloodstone+1
				set HasItem_Bloodstone[id]=HasItem_Bloodstone[id]+1
			elseif i==Item_Real[CraniumBasher]or (i)==Item_Real[AbyssalBlade]then
				set HasItem_CraniumBasher[id]=HasItem_CraniumBasher[id]+1
				call ExecuteFunc("Preload_CalculatePossibleBashes")
			elseif i==Item_Real[Desolator] then
				call DesolatorExistsRegister()
			elseif i==Item_Real[HeartOfTarrasque]then
				set TotalCount_Heart=TotalCount_Heart+1
				set HasItem_Heart[id]=HasItem_Heart[id]+1
			elseif i==Item_Real[LinkensSphere]then
				set TotalCount_LinkenSphere=TotalCount_LinkenSphere+1
				set HasItem_LinkenSphere[id]=HasItem_LinkenSphere[id]+1
				call DisableTrigger(t_manipulateitem)
				set it=CreateItem('I0HM',GetUnitX(Unit),GetUnitY(Unit))//I0HM -> Linken's Sphere
				call UnitAddItem(Unit,it)
				if GetWidgetLife(it)>0 then
					call RemoveItem(it)
				endif
				set it=null
				call EnableTrigger(t_manipulateitem)
			elseif i==Item_Real[SangeAndYasha]then
				set HasItem_SangeNYasha[id]=HasItem_SangeNYasha[id]+1
			elseif i==Item_Real[Sange]then
				set HasItem_Sange[id]=HasItem_Sange[id]+1
			elseif (i)==Item_Real[HeavensHalberd]then
				set HasItem_HeavensHalberd[id]=HasItem_HeavensHalberd[id]+1
			elseif i==Item_Real[TranquilBoots]then
				set TotalCount_Tranquils=TotalCount_Tranquils+1
				call TranquilsRegister()
				set HasItem_TranquilBoots[id]=HasItem_TranquilBoots[id]+1
			elseif i==Item_Real[QuellingBlade] or i==Item_Real[QuellingBladeRanged]then
				call QuellingBladeRegister()
			elseif i==Item_Real[DiffusalBlade] or i==Item_Real[DiffusalBlade_upg] or id==Item_Real[DiffusalBlade_empty] then
				call DiffusalBladeRegister()
			elseif i==Item_Real[EyeOfSkadi] or i==Item_Real[EyeOfSkadiRanged] then
				call SkadiRegister()
			elseif i==Item_Real[OrbOfVenom] or i==Item_Real[OrbOfVenomRanged] then
				call OrbOfVenomRegister()
			elseif i==Item_Real[Mjollnir] or i==Item_Real[Maelstrom] then
				call MjollnirRegister()
			elseif i==Item_Real[Butterfly] then
				if HaveSavedHandle(HY,GetHandleId(Unit),'AIev')==false then//AIev -> Evasion
					call UnitAddAbility2(Unit,'A431')
					call UnitMakeAbilityPermanent(Unit,true,'AIev')//AIev -> Evasion
				endif
			elseif i==Item_Real[SilverEdge] then
				call SilverEdgeRegister()
			elseif i==Item_Real[VladmirsOffering] then
				call VladmirOfferingRegister()
			endif
		elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM then
			if i==Item_Real[javelin]then
				set HasItem_Javelin[id]=HasItem_Javelin[id]-1
			elseif i==Item_Real[KelensDagger]then
				set HasItem_Dagger[id]=HasItem_Dagger[id]-1
				set TotalCount_Dagger=TotalCount_Dagger-1
			elseif i==Item_Real[TranquilBoots]then
				set HasItem_TranquilBoots[id]=HasItem_TranquilBoots[id]-1
				set TotalCount_Tranquils=TotalCount_Tranquils-1
			elseif i==Item_Real[bloodstone]then
				set HasItem_Bloodstone[id]=HasItem_Bloodstone[id]-1
				set TotalCount_Bloodstone=TotalCount_Bloodstone-1
			elseif i==Item_Real[CraniumBasher]or (i)==Item_Real[AbyssalBlade]then
				set HasItem_CraniumBasher[id]=HasItem_CraniumBasher[id]-1
				if HasItem_CraniumBasher[id]<1 or FindItemOfTypeEx(Unit,Item_Real[CraniumBasher],GetManipulatedItem())==null or FindItemOfTypeEx(Unit,Item_Real[AbyssalBlade],GetManipulatedItem())==null then
					call UnitRemoveAbility(Unit,'A174')//A174 -> Cranium Basher Container
				endif
			elseif i==Item_Real[HeartOfTarrasque]then
				set HasItem_Heart[id]=HasItem_Heart[id]-1
				set TotalCount_Heart=TotalCount_Heart-1
			elseif i==Item_Real[LinkensSphere]or i==Item_Mute[LinkensSphere]then
				set TotalCount_LinkenSphere=IMaxBJ(TotalCount_LinkenSphere-1,0)
				set HasItem_LinkenSphere[id]=IMaxBJ(HasItem_LinkenSphere[id]-1,0)
				call UnitRemoveAbility(Unit,'B0BI')//B0BI -> Linken Sphere
			elseif i==Item_Real[Butterfly] then
				if FindItemOfTypeEx(Unit,Item_Real[Butterfly],GetManipulatedItem())==null then
					call UnitRemoveAbility(Unit,'A431')
				endif
			endif
		endif
	endif
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_PAWN_ITEM then
		set Item=GetSoldItem()
		call SetItemUserData(Item,-2)
		call ItemSold(GetOwningPlayer(Unit),Item)
		set tt_item1=Item
		if IsAghanim(Item) then
			call HeroAghanim(Unit,true)
		endif
		
	elseif GetItemTypeId(GetManipulatedItem())!='I02M' then//I02M -> Dummy Item Scourge
		set Item=GetManipulatedItem()
		if IsUnitIllusion(Unit)or GetItemUserData(Item)==-2 then
			set Item=null
			set Unit=null
			set t=null
			return false
		endif
		if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
			set EventType=1
		else
			set EventType=2
		endif
		if((EventType==1) or(EventType==2 and IsItemTemporary(Item)==false and GetWidgetLife(Item)>0))and GetUnitTypeId(Unit)!='H00J' then//H00J -> Geomancer
			if IsRune(GetItemTypeId(Item)) or IsFakeRune(GetItemTypeId(Item)) or GetItemTypeId(Item)=='I0HM' then//I0HM -> Linken's Sphere
				set Item=null
				set Unit=null
				set t=null
				return false
			endif
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call TriggerRegisterTimerEvent(t,0,false)
			call TriggerAddCondition(t,Condition(function C79))
			call SaveUnitHandle(HY,h,26,(Unit))
			call SaveInteger(HY,h,97,(EventType))
			call SaveInteger(HY,h,93,(GetIndex(Item)))
			call SaveItemHandle(HY,h,0,Item)
			if IsItemTemporary(Item)then
				call SaveBoolean(HY,h,95,(true))
				call SavePlayerHandle(HY,h,54,(GetItemPlayer(Item)))
				call SaveInteger(HY,h,76,(GetItemCharges(Item)))
				//call BJDebugMsg(I2S(GetItemCharges(Item)))
				call SaveReal(HY,h,6,((GetItemX(Item))*1.))
				call SaveReal(HY,h,7,((GetItemY(Item))*1.))
			else
				call SaveBoolean(HY,h,95,(false))
				call SaveItemHandle(HY,h,96,(Item))
				call SetItemUserData(Item,0)
			endif
		endif
	endif
	set Item=null
	set Unit=null
	set t=null
	return false
endfunction

function CO9 takes unit Hero,integer CP9,boolean CQ9 returns nothing
	local string CR9
	local string s
	local player p=GetOwningPlayer(Hero)
	local real d=2
	local string CS9="Use"
	if CQ9 then
		set CS9="Store"
	endif
	if CP9=='I006'or CP9==GetFakeRune('I006') then//I006 -> |c00ff0303Haste|r
		set CR9="|c00ff0000"+GetObjectName('n0JQ')+"|r"//n0JQ -> Haste
		call Traffic_RegisterData("Rune"+CS9+"1",GetPlayerId(p))
	elseif CP9=='I008'or CP9==GetFakeRune('I008') then//I008 -> |cff00ff00Regeneration|r
		set CR9="|c0000ff00"+GetObjectName('n0JN')+"|r"//n0JN -> Regeneration
		call Traffic_RegisterData("Rune"+CS9+"2",GetPlayerId(p))
	elseif CP9=='I00K'or CP9==GetFakeRune('I00K') then//I00K -> |c000042ffDouble Damage|r
		set CR9="|c000000ff"+GetObjectName('n0K3')+"|r"//n0K3 -> Double Damage
		call Traffic_RegisterData("Rune"+CS9+"3",GetPlayerId(p))
	elseif CP9=='I007'or CP9==GetFakeRune('I007') then//I007 -> |c00fffc01Illusion|r
		set CR9="|c00afaf00"+GetObjectName('n0K2')+"|r"//n0K2 -> Illusion
		call Traffic_RegisterData("Rune"+CS9+"4",GetPlayerId(p))
	elseif CP9=='I00J'or CP9==GetFakeRune('I00J') then//I00J -> |cff99ccffInvisibility|r
		set CR9="|c00652DC1"+GetObjectName('n0K4')+"|r"//n0K4 -> Invisibility
		call Traffic_RegisterData("Rune"+CS9+"5",GetPlayerId(p))
	elseif CP9=='I0QA'or CP9==GetFakeRune('I0QA') then//I0QA -> |c00ffff01Bounty|r
		set CR9="|c00ffff01"+"Bounty"+"|r"
		call Traffic_RegisterData("Rune"+CS9+"6",GetPlayerId(p))
	endif
	if CQ9 then
		set s=udg_Colors[GetPlayerId(p)]+GetUnitName(Hero)+"|r "+GetObjectName('n0GU')+"|r "+CR9+" "+GetObjectName('n0GW')//n0GU -> has bottled the, n0GW -> rune
		set d=1
	else
		if VP7 then
			set s=udg_Colors[GetPlayerId(p)]+GetUnitName(Hero)+"|r "+GetObjectName('n0GV')+"|r "+CR9+" "+GetObjectName('n0GW')//n0GV -> has used the stored, n0GW -> rune
		else
			set s=udg_Colors[GetPlayerId(p)]+GetUnitName(Hero)+"|r "+GetObjectName('n0GT')+"|r "+CR9+" "+GetObjectName('n0GW')//n0GT -> has acquired a, n0GW -> rune
		endif
	endif
	if(IsPlayerAlly(GetLocalPlayer(),p)and GetLocalPlayer()!=p)or IsObserver(GetLocalPlayer()) or IsL1ch then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,d,s)
	endif
	set p=null
endfunction

function SmoothHealingSystemDurForBottle takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit target=LoadUnitHandle(HY,h,0)
	local integer buffid=LoadInteger(HY,h,0)
	local real amounthp=LoadReal(HY,h,0)
	local real amountmp=LoadReal(HY,h,1)
	local real duration=LoadReal(HY,h,2)
	if IsDead(target)==false and GetUnitAbilityLevel(target,buffid)>0 then
		if amountmp>0 then
			call SetUnitState(target,UNIT_STATE_MANA,GetUnitState(target,UNIT_STATE_MANA)+amountmp/duration*0.1)
		endif
		if amounthp>0 and IsUnitHPFreezed(target)==false then
			call SetWidgetLife(target,GetWidgetLife(target)+amounthp/duration*0.1)
		endif
	else
		call SaveBoolean(MHT,GetHandleId(target),buffid,false)
		call PauseTimer(t)
		call FlushChildHashtable(HY,h)
		call DestroyTimer(t)
	endif
	set t=null
	set target=null
endfunction

function SmoothHealingSystemForBottle takes real hp, real mp, real dur, integer buffid, unit target returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0.1,true,function SmoothHealingSystemDurForBottle)
	call SaveUnitHandle(HY,h,0,target)
	call SaveBoolean(MHT,GetHandleId(target),buffid,true)
	call SaveInteger(HY,h,0,buffid)
	call SaveReal(HY,h,0,hp)
	call SaveReal(HY,h,1,mp)
	call SaveReal(HY,h,2,dur)
	set t=null
endfunction

function SmoothHealingSystemDur takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit target=LoadUnitHandle(HY,h,0)
	local integer htype=LoadInteger(HY,h,1)
	local integer buffid=LoadInteger(HY,h,0)
	local real amount=LoadReal(HY,h,0)
	local real duration=LoadReal(HY,h,1)
	if IsDead(target)==false and GetUnitAbilityLevel(target,buffid)>0 then
		if htype=='00MP' then
			call SetUnitState(target,UNIT_STATE_MANA,GetUnitState(target,UNIT_STATE_MANA)+amount/duration*0.1)
		elseif htype=='00HP' then
			if IsUnitHPFreezed(target)==false then
				call SetWidgetLife(target,GetWidgetLife(target)+amount/duration*0.1)
			endif
		endif
	else
		call PauseTimer(t)
		call FlushChildHashtable(HY,h)
		call DestroyTimer(t)
	endif
	set t=null
	set target=null
endfunction

function SmoothHealingSystem takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local unit target=GetSpellTargetUnit()
	call TimerStart(t,0.1,true,function SmoothHealingSystemDur)
	call SaveUnitHandle(HY,h,0,target)
	if GetSpellAbilityId()=='AIpl' or GetSpellAbilityId()=='A1WA' then//clarity//AIpl -> Lesser Clarity Potion, A1WA -> Sapphire Water Temp
		call SaveInteger(HY,h,0,'BIrm')//BIrm -> Clarity Potion
		call SaveInteger(HY,h,1,'00MP')
		call SaveReal(HY,h,0,170)
		call SaveReal(HY,h,1,45)
	else//salve
		call SaveInteger(HY,h,0,'B02Z')//B02Z -> Healing Salve
		call SaveInteger(HY,h,1,'00HP')
		call SaveReal(HY,h,0,400)
		call SaveReal(HY,h,1,10)
	endif
	set t=null
	set target=null
endfunction

function CT9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	if GetUnitAbilityLevel(Hero,'B01S')==0 or(GetWidgetLife(Hero)==GetUnitState(Hero,UNIT_STATE_MAX_LIFE)and GetUnitState(Hero,UNIT_STATE_MANA)==GetUnitState(Hero,UNIT_STATE_MAX_MANA)) then//B01S -> |c000000ffRegeneration|r
		call UnitRemoveAbility(Hero,'B01S')//B01S -> |c000000ffRegeneration|r
		call UnitRemoveAbility(Hero,'B04A')//B04A -> Bottle 
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Hero=null
	return false
endfunction

function CU9 takes unit Hero,item Item returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddCondition(t,Condition(function CT9))
	call SaveUnitHandle(HY,h,14,Hero)
	set t=null
	if LoadBoolean(MHT,GetHandleId(Hero),'B01S')==false then//B01S -> |c000000ffRegeneration|r
		call SmoothHealingSystemForBottle(3000,2000,30,'B01S',Hero)//B01S -> |c000000ffRegeneration|r
	endif
endfunction

function CV9 takes unit Hero,item Item returns nothing
	local unit u=Hero
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local unit Caster=CreateUnit(GetOwningPlayer(u),'e00E',x,y,0)//e00E -> Spellcaster
	call UnitAddAbility(Caster,'A0GR')//A0GR -> Illusions
	call IssueTargetOrderById(Caster,852274,u)
	call IssueTargetOrderById(Caster,852274,u)
	set u=null
	set Caster=null
endfunction

function RemoveDefaultString2 takes nothing returns nothing
	local unit cho= LoadUnitHandle(HY,690,1)
	local integer cha=0
	local timer t= GetExpiredTimer()
	loop
		exitwhen cha>6
		if GetItemTypeId(UnitItemInSlot(cho,cha))==0 then
			call UnitRemoveItemFromSlot(cho,cha)
		endif
		set cha=cha + 1
	endloop
	call Timer_End(t)
	set t=null
	set cho=null
endfunction

function RemoveDefaultString takes unit Hero, real i returns nothing
	local timer t =CreateTimer()
	call SaveUnitHandle(HY,690,1,Hero)
	call TimerStart(t,i,false,function RemoveDefaultString2)
	set t=null
endfunction

function BountyRunePickup takes unit u returns nothing
	local integer m=IMaxIF(0,R2I((TimerGetElapsed(GlobalTimer)-GameStartsTime)/60))
	local integer g
	local integer xp
	if doubledBounty then
		set g=100
		set xp=100
	else
		set g=m*2+50
		set xp=m*5+50
	endif
	if GetUnitAbilityLevel(u,'B00X')!=0 then//B00X -> Goblin's Greed
		set g=R2I(g*(GetUnitAbilityLevel(u,'A0O3')*0.5+2.5))
	endif
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\ResourceItems\\ResourceEffectTarget.mdl",u,"origin"))
	call ImitateBountyGain(GetOwningPlayer(u),u,g)
	if IsUnitType(u,UNIT_TYPE_HERO) then
		call AddHeroXP(u,xp,true)
	endif
endfunction

function ProvideRealRune takes unit u, integer id returns nothing
	local item it=CreateItem(GetRealRune(id),GetUnitX(u),GetUnitY(u))
	if UnitAddItem(u,it) and GetWidgetLife(it)<=0 then
	else
		call RemoveItem(it)
	endif
	set it=null
endfunction

function EPD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,h,26))
	local integer CL9=(LoadInteger(HY,h,98))
	local item Item=UnitItemInSlot(u,CL9)
	local integer EQD=(LoadInteger(HY,h,105))
	local item EJD
	local integer FO9
	local integer id
	local integer iid=GetIndex(Item)
	if Item!=null and Bottle_IsIndexRune(iid) and GetHandleId(Item)==EQD and IsDead(u)==false and IsDead(u)==false then
		set id=GetRuneFromBottle(iid)
		
		set FO9=GetItemSlot(u,Item)
		set tt_player1=GetItemPlayer(Item)
		call DestroyItem(Item)
		set tt_item1=AddItemByIdInSlot(u,Item_Real[Bottle3],FO9)
		call SetItemPlayer(tt_item1,tt_player1,false)
		call SetItemUserData(tt_item1,1)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call Func0404(u,id)
	endif
	set t=null
	set u=null
	set Item=null
	set EJD=null
	return false
endfunction

function ERD takes unit u,item EJD returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer CL9=GetItemSlot(u,EJD)
	call SaveInteger(HY,h,98,(CL9))
	call SaveInteger(HY,h,105,(GetHandleId(EJD)))
	call SaveUnitHandle(HY,h,26,(u))
	call TriggerRegisterTimerEvent(t,120,true)
	call TriggerAddCondition(t,Condition(function EPD))
	set t=null
endfunction

function GetBottleWithRuneId takes integer FN9 returns integer
	if FN9=='I006' then//I006 -> |c00ff0303Haste|r
		return BottleHaste
	elseif FN9=='I008' then//I008 -> |cff00ff00Regeneration|r
		return BottleRegen
	elseif FN9=='I00J' then//I00J -> |cff99ccffInvisibility|r
		return BottleInvis
	elseif FN9=='I00K' then//I00K -> |c000042ffDouble Damage|r
		return BottleDD
	elseif FN9=='I007' then//I007 -> |c00fffc01Illusion|r
		return BottleIllusion
	elseif FN9=='I0QA' then//I0QA -> |c00ffff01Bounty|r
		return BottleBounty
	endif
	return-1
endfunction

function DoubleDamage takes unit u returns nothing
	call UnitAddAbilityTimedExF(u,'A3FL',1,45,'B01P')
	call UnitMakeAbilityPermanent(u,true,'A3FK')
	call HideAbility('A3FL')
endfunction

function CW9 takes unit Hero,item Item returns nothing
	local item it
	local integer i
	local integer k
	local boolean borrowed=false
	if IsFakeRune(GetItemTypeId(Item)) then
		set it=FindItemOfType(Hero,Item_Real[Bottle0])
		if it==null then
			set it=FindItemOfType(Hero,Item_Real[Bottle1])
		endif
		if it==null then
			set it=FindItemOfType(Hero,Item_Real[Bottle2])
		endif
		if it==null then
			set it=FindItemOfType(Hero,Item_Real[Bottle3])
		endif
		if it==null then
			set it=FindItemOfType(Hero,Item_Mute[Bottle0])
		endif
		if it==null then
			set it=FindItemOfType(Hero,Item_Mute[Bottle1])
		endif
		if it==null then
			set it=FindItemOfType(Hero,Item_Mute[Bottle2])
		endif
		if it==null then
			set it=FindItemOfType(Hero,Item_Mute[Bottle3])
		endif
		if it!=null then
			if BottlePickupRunesOldfashion[GetPlayerId(GetOwningPlayer(Hero))]==false then
				set i=GetItemSlot(Hero,it)
				set k=GetBottleWithRuneId(GetRealRune(GetItemTypeId(Item)))
				call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",Hero,"overhead"))
				set tt_player1=GetItemPlayer(it)
				call DestroyItem(it)
				call DisableTrigger(t_manipulateitem)
				if GetOwningPlayer(Hero)==tt_player1 then
					set tt_item1=AddItemByIdInSlot(Hero,Item_Real[k],i)
				else
					set tt_item1=AddItemByIdInSlot(Hero,Item_Mute[k],i)
				endif
				call EnableTrigger(t_manipulateitem)
				call SetItemPlayer(tt_item1,tt_player1,false)
				call SetItemUserData(tt_item1,1)
				set it=UnitItemInSlot(Hero,i)
				call ERD(Hero,it)
				call CO9(Hero,GetItemTypeId(Item),true)
			else
				set i=GetItemSlot(Hero,it)
				set k=Bottle3
				call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",Hero,"overhead"))
				set tt_player1=GetItemPlayer(it)
				call DestroyItem(it)
				call DisableTrigger(t_manipulateitem)
				if GetOwningPlayer(Hero)==tt_player1 then
					set tt_item1=AddItemByIdInSlot(Hero,Item_Real[k],i)
				else
					set tt_item1=AddItemByIdInSlot(Hero,Item_Mute[k],i)
				endif
				call EnableTrigger(t_manipulateitem)
				call SetItemPlayer(tt_item1,tt_player1,false)
				call SetItemUserData(tt_item1,1)
				call ProvideRealRune(Hero,GetItemTypeId(Item))
			endif
		else
			call ProvideRealRune(Hero,GetItemTypeId(Item))
		endif
	elseif IsRune(GetItemTypeId(Item)) then
		call CO9(Hero,GetItemTypeId(Item),false)
	endif
	if GetItemTypeId(Item)=='I007' then//I007 -> |c00fffc01Illusion|r
		call CV9(Hero,Item)
	elseif GetItemTypeId(Item)=='I0QA' then//I0QA -> |c00ffff01Bounty|r
		call BountyRunePickup(Hero)
	elseif GetItemTypeId(Item)=='I00J' then//I00J -> |cff99ccffInvisibility|r
		if GetUnitAbilityLevel(Hero,'B09Y')>0 then//B09Y -> Phase
			call UnitRemoveAbility(Hero,'B09Y')//B09Y -> Phase
			call UnitRemoveAbility(Hero,'B01Q')//B01Q -> |c0000ff00Invisibility|r
			call DisableTrigger(GetTriggeringTrigger())
			call UnitAddItemById(Hero,'I00J')//I00J -> |cff99ccffInvisibility|r
			call EnableTrigger(GetTriggeringTrigger())
		endif
	elseif GetItemTypeId(Item)=='I008' then//I008 -> |cff00ff00Regeneration|r
		call CU9(Hero,Item)
	elseif GetItemTypeId(Item)=='I00K' then
		call DoubleDamage(Hero)
	endif
	//call RemoveDefaultString(Hero,.5)
	set it=null
endfunction

function CY9 takes item Item,unit Source,boolean CZ9 returns nothing
	local integer indexId=GetIndex(Item)
	local integer h=GetHandleId(Source)
	local string s=""
	if(indexId==Gem and FindItemOfTypeEx(Source,Gem,Item)==null)or(indexId==GemCourier and FindItemOfTypeEx(Source,GemCourier,Item)==null)then
		if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Source)) or IsObserver(GetLocalPlayer())then
			set s="Abilities\\Spells\\Human\\MagicSentry\\MagicSentryCaster.mdl"
		endif
		if CZ9 then
			if GetEmptyInventorySlots(Source)>0 or GetItemType(Item)==ITEM_TYPE_PERMANENT or GetItemType(Item)==ITEM_TYPE_CAMPAIGN then
				if GetUnitAbilityLevel(Source,'A26A')==0 and GetUnitAbilityLevel(Source,'A26B')==0 then//A26A -> Gem Visual Real, A26B -> Gem Visual Fake
					if s=="Abilities\\Spells\\Human\\MagicSentry\\MagicSentryCaster.mdl" then
						call UnitAddAbility2(Source,'A26A')//A26A -> Gem Visual Real
					else
						call UnitAddAbility2(Source,'A26B')//A26B -> Gem Visual Fake
					endif
				endif
			endif
		else
			if not(GetUnitAbilityLevel(Source,'A26A')==0 and GetUnitAbilityLevel(Source,'A26B')==0)then//A26A -> Gem Visual Real, A26B -> Gem Visual Fake
				call UnitRemoveAbility(Source,'A26B')//A26B -> Gem Visual Fake
				call UnitRemoveAbility(Source,'A26A')//A26A -> Gem Visual Real
				call RemoveSavedHandle(HY,h,670)
			endif
		endif
	endif
endfunction

function SendInventoryInfoDelayed takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer i=0
	local integer k=UnitInventorySize(u)
	local item it
	local integer pid=GetPlayerId(GetOwningPlayer(u))
	call RemoveSavedHandle(HY,GetHandleId(u),'INVR')
	call DestroyTimer(t)
	loop
		set it=UnitItemInSlot(u,i)
		if it!=null then
			call Traffic_RegisterData("LoD_INV_"+I2S(pid),GetItemTypeId(it))
		endif
		set i=i+1
		exitwhen i>k
	endloop
	set it=null
	set t=null
	set u=null
endfunction

function SendInventoryInfo takes unit u returns nothing
	local timer t
	local integer h
	local integer hu=GetHandleId(u)
	if advancedTracking==false then
		return
	endif
	if HaveSavedHandle(HY,hu,'INVR')==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveTimerHandle(HY,hu,'INVR',t)
		call TimerStart(t,0.1,false,function SendInventoryInfoDelayed)
		call SaveUnitHandle(HY,h,0,u)
		set t=null
	else
		call TimerStart(LoadTimerHandle(HY,hu,'INVR'),0.1,false,function SendInventoryInfoDelayed)
	endif
endfunction

function CA9 takes nothing returns boolean
	local unit Hero=GetTriggerUnit()
	local item Item=GetManipulatedItem()
	local integer id=GetItemTypeId(Item)
	if Item==null or IsUnitIllusion(Hero) or IsUnitType(Hero,UNIT_TYPE_HERO)==false or GetItemTypeId(Item)=='I02M' then//
		set Hero=null
		set Item=null
		return false
	endif
	if GetIndex(Item)>0 then
		if(GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM and GetItemType(Item)!=ITEM_TYPE_PURCHASABLE)or GetTriggerEventId()==EVENT_PLAYER_UNIT_PAWN_ITEM then
			call CY9(Item,Hero,false)
			call Traffic_RegisterData("DRI_"+I2S(GetPlayerId(GetOwningPlayer(Hero))),Item_Real[FindRealIndexId(GetIndex(Item))])
			call SendInventoryInfo(Hero)
		elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
			call CY9(Item,Hero,true)
			call Traffic_RegisterData("PUI_"+I2S(GetPlayerId(GetOwningPlayer(Hero))),Item_Real[FindRealIndexId(GetIndex(Item))])
			call SendInventoryInfo(Hero)
		endif
	//else
		//call echo("prevented rune")
	endif
//	call RemoveDefaultString(Hero,.1)
	set Hero=null
	set Item=null
	return false
endfunction

function DICCI takes player p, integer dataint, integer id, real x, real y returns nothing
	local item it=CreateItem(Item_Dummy[id],x,y)
	call SetItemPlayer(it,p,false)
	call SetItemUserData(it,dataint)
	set it=null
endfunction

function C59 takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local item it
	local integer i=0
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local integer iid
	local player p
	call DisableTrigger(t_manipulateitem)
	loop
		exitwhen i>5
		set it=UnitItemInSlot(u,i)
		set iid=GetIndex(it)
		set p=GetItemPlayer(it)
		if iid==Perseverance then
			call RemoveItem(it)
			call DICCI(p,1,RingOfHealth,x,y)
			call DICCI(p,1,VoidStone,x,y)
		elseif iid==RingOfBasilius or iid==RingOfBasiliusHero then
			call RemoveItem(it)
			call DICCI(p,1,RingOfProtection,x,y)
			call DICCI(p,1,SobiMask,x,y)
		elseif iid==ShivasGuard or iid==ShivasGuardCourier then
			call RemoveItem(it)
			call DICCI(p,1,PlateMail,x,y)
			call DICCI(p,1,MysticStaff,x,y)
			call DICCI(p,1,RecipeShivasGuard,x,y)
		elseif (iid)==Mjollnir then
			call RemoveItem(it)
			call DICCI(p,1,Hyperstone,x,y)
			call DICCI(p,1,Maelstrom,x,y)
			call DICCI(p,1,RecipeMjollnir,x,y)
		elseif iid==ArcaneBoots then
			call RemoveItem(it)
			call DICCI(p,1,BootsOfSpeed,x,y)
			call DICCI(p,1,EnergyBooster,x,y)
		elseif iid==HelmOfTheDominator or iid==HelmOfTheDominatorCourier then
			call RemoveItem(it)
			call DICCI(p,1,HelmOfIronWill,x,y)
			call DICCI(p,1,MaskOfDeath,x,y)
		elseif iid==MantaStyle or iid==MantaStyleRanged then
			call RemoveItem(it)
			call DICCI(p,1,Yasha,x,y)
			call DICCI(p,1,UltimateOrb,x,y)
			call DICCI(p,1,RecipeMantaStyle,x,y)
		elseif iid==EtherealBlade then
			call RemoveItem(it)
			call DICCI(p,1,Eaglehorn,x,y)
			call DICCI(p,1,GhostScepter,x,y)
		elseif iid==SangeAndYasha then
			call RemoveItem(it)
			call DICCI(p,1,Sange,x,y)
			call DICCI(p,1,Yasha,x,y)
		elseif iid==RingOfAquila or iid==RingOfAquilaHero then
			call RemoveItem(it)
			call DICCI(p,1,WraithBand,x,y)
			call DICCI(p,1,RingOfBasilius,x,y)
		elseif iid==AbyssalBlade then 
			call RemoveItem(it)
			call DICCI(p,1,CraniumBasher,x,y)
			call DICCI(p,1,SacredRelic,x,y)
		elseif iid==SolarCrest then 
			call RemoveItem(it)
			call DICCI(p,1,MedallionOfCourage,x,y)
			call DICCI(p,1,TalismanOfEvasion,x,y)
		elseif iid==GlimmerCape then
			call RemoveItem(it)
			call DICCI(p,1,PlaneswalkerCloak,x,y)
			call DICCI(p,1,ShadowAmulet,x,y)
		elseif iid==LotusOrb then
			call RemoveItem(it)
			call DICCI(p,1,RecipeLotusOrb,x,y)
			call DICCI(p,1,PlateMail,x,y)
			call DICCI(p,1,Perseverance,x,y)
		elseif iid==HeavensHalberd then
			call RemoveItem(it)
			call DICCI(p,1,Sange,x,y)
			call DICCI(p,1,TalismanOfEvasion,x,y)
		elseif iid==MoonShard then
			call RemoveItem(it)
			call DICCI(p,1,Hyperstone,x,y)
			call DICCI(p,1,Hyperstone,x,y)
		elseif iid==PowerTreadsAgility or iid==PowerTreadsIntelligence or iid==PowerTreadsStrength then
			call RemoveItem(it)
			call DICCI(p,1,BootsOfSpeed,x,y)
			call DICCI(p,1,GlovesOfHaste,x,y)
			if iid==PowerTreadsAgility then
				call DICCI(p,1,BootsOfElvenskin,x,y)
			elseif iid==PowerTreadsStrength then
				call DICCI(p,1,BeltOfStrength,x,y)
			else
				call DICCI(p,1,RobeOfMagi,x,y)
			endif
			
		endif
		set i=i+1
	endloop
	call EnableTrigger(t_manipulateitem)
	set u=null
	set it=null
endfunction

function Spell_Disassemble takes nothing returns boolean
	if GetSpellAbilityId()=='A0K5' or GetSpellAbilityId()=='A1RF' then//A0K5 -> Disassemble, A1RF -> Disassemble
		call C59()
	endif
	return false
endfunction

function L49 takes integer indexId returns boolean
	return indexId!=DivineRapier and indexId!=bloodstone and indexId!=Gem and indexId!=Aegis
endfunction

function L79 takes nothing returns nothing
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
		call SetItemPawnable(GetManipulatedItem(),false)
	else
		call SetItemPawnable(GetManipulatedItem(),true)
	endif
endfunction

function CourierCantSell takes nothing returns boolean
	if GetItemType(GetManipulatedItem())==ITEM_TYPE_PERMANENT and L49(F49(GetManipulatedItem()))and IsCourier(GetTriggerUnit())then
		call L79()
	endif
	return false
endfunction

function L99 takes nothing returns nothing
	local integer x=1
	local player p
	loop
		exitwhen x>16
		if FindItemOfType(udg_Hero[x],Item_Real[bloodstone])!=null then
			//call RemoveUnit(BloodstoneHeroes[GetPlayerId(GetOwningPlayer(udg_Hero[x]))])
		endif
		set x=x+1
	endloop
	set p=null
endfunction

function LE9 takes nothing returns boolean
	return(IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) and AliveNonBuildOrMarker(GetFilterUnit()))!=null//
endfunction

function LG9 takes unit u returns nothing
	local group g=GetAvailableGroup()
	local unit u2
	local real r=500+30*GetItemCharges(FindItemOfType(u,Item_Real[bloodstone]))
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1700,Condition(function LE9))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call SetWidgetLife(u2,GetWidgetLife(u2)+r)
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\BloodstoneHealTarget.mdx",u2,"origin"))
		call GroupRemoveUnit(g,u2)
	endloop
	call KillGroup(g)
	set g=null
	set u2=null
endfunction

function BloodStone_Bloodpact takes unit Hero returns nothing
	//set BloodstoneHeroes[GetPlayerId(GetOwningPlayer(Hero))]=CreateUnit(GetOwningPlayer(Hero),'H00M',GetUnitX(Hero),GetUnitY(Hero),GetUnitFacing(Hero))//H00M -> Bloodrune
	call LG9(Hero)
endfunction

function BloodStoneWrap takes nothing returns nothing
	if FindItemOfType(GetTriggerUnit(),Item_Real[bloodstone])!=null then
		call BloodStone_Bloodpact(GetTriggerUnit())
	endif
endfunction

function LI9 takes unit u returns nothing
	local integer c=GetItemCharges(FindItemOfType(u,Item_Real[bloodstone]))
	if c>0 then
		call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+c)
	endif
endfunction

function BloodstoneMP takes nothing returns boolean
	local integer i=1
	local unit Hero
	local integer id
	if TotalCount_Bloodstone>0 then
		loop
			exitwhen i>5
			set id=GetPlayerId(Sentinels[i])
			set Hero=udg_Hero[id]
			if HasItem_Bloodstone[id]>0 and Hero!=null  and IsDead(Hero)==false then
				call LI9(Hero)
			endif
			set id=GetPlayerId(Scourges[i])
			set Hero=udg_Hero[id]
			if HasItem_Bloodstone[id]>0 and Hero!=null  and IsDead(Hero)==false then
				call LI9(Hero)
			endif
			set i=i+1
		endloop
	endif
	set Hero=null
	return false
endfunction

function ObsWardAttacked takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer c=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
		if GetUnitTypeId(GetTriggerUnit())=='oeye' or GetUnitTypeId(GetTriggerUnit())=='o004' then//oeye -> Sentry Ward, o004 -> Observer Ward
			call UnitAddAbility2(GetAttacker(),'A3AW')
			call UnitMakeAbilityPermanent(GetAttacker(),true,'A3AV')
		elseif GetUnitAbilityLevel(GetAttacker(),'A3AV')>0 then
			call UnitRemoveAbility(GetAttacker(),'A3AW')
		endif
	else
		call SaveInteger(HY,h,0,IMaxIF(c-1,0))
		
		if LoadInteger(HY,h,0)<1 then
			call DisableTrigger(t)
		endif
	endif
	set t=null
	return false
endfunction

function Func0686 takes unit loc_unit01,unit loc_unit02 returns nothing
	local string s=""
	local string s2="items\\wards\\"
	local string s3="war3mapImported\\"
	
	if GetUnitTypeId(loc_unit01)=='oeye'then//oeye -> Sentry Ward
		set s2=s2+"SentryWard.mdx"
		set s3=s3+"EnemySentryWardMark.mdx"
	else
		set s2=s2+"ObserverWard.mdx"
		set s3=s3+"EnemyObserverWardMark.mdx"
	endif
	if IsPlayerEnemy(GetLocalPlayer(),GetOwningPlayer(loc_unit02))and IsObserver(GetLocalPlayer())==false then
		set s=s3
		set s2=""
	endif
	call AddSpecialEffectTarget(s,loc_unit01,"origin")
	call AddSpecialEffectTarget(s2,loc_unit01,"origin")
endfunction

function Autoselection takes nothing returns nothing
	local unit u=GetSummonedUnit()
	local unit caster=GetSummoningUnit()
	local integer uid=GetUnitTypeId(u)
	local integer i
//	if uid=='o004' or uid=='oeye' then//o004 -> Observer Ward, oeye -> Sentry Ward
//		call Func0686(u,caster)
//		if uid=='oeye' then//oeye -> Sentry Ward
//			call TimedReveal(GetOwningPlayer(u),12,GetUnitX(u),GetUnitY(u),150)
//		endif
//	endif
//	if uid=='u012'then//u012 -> Scarab
//		call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_EFFECT)
//		if GetUnitAbilityLevel(caster,'A0A8')>0 then
//			call UnitAddAbility2(u,'A1HW')
//		endif
//	endif
	if uid=='osp4' or uid=='o008' or uid=='o009' or uid=='o01C' or uid=='o01D' or uid=='o01E' then//osp4 -> Serpent Ward, o008 -> Serpent Ward, o009 -> Serpent Ward, o01C -> Serpent Ward, o01D -> Serpent Ward, o01E -> Serpent Ward
		call SelectSummons(u)
	elseif uid=='o000' or uid=='o001' or uid=='o00A' or uid=='o00X' then//o000 -> Death Ward, o001 -> Death Ward, o00A -> Death Ward, o00X -> Death Ward
		call SelectSummons(u)
	endif
	set u=null
	set caster=null
endfunction

function LT9 takes nothing returns nothing
	local unit u=GetEnumUnit()
	local integer i=0
	local player p=GetOwningPlayer(GetTriggerUnit())
	local item Item
	local integer id=GetPlayerId(p)
	loop
		exitwhen i>5
		set Item=UnitItemInSlot(u,i)
		if Item!=null and GetItemPlayer(Item)==p then
			call UnitRemoveItem(u,Item)
			call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
		endif
		set i=i+1
	endloop
	set u=null
	set p=null
	set Item=null
endfunction

function LU9 takes nothing returns nothing
	local item Item=GetEnumItem()
	local unit u=VX7
	local player p=GetOwningPlayer(u)
	local integer id=GetPlayerId(p)
	if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==p then
		call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
		call UnitAddItem(CirclesOfPower[id],Item)
	endif
	set Item=null
	set u=null
	set p=null
endfunction

function LV9 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,h,53))
	set VX7=u
	if IsSentinel(GetOwningPlayer(VX7))then
		call EnumItemsInRect(FountainRectFrogSent,Condition(function ReturnTrue),function LU9)
	else
		call EnumItemsInRect(FountainRectFrogScourge,Condition(function ReturnTrue),function LU9)
	endif
	if GetTriggerEvalCount(t)==2 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set u=null
	return false
endfunction

function LW9 takes nothing returns boolean
	return IsCourier(GetFilterUnit())
endfunction

function LX9 takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer i=0
	local group g=GetAvailableGroup()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1300,Condition(function LW9))
	call ForGroup(g,function LT9)
	call KillGroup(g)
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddCondition(t,Condition(function LV9))
	call SaveUnitHandle(HY,h,53,(u))
	set u=null
	set g=null
	set t=null
endfunction

function LZ9 takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer i=0
	local item Item
	local integer id=GetPlayerId(GetOwningPlayer(u))
	local region r=CreateRegion()
	if IsSentinel(GetOwningPlayer(u))then
		call RegionAddRect(r,FountainRectFrogSent)
	else
		call RegionAddRect(r,FountainRectFrogScourge)
	endif
	loop
		exitwhen i>5
		set Item=UnitItemInSlot(u,i)
		if Bottle_IsIndexRune(GetIndex(Item))==false and GetIndex(Item)!=Aegis then
			call UnitRemoveItemFromSlot(u,i)
			if(GetUnitTypeId(u)=='ncop' or IsUnitInRegion(r,u))and IsPlayerAlly(GetItemPlayer(Item),GetOwningPlayer(u)) then//ncop -> Circle of Power
				set id=GetPlayerId(GetItemPlayer(Item))
				call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
			endif
		endif
		set i=i+1
	endloop
	call RemoveRegion(r)
	set u=null
	set Item=null
	set r=null
endfunction

function LB9 takes unit Source returns boolean
	local integer h=GetHandleId(Source)
	local integer i=0
	local real Time=(TimerGetElapsed(GlobalTimer))
	local real LC9=13
	if(LoadReal(HY,h,730))<Time-LC9 then
		return false
	endif
	return true
endfunction

function TranquilBoots_Attackd takes unit Source returns nothing
	local integer h=GetHandleId(Source)
	call SaveReal(HY,h,730,TimerGetElapsed(GlobalTimer))
endfunction

function CheckTranquils takes unit Hero returns nothing
	local integer i=0
	local item L19
	local integer indexId
	local boolean L09=false
	if LB9(Hero)then
		set L09=true
	endif
	loop
		exitwhen i>5
		set L19=UnitItemInSlot(Hero,i)
		set indexId=F49(L19)
		if indexId==TranquilBoots and L09 then
			call DisableTrigger(t_manipulateitem)
			set tt_player1=GetItemPlayer(L19)
			call RemoveItem(L19)
			set tt_item1=AddItemByIdInSlot(Hero,Item_Real[TranquilBootsBroken],i)
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
			call EnableTrigger(t_manipulateitem)
		endif
		if indexId==TranquilBootsBroken and L09==false then
			call DisableTrigger(t_manipulateitem)
			set tt_player1=GetItemPlayer(L19)
			call RemoveItem(L19)
			set tt_item1=AddItemByIdInSlot(Hero,Item_Real[TranquilBoots],i)
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
			call EnableTrigger(t_manipulateitem)
		endif
		set i=i+1
	endloop
	set Hero=null
	set L19=null
endfunction

function CheckHearts takes unit Hero returns nothing
	local integer i=0
	local item L29
	local integer indexId
	local boolean D4D=false
	local real time=4
	if IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER)==false then
		set time=6
	endif
	if VY7[GetPlayerId(GetOwningPlayer(Hero))]+time>(TimerGetElapsed(GlobalTimer))then
		set D4D=true
	endif
	loop
		exitwhen i>5
		set L29=UnitItemInSlot(Hero,i)
		set indexId=F49(L29)
		if indexId==HeartOfTarrasque and D4D then
			call DisableTrigger(t_manipulateitem)
			set tt_player1=GetItemPlayer(L29)
			call RemoveItem(L29)
			set tt_item1=AddItemByIdInSlot(Hero,Item_Real[DisabledHeartOfTarrasque],i)
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
			call EnableTrigger(t_manipulateitem)
		endif
		if indexId==DisabledHeartOfTarrasque and D4D==false then
			call DisableTrigger(t_manipulateitem)
			set tt_player1=GetItemPlayer(L29)
			call RemoveItem(L29)
			set tt_item1=AddItemByIdInSlot(Hero,Item_Real[HeartOfTarrasque],i)
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
			call EnableTrigger(t_manipulateitem)
		endif
		set i=i+1
	endloop
	set Hero=null
	set L29=null
endfunction

function D7D takes nothing returns nothing
	local string teststring=StringCase("D7D",false)
	if IsRealDamage and GetEventDamage()>2 and (IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource()))or GetUnitTypeId(GetEventDamageSource())=='n00L' or GetEventDamageSource()==ScourgeFountain or GetEventDamageSource()==SentFountain) then//n00L -> Roshan
		set teststring=StringCase(GetUnitName(GetTriggerUnit())+" dmgby "+GetUnitName(GetEventDamageSource()),false)
		if GetEventDamageSource()!=GetTriggerUnit() or GetUnitAbilityLevel(GetTriggerUnit(),'B028')>0  then//B028 -> Poison Nova
			if GetEventDamage()>5 then
				set VY7[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=(TimerGetElapsed(GlobalTimer))
			endif
			if GetEventDamage()>=10 then
				set LastTimeDamaged_ForDagger[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=TimerGetElapsed(GlobalTimer)
			endif
		else
			if GetEventDamage()>=5 then
				set LastTimeDamaged_ForDagger[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=TimerGetElapsed(GlobalTimer)
			endif
		endif
	endif
endfunction

function DummyDagger takes unit u, item it, integer slot returns nothing
	local integer i
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
	set tt_player1=GetItemPlayer(it)
	call RemoveItem(it)
	call UnitAddAbility(d,'AInv')//AInv -> Inventory
	set it=UnitAddItemById(d,Item_Real[DisabledKelensDagger])
	call UnitUseItem(d,it)
	call AddItemInSlot(u,it,slot)
	call SetItemPlayer(it,tt_player1,false)
	call SetItemUserData(it,1)
	set d=null
endfunction

function CheckDaggers takes unit Hero returns nothing
	local integer i=0
	local item it
	local integer indexId
	local boolean b=false
	local real diff=LastTimeDamaged_ForDagger[GetPlayerId(GetOwningPlayer(Hero))]+3 - TimerGetElapsed(GlobalTimer)
	if diff>=0 then
		set b=true
	endif
	loop
		set it=UnitItemInSlot(Hero,i)
		set indexId=F49(it)
		if (indexId==KelensDagger and b) or (indexId==DisabledKelensDagger and diff >= 2.9) then
			call DisableTrigger(t_manipulateitem)
			call DummyDagger(Hero,it,i)
			call EnableTrigger(t_manipulateitem)
		endif
		if indexId==DisabledKelensDagger and b==false then
			call DisableTrigger(t_manipulateitem)
			set tt_player1=GetItemPlayer(it)
			call RemoveItem(it)
			set tt_item1=AddItemByIdInSlot(Hero,Item_Real[KelensDagger],i)
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
			call EnableTrigger(t_manipulateitem)
		endif
		set i=i+1
		exitwhen i>5
	endloop
	set Hero=null
	set it=null
endfunction

function CheckToggleItems takes nothing returns boolean
	local integer i=1
	local unit Hero
	local integer id
	local boolean daggers=TotalCount_Dagger>0
	local boolean hearts=TotalCount_Heart>0
	local integer c=GetTriggerEvalCount(GetTriggeringTrigger())
	set zOffsetDebug=0
	if not(TotalCount_Dagger>0 or TotalCount_Heart>0 or TotalCount_Tranquils>0) then
		return false
	endif
	loop
		exitwhen i>5
		set id=GetPlayerId(Sentinels[i])
		set Hero=udg_Hero[id]
		if Hero!=null and IsDead(Hero)==false then
			if daggers and HasItem_Dagger[id]>0 then
				call CheckDaggers(Hero)
			endif
			if ModuloInteger(c,3)==1 then
				if HasItem_TranquilBoots[id]>0 then
					call CheckTranquils(Hero)
				endif
				if hearts and HasItem_Heart[id]>0 then
					call CheckHearts(Hero)
				endif
			endif
		endif
		set id=GetPlayerId(Scourges[i])
		set Hero=udg_Hero[id]
		if Hero!=null and IsDead(Hero)==false then
			if daggers and HasItem_Dagger[id]>0 then
				call CheckDaggers(Hero)
			endif
			if ModuloInteger(c,3)==1 then
				if HasItem_TranquilBoots[id]>0 then
					call CheckTranquils(Hero)
				endif
				if hearts and HasItem_Heart[id]>0 then
					call CheckHearts(Hero)
				endif
			endif
		endif
		set i=i+1
	endloop
	set Hero=null
	return false
endfunction

function DJD takes unit DKD returns boolean
	return false
endfunction

function DND takes nothing returns nothing
	local unit DOD=GetAttacker()
	local integer DPD=UnitInventorySize(DOD)
	local integer x=0
	local item i
	loop
		exitwhen x>DPD
		set i=UnitItemInSlot(DOD,x)
		if F49(i)==javelin and PRD_Get(DOD,'JAVL',20) and GenericCondition_IsDotAInvis(DOD)==false then
			if IsSpiritBear(DOD)then
				if DJD(DOD)==false then
					if GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 then//
						call DamageTarget(DOD,GetTriggerUnit(),2,40)
					endif
				endif
			else
				if GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 then//
					call DamageTarget(DOD,GetTriggerUnit(),2,40)
				endif
			endif
		endif
		set x=x+1
	endloop
	set i=null
	set DOD=null
endfunction

function SangeApplyGreaterMaim takes unit u returns nothing
	call UnitAddAbilityTimedExF(u,'A263',1,5,'B08N')
endfunction

function DTD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if GetEventDamageSource()==Source and GetEventDamage()>0 then
			if IsRealDamage then
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
				call SangeApplyGreaterMaim(Target)
			endif
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function DUD takes nothing returns nothing
	local unit Source=GetAttacker()
	local unit Target=GetTriggerUnit()
	local trigger t
	local integer h
	if((LoadInteger(HY,(GetHandleId((Source))),(4309)))!=1) then
		call AddTimedKeyToUnit(Source,4309,.2)
		if PRD_Get(Source,'MAIM'+1,16) then
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
			call TriggerRegisterTimerEvent(t,2.5,false)
			call TriggerAddCondition(t,Condition(function DTD))
			call SaveUnitHandle(HY,h,2,(Source))
			call SaveUnitHandle(HY,h,17,(Target))
		endif
	endif
	set Source=null
	set Target=null
	set t=null
endfunction

function DVD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real DRD=(LoadReal(HY,(GetHandleId(Source)),693))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or DRD<(TimerGetElapsed(GlobalTimer))then
		call UnitRemoveAbility(Source,'A264')//A264 -> Sange Slow Container
		call UnitRemoveAbility(Source,'B02I')//B02I -> Maimed
//		call UnitRemoveAbility(Source,'A26C')//A26C -> Sange Visual Effect
		call SaveReal(HY,(GetHandleId(Source)),693,(0*1.))
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function SangeApplyMaim takes unit u returns nothing
	call UnitAddAbilityTimedExF(u,'A264',1,4,'B02I')
endfunction

function DXD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if GetEventDamageSource()==Source and GetEventDamage()>0 then
			if IsRealDamage then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call SangeApplyMaim(Target)
			endif
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function DYD takes nothing returns nothing
	local unit Source=GetAttacker()
	local unit Target=GetTriggerUnit()
	local trigger t
	local integer h
	if((LoadInteger(HY,(GetHandleId((Source))),(4309)))==1)==false then
		call AddTimedKeyToUnit(Source,4309,.2)
		if PRD_Get(Source,'MAIM',15) then
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
			call TriggerRegisterTimerEvent(t,2.5,false)
			call TriggerAddCondition(t,Condition(function DXD))
			call SaveUnitHandle(HY,h,2,(Source))
			call SaveUnitHandle(HY,h,17,(Target))
		endif
	endif
	set Source=null
	set Target=null
	set t=null
endfunction

function CraniumBasherWrapper takes nothing returns nothing
	local unit u=GetAttacker()
	local integer chance=25
	local integer id=GetPlayerId(GetOwningPlayer(GetAttacker()))
	local integer h=GetHandleId(u)
	local real time=(TimerGetElapsed(GlobalTimer))
	local real DBD=(LoadReal(HY,h,101))
	local boolean DCD=(LoadBoolean(HY,h,99))
	local boolean D3D=(LoadBoolean(HY,h,100))
	local boolean D6D=time<DBD
	local boolean fire=false
	if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false then
		set chance=10
	endif
	if PRD_Get(u,'BASH',chance) then
		set fire=true
	endif
	//P263==A0JJ; P275==A081
	if GetUnitAbilityLevel(u,'A0WW')>0 or GetUnitAbilityLevel(u,'A0JJ')>0 or GetUnitAbilityLevel(u,'A081')>0 or GetUnitAbilityLevel(u,'A0G5')>0 or GetUnitAbilityLevel(u,'A09E')>0 then//A0G5 -> Greater Bash, QP1X -> Greater Bash, A09E -> Bash
		call UnitRemoveAbility(u,'A174')//A174 -> Cranium Basher Container
		set u=null
		return
	endif
	if DCD and D6D==false and D3D==false then
		call SaveReal(HY,h,101,((time+2.3)*1.))
		if fire==false then
			call SaveBoolean(HY,h,100,(true))
		endif
	elseif D6D or D3D then
		call UnitRemoveAbility(u,'A174')//A174 -> Cranium Basher Container
		call SaveBoolean(HY,h,99,(false))
		call SaveBoolean(HY,h,100,(false))
	endif
	if fire then
		call UnitAddAbility2(u,'A174')//A174 -> Cranium Basher Container
		call UnitMakeAbilityPermanent(u,true,'A175')//A175 -> Cranium Basher
		call SaveBoolean(HY,h,99,(true))
	endif
	set u=null
endfunction

function D1D takes unit u returns unit
	if IsUnitType(u,UNIT_TYPE_HERO)or GetUnitAbilityLevel(u,'A04R')==0 then//
		return u
	else
		return udg_Hero[GetPlayerId(GetOwningPlayer(u))]
	endif
endfunction

function NecronomiconKilled takes unit killer, unit victim returns nothing
	local integer id=GetUnitTypeId(victim)
	local integer i
	local real dmg=0
	local group g
	local unit u
	if (id=='n00J' or id=='n00A' or id=='n006') then
		set i=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(victim))],'A0A8')
		if i>0 or (IsUnitType(killer,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(victim,GetOwningPlayer(killer))) then//n00J -> Necronomicon Warrior 1, n00A -> Necronomicon Warrior 2, n006 -> Necronomicon Warrior 3
			if id=='n00J' then
				set dmg=400
			elseif id=='n00A' then
				set dmg=500
			elseif id=='n006' then
				set dmg=600
			endif
			if i>0 then
				set g=GetAvailableGroup()
				set tt_unit1=victim
				call GroupEnumUnitsInRange(g,GetUnitX(victim),GetUnitY(victim),300,Condition(function DefaultEnemyFilterWithAncients))
				if IsUnitType(killer,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(victim,GetOwningPlayer(killer)) then
					call GroupAddUnit(g,killer)
				endif
				loop
					set u=FirstOfGroup(g)
					exitwhen u==null
					call DamageTarget(victim,u,3,dmg)
					call CR8("CLPB",victim,u,1,1,1,1,.5)
					call GroupRemoveUnit(g,u)
				endloop
				call KillGroup(g)
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl",GetUnitX(victim),GetUnitY(victim)))
			else
				call DamageTarget(victim,D1D(killer),3,dmg)
				call CR8("CLPB",victim,D1D(killer),1,1,1,1,.5)
			endif
		endif
	endif
endfunction

function D5D takes nothing returns boolean
	local unit Hero=GetTriggerUnit()
	local integer Level=1
	local integer id='EUL1'
	if GetItemTypeId(GetManipulatedItem())==Item_Real[OctarineCore] then
		if FindItemOfTypeEx(Hero,Item_Real[OctarineCore],GetManipulatedItem())==null then
			set tt_unit1=Hero
			call ExecuteFunc("OctarineCoreDrop")
		endif
		set Hero=null
		return false
	endif
	if FindItemOfType(Hero,Item_Real[TranquilBootsBroken])!=null then//60
		set Level=4//100
	endif
	if FindItemOfTypeEx(Hero,Item_Real[BootsOfSpeed],GetManipulatedItem())!=null then//50
		set Level=2//90
	endif
	if FindItemOfTypeEx(Hero,Item_Real[PhaseBoots],GetManipulatedItem())!=null then//55
		set Level=2//90
	endif
	if FindItemOfTypeEx(Hero,Item_Real[PowerTreadsAgility],GetManipulatedItem())!=null or FindItemOfTypeEx(Hero,Item_Real[PowerTreadsStrength],GetManipulatedItem())!=null or FindItemOfTypeEx(Hero,Item_Real[PowerTreadsIntelligence],GetManipulatedItem())!=null then
		set Level=2//90
	endif
	if FindItemOfTypeEx(Hero,Item_Real[ArcaneBoots],GetManipulatedItem())!=null then//60
		set Level=3//95
	endif
	if FindItemOfTypeEx(Hero,Item_Real[TranquilBoots],GetManipulatedItem())!=null then//75
		set id='EUL2'
		set Level=1//125
	endif
	if FindItemOfTypeEx(Hero,Item_Real[bootsOfTravel],GetManipulatedItem())!=null then//100
		set id='EUL2'
		set Level=2//140
	endif
	if FindItemOfTypeEx(Hero,Item_Real[Eul],GetManipulatedItem())!=null then
		call UnitAddAbility2(Hero,id)
		call SetUnitAbilityLevel(Hero,id,Level)
	else
		call UnitRemoveAbility(Hero,'EUL1')
		call UnitRemoveAbility(Hero,'EUL2')
	endif
	set Hero=null
	return false
endfunction

function D2D takes nothing returns boolean
	local unit Hero=GetTriggerUnit()
	local integer Level=1
	local integer id='EUL1'
	if FindItemOfType(Hero,Item_Real[TranquilBootsBroken])!=null then//60+40
		set Level=4//100
	endif
	if FindItemOfType(Hero,Item_Real[BootsOfSpeed])!=null then//50+40
		set Level=2//90
	endif
	if FindItemOfType(Hero,Item_Real[PhaseBoots])!=null then//50+40
		set Level=2//90
	endif
	if FindItemOfType(Hero,Item_Real[PowerTreadsAgility])!=null or FindItemOfType(Hero,Item_Real[PowerTreadsStrength])!=null or FindItemOfType(Hero,Item_Real[PowerTreadsIntelligence])!=null then
		set Level=2//90
	endif
	if FindItemOfType(Hero,Item_Real[ArcaneBoots])!=null then//55+40
		set Level=3//95
	endif
	if FindItemOfType(Hero,Item_Real[TranquilBoots])!=null then//90+40
		set Level=1//130
		set id='EUL2'
	endif
	if FindItemOfType(Hero,Item_Real[bootsOfTravel])!=null then//100+40
		set Level=2//140
		set id='EUL2'
	endif
	if FindItemOfType(Hero,Item_Real[Eul])!=null then
		call UnitAddAbility2(Hero,id)
		call SetUnitAbilityLevel(Hero,id,Level)
	endif
	set Hero=null
	return false
endfunction


function Armlet_StrBonus takes unit u,integer d returns nothing
	local integer array b
	local integer a=d
	local integer c=1
	local integer i=0
	local integer z
	local real hp
	if d==0 then
		set hp=GetUnitState(u,UNIT_STATE_MAX_LIFE)-GetWidgetLife(u)
	endif
	if d<1 then
		call UnitRemoveAbility(u,ArmletStrBonus[0])
		call UnitRemoveAbility(u,ArmletStrBonus[1])
		call UnitRemoveAbility(u,ArmletStrBonus[2])
		call UnitRemoveAbility(u,ArmletStrBonus[3])
		call UnitRemoveAbility(u,ArmletStrBonus[4])
		call SetWidgetLife(u,RMaxIF(GetUnitState(u,UNIT_STATE_MAX_LIFE)-hp,1))
		return
	endif
	loop
		exitwhen c==0
		set c=a/ 2
		set b[i]=a-c*2
		set a=c
		set i=i+1
	endloop
	set z=4
	set i=0
	loop
		exitwhen i>z
		if b[i]==1 then
			call UnitAddAbility2(u,ArmletStrBonus[i])
		else
			call UnitRemoveAbility(u,ArmletStrBonus[i])
		endif
		set i=i+1
	endloop
endfunction

function Armlet_TogglingOn takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(MHT,h,0)
	local real KXD=LoadReal(MHT,h,0)
	if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		if FindItemOfType(u,Item_Real[ArmletOn])==null then
			//call Armlet_StrBonus(u,0)
			call SetHeroStr(u,IMaxIF(GetHeroStr(u,false)-LoadInteger(HeroStats,GetHandleId(u),'ARML'),1),true)
			call SaveInteger(HeroStats,GetHandleId(u),'ARML',0)
			//call SetUnitState(u,UNIT_STATE_LIFE,RMaxIF(GetUnitState(u,UNIT_STATE_MAX_LIFE)-KXD,1))
			if IsTriggerEnabled(t) then
				call FlushChildHashtable(MHT,h)
				call CleanTrigger(t)
			endif
			set t=null
			set u=null
			return
		endif
		if GetTriggerEvalCount(t)<=25 then
			call SetHeroStr(u,GetHeroStr(u,false)+1,true)
			call SaveInteger(HeroStats,GetHandleId(u),'ARML',GetTriggerEvalCount(t))
			//call Armlet_StrBonus(u,GetTriggerEvalCount(t))
			if IsDead(u)==false then
				//call SetWidgetLife(u,RMaxIF(GetUnitState(u,UNIT_STATE_MAX_LIFE)-KXD,1))
			endif
		endif
	else
		call SetHeroStr(u,IMaxIF(GetHeroStr(u,false)-LoadInteger(HeroStats,GetHandleId(u),'ARML'),1),true)
		call SaveInteger(HeroStats,GetHandleId(u),'ARML',0)
		//call SetUnitState(u,UNIT_STATE_LIFE,RMaxIF(GetUnitState(u,UNIT_STATE_MAX_LIFE)-KXD,1))
		if IsTriggerEnabled(t) then
			call FlushChildHashtable(MHT,h)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set u=null
endfunction



function E4D takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t
	local real KXD
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM then
		
		if F49(GetManipulatedItem())==ArmletOff or F49(GetManipulatedItem())==ArmletOffCourier then
			call UnitRemoveAbility(Hero,'A44Q')
			if F49(GetManipulatedItem())==ArmletOff then
				call Armlet_StrBonus(Hero,0)
			endif
		endif
		if F49(GetManipulatedItem())==Satanic then
			call UnitRemoveAbility(Hero,'A1BW')//A1BW -> Item Damage Bonus (+20)
		endif
		if F49(GetManipulatedItem())==ArmletOn or F49(GetManipulatedItem())==ArmletOnCourier then
			call UnitRemoveAbility(Hero,'A44Q')
			call UnitRemoveAbility(Hero,'A0UK')//A0UK -> Armlet Effect
			if HaveSavedHandle(HY,GetHandleId(Hero),'ARML') then
				call TriggerEvaluate(LoadTriggerHandle(HY,GetHandleId(Hero),'ARML'))
			endif
			if F49(GetManipulatedItem())==ArmletOn then
				//call Armlet_StrBonus(Hero,0)
				
			endif
		endif
	endif
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
		if F49(GetManipulatedItem())==ArmletOff  or F49(GetManipulatedItem())==ArmletOffCourier then
			call UnitAddAbility2(Hero,'A44Q')
			if F49(GetManipulatedItem())==ArmletOff then
				call Armlet_StrBonus(Hero,0)
			endif
		endif
		if F49(GetManipulatedItem())==Satanic then
			call UnitAddAbility2(Hero,'A1BW')//A1BW -> Item Damage Bonus (+20)
		endif
		if F49(GetManipulatedItem())==ArmletOn or F49(GetManipulatedItem())==ArmletOnCourier then
			call UnitAddAbility2(Hero,'A44Q')
			call UnitAddAbility2(Hero,'A0UK')//A0UK -> Armlet Effect
			if F49(GetManipulatedItem())==ArmletOn then
				set t=CreateTrigger()
				call TriggerRegisterTimerEvent(t,0.6/25,true)
				set KXD=GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)-GetWidgetLife(GetTriggerUnit())
				call SaveUnitHandle(MHT,GetHandleId(t),0,Hero)
				call SaveBoolean(HeroStats,GetHandleId(Hero),20,true)
				call SaveReal(MHT,GetHandleId(t),0,KXD)
				call TriggerAddCondition(t,Condition(function Armlet_TogglingOn))
				if HaveSavedHandle(HY,GetHandleId(Hero),'ARML') then
					call TriggerEvaluate(LoadTriggerHandle(HY,GetHandleId(Hero),'ARML'))
				endif
				call SaveTriggerHandle(HY,GetHandleId(Hero),'ARML',t)
				set t=null
				call AddTimedKeyToUnit(Hero,4298,.6)
			endif
		endif
	endif
	set Hero=null
endfunction

function E7D takes nothing returns boolean
	if GetItemType(GetManipulatedItem())==ITEM_TYPE_PERMANENT and(F49(GetManipulatedItem())==ArmletOn or F49(GetManipulatedItem())==ArmletOff or F49(GetManipulatedItem())==Satanic or F49(GetManipulatedItem())==bloodstone)then
		call E4D()
	endif
	return false
endfunction

function E8D takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local item Item=(LoadItemHandle(HY,h,96))
	if GetTriggerEventId()==EVENT_UNIT_DROP_ITEM and GetManipulatedItem()==Item then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()!=EVENT_UNIT_DROP_ITEM then
		if LoadInteger(HY,GetHandleId(Hero),4310)!=1 and IsCourier(Hero)==false and IsUnitInvulnerable(Hero)==false then
			call SetWidgetLife(Hero,RMaxIF(GetWidgetLife(Hero)-40.,1))
		endif
	endif
	set t=null
	set Hero=null
	set Item=null
	return false
endfunction

function E9D takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DROP_ITEM)
	call TriggerAddCondition(t,Condition(function E8D))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveItemHandle(HY,h,96,(GetManipulatedItem()))
	set t=null
	set Hero=null
endfunction

function EDD takes nothing returns boolean
	if GetItemType(GetManipulatedItem())==ITEM_TYPE_PERMANENT and (F49(GetManipulatedItem())==ArmletOn or (F49(GetManipulatedItem())==ArmletOnCourier and IsUnitSpiritBear(GetTriggerUnit()))) then
		call E9D()
	endif
	return false
endfunction

function EED takes unit u returns boolean
	local item EFD=CreateItem('I0KK',GetUnitX(u),GetUnitY(u))//I0KK -> Aegis Check
	local boolean result=UnitAddItem(u,EFD)
	if result==false then
		call RemoveItem(EFD)
	endif
	set EFD=null
	return result
endfunction

function EGD takes unit Hero,item Item,integer FO9 returns item
	local real x=FI9(Hero)
	local real y=FK9(Hero)
	local integer i=0
	local boolean array FP9
	local item FQ9
	loop
		exitwhen i>(UnitInventorySize(Hero)-1)
		if UnitItemInSlot(Hero,i)==null and i!=FO9 then
			set FQ9=CreateItem('I02M',x,y)//I02M -> Dummy Item Scourge
			call UnitAddItem(Hero,FQ9)
			set FP9[i]=true
		else
			set FP9[i]=false
		endif
		if i==FO9 then
			call UnitAddItem(Hero,Item)
		endif
		set i=i+1
	endloop
	set i=0
	loop
		exitwhen i>5
		if FP9[i] then
			call RemoveItem(UnitItemInSlot(Hero,i))
		endif
		set i=i+1
	endloop
	set tt_item1=Item
	set FQ9=null
	return tt_item1
endfunction

function EHD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer i=0
	local item EID
	local integer indexId
	local unit Caster
	local item EJD
	local item it
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SaveBoolean(HY,(GetHandleId(Hero)),102,(false))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif EED(Hero)==false then
		call TriggerRegisterTimerEvent(t,5.5,false)
	else
		call SaveBoolean(HY,(GetHandleId(Hero)),102,(false))
		call DisableTrigger(t_manipulateitem)
		if HasItem_LinkenSphere[GetPlayerId(GetOwningPlayer(Hero))]>0 then
			set it=UnitAddItemById(Hero,'I0HM')//I0HM -> Linken's Sphere
			if GetWidgetLife(it)>0 then
				call RemoveItem(it)
			endif
			set it=null
		endif
		loop
			exitwhen i>5
			set EID=UnitItemInSlot(Hero,i)
			set indexId=F49(EID)
			if indexId==LinkenDummy then
				set tt_player1=GetItemPlayer(EID)
				call RemoveItem(EID)
				set Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
				call UnitAddAbility(Caster,'AInv')//AInv -> Inventory
				set EJD=UnitAddItemById(Caster,Item_Real[LinkensSphere])
				call UnitUseItem(Caster,EJD)
				set tt_item1=EGD(Hero,EJD,i)
				call SetItemPlayer(EJD,tt_player1,false)
				call SetItemUserData(EJD,1)
				call UnitRemoveAbility(Caster,'AInv')//AInv -> Inventory
				set Caster=null
				set EJD=null
			endif
			set EID=null
			set i=i+1
		endloop
		call EnableTrigger(t_manipulateitem)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Hero=null
	set EID=null
	set Caster=null
	set EJD=null
	return false
endfunction

function EKD takes unit Hero returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer i=0
	local item EID
	local integer indexId
	local unit Caster
	local item EJD
	call DisableTrigger(t_manipulateitem)
	call SaveBoolean(HY,(GetHandleId(Hero)),102,(true))
	call TriggerRegisterTimerEvent(t,17,false)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerAddCondition(t,Condition(function EHD))
	call SaveUnitHandle(HY,h,14,(Hero))
	loop
		exitwhen i>5
		set EID=UnitItemInSlot(Hero,i)
		set indexId=F49(EID)
		if indexId==LinkensSphere or indexId==LinkenDummy then
			set tt_player1=GetItemPlayer(EID)
			call RemoveItem(EID)
			set Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
			call UnitAddAbility(Caster,'AInv')//AInv -> Inventory
			set EJD=UnitAddItemById(Caster,Item_Real[LinkenDummy])
			call UnitUseItem(Caster,EJD)
			set tt_item1=EGD(Hero,EJD,i)
			call SetItemPlayer(EJD,tt_player1,false)
			call SetItemUserData(EJD,1)
			call UnitRemoveAbility(Caster,'AInv')//AInv -> Inventory
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\DispelMagic\\DispelMagicTarget.mdl",Hero,"origin"))
			set Caster=null
			set EJD=null
		endif
		set EID=null
		set i=i+1
	endloop
	call EnableTrigger(t_manipulateitem)
	set t=null
endfunction

function LinkensWrapper takes nothing returns boolean
	local integer i=1
	local unit Hero
	local integer id
	if GameEnded then
		return false
	endif
	if TotalCount_LinkenSphere>0 then
		loop
			exitwhen i>5
			set id=GetPlayerId(Sentinels[i])
			set Hero=udg_Hero[id]
			if HasItem_LinkenSphere[id]>0 and Hero!=null and IsDead(Hero)==false and LoadBoolean(HY,GetHandleId(Hero),102)==false and IsBlocked(Hero)==false and LoadBoolean(HY,GetHandleId(Hero),129)==false then
				call EKD(Hero)
			endif
			set id=GetPlayerId(Scourges[i])
			set Hero=udg_Hero[id]
			if HasItem_LinkenSphere[id]>0 and Hero!=null and IsDead(Hero)==false and LoadBoolean(HY,GetHandleId(Hero),102)==false and IsBlocked(Hero)==false and LoadBoolean(HY,GetHandleId(Hero),129)==false then
				call EKD(Hero)
			endif
			set i=i+1
		endloop
	endif
	set Hero=null
	return false
endfunction

function RemoveLinkenBuff takes unit u returns nothing
	call EKD(u)
	call UnitRemoveAbility(u,'B0BI')//B0BI -> Linken Sphere
endfunction

function EOD takes nothing returns boolean
	local integer id
	local unit u
	local integer h
	if GetSpellAbilityId()=='A0H6' then//A0H6 -> Bottle Empty
		set u=GetTriggerUnit()
		set h=GetHandleId(u)
		call SaveUnitHandle(HY,h,103,null)
		call SaveInteger(HY,h,104,0)
		if(FindItemOfType(GetTriggerUnit(),Item_Real[Bottle0])!=null or FindItemOfType(GetTriggerUnit(),Item_Mute[Bottle0])!=null)and(GetUnitTypeId(GetSpellTargetUnit())=='nfoh' or GetUnitTypeId(GetSpellTargetUnit())=='ndfl')then//nfoh -> Well of Life, ndfl -> Defiled Fountain of Life
			call SaveUnitHandle(HY,h,103,GetSpellTargetUnit())
		elseif IsFakeRune(GetItemTypeId(GetSpellTargetItem()))then
			set id=GetRealRune(GetItemTypeId(GetSpellTargetItem()))
			call CO9(GetTriggerUnit(),id,true)
			call SaveInteger(HY,h,104,id)
			call DestroyItem(GetSpellTargetItem())
		endif
	endif
	set u=null
	return false
endfunction

function ESD takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local item Item=GetManipulatedItem()
	local integer indexId=GetIndex(Item)
	local unit ETD
	local integer EUD
	local integer FO9
	local item EJD=null
	local integer EVD
	local integer id
	if indexId==Bottle0 then
		set FO9=GetItemSlot(u,Item)
		set ETD=(LoadUnitHandle(HY,(GetHandleId(u)),103))
		set EUD=(LoadInteger(HY,(GetHandleId(u)),104))
		if GetUnitTypeId(ETD)=='nfoh' or GetUnitTypeId(ETD)=='ndfl' then//nfoh -> Well of Life, ndfl -> Defiled Fountain of Life
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"overhead"))
			call SoundForPlayer(GetOwningPlayer(u),"Abilities\\Spells\\Human\\Heal\\HealTarget.wav")
			set tt_player1=GetItemPlayer(Item)
			call DestroyItem(Item)
			set tt_item1=AddItemByIdInSlot(u,Item_Real[Bottle3],FO9)
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
		elseif IsRune(EUD)then
			set EVD=GetBottleWithRuneId(EUD)
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"overhead"))
			set tt_player1=GetItemPlayer(Item)
			call DestroyItem(Item)
			call DisableTrigger(t_manipulateitem)
			if GetOwningPlayer(u)==tt_player1 then
				set tt_item1=AddItemByIdInSlot(u,Item_Real[EVD],FO9)
			else
				set tt_item1=AddItemByIdInSlot(u,Item_Mute[EVD],FO9)
			endif
			call EnableTrigger(t_manipulateitem)
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
			set EJD=UnitItemInSlot(u,FO9)
			call ERD(u,EJD)
		endif
	elseif indexId==Bottle3 then
		set FO9=GetItemSlot(u,Item)
		set tt_player1=GetItemPlayer(Item)
		call DestroyItem(Item)
		set tt_item1=AddItemByIdInSlot(u,Item_Real[Bottle2],FO9)
		call SetItemPlayer(tt_item1,tt_player1,false)
		call SetItemUserData(tt_item1,1)
	elseif indexId==Bottle2 then
		set FO9=GetItemSlot(u,Item)
		set tt_player1=GetItemPlayer(Item)
		call DestroyItem(Item)
		set tt_item1=AddItemByIdInSlot(u,Item_Real[Bottle1],FO9)
		call SetItemPlayer(tt_item1,tt_player1,false)
		call SetItemUserData(tt_item1,1)
	elseif indexId==Bottle1 then
		set FO9=GetItemSlot(u,Item)
		set tt_player1=GetItemPlayer(Item)
		call DestroyItem(Item)
		set tt_item1=AddItemByIdInSlot(u,Item_Real[Bottle0],FO9)
		call SetItemPlayer(tt_item1,tt_player1,false)
		call SetItemUserData(tt_item1,0)
	elseif Bottle_IsIndexRune(indexId)then
		//if(LoadInteger(HY,(GetHandleId(Item)),(GetHandleId(u))))>0 then
			set VP7=true
			set FO9=GetItemSlot(u,Item)
			set id=GetRuneFromBottle(indexId)
			if id>0 then
				set EJD=CreateItem(id,GetUnitX(u),GetUnitY(u))
			else
				set EJD=null
			endif
			set tt_player1=GetItemPlayer(Item)
			call DestroyItem(Item)
			set tt_item1=AddItemByIdInSlot(u,Item_Real[Bottle3],FO9)
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
			call UnitAddItem(u,EJD)
			set VP7=false
		//endif
	endif
	set u=null
	set Item=null
	set ETD=null
	set EJD=null
endfunction

function EWD takes nothing returns boolean
	if GetIssuedOrderId()==851971 then
		if GetOrderTargetItem()!=null then
			if IsFakeRune(GetItemTypeId(GetOrderTargetItem()))then
				call InterruptUnit(GetTriggerUnit())
				call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0LU'))//n0LU -> Courier cannot use powerups
			elseif GetIndex(GetOrderTargetItem())==DivineRapier or GetIndex(GetOrderTargetItem())==DivineRapierFree then
				call InterruptUnit(GetTriggerUnit())
				call Error(GetOwningPlayer(GetTriggerUnit()),"Courier cannot pickup Divine Rapier")
			endif
		endif
	endif
	return false
endfunction

function CourierCantPickupRunes takes unit EYD returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,EYD,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call TriggerAddCondition(t,Condition(function EWD))
	set t=null
endfunction

function GetRandomGroundCourierModel takes player p returns integer
	local integer r=GetRandomInt(1,6)
	if IsProPlayer(p) then
		return 'np00'
	endif
	if IsSentinel(p)then
		if r==1 then
			return 'n00I'//n00I -> Chicken
		elseif r==2 then
			return 'n022'//n022 -> Raccoon
		elseif r==3 then
			return 'n021'//n021 -> Penguin
		elseif r==4 then
			return 'n0KY'//n0KY -> Zoidberg
		elseif r==5 then
			return 'n0KZ'//n0KZ -> Seal
		else
			return 'n0LE'//n0LE -> Rabbit
		endif
	else
		if r==1 then
			return 'n023'//n023 -> Carrion Beetle
		elseif r==2 then
			return 'n024'//n024 -> Dune Worm
		elseif r==3 then
			return 'n025'//n025 -> Fel Boar
		elseif r==4 then
			return 'n0L0'//n0L0 -> Skink
		elseif r==5 then
			return 'n0L1'//n0L1 -> Dog
		else
			return 'n0M4'//n0M4 -> Pack Horse
		endif
	endif
	return 0
endfunction

function GetRandomFlyCourierModel takes player p returns integer
	if IsProPlayer(p) then
		return 'np01'
	endif
	if GetRandomInt(1,3)==1 then
		return 'e02R'//e02R -> Goblin Zeppelin
	elseif IsSentinel(p)then
		return 'e01H'//e01H -> Crow
	else
		return 'e01Z'//e01Z -> Vulture
	endif
	return 0
endfunction

function EBD takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local real a=GetUnitFacing(u)
	local unit c=CreateUnit(GetOwningPlayer(u),GetRandomGroundCourierModel(GetOwningPlayer(u)),x,y,a)
	call Z89(c)
	call GroupAddUnit(CouriersSummoned,c)
	call SaveUnitHandle(HeroStats,GetHandleId(GetOwningPlayer(u)),'COUR',GetBestCourier(GetOwningPlayer(u)))
	call SetUnitPosition(c,x+25*Cos(a*bj_DEGTORAD),y+25*Sin(a*bj_DEGTORAD))
	if ShowCourierIcon[GetPlayerId(GetOwningPlayer(c))]==false then
		call UnitRemoveType(c,UNIT_TYPE_PEON)
	else
		call UnitAddType(c,UNIT_TYPE_PEON)
	endif
	set c=null
	set u=null
endfunction

function E3D takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local unit courier=CreateUnit(GetOwningPlayer(u),GetRandomFlyCourierModel(GetOwningPlayer(u)),GetUnitX(u),GetUnitY(u),GetUnitFacing(u))
	call Z89(courier)
	call GroupAddUnit(CouriersSummoned,courier)
	call SaveUnitHandle(HeroStats,GetHandleId(GetOwningPlayer(u)),'COUR',GetBestCourier(GetOwningPlayer(u)))
	if ShowCourierIcon[GetPlayerId(GetOwningPlayer(courier))]==false then
		call UnitRemoveType(courier,UNIT_TYPE_PEON)
	else
		call UnitAddType(courier,UNIT_TYPE_PEON)
	endif
	call CourierCantPickupRunes(courier)
	set courier=null
	set u=null
endfunction

function ELD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,124)
	local integer i=1
	local integer array itemsid
	local integer array charges
	local integer E1D=LoadInteger(HY,h,125)
	set itemsid[1]=LoadInteger(HY,h,106)
	set itemsid[2]=LoadInteger(HY,h,107)
	set itemsid[3]=LoadInteger(HY,h,108)
	set itemsid[4]=LoadInteger(HY,h,109)
	set itemsid[5]=LoadInteger(HY,h,110)
	set itemsid[6]=LoadInteger(HY,h,111)
	set charges[1]=LoadInteger(HY,h,112)
	set charges[2]=LoadInteger(HY,h,113)
	set charges[3]=LoadInteger(HY,h,114)
	set charges[4]=LoadInteger(HY,h,115)
	set charges[5]=LoadInteger(HY,h,116)
	set charges[6]=LoadInteger(HY,h,117)
	call DisableTrigger(t_manipulateitem)
	if GetTriggerEvalCount(t)==1 then
		call UnitAddAbility(u,E1D)
		if ShowCourierIcon[GetPlayerId(GetOwningPlayer(u))]==false then
			call UnitRemoveType(u,UNIT_TYPE_PEON)
		else
			call UnitAddType(u,UNIT_TYPE_PEON)
		endif
	else
		loop
			if itemsid[i]>0 then
				set tt_item1=CreateItem(itemsid[i],GetUnitX(u),GetUnitY(u))
				call UnitAddItem(u,tt_item1)
				call SetItemPlayer(tt_item1,LoadPlayerHandle(HY,h,117+i),false)
				call SetItemUserData(tt_item1,1)
				if charges[i]>0 then
					call SetItemCharges(tt_item1,charges[i])
				endif
			endif
			set i=i+1
			exitwhen i>6
		endloop
		if ShowCourierIcon[GetPlayerId(GetOwningPlayer(u))]==false then
			call UnitRemoveType(u,UNIT_TYPE_PEON)
		else
			call UnitAddType(u,UNIT_TYPE_PEON)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	call EnableTrigger(t_manipulateitem)
	call UnitMakeAbilityPermanent(u,true,'A29M')//A29M -> Courier Reincarnation 180
	call UnitMakeAbilityPermanent(u,true,'A413')
	set t=null
	set u=null
	return false
endfunction

function itsNewDisabledConsumable takes integer id returns boolean
	return id==Tango or id==HealingSalve or id==ClarityPotion
endfunction

function FID takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit FJD=(LoadUnitHandle(HY,h,2))
	local integer FKD=GetUnitTypeId(FJD)
	local real x=GetUnitX(FJD)
	local real y=GetUnitY(FJD)
	local item FMD
	local item FND
	local item FOD
	local item FPD
	local item FQD
	local item FRD
	local player p0
	local player p1
	local player p2
	local player p3
	local player p4
	local player p5
	local integer E0D
	local integer E5D
	local integer E2D
	local integer F4D
	local integer F7D
	local integer F8D
	local integer F9D=-1
	local integer FDD=-1
	local integer FED=-1
	local integer FFD=-1
	local integer FGD=-1
	local integer FHD=-1
	local integer E1D
	local item Item
	local integer i
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	if FJD==null or IsDead(FJD)then
		return false
	endif
	set t=CreateTrigger()
	set h=GetHandleId(t)
	set FMD=UnitItemInSlot(FJD,0)
	set FND=UnitItemInSlot(FJD,1)
	set FOD=UnitItemInSlot(FJD,2)
	set FPD=UnitItemInSlot(FJD,3)
	set FQD=UnitItemInSlot(FJD,4)
	set FRD=UnitItemInSlot(FJD,5)
	set E0D=GetItemTypeId(FMD)
	set E5D=GetItemTypeId(FND)
	set E2D=GetItemTypeId(FOD)
	set F4D=GetItemTypeId(FPD)
	set F7D=GetItemTypeId(FQD)
	set F8D=GetItemTypeId(FRD)
	set p0=GetItemPlayer(FMD)
	set p1=GetItemPlayer(FND)
	set p2=GetItemPlayer(FOD)
	set p3=GetItemPlayer(FPD)
	set p4=GetItemPlayer(FQD)
	set p5=GetItemPlayer(FRD)
	set Item=FMD
	set i=GetIndex(Item)
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
		set F9D=GetItemCharges(Item)
	endif
	set Item=FND
	set i=GetIndex(Item)
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
		set FDD=GetItemCharges(Item)
	endif
	set Item=FOD
	set i=GetIndex(Item)
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
		set FED=GetItemCharges(Item)
	endif
	set Item=FPD
	set i=GetIndex(Item)
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
		set FFD=GetItemCharges(Item)
	endif
	set Item=FQD
	set i=GetIndex(Item)
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
		set FGD=GetItemCharges(Item)
	endif
	set Item=FRD
	set i=GetIndex(Item)
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
		set FHD=GetItemCharges(Item)
	endif
	call DestroyItem(FMD)
	call DestroyItem(FND)
	call DestroyItem(FOD)
	call DestroyItem(FPD)
	call DestroyItem(FQD)
	call DestroyItem(FRD)
	if FKD=='n00I' then//n00I -> Chicken
		set E1D='S009'//S009 -> Courier Morph - Chicken to Penguin
	elseif FKD=='n022' then//n022 -> Raccoon
		set E1D='S00V'//S00V -> Courier Morph - Raccoon to Crab
	elseif FKD=='n021' then//n021 -> Penguin
		set E1D='S00C'//S00C -> Courier Morph - Penguin to Raccoon
	elseif FKD=='n023' then//n023 -> Carrion Beetle
		set E1D='S00E'//S00E -> Courier Morph - Carrion Beetle to Fel Boar
	elseif FKD=='n024' then//n024 -> Dune Worm
		set E1D='S00B'//S00B -> Courier Morph - Dune Worm to Carrion Beetle
	elseif FKD=='n025' then//n025 -> Fel Boar
		set E1D='S00F'//S00F -> Courier Morph - Fel Boar to Rabit
	elseif FKD=='n0KY' then//n0KY -> Zoidberg
		set E1D='S00W'//S00W -> Courier Morph - Crab to Seal
	elseif FKD=='n0KZ' then//n0KZ -> Seal
		set E1D='S00Y'//S00Y -> Courier Morph - Seal to Skink
	elseif FKD=='n0L0' then//n0L0 -> Skink
		set E1D='S00X'//S00X -> Courier Morph - Skink to Dog
	elseif FKD=='n0L1' then//n0L1 -> Dog
		set E1D='S00D'//S00D -> Courier Morph - Dog to Dune Worm
	elseif FKD=='n0LE' then//n0LE -> Rabbit
		set E1D='S01F'//S01F -> Courier Morph - Rabit To Pack
	elseif FKD=='n0M4' then//n0M4 -> Pack Horse
		set E1D='S015'//S015 -> Courier Morph - Pack to Chicken
	endif
	if GetRandomInt(1,10)==1 then
		set E1D='S00G'//S00G -> Courier Morph - To Mini Pudge
	endif
	if GetRandomInt(1,10)<3 then
		set E1D='S016'//S016 -> Courier Morph - To Mini Grunt
	endif
	if FKD=='n00M' then//n00M -> Mini Pudge
		set E1D='S00L'//S00L -> Courier Morph - To Mini Techies
	elseif FKD=='n0LS' then//n0LS -> Grunt
		set E1D='S00L'//S00L -> Courier Morph - To Mini Techies
	elseif FKD=='n0HV' then//n0HV -> Mini Techies
		set E1D='S00F'//S00F -> Courier Morph - Fel Boar to Rabit
	endif
	if FKD=='e01H' then//e01H -> Crow
		set E1D='S012'//S012 -> Courier Morph - To Zeppelin
	elseif FKD=='e01Z' then//e01Z -> Vulture
		set E1D='S010'//S010 -> Courier Morph - To Owl
	elseif FKD=='e02R' then//e02R -> Goblin Zeppelin
		set E1D='S014'//S014 -> Courier Morph - To Vulture
	elseif FKD=='e02T' then//e02T -> Snow Owl
		set E1D='S011'//S011 -> Courier Morph - To Viper
	elseif FKD=='e02S' then//e02S -> Mini Viper
		set E1D='S017'//S017 -> Courier Morph - To Frost
	elseif FKD=='e030' then//e030 -> Frost Wyrm
		set E1D='S013'//S013 -> Courier Morph - To Crow
	endif
	call SavePlayerHandle(HY,h,118,(p0))
	call SavePlayerHandle(HY,h,119,(p1))
	call SavePlayerHandle(HY,h,120,(p2))
	call SavePlayerHandle(HY,h,121,(p3))
	call SavePlayerHandle(HY,h,122,(p4))
	call SavePlayerHandle(HY,h,123,(p5))
	call SaveInteger(HY,h,106,(E0D))
	call SaveInteger(HY,h,107,(E5D))
	call SaveInteger(HY,h,108,(E2D))
	call SaveInteger(HY,h,109,(F4D))
	call SaveInteger(HY,h,110,(F7D))
	call SaveInteger(HY,h,111,(F8D))
	call SaveInteger(HY,h,112,(F9D))
	call SaveInteger(HY,h,113,(FDD))
	call SaveInteger(HY,h,114,(FED))
	call SaveInteger(HY,h,115,(FFD))
	call SaveInteger(HY,h,116,(FGD))
	call SaveInteger(HY,h,117,(FHD))
	call SaveUnitHandle(HY,h,124,(FJD))
	call SaveInteger(HY,h,125,(E1D))
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function ELD))
	set t=null
	set FJD=null
	set FMD=null
	set FND=null
	set FOD=null
	set FPD=null
	set FQD=null
	set FRD=null
	set p0=null
	set p1=null
	set p2=null
	set p3=null
	set p4=null
	set p5=null
	set Item=null
	return false
endfunction

function FSD takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.05,false)
	call TriggerAddCondition(t,Condition(function FID))
	call SaveUnitHandle(HY,h,2,(GetTriggerUnit()))
	set t=null
endfunction

function FUD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit ECD=(LoadUnitHandle(HY,h,124))
	local integer E1D=(LoadInteger(HY,h,125))
	local integer E0D=(LoadInteger(HY,h,106))
	local integer E5D=(LoadInteger(HY,h,107))
	local integer E2D=(LoadInteger(HY,h,108))
	local integer F4D=(LoadInteger(HY,h,109))
	local integer F7D=(LoadInteger(HY,h,110))
	local integer F8D=(LoadInteger(HY,h,111))
	local player p0=(LoadPlayerHandle(HY,h,118))
	local player p1=(LoadPlayerHandle(HY,h,119))
	local player p2=(LoadPlayerHandle(HY,h,120))
	local player p3=(LoadPlayerHandle(HY,h,121))
	local player p4=(LoadPlayerHandle(HY,h,122))
	local player p5=(LoadPlayerHandle(HY,h,123))
	local integer F9D=(LoadInteger(HY,h,112))
	local integer FDD=(LoadInteger(HY,h,113))
	local integer FED=(LoadInteger(HY,h,114))
	local integer FFD=(LoadInteger(HY,h,115))
	local integer FGD=(LoadInteger(HY,h,116))
	local integer FHD=(LoadInteger(HY,h,117))
	call DisableTrigger(t_manipulateitem)
	if GetTriggerEvalCount(t)==1 then
		call UnitAddAbility(ECD,E1D)
		if ShowCourierIcon[GetPlayerId(GetOwningPlayer(ECD))]==false then
			call UnitRemoveType(ECD,UNIT_TYPE_PEON)
		else
			call UnitAddType(ECD,UNIT_TYPE_PEON)
		endif
	else
		if E0D>0 then
			set tt_item1=CreateItem(E0D,GetUnitX(ECD),GetUnitY(ECD))
			call UnitAddItem(ECD,tt_item1)
			call SetItemPlayer(tt_item1,p0,false)
			call SetItemUserData(tt_item1,1)
		endif
		if F9D>0 then
			call SetItemCharges(tt_item1,F9D)
		endif
		if E5D>0 then
			set tt_item1=CreateItem(E5D,GetUnitX(ECD),GetUnitY(ECD))
			call UnitAddItem(ECD,tt_item1)
			call SetItemPlayer(tt_item1,p1,false)
			call SetItemUserData(tt_item1,1)
		endif
		if FDD>0 then
			call SetItemCharges(tt_item1,FDD)
		endif
		if E2D>0 then
			set tt_item1=CreateItem(E2D,GetUnitX(ECD),GetUnitY(ECD))
			call UnitAddItem(ECD,tt_item1)
			call SetItemPlayer(tt_item1,p2,false)
			call SetItemUserData(tt_item1,1)
		endif
		if FED>0 then
			call SetItemCharges(tt_item1,FED)
		endif
		if F4D>0 then
			set tt_item1=CreateItem(F4D,GetUnitX(ECD),GetUnitY(ECD))
			call UnitAddItem(ECD,tt_item1)
			call SetItemPlayer(tt_item1,p3,false)
			call SetItemUserData(tt_item1,1)
		endif
		if FFD>0 then
			call SetItemCharges(tt_item1,FFD)
		endif
		if F7D>0 then
			set tt_item1=CreateItem(F7D,GetUnitX(ECD),GetUnitY(ECD))
			call UnitAddItem(ECD,tt_item1)
			call SetItemPlayer(tt_item1,p4,false)
			call SetItemUserData(tt_item1,1)
		endif
		if FGD>0 then
			call SetItemCharges(tt_item1,FGD)
		endif
		if F8D>0 then
			set tt_item1=CreateItem(F8D,GetUnitX(ECD),GetUnitY(ECD))
			call UnitAddItem(ECD,tt_item1)
			call SetItemPlayer(tt_item1,p5,false)
			call SetItemUserData(tt_item1,1)
		endif
		if FHD>0 then
			call SetItemCharges(tt_item1,FHD)
		endif
		if ShowCourierIcon[GetPlayerId(GetOwningPlayer(ECD))]==false then
			call UnitRemoveType(ECD,UNIT_TYPE_PEON)
		else
			call UnitAddType(ECD,UNIT_TYPE_PEON)
		endif
		call SetUnitFlyHeight(ECD,240,0)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	call EnableTrigger(t_manipulateitem)
	set t=null
	set ECD=null
	set p0=null
	set p1=null
	set p2=null
	set p3=null
	set p4=null
	set p5=null
	return false
endfunction

function FVD takes unit FJD returns nothing
	local integer FKD=GetUnitTypeId(FJD)
	local real x=GetUnitX(FJD)
	local real y=GetUnitY(FJD)
	local item FMD
	local item FND
	local item FOD
	local item FPD
	local item FQD
	local item FRD
	local player p0
	local player p1
	local player p2
	local player p3
	local player p4
	local player p5
	local integer E0D
	local integer E5D
	local integer E2D
	local integer F4D
	local integer F7D
	local integer F8D
	local integer F9D=-1
	local integer FDD=-1
	local integer FED=-1
	local integer FFD=-1
	local integer FGD=-1
	local integer FHD=-1
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer E1D
	local item Item
	local integer i
	local item FWD
	set i=0
	loop
		exitwhen i>5
		set FWD=UnitItemInSlot(FJD,i)
		if GetIndex(FWD)==Gem then
			call UnitRemoveItem(FJD,FWD)
		endif
		set i=i+1
	endloop
	set FMD=UnitItemInSlot(FJD,0)
	set FND=UnitItemInSlot(FJD,1)
	set FOD=UnitItemInSlot(FJD,2)
	set FPD=UnitItemInSlot(FJD,3)
	set FQD=UnitItemInSlot(FJD,4)
	set FRD=UnitItemInSlot(FJD,5)
	set E0D=GetItemTypeId(FMD)
	set E5D=GetItemTypeId(FND)
	set E2D=GetItemTypeId(FOD)
	set F4D=GetItemTypeId(FPD)
	set F7D=GetItemTypeId(FQD)
	set F8D=GetItemTypeId(FRD)
	set p0=GetItemPlayer(FMD)
	set p1=GetItemPlayer(FND)
	set p2=GetItemPlayer(FOD)
	set p3=GetItemPlayer(FPD)
	set p4=GetItemPlayer(FQD)
	set p5=GetItemPlayer(FRD)
	set Item=FMD
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
		set F9D=GetItemCharges(Item)
	endif
	set Item=FND
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
		set FDD=GetItemCharges(Item)
	endif
	set Item=FOD
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
		set FED=GetItemCharges(Item)
	endif
	set Item=FPD
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
		set FFD=GetItemCharges(Item)
	endif
	set Item=FQD
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
		set FGD=GetItemCharges(Item)
	endif
	set Item=FRD
	if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
		set FHD=GetItemCharges(Item)
	endif
	call DestroyItem(FMD)
	call DestroyItem(FND)
	call DestroyItem(FOD)
	call DestroyItem(FPD)
	call DestroyItem(FQD)
	call DestroyItem(FRD)
	if GetUnitTypeId(FJD)=='np00'then
		set E1D='S020'
	else
		if IsSentinel(GetOwningPlayer(FJD))then
			set E1D='S00I'//S00I -> Courier Morph - To Crow
		else
			set E1D='S00J'//S00J -> Courier Morph - To Vulture
		endif
		if GetRandomInt(1,3)==1 then
			set E1D='S00Z'//S00Z -> Courier Morph - To Zeppelin
		endif
	endif
	call SavePlayerHandle(HY,h,118,(p0))
	call SavePlayerHandle(HY,h,119,(p1))
	call SavePlayerHandle(HY,h,120,(p2))
	call SavePlayerHandle(HY,h,121,(p3))
	call SavePlayerHandle(HY,h,122,(p4))
	call SavePlayerHandle(HY,h,123,(p5))
	call SaveInteger(HY,h,106,(E0D))
	call SaveInteger(HY,h,107,(E5D))
	call SaveInteger(HY,h,108,(E2D))
	call SaveInteger(HY,h,109,(F4D))
	call SaveInteger(HY,h,110,(F7D))
	call SaveInteger(HY,h,111,(F8D))
	call SaveInteger(HY,h,112,(F9D))
	call SaveInteger(HY,h,113,(FDD))
	call SaveInteger(HY,h,114,(FED))
	call SaveInteger(HY,h,115,(FFD))
	call SaveInteger(HY,h,116,(FGD))
	call SaveInteger(HY,h,117,(FHD))
	call SaveUnitHandle(HY,h,124,(FJD))
	call SaveInteger(HY,h,125,(E1D))
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function FUD))
	set t=null
	set FJD=null
	set FMD=null
	set FND=null
	set FOD=null
	set FPD=null
	set FQD=null
	set FRD=null
	set p0=null
	set p1=null
	set p2=null
	set p3=null
	set p4=null
	set p5=null
	set Item=null
	set FWD=null
endfunction

function FXD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local item FYD=ZE8(Source,Item_Real[RecipeFlyingCourier])
	local boolean forced=LoadBoolean(HY,h,0)
	if forced==false then
		if FYD==null then
			set FYD=ZE8(Source,Item_Mute[RecipeFlyingCourier])
		endif
	endif
	if FYD!=null or forced then
		if forced==false then
			call RemoveItem(FYD)
		endif
		call FVD(Source)
	else
		call Error(GetOwningPlayer(Source),GetObjectName('n02Q'))//n02Q -> Recipe requirements not complete!
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	set FYD=null
	return false
endfunction

function FZD takes unit Source, boolean forced returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call CourierCantPickupRunes(Source)
	call TriggerRegisterTimerEvent(t,.05,false)
	call TriggerAddCondition(t,Condition(function FXD))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveBoolean(HY,h,0,forced)
	set t=null
endfunction

function LongCourierUp takes nothing returns nothing
	call FZD(tt_unit1,true)
endfunction

function FAD takes nothing returns boolean
	if GetSpellAbilityId()=='A0GD' then//A0GD -> Flying Courier Morph
		call FZD(GetTriggerUnit(),false)
	endif
	return false
endfunction

function FBD takes nothing returns boolean
	local unit Hero=GetTriggerUnit()
	local item Item=GetManipulatedItem()
	local integer id=GetItemTypeId(Item)
	local integer i
	if(id==Item_Real[ScrollOfTownPortal]or id==Item_Real[bootsOfTravel]or id==Item_Real[bootsOfTravel2])and IsUnitType(Hero,UNIT_TYPE_HERO) then
		set V17[GetPlayerId(GetOwningPlayer(Hero))]=GetItemX(Item)
		set V07[GetPlayerId(GetOwningPlayer(Hero))]=GetItemY(Item)
	endif
	call CW9(Hero,Item)
//	call RemoveDefaultString(Hero,1)
	if(GetItemTypeId(Item)==Item_Real[ArmletOn]or GetItemTypeId(Item)==Item_Real[ArmletOff])and IsCourier(Hero)then
		call UnitRemoveItem(Hero,Item)
	elseif (GetItemTypeId(Item))==Item_Real[MagicWand]and IsUnitType(Hero,UNIT_TYPE_HERO) then
		set i=LoadInteger(HY,GetHandleId(Hero),750)
		if i>0 then
			if(LoadBoolean(HY,GetHandleId(Hero),751))==false then
				call SaveBoolean(HY,GetHandleId(Hero),751,true)
				call SetItemCharges(Item,i)
			endif
		endif
	elseif GetItemTypeId(Item)==Item_Real[Aegis]and GetUnitTypeId(Hero)!='n00L' and M47==false then//n00L -> Roshan
		set K27=Hero
		set M47=true
		call Traffic_RegisterData("AegisOn",GetPlayerId(GetOwningPlayer(Hero)))
		if (IsSentinel(GetOwningPlayer(Hero)) and LastRoshanSlayer==0) or (IsScourge(GetOwningPlayer(Hero)) and LastRoshanSlayer==1) then
			call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[GetPlayerId(GetOwningPlayer(Hero))]+GetUnitName(Hero)+"|r "+GetObjectName('n0EQ'))//n0EQ -> has acquired Aegis of the Immortal
		else
			call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[GetPlayerId(GetOwningPlayer(Hero))]+GetUnitName(Hero)+"|r "+"snatched Aegis of the Immortal!")
		endif
	elseif GetItemTypeId(Item)==Item_Real[RecipeFlyingCourier] and IsBasicCourier(Hero)then
		call FZD(Hero,false)
	endif
	set Hero=null
	set Item=null
	return false
endfunction

function TangoHealingDur  takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real heal=LoadReal(HY,h,0)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer c=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call UnitRemoveAbility(u,'A0PV')//A0PV -> Tango Buff
		call UnitRemoveAbility(u,'B07L')//B07L -> |cff00ff00Ancient Tango of Essifation|r
		call RemoveSavedHandle(HY,GetHandleId(u),'TNGO')
		call DestroyTrigger(t)
		call FlushChildHashtable(HY,h)
	else
		if c > 0 then
			call SaveInteger(HY,h,0,c-1)
			call SetWidgetLife(u,GetWidgetLife(u)+heal)
			
		else
			call UnitRemoveAbility(u,'A0PV')//A0PV -> Tango Buff
			call UnitRemoveAbility(u,'B07L')//B07L -> |cff00ff00Ancient Tango of Essifation|r
			call RemoveSavedHandle(HY,GetHandleId(u),'TNGO')
			call DestroyTrigger(t)
			call FlushChildHashtable(HY,h)
		endif
		
	endif
	set t=null
	set u=null
	return false
endfunction

function TangoHealingEffect takes real heal returns nothing
	local trigger t
	local integer h
	local unit u=GetTriggerUnit()
	if HaveSavedHandle(HY,GetHandleId(u),'TNGO') then
		set t=LoadTriggerHandle(HY,GetHandleId(u),'TNGO')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,GetHandleId(u),'TNGO',t)
		call SaveUnitHandle(HY,h,0,u)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerRegisterTimerEvent(t,0,false)
		call TriggerRegisterDeathEvent(t,u)
		call TriggerAddCondition(t,Condition(function TangoHealingDur))
		call UnitAddAbility2(u,'A0PV')//A0PV -> Tango Buff
	endif
	call SaveReal(HY,h,0,heal*1.0 / 16.)
	call SaveInteger(HY,h,0,16)
	set t=null
	set u=null
endfunction

function TangoUsed takes nothing returns nothing
	if GetSpellTargetDestructable()!=null then
		call TangoHealingEffect(115)
	elseif GetSpellTargetUnit()!=null then
		if IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(GetSpellTargetUnit())) and (IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) or IsSpiritBear(GetSpellTargetUnit())) then
			call UnitAddItemById(GetSpellTargetUnit(),Item_Dummy[TangoBorrowed])
		elseif IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetSpellTargetUnit())) and (GetUnitTypeId(GetSpellTargetUnit())=='oeye' or GetUnitTypeId(GetSpellTargetUnit())=='o004') then//oeye -> Sentry Ward, o004 -> Observer Ward
			call TangoHealingEffect(230)
			call DamageTargetDelayed(GetTriggerUnit(),GetSpellTargetUnit(),2,500,0.)
		else
			call CreateItem(Item_Dummy[TangoBorrowed],GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()))
		endif
	endif
endfunction

function F1D takes integer id,real x,real y returns nothing
	if IsPointInRegion(RegionNoTPScrollPenalty,x,y)==false then
		set W87=W87+1
		set V57[W87]=Player(id)
		set V27[W87]=x
		set W47[W87]=y
		set W77[W87]=(TimerGetElapsed(GlobalTimer))
	endif
endfunction

function F0D takes integer id,real x,real y returns integer
	local real Time=(TimerGetElapsed(GlobalTimer))
	local integer i=0
	local integer Count=0
	if IsPointInRegion(RegionNoTPScrollPenalty,x,y) then
		return Count
	endif
	loop
		exitwhen i>W87
		if(Time<W77[i]+25)and(DistanceBetweenXY(x,y,V27[i],W47[i])<WD7*2+50)and IsPlayerAlly(Player(id),V57[i]) then
			set Count=Count+1
		endif
		set i=i+1
	endloop
	return Count
endfunction

function F5D takes integer ZG8 returns integer
	if ZG8==GetPlayerId(Sentinels[1])then
		return 'h0BI'//h0BI -> Scroll of Teleport Effect To - Blue
	elseif ZG8==GetPlayerId(Sentinels[2])then
		return 'h0BK'//h0BK -> Scroll of Teleport Effect To - Teal
	elseif ZG8==GetPlayerId(Sentinels[3])then
		return 'h0BG'//h0BG -> Scroll of Teleport Effect To - Purple
	elseif ZG8==GetPlayerId(Sentinels[4])then
		return 'h0BF'//h0BF -> Scroll of Teleport Effect To - Yellow
	elseif ZG8==GetPlayerId(Sentinels[5])then
		return 'h0BL'//h0BL -> Scroll of Teleport Effect To - Orange
	elseif ZG8==GetPlayerId(Scourges[1])then
		return 'h0BH'//h0BH -> Scroll of Teleport Effect To - Pink
	elseif ZG8==GetPlayerId(Scourges[2])then
		return 'h0BJ'//h0BJ -> Scroll of Teleport Effect To - Gray
	elseif ZG8==GetPlayerId(Scourges[3])then
		return 'h0BM'//h0BM -> Scroll of Teleport Effect To - LightBlue
	elseif ZG8==GetPlayerId(Scourges[4])then
		return 'h0A5'//h0A5 -> Scroll of Teleport Effect To - DarkGreen
	elseif ZG8==GetPlayerId(Scourges[5])then
		return 'h0BN'//h0BN -> Scroll of Teleport Effect To - Brown
	endif
	return 'h0BN'//h0BN -> Scroll of Teleport Effect To - Brown
endfunction

function G4D takes integer ZG8 returns string
	if ZG8==GetPlayerId(Sentinels[1])then
		return"war3mapImported\\TeleportTarget_Blue.mdx"
	elseif ZG8==GetPlayerId(Sentinels[2])then
		return"war3mapImported\\TeleportTarget_Teal.mdx"
	elseif ZG8==GetPlayerId(Sentinels[3])then
		return"war3mapImported\\TeleportTarget_Purple.mdx"
	elseif ZG8==GetPlayerId(Sentinels[4])then
		return"war3mapImported\\TeleportTarget_Yellow.mdx"
	elseif ZG8==GetPlayerId(Sentinels[5])then
		return"war3mapImported\\TeleportTarget_Orange.mdx"
	elseif ZG8==GetPlayerId(Scourges[1])then
		return"war3mapImported\\TeleportTarget_Pink.mdx"
	elseif ZG8==GetPlayerId(Scourges[2])then
		return"war3mapImported\\TeleportTarget_Gray.mdx"
	elseif ZG8==GetPlayerId(Scourges[3])then
		return"war3mapImported\\TeleportTarget_LightBlue.mdx"
	elseif ZG8==GetPlayerId(Scourges[4])then
		return"war3mapImported\\TeleportTarget_DarkGreen.mdx"
	elseif ZG8==GetPlayerId(Scourges[5])then
		return"war3mapImported\\TeleportTarget_Brown.mdx"
	endif
	return"Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl"
endfunction

function G8D takes nothing returns boolean
	local real d
	if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)and GetWidgetLife(GetFilterUnit())>0 and GetUnitAbilityLevel(GetFilterUnit(),'Asud')==0 and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit2)) and GetUnitTypeId(GetFilterUnit())!='u00S' and GetUnitTypeId(GetFilterUnit())!='ncop' and GetUnitTypeId(GetFilterUnit())!='emow' and GetUnitTypeId(GetFilterUnit())!='uzig' and IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false then//Asud -> Sell Units, u00S -> Power Cog, ncop -> Circle of Power, emow -> Moon Well, uzig -> Ziggurat
		set d=DistanceBetweenXY(TJ,RJ,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()))
		if d<tt_real1 then
			set tt_real1=d
			set tt_unit1=GetFilterUnit()
		endif
	endif
	return false
endfunction

function G9D takes unit whichUnit,real x,real y returns unit
	local group g=GetAvailableGroup()
	set tt_unit1=null
	set tt_unit2=whichUnit
	set tt_real1=99999
	set TJ=x
	set RJ=y
	call GroupEnumUnitsInRange(g,x,y,99999,Condition(function G8D))
	call KillGroup(g)
	set g=null
	return tt_unit1
endfunction

function GDD takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='n0FH' or id=='n0F6' or id=='n0FI' or id=='n0FJ'//n0FH -> Tombstone - Level 4, n0F6 -> Tombstone - Level 3, n0FI -> Tombstone - Level 2, n0FJ -> Tombstone - Level 1
endfunction

function GHD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local unit GID=(LoadUnitHandle(HY,h,448))
	local unit GJD=(LoadUnitHandle(HY,h,447))
	local ubersplat Splat=(LoadUbersplatHandle(HY,h,131))
	local integer Count=(LoadInteger(HY,h,34))
	local real DP9=(LoadReal(HY,h,57))
	local real Time=(LoadReal(HY,h,442))
	local integer id=GetPlayerId(GetOwningPlayer(Hero))
	local boolean GKD=false
	local integer i=0
	local integer charges
	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
		if GetSpellAbilityId()=='A1R5' then//A1R5 -> Scroll of Teleporation (fixed)
			set GKD=true
		endif
	else
		set Count=Count+1
		call SaveInteger(HY,h,34,(Count))
		if Count==1 then
			if DP9>3 then
				call SetUnitAnimationByIndex(GID,1)
				call SetUnitAnimationByIndex(GJD,1)
			endif
		elseif Count==2 then
			set GKD=true
		else
		endif
	endif
	if GKD then
		call SaveInteger(HY,(GetHandleId((Hero))),(4256),2)
		call KillUnit(GID)
		call KillUnit(GJD)
		call DestroyUbersplat(Splat)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if Count==2 then
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl",GetUnitX(Hero),GetUnitY(Hero)))
			call DestroyEffect(AddSpecialEffect(G4D(id),x,y))
			call SetUnitX(Hero,x)
			call SetUnitY(Hero,y)
			call PauseUnit(Hero,true)
			call PauseUnit(Hero,false)
			call KillTrees(x,y,240)
		endif
	endif
	set t=null
	set Hero=null
	set GID=null
	set GJD=null
	set Splat=null
	return false
endfunction

function GMD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local unit GID=(LoadUnitHandle(HY,h,448))
	local unit GJD=(LoadUnitHandle(HY,h,447))
	local ubersplat Splat=(LoadUbersplatHandle(HY,h,131))
	local integer Count=(LoadInteger(HY,h,34))
	local real DP9=(LoadReal(HY,h,57))
	local real Time=(LoadReal(HY,h,442))
	local integer id=GetPlayerId(GetOwningPlayer(Hero))
	local boolean GKD=false
	local integer i=0
	local integer charges
	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
		if GetSpellAbilityId()=='A231' or GetSpellAbilityId()=='A3AG' then//A231 -> Boots of Travel (fixed)
			call DestroyEffect((LoadEffectHandle(HY,h,175)))
			call DestroyEffect((LoadEffectHandle(HY,h,176)))
			call DestroyEffect((LoadEffectHandle(HY,h,177)))
			call SaveInteger(HY,(GetHandleId((Hero))),(4256),2)
			call KillUnit(GID)
			call KillUnit(GJD)
			call DestroyUbersplat(Splat)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call UnitRemoveType(Target,UNIT_TYPE_PEON)
		endif
	elseif GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call DestroyEffect((LoadEffectHandle(HY,h,175)))
		call DestroyEffect((LoadEffectHandle(HY,h,176)))
		call DestroyEffect((LoadEffectHandle(HY,h,177)))
		call UnitRemoveType(Target,UNIT_TYPE_PEON)
		call SaveInteger(HY,(GetHandleId((Hero))),(4256),2)
		call KillUnit(GID)
		call KillUnit(GJD)
		call DestroyUbersplat(Splat)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call DestroyEffect((LoadEffectHandle(HY,h,175)))
		call DestroyEffect((LoadEffectHandle(HY,h,176)))
		call DestroyEffect((LoadEffectHandle(HY,h,177)))
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl",GetUnitX(Hero),GetUnitY(Hero)))
		call SaveInteger(HY,(GetHandleId((Hero))),(4256),2)
		call KillUnit(GID)
		call KillUnit(GJD)
		call DestroyUbersplat(Splat)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveType(Target,UNIT_TYPE_PEON)
		call SetUnitX(Hero,GetUnitX(Target)-1)
		call SetUnitY(Hero,GetUnitY(Target)-1)
		call PauseUnit(Hero,true)
		call PauseUnit(Hero,false)
		call KillTrees(x,y,240)
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl",GetUnitX(Hero),GetUnitY(Hero)))
	endif
	set t=null
	set Hero=null
	set GID=null
	set GJD=null
	set Splat=null
	set Target=null
	return false
endfunction

function ShowTPTimer takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit hero=LoadUnitHandle(HY,h,0)
	local real time=LoadReal(HY,h,0)
	local real curtime=GetTriggerEvalCount(t)*0.5-0.5
	local texttag tt
	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST or curtime>=time then
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	else
		set tt=CreateTextTag()
		call SetTextTagText(tt,R2SW(time-curtime,1,1),.03)
		call SetTextTagPosUnit(tt,hero,0)
		call SetTextTagColorBJ(tt,150,75,255,15)
		call SetTextTagVelocity(tt,0,.035)
		call SetTextTagFadepoint(tt,3)
		call SetTextTagLifespan(tt,.5)
		call SetTextTagPermanent(tt,false)
		call SetTextTagVisibility(tt,IsUnitAlly(hero,GetLocalPlayer())or IsObserver(GetLocalPlayer()))
		set tt=null
	endif
	set t=null
	set hero=null
endfunction

function GND takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local real x
	local real y
	local real a
	local trigger t
	local integer h
	local unit GID
	local unit GJD
	local ubersplat Splat
	local integer id=GetPlayerId(GetOwningPlayer(Hero))
	local integer Count
	local real GOD
	local trigger tt
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call SaveInteger(HY,(GetHandleId((Hero))),(4256),1)
	if Target==null then
		set x=GetSpellTargetX()
		set y=GetSpellTargetY()
		if x==V17[id]and y==V07[id]then
			if IsSentinel(GetOwningPlayer(Hero))then
				set x=GetUnitX(SentFountain)
				set y=GetUnitY(SentFountain)
			else
				set x=GetUnitX(ScourgeFountain)
				set y=GetUnitY(ScourgeFountain)
			endif
		endif
		set Target=G9D(Hero,x,y)
	else
		set x=GetUnitX(Target)
		set y=GetUnitY(Target)
	endif
	if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))>WD7 then
		set a=Atan2(y-GetUnitY(Target),x-GetUnitX(Target))
		set x=GetUnitX(Target)+WD7*Cos(a)
		set y=GetUnitY(Target)+WD7*Sin(a)
	elseif DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<50 then
		set a=Atan2(y-GetUnitY(Target),x-GetUnitX(Target))
		set x=GetUnitX(Target)+120*Cos(a)
		set y=GetUnitY(Target)+120*Sin(a)
	endif
	if IsPointInRegion(RestrictedRegion,x,y) then
		set a=Atan2(y-GetUnitY(Target),x-GetUnitX(Target))
		set x=GetUnitX(Target)+200*Cos(a)
		set y=GetUnitY(Target)+200*Sin(a)
	endif
	set x=SafeX50(x)
	set y=SafeY50(y)
	if(IsUnitAlly(Hero,GetLocalPlayer())and GetLocalPlayer()!=GetOwningPlayer(Hero))or(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2))then
		call PingMinimapEx(x,y,3,255,255,255,false)
	endif
	set GJD=CreateUnit(GetOwningPlayer(Hero),F5D(id),x,y,0)
	set GID=CreateUnit(GetOwningPlayer(Hero),'h0AX',GetUnitX(Hero),GetUnitY(Hero),0)
	set Splat=CreateUbersplat(GetUnitX(Hero),GetUnitY(Hero),"SCTP",255,255,255,255,false,false)
	call SetUbersplatRenderAlways(Splat,IsUnitVisibleLoD(Hero,GetLocalPlayer()))
	set Count=F0D(GetPlayerId(GetOwningPlayer(Hero)),x,y)
	set GOD=3
  if Count>0 then
    set GOD=4.5+0.5*Count
  endif
	call F1D(GetPlayerId(GetOwningPlayer(Hero)),x,y)
	if Count>0 then
		call SetUnitAnimationByIndex(GID,2)
		call SetUnitAnimationByIndex(GJD,2)
	endif
	call TriggerRegisterTimerEvent(t,GOD-3,false)
	call TriggerRegisterTimerEvent(t,GOD,false)
	
	set tt=CreateTrigger()
	call TriggerRegisterTimerEvent(tt,0.5,true)
	call TriggerRegisterTimerEvent(tt,0,false)
	call SaveUnitHandle(HY,GetHandleId(tt),0,Hero)
	call SaveReal(HY,GetHandleId(tt),0,GOD)
	call TriggerAddCondition(tt,Condition(function ShowTPTimer))
	call TriggerRegisterUnitEvent(tt,Hero,EVENT_UNIT_SPELL_ENDCAST)
	
	set tt=null
	
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function GHD))
	call TimedReveal(GetOwningPlayer(Hero),GOD,x,y,200)
	call SaveUnitHandle(HY,h,447,(GJD))
	call SaveUnitHandle(HY,h,448,(GID))
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	call SaveReal(HY,h,442,(((TimerGetElapsed(GlobalTimer)))*1.))
	call SaveReal(HY,h,57,((GOD)*1.))
	call SaveUbersplatHandle(HY,h,131,(Splat))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveInteger(HY,h,34,0)
	call BB8(Hero,ZF,x,y,2400)
	set Hero=null
	set Target=null
	set GID=null
	set GJD=null
	set t=null
	set Splat=null
endfunction

function BootsOfTravelFilter2normal takes nothing returns boolean
	local real d
	local unit u=GetFilterUnit()
	if GetWidgetLife(u)>0 and IsUnitIdType(GetUnitTypeId(u),UNIT_TYPE_HERO)==false and GetUnitAbilityLevel(u,'Asud')==0 and (GetUnitAbilityLevel(u,'A04R')==0 or GetUnitTypeId(u)=='nfoh' or GetUnitTypeId(u)=='ndfl') and IsUnitAlly(u,GetOwningPlayer(tt_unit2)) and GetOwningPlayer(u)!=Player15 and IsUnitIllusion(u)==false  then//Asud -> Sell Units, , nfoh -> Well of Life, ndfl -> Defiled Fountain of Life, n0F5 -> Living Dead
		set d=DistanceBetweenXY(TJ,RJ,GetUnitX(u),GetUnitY(u))
		if d<tt_real1 then
			set tt_real1=d
			set tt_unit1=u
		endif
	endif
	set u=null
	return false
endfunction

function BootsOfTravelFilter2hero takes nothing returns boolean
	local real d
	if IsDead(GetFilterUnit())==false and GetFilterUnit()!=GetTriggerUnit() and GetUnitAbilityLevel(GetFilterUnit(),'Asud')==0 and (GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 or GetUnitTypeId(GetFilterUnit())=='nfoh' or GetUnitTypeId(GetFilterUnit())=='ndfl') and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit2)) and GetOwningPlayer(GetFilterUnit())!=Player15 then//Asud -> Sell Units, , nfoh -> Well of Life, ndfl -> Defiled Fountain of Life, n0F5 -> Living Dead
		set d=DistanceBetweenXY(TJ,RJ,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()))
		if d<tt_real1 then
			set tt_real1=d
			set tt_unit1=GetFilterUnit()
		endif
	endif
	return false
endfunction

function BootsOfTravelFilter takes unit whichUnit,real x,real y,boolean b returns unit
	local group g=GetAvailableGroup()
	set tt_unit1=null
	set tt_unit2=whichUnit
	set tt_real1=99999
	set TJ=x
	set RJ=y
	if b then
		call GroupEnumUnitsInRange(g,x,y,99999,Condition(function BootsOfTravelFilter2hero))
		
	else
		call GroupEnumUnitsInRange(g,x,y,99999,Condition(function BootsOfTravelFilter2normal))
		
	endif
	call KillGroup(g)
	return tt_unit1
endfunction

function GPD takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local real x
	local real y
	local real a
	local trigger t
	local integer h
	local unit GID
	local unit GJD
	local ubersplat Splat
	local integer id=GetPlayerId(GetOwningPlayer(Hero))
	local integer Count
	local real GOD
	local trigger tt
	
	set tt=CreateTrigger()
	call TriggerRegisterTimerEvent(tt,0.5,true)
	call TriggerRegisterTimerEvent(tt,0,false)
	call SaveUnitHandle(HY,GetHandleId(tt),0,Hero)
	call SaveReal(HY,GetHandleId(tt),0,3)
	call TriggerAddCondition(tt,Condition(function ShowTPTimer))
	call TriggerRegisterUnitEvent(tt,Hero,EVENT_UNIT_SPELL_ENDCAST)
	
	set tt=null
	set t=CreateTrigger()
	set h=GetHandleId(t)
	if Target==null then
		set x=GetSpellTargetX()
		set y=GetSpellTargetY()
		if x==V17[id]and y==V07[id]then
			if IsSentinel(GetOwningPlayer(Hero))then
				set x=GetUnitX(SentFountain)
				set y=GetUnitY(SentFountain)
			else
				set x=GetUnitX(ScourgeFountain)
				set y=GetUnitY(ScourgeFountain)
			endif
		endif
		if GetSpellAbilityId()=='A3AG' then
			set Target=BootsOfTravelFilter(Hero,x,y,true)
		else
			set Target=BootsOfTravelFilter(Hero,x,y,false)
		endif
	endif
	set x=GetUnitX(Target)
	set y=GetUnitY(Target)
	if(IsUnitAlly(Hero,GetLocalPlayer())and GetLocalPlayer()!=GetOwningPlayer(Hero))or(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2))then
		call PingMinimapEx(x,y,3,255,255,255,false)
	endif
	set Splat=CreateUbersplat(GetUnitX(Hero),GetUnitY(Hero),"SCTP",255,255,255,255,false,false)
	call SetUbersplatRenderAlways(Splat,IsUnitVisibleLoD(Hero,GetLocalPlayer()))
	set GOD=3
	call UnitAddType(Target,UNIT_TYPE_PEON)
	call TriggerRegisterTimerEvent(t,GOD,false)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function GMD))
	call TimedReveal(GetOwningPlayer(Hero),GOD,x,y,200)
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	call SaveReal(HY,h,442,(((TimerGetElapsed(GlobalTimer)))*1.))
	call SaveReal(HY,h,57,((GOD)*1.))
	call SaveUbersplatHandle(HY,h,131,(Splat))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,34,0)
	call SaveEffectHandle(HY,h,175,(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTo.mdl",Hero,"origin")))
	call SaveEffectHandle(HY,h,176,(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl",Hero,"origin")))
	call SaveEffectHandle(HY,h,177,(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTo.mdl",Target,"origin")))
	call BB8(Hero,ZF,x,y,2400)
	set Hero=null
	set Target=null
	set GID=null
	set GJD=null
	set t=null
	set Splat=null
endfunction

function BootsOfTravelUsed takes nothing returns nothing
	if GetSpellAbilityId()=='A1R5' and IsCourier(GetTriggerUnit())==false then//A1R5 -> Scroll of Teleporation (fixed)
		call GND()
	endif
	if GetSpellAbilityId()=='A231' or GetSpellAbilityId()=='A3AG' then//A231 -> Boots of Travel (fixed)
		call GPD()
	endif
endfunction

function IsNecronomiconSummon takes unit u returns boolean
	local integer i=GetUnitTypeId(u)
	return i=='n00H' or i=='n00G' or i=='n00K' or i=='n00J' or i=='n00A' or i=='n006'
endfunction

function NecronomiconSummonFilter takes nothing returns boolean
	if IsNecronomiconSummon(GetFilterUnit()) then
		if LoadInteger(TempHash,0,0)==LoadInteger(HY,GetHandleId(GetFilterUnit()),784) then
			call KillUnit(GetFilterUnit())
		endif
	endif
	return false
endfunction

function NecronomiconSummoning takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit archer
	local unit warrior
	local integer archid
	local integer warid
	local group g=GetAvailableGroup()
	local real a=GetUnitFacing(caster)*bj_DEGTORAD
	local real x1=GetUnitX(caster)+50*Cos(a)
	local real y1=GetUnitY(caster)+50*Sin(a)
	local real x2=GetUnitX(caster)+50*Cos(a)
	local real y2=GetUnitY(caster)+50*Sin(a)
	local integer i=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetTriggerPlayer())],'A0A8')
	if GetSpellAbilityId()=='A0HB' then
		set archid='n00H'
		set warid='n00J'
	elseif GetSpellAbilityId()=='A0D3' then
		set archid='n00G'
		set warid='n00A'
	elseif GetSpellAbilityId()=='A0DF' then
		set archid='n00K'
		set warid='n006'
	endif
	call SaveInteger(TempHash,0,0,GetHandleId(caster))
	call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(GetTriggerUnit()),Condition(function NecronomiconSummonFilter))
	call KillGroup(g)
	set archer=CreateUnit(GetOwningPlayer(caster),archid,x1,y1,GetUnitFacing(caster))
	call SaveInteger(HY,GetHandleId(archer),784,GetHandleId(caster))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",archer,"origin"))
	call UnitApplyTimedLife(archer,'BTLF',40)
	set warrior=CreateUnit(GetOwningPlayer(caster),warid,x2,y2,GetUnitFacing(caster))
	call SaveInteger(HY,GetHandleId(warrior),784,GetHandleId(caster))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",warrior,"origin"))
	call UnitApplyTimedLife(warrior,'BTLF',40)
	if i>0 then
		call UnitAddAbility2(archer,'A43C')
		call LoDStat_Add(archer,20+10*i,"attack")
		call LoDStat_Add(warrior,20+10*i,"attack")
	endif
	set g=null
	set archer=null
	set warrior=null
	set caster=null
endfunction

function GVD takes nothing returns nothing
	call UnitAddAbilityTimedExF(GetTriggerUnit(),'A1CN',1,4,0)//A1CN -> Item Life Steal 200%
endfunction

function GWDb takes nothing returns nothing
	local unit u= GetSpellTargetUnit()
	local integer info
	local integer pid=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
	if IsSentinel(Player(pid)) then
		call UnitShareVision(u,Scourges[0],false)
		call UnitShareVision(u,Scourges[1],false)
		call UnitShareVision(u,Scourges[2],false)
		call UnitShareVision(u,Scourges[3],false)
		call UnitShareVision(u,Scourges[4],false)
		call UnitShareVision(u,Scourges[5],false)
	else
		call UnitShareVision(u,Sentinels[0],false)
		call UnitShareVision(u,Sentinels[1],false)
		call UnitShareVision(u,Sentinels[2],false)
		call UnitShareVision(u,Sentinels[3],false)
		call UnitShareVision(u,Sentinels[4],false)
		call UnitShareVision(u,Sentinels[5],false)
	endif
	call UnitAddAbility(u,'ACrk')//ACrk -> Resistant Skin
	call UnitRefillMana(u)
	call SetWidgetLife(u,99999)
	set info = GetHandleId(GetTriggerUnit())
	call KillUnit(LoadUnitHandle(MHT,info,'ACch'))//ACch -> Helm of the Dominator
	call SaveUnitHandle(MHT,info,'ACch',u)//ACch -> Helm of the Dominator
	if GetUnitState(u,UNIT_STATE_MAX_LIFE)<1400 then
		call AddMaxHPFx(u,R2I(1400-GetUnitState(u,UNIT_STATE_MAX_LIFE)))
	endif
	set u = null
endfunction

function GXD takes integer i returns integer//bkb shells 10-4
	local integer lvl=LoadInteger(HeroStats,GetHandleId(GetOwningPlayer(GetTriggerUnit())),'0BKB')
	if (i=='A11F' or i=='A11E' or i=='A0S3' or i=='A11D' or i=='A11G' or i=='A11H')==false then//A11F -> Avatar, A11E -> Avatar, A0S3 -> Avatar, A11D -> Avatar, A11G -> Avatar, A11H -> Avatar
		return 0
	endif
	if lvl==0 then
		return 'A11B'//A11B -> Avatar
	elseif lvl==9 then
		return 'A11A'//A11A -> Avatar
	elseif lvl==8 then
		return 'A0S2'//A0S2 -> Avatar
	elseif lvl==7 then
		return 'A119'//A119 -> Avatar
	elseif lvl==6 then
		return 'A11C'//A11C -> Avatar
	elseif lvl==5 then
		return 'A118'//A118 -> Avatar
	endif
	return 0
endfunction

function GYD takes integer i returns integer
	local integer lvl=LoadInteger(HeroStats,GetHandleId(GetOwningPlayer(GetTriggerUnit())),'0BKB')
	if lvl==0 then
		return 10
	else
		return lvl
	endif
	return 0
endfunction

function GZD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	if IsDead(Hero)==false and Hero!=null then
		call SetUnitScale(Hero,U18(Hero),U18(Hero),U18(Hero))
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	return false
endfunction

function GAD takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
	local trigger t=CreateTrigger()
	local real DP9=GYD(GetSpellAbilityId())
	call A68(Hero,WS7,DP9)
	call UnitMakeAbilityPermanent(Hero,true,WS7)
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),WS7,false)
	call UnitMakeAbilityPermanent(Hero,true,'A0S6')
	call UnitAddAbility(Caster,GXD(GetSpellAbilityId()))
	call IssueTargetOrderById(Caster,852186,Hero)
	call PurgingTriggered(Hero,false)
	call PurgingTriggeredSpellImmune(Hero)
	if IsCourier(Hero)then
		call AA8(Hero,DP9,3)
	else
		call AA8(Hero,DP9,1.4)
	endif
	call TriggerRegisterTimerEvent(t,DP9+7,false)
	call TriggerAddCondition(t,Condition(function GZD))
	call SaveUnitHandle(HY,(GetHandleId(t)),14,(Hero))
	set t=null
	set Hero=null
	set Caster=null
endfunction

function GBD takes nothing returns nothing
	if GXD(GetSpellAbilityId())>0 then
		call GAD()
	endif
endfunction

function GCD takes nothing returns nothing
	if((LoadInteger(HY,(GetHandleId((GetEnumUnit()))),(4258)))==1) then
		call Error(GetOwningPlayer(GetEnumUnit()),GetObjectName('n02M')+" "+GetUnitName(GetEnumUnit())+" "+GetObjectName('n02S'))//n02M -> Mekansm failed to heal, n02S -> because it has been healed by Mekansm in the past 25 seconds
	else
		if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
			call AddTimedKeyToUnit(GetEnumUnit(),4258,25)
		endif
		call SetWidgetLife(GetEnumUnit(),GetWidgetLife(GetEnumUnit())+250)
	endif
endfunction

function G3D takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),925,Condition(function L18))
	call ForGroup(g,function GCD)
	call KillGroup(g)
	set Source=null
	set g=null
endfunction

function GLD takes nothing returns nothing
	if((LoadInteger(HY,(GetHandleId((GetEnumUnit()))),(4278)))==1) then
		call Error(GetOwningPlayer(GetEnumUnit()),GetObjectName('n02M'))//n02M -> Mekansm failed to heal
	else
		if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
			call AddTimedKeyToUnit(GetEnumUnit(),4278,50)
		endif
		if GetUnitAbilityLevel(GetEnumUnit(),'B0BT')==0 and GetUnitAbilityLevel(GetEnumUnit(),'B0BU')==0 then//B0BT -> Khadgar's Pipe of Insight, B0BU -> Khadgar's Pipe of Insight
			call IssueTargetOrderById(WT7,852186,GetEnumUnit())
		endif
	endif
endfunction

function PipeOfInsightBarrierFilter takes nothing returns boolean
	return IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function G1D takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local group g=GetAvailableGroup()
	set WT7=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
	call UnitAddAbility(WT7,'A1EV')//A1EV -> Pipe of Insight barrier
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),525,Condition(function PipeOfInsightBarrierFilter))
	call ForGroup(g,function GLD)
	call KillGroup(g)
	set Source=null
	set g=null
endfunction

function G5D takes nothing returns nothing
	if GetSpellAbilityId()=='A02W' then//A02W -> Item Cooldown Reset
		call FlushChildHashtable(CooldownStorage,GetHandleId(GetTriggerUnit()))
		call UnitResetCooldown(GetTriggerUnit())
		call RemoveAbilsForUnit(GetTriggerUnit())
	endif
endfunction

function G2D takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=LoadUnitHandle(HY,h,30)
	local real Damage=(LoadReal(HY,h,20))
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED or GetUnitAbilityLevel(GetTriggerUnit(),'B031')==0 then//B031 -> Orchid Malevolence
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call DamageTarget(Source,Target,1,Damage)
		if Damage>0 then
			call TextTagOnUnit("+"+I2S(R2I(Damage)),1,Target,.023,255,0,0,216)
		endif
	elseif GetEventDamage()>1 then
		if IsRealDamage then
			call SaveReal(HY,h,20,Damage+GetEventDamage()*0.3)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function H4D takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,30,((Target)))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Silence\\SilenceTarget.mdl",Target,"overhead")))
	call SaveReal(HY,h,20,0)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerRegisterTimerEvent(t,5,false)
	call TriggerAddCondition(t,Condition(function G2D))
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function H7D takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function H4D))
	call SaveUnitHandle(HY,h,17,(GetSpellTargetUnit()))
	call SaveUnitHandle(HY,h,2,(GetTriggerUnit()))
	set t=null
endfunction

function H8D takes nothing returns nothing
	if GetSpellAbilityId()=='A0FD' and IsBlocked(GetSpellTargetUnit())==false then//A0FD -> Orchid Malevolence
		call H7D()
	endif
endfunction

function H9D takes unit u,real d returns boolean
	if IsUnitType(u,UNIT_TYPE_HERO)or GetUnitAbilityLevel(u,'A04R')>0 then//
		return d>5
	endif
	return true
endfunction

function HDD takes unit u returns unit
	local group g
	if GetUnitAbilityLevel(u,'A04R')==0 then//
		return u
	endif
	set tt_unit1=GetTriggerUnit()
	set g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),900,Condition(function DefaultEnemyFilter))
	set WU7=FirstOfGroup(g)
	call KillGroup(g)
	set g=null
	return WU7
endfunction

function StaticChargeAoE takes nothing returns nothing
	local unit u
	if StaticChargeCounter>0 then
		set StaticChargeCounter=StaticChargeCounter-1
		set u=CreateUnit(GetOwningPlayer(StaticChargeCaster),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)//e00E -> Spellcaster
		call UnitAddAbility(u,'A0K6')//A0K6 -> Mjollnir
		call IssueTargetOrder(u,"forkedlightning",GetEnumUnit())
		set u=null
	endif
endfunction

function HED takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Caster
	local unit u=LoadUnitHandle(HY,h,0)
	local group g
	if GetUnitAbilityLevel(u,'A3KI')==0 then
		//call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		set g=GetAvailableGroup()
		set u=(LoadUnitHandle(HY,h,2))
		set Caster=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)//e00E -> Spellcaster
		call AddTimedKeyToUnit(GetTriggerUnit(),4257,1)
		call UnitAddAbility(Caster,'A0K6')//A0K6 -> Mjollnir
		set StaticChargeCaster=u
		set StaticChargeCounter=6
		call GroupEnumUnitsInRange(g,GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),925,Condition(function NonImmuneEnemyFilter))
		if DistanceBetweenUnits(GetTriggerUnit(),GetEventDamageSource())<900 then
			if IssueTargetOrderById(Caster,852587,HDD(GetEventDamageSource())) then
				set StaticChargeCounter=5
			endif
		endif
		call ForGroup(g,function StaticChargeAoE)
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Caster=null
	set u=null
endfunction

function HFD takes nothing returns boolean
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED or (H9D(GetEventDamageSource(),GetEventDamage()) and IsUnitEnemy(GetEventDamageSource(),GetOwningPlayer(GetTriggerUnit())) and GetRandomInt(1,100)<21 and LoadInteger(HY,GetHandleId(GetTriggerUnit()),4257)!=1) then
		call HED()
	endif
	return false
endfunction

function Func0821 takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	if target==null then
		set target=caster
	endif
	call UnitAddAbilityTimedExF(target,'A3KI',1,15,'B3KI')
	//call AddTimedKeyToUnit(target,4279,15)
	call TriggerRegisterTimerEvent(t,0.1,true)
	call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function HFD))
	//call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\LightningShield\\LightningShieldTarget.mdl",target,"origin")))
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveUnitHandle(HY,h,0,target)
	set t=null
	set caster=null
	set target=null
endfunction

function MjollnirLightnings takes unit attacker, unit target returns nothing
	local integer id=0
	local integer chance=0
	local unit dummy
	if GetUnitAbilityLevel(attacker,'A0JH')>0 then//A0JH -> Mjollnir
		set id='A0JK'//A0JK -> Mjollnir lightning
		set chance=25
	else
		set id='A0FK'//A0FK -> Maelstrom lightning
		set chance=25
	endif
	if PRD_Get(attacker,id,chance) then
		set dummy=CreateUnit(GetOwningPlayer(attacker),'e00E',GetUnitX(attacker),GetUnitY(attacker),0)//e00E -> Spellcaster
		call UnitAddAbility(dummy,id)
		call IssueTargetOrder(dummy,"chainlightning",target)
		set dummy=null
	endif
endfunction

function ManaBurnCommon takes unit attacker, unit target, real burn returns nothing
	local real mp=GetUnitState(target,UNIT_STATE_MANA)
	set burn=RMinIF(mp,burn)
	if mp > 0 and IsMagicImmune(target)==false then
		call DamageTarget(attacker,target,2,burn)
		call SetUnitState(target,UNIT_STATE_MANA,mp-burn)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Feedback\\ArcaneTowerAttack.mdl",target,"origin"))
	endif
endfunction

function DiffusalBladeAct takes unit attacker, unit target returns nothing
	if IsUnitIllusion(attacker) and IsUnitType(attacker,UNIT_TYPE_MELEE_ATTACKER)==false then
		call ManaBurnCommon(attacker,target,12)
	else
		call ManaBurnCommon(attacker,target,25)
	endif
	
endfunction

function HID takes nothing returns nothing
	local unit HJD=GetTriggerUnit()
	local item FYD=ZE8(HJD,Item_Real[RecipeFlyingCourier])
	if FYD==null then
		set FYD=ZE8(HJD,Item_Mute[RecipeFlyingCourier])
	endif
	if FYD!=null then
		call DestroyItem(FYD)
		call UnitRemoveAbility(HJD,'A0VR')//A0VR -> Mana Upgrade
		call UnitAddAbility(HJD,'A0VU')//A0VU -> Item Mana Bonus 400
		call SetUnitState(HJD,UNIT_STATE_MANA,400)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIem\\AIemTarget.mdl",HJD,"origin"))
	else
		call Error(GetOwningPlayer(HJD),GetObjectName('n02Q'))//n02Q -> Recipe requirements not complete!
	endif
	set HJD=null
	set FYD=null
endfunction

function BreakRemoveVampiricAuraForGroup takes nothing returns nothing
	call UnitRemoveAbility(GetEnumUnit(),'BVA1')//BVA1 -> Vampiric Aura
	call UnitRemoveAbility(GetEnumUnit(),'BVA2')//BVA2 -> Vampiric Aura
	call UnitRemoveAbility(GetEnumUnit(),'BVA3')//BVA3 -> Vampiric Aura
	call UnitRemoveAbility(GetEnumUnit(),'BVA4')//BVA4 -> Vampiric Aura
endfunction

function DefaultAllyFilter takes nothing returns boolean
	return IsUnitAlly(tt_unit1,GetOwningPlayer(GetFilterUnit())) and AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function DefaultAllyFilterHeroOnly takes nothing returns boolean
	return DefaultAllyFilter() and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)
endfunction

function BreakSwitcher takes unit u, player p, boolean b returns nothing
	local group g
	
	call SetPlayerAbilityAvailable(p,'A1J2',b)//bounty hunter//A1J2 -> Jinada Critical - 1
	call SetPlayerAbilityAvailable(p,'A1IT',b)//A1IT -> Jinada Critical - 2
	call SetPlayerAbilityAvailable(p,'A1J1',b)//A1J1 -> Jinada Critical - 3
	call SetPlayerAbilityAvailable(p,'A1J0',b)//A1J0 -> Jinada Critical - 4
	call SetPlayerAbilityAvailable(p,'A1IS',b)//A1IS -> Jinada FX
	
	call SetPlayerAbilityAvailable(p,'A34E',b)
	call SetPlayerAbilityAvailable(p,'A34F',b)
	
	call SetPlayerAbilityAvailable(p,'A0AH',b)//lone druid demolish//A0AH -> Demolish
	
	call SetPlayerAbilityAvailable(p,'A09E',b)//troll's bash//A09E -> Bash
	
	if b==false then
		call UnitRemoveAbility(u,'B03X')//B03X -> Unstable Current
	endif
	if b==false then
		call UnitRemoveAbility(u,'BOac')
	endif
	if b==false then
		call UnitRemoveAbility(u,'B01W')//B01W -> Lunar Blessing
	endif
	
	if GetUnitAbilityLevel(u,'P279')>0 or GetUnitAbilityLevel(u,'A3BF')>0 and IsUnitIllusion(u)==false then//viper
		if b then
			call UnitRemoveAbility(u,'A3BF')
		else
			call UnitAddAbility2(u,'A3BF')
			call HideAbility('A3BF')
		endif
	endif
	
	if b==false then
		call UnitRemoveAbility(u,'B00E')//B00E -> Inner Beast
	endif
	if GetUnitAbilityLevel(u,'P135')>0 or GetUnitAbilityLevel(u,'A373')>0 and IsUnitIllusion(u)==false then//spell shield
		if b then
			call UnitRemoveAbility(u,'A374')
		else
			call UnitAddAbility2(u,'A374')
			call HideAbility('A374')
		endif
	endif
	
	if b==false then
		call UnitRemoveAbility(u,'B07M')//B07M -> Brilliance Aura
	endif
	
	
	call SetPlayerAbilityAvailable(p,'P131',b)//dk dragon blood regen
	if GetUnitAbilityLevel(u,'P131')>0 and IsUnitIllusion(u)==false then//dk dragon blood
		if b then
			call UnitRemoveAbility(u,'A375')
		else
			call UnitAddAbility2(u,'A375')
			call SetUnitAbilityLevel(u,'A375',GetUnitAbilityLevel(u,'P131'))
		endif
	endif
	
	call SetPlayerAbilityAvailable(p,'A03B',b)//lycan crit//A03B -> Crit Strike
	
	call SetPlayerAbilityAvailable(p,'A0ZJ',b)//lycan passive//A0ZJ -> Feral Heart Caster lvl 1
	call SetPlayerAbilityAvailable(p,'A0ZI',b)//lycan passive//A0ZI -> Feral Heart Caster lvl 2
	call SetPlayerAbilityAvailable(p,'A0ZH',b)//lycan passive//A0ZH -> Feral Heart Caster lvl 3
	call SetPlayerAbilityAvailable(p,'A0ZG',b)//lycan passive//A0ZG -> Feral Heart Caster lvl 4
	
	if b==false then
		call UnitRemoveAbility(u,'B09B')//lycan debuffs//B09B -> Feral Impulse|n|cff4F4F4FLevel:|r 1
		call UnitRemoveAbility(u,'B09A')//lycan debuffs//B09A -> Feral Impulse|n|cff4F4F4FLevel:|r 2
		call UnitRemoveAbility(u,'B097')//lycan debuffs//B097 -> Feral Impulse|n|cff4F4F4FLevel:|r 3
		call UnitRemoveAbility(u,'B09D')//lycan debuffs//B09D -> Feral Impulse|n|cff4F4F4FLevel:|r 4
	endif
	
	if b==false then
		call UnitRemoveAbility(u,'BVA1')//vampiric aura//BVA1 -> Vampiric Aura
		call UnitRemoveAbility(u,'BVA2')//BVA2 -> Vampiric Aura
		call UnitRemoveAbility(u,'BVA3')//BVA3 -> Vampiric Aura
		call UnitRemoveAbility(u,'BVA4')//BVA4 -> Vampiric Aura
	endif
	
	if b==false then
		set g=GetAvailableGroup()
		set tt_unit1=u
		call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),900,Condition(function DefaultAllyFilter))
		call ForGroup(g,function BreakRemoveVampiricAuraForGroup)
		call KillGroup(g)
	endif
	
	call SetPlayerAbilityAvailable(p,'A1JT',b)//visage's cloak//A1JT -> Visage Shell - 1,1
	call SetPlayerAbilityAvailable(p,'A1K6',b)//A1K6 -> IceShell Magic 1,1
	call SetPlayerAbilityAvailable(p,'A1JU',b)//A1JU -> IceShell - 1,2
	call SetPlayerAbilityAvailable(p,'A1K7',b)//A1K7 -> IceShell Magic 1,2
	call SetPlayerAbilityAvailable(p,'A1JV',b)//A1JV -> IceShell - 1,3
	call SetPlayerAbilityAvailable(p,'A1K8',b)//A1K8 -> IceShell Magic 1,3
	call SetPlayerAbilityAvailable(p,'A1JC',b)//A1JC -> IceShell - 1,4
	call SetPlayerAbilityAvailable(p,'A1K9',b)//A1K9 -> IceShell Magic 1,4
	
	call SetPlayerAbilityAvailable(p,'A1JF',b)//A1JF -> IceShell - 2,1
	call SetPlayerAbilityAvailable(p,'A1KB',b)//A1KB -> IceShell Magic 2,1
	call SetPlayerAbilityAvailable(p,'A1JG',b)//A1JG -> IceShell - 2,2
	call SetPlayerAbilityAvailable(p,'A1KC',b)//A1KC -> IceShell Magic 2,2
	call SetPlayerAbilityAvailable(p,'A1JH',b)//A1JH -> IceShell - 2,3
	call SetPlayerAbilityAvailable(p,'A1KD',b)//A1KD -> IceShell Magic 2,3
	call SetPlayerAbilityAvailable(p,'A1JI',b)//A1JI -> IceShell - 2,4
	call SetPlayerAbilityAvailable(p,'A1K5',b)//A1K5 -> IceShell Magic 2,4
	
	call SetPlayerAbilityAvailable(p,'A1JJ',b)//A1JJ -> IceShell - 3,1
	call SetPlayerAbilityAvailable(p,'A1KH',b)//A1KH -> IceShell Magic 3,1
	call SetPlayerAbilityAvailable(p,'A1JL',b)//A1JL -> IceShell - 3,2
	call SetPlayerAbilityAvailable(p,'A1K4',b)//A1K4 -> IceShell Magic 3,2
	call SetPlayerAbilityAvailable(p,'A1JM',b)//A1JM -> IceShell - 3,3
	call SetPlayerAbilityAvailable(p,'A1KI',b)//A1KI -> IceShell Magic 3,3
	call SetPlayerAbilityAvailable(p,'A1JN',b)//A1JN -> IceShell - 3,4
	call SetPlayerAbilityAvailable(p,'A1KJ',b)//A1KJ -> IceShell Magic 3,4
	
	call SetPlayerAbilityAvailable(p,'A1JQ',b)//A1JQ -> IceShell - 4,1
	call SetPlayerAbilityAvailable(p,'A1KM',b)//A1KM -> IceShell Magic 4,1
	call SetPlayerAbilityAvailable(p,'A1JR',b)//A1JR -> IceShell - 4,2
	call SetPlayerAbilityAvailable(p,'A1KN',b)//A1KN -> IceShell Magic 4,2
	call SetPlayerAbilityAvailable(p,'A1JX',b)//A1JX -> IceShell - 4,3
	call SetPlayerAbilityAvailable(p,'A1K0',b)//A1K0 -> IceShell Magic 4,3
	call SetPlayerAbilityAvailable(p,'A1JY',b)//A1JY -> IceShell - 4,4
	call SetPlayerAbilityAvailable(p,'A1K3',b)//A1K3 -> IceShell Magic 4,4
	
endfunction

function BreakDummyCreate takes unit u returns nothing
	local player p=GetOwningPlayer(u)
	call KillUnit(LoadUnitHandle(HY,GetHandleId(p),'brek'))
	call SaveUnitHandle(HY,GetHandleId(p),'brek',CreateUnit(p,'e00L',0,0,0))
	call ShowUnit(LoadUnitHandle(HY,GetHandleId(p),'brek'),false)
	call PauseUnit(LoadUnitHandle(HY,GetHandleId(p),'brek'),true)
endfunction

function BreakDummyKill takes unit u returns nothing
	local player p=GetOwningPlayer(u)
	call KillUnit(LoadUnitHandle(HY,GetHandleId(p),'brek'))
endfunction

function BreakRemove takes unit u returns nothing
	call BreakSwitcher(u,GetOwningPlayer(u),true)
	call UnitRemoveAbility(u,'A36D')
	call UnitRemoveAbility(u,'B36D')
	if IsUnitType(u,UNIT_TYPE_HERO) then
		call BreakDummyCreate(u)
	endif
endfunction

function BreakAdd takes unit u returns nothing
	call BreakSwitcher(u,GetOwningPlayer(u),false)
	if IsUnitType(u,UNIT_TYPE_HERO) then
		call BreakDummyKill(u)
	endif
endfunction

function BreakDur takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer c=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		if c<=1 then
			call RemoveSavedHandle(HY,GetHandleId(u),'BREK')
			call FlushChildHashtable(HY,h)
			call DisableTrigger(t)
			call DestroyTrigger(t)
			call BreakRemove(u)
			//call echo("break expirated")
		else
			call SaveInteger(HY,h,0,c-1)
			//call echo("break expirated, "+I2S(LoadInteger(HY,h,0))+" left")
		endif
	else
		call RemoveSavedHandle(HY,GetHandleId(u),'BREK')
		call FlushChildHashtable(HY,h)
		call DisableTrigger(t)
		call DestroyTrigger(t)
		call BreakRemove(u)
		//call echo("break expirated cause death")
		
	endif
	
	
	set t=null
endfunction

function Break takes unit u, real dur returns nothing
	local trigger t
	local integer h
	local integer hu=GetHandleId(u)
	if HaveSavedHandle(HY,hu,'BREK') then
		set t=LoadTriggerHandle(HY,hu,'BREK')
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,dur,false)
		call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
		//call echo("added break for "+R2S(dur))
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,hu,'BREK',t)
		call TriggerRegisterTimerEvent(t,dur,false)
		call TriggerRegisterDeathEvent(t,u)
		call SaveInteger(HY,h,0,1)
		call SaveUnitHandle(HY,h,0,u)
		call UnitAddAbility2(u,'A36D')
		call TriggerAddCondition(t,Condition(function BreakDur))
		call BreakAdd(u)
		//call echo("added new break for "+R2S(dur))
	endif
	set t=null
endfunction

function HMD takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local group HND=WW7
	local unit Source=WX7
	if IsUnitInGroup(Target,HND)==false then
		call GroupAddUnit(HND,Target)
		call IssueTargetOrderById(WY7,852075,Target)
		call DamageTarget(Source,Target,1,200)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\FrostNova\\FrostNovaTarget.mdl",Target,"origin"))
	endif
	set Target=null
	set HND=null
	set Source=null
endfunction

function HOD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local group HND=(LoadGroupHandle(HY,h,133))
	local real d
	local real x
	local real x0=GetUnitX(Source)
	local real y
	local real y0=GetUnitY(Source)
	local group g=GetAvailableGroup()
	local integer Count=GetTriggerEvalCount(t)
	local integer i
	call SetUnitX(Caster,GetUnitX(Source))
	call SetUnitY(Caster,GetUnitY(Source))
	set WW7=HND
	set WX7=Source
	set WY7=(LoadUnitHandle(HY,h,132))
	if GetTriggerEvalCount(t)>33 then
		call KillUnit(Caster)
		call KillGroup(HND)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set d=Count*21
		set i=0
		loop
			exitwhen i>36
			set x=x0+d*Cos(360*i/ 36*bj_DEGTORAD)
			set y=y0+d*Sin(360*i/ 36*bj_DEGTORAD)
			set tt_unit1=Source
			call GroupEnumUnitsInRange(g,x,y,150,Condition(function LT8))
			call ForGroup(g,function HMD)
			set i=i+1
		endloop
	endif
	call KillGroup(g)
	set t=null
	set Caster=null
	set HND=null
	set Source=null
	set g=null
	return false
endfunction

function PhaseBootsRemoveImmolationB takes nothing returns nothing
	local timer t=GetExpiredTimer()
	call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'BEim')
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTimer(t)
	set t=null
endfunction

function PhaseBootsRemoveImmolation takes unit u returns nothing
	local timer t=CreateTimer()
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call TimerStart(t,0,false,function PhaseBootsRemoveImmolationB)
	set t=null
endfunction

function HPD takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real x=GetUnitX(Hero)
	local real y=GetUnitY(Hero)
	local group HND=GetAvailableGroup()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'h091',x,y,0)//h091 -> Shivas Guard
	local unit HQD=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
	call UnitAddAbility(HQD,'A0T0')//A0T0 -> MageArmor
	call SaveGroupHandle(HY,h,133,(HND))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveUnitHandle(HY,h,132,(HQD))
	call SaveUnitHandle(HY,h,2,(Hero))
	call TriggerRegisterTimerEvent(t,.06,true)
	call TriggerAddCondition(t,Condition(function HOD))
	call PhaseBootsRemoveImmolation(Hero)
	set t=null
	set HND=null
	set Caster=null
	set HQD=null
	set Hero=null
endfunction

function HSD takes unit Source,integer HTD returns nothing
	local integer h=GetHandleId(Source)
	call SaveInteger(HY,h,750,(HTD))
endfunction

function HUD takes nothing returns nothing
	local integer i=0
	local integer charges=0
	local boolean HVD=false
	if GetSpellAbilityId()=='A0JY' then//A0JY -> Magic Stick
		loop
			exitwhen i>5
			if (F49(UnitItemInSlot(GetTriggerUnit(),i)))==MagicStick or (F49(UnitItemInSlot(GetTriggerUnit(),i)))==MagicWand then
				set charges=GetItemCharges(UnitItemInSlot(GetTriggerUnit(),i))
				if charges>0 then
					call SetItemCharges(UnitItemInSlot(GetTriggerUnit(),i),0)
					call HSD(GetTriggerUnit(),0)
					if HVD==false then
						set HVD=true
						call SetUnitState(GetTriggerUnit(),UNIT_STATE_MANA,GetUnitState(GetTriggerUnit(),UNIT_STATE_MANA)+15*charges)
						call SetWidgetLife(GetTriggerUnit(),GetWidgetLife(GetTriggerUnit())+15*charges)
						call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIre\\AIreTarget.mdl",GetTriggerUnit(),"origin"))
					endif
				endif
				return
			endif
			set i=i+1
		endloop
	endif
endfunction

function IsNotADummyAbility takes integer id returns boolean
	local integer i=1
	loop
		exitwhen i>SomeDummyAbilitiesCounter
		if id==SomeDummyAbilitiesList[i]then
			return false
		endif
		set i=i+1
	endloop
	return true
endfunction

function HZD takes nothing returns nothing
	local unit u=GetEnumUnit()
	local integer i=0
	local integer c
	local integer id
	local integer lim
	local item it
	if IsUnitVisibleLoD(GetTriggerUnit(),GetOwningPlayer(u)) then
		loop
			set it=UnitItemInSlot(u,i)
			set id=F49(it)
			if id==MagicStick or id==MagicWand then
				if id==MagicStick then
					set lim=10
				else
					set lim=17
				endif
				set c=GetItemCharges(it)
				call HSD(u,IMinIF(c+1,lim))
				call SetItemCharges(it,IMinIF(c+1,lim))
				call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"chest"))
				set i=5
			endif
			set i=i+1
			exitwhen i>5
		endloop
		endif
	set it=null
	set u=null
endfunction

function HAD takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit Source=GetTriggerUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	call GroupEnumUnitsInRange(g,x,y,1225,Condition(function D89))
	call ForGroup(g,function HZD)
	call KillGroup(g)
	set g=null
	set Source=null
endfunction

function HBD takes nothing returns nothing
	if IsNotADummyAbility(GetSpellAbilityId()) and isAintItemAbility(GetSpellAbilityId()) and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 and isDummyAbility(GetSpellAbilityId())==false then//
		call HAD()
	endif
endfunction

function HCD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit H3D=(LoadUnitHandle(HY,h,134))
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call UnitRemoveAbility(H3D,'A17R')//A17R -> Fortification Armor Bonus
		call UnitRemoveAbility(H3D,'A24F')//A24F -> Fortify Spell Damage Reduction
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set H3D=null
	return false
endfunction

function H6D takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)and GetWidgetLife(GetFilterUnit())>.5 and IsUnitAlly(GetFilterUnit(),WZ7) and GetOwningPlayer(GetFilterUnit())!=Player15 and GetUnitTypeId(GetFilterUnit())!='ncop' and GetUnitTypeId(GetFilterUnit())!='n0FJ' and GetUnitTypeId(GetFilterUnit())!='n0FI' and GetUnitTypeId(GetFilterUnit())!='n0F6' and GetUnitTypeId(GetFilterUnit())!='n0FH')!=null//ncop -> Circle of Power, n0FJ -> Tombstone - Level 1, n0FI -> Tombstone - Level 2, n0F6 -> Tombstone - Level 3, n0FH -> Tombstone - Level 4
endfunction

function HLD takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit H3D=GetEnumUnit()
	local string s
	call UnitAddAbility(H3D,'A17R')//A17R -> Fortification Armor Bonus
	call UnitAddAbility(H3D,'A24F')//A24F -> Fortify Spell Damage Reduction
	if IsSentinel(WZ7)then
		set s="effects\\GlyphSent.mdx"
	else
		set s="effects\\GlyphScourge.mdx"
	endif
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget(s,H3D,"origin")))
	call SaveUnitHandle(HY,h,134,(H3D))
	call TriggerRegisterUnitEvent(t,H3D,EVENT_UNIT_DEATH)
	call TriggerRegisterTimerEvent(t,4,false)
	call TriggerAddCondition(t,Condition(function HCD))
	set t=null
	set H3D=null
endfunction

function H1D takes unit u,player p returns nothing
	local integer i
	if IsSentinel(p)then
		set i=1
		if u!=CirclesOfPower[i]then
			call IssueImmediateOrderById(CirclesOfPower[i],852244)
		endif
		set i=2
		if u!=CirclesOfPower[i]then
			call IssueImmediateOrderById(CirclesOfPower[i],852244)
		endif
		set i=3
		if u!=CirclesOfPower[i]then
			call IssueImmediateOrderById(CirclesOfPower[i],852244)
		endif
		set i=4
		if u!=CirclesOfPower[i]then
			call IssueImmediateOrderById(CirclesOfPower[i],852244)
		endif
		set i=5
		if u!=CirclesOfPower[i]then
			call IssueImmediateOrderById(CirclesOfPower[i],852244)
		endif
	else
		set i=7
		if u!=CirclesOfPower[i]then
			call IssueImmediateOrderById(CirclesOfPower[i],852244)
		endif
		set i=8
		if u!=CirclesOfPower[i]then
			call IssueImmediateOrderById(CirclesOfPower[i],852244)
		endif
		set i=9
		if u!=CirclesOfPower[i]then
			call IssueImmediateOrderById(CirclesOfPower[i],852244)
		endif
		set i=10
		if u!=CirclesOfPower[i]then
			call IssueImmediateOrderById(CirclesOfPower[i],852244)
		endif
		set i=11
		if u!=CirclesOfPower[i]then
			call IssueImmediateOrderById(CirclesOfPower[i],852244)
		endif
	endif
endfunction

function H5D takes nothing returns nothing
	local group g
	local unit u=GetTriggerUnit()
	local player p=GetOwningPlayer(u)
	if(IsSentinel(p)and WA7==false)or(IsSentinel(p)==false and WB7==false)then
		set g=GetAvailableGroup()
		set WZ7=p
		call GroupEnumUnitsInRange(g,0,0,12000,Condition(function H6D))
		call ForGroup(g,function HLD)
		call KillGroup(g)
		if IsSentinel(p)then
			set WA7=true
			call H1D(u,p)
			set WA7=false
		else
			set WB7=true
			call H1D(u,p)
			set WB7=false
		endif
		if (IsPlayerAlly(p,GetLocalPlayer()) or (udg_ObserverMode and IsObserver(GetLocalPlayer()))) and p!=GetLocalPlayer() then
			call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,5,udg_Colors[GetPlayerId(p)]+PlayerNames[GetPlayerId((p))]+"|r ordered to use Glyph of Fortification")
		endif
	endif
	set g=null
	set u=null
	set p=null
endfunction

function PhaseBootsFlyingCast takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	if GetTriggerEventId()==EVENT_UNIT_SPELL_CAST then
		call UnitRemoveAbility(GetTriggerUnit(),'A3CQ')
		call UnitRemoveAbility(GetTriggerUnit(),'A3K1')
		call UnitRemoveAbility(GetTriggerUnit(),'B09Y')
	endif
	call DestroyTrigger(t)
	set t=null
	return false
endfunction

function PhaseBootsFlying takes unit u returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_CAST)
	call TriggerRegisterDeathEvent(t,u)
	call TriggerAddCondition(t,Condition(function PhaseBootsFlyingCast))
	if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) then
		call UnitAddAbilityTimedExF(u,'A3K1',1,2.5,'B09Y')//B09Y -> Phase
	else
		call UnitAddAbilityTimedExF(u,'A3CQ',1,2.5,'B09Y')//B09Y -> Phase
	endif
	set t=null
endfunction

function PhaseBootsLand takes unit u returns nothing
	if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)then
		call Func0404(u,'I0T8')
	else
		call Func0404(u,'I0TA')
	endif
endfunction

function I4D takes nothing returns nothing
	call PhaseBootsRemoveImmolation(GetTriggerUnit())
	if GetUnitAbilityLevel(GetTriggerUnit(),'Bpsh')>0 then
		call UnitRemoveAbility(GetTriggerUnit(),'Bpsh')
	endif
	if IsUnitType(GetTriggerUnit(),UNIT_TYPE_FLYING) then
		call PhaseBootsFlying(GetTriggerUnit())
	else
		call PhaseBootsLand(GetTriggerUnit())
	endif
endfunction

function I7D takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer c=LoadInteger(HY,GetHandleId(u),'BMON')-1
	if c==0 then
		call RemoveSavedBoolean(HY,GetHandleId(u),'BMON')
		call RemoveSavedInteger(HY,GetHandleId(u),'BMON')
		call UnitRemoveAbility(u,'A43C')
	else
		call SaveInteger(HY,GetHandleId(u),'BMON',c)
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set u=null
	set t=null
	return false
endfunction

function BladeMailSpell takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	//call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
	call TriggerRegisterTimerEvent(t,4.5,false)
	call TriggerAddCondition(t,Condition(function I7D))
	call UnitAddAbility2(Source,'A43C')
	call SaveBoolean(HY,GetHandleId(Source),'BMON',true)
	call SaveInteger(HY,GetHandleId(Source),'BMON',LoadInteger(HY,GetHandleId(Source),'BMON')+1)
	call SaveUnitHandle(HY,h,0,Source)
	set t=null
	set Source=null
endfunction

function IDD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real a=(LoadReal(HY,h,137))
	local real d=(LoadReal(HY,h,138))
	local real x=SafeX50(GetUnitX(Target)+d/ 10*Cos(a*bj_DEGTORAD))
	local real y=SafeY50(GetUnitY(Target)+d/ 10*Sin(a*bj_DEGTORAD))
	if GetTriggerEvalCount(t)==11 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",x,y))
		if((LoadInteger(HY,(GetHandleId((Target))),(4306)))!=1)and GetUnitAbilityLevel(Target,'B08V')==0 then//B08V -> Black Hole
			call KillTrees(x,y,150)
			if IsUnitType(Target,UNIT_TYPE_HERO)then
				call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
			endif
			call SetUnitX(Target,x)
			call SetUnitY(Target,y)
		endif
	endif
	set Target=null
	set t=null
	return false
endfunction

function IED takes unit Target returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real x
	local real y
	local real d
	local real a
	local integer i=-1
	local boolean IFD=false
	call AddTimedKeyToUnit(Target,4414,3)
	set a=GetUnitFacing(Target)
	loop
		exitwhen IFD or i==23
		set i=i+1
		set x=SafeX50(GetUnitX(Target)+(600-i*25)*Cos(a*bj_DEGTORAD))
		set y=SafeY50(GetUnitY(Target)+(600-i*25)*Sin(a*bj_DEGTORAD))
		if(IsPointInRegion(RestrictedRegion,((x)*1.),((y)*1.)))==false then
			set IFD=true
		endif
	endloop
	set d=DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))
	call TriggerRegisterTimerEvent(t,.04,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function IDD))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveReal(HY,h,137,((a)*1.))
	call SaveReal(HY,h,138,((d)*1.))
	set t=null
endfunction

function ForceStaffFilter takes nothing returns boolean
	return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)
endfunction

function ForceStaffSup takes unit u returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=GetTriggerUnit()
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u)+70,76,Condition(function ForceStaffFilter))
	if FirstOfGroup(g)!=null then
		call IED(FirstOfGroup(g))
	endif
	call KillGroup(g)
endfunction

function ForceStaffAct takes nothing returns nothing
	local unit u=GetSpellTargetUnit()
	local unit caster=GetTriggerUnit()
	local boolean isMissile
	if GetSpellTargetItem()!=null then
		set u=caster
	endif
	set isMissile=IsHomingMissileId(GetUnitTypeId(u))
	if GetUnitTypeId(u)!='n00L' and GetUnitAbilityLevel(u,'B0FG')==0 and LoadBoolean(HY,GetHandleId(u),4306)==false then//n00L -> Roshan, B0FG -> Duel
		if isMissile then
			call IED(u)
		elseif GetUnitAbilityLevel(u,'A04R')>0 and GetUnitMoveSpeed(u)==0 then//
			call ForceStaffSup(u)
		elseif IsUnitEnemy(u,GetOwningPlayer(caster)) then
			if IsBlocked(u)==false then
				call IED(u)
			endif
		elseif IsUnitAlly(u,GetOwningPlayer(caster)) and (LoadBoolean(HY,GetHandleId(GetOwningPlayer(u)),139)==false or GetOwningPlayer(u)==GetOwningPlayer(caster)) then
			call IED(u)
		endif
	endif
	set u=null
	set caster=null
endfunction

function DiffusalBladePurgeTriggered takes nothing returns nothing
	local unit d
	if GetSpellTargetItem()!=null then
		set d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
		call UnitAddAbility(d,'AIpg')
		call IssueTargetOrder(d,"purge",GetTriggerUnit())
		call PurgingTriggered(d,false)
		set d=null
	endif
endfunction

function IHD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	if (GetTriggerEvalCount(t)>30) or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call UnitRemoveAbility(Source,'A1QC')//A1QC -> Etherblast Container
		call UnitRemoveAbility(Source,'B0CY')//B0CY -> Ether Blast
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set Source=null
	set t=null
	return false
endfunction

function IID takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	if (GetTriggerEvalCount(t)>LoadInteger(HY,h,2))then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set Source=null
	set t=null
	return false
endfunction

function IJD takes unit u,boolean enemy returns nothing
	local unit Source=u
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer c=40
	if enemy then
		set c=30
	endif
	call UnitAddAbilityTimedExF(Source,'Aetl',1,R2I(c/10),0)//Aetl -> Ethereal
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'Aetl',false)//Aetl -> Ethereal
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddCondition(t,Condition(function IID))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,2,c)
	set Source=null
	set t=null
endfunction

function IKD takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit Source=tt_unit1
	local unit Target=tt_unit2
	local real Damage=(LoadReal(HY,h,20))
	local trigger t
	if Source!=Target then
		call IJD(Target,LoadBoolean(HY,h,0))
		if LoadBoolean(HY,h,0)then
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call UnitAddAbilityTimedExF(Target,'A1QB',1,4,'B0CY')//A1QB -> Ethereal Blade MS, B0CY -> Ether Blast
			call TriggerRegisterTimerEvent(t,.1,true)
			call TriggerRegisterDeathEvent(t,Target)
			call TriggerAddCondition(t,Condition(function IHD))
			call SaveUnitHandle(HY,h,2,(Target))
			call TextTagOnUnit("+"+I2S(R2I(Damage)),2,Target,.027,3,216,120,216)
			call DamageTarget(Source,Target,1,Damage)
		endif
	endif
	call IJD(Source,LoadBoolean(HY,h,0))
	set t=null
	set Source=null
	set Target=null
endfunction

function IMD takes boolean b, unit Target returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t2
	local integer Cache2
	local integer stat
	local real amount
	set t2=AddProjectile(Source,Target,'h0BS',"IKD",1200,false)//h0BS -> Etherblast Projectile
	set Cache2=GetHandleId(t2)
	set stat = GetUnitPrimaryAttribute(Source)
	if b then
		if stat==1 then
			set amount = GetHeroInt(Source,true)*2.+75
		elseif stat==2 then
			set amount = GetHeroAgi(Source,true)*2.+75
		elseif stat==3 then
			set amount = GetHeroStr(Source,true)*2.+75
		endif
		call SaveReal(HY,(Cache2),20,amount)
	endif
	call SaveBoolean(HY,Cache2,0,b)
	set Source=null
	set t2=null
endfunction

function IOD takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local unit t = GetSpellTargetUnit()
	local item it=GetSpellTargetItem()
	local boolean b
	if it!=null then
		set t = u
	endif
	set it=null
	if GetSpellAbilityId()=='A1QD' and (IsBlocked(t)==false or IsUnitAlly(u,GetOwningPlayer(t))) and IsMagicImmune(t)==false then//A1QD -> Ether Blast
		call IMD(IsUnitEnemy(u,GetOwningPlayer(t)),t)
	endif
	
	set u = null
	set t = null
endfunction

function IPD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	if GetTriggerEvalCount(t)>40 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif (IsMagicImmune(Source) and IsUnitType(Source,UNIT_TYPE_HERO)) then
		call UnitRemoveAbility(Source,'Aetl')//Aetl -> Ethereal
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set Source=null
	set t=null
	return false
endfunction

function IQD takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t
	local integer h
	if IsCourier(Source)==false then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call UnitAddAbilityTimedExF(Source,'Aetl',1,4,0)//Aetl -> Ethereal
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'Aetl',false)//Aetl -> Ethereal
		call TriggerRegisterTimerEvent(t,.1,true)
		call TriggerAddCondition(t,Condition(function IPD))
		call SaveUnitHandle(HY,h,2,(Source))
	endif
	set Source=null
	set t=null
endfunction

function IRD takes nothing returns nothing
	if GetSpellAbilityId()=='A1AC' and (IsMagicImmune(GetTriggerUnit())==false or IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==false) then//A1AC -> Ghost Potion
		call IQD()
	endif
endfunction

function ISD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real ITD=(LoadReal(HY,h,529))
	local real IUD=(LoadReal(HY,h,530))
	local real IVD=GetUnitState(Source,UNIT_STATE_MANA)
	local real IWD=GetUnitState(Source,UNIT_STATE_MAX_MANA)
	local real IXD=(LoadReal(HY,h,668))
	local real IYD=GetUnitStatePercent(Source,UNIT_STATE_MANA,UNIT_STATE_MAX_MANA)
	local real IZD=(IXD-IYD)/ 100
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEvalCount(t)==20*10 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if ITD<150 then
			call SetUnitState(Source,UNIT_STATE_MANA,IVD-(150-ITD-IUD))
		endif
	else
		if IZD>0 then
			set ITD=ITD+IZD*IWD
			if IUD>0 then
				if IZD*IWD>IUD then
					call SetUnitState(Source,UNIT_STATE_MANA,IVD+IUD)
					set IUD=0
				else
					if IUD>(IWD-IVD)then
						set IUD=IUD-(IWD-IVD)
						call SetUnitState(Source,UNIT_STATE_MANA,IWD)
					else
						set IUD=IUD-IZD*IWD
						call SetUnitState(Source,UNIT_STATE_MANA,IVD+IZD*IWD)
					endif
				endif
			endif
		endif
		set IXD=IYD
		call SaveReal(HY,h,668,((IXD)*1.))
		call SaveReal(HY,h,529,((ITD)*1.))
		call SaveReal(HY,h,530,((IUD)*1.))
	endif
	set t=null
	set Source=null
	return false
endfunction

function IAD takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real IBD=GetWidgetLife(Source)
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real IVD=GetUnitState(Source,UNIT_STATE_MANA)
	if IBD>151 then
		call SetWidgetLife(Source,IBD-150)
	else
		call SetWidgetLife(Source,1)
	endif
	call Z48("Abilities\\Spells\\Orc\\SpiritLink\\SpiritLinkZapTarget.mdl",Source,"origin",2)
	call SetUnitState(Source,UNIT_STATE_MANA,IVD+150)
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function ISD))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveReal(HY,h,242,((GetUnitState(Source,UNIT_STATE_MANA))*1.))
	call SaveReal(HY,h,529,(0*1.))
	call SaveReal(HY,h,668,((GetUnitStatePercent(Source,UNIT_STATE_MANA,UNIT_STATE_MAX_MANA))*1.))
	if(IVD+150)>GetUnitState(Source,UNIT_STATE_MAX_MANA)then
		call SaveReal(HY,h,530,(((IVD+150)-GetUnitState(Source,UNIT_STATE_MAX_MANA))*1.))
	endif
	set Source=null
	set t=null
endfunction

function I3D takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x
	local real y
	if IsSentinel(GetOwningPlayer(Source))then
		set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
		set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
	else
		set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
		set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
	endif
	//call IssuePointOrderById(Source,ORDER_move,x,y)
	call CourierIssuePointOrder(Source,ORDER_move,x,y)
	call SaveCourierState(Source,"Going home")
	set Source=null
endfunction

function BSO takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x
	local real y
	if IsSentinel(GetOwningPlayer(Source))then
		set x=-4533
		set y=1158
	else
		set x=3190
		set y=-35
	endif
	call CourierIssuePointOrder(Source,ORDER_move,x,y)
	call SaveCourierState(Source,"To the Secret Shop")
	set Source=null
endfunction

function ILD takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	call SaveBoolean(HY,(GetHandleId(Hero)),129,(true))
	set Hero=null
endfunction

function I1D takes nothing returns nothing
	if(GetSpellAbilityId()=='A0B8' or GetSpellAbilityId()=='A1WE')and IsBlocked(GetTriggerUnit()) then//A0B8 -> Manta Image, A1WE -> Manta Image (ranged)
		call ILD()
	endif
endfunction

function I2D takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or(GetTriggerEventId()==EVENT_UNIT_DAMAGED and(IsCreepId(GetUnitTypeId(GetEventDamageSource()))==false and(GetOwningPlayer(GetEventDamageSource())!=Neutrals)and GetEventDamage()>0)or W67)then//n00L -> Roshan
		call UnitRemoveAbility(Target,'B0CG')//B0CG -> Urn of Shadows
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	return false
endfunction

function UrnOfShadowsEnemyDur takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local integer c=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or c==0 then
		call UnitRemoveAbility(target,'A3B2')
		call UnitRemoveAbility(target,'B3B2')//B3B2 -> Urn of Shadows
		call RemoveSavedHandle(HY,GetHandleId(target),'EURN')
		call DestroyTrigger(t)
		call FlushChildHashtable(HY,h)
	else
		call SaveInteger(HY,h,0,c-1)
		call DamageTarget(GetDamageSourceForStickyNapalm(caster),target,3,150./8.)
	endif
	set caster=null
	set target=null
	set t=null
	return false
endfunction

function UrnOfShadowsOnEnemy takes unit from, unit to returns nothing
	local trigger t
	local integer h
	if HaveSavedHandle(HY,GetHandleId(to),'EURN') then
		set t=LoadTriggerHandle(HY,GetHandleId(to),'EURN')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,GetHandleId(to),'EURN',t)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerRegisterDeathEvent(t,to)
		call TriggerAddCondition(t,Condition(function UrnOfShadowsEnemyDur))
		call SaveUnitHandle(HY,h,1,to)
	endif
	call SaveUnitHandle(HY,h,0,from)
	call SaveInteger(HY,h,0,8)
	call UnitAddAbility2(to,'A3B2')
	set t=null
endfunction

function J4D takes nothing returns nothing
	local trigger t
	local integer h
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local unit Caster
	local integer i=0
	local boolean found=false
	local boolean IFD=false
	local integer charges
	if Target==null then
		set Target=GetTriggerUnit()
	endif
	set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	loop
		exitwhen i>5 or IFD
		if F49(UnitItemInSlot(Source,i))==UrnOfShadows then
			set charges=GetItemCharges(UnitItemInSlot(Source,i))
			if charges>0 then
				set found=true
				set charges=charges-1
			else
				set IFD=true
				set found=false
			endif
		endif
		set i=i+1
	endloop
	if found then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		if IsUnitAlly(Target,GetOwningPlayer(Source)) then
			if GetUnitAbilityLevel(Target,'B0CG')==0 then//B0CG -> Urn of Shadows
				call UnitAddAbility(Caster,'A1MM')//A1MM -> Staff of Healing
				call IssueTargetOrderById(Caster,852609,Target)
				call SmoothHealingSystemForBottle(400,0,8,'B0CG',Target)//B0CG -> Urn of Shadows
			endif
			call SaveUnitHandle(HY,h,17,Target)
			call TriggerRegisterTimerEvent(t,8,false)
			call TriggerRegisterDeathEvent(t,Target)
			call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
			call TriggerAddCondition(t,Condition(function I2D))
		else
			call UrnOfShadowsOnEnemy(Source,Target)
		endif
	endif
	set Source=null
	set Caster=null
	set Target=null
	set t=null
endfunction

//function Spectre_Dispersion_Init takes nothing returns nothing
//	local integer i=0
//	loop
//		exitwhen i>16
//		set WL7[i]=false
//		set i=i+1
//	endloop
//endfunction

function AlchemistScepterUse takes nothing returns nothing
	local unit u=GetSpellTargetUnit()
	local integer i
	set bj_playerIsCrippled[0]=false
	if IsUnitType(u,UNIT_TYPE_HERO) and IsFakeHero2(u)==false and GetUnitAbilityLevel(u,'A3E7')==0 then
		call UnitAddAbility2(u,'A3E7')
		call HeroAghanim(u,false)
		set i=0
		loop
			exitwhen i>5
			if IsAghanim(UnitItemInSlot(u,i)) and IsItemPawnable(UnitItemInSlot(u,i))==false then
				call SetItemDroppable(UnitItemInSlot(u,i),true)
			endif
			set i=i+1
		endloop
		set AlchemistBonus[GetPlayerId(GetOwningPlayer(u))]=AlchemistBonus[GetPlayerId(GetOwningPlayer(u))]+GetItemGoldCostById(Item_Real[AghanimBasic])
		if GetOwningPlayer(u)!=GetOwningPlayer(GetTriggerUnit()) then
			set AlchemistBonus[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=AlchemistBonus[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]+GetItemGoldCostById(Item_Real[AghanimBasic])
		endif
		set NetWorthRecount[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=true
		set NetWorthRecount[GetPlayerId(GetOwningPlayer(u))]=true
		call SetHeroStr(u,GetHeroStr(u,false)+10,true)
		call SetHeroInt(u,GetHeroInt(u,false)+10,true)
		call SetHeroAgi(u,GetHeroAgi(u,false)+10,true)
		call UnitAddAbility2(u,'A3I2')
		call UnitAddAbility2(u,'A3I3')
		set bj_playerIsCrippled[0]=true
	endif
	set u=null
endfunction

function J9D takes nothing returns nothing
	call UnitAddAbilityTimedEx(GetEnumUnit(),'A1ZY',1,6,'B0DX')//A1ZY -> Ancient Jangoo Bonus, B0DX -> Ancient Janggo of Endurance
endfunction

function JDD takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local integer i=0
	local boolean found=false
	local boolean IFD=false
	local integer charges
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),925,Condition(function LL8))
	call ForGroup(g,function J9D)
	call KillGroup(g)
	set g=null
	set Source=null
endfunction

function JFD takes unit u returns boolean
	local integer U58=GetUnitTypeId(u)
	return U58=='H0B8'//H0B8 -> Ice Blast
endfunction

function JGD takes nothing returns boolean
	return(IsUnitEnemy(GetFilterUnit(),W57)and IsPrimalSplitUnit(GetUnitTypeId(GetFilterUnit()))==false and IsDead(GetFilterUnit())==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO))and JFD(GetFilterUnit())==false)!=null
endfunction

function JHD takes unit Source returns boolean
	local group g=GetAvailableGroup()
	local boolean found
	set W57=GetOwningPlayer(Source)
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1050,Condition(function JGD))
	set found=FirstOfGroup(g)!=null
	call KillGroup(g)
	set g=null
	return found
endfunction

function JID takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local group g
	local integer Count
	local boolean JJD
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
		if GetAttacker()==Source then
			call UnitRemoveAbility(Source,'A20L')//A20L -> Smoke of Deceit
			call UnitRemoveAbility(Source,'A20S')//A20S -> Smoke of Deceit Container
			call UnitRemoveAbility(Source,'B0E2')//B0E2 -> Smoke of Deceit
			call UnitRemoveAbility(Source,'B09Y')//B09Y -> Phase
			if((LoadInteger(HY,(GetHandleId((Source))),(4302)))==1)==false then
				call UnitSetUsesAltIcon(Source,false)
			endif
			call DestroyEffect((LoadEffectHandle(HY,h,32)))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	else
		set JJD=(LoadBoolean(HY,h,671))
		set Count=(LoadInteger(HY,h,34))
		set Count=Count+1
		call SaveInteger(HY,h,34,(Count))
		set g=GetAvailableGroup()
		set W57=GetOwningPlayer(Source)
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1050,Condition(function JGD))
		if GetUnitAbilityLevel(Source,'B09Y')>0 then//B09Y -> Phase
			call SaveBoolean(HY,h,671,(true))
		elseif JJD then
			call SaveBoolean(HY,h,671,(false))
			call UnitRemoveAbility(Source,'A20L')//A20L -> Smoke of Deceit
			call UnitAddAbility2(Source,'A20L')//A20L -> Smoke of Deceit
		endif
		if Count>350 or FirstOfGroup(g)!=null then
			call UnitRemoveAbility(Source,'A20L')//A20L -> Smoke of Deceit
			call UnitRemoveAbility(Source,'A20S')//A20S -> Smoke of Deceit Container
			call UnitRemoveAbility(Source,'B0E2')//B0E2 -> Smoke of Deceit
			call UnitRemoveAbility(Source,'B09Y')//B09Y -> Phase
			if((LoadInteger(HY,GetHandleId(Source),4302))!=1) then
				call UnitSetUsesAltIcon(Source,false)
			endif
			call DestroyEffect(LoadEffectHandle(HY,h,32))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
		call KillGroup(g)
	endif
	set t=null
	set Source=null
	set g=null
	return false
endfunction

function JKD takes nothing returns nothing
	local unit Source=GetEnumUnit()
	local trigger t
	local integer h
	if IsPlayerBelongToTeams(GetOwningPlayer(Source))and JHD(Source)==false then
		if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Source))==false and IsObserver(GetLocalPlayer())==false then
			call UnitSetUsesAltIcon(Source,true)
		endif
		call RemoveEndlessFadetime(Source)
		call UnitAddAbility2(Source,'A20L')//A20L -> Smoke of Deceit
		call UnitMakeAbilityPermanent(Source,true,'A20L')//A20L -> Smoke of Deceit
		if IsUnitBADWithSpellbooks(Source)==false then
			call UnitAddAbility2(Source,'A20S')//A20S -> Smoke of Deceit Container
			call UnitMakeAbilityPermanent(Source,true,'A20S')//A20S -> Smoke of Deceit Container
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A20S',false)//A20S -> Smoke of Deceit Container
		endif
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveInteger(HY,h,34,0)
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveBoolean(HY,h,671,(false))
		call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\SmokeOfDeceit.mdx",Source,"chest")))
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
		call TriggerRegisterTimerEvent(t,.1,true)
		call TriggerAddCondition(t,Condition(function JID))
		set t=null
	endif
	set Source=null
endfunction

function JMD takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1225,Condition(function L68))
	call ForGroup(g,function JKD)
	call KillGroup(g)
	set Source=null
	set g=null
endfunction

function JOD takes nothing returns nothing
	call UnitAddAbilityTimedEx(GetEnumUnit(),'A28E',1,20,0)//A28E -> Veil of Discord
	call UnitAddAbilityTimedEx(GetEnumUnit(),'A28G',1,20,'B0EQ')//A28G -> Veil of Discord Icon, B0EQ -> Veil of Discord
endfunction

function JPD takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	call HideAbility('A28E')//A28E -> Veil of Discord
	call GroupEnumUnitsInRange(g,x,y,625,Condition(function LR8))
	call ForGroup(g,function JOD)
	call KillGroup(g)
	call DestroyEffect(AddSpecialEffect("war3mapImported\\DarkLightningNova.mdx",x,y))
	set Source=null
	set g=null
endfunction

function Item_QuellingBlade_Start takes nothing returns nothing
	if IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) then
		call DamageTarget(GetTriggerUnit(),GetSpellTargetUnit(),2,500)
	endif
endfunction

function Item_QuellingBlade_Reg takes nothing returns nothing
	if (GetUnitTypeId(GetSpellTargetUnit())=='o004' or GetUnitTypeId(GetSpellTargetUnit())=='oeye' or IsTechiesLandMine(GetSpellTargetUnit())) then//o004 -> Observer Ward, oeye -> Sentry Ward
		call Item_QuellingBlade_Start()
	endif
endfunction

function RodOfAtos_SpellEffect takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call UnitAddAbility(Caster,'A2K3')//A2K3 -> Rod of atos slow 3
	call IssueTargetOrderById(Caster,852075,Target)
	call EvasionSourceActivate(EVASION_BUFF_ATOS,8)
	set Source=null
	set Target=null
	set Caster=null
endfunction

function SilverEdge_SpellEffect takes nothing returns nothing
	call EvasionSourceActivate(EVASION_BUFF_SILVEREDGE,20)
endfunction

function JUD takes nothing returns nothing
	if GetSpellAbilityId()=='A2EA' and IsBlocked(GetSpellTargetUnit())==false then//A2EA -> Rod of atos
		call RodOfAtos_SpellEffect()
	endif
endfunction

function Item_Dust_Filter takes nothing returns boolean
	return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and (AliveNonBuildOrMarker(GetFilterUnit())) and IsNonAncient(GetFilterUnit())
endfunction

function Item_Dust_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,h,2))
	if GetUnitAbilityLevel(u,'Bdet')==0 or LoadReal(HY,GetHandleId(u),'AItb')+12 < TimerGetElapsed(GlobalTimer) then//Bdet -> Dust of Appearance
		call UnitRemoveAbility(u,'A2SJ')
		call UnitRemoveAbility(u,'B0GR')//B0GR -> Dust of Appearance
		call UnitRemoveAbility(u,'Bdet')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if GenericCondition_IsDotAInvis(u) then
			if GetUnitAbilityLevel(u,'B0GR')==0 then//B0GR -> Dust of Appearance
				call UnitAddAbility2(u,'A2SJ')
			endif
		else
			if GetUnitAbilityLevel(u,'B0GR')>0 then//B0GR -> Dust of Appearance
				call UnitRemoveAbility(u,'A2SJ')
				call UnitRemoveAbility(u,'B0GR')//B0GR -> Dust of Appearance
			endif
		endif
	endif
	set u=null
	set t=null
	return false
endfunction

function Item_Dust_Start takes nothing returns nothing
	local unit u=GetEnumUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.02,true)
	call TriggerRegisterDeathEvent(t,u)
	call TriggerAddCondition(t,Condition(function Item_Dust_Duration))
	call SaveReal(HY,GetHandleId(u),'AItb',TimerGetElapsed(GlobalTimer))
	call SaveUnitHandle(HY,h,2,(u))
	set t=null
	set u=null
endfunction

function Item_Dust_Init takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u=GetTriggerUnit()
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1075,Condition(function Item_Dust_Filter))
	call ForGroup(g,function Item_Dust_Start)
	call KillGroup(g)
	set g=null
	set u=null
endfunction

function Item_Bloodstone_Act takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	call SetItemCharges(FindItemOfType(caster,Item_Real[bloodstone]),GetItemCharges(FindItemOfType(caster,Item_Real[bloodstone]))+1)
	call FlushChildHashtable(HY,h)
	call SaveBoolean(HY,GetHandleId(caster),'suic',true)
	call CleanTrigger(t)
	call KillUnit(caster)
	set caster=null
	set t=null
	return false
endfunction

function Item_Bloodstone_Init takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,(caster))
	call TriggerAddCondition(t,Condition(function Item_Bloodstone_Act))
	call TriggerRegisterTimerEvent(t,0.01,false)
	set t=null
	set caster=null
endfunction

function Halberd_Start takes nothing returns nothing
	local unit u = GetSpellTargetUnit()
	if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) then
		call UnitAddAbilityTimedExF(u,'C033',1,3,'D033')
		call UnitAddAbilityTimedExF(u,'A3KC',1,3,0)
	else
		call UnitAddAbilityTimedExF(u,'C033',1,4.5,'D033')
		call UnitAddAbilityTimedExF(u,'A3KC',1,4.5,0)
	endif
	set u = null
endfunction

function JAD takes integer Level,unit Source,unit Target returns nothing
	call DamageTarget(Source,Target,1,300+100*Level)
endfunction

function JBD takes nothing returns nothing
	local integer JCD=0
	if GetSpellAbilityId()=='A02O' then//A02O -> Finger of Death
		set JCD=1
	elseif GetSpellAbilityId()=='A08Y' then//A08Y -> Finger of Death
		set JCD=2
	elseif GetSpellAbilityId()=='A08Z' then//A08Z -> Finger of Death
		set JCD=3
	elseif GetSpellAbilityId()=='A090' then//A090 -> Finger of Death
		set JCD=4
	elseif GetSpellAbilityId()=='A092' then//A092 -> Finger of Death
		set JCD=5
	endif
	if JCD>0 then
		if IsBlocked(GetSpellTargetUnit())==false then
			call DamageTarget(GetTriggerUnit(),GetSpellTargetUnit(),1,300+100*JCD)
		else
			call RemoveLinkenBuff(GetSpellTargetUnit())
		endif
	endif
endfunction

function J3D takes nothing returns nothing
	if GetSpellAbilityId()=='A2HQ' then//A2HQ -> Blade of the Reaper
		call WL9(GetTriggerUnit(),GetSpellTargetUnit())
	endif
endfunction

function Linken_ReApply2 takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local item it
	local unit u=LoadUnitHandle(HY,h,0)
	call DisableTrigger(t_manipulateitem)
	set it=CreateItem('I0HM',GetUnitX(u),GetUnitY(u))//I0HM -> Linken's Sphere
	call UnitAddItem(u,it)
	if GetWidgetLife(it)>0 then
		call RemoveItem(it)
	endif
	set it=null
	call EnableTrigger(t_manipulateitem)
	call PauseTimer(t)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set u=null
endfunction

function Linken_ReApply takes unit u returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.1,false,function Linken_ReApply2)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	set t=null
endfunction

function LinkenSphere_ShareRemove takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if GetUnitAbilityLevel(u,'B0BI')==0 or GetTriggerEvalCount(t)>160 or GetTriggerEventId()==EVENT_UNIT_DEATH then//B0BI -> Linken Sphere
		call UnitRemoveAbility(u,'B0BI')//B0BI -> Linken Sphere
		call DestroyEffect(LoadEffectHandle(HY,h,1))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set u=null
endfunction

function LinkenSphere_SpreadOn takes unit u, boolean byItem returns nothing
	local trigger t
	local item it
	if IsUnitIllusion(u)==false then
		if byItem then
			call EKD(GetTriggerUnit())
			call UnitRemoveAbility(GetTriggerUnit(),'B0BI')//B0BI -> Linken Sphere
		endif
		call DisableTrigger(t_manipulateitem)
		set it=CreateItem('I0HM',GetUnitX(u),GetUnitY(u))//I0HM -> Linken's Sphere
		if UnitAddItem(u,it) and GetWidgetLife(it)<=0 then
			set t=CreateTrigger()
			call TriggerRegisterTimerEvent(t,0.1,true)
			call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
			call TriggerAddCondition(t,Condition(function LinkenSphere_ShareRemove))
			call SaveEffectHandle(HY,GetHandleId(t),1,AddSpecialEffectTarget("war3mapImported\\Linkens_Main.mdx",u,"chest"))
			call SaveUnitHandle(HY,GetHandleId(t),0,u)
		else
			call RemoveItem(it)
		endif
		call EnableTrigger(t_manipulateitem)
	endif
	set it=null
	set t=null
endfunction

function LinkenSphere_Share takes nothing returns nothing
	call LinkenSphere_SpreadOn(GetSpellTargetUnit(),true)
endfunction

function J0D takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	call UnitRemoveAbility(Source,'A1ZJ')//A1ZJ -> Item Armor Bonus
	call UnitRemoveAbility(Target,LoadInteger(HY,h,0))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
	set Source=null
	set Target=null
endfunction

function J5D takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local unit u=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	call TimerStart(t,7,false,function J0D)
	call SaveUnitHandle(HY,h,2,u)
	call SaveUnitHandle(HY,h,17,target)
	call UnitAddAbility2(u,'A1ZJ')//A1ZJ -> Item Armor Bonus
	if IsUnitEnemy(u,GetOwningPlayer(target)) then
		call UnitAddAbility2(target,'A1ZJ')//A1ZJ -> Item Armor Bonus
		call SaveInteger(HY,h,0,'A1ZJ')//A1ZJ -> Item Armor Bonus
		if target==Roshan then
			call SetUnitAbilityLevel(target,'A1ZJ',2)
		endif
	else
		call UnitAddAbility2(target,'A44N')
		call SaveInteger(HY,h,0,'A44N')
	endif
	set t=null
	set u=null
	set target=null
endfunction

function K4D takes nothing returns nothing
	local unit whichUnit=GetTriggerUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(whichUnit),'e00E',GetUnitX(whichUnit),GetUnitY(whichUnit),0)//e00E -> Spellcaster
	if GetSpellAbilityId()=='AIpl' then//AIpl -> Lesser Clarity Potion
		call UnitAddAbility(Caster,'A1WA')//A1WA -> Sapphire Water Temp
	elseif GetSpellAbilityId()=='AIpr' then//AIpr -> Sapphire Water
		call UnitAddAbility(Caster,'AIpr')//AIpr -> Sapphire Water
	endif
	call IssueTargetOrderById(Caster,852609,whichUnit)
	set whichUnit=null
	set Caster=null
endfunction

function K7D takes nothing returns nothing
	if GetSpellAbilityId()=='AIpl' or GetSpellAbilityId()=='AIpr' or GetSpellAbilityId()=='A1WA' then//AIpl -> Lesser Clarity Potion, AIpr -> Sapphire Water, A1WA -> Sapphire Water Temp
		if GetSpellTargetItem()!=null then
			call K4D()
		else
			if (GetUnitAbilityLevel(GetSpellTargetUnit(),'BIrm')==0 and GetSpellAbilityId()!='AIpr') then//BIrm -> Clarity Potion, AIpr -> Sapphire Water
				call SmoothHealingSystemForBottle(0,150,30,'BIrm',GetSpellTargetUnit())//BIrm -> Clarity Potion
			elseif (GetUnitAbilityLevel(GetSpellTargetUnit(),'B02Z')==0 and GetSpellAbilityId()=='AIpr') then//B02Z -> Healing Salve, AIpr -> Sapphire Water
				call SmoothHealingSystemForBottle(400,0,8,'B02Z',GetSpellTargetUnit())//B02Z -> Healing Salve
			endif
		endif
	elseif GetSpellAbilityId()=='A0FO' and GetUnitAbilityLevel(GetTriggerUnit(),'B04A')==0 then//A0FO -> Bottle Regen, B04A -> Bottle 
		call SmoothHealingSystemForBottle(110,70,3,'B04A',GetTriggerUnit())//B04A -> Bottle 
	endif
endfunction


function RestoreWardIfFail takes unit Hero, integer ward returns nothing
	local integer indexid
	local item it
	if ward=='o004' then//o004 -> Observer Ward
		set indexid=Item_Real[ObserverWards]
	else
		set indexid=Item_Real[SentryWards]
	endif
	call DisableTrigger(t_manipulateitem)
	set it=FindItemOfType(Hero,indexid)
	if it==null then
		set tt_player1=GetOwningPlayer(Hero)
		set tt_item1=CreateItem(indexid,0,0)
		call UnitAddItem(Hero,tt_item1)
		call SetItemPlayer(tt_item1,tt_player1,false)
		call SetItemUserData(tt_item1,1)
	else
		call SetItemCharges(it,GetItemCharges(it)+1)
	endif
	call EnableTrigger(t_manipulateitem)
	set it=null
endfunction

function NewWards takes nothing returns nothing
	local integer id=GetSpellAbilityId()
	local unit d
	local unit caster
	local real x
	local real y
	local item it
	local integer semiid
	local integer realid
	local integer index
	local real dur=0
	if id=='A02X' or id=='AIsw' then//observer ward//A02X -> Observer Ward, AIsw -> Sentry Ward
		if id=='A02X' then//A02X -> Observer Ward
			set semiid='o004'//o004 -> Observer Ward
			set realid='A33D'
			set dur=420
			set index=ObserverWards
		else
			set semiid='oeye'//oeye -> Sentry Ward
			set realid='A33E'
			set dur=240
			set index=SentryWards
		endif
		set caster=GetTriggerUnit()
		set x=GetSpellTargetX()
		set y=GetSpellTargetY()
		if GetSpellTargetUnit()==null then
			if IsPointInRegion(ForbiddenWardsRegion,x,y) then
				call RestoreWardIfFail(caster,semiid)
			else
				set d=CreateUnit(GetOwningPlayer(caster),semiid,x,y,0)
				call SetUnitPathing(d,false)
				call SetUnitPosition(d,x,y)
				call UnitAddAbility(d,'A0XB')//A0XB -> Permanent Invisibility
				call UnitApplyTimedLife(d,'BTFL',dur)
				set d=null
			endif
		else
			set d=GetSpellTargetUnit()
			set it=FindItemOfType(d,index)
			if it!=null then
				call SetItemCharges(it,GetItemCharges(it)+1)
			elseif GetEmptyInventorySlots(d)>0 then
				set it=CreateItem(Item_Real[index],0,0)
				call SetItemCharges(it,1)
				call UnitAddItem(d,it)
			else
				call DisplayTimedTextToPlayer(GetOwningPlayer(caster),0,0,5,"Target's inventory is full")
				call RestoreWardIfFail(caster,semiid)
			endif
			set it=null
		endif
	endif
	
	set caster=null
	set d=null
endfunction

function K9D takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Level=(LoadInteger(HY,h,34))
	if(GetTriggerEventId()==EVENT_UNIT_DEATH and GetKillingUnit()==Source)or(GetTriggerEventId()==EVENT_UNIT_DAMAGED and GetUnitAbilityLevel(Target,'B0ES')>0)then//B0ES -> Hand of Midas
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Transmute\\PileofGold.mdl",GetUnitX(Target),GetUnitY(Target)))
		if (IsUnitType(Source,UNIT_TYPE_HERO)) then
			call AddHeroXP(Source,R2I(LoadInteger(UnitStats,GetUnitTypeId(Target),EXP)*2.5),true)
		else
			call AddHeroXP(udg_Hero[GetPlayerId(GetOwningPlayer(Source))],R2I(LoadInteger(UnitStats,GetUnitTypeId(Target),EXP)*2.5),true)
		endif
		call ImitateBountyGain(GetOwningPlayer(Source),Target,190)
		set ReliableGold[GetPlayerId(GetOwningPlayer(Source))]=ReliableGold[GetPlayerId(GetOwningPlayer(Source))]+190
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(Target)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function KDD takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitLevel(Target)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,34,(Level))
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function K9D))
	set t=null
	set Source=null
	set Target=null
endfunction

function KFD takes nothing returns nothing
	call SetUnitState(GetEnumUnit(),UNIT_STATE_MANA,GetUnitState(GetEnumUnit(),UNIT_STATE_MANA)+135)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl",GetEnumUnit(),"origin"))
endfunction

function KGD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),25+900,Condition(function L08))
	call ForGroup(g,function KFD)
	call KillGroup(g)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set g=null
	set Source=null
	set t=null
	return false
endfunction

function KHD takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t
	if GetSpellAbilityId()=='A0K7' then//A0K7 -> Arcane Ring
		if GetUnitTypeId(Source)!='H00J' then//H00J -> Geomancer
			set t=CreateTrigger()
			call TriggerRegisterTimerEvent(t,0,false)
			call TriggerAddCondition(t,Condition(function KGD))
			call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
			set t=null
		elseif GetUnitTypeId(Source)=='H00J' then//H00J -> Geomancer
			call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+25)
		endif
	endif
	set Source=null
endfunction

function Eul_Damage takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		call DamageTarget(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1),1,50)
	endif
	call DestroyTrigger(t)
	call FlushChildHashtable(HY,h)
	set t=null
endfunction

function SimulateCycloneEffect takes unit target, unit dummy returns boolean
	if IssueTargetOrder(dummy,"cyclone",target) then
		call echo("cyclone")
		return true
	elseif IssueTargetOrder(dummy,"sleep",target) then
		call echo("sleep")
		//call UnitRemoveBuffsEx(target,true,true,true,false,false,false,false)
		return true
	else
		call UnitShareVision(target,GetOwningPlayer(dummy),true)
		if IssueTargetOrder(dummy,"cyclone",target) then
			call echo("cyclone")
			call UnitShareVision(target,GetOwningPlayer(dummy),false)
			return true
		elseif IssueTargetOrder(dummy,"sleep",target) then
			call echo("sleep")
			call UnitShareVision(target,GetOwningPlayer(dummy),false)
			//call UnitRemoveBuffsEx(target,true,true,true,false,false,false,false)
			return true
		endif
		call UnitShareVision(target,GetOwningPlayer(dummy),false)
	endif
	call echo("none")
	return false
endfunction

function KID takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local unit Caster
	local trigger t
	if GetSpellTargetItem()!=null then
		set Target=GetTriggerUnit()
	endif
	if IsBlocked(GetSpellTargetUnit())==false or IsPlayerAlly(GetOwningPlayer(Source),GetOwningPlayer(Target))then//A1T7 -> Eul Cyclone
		
		set Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
		call UnitAddAbility(Caster,'A13V')
		call UnitAddAbility(Caster,'A3G5')
		call SaveUnitHandle(HY,GetHandleId(Caster),0,Source)
		if SimulateCycloneEffect(Target,Caster) and IsPlayerEnemy(GetOwningPlayer(Source),GetOwningPlayer(Target)) then
			set t=CreateTrigger()
			call TriggerRegisterTimerEvent(t,2.51,false)
			call TriggerRegisterDeathEvent(t,Target)
			call TriggerAddCondition(t,Condition(function Eul_Damage))
			call SaveUnitHandle(HY,GetHandleId(t),2,Caster)
			call SaveUnitHandle(HY,GetHandleId(t),17,Target)
			set t=null
		endif
	endif
	set Source=null
	set Target=null
	set Caster=null
	
endfunction

function Courier_Burst_SpeedEnd takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call CustomSpeed(LoadUnitHandle(HY,h,0),0,0)
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	set t=null
endfunction

function Courier_Burst_Speed takes unit u returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,u)
	call CustomSpeed(u,999,800)
	call TimerStart(t,4.0,false,function Courier_Burst_SpeedEnd)
	set t=null
endfunction

function Courier_Burst takes nothing returns nothing
	call Courier_Burst_Speed(GetTriggerUnit())
endfunction

function WTFModeReset takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	local integer i=GetUnitTypeId(u)
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTimer(t)
	if i!='ncop' then//ncop -> Circle of Power
		call UnitResetCooldown(u)
		call SetUnitState(u,UNIT_STATE_MANA,999999)
	endif
	set u=null
	set t=null
endfunction

function WTFModeOnCast takes nothing returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0,false,function WTFModeReset)
	call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
	set t=null
endfunction

function ShowHideUnit takes unit u returns nothing
	local boolean array b
	local player p
	local integer i=1
	loop
		if IsUnitSelected(u,Player(i))then
			set b[i]=true
		else
			set b[i]=false
		endif
		set i=i+1
		exitwhen i>11
	endloop
	call ShowUnit(u,false)
	call ShowUnit(u,true)
	set i=1
	loop
		if b[i]then
			call SelectUnitAddForPlayer(u,Player(i))
		endif
		set i=i+1
		exitwhen i>11
	endloop
	
endfunction

function VariousItemSpells takes nothing returns boolean
	local integer id=GetSpellAbilityId()
	if IsBackMorph() then
		return false
	endif
	if WTFModeActive then
		call WTFModeOnCast()
	endif
	call K7D()//heals
	if HaveSavedString(MHT,id,12) then
		call ExecuteFunc(LoadStr(MHT,id,12))
	endif
	if GetUnitTypeId(GetTriggerUnit())=='e00E' then//e00E -> Spellcaster
		return false
	endif
	call HBD()//stick charging
	if GetSpellAbilityId()=='A2K7' and IsBlocked(GetSpellTargetUnit())==false then//A2K7 -> Annihilator Stun
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\LevelerStunFX.mdx",GetSpellTargetUnit(),"head"))
	endif
	return false
endfunction

function KKD takes unit Hero returns nothing
	call SetWidgetLife(Hero,GetUnitState(Hero,UNIT_STATE_MAX_LIFE))
	call SetUnitState(Hero,UNIT_STATE_MANA,GetUnitState(Hero,UNIT_STATE_MAX_MANA))
endfunction

function KND takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	call KKD(Hero)
	call RemoveStuffFromHero(Hero)
	call ClearSelectionForPlayer(GetOwningPlayer(Hero))
	call SelectUnitAddForPlayer(Hero,GetOwningPlayer(Hero))
	call FixVisionGlitchOnBuyBack(Hero)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	return false
endfunction

function KPD takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real x
	local real y
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call Traffic_RegisterData("AegisOff",GetPlayerId(GetOwningPlayer(Hero)))
	call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(Hero),'o01P',GetUnitX(Hero),GetUnitY(Hero),0),'BTLF',5)
	set K27=null
	call TriggerRegisterTimerEvent(t,5,false)
	call TriggerAddCondition(t,Condition(function KND))
	call SaveUnitHandle(HY,h,14,(Hero))
	call AddTimedKeyToUnit(Hero,4304,5)
	set t=null
	set Hero=null
endfunction

function KQD takes nothing returns nothing
	if F49(GetManipulatedItem())==Aegis then
		call KPD()
	endif
endfunction

function ReplaceItemByIdInSlotLoD takes unit u, integer id, integer dataint, item replaced returns nothing
	local item it
	local integer slot=GetItemSlot(u,replaced)
	local player p=GetItemPlayer(replaced)
	call DisableTrigger(t_manipulateitem)
	call RemoveItem(replaced)
	set it=AddItemByIdInSlot(u,Item_Real[id],slot)
	call SetItemPlayer(it,p,false)
	call SetItemUserData(it,dataint)
	call EnableTrigger(t_manipulateitem)
	set it=null
endfunction

function KSD takes integer indexId returns nothing
	local unit u=GetTriggerUnit()
	local item it=GetManipulatedItem()
	local integer slot
	local player p
	if indexId==RingOfBasilius then
		call ReplaceItemByIdInSlotLoD(u,RingOfBasiliusHero,1,it)
	elseif indexId==RingOfBasiliusHero then
		call ReplaceItemByIdInSlotLoD(u,RingOfBasilius,1,it)
	elseif indexId==RingOfAquila then
		call ReplaceItemByIdInSlotLoD(u,RingOfAquilaHero,1,it)
	elseif indexId==RingOfAquilaHero then
		call ReplaceItemByIdInSlotLoD(u,RingOfAquila,1,it)
	elseif indexId==MKBOn then
		call ReplaceItemByIdInSlotLoD(u,MKBOff,1,it)
	elseif indexId==MKBOff then
		call ReplaceItemByIdInSlotLoD(u,MKBOn,1,it)
	endif
	if indexId==RadianceOn then
		call ReplaceItemByIdInSlotLoD(u,RadianceOff,1,it)
	elseif indexId==RadianceOff then
		call ReplaceItemByIdInSlotLoD(u,RadianceOn,1,it)
	endif
	if indexId==PowerTreadsAgility then
		call ReplaceItemByIdInSlotLoD(u,PowerTreadsStrength,1,it)
	elseif indexId==PowerTreadsStrength then
		call ReplaceItemByIdInSlotLoD(u,PowerTreadsIntelligence,1,it)
	elseif indexId==PowerTreadsIntelligence then
		call ReplaceItemByIdInSlotLoD(u,PowerTreadsAgility,1,it)
	endif
	if indexId==DiffusalBlade and GetItemCharges(it)==0 then
		call ReplaceItemByIdInSlotLoD(u,DiffusalBlade_empty,1,it)
	elseif indexId==DiffusalBlade_upg and GetItemCharges(it)==0 then
		call ReplaceItemByIdInSlotLoD(u,DiffusalBlade_upg_empty,1,it)
	elseif indexId==janggo and GetItemCharges(it)==0 then
		call ReplaceItemByIdInSlotLoD(u,janggoempty,1,it)
	endif
	set u=null
	set it=null
endfunction

function KVD takes integer indexId returns nothing
	local unit u=GetTriggerUnit()
	local item it=GetManipulatedItem()
	local player p=GetItemPlayer(it)
	local integer i=LoadInteger(HeroStats,GetHandleId(p),'0BKB')
	local integer rid=0
	if i==0 then
		set rid=BKB09
	elseif i==9 then
		set rid=BKB08
	elseif i==8 then
		set rid=BKB07
	elseif i==7 then
		set rid=BKB06
	elseif i==6 then
		set rid=BKB05
	endif
	if indexId==BKB10 or indexId==BKB09 or indexId==BKB08 or indexId==BKB07 or indexId==BKB06 then
		call ReplaceItemByIdInSlotLoD(u,rid,1,it)
		if i==0 then
			call SaveInteger(HeroStats,GetHandleId(p),'0BKB',9)
		else
			call SaveInteger(HeroStats,GetHandleId(p),'0BKB',IMaxIF(i-1,5))
		endif
	endif
	set u=null
	set it=null
endfunction

function KWD takes integer id returns boolean
	local real KXD
	local trigger t
	local real hp
	local unit u=GetTriggerUnit()
	local item it=GetManipulatedItem()
	if id==ArmletOff then
		set KXD=GetUnitState(u,UNIT_STATE_MAX_LIFE)-GetWidgetLife(u)
		set hp=GetWidgetLife(u)
		call ReplaceItemByIdInSlotLoD(u,ArmletOn,1,it)
		call PhaseBootsRemoveImmolation(u)
//		//call SetWidgetLife(u,hp)
//		set t=CreateTrigger()
//		call TriggerRegisterTimerEvent(t,0.7/25,true)
//		call SaveUnitHandle(MHT,GetHandleId(t),0,u)
//		call SaveBoolean(HeroStats,GetHandleId(u),20,true)
//		call SaveReal(MHT,GetHandleId(t),0,KXD)
//		call echo("started")
//		call TriggerAddCondition(t,Condition(function Armlet_TogglingOn))
//		set t=null
		call AddTimedKeyToUnit(u,4298,.6)
	elseif id==ArmletOn then
		set KXD=GetUnitState(u,UNIT_STATE_MAX_LIFE)-GetWidgetLife(u)
		call ReplaceItemByIdInSlotLoD(u,ArmletOff,1,it)
		call SaveBoolean(HeroStats,GetHandleId(u),20,false)
		//call Armlet_StrBonus(u,0)
		call SetHeroStr(u,IMaxIF(GetHeroStr(u,false)-LoadInteger(HeroStats,GetHandleId(u),'ARML'),1),true)
		call SaveInteger(HeroStats,GetHandleId(u),'ARML',0)
		call PhaseBootsRemoveImmolation(u)
		//call SetWidgetLife(u,RMaxIF(GetUnitState(u,UNIT_STATE_MAX_LIFE)-KXD,1))
	endif
	set u=null
	set it=null
	return false
endfunction

function KZD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local item it
	if EED(Source)then
		call DisableTrigger(t_manipulateitem)
		set it=CreateItem('I0HM',GetUnitX(Source),GetUnitY(Source))//I0HM -> Linken's Sphere
		call UnitAddItem(Source,it)
		if GetWidgetLife(it)>0 then
			call RemoveItem(it)
		endif
		set it=null
		call EnableTrigger(t_manipulateitem)
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call SaveBoolean(HY,(GetHandleId(Source)),129,(false))
	set t=null
	set Source=null
	return false
endfunction

function KAD takes integer indexId returns nothing
	local unit Source=GetTriggerUnit()
	local item B38=GetManipulatedItem()
	local trigger t
	if(indexId==MantaStyle or indexId==MantaStyleRanged)and(LoadBoolean(HY,(GetHandleId(Source)),129)) then
		set t=CreateTrigger()
		call TriggerRegisterTimerEvent(t,.41,false)
		call TriggerAddCondition(t,Condition(function KZD))
		call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
		set t=null
	endif
	set Source=null
	set B38=null
endfunction

function ItemLockOnUsageUnlock takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call SetItemDroppable(LoadItemHandle(HY,h,0),true)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
endfunction

function ItemLockOnUsage takes nothing returns boolean
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,LoadInteger(ItemsData,GetItemTypeId(GetManipulatedItem()),'00CD'),false,function ItemLockOnUsageUnlock)
	call SetItemDroppable(GetManipulatedItem(),false)
	call SaveItemHandle(HY,h,0,GetManipulatedItem())
	set t=null
	return false
endfunction

function MoonShardUsed takes nothing returns nothing
	call RemoveItem(GetManipulatedItem())
	call UnitAddAbility2(GetTriggerUnit(),'A398')
	call DestroyEffect(AddSpecialEffectTarget("effects\\Eclipse.mdx",GetTriggerUnit(),"origin"))
endfunction

function KBD takes nothing returns boolean
	local real x
	local real y
	local real a
	local integer id=F49(GetManipulatedItem())
	local integer iid=GetItemTypeId(GetManipulatedItem())
	if GetUnitTypeId(GetTriggerUnit())!='e00E' and(LoadInteger(ItemsData,iid,'00CD'))>0 and (GetUnitAbilityLevel(GetTriggerUnit(),'A0A5')>0 or IsSpiritBear(GetTriggerUnit())) then//e00E -> Spellcaster, A0A5 -> Summon Spirit Bear
		call ItemLockOnUsage()
	endif
	if iid==Item_Real[MoonShard] then
		if GetUnitAbilityLevel(GetTriggerUnit(),'A398')==0 then
			call MoonShardUsed()
		endif
	elseif iid==Item_Real[Mango] then
		call RemoveItem(GetManipulatedItem())
	elseif iid==Item_Real[AghanimUpgraderGiftable]  then
		if bj_playerIsCrippled[0] then
			call RemoveItem(GetManipulatedItem())
			call HeroAghanim(GetTriggerUnit(),true)
		endif
		set bj_playerIsCrippled[0]=false
	endif
	
	if ISRECIPECLICK then
		call GetMissingItems(GetTriggerUnit(),GetItemReceiptIndex(GetIndex(GetManipulatedItem()),true),GetItemPlayer(GetManipulatedItem()))
		set ISRECIPECLICK=false
	endif
	
	call KSD(id)
	call ESD()
	call KQD()
	call KWD(id)
	call KVD(id)
	call KAD(id)
	return false
endfunction

function KLD takes nothing returns boolean
	if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
		call IssuePointOrderByIdLoc(GetTriggerUnit(),ORDER_attack,FrozenThroneLoc)
	elseif GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
		call IssuePointOrderByIdLoc(GetTriggerUnit(),ORDER_attack,TreeOfLifeLoc)
	endif
	return false
endfunction

function K1D takes nothing returns nothing
	set RangeCreepsAmount=RangeCreepsAmount+1
endfunction

function K0D takes nothing returns nothing
	set MeleeCreepsAmount=MeleeCreepsAmount+1
endfunction

function K5D takes nothing returns boolean
	if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
		call IssuePointOrderByIdLoc(GetTriggerUnit(),ORDER_attack,MidCreepsWaypoint)
	endif
	return false
endfunction

function K2D takes nothing returns boolean
	if GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
		call IssuePointOrderByIdLoc(GetTriggerUnit(),ORDER_attack,MidCreepsWaypoint)
	endif
	return false
endfunction

function M4D takes nothing returns boolean
	if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
		call IssuePointOrderByIdLoc(GetTriggerUnit(),ORDER_attack,TopCreepsWaypoint)
	endif
	return false
endfunction

function M7D takes nothing returns boolean
	if GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
		call IssuePointOrderByIdLoc(GetTriggerUnit(),ORDER_attack,TopCreepsWaypoint)
	endif
	return false
endfunction

function M8D takes nothing returns boolean
	if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
		call IssuePointOrderByIdLoc(GetTriggerUnit(),ORDER_attack,BottomCreepsWaypoint)
	endif
	return false
endfunction

function M9D takes nothing returns boolean
	if GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
		call IssuePointOrderByIdLoc(GetTriggerUnit(),ORDER_attack,BottomCreepsWaypoint)
	endif
	return false
endfunction

function MDD takes nothing returns nothing
	local integer i=1
	local integer id
	loop
		exitwhen i>5
		set id=GetPlayerId(Sentinels[i])
		call Traffic_RegisterData("CSK"+I2S(id),PlayerCS[id])
		call Traffic_RegisterData("ConvertSkillData"+I2S(id),CSDenies[id])
		call Traffic_RegisterData("NK"+I2S(id),(LoadInteger(HY,(400+id),79)))
		set id=GetPlayerId(Scourges[i])
		call Traffic_RegisterData("CSK"+I2S(id),PlayerCS[id])
		call Traffic_RegisterData("ConvertSkillData"+I2S(id),CSDenies[id])
		call Traffic_RegisterData("NK"+I2S(id),(LoadInteger(HY,(400+id),79)))
		set i=i+1
	endloop
endfunction

function ToggleRaxSpawnAnimation takes boolean activate returns nothing
	local unit u
	local string s1
	local string s2
	if activate then
		set s1="stand work alternate"
		set s2="stand work"
	else
		set s1="stand alternate"
		set s2="stand"
	endif
	if IsDead(Elf_Rax_Melee_Top)==false then
		call SetUnitAnimation(Elf_Rax_Melee_Top,s1)
	endif
	if IsDead(Elf_Rax_Melee_Mid)==false then
		call SetUnitAnimation(Elf_Rax_Melee_Mid,s1)
	endif
	if IsDead(Elf_Rax_Melee_Bot)==false then
		call SetUnitAnimation(Elf_Rax_Melee_Bot,s1)
	endif
	if IsDead(Elf_Rax_Range_Top)==false then
		call SetUnitAnimation(Elf_Rax_Range_Top,s1)
	endif
	if IsDead(Elf_Rax_Range_Mid)==false then
		call SetUnitAnimation(Elf_Rax_Range_Mid,s1)
	endif
	if IsDead(Elf_Rax_Range_Bot)==false then
		call SetUnitAnimation(Elf_Rax_Range_Bot,s1)
	endif
	
	if IsDead(Und_Rax_Melee_Top)==false then
		call SetUnitAnimation(Und_Rax_Melee_Top,s2)
	endif
	if IsDead(Und_Rax_Melee_Mid)==false then
		call SetUnitAnimation(Und_Rax_Melee_Mid,s2)
	endif
	if IsDead(Und_Rax_Melee_Bot)==false then
		call SetUnitAnimation(Und_Rax_Melee_Bot,s2)
	endif
	if IsDead(Und_Rax_Range_Top)==false then
		call SetUnitAnimation(Und_Rax_Range_Top,s2)
	endif
	if IsDead(Und_Rax_Range_Mid)==false then
		call SetUnitAnimation(Und_Rax_Range_Mid,s2)
	endif
	if IsDead(Und_Rax_Range_Bot)==false then
		call SetUnitAnimation(Und_Rax_Range_Bot,s2)
	endif
	set u=null
endfunction

function MKD takes nothing returns boolean
	call ToggleRaxSpawnAnimation(true)
	return false
endfunction

function MMD takes group g,integer MOD returns nothing
	local unit u
	loop
		set u=FirstOfGroup(g)
		exitwhen(u==null)
		call GroupRemoveUnit(g,u)
		call SetUnitAbilityLevel(u,WaypointAbilID,MOD)
		call IssuePointOrderByIdLoc(u,ORDER_attack,WaypointLocations[MOD])//attack
	endloop
	set u=null
endfunction


function BoostOfflaneEnd takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	call SetUnitMoveSpeed(u,LoadReal(HY,h,25))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
	set u=null
endfunction

function BoostOfflane takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local real m
	local real d=10
	if TempInteger==1 then
		set m=1.25
	else
		set m=0.75
	endif
	call SaveReal(HY,h,25,GetUnitMoveSpeed(GetEnumUnit()))
	call SetUnitMoveSpeed(GetEnumUnit(),GetUnitMoveSpeed(GetEnumUnit())*m)
	call TimerStart(t,d,false,function BoostOfflaneEnd)
	call SaveUnitHandle(HY,h,0,GetEnumUnit())
	set t=null
endfunction

function CreepSpawning takes nothing returns nothing
	local boolean MQD=ModuloInteger(GetTriggerExecCount(AG),7)==0
	if CreepSpawnDisabled then
		return
	endif
	call ToggleRaxSpawnAnimation(false)
	if MQD then
		call MDD()
	endif
	if GetTriggerExecCount(AG)==1 and Mode_OM==false then
		call UnitResetCooldown(CirclesOfPower[1])
		call UnitResetCooldown(CirclesOfPower[2])
		call UnitResetCooldown(CirclesOfPower[3])
		call UnitResetCooldown(CirclesOfPower[4])
		call UnitResetCooldown(CirclesOfPower[5])
		call UnitResetCooldown(CirclesOfPower[7])
		call UnitResetCooldown(CirclesOfPower[8])
		call UnitResetCooldown(CirclesOfPower[9])
		call UnitResetCooldown(CirclesOfPower[10])
		call UnitResetCooldown(CirclesOfPower[11])
		call UnitRemoveAbility(Towers_Sent_Top_1,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(Towers_Sent_Mid_1,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(Towers_Sent_Bot_1,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(Towers_Scourge_Top_1,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(Towers_Scourge_Mid_1,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(Towers_Scourge_Bot_1,'Avul')//Avul -> Invulnerable
	elseif GetTriggerExecCount(AG)==1 and Mode_OM then
		call UnitRemoveAbility(Towers_Sent_Mid_1,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(Towers_Scourge_Mid_1,'Avul')//Avul -> Invulnerable
	endif
	if GetTriggerExecCount(AG)==1 then
		call EnableTrigger(TriggerGoldPerSecond)
	endif
	if Mode_OM==false and Mode_NT==false then
		if(ElfTopRaxMExists)then
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'ugho',Scourges[0],ScourgeTopMeleeSpawn,bj_UNIT_FACING)//ugho -> Ghoul
		else
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'u001',Scourges[0],ScourgeTopMeleeSpawn,bj_UNIT_FACING)//u001 -> Ghoul
		endif
		if NeedBoost then
			set TempInteger=1
			call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
		endif
		call MMD(bj_lastCreatedGroup,2)
	endif
	if Mode_NM==false then
		if(ElfMidRaxMExists)then
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'ugho',Scourges[0],ScourgeMidMeleeSpawn,bj_UNIT_FACING)//ugho -> Ghoul
		else
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'u001',Scourges[0],ScourgeMidMeleeSpawn,bj_UNIT_FACING)//u001 -> Ghoul
		endif
		call MMD(bj_lastCreatedGroup,3)
	endif
	if Mode_OM==false and Mode_NB==false then
		if(ElfBotRaxMExists)then
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'ugho',Scourges[0],ScourgeBottomMeleeSpawn,bj_UNIT_FACING)//ugho -> Ghoul
		else
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'u001',Scourges[0],ScourgeBottomMeleeSpawn,bj_UNIT_FACING)//u001 -> Ghoul
		endif
		if NeedBoost then
			set TempInteger=2
			call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
		endif
		call MMD(bj_lastCreatedGroup,4)
		
	endif
	if Mode_OM==false and Mode_NT==false then
		if(ElfTopRaxRExists)then
			call CreateNUnitsAtLoc(RangeCreepsAmount,'unec',Scourges[0],ScourgeTopRangeSpawn,bj_UNIT_FACING)//unec -> Necromancer
		else
			call CreateNUnitsAtLoc(RangeCreepsAmount,'u002',Scourges[0],ScourgeTopRangeSpawn,bj_UNIT_FACING)//u002 -> Necromancer
		endif
		if NeedBoost then
			set TempInteger=1
			call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
		endif
		call MMD(bj_lastCreatedGroup,2)
	endif
	if Mode_NM==false then
		if(ElfMidRaxRExists)then
			call CreateNUnitsAtLoc(RangeCreepsAmount,'unec',Scourges[0],ScourgeMidRangeSpawn,bj_UNIT_FACING)//unec -> Necromancer
		else
			call CreateNUnitsAtLoc(RangeCreepsAmount,'u002',Scourges[0],ScourgeMidRangeSpawn,bj_UNIT_FACING)//u002 -> Necromancer
		endif
		call MMD(bj_lastCreatedGroup,3)
	endif
	if Mode_OM==false and Mode_NB==false then
		if(ElfBotRaxRExists)then
			call CreateNUnitsAtLoc(RangeCreepsAmount,'unec',Scourges[0],ScourgeBottomRangeSpawn,bj_UNIT_FACING)//unec -> Necromancer
		else
			call CreateNUnitsAtLoc(RangeCreepsAmount,'u002',Scourges[0],ScourgeBottomRangeSpawn,bj_UNIT_FACING)//u002 -> Necromancer
		endif
		if NeedBoost then
			set TempInteger=2
			call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
		endif
		call MMD(bj_lastCreatedGroup,4)
	endif
	if MQD then
		if Mode_OM==false and Mode_NT==false then
			if(ElfTopRaxRExists)then
				call CreateNUnitsAtLoc(RangeCreepsAmount,'umtw',Scourges[0],ScourgeTopRangeSpawn,bj_UNIT_FACING)//umtw -> Meat Wagon
			else
				call CreateNUnitsAtLoc(RangeCreepsAmount,'u00R',Scourges[0],ScourgeTopRangeSpawn,bj_UNIT_FACING)//u00R -> Meat Wagon
			endif
			if NeedBoost then
				set TempInteger=1
				call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
			endif
			call MMD(bj_lastCreatedGroup,2)
		endif
		if Mode_NM==false then
			if(ElfMidRaxRExists)then
				call CreateNUnitsAtLoc(RangeCreepsAmount,'umtw',Scourges[0],ScourgeMidRangeSpawn,bj_UNIT_FACING)//umtw -> Meat Wagon
			else
				call CreateNUnitsAtLoc(RangeCreepsAmount,'u00R',Scourges[0],ScourgeMidRangeSpawn,bj_UNIT_FACING)//u00R -> Meat Wagon
			endif
			call MMD(bj_lastCreatedGroup,3)
		endif
		if Mode_OM==false and Mode_NB==false then
			if(ElfBotRaxRExists)then
				call CreateNUnitsAtLoc(RangeCreepsAmount,'umtw',Scourges[0],ScourgeBottomRangeSpawn,bj_UNIT_FACING)//umtw -> Meat Wagon
			else
				call CreateNUnitsAtLoc(RangeCreepsAmount,'u00R',Scourges[0],ScourgeBottomRangeSpawn,bj_UNIT_FACING)//u00R -> Meat Wagon
			endif
			if NeedBoost then
				set TempInteger=2
				call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
			endif
			call MMD(bj_lastCreatedGroup,4)
		endif
	endif
	if Mode_OM==false and Mode_NT==false then
		if(UndTopRaxMExists)then
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'esen',Sentinels[0],SentinelTopMeleeSpawn,bj_UNIT_FACING)//esen -> Treant
		else
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'e00V',Sentinels[0],SentinelTopMeleeSpawn,bj_UNIT_FACING)//e00V -> Treant
		endif
		if NeedBoost then
			set TempInteger=2
			call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
		endif
		call MMD(bj_lastCreatedGroup,2)
	endif
	if Mode_NM==false then
		if(UndMidRaxMExists)then
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'esen',Sentinels[0],SentinelMidMeleeSpawn,bj_UNIT_FACING)//esen -> Treant
		else
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'e00V',Sentinels[0],SentinelMidMeleeSpawn,bj_UNIT_FACING)//e00V -> Treant
		endif
		call MMD(bj_lastCreatedGroup,3)
	endif
	if Mode_OM==false and Mode_NB==false then
		if(UndBotRaxMExists)then
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'esen',Sentinels[0],SentinelBottomMeleeSpawn,bj_UNIT_FACING)//esen -> Treant
		else
			call CreateNUnitsAtLoc(MeleeCreepsAmount,'e00V',Sentinels[0],SentinelBottomMeleeSpawn,bj_UNIT_FACING)//e00V -> Treant
		endif
		if NeedBoost then
			set TempInteger=1
			call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
		endif
		call MMD(bj_lastCreatedGroup,4)
	endif
	if Mode_OM==false and Mode_NT==false then
		if(UndTopRaxRExists)then
			call CreateNUnitsAtLoc(RangeCreepsAmount,'edry',Sentinels[0],SentinelTopRangeSpawn,bj_UNIT_FACING)//edry -> Druid of the Talon
		else
			call CreateNUnitsAtLoc(RangeCreepsAmount,'e00W',Sentinels[0],SentinelTopRangeSpawn,bj_UNIT_FACING)//e00W -> Druid of the Talon
		endif
		if NeedBoost then
			set TempInteger=2
			call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
		endif
		call MMD(bj_lastCreatedGroup,2)
	endif
	if Mode_NM==false then
		if(UndMidRaxRExists)then
			call CreateNUnitsAtLoc(RangeCreepsAmount,'edry',Sentinels[0],SentinelMidRangeSpawn,bj_UNIT_FACING)//edry -> Druid of the Talon
		else
			call CreateNUnitsAtLoc(RangeCreepsAmount,'e00W',Sentinels[0],SentinelMidRangeSpawn,bj_UNIT_FACING)//e00W -> Druid of the Talon
		endif
		call MMD(bj_lastCreatedGroup,3)
	endif
	if Mode_OM==false and Mode_NB==false then
		if(UndBotRaxRExists)then
			call CreateNUnitsAtLoc(RangeCreepsAmount,'edry',Sentinels[0],SentinelBottomRangeSpawn,bj_UNIT_FACING)//edry -> Druid of the Talon
		else
			call CreateNUnitsAtLoc(RangeCreepsAmount,'e00W',Sentinels[0],SentinelBottomRangeSpawn,bj_UNIT_FACING)//e00W -> Druid of the Talon
		endif
		if NeedBoost then
			set TempInteger=1
			call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
		endif
		call MMD(bj_lastCreatedGroup,4)
	endif
	if MQD then
		if Mode_OM==false and Mode_NT==false then
			if(UndBotRaxRExists)then
				call CreateNUnitsAtLoc(RangeCreepsAmount,'ebal',Sentinels[0],SentinelTopRangeSpawn,bj_UNIT_FACING)//ebal -> Glaive Thrower
			else
				call CreateNUnitsAtLoc(RangeCreepsAmount,'e026',Sentinels[0],SentinelTopRangeSpawn,bj_UNIT_FACING)//e026 -> Glaive Thrower
			endif
			if NeedBoost then
				set TempInteger=2
				call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
			endif
			call MMD(bj_lastCreatedGroup,2)
		endif
		if Mode_NM==false then
			if(UndMidRaxRExists)then
				call CreateNUnitsAtLoc(RangeCreepsAmount,'ebal',Sentinels[0],SentinelMidRangeSpawn,bj_UNIT_FACING)//ebal -> Glaive Thrower
			else
				call CreateNUnitsAtLoc(RangeCreepsAmount,'e026',Sentinels[0],SentinelMidRangeSpawn,bj_UNIT_FACING)//e026 -> Glaive Thrower
			endif
			call MMD(bj_lastCreatedGroup,3)
		endif
		if Mode_OM==false and Mode_NB==false then
			if(UndBotRaxRExists)then
				call CreateNUnitsAtLoc(RangeCreepsAmount,'ebal',Sentinels[0],SentinelBottomRangeSpawn,bj_UNIT_FACING)//ebal -> Glaive Thrower
			else
				call CreateNUnitsAtLoc(RangeCreepsAmount,'e026',Sentinels[0],SentinelBottomRangeSpawn,bj_UNIT_FACING)//e026 -> Glaive Thrower
			endif
			if NeedBoost then
				set TempInteger=1
				call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
			endif
			call MMD(bj_lastCreatedGroup,4)
		endif
	endif
endfunction

function MRD takes nothing returns nothing
	set ElfTopRaxRExists=false
	call DisableTrigger(Elf_Rax_Range_Top_Deathward)
	call Traffic_RegisterData("Rax"+I2S(0)+I2S(0)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),true)
endfunction

function MSD takes nothing returns nothing
	set ElfMidRaxRExists=false
	call DisableTrigger(Elf_Rax_Range_Mid_Deathward)
	call Traffic_RegisterData("Rax"+I2S(0)+I2S(1)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),true)
endfunction

function MTD takes nothing returns nothing
	set ElfBotRaxRExists=false
	call DisableTrigger(Elf_Rax_Range_Bot_Deathward)
	call Traffic_RegisterData("Rax"+I2S(0)+I2S(2)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),true)
endfunction

function MUD takes nothing returns nothing
	set ElfTopRaxMExists=false
	call DisableTrigger(Elf_Rax_Melee_Top_Deathward)
	call Traffic_RegisterData("Rax"+I2S(0)+I2S(0)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),false)
endfunction

function MVD takes nothing returns nothing
	set ElfMidRaxMExists=false
	call DisableTrigger(Elf_Rax_Melee_Mid_Deathward)
	call Traffic_RegisterData("Rax"+I2S(0)+I2S(1)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),false)
endfunction

function MWD takes nothing returns nothing
	set ElfBotRaxMExists=false
	call DisableTrigger(Elf_Rax_Melee_Bot_Deathward)
	call Traffic_RegisterData("Rax"+I2S(0)+I2S(2)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),false)
endfunction

function MXD takes nothing returns nothing
	set UndTopRaxRExists=false
	call DisableTrigger(Und_Rax_Range_Top_Deathward)
	call Traffic_RegisterData("Rax"+I2S(1)+I2S(0)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),true)
endfunction

function MYD takes nothing returns nothing
	set UndMidRaxRExists=false
	call DisableTrigger(Und_Rax_Range_Mid_Deathward)
	call Traffic_RegisterData("Rax"+I2S(1)+I2S(1)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),true)
endfunction

function MZD takes nothing returns nothing
	set UndBotRaxRExists=false
	call DisableTrigger(Und_Rax_Range_Bot_Deathward)
	call Traffic_RegisterData("Rax"+I2S(1)+I2S(2)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),true)
endfunction

function MAD takes nothing returns nothing
	set UndTopRaxMExists=false
	call DisableTrigger(Und_Rax_Melee_Top_Deathward)
	call Traffic_RegisterData("Rax"+I2S(1)+I2S(0)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),false)
endfunction

function MBD takes nothing returns nothing
	set UndMidRaxMExists=false
	call DisableTrigger(Und_Rax_Melee_Mid_Deathward)
	call Traffic_RegisterData("Rax"+I2S(1)+I2S(1)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),false)
endfunction

function MCD takes nothing returns nothing
	set UndBotRaxMExists=false
	call DisableTrigger(Und_Rax_Melee_Bot_Deathward)
	call Traffic_RegisterData("Rax"+I2S(1)+I2S(2)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
	call RaxKill(GetKillingUnit(),false)
endfunction

function M3D takes nothing returns boolean
	local real M6D=GetWidgetLife(GetTriggerUnit())/ GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)
	if M6D<.75 and XI7==false then
		set XI7=true
		call Traffic_RegisterData("Tree",75)
	endif
	if M6D<.5 and XH7==false then
		set XH7=true
		call Traffic_RegisterData("Tree",50)
	endif
	if M6D<.25 and XG7==false then
		set XG7=true
		call Traffic_RegisterData("Tree",25)
	endif
	if M6D<.1 and XF7==false then
		set XF7=true
		call Traffic_RegisterData("Tree",10)
	endif
	return false
endfunction

function MLD takes nothing returns boolean
	local real M6D=GetWidgetLife(GetTriggerUnit())/ GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)
	if M6D<.75 and XE7==false then
		set XE7=true
		call Traffic_RegisterData("Throne",75)
	endif
	if M6D<.5 and XD7==false then
		set XD7=true
		call Traffic_RegisterData("Throne",50)
	endif
	if M6D<.25 and X97==false then
		set X97=true
		call Traffic_RegisterData("Throne",25)
	endif
	if M6D<.1 and X87==false then
		set X87=true
		call Traffic_RegisterData("Throne",10)
	endif
	return false
endfunction

function M1D takes nothing returns boolean
	return( not(UndTopRaxMExists or UndMidRaxMExists or UndBotRaxMExists or UndTopRaxRExists or UndMidRaxRExists or UndBotRaxRExists))
endfunction

function MegaCreepsSent takes nothing returns nothing
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())]*2,GetObjectName('n04O')+" "+GetObjectName('n0C7'))//n04O -> The Sentinel has destroyed all of the Scourge's unit producing structures. , n0C7 -> The Sentinel now has Mega Creeps.
	call SetPlayerTechResearchedSwap('R00D',(GetPlayerTechCountSimple('R00D',Sentinels[0])+30),Sentinels[0])
	call SetPlayerTechResearchedSwap('R00C',(GetPlayerTechCountSimple('R00C',Sentinels[0])+30),Sentinels[0])
	call DisableTrigger(JG)
endfunction

function M5D takes nothing returns boolean
	return( not(ElfTopRaxMExists or ElfMidRaxMExists or ElfBotRaxMExists or ElfTopRaxRExists or ElfMidRaxRExists or ElfBotRaxRExists))
endfunction

function MegaCreepsScourge takes nothing returns nothing
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())]*2,GetObjectName('n04X')+" "+GetObjectName('n0C9'))//n04X -> The Scourge has destroyed all of the Sentinel's unit producing structures., n0C9 -> The Scourge now has Mega Creeps.
	call SetPlayerTechResearchedSwap('R009',(GetPlayerTechCountSimple('R009',Scourges[0])+30),Scourges[0])
	call SetPlayerTechResearchedSwap('R00B',(GetPlayerTechCountSimple('R00B',Scourges[0])+30),Scourges[0])
	call DisableTrigger(KG)
endfunction

function CreepUpgradeTime takes nothing returns nothing
	call SetPlayerTechResearchedSwap('R007',(GetPlayerTechCountSimple('R007',Sentinels[0])+1),Sentinels[0])
	call SetPlayerTechResearchedSwap('R00C',(GetPlayerTechCountSimple('R00C',Sentinels[0])+1),Sentinels[0])
	call SetPlayerTechResearchedSwap('R008',(GetPlayerTechCountSimple('R008',Sentinels[0])+1),Sentinels[0])
	call SetPlayerTechResearchedSwap('R00D',(GetPlayerTechCountSimple('R00D',Sentinels[0])+1),Sentinels[0])
	call SetPlayerTechResearchedSwap('R009',(GetPlayerTechCountSimple('R009',Scourges[0])+1),Scourges[0])
	call SetPlayerTechResearchedSwap('R003',(GetPlayerTechCountSimple('R003',Scourges[0])+1),Scourges[0])
	call SetPlayerTechResearchedSwap('R00A',(GetPlayerTechCountSimple('R00A',Scourges[0])+1),Scourges[0])
	call SetPlayerTechResearchedSwap('R00B',(GetPlayerTechCountSimple('R00B',Scourges[0])+1),Scourges[0])
	set NeedBoost=false
endfunction

function PreloadNeutrals takes nothing returns nothing
	local location YT9=GetRectCenter(J5)
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nbdo',YT9,bj_UNIT_FACING))//nbdo -> Blue Dragonspawn Overseer
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nbds',YT9,bj_UNIT_FACING))//nbds -> Blue Dragonspawn Sorcerer
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'ngst',YT9,bj_UNIT_FACING))//ngst -> Rock Golem
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'n026',YT9,bj_UNIT_FACING))//n026 -> Mud Golem
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nggr',YT9,bj_UNIT_FACING))//nggr -> Emerald Golem
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nbdk',YT9,bj_UNIT_FACING))//nbdk -> Black Drake
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nbwm',YT9,bj_UNIT_FACING))//nbwm -> Black Dragon
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nogm',YT9,bj_UNIT_FACING))//nogm -> Ogre Mauler
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nomg',YT9,bj_UNIT_FACING))//nomg -> Ogre Magi
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nfpc',YT9,bj_UNIT_FACING))//nfpc -> Polar Furbolg Champion
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nfpu',YT9,bj_UNIT_FACING))//nfpu -> Polar Furbolg Ursa Warrior
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nsth',YT9,bj_UNIT_FACING))//nsth -> Satyr Hellcaller
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nstl',YT9,bj_UNIT_FACING))//nstl -> Satyr Soulstealer
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nsat',YT9,bj_UNIT_FACING))//nsat -> Satyr Trickster
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nwlg',YT9,bj_UNIT_FACING))//nwlg -> Giant Wolf
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nkol',YT9,bj_UNIT_FACING))//nkol -> Kobold Taskmaster
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nkob',YT9,bj_UNIT_FACING))//nkob -> Kobold
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nkot',YT9,bj_UNIT_FACING))//nkot -> Kobold Tunneler
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'ncnk',YT9,bj_UNIT_FACING))//ncnk -> Centaur Khan
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'ncen',YT9,bj_UNIT_FACING))//ncen -> Centaur Outrunner
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'ngns',YT9,bj_UNIT_FACING))//ngns -> Gnoll Assassin
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nftb',YT9,bj_UNIT_FACING))//nftb -> Forest Troll Berserker
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nfsh',YT9,bj_UNIT_FACING))//nfsh -> Forest Troll High Priest
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'ngh1',YT9,bj_UNIT_FACING))//ngh1 -> Ghost
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'npfl',YT9,bj_UNIT_FACING))//npfl -> Fel Beast
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nowe',YT9,bj_UNIT_FACING))//nowe -> Enraged Wildkin
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nowb',YT9,bj_UNIT_FACING))//nowb -> Wildkin
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nmrm',YT9,bj_UNIT_FACING))//nmrm -> Murloc Nightcrawler
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nmrr',YT9,bj_UNIT_FACING))//nmrr -> Murloc Huntsman
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'nmrl',YT9,bj_UNIT_FACING))//nmrl -> Murloc Tiderunner
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'ndtr',YT9,bj_UNIT_FACING))//ndtr -> Dark Troll
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'ndtw',YT9,bj_UNIT_FACING))//ndtw -> Dark Troll Warlord
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'n0LC',YT9,bj_UNIT_FACING))//n0LC -> Thunder Lizard
	call RemoveUnit(CreateUnitAtLoc(Neutrals,'n0LD',YT9,bj_UNIT_FACING))//n0LD -> Thunder Lizard
	call RemoveLocation(YT9)
	set YT9=null
endfunction

function SpawnNeutrals_Harpies takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'n0HW',x,y,0),x,y)//n0HW -> Harpy Scout
	call SetUnitPosition(CreateUnit(Neutrals,'n0HX',x,y,0),x,y)//n0HX -> Harpy Storm
	call SetUnitPosition(CreateUnit(Neutrals,'n0HW',x,y,0),x,y)//n0HW -> Harpy Scout
endfunction

function SpawnNeutrals_Junglers takes real x,real y returns nothing
	local unit u
	set u=CreateUnit(Neutrals,'njg1',x,y,0)//njg1 -> Jungle Stalker
	call SetUnitPosition(u,x,y)
	set u=CreateUnit(Neutrals,'njg1',x,y,0)//njg1 -> Jungle Stalker
	call SetUnitPosition(u,x,y)
	set u=CreateUnit(Neutrals,'njga',x,y,0)//njga -> Elder Jungle Stalker
	call SetUnitPosition(u,x,y)
	set u=null
endfunction

function SpawnNeutrals_DragonOverseers takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nbdo',x,y,0),x,y)//nbdo -> Blue Dragonspawn Overseer
	call SetUnitPosition(CreateUnit(Neutrals,'nbdo',x,y,0),x,y)//nbdo -> Blue Dragonspawn Overseer
	call SetUnitPosition(CreateUnit(Neutrals,'nbds',x,y,0),x,y)//nbds -> Blue Dragonspawn Sorcerer
endfunction

function SpawnNeutrals_BlackDragons takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nbdk',x,y,0),x,y)//nbdk -> Black Drake
	call SetUnitPosition(CreateUnit(Neutrals,'nbdk',x,y,0),x,y)//nbdk -> Black Drake
	call SetUnitPosition(CreateUnit(Neutrals,'nbwm',x,y,0),x,y)//nbwm -> Black Dragon
endfunction

function SpawnNeutrals_RockGolems takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'ngst',x,y,0),x,y)//ngst -> Rock Golem
	call SetUnitPosition(CreateUnit(Neutrals,'ngst',x,y,0),x,y)//ngst -> Rock Golem
	call SetUnitPosition(CreateUnit(Neutrals,'nggr',x,y,0),x,y)//nggr -> Emerald Golem
endfunction

function SpawnNeutrals_Lizards takes real x,real y returns nothing
	local unit u
	set u=CreateUnit(Neutrals,'n0LC',x,y,0)//n0LC -> Thunder Lizard
	call SetUnitPosition(u,x,y)
	call SetUnitPosition(CreateUnit(Neutrals,'n0LD',x,y,0),x,y)//n0LD -> Thunder Lizard
	call SetUnitPosition(CreateUnit(Neutrals,'n0LD',x,y,0),x,y)//n0LD -> Thunder Lizard
	set u=null
endfunction

function SpawnNeutrals_Ogres takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nogm',x,y,0),x,y)//nogm -> Ogre Mauler
	call SetUnitPosition(CreateUnit(Neutrals,'nogm',x,y,0),x,y)//nogm -> Ogre Mauler
	call SetUnitPosition(CreateUnit(Neutrals,'nomg',x,y,0),x,y)//nomg -> Ogre Magi
endfunction

function SpawnNeutrals_Furbolgs takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nfpc',x,y,0),x,y)//nfpc -> Polar Furbolg Champion
	call SetUnitPosition(CreateUnit(Neutrals,'nfpu',x,y,0),x,y)//nfpu -> Polar Furbolg Ursa Warrior
endfunction

function SpawnNeutrals_SatyrsBig takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nsth',x,y,0),x,y)//nsth -> Satyr Hellcaller
	call SetUnitPosition(CreateUnit(Neutrals,'nstl',x,y,0),x,y)//nstl -> Satyr Soulstealer
	call SetUnitPosition(CreateUnit(Neutrals,'nsat',x,y,0),x,y)//nsat -> Satyr Trickster
endfunction

function SpawnNeutrals_SatyrsSmall takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nstl',x,y,0),x,y)//nstl -> Satyr Soulstealer
	call SetUnitPosition(CreateUnit(Neutrals,'nstl',x,y,0),x,y)//nstl -> Satyr Soulstealer
	call SetUnitPosition(CreateUnit(Neutrals,'nsat',x,y,0),x,y)//nsat -> Satyr Trickster
	call SetUnitPosition(CreateUnit(Neutrals,'nsat',x,y,0),x,y)//nsat -> Satyr Trickster
endfunction

function SpawnNeutrals_Wolves takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nwlg',x,y,0),x,y)//nwlg -> Giant Wolf
	call SetUnitPosition(CreateUnit(Neutrals,'nwlg',x,y,0),x,y)//nwlg -> Giant Wolf
	call SetUnitPosition(CreateUnit(Neutrals,'n00S',x,y,0),x,y)//n00S -> Alpha Wolf
endfunction

function SpawnNeutrals_MudGolems takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'n026',x,y,0),x,y)//n026 -> Mud Golem
	call SetUnitPosition(CreateUnit(Neutrals,'n026',x,y,0),x,y)//n026 -> Mud Golem
endfunction

function SpawnNeutrals_Kobolds takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nkol',x,y,0),x,y)//nkol -> Kobold Taskmaster
	call SetUnitPosition(CreateUnit(Neutrals,'nkob',x,y,0),x,y)//nkob -> Kobold
	call SetUnitPosition(CreateUnit(Neutrals,'nkob',x,y,0),x,y)//nkob -> Kobold
	call SetUnitPosition(CreateUnit(Neutrals,'nkob',x,y,0),x,y)//nkob -> Kobold
	call SetUnitPosition(CreateUnit(Neutrals,'nkot',x,y,0),x,y)//nkot -> Kobold Tunneler
endfunction

function SpawnNeutrals_Trolls takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nftb',x,y,0),x,y)//nftb -> Forest Troll Berserker
	call SetUnitPosition(CreateUnit(Neutrals,'nftb',x,y,0),x,y)//nftb -> Forest Troll Berserker
	call SetUnitPosition(CreateUnit(Neutrals,'nfsh',x,y,0),x,y)//nfsh -> Forest Troll High Priest
endfunction

function SpawnNeutrals_Centaurs takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'ncen',x,y,0),x,y)//ncen -> Centaur Outrunner
	call SetUnitPosition(CreateUnit(Neutrals,'ncnk',x,y,0),x,y)//ncnk -> Centaur Khan
endfunction

function SpawnNeutrals_Gnolls takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'ngns',x,y,0),x,y)//ngns -> Gnoll Assassin
	call SetUnitPosition(CreateUnit(Neutrals,'ngns',x,y,0),x,y)//ngns -> Gnoll Assassin
	call SetUnitPosition(CreateUnit(Neutrals,'ngns',x,y,0),x,y)//ngns -> Gnoll Assassin
endfunction

function SpawnNeutrals_TrollsKobold takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nftb',x,y,0),x,y)//nftb -> Forest Troll Berserker
	call SetUnitPosition(CreateUnit(Neutrals,'nftb',x,y,0),x,y)//nftb -> Forest Troll Berserker
	call SetUnitPosition(CreateUnit(Neutrals,'nkol',x,y,0),x,y)//nkol -> Kobold Taskmaster
endfunction

function SpawnNeutrals_Banshee takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'ngh1',x,y,0),x,y)//ngh1 -> Ghost
	call SetUnitPosition(CreateUnit(Neutrals,'npfl',x,y,0),x,y)//npfl -> Fel Beast
	call SetUnitPosition(CreateUnit(Neutrals,'npfl',x,y,0),x,y)//npfl -> Fel Beast
endfunction

function SpawnNeutrals_Wildkins takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'nowe',x,y,0),x,y)//nowe -> Enraged Wildkin
	call SetUnitPosition(CreateUnit(Neutrals,'nowb',x,y,0),x,y)//nowb -> Wildkin
	call SetUnitPosition(CreateUnit(Neutrals,'nowb',x,y,0),x,y)//nowb -> Wildkin
endfunction

function SpawnNeutrals_DarkTrolls takes real x,real y returns nothing
	call SetUnitPosition(CreateUnit(Neutrals,'ndtr',x,y,0),x,y)//ndtr -> Dark Troll
	call SetUnitPosition(CreateUnit(Neutrals,'ndtr',x,y,0),x,y)//ndtr -> Dark Troll
	call SetUnitPosition(CreateUnit(Neutrals,'ndtw',x,y,0),x,y)//ndtw -> Dark Troll Warlord
endfunction

function NWD takes real x,real y returns nothing
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=SpawnHistory[0]
		set i=GetRandomInt(1,5)
	endloop
	set SpawnHistory[0]=i
	if i==1 then
		call SpawnNeutrals_Furbolgs(x,y)
	elseif i==2 then
		call SpawnNeutrals_SatyrsBig(x,y)
	elseif i==3 then
		call SpawnNeutrals_Wildkins(x,y)
	elseif i==4 then
		call SpawnNeutrals_DarkTrolls(x,y)
	elseif i==5 then
		call SpawnNeutrals_Centaurs(x,y)
	endif
endfunction

function NXD takes real x,real y returns nothing
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=SpawnHistory[1]
		set i=GetRandomInt(1,5)
	endloop
	set SpawnHistory[1]=i
	if i==1 then
		call SpawnNeutrals_Furbolgs(x,y)
	elseif i==2 then
		call SpawnNeutrals_SatyrsBig(x,y)
	elseif i==3 then
		call SpawnNeutrals_Wildkins(x,y)
	elseif i==4 then
		call SpawnNeutrals_DarkTrolls(x,y)
	elseif i==5 then
		call SpawnNeutrals_Centaurs(x,y)
	endif
endfunction

function NYD takes real x,real y returns nothing
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=SpawnHistory[2]
		set i=GetRandomInt(1,5)
	endloop
	set SpawnHistory[2]=i
	if i==1 then
		call SpawnNeutrals_Furbolgs(x,y)
	elseif i==2 then
		call SpawnNeutrals_SatyrsBig(x,y)
	elseif i==3 then
		call SpawnNeutrals_Wildkins(x,y)
	elseif i==4 then
		call SpawnNeutrals_DarkTrolls(x,y)
	elseif i==5 then
		call SpawnNeutrals_Centaurs(x,y)
	endif
endfunction

function NZD takes real x,real y returns nothing
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=SpawnHistory[3]
		set i=GetRandomInt(1,5)
	endloop
	set SpawnHistory[3]=i
	if i==1 then
		call SpawnNeutrals_Furbolgs(x,y)
	elseif i==2 then
		call SpawnNeutrals_SatyrsBig(x,y)
	elseif i==3 then
		call SpawnNeutrals_Wildkins(x,y)
	elseif i==4 then
		call SpawnNeutrals_DarkTrolls(x,y)
	elseif i==5 then
		call SpawnNeutrals_Centaurs(x,y)
	endif
endfunction

function NAD takes real x,real y returns nothing
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=SpawnHistory[4]
		set i=GetRandomInt(1,5)
	endloop
	set SpawnHistory[4]=i
	if i==1 then
		call SpawnNeutrals_MudGolems(x,y)
	elseif i==2 then
		call SpawnNeutrals_Ogres(x,y)
	elseif i==3 then
		call SpawnNeutrals_SatyrsSmall(x,y)
	elseif i==4 then
		call SpawnNeutrals_Wolves(x,y)
	elseif i==5 then
		call SpawnNeutrals_Centaurs(x,y)
	endif
endfunction

function NBD takes real x,real y returns nothing
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=SpawnHistory[5]
		set i=GetRandomInt(1,5)
	endloop
	set SpawnHistory[5]=i
	if i==1 then
		call SpawnNeutrals_MudGolems(x,y)
	elseif i==2 then
		call SpawnNeutrals_Ogres(x,y)
	elseif i==3 then
		call SpawnNeutrals_SatyrsSmall(x,y)
	elseif i==4 then
		call SpawnNeutrals_Wolves(x,y)
	elseif i==5 then
		call SpawnNeutrals_Centaurs(x,y)
	endif
endfunction

function NCD takes real x,real y returns nothing
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=SpawnHistory[6]
		set i=GetRandomInt(1,5)
	endloop
	set SpawnHistory[6]=i
	if i==1 then
		call SpawnNeutrals_MudGolems(x,y)
	elseif i==2 then
		call SpawnNeutrals_Ogres(x,y)
	elseif i==3 then
		call SpawnNeutrals_SatyrsSmall(x,y)
	elseif i==4 then
		call SpawnNeutrals_Wolves(x,y)
	elseif i==5 then
		call SpawnNeutrals_Centaurs(x,y)
	endif
endfunction

function N3D takes real x,real y returns nothing
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=SpawnHistory[7]
		set i=GetRandomInt(1,5)
	endloop
	set SpawnHistory[7]=i
	if i==1 then
		call SpawnNeutrals_MudGolems(x,y)
	elseif i==2 then
		call SpawnNeutrals_Ogres(x,y)
	elseif i==3 then
		call SpawnNeutrals_SatyrsSmall(x,y)
	elseif i==4 then
		call SpawnNeutrals_Wolves(x,y)
	elseif i==5 then
		call SpawnNeutrals_Centaurs(x,y)
	endif
endfunction

function N6D takes real x,real y returns nothing
	local integer i=GetRandomInt(1,6)
	loop
		exitwhen i!=SpawnHistory[8]
		set i=GetRandomInt(1,6)
	endloop
	set SpawnHistory[8]=i
	if i==1 then
		call SpawnNeutrals_Banshee(x,y)
	elseif i==2 then
		call SpawnNeutrals_TrollsKobold(x,y)
	elseif i==3 then
		call SpawnNeutrals_Gnolls(x,y)
	elseif i==4 then
		call SpawnNeutrals_Kobolds(x,y)
	elseif i==5 then
		call SpawnNeutrals_Trolls(x,y)
	elseif i==6 then
		call SpawnNeutrals_Harpies(x,y)
	endif
endfunction

function NLD takes real x,real y returns nothing
	local integer i=GetRandomInt(1,6)
	loop
		exitwhen i!=SpawnHistory[9]
		set i=GetRandomInt(1,6)
	endloop
	set SpawnHistory[9]=i
	if i==1 then
		call SpawnNeutrals_Banshee(x,y)
	elseif i==2 then
		call SpawnNeutrals_TrollsKobold(x,y)
	elseif i==3 then
		call SpawnNeutrals_Gnolls(x,y)
	elseif i==4 then
		call SpawnNeutrals_Kobolds(x,y)
	elseif i==5 then
		call SpawnNeutrals_Trolls(x,y)
	elseif i==6 then
		call SpawnNeutrals_Harpies(x,y)
	endif
endfunction

function N1D takes real x,real y returns nothing//scourge's ancients
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=SpawnHistory[10]
		set i=GetRandomInt(3,5)
	endloop
	set SpawnHistory[10]=i
	if i==1 then
		call SpawnNeutrals_Junglers(x,y)
	elseif i==2 then
		call SpawnNeutrals_DragonOverseers(x,y)
	elseif i==3 then
		call SpawnNeutrals_BlackDragons(x,y)
	elseif i==4 then
		call SpawnNeutrals_RockGolems(x,y)
	elseif i==5 then
		call SpawnNeutrals_Lizards(x,y)
	endif
endfunction

function N0D takes real x,real y returns nothing
	local integer i=GetRandomInt(1,5)
	loop
		exitwhen i!=SpawnHistory[11]
		set i=GetRandomInt(3,5)
	endloop
	set SpawnHistory[11]=i
	if i==1 then
		call SpawnNeutrals_Junglers(x,y)
	elseif i==2 then
		call SpawnNeutrals_DragonOverseers(x,y)
	elseif i==3 then
		call SpawnNeutrals_BlackDragons(x,y)
	elseif i==4 then
		call SpawnNeutrals_RockGolems(x,y)
	elseif i==5 then
		call SpawnNeutrals_Lizards(x,y)
	endif
endfunction

function N5D takes nothing returns nothing
	if GetUnitAbilityLevel(GetEnumUnit(),'A0P4')!=0 or GetUnitTypeId(GetEnumUnit())=='o003' or GetUnitTypeId(GetEnumUnit())=='o01X' or IsDead(GetEnumUnit()) or IsCourier(GetEnumUnit()) then//A0P4 -> Marker Allow Neutral Spawn, o003 -> Spin Web, o01X -> Stone Rock
		call GroupRemoveUnit(TempGroup2,GetEnumUnit())
	endif
endfunction

function N2D takes group g returns boolean
	set TempGroup2=g
	call ForGroup(g,function N5D)
	return FirstOfGroup(g)==null
endfunction

function IsSpawnLocker takes nothing returns boolean
	if GetUnitAbilityLevel(GetFilterUnit(),'A0P4')!=0 or GetUnitTypeId(GetFilterUnit())=='o003' or GetUnitTypeId(GetFilterUnit())=='o01X' or IsDead(GetFilterUnit()) or IsCourier(GetFilterUnit()) then//A0P4 -> Marker Allow Neutral Spawn, o003 -> Spin Web, o01X -> Stone Rock
		return false
	endif
	return true
endfunction

function NeutralsRespawn takes nothing returns boolean
	local group g
	local rect r1
	local rect r2
	if Mode_NN then
		return false
	endif
	set g=GetAvailableGroup()
	call GroupEnumUnitsInRect(g,NR_Und_A,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call N1D(GetRectCenterX(NR_Und_Ar),GetRectCenterY(NR_Und_Ar))//scourge ancients
	endif
	call GroupEnumUnitsInRect(g,NR_Elf_A,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call N0D(GetRectCenterX(NR_Elf_Ar),GetRectCenterY(NR_Elf_Ar))//sent ancients
	endif
	call GroupEnumUnitsInRect(g,NR_Elf_C,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call NWD(GetRectCenterX(NR_Elf_Cr),GetRectCenterY(NR_Elf_Cr))//sent center
	endif
	call GroupEnumUnitsInRect(g,NR_Und_Bp,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call NYD(GetRectCenterX(NR_Und_Bpr),GetRectCenterY(NR_Und_Bpr))//scourge big pulled
	endif
	call GroupEnumUnitsInRect(g,NR_Und_P,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call NLD(GetRectCenterX(NR_Und_Pr),GetRectCenterY(NR_Und_Pr))//scourge pulling
	endif
	call GroupEnumUnitsInRect(g,NR_Elf_P,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call N6D(GetRectCenterX(NR_Elf_Pr),GetRectCenterY(NR_Elf_Pr))//sent pulling
	endif
	call GroupEnumUnitsInRect(g,NR_Und_TR,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call NCD(GetRectCenterX(NR_Und_TRr),GetRectCenterY(NR_Und_TRr))//scourge toprune
	endif
	call GroupEnumUnitsInRect(g,NR_Elf_BR,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call N3D(GetRectCenterX(NR_Elf_BRr),GetRectCenterY(NR_Elf_BRr))//sent runewiev
	endif
	call GroupEnumUnitsInRect(g,NR_Und_BB,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call NZD(GetRectCenterX(NR_Und_BBr),GetRectCenterY(NR_Und_BBr))//scourge big near base
	endif
	call GroupEnumUnitsInRect(g,NR_Elf_OldSm,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call NAD(GetRectCenterX(NR_Elf_OldSmr),GetRectCenterY(NR_Elf_OldSmr))//sentinel old small
	endif
	call GroupEnumUnitsInRect(g,NR_Uld_OldSm,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call NBD(GetRectCenterX(NR_Uld_OldSmr),GetRectCenterY(NR_Uld_OldSmr))//scourge old small
	endif
	call GroupEnumUnitsInRect(g,NR_Elf_Roof,Condition(function IsSpawnLocker))
	if FirstOfGroup(g)==null then
		call NXD(GetRectCenterX(NR_Elf_Roofr),GetRectCenterY(NR_Elf_Roofr))
	endif
	call KillGroup(g)
	set r1=null
	set r2=null
	set g=null
	return false
endfunction

function SuperCreeps takes nothing returns nothing
	local integer i=0
	local group g
	local unit u=null
	local real x1
	local real y1
	local real x2
	local real y2
	local integer array creepid
	local integer cid=GetRandomInt(0,2)
	local integer rid=0
	local string s=""
	local unit u2
	if Mode_NM and Mode_NT and Mode_NB then//fuck it?
		return
	endif
	set creepid[0]='n003'//n003 -> Siege Golem
	set creepid[1]='n00E'//n00E -> Scary Fish
	set creepid[2]='n00D'//n00D -> Ancient Hydra
	set rid=creepid[cid]//Result ID = rid, creeps being spawnd id
	set cid=GetRandomInt(0,2)//get path: 0=middle, 1=bottom, 2=top
	if Mode_OM then
		set cid=0
	endif
	if (Mode_NM and cid==0) or (Mode_NT and cid==2) or (Mode_NB and cid==1) then
		loop
			set cid=GetRandomInt(0,2)
			exitwhen (Mode_NM and cid!=0) or (Mode_NT and cid!=2) or (Mode_NB and cid!=1)
		endloop
	endif
	if cid==0 then
		set x1=GetRectCenterX(Waypoints_SentMidSpawn)
		set y1=GetRectCenterY(Waypoints_SentMidSpawn)
		set x2=GetRectCenterX(Waypoints_ScMidSpawn)
		set y2=GetRectCenterY(Waypoints_ScMidSpawn)
		set i=2
		set s="middle"
	elseif cid==1 then
		set x1=GetRectCenterX(Waypoints_SentBotSpawn)
		set y1=GetRectCenterY(Waypoints_SentBotSpawn)
		set x2=GetRectCenterX(Waypoints_ScBotSpawn)
		set y2=GetRectCenterY(Waypoints_ScBotSpawn)
		set i=3
		set s="bottom"
	else
		set x1=GetRectCenterX(Waypoints_SentTopSpawn)
		set y1=GetRectCenterY(Waypoints_SentTopSpawn)
		set x2=GetRectCenterX(Waypoints_ScTopSpawn)
		set y2=GetRectCenterY(Waypoints_ScTopSpawn)
		set i=4
		set s="top"
	endif
	if rid>0 then
		set g=GetAvailableGroup()
		set u=CreateUnit(Sentinels[0],rid,x1,y1,90)
		call GroupAddUnit(g,u)
		set u2=CreateUnit(Scourges[0],rid,x2,y2,90)
		call GroupAddUnit(g,u2)
		call MMD(g,i)
		if NeedBoost and cid!=0 then
			call GroupClear(g)
			if cid==1 then
				set TempInteger=1
				call GroupAddUnit(g,u)
				call ForGroup(g,function BoostOfflane)
				call GroupClear(g)
				set TempInteger=2
				call GroupAddUnit(g,u2)
				call ForGroup(g,function BoostOfflane)
			else
				set TempInteger=1
				call GroupAddUnit(g,u2)
				call ForGroup(g,function BoostOfflane)
				call GroupClear(g)
				set TempInteger=2
				call GroupAddUnit(g,u)
				call ForGroup(g,function BoostOfflane)
			endif
		endif
		call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())],"|c000000ff"+GetObjectName(rid)+"|r has been spawned for both teams and is taking the "+s+" path")
		call KillGroup(g)
	endif
	set g=null
	set u=null
	set u2=null
endfunction

function Trig_display_leaderboard_Actions takes nothing returns nothing
	local integer k
	local integer j
	local integer n
	local integer m
	local integer i
	local player p
	local integer pid
	local string sred
	local string sgreen
	local string sblue
	set XM7=XM7+1
	set SentinelsIngame=0
	set ScourgesIngame=0
	set i=0
	loop
		exitwhen i>5
		set p=Sentinels[i]
		if IsPlayerExisted(p)then
			set SentinelsIngame=SentinelsIngame+1
		endif
		set p=Scourges[i]
		if IsPlayerExisted(p)then
			set ScourgesIngame=ScourgesIngame+1
		endif
		set i=i+1
	endloop
	if YM==false then
		set M1=SentinelsIngame
		set N1=ScourgesIngame
	endif
	set k=1
	set j=5
	set n=1
	loop
		exitwhen k>j
		set p=Sentinels[k]
		if IsPlayerExisted(p)then
			set Sents[n]=p
			set n=n+1
		endif
		set k=k+1
	endloop
	set k=1
	set j=5
	set n=1
	loop
		exitwhen k>j
		set p=Scourges[k]
		if IsPlayerExisted(p)then
			set Scrgs[n]=p
			set n=n+1
		endif
		set k=k+1
	endloop
	if XM7==1 then
		set MainMB=CreateMultiboardBJ(8+6,3+ScourgesIngame+SentinelsIngame," ")
		call MultiboardMinimize(MainMB,true)
	endif
	if NumberOfExtraAbilities>=2 then
		call MBSetText(MainMB,2,1,"CD1")
		call MBSetText(MainMB,3,1,"CD2")
	else
		call MBSetText(MainMB,2,1,"CD")
		call MBSetText(MainMB,3,1," ")
	endif
	call MBSetText(MainMB,4,1,"|c00838B8BL|r")
	call MBSetText(MainMB,5,1,RED+"K|r")
	call MBSetText(MainMB,6,1,BLUE+"D|r")
	call MBSetText(MainMB,7,1,GREY+"A|r")
	call MBSetText(MainMB,1,2,GetObjectName('n0DK'))//n0DK -> The Sentinel
	call MBSetText(MainMB,5,2,RED+"0|r")
	call MBSetText(MainMB,6,2,BLUE+"0|r")
	call MBSetText(MainMB,1,3+SentinelsIngame,GetObjectName('n0DO'))//n0DO -> The Scourge
	call MBSetText(MainMB,5,3+SentinelsIngame,RED+"0|r")
	call MBSetText(MainMB,6,3+SentinelsIngame,BLUE+"0|r")
	set pid=GetPlayerId(Sentinels[0])
	call MBSetColor(MainMB,1,2,VL8(SubString(udg_Colors[pid],4,6))/255.*100, VL8(SubString(udg_Colors[pid],6,8))/255.*100, VL8(SubString(udg_Colors[pid],8,10))/255.*100,0)
	set pid=GetPlayerId(Scourges[0])
	call MBSetColor(MainMB,1,3+SentinelsIngame,VL8(SubString(udg_Colors[pid],4,6))/255.*100, VL8(SubString(udg_Colors[pid],6,8))/255.*100, VL8(SubString(udg_Colors[pid],8,10))/255.*100,0)
	set k=1
	set j=3+ScourgesIngame+SentinelsIngame
	loop
		exitwhen k>j
		call MBSetWidth(MainMB,1,k,10.8)
		call MBSetWidth(MainMB,2,k,2)
		if NumberOfExtraAbilities>=2 then
			call MBSetWidth(MainMB,3,k,2)
		else
			call MBSetWidth(MainMB,3,k,.01)
		endif
		call MBSetWidth(MainMB,4,k,2)
		call MBSetWidth(MainMB,5,k,1.3)
		call MBSetWidth(MainMB,6,k,1.3)
		call MBSetWidth(MainMB,7,k,1.3)
		call MBSetWidth(MainMB,8,k,2.5)
		call MBSetWidth(MainMB,9,k,.01)
		call MBSetWidth(MainMB,10,k,.01)
		call MBSetWidth(MainMB,11,k,.01)
		call MBSetWidth(MainMB,12,k,.01)
		call MBSetWidth(MainMB,13,k,.01)
		call MBSetWidth(MainMB,14,k,.01)
		set k=k+1
	endloop
	set k=1
	set j=8+6
	loop
		exitwhen k>j
		set n=1
		set m=3+ScourgesIngame+SentinelsIngame
		loop
			exitwhen n>m
			call MBSetStyle(MainMB,k,n,true,false)
			set n=n+1
		endloop
		set k=k+1
	endloop
	set k=1
	set j=SentinelsIngame
	loop
		exitwhen k>j
		call MBSetStyle(MainMB,1,k+2,true,true)
		call MBSetColor(MainMB,8,k+2,255,204,0,0)
		set pid=GetPlayerId(Sents[k])
		set XJ7[pid]=1-1
		set XK7[pid]=k+2-1
		call MBSetText(MainMB,1,k+2,(PlayerNames[pid]))
		if IsPlayer(Sents[k])then
			set sred=SubString(udg_Colors[pid],4,6)
			set sgreen=SubString(udg_Colors[pid],6,8)
			set sblue=SubString(udg_Colors[pid],8,10)
			call MBSetColor(MainMB,1,k+2,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
			call MBSetColor(MainMB,2,k+2,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
			call MBSetColor(MainMB,3,k+2,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
		else
			call MBSetText(MainMB,1,k+2,"|c00333333"+(PlayerNames[pid])+"|r")
		endif
		call MBSetText(MainMB,5,k+2,RED+"0|r")
		call MBSetText(MainMB,6,k+2,BLUE+"0|r")
		call MBSetText(MainMB,7,k+2,GREY+"0|r")
		set k=k+1
	endloop
	set k=1
	set j=ScourgesIngame
	loop
		exitwhen k>j
		call MBSetStyle(MainMB,1,k+3+SentinelsIngame,true,true)
		call MBSetColor(MainMB,8,k+3+SentinelsIngame,255,204,0,0)
		set pid=GetPlayerId(Scrgs[k])
		set XJ7[pid]=1-1
		set XK7[pid]=k+3+SentinelsIngame-1
		call MBSetText(MainMB,1,k+3+SentinelsIngame,(PlayerNames[pid]))
		if IsPlayer(Scrgs[k])then
			set sred=SubString(udg_Colors[pid],4,6)
			set sgreen=SubString(udg_Colors[pid],6,8)
			set sblue=SubString(udg_Colors[pid],8,10)
			call MBSetColor(MainMB,1,k+3+SentinelsIngame,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
			call MBSetColor(MainMB,2,k+3+SentinelsIngame,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
			call MBSetColor(MainMB,3,k+3+SentinelsIngame,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
		else
			call MBSetText(MainMB,1,k+3+SentinelsIngame,"|c00333333"+(PlayerNames[pid])+"|r")
		endif
		call MBSetText(MainMB,5,k+3+SentinelsIngame,RED+"0|r")
		call MBSetText(MainMB,6,k+3+SentinelsIngame,BLUE+"0|r")
		call MBSetText(MainMB,7,k+3+SentinelsIngame,GREY+"0|r")
		set k=k+1
	endloop
	if udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2)and XM7==1 then
		call MultiboardDisplay(MainMB,false)
	endif
	call MBSetStyle(MainMB,8,1,false,true)
	call MBSetIcon(MainMB,8,1,"UI\\Feedback\\Resources\\ResourceGold.blp")
	if XM7>1 then
		call TriggerExecute(TG)
	endif
	set p=null
endfunction

function RefreshBoard takes nothing returns nothing
	local integer i
	local integer k
	call MBSetText(MainMB,5,2,RED+I2S(Kills[GetPlayerId(Sentinels[0])])+"|r")
	call MBSetText(MainMB,6,2,BLUE+I2S(Deaths[GetPlayerId(Sentinels[0])])+"|r")
	call MBSetText(MainMB,5,3+SentinelsIngame,RED+I2S(Kills[GetPlayerId(Scourges[0])])+"|r")
	call MBSetText(MainMB,6,3+SentinelsIngame,BLUE+I2S(Deaths[GetPlayerId(Scourges[0])])+"|r")
	set i=1
	set k=SentinelsIngame
	loop
		exitwhen i>k
		call MBSetText(MainMB,5,(i+2),RED+I2S(Kills[GetPlayerId(Sents[i])])+"|r")
		call MBSetText(MainMB,6,(i+2),BLUE+I2S(Deaths[GetPlayerId(Sents[i])])+"|r")
		call MBSetText(MainMB,7,(i+2),GREY+I2S(Assists[GetPlayerId(Sents[i])])+"|r")
		set i=i+1
	endloop
	set i=1
	set k=ScourgesIngame
	loop
		exitwhen i>k
		call MBSetText(MainMB,5,(i+3+SentinelsIngame),RED+I2S(Kills[GetPlayerId(Scrgs[i])])+"|r")
		call MBSetText(MainMB,6,(i+3+SentinelsIngame),BLUE+I2S(Deaths[GetPlayerId(Scrgs[i])])+"|r")
		call MBSetText(MainMB,7,(i+3+SentinelsIngame),GREY+I2S(Assists[GetPlayerId(Scrgs[i])])+"|r")
		set i=i+1
	endloop
endfunction

function OJD takes integer a returns integer
	local integer i=0
	local integer x=0
	local string s=I2S(a)
	loop
		exitwhen i>StringLength(s)
		if SubString(s,i,i+1)=="1"then
			set x=x+1
		endif
		set i=i+1
	endloop
	return x
endfunction

function OKD takes player p,integer k returns string
	if IsPlayerAlly(GetLocalPlayer(),p) then
		if SpellInfoShown[GetPlayerId(GetLocalPlayer())] then
			if k<=4+NumberOfExtraAbilities then
				return SkillIcon[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+k]]
			else
				return EmptySlotPath
			endif
		endif
		return GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(p)],k-1))
//	elseif SpellInfoShown[GetPlayerId(GetLocalPlayer())] then
//		if IsSentinel(p) then
//			if LoadBoolean(MHT,'SPL0'+GetPlayerId(p),SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+k]])then
//				return SkillIcon[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+k]]
//			else
//				return EmptySlotPath
//			endif
//		else
//			if LoadBoolean(MHT,'SPLH'+GetPlayerId(p),SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+k]])then
//				return SkillIcon[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+k]]
//			else
//				return EmptySlotPath
//			endif
//		endif
	else
		return EmptySlotPath
	endif
endfunction

function GetChargesForPlayer takes nothing returns string
	local integer pid=GetPlayerId(GetLocalPlayer())
	local string charges=""
	if LoadBoolean(HeroStats,GetHandleId(GetLocalPlayer()),'OptC') then
		return ""
	endif
	if GetUnitAbilityLevel(udg_Hero[pid],'A0K9')>0 then//A0K9 -> Blink Strike
		set charges=charges+"|c0064a8e5"
		set charges=charges+I2S(LoadInteger(HY,GetHandleId(udg_Hero[pid]),'A0K9'))//A0K9 -> Blink Strike
		set charges=charges+" ("+I2S(R2I(LoadReal(HY,GetHandleId(LoadTriggerHandle(HY,GetHandleId(udg_Hero[pid]),'A0K9')),0)))+")"//A0K9 -> Blink Strike
		set charges=charges+"|r;"
	endif
	if GetUnitAbilityLevel(udg_Hero[pid],'A34J')>0 then//A34J -> Demonic Purge
		if charges!="" then
			set charges=charges+" "
		endif
		set charges=charges+"|c009621c4"
		set charges=charges+I2S(LoadInteger(HY,GetHandleId(udg_Hero[pid]),'A34J'))//A34J -> Demonic Purge
		set charges=charges+" ("+I2S(R2I(LoadReal(HY,GetHandleId(LoadTriggerHandle(HY,GetHandleId(udg_Hero[pid]),'A34J')),0)))+")"//A34J -> Demonic Purge
		set charges=charges+"|r;"
	endif
	if GetUnitAbilityLevel(udg_Hero[pid],'A064')>0 then//A064 -> Shrapnel
		if charges!="" then
			set charges=charges+" "
		endif
		set charges=charges+"|c00dcf1f7"
		set charges=charges+I2S(LoadInteger(HY,GetHandleId(udg_Hero[pid]),'A064'))//A064 -> Shrapnel
		set charges=charges+" ("+I2S(R2I(LoadReal(HY,GetHandleId(LoadTriggerHandle(HY,GetHandleId(udg_Hero[pid]),'A064')),0)))+")"//A064 -> Shrapnel
		set charges=charges+"|r;"
	endif
	if charges!="" then
		set charges="Charges: "+charges
	endif
	return charges
endfunction

function BigRefreshBoard takes nothing returns nothing
	local integer VT8
	local integer VU8
	local string Time
	local real YO8
	local string s1=" "
	local integer r
	local integer i
	local integer array time_1a
	local string array color_1a
	local integer index_1a=0
	local integer array time_1b
	local string array color_1b
	local integer index_1b=0
	local integer x=0
	local integer id
	local string OOD
	local string OPD
	local string OQD
	local string ORD
	local string OSD
	local string s2=" "
	local string s
	local string sbis
	local real OTD
	local real OTDbis
	local string spacer
	local integer OUD=0
	local string OVD=""
	local string OWD=""
	local integer OXD=0
	local integer OYD=0
	local string OZD=""
	local integer pid
	local string charges=""
	if MainMB==null then
		return
	endif
	set charges=GetChargesForPlayer()
	
	set i=1
	loop
		exitwhen i>5
		set pid=GetPlayerId(Sentinels[i])
		set r=R2I(TimerGetRemaining(HeroRespawnTimer[pid]))
		if r>0 then
			set OUD=OUD+OJD(r)
			if OXD==0 then
				if r<10 then
					set OVD=udg_Colors[pid]+"0"+I2S(r)+" |r"
				else
					set OVD=udg_Colors[pid]+I2S(r)+" |r"
				endif
			else
				if r<10 then
					set OVD=OVD+WHITE+"| |r"+udg_Colors[pid]+"0"+I2S(r)+" |r"
				else
					set OVD=OVD+WHITE+"| |r"+udg_Colors[pid]+I2S(r)+" |r"
				endif
			endif
			set OXD=OXD+1
		endif
		set i=i+1
	endloop
	if OXD>0 then
		if IsPlayerAlly(GetLocalPlayer(),Sentinels[0]) then
			set OVD=WHITE+"["+GetObjectName('n0JS')+" |r"+OVD+WHITE+"]|r"//n0JS -> Allied:
		else
			set OVD=RED2+"["+GetObjectName('n0JR')+" |r"+OVD+RED2+"]|r"//n0JR -> Enemy:
		endif
	endif
	set i=1
	loop
		exitwhen i>5
		set pid=GetPlayerId(Scourges[i])
		set r=R2I(TimerGetRemaining(HeroRespawnTimer[pid]))
		if r>0 then
			set OUD=OUD+OJD(r)
			if OYD==0 then
				if r<10 then
					set OWD=udg_Colors[pid]+"0"+I2S(r)+" |r"
				else
					set OWD=udg_Colors[pid]+I2S(r)+" |r"
				endif
			else
				if r<10 then
					set OWD=OWD+WHITE+"| |r"+udg_Colors[pid]+"0"+I2S(r)+" |r"
				else
					set OWD=OWD+WHITE+"| |r"+udg_Colors[pid]+I2S(r)+" |r"
				endif
			endif
			set OYD=OYD+1
		endif
		set i=i+1
	endloop
	if OYD>0 then
		if IsPlayerAlly(GetLocalPlayer(),Scourges[0]) then
			set OWD=WHITE+"["+GetObjectName('n0JS')+" |r"+OWD+WHITE+"]|r"//n0JS -> Allied:
		else
			set OWD=RED2+"["+GetObjectName('n0JR')+" |r"+OWD+RED2+"]|r"//n0JR -> Enemy:
		endif
	endif
	if MainMB!=null then
		set id=GetPlayerId(GetLocalPlayer())
		if id>=0 and id<16 then
			if CSONStatus1[x]then
				set OOD=I2S(Kills[id])
				set OPD=I2S(Deaths[id])
				set OQD=I2S(Assists[id])
				set ORD=I2S(PlayerCS[id])
				set OSD=I2S(CSDenies[id])
				set s2=" |c00838B8B("+OOD+"/"+OPD+"/"+OQD+" - "+ORD+"/"+OSD+" - |r|c00FFDC00"+I2S(ReliableGold[id])+"|r |c00838B8B)|r"
			endif
		endif
	endif
	if OYD==0 and OXD==0 then
		call MultiboardSetTitleText(MainMB,charges+s2)
	else
		if IsPlayerAlly(GetLocalPlayer(),Sentinels[0]) then
			call MultiboardSetTitleText(MainMB,charges+OWD+" "+OVD+" "+s2)
		else
			call MultiboardSetTitleText(MainMB,charges+OVD+" "+OWD+" "+s2)
		endif
	endif
	if not b_isPickTime then
		if(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2))==false then
			call MultiboardDisplay(MainMB,true)
		endif
	endif
	if CustomWaterColor[GetPlayerId(GetLocalPlayer())]==false then
		call SetWaterBaseColor(0,0,255,255)
	endif
	set VT8=1
	set VU8=SentinelsIngame
	loop
		exitwhen VT8>VU8
		set pid=GetPlayerId(Sents[VT8])
		call MBSetIcon(MainMB,1,VT8+2,US8(udg_Hero[pid]))
		call MBSetText(MainMB,4,VT8+2,"|c00838B8B"+I2S(GetHeroLevel(udg_Hero[pid]))+"|r")
		if ItemInfoShown[GetPlayerId(GetLocalPlayer())]then
			call MBSetWidth(MainMB,8,1,3)
			call MBSetWidth(MainMB,9,1,2.8)
			call MBSetWidth(MainMB,10,1,.8)
			call MBSetWidth(MainMB,11,1,.8)
			call MBSetWidth(MainMB,12,1,.8)
			call MBSetWidth(MainMB,13,1,.8)
			call MBSetWidth(MainMB,14,1,.1)
			call MBSetWidth(MainMB,8,VT8+2,3)
			call MBSetWidth(MainMB,9,VT8+2,1.1)
			call MBSetWidth(MainMB,10,VT8+2,1.1)
			call MBSetWidth(MainMB,11,VT8+2,1.1)
			call MBSetWidth(MainMB,12,VT8+2,1.1)
			call MBSetWidth(MainMB,13,VT8+2,1.1)
			call MBSetWidth(MainMB,14,VT8+2,.1)
			call MBSetStyle(MainMB,9,VT8+2,false,true)
			call MBSetStyle(MainMB,10,VT8+2,false,true)
			call MBSetStyle(MainMB,11,VT8+2,false,true)
			call MBSetStyle(MainMB,12,VT8+2,false,true)
			call MBSetStyle(MainMB,13,VT8+2,false,true)
			call MBSetStyle(MainMB,14,VT8+2,false,true)
			call MBSetText(MainMB,9,1,"Items")
		elseif SpellInfoShown[GetPlayerId(GetLocalPlayer())]then
			call MBSetWidth(MainMB,8,1,3)
			call MBSetWidth(MainMB,9,1,2.8)
			call MBSetWidth(MainMB,10,1,.8)
			call MBSetWidth(MainMB,11,1,.8)
			call MBSetWidth(MainMB,12,1,.8)
			call MBSetWidth(MainMB,13,1,.8)
			call MBSetWidth(MainMB,14,1,.1)
			call MBSetWidth(MainMB,8,VT8+2,3)
			call MBSetWidth(MainMB,9,VT8+2,1.1)
			call MBSetWidth(MainMB,10,VT8+2,1.1)
			call MBSetWidth(MainMB,11,VT8+2,1.1)
			if NumberOfExtraAbilities>=1 then
				call MBSetWidth(MainMB,12,VT8+2,1.1)
			else
				call MBSetWidth(MainMB,12,VT8+2,.1)
			endif
			if NumberOfExtraAbilities>=2 then
				call MBSetWidth(MainMB,13,VT8+2,1.1)
			else
				call MBSetWidth(MainMB,13,VT8+2,.1)
			endif
			call MBSetWidth(MainMB,14,VT8+2,.1)
			call MBSetStyle(MainMB,9,VT8+2,false,true)
			call MBSetStyle(MainMB,10,VT8+2,false,true)
			call MBSetStyle(MainMB,11,VT8+2,false,true)
			call MBSetStyle(MainMB,12,VT8+2,false,true)
			if NumberOfExtraAbilities>=1 then
				call MBSetStyle(MainMB,13,VT8+2,false,true)
			else
				call MBSetStyle(MainMB,13,VT8+2,false,false)
			endif
			if NumberOfExtraAbilities>=2 then
				call MBSetStyle(MainMB,14,VT8+2,false,true)
			else
				call MBSetStyle(MainMB,14,VT8+2,false,false)
			endif
			call MBSetText(MainMB,9,1,"Spells")
		else
			call MBSetWidth(MainMB,8,1,2)
			call MBSetWidth(MainMB,9,1,.1)
			call MBSetWidth(MainMB,10,1,.1)
			call MBSetWidth(MainMB,11,1,.1)
			call MBSetWidth(MainMB,12,1,.1)
			call MBSetWidth(MainMB,13,1,.1)
			call MBSetWidth(MainMB,14,1,.1)
			call MBSetWidth(MainMB,8,VT8+2,2.5)
			call MBSetWidth(MainMB,9,VT8+2,.1)
			call MBSetWidth(MainMB,10,VT8+2,.1)
			call MBSetWidth(MainMB,11,VT8+2,.1)
			call MBSetWidth(MainMB,12,VT8+2,.1)
			call MBSetWidth(MainMB,13,VT8+2,.1)
			call MBSetWidth(MainMB,14,VT8+2,.1)
			call MBSetStyle(MainMB,9,VT8+2,false,false)
			call MBSetStyle(MainMB,10,VT8+2,false,false)
			call MBSetStyle(MainMB,11,VT8+2,false,false)
			call MBSetStyle(MainMB,12,VT8+2,false,false)
			call MBSetStyle(MainMB,13,VT8+2,false,false)
			call MBSetStyle(MainMB,14,VT8+2,false,false)
			call MBSetText(MainMB,9,1," ")
		endif
		call MBSetIcon(MainMB,9,VT8+2,OKD(Sents[VT8],1))
		call MBSetIcon(MainMB,10,VT8+2,OKD(Sents[VT8],2))
		call MBSetIcon(MainMB,11,VT8+2,OKD(Sents[VT8],3))
		call MBSetIcon(MainMB,12,VT8+2,OKD(Sents[VT8],4))
		call MBSetIcon(MainMB,13,VT8+2,OKD(Sents[VT8],5))
		call MBSetIcon(MainMB,14,VT8+2,OKD(Sents[VT8],6))
		set pid=GetPlayerId(Sents[VT8])
		if(UA8(udg_Hero[pid])and udg_Hero[pid]!=null and TimerGetRemaining(HeroRespawnTimer[pid])>0)then
			if IsPlayerAlly(GetLocalPlayer(),Sents[VT8])then
				set OZD=WHITE+" ("+I2S(R2I(TimerGetRemaining(HeroRespawnTimer[pid])))+")|r"
			else
				set OZD=RED2+" ("+I2S(R2I(TimerGetRemaining(HeroRespawnTimer[pid])))+")|r"
			endif
		else
			set OZD="  "
		endif
		if IsPlayerLeftGame[pid]then
			call MBSetText(MainMB,1,VT8+2,TabTab+"|c00333333"+(PlayerNames[pid])+"|r"+OZD)
		else
			call MBSetText(MainMB,1,VT8+2,TabTab+(PlayerNames[pid])+OZD)
		endif
		set OTD=(TimerGetRemaining(PrimUltiTimer[pid]))
		if OTD>0 then
			set s=I2S(R2I(OTD))
		else
			set s=" "
		endif
		set OTDbis=(TimerGetRemaining(SecUltiTimer[pid]))
		if OTDbis>0 then
			set sbis=I2S(R2I(OTDbis))
		else
			set sbis=" "
		endif
		if IsPlayerEnemy(GetLocalPlayer(),Sents[VT8]) and GetUnitAbilityLevel(udg_Hero[GetPlayerId(Sents[VT8])],'B00L')==0 then
			call MBSetText(MainMB,8,VT8+2," ")
			set s=" "
			set sbis=" "
		else
			call MBSetText(MainMB,8,VT8+2,"|cffffcc00"+I2S(R2I(GetPlayerState(Sents[VT8],PLAYER_STATE_RESOURCE_GOLD)))+"|r")
		endif
		call MBSetText(MainMB,2,VT8+2,s)
		call MBSetText(MainMB,3,VT8+2,sbis)
		set VT8=VT8+1
	endloop
	set VT8=1
	set VU8=ScourgesIngame
	loop
		exitwhen VT8>VU8
		set pid=GetPlayerId(Scrgs[VT8])
		call MBSetIcon(MainMB,1,VT8+3+SentinelsIngame,US8(udg_Hero[pid]))
		call MBSetText(MainMB,4,VT8+3+SentinelsIngame,"|c00838B8B"+I2S(GetHeroLevel(udg_Hero[pid]))+"|r")
		if ItemInfoShown[GetPlayerId(GetLocalPlayer())]then
			call MBSetWidth(MainMB,8,1,3)
			call MBSetWidth(MainMB,9,1,2.8)
			call MBSetWidth(MainMB,10,1,.8)
			call MBSetWidth(MainMB,11,1,.8)
			call MBSetWidth(MainMB,12,1,.8)
			call MBSetWidth(MainMB,13,1,.8)
			call MBSetWidth(MainMB,14,1,.1)
			call MBSetWidth(MainMB,8,VT8+3+SentinelsIngame,3)
			call MBSetWidth(MainMB,9,VT8+3+SentinelsIngame,1.1)
			call MBSetWidth(MainMB,10,VT8+3+SentinelsIngame,1.1)
			call MBSetWidth(MainMB,11,VT8+3+SentinelsIngame,1.1)
			call MBSetWidth(MainMB,12,VT8+3+SentinelsIngame,1.1)
			call MBSetWidth(MainMB,13,VT8+3+SentinelsIngame,1.1)
			call MBSetWidth(MainMB,14,VT8+3+SentinelsIngame,.1)
			call MBSetStyle(MainMB,9,VT8+3+SentinelsIngame,false,true)
			call MBSetStyle(MainMB,10,VT8+3+SentinelsIngame,false,true)
			call MBSetStyle(MainMB,11,VT8+3+SentinelsIngame,false,true)
			call MBSetStyle(MainMB,12,VT8+3+SentinelsIngame,false,true)
			call MBSetStyle(MainMB,13,VT8+3+SentinelsIngame,false,true)
			call MBSetStyle(MainMB,14,VT8+3+SentinelsIngame,false,true)
			call MBSetText(MainMB,9,1,"Items")
		elseif SpellInfoShown[GetPlayerId(GetLocalPlayer())]then
			call MBSetWidth(MainMB,8,1,3)
			call MBSetWidth(MainMB,9,1,2.8)
			call MBSetWidth(MainMB,10,1,.8)
			call MBSetWidth(MainMB,11,1,.8)
			call MBSetWidth(MainMB,12,1,.8)
			call MBSetWidth(MainMB,13,1,.8)
			call MBSetWidth(MainMB,14,1,.1)
			call MBSetWidth(MainMB,8,VT8+3+SentinelsIngame,3)
			call MBSetWidth(MainMB,9,VT8+3+SentinelsIngame,1.1)
			call MBSetWidth(MainMB,10,VT8+3+SentinelsIngame,1.1)
			call MBSetWidth(MainMB,11,VT8+3+SentinelsIngame,1.1)
			if NumberOfExtraAbilities>=1 then
				call MBSetWidth(MainMB,12,VT8+3+SentinelsIngame,1.1)
			else
				call MBSetWidth(MainMB,12,VT8+3+SentinelsIngame,.1)
			endif
			if NumberOfExtraAbilities>=2 then
				call MBSetWidth(MainMB,13,VT8+3+SentinelsIngame,1.1)
			else
				call MBSetWidth(MainMB,13,VT8+3+SentinelsIngame,.1)
			endif
			call MBSetWidth(MainMB,14,VT8+3+SentinelsIngame,.1)
			call MBSetStyle(MainMB,9,VT8+3+SentinelsIngame,false,true)
			call MBSetStyle(MainMB,10,VT8+3+SentinelsIngame,false,true)
			call MBSetStyle(MainMB,11,VT8+3+SentinelsIngame,false,true)
			call MBSetStyle(MainMB,12,VT8+3+SentinelsIngame,false,true)
			if NumberOfExtraAbilities>=1 then
				call MBSetStyle(MainMB,13,VT8+3+SentinelsIngame,false,true)
			else
				call MBSetStyle(MainMB,13,VT8+3+SentinelsIngame,false,false)
			endif
			if NumberOfExtraAbilities>=2 then
				call MBSetStyle(MainMB,14,VT8+3+SentinelsIngame,false,true)
			else
				call MBSetStyle(MainMB,14,VT8+3+SentinelsIngame,false,false)
			endif
			call MBSetText(MainMB,9,1,"Spells")
		else
			call MBSetWidth(MainMB,8,1,2)
			call MBSetWidth(MainMB,9,1,.1)
			call MBSetWidth(MainMB,10,1,.1)
			call MBSetWidth(MainMB,11,1,.1)
			call MBSetWidth(MainMB,12,1,.1)
			call MBSetWidth(MainMB,13,1,.1)
			call MBSetWidth(MainMB,14,1,.1)
			call MBSetWidth(MainMB,8,VT8+3+SentinelsIngame,2.5)
			call MBSetWidth(MainMB,9,VT8+3+SentinelsIngame,.1)
			call MBSetWidth(MainMB,10,VT8+3+SentinelsIngame,.1)
			call MBSetWidth(MainMB,11,VT8+3+SentinelsIngame,.1)
			call MBSetWidth(MainMB,12,VT8+3+SentinelsIngame,.1)
			call MBSetWidth(MainMB,13,VT8+3+SentinelsIngame,.1)
			call MBSetWidth(MainMB,14,VT8+3+SentinelsIngame,.1)
			call MBSetStyle(MainMB,9,VT8+3+SentinelsIngame,false,false)
			call MBSetStyle(MainMB,10,VT8+3+SentinelsIngame,false,false)
			call MBSetStyle(MainMB,11,VT8+3+SentinelsIngame,false,false)
			call MBSetStyle(MainMB,12,VT8+3+SentinelsIngame,false,false)
			call MBSetStyle(MainMB,13,VT8+3+SentinelsIngame,false,false)
			call MBSetStyle(MainMB,14,VT8+3+SentinelsIngame,false,false)
			call MBSetText(MainMB,9,1," ")
		endif
		call MBSetIcon(MainMB,9,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],1))
		call MBSetIcon(MainMB,10,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],2))
		call MBSetIcon(MainMB,11,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],3))
		call MBSetIcon(MainMB,12,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],4))
		call MBSetIcon(MainMB,13,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],5))
		call MBSetIcon(MainMB,14,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],6))
		set pid=GetPlayerId(Scrgs[VT8])
		if(UA8(udg_Hero[pid])and udg_Hero[pid]!=null and TimerGetRemaining(HeroRespawnTimer[pid])>0)then
			if IsPlayerAlly(GetLocalPlayer(),Scrgs[VT8])then
				set OZD=WHITE+" ("+I2S(R2I(TimerGetRemaining(HeroRespawnTimer[pid])))+")|r"
			else
				set OZD=RED2+" ("+I2S(R2I(TimerGetRemaining(HeroRespawnTimer[pid])))+")|r"
			endif
		else
			set OZD="  "
		endif
		if IsPlayerLeftGame[pid]then
			call MBSetText(MainMB,1,VT8+3+SentinelsIngame,TabTab+"|c00333333"+(PlayerNames[pid])+"|r"+OZD)
		else
			call MBSetText(MainMB,1,VT8+3+SentinelsIngame,TabTab+(PlayerNames[pid])+OZD)
		endif
		set OTD=TimerGetRemaining(PrimUltiTimer[pid])
		if OTD>0 then
			set s=I2S(R2I(OTD))
		else
			set s=" "
		endif
		set OTDbis=TimerGetRemaining(SecUltiTimer[pid])
		if OTDbis>0 then
			set sbis=I2S(R2I(OTDbis))
		else
			set sbis=" "
		endif
		if IsPlayerEnemy(GetLocalPlayer(),Scrgs[VT8]) and GetUnitAbilityLevel(udg_Hero[GetPlayerId(Scrgs[VT8])],'B00L')==0 then
			call MBSetText(MainMB,8,VT8+3+SentinelsIngame," ")
			set s=" "
			set sbis=" "
		else
			call MBSetText(MainMB,8,VT8+3+SentinelsIngame,"|cffffcc00"+I2S(R2I(GetPlayerState(Scrgs[VT8],PLAYER_STATE_RESOURCE_GOLD)))+"|r")
		endif
		call MBSetText(MainMB,2,VT8+3+SentinelsIngame,s)
		call MBSetText(MainMB,3,VT8+3+SentinelsIngame,sbis)
		set VT8=VT8+1
	endloop
endfunction

function OAD takes player p returns string
	return udg_Colors[GetPlayerId(p)]+PlayerNames[GetPlayerId(p)]+"|r"
endfunction

function OBD takes player p returns string
	local string OCD=I2S(AssistsBonusGoldCounter[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function O6D takes player p returns string
	local string OCD=I2S(AssistsBonusExpCounter[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function I59 takes nothing returns nothing
	local integer i=1
	local multiboarditem mbitem
	loop
		exitwhen i>XA7
		if(LeftAt[GetPlayerId((XZ7[i]))])!="Here"then
			set mbitem=MultiboardGetItem(FinalMB,XX7[i],XY7[i])
			call MultiboardSetItemStyle(mbitem,true,false)
			call MultiboardSetItemValue(mbitem,"|c00555555"+(LeftAt[GetPlayerId((XZ7[i]))])+"|r")
			call MultiboardSetItemWidth(mbitem,.07)
			call MultiboardReleaseItem(mbitem)
		endif
		set i=i+1
	endloop
	set mbitem=null
endfunction

function OLD takes player p returns string
	local string OCD=I2S(GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD))
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function O1D takes player p returns string
	local string OCD=I2S(ItemStats_Consumables[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function O0D takes player p returns string
	local string OCD=I2S(GetUnitLevel(udg_Hero[GetPlayerId(p)]))
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function O5D takes player p returns string
	local string OCD=I2S(ItemStats_Wards[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function O2D takes player p returns string
	local string OCD=I2S(GoldEarnedByKills[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function P4D takes player p returns string
	local string OCD=I2S(PlayerGoldLost[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function P7D takes player p returns string
	local string OCD=I2S(Assists[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function P8D takes player p returns string
	local string OCD=I2S(Kills[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function P9D takes player p returns string
	local string OCD=I2S(Deaths[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function PDD takes player p returns string
	local string OCD=I2S(PlayerCS[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function PED takes player p returns string
	local string OCD=I2S(CSDenies[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function PFD takes player p returns string
	local string OCD=I2S((LoadInteger(HY,(400+GetPlayerId(p)),79)))
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function PGD takes player p returns string
	local string OCD=I2S(DoubleKills[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function PHD takes player p returns string
	local string OCD=I2S(TrippleKills[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function PID takes player p returns string
	local string OCD=I2S(PlayerBestStreak[GetPlayerId(p)])
	local string O3D=OCD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+OCD+"|r"
	endif
	return O3D
endfunction

function PJD takes player p returns string
	local string PKD
	local string PMD
	local string O3D
	local integer k=PlayerTowersKilled[GetPlayerId(p)]
	local integer d=PlayerTowersDenied[GetPlayerId(p)]
	if k<1 then
		set k=0
	endif
	if d<1 then
		set d=0
	endif
	set PKD=I2S(k)
	set PMD=I2S(d)
	set O3D=PKD+"/"+PMD
	if p==GetLocalPlayer()then
		set O3D=ORANGE+PKD+"|r/"+ORANGE+PMD+"|r"
	endif
	return O3D
endfunction

function PND takes player p returns string
	local integer POD=PlayerTimeDead[GetPlayerId(p)]
	local string Time
	local integer Minutes
	local integer Seconds
	set Minutes=(POD/ 60)-(1/ 2)
	set Seconds=ModuloInteger(POD,60)
	if(Seconds<10)then
		set Time=I2S(Minutes)+":0"+I2S(Seconds)
	else
		set Time=I2S(Minutes)+":"+I2S(Seconds)
	endif
	if p==GetLocalPlayer()then
		set Time=ORANGE+Time+"|r"
	endif
	return Time
endfunction

function PPD takes player Source,player Target returns string
	local string PKD
	local string PMD
	local string O3D
	local integer k=LoadInteger(HY,400+GetPlayerId(Source),450+GetPlayerId(Target))
	local integer d=LoadInteger(HY,400+GetPlayerId(Source),500+GetPlayerId(Target))
	if k<1 then
		set k=0
	endif
	if d<1 then
		set d=0
	endif
	set PKD=I2S(k)
	set PMD=I2S(d)
	set O3D=PKD+"/"+PMD
	if Source==GetLocalPlayer()then
		set O3D=ORANGE+PKD+"|r/"+ORANGE+PMD+"|r"
	endif
	return O3D
endfunction

function MBWrapper takes multiboarditem mbitem, boolean ItemStyle1, boolean ItemStyle2, string Value, string IconPath, real wdth returns nothing
	call MultiboardSetItemStyle(mbitem,ItemStyle1,ItemStyle2)
	if IconPath!=null then
		call MultiboardSetItemIcon(mbitem,IconPath)
	endif
	if Value!=null then
		call MultiboardSetItemValue(mbitem,Value)
	endif
	if wdth>0 then
		call MultiboardSetItemWidth(mbitem,wdth)
	endif
endfunction

function DisplayFinalMB takes nothing returns nothing
	local integer elf=SentinelsIngame
	local integer und=ScourgesIngame
	local player array PTD
	local player array PUD
	local integer curRow
	local integer curCol
	local integer numRows=21+IMaxIF(elf,und)+1
	local integer numCols=1+(elf+und)*2
	local multiboarditem mbitem
	local integer i
	local integer x
	local string e="|r"
	local string c0="|cff99ccff"
	local integer PZD
	local integer PAD
	call DisableTrigger(QG)
	call DestroyMultiboard(MainMB)
	if elf>0 and und>0 then
		set numRows=numRows+2
	endif
	set FinalMB=CreateMultiboard()
	call MultiboardSetItemsWidth(FinalMB,0)
	call MultiboardSetRowCount(FinalMB,numRows)
	call MultiboardSetColumnCount(FinalMB,numCols)
	call MultiboardSetTitleText(FinalMB,GetObjectName('n0E3')+" "+" - "+(ModeNameString))//n0E3 -> DotA Scores
	call MultiboardMinimize(FinalMB,true)
	call MultiboardSetItemsStyle(FinalMB,false,false)
	call MultiboardDisplay(FinalMB,true)
	call MultiboardMinimize(FinalMB,false)
	call MultiboardSetTitleText(FinalMB,GetObjectName('n0E3')+" "+" - "+(ModeNameString)+" - "+("|c00ff0303"+I2S(Kills[GetPlayerId(Sentinels[0])])+"|r/|c0020c000"+I2S(Deaths[GetPlayerId(Sentinels[0])])+"|r"))//n0E3 -> DotA Scores
	set x=1
	set i=1
	loop
		exitwhen i>5
		if IsPlayer(Sentinels[i])or GetPlayerSlotState(Sentinels[i])==PLAYER_SLOT_STATE_LEFT then
			set PTD[x]=Sentinels[i]
			set x=x+1
		endif
		set i=i+1
	endloop
	set x=1
	set i=1
	loop
		exitwhen i>5
		if IsPlayer(Scourges[i])or GetPlayerSlotState(Scourges[i])==PLAYER_SLOT_STATE_LEFT then
			set PUD[x]=Scourges[i]
			set x=x+1
		endif
		set i=i+1
	endloop
	set i=0
	set curCol=0
	loop
		exitwhen i>numRows
		set mbitem=MultiboardGetItem(FinalMB,i,curCol)
		call MultiboardSetItemWidth(mbitem,.075)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=0
	set curCol=0
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem," ")
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,false,false)
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,OAD(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,OAD(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,false,false)
	call MultiboardReleaseItem(mbitem)
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,true,O0D(PTD[i]),US8(udg_Hero[GetPlayerId(PTD[i])]),.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,true,O0D(PUD[i]),US8(udg_Hero[GetPlayerId(PUD[i])]),.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0EB')+e)//n0EB -> Items
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],0)),.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],1)),.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],0)),.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],1)),.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+" "+e)
	call MultiboardReleaseItem(mbitem)
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],2)),.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],3)),.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],2)),.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],3)),.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+" "+e)
	call MultiboardReleaseItem(mbitem)
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],4)),.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],5)),.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],4)),.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,false,true,null,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],5)),.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E2')+e)//n0E2 -> Current Gold
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,OLD(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,OLD(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E1')+e)//n0E1 -> Hero K/D/A
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,P8D(PTD[i])+"/"+P9D(PTD[i])+"/"+P7D(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,P8D(PUD[i])+"/"+P9D(PUD[i])+"/"+P7D(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DZ')+e)//n0DZ -> Creep Stats
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PDD(PTD[i])+"/"+PED(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PDD(PUD[i])+"/"+PED(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0JU')+e)//n0JU -> Bonus Gold
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,OBD(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,OBD(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0KF')+e)//n0KF -> Bonus XP
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,O6D(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,O6D(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E0')+e)//n0E0 -> Wards
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,O5D(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,O5D(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DT')+e)//n0DT -> Tower Stats
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PJD(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PJD(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DY')+e)//n0DY -> Neutral kills
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PFD(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PFD(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DU')+e)//n0DU -> Hero Kill Gold
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,O2D(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,O2D(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DV')+e)//n0DV -> Time Dead
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PND(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PND(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DW')+e)//n0DW -> Gold Lost
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,P4D(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,P4D(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DN')+e)//n0DN -> Consumables
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,O1D(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,O1D(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0D8')+e)//n0D8 -> Double Kills
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PGD(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PGD(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DI')+e)//n0DI -> Triple Kills
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PHD(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PHD(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DM')+e)//n0DM -> Longest Spree
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PID(PTD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,PID(PUD[i]),null,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	if elf>0 and und>0 then
		set curCol=0
		set PZD=curRow
		set PAD=curCol
		set curRow=curRow+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DL')+e)//n0DL -> Kill Details
		call MultiboardReleaseItem(mbitem)
		set curRow=PZD
		set x=1
		loop
			exitwhen x>elf
			set curCol=0
			set curRow=PZD
			set i=1
			loop
				exitwhen i>und
				set curCol=x+(x-1)
				set curRow=curRow+1
				set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
				call MBWrapper(mbitem,false,true,null,US8(udg_Hero[GetPlayerId(PTD[x])]),.01)
				call MultiboardReleaseItem(mbitem)
				set curCol=curCol+1
				set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
				call MBWrapper(mbitem,true,true," "+PPD(PTD[x],PUD[i]),US8(udg_Hero[GetPlayerId(PUD[i])]),.059)
				call MultiboardReleaseItem(mbitem)
				set i=i+1
			endloop
			set x=x+1
		endloop
		set x=elf+1
		loop
			exitwhen x>(und+elf)
			set curCol=0
			set curRow=PZD
			set i=1
			loop
				exitwhen i>elf
				set curCol=x+(x-1)
				set curRow=curRow+1
				set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
				call MBWrapper(mbitem,false,true,null,US8(udg_Hero[GetPlayerId(PUD[x-elf])]),.01)
				call MultiboardReleaseItem(mbitem)
				set curCol=curCol+1
				set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
				call MBWrapper(mbitem,true,true," "+PPD(PUD[x-elf],PTD[i]),US8(udg_Hero[GetPlayerId(PTD[i])]),.059)
				call MultiboardReleaseItem(mbitem)
				set i=i+1
			endloop
			set x=x+1
		endloop
	endif
	set curRow=curRow+1
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0CZ')+e)//n0CZ -> Left At
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>elf
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,LeftAt[GetPlayerId(PTD[i])],null,.07)
		call MultiboardReleaseItem(mbitem)
		set XA7=XA7+1
		set XX7[XA7]=curRow
		set XY7[XA7]=curCol
		set XZ7[XA7]=PTD[i]
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>und
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
		call MBWrapper(mbitem,true,false,LeftAt[GetPlayerId(PUD[i])],null,.07)
		call MultiboardReleaseItem(mbitem)
		set XA7=XA7+1
		set XX7[XA7]=curRow
		set XY7[XA7]=curCol
		set XZ7[XA7]=PUD[i]
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0D9')+e)//n0D9 -> Winner
	call MultiboardReleaseItem(mbitem)
	set mbitem=MultiboardGetItem(FinalMB,curRow,curCol+1)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,(K3))
	call MultiboardSetItemWidth(mbitem,.07)
	call MultiboardReleaseItem(mbitem)
	call MultiboardMinimize(FinalMB,true)
	call MultiboardMinimize(FinalMB,false)
	set mbitem=null
endfunction

function PBD takes player p returns string
	return udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"
endfunction

function PCD takes player p returns string
	local integer k=PlayerTowersKilled[GetPlayerId(p)]
	local integer d=PlayerTowersDenied[GetPlayerId(p)]
	if k<1 then
		set k=0
	endif
	if d<1 then
		set d=0
	endif
	return I2S(k)+"/"+I2S(d)
endfunction

function P3D takes player p returns string
	local integer POD=PlayerTimeDead[GetPlayerId(p)]
	local string Time
	local integer Minutes
	local integer Seconds
	set Minutes=(POD/ 60)-(1/ 2)
	set Seconds=ModuloInteger(POD,60)
	if(Seconds<10)then
		set Time=I2S(Minutes)+":0"+I2S(Seconds)
	else
		set Time=I2S(Minutes)+":"+I2S(Seconds)
	endif
	return Time
endfunction

function P6D takes player Source,player Target returns string
	local integer k=(LoadInteger(HY,(400+GetPlayerId(Source)),(450+GetPlayerId(Target))))
	local integer d=(LoadInteger(HY,(400+GetPlayerId(Source)),(500+GetPlayerId(Target))))
	if k<1 then
		set k=0
	endif
	if d<1 then
		set d=0
	endif
	return I2S(k)+"/"+I2S(d)
endfunction

function PLD takes player Source returns string
	local string P1D
	if IsDead(udg_Hero[GetPlayerId(Source)])then
		set P1D=I2S(R2I(TimerGetRemaining(HeroRespawnTimer[GetPlayerId(Source)])))
	else
		set P1D=" "
	endif
	return P1D
endfunction

function P0D takes player Source returns string
	local real r=(TimerGetRemaining(PrimUltiTimer[GetPlayerId((Source))]))
	local string P1D
	if r>0 then
		set P1D=I2S(R2I(r))
	else
		set P1D=" "
	endif
	return P1D
endfunction

function P5D takes integer P2D,integer Q4D returns nothing
	set ObsBoard=CreateMultiboard()
	call MultiboardSetItemsWidth(ObsBoard,0)
	call MultiboardSetRowCount(ObsBoard,P2D)
	call MultiboardSetColumnCount(ObsBoard,Q4D)
	call MultiboardSetTitleText(ObsBoard,GetObjectName('n0E3')+" "+" - "+(ModeNameString))//n0E3 -> DotA Scores
	call MultiboardMinimize(ObsBoard,true)
	call MultiboardSetItemsStyle(ObsBoard,false,false)
	if (GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2) then
		call MultiboardDisplay(ObsBoard,true)
	endif
endfunction

function Q7D takes nothing returns nothing
	local integer PRD=M1
	local integer PSD=N1
	local player array PTD
	local player array PUD
	local integer curRow
	local integer curCol
	local integer numRows=1+21+IMaxIF(PRD,PSD)
	local integer numCols=1+(PRD+PSD)*2
	local multiboarditem mbitem
	local integer i
	local integer x
	local string e="|r"
	local string c0="|cff99ccff"
	local integer PZD
	local integer PAD
	local integer Q8D=131
	local integer Q9D=139
	local integer QDD=139
	local integer QED=255
	local integer OUD=0
	local string OVD=""
	local string OWD=""
	local integer OXD=0
	local integer OYD=0
	local integer r
	if PRD>0 and PSD>0 then
		set numRows=numRows+2
	endif
	if GetTriggerExecCount(GetTriggeringTrigger())==1 then
		call P5D(numRows,numCols)
	endif
	if udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2) then
		call MultiboardDisplay(ObsBoard,true)
	endif
	set i=1
	loop
		exitwhen i>5
		set r=R2I(TimerGetRemaining(HeroRespawnTimer[GetPlayerId(Sentinels[i])]))
		if r>0 then
			set OUD=OUD+OJD(r)
			if OXD==0 then
				if r<10 then
					set OVD=udg_Colors[GetPlayerId(Sentinels[i])]+"0"+I2S(r)+" |r"
				else
					set OVD=udg_Colors[GetPlayerId(Sentinels[i])]+I2S(r)+" |r"
				endif
			else
				if r<10 then
					set OVD=OVD+WHITE+"| |r"+udg_Colors[GetPlayerId(Sentinels[i])]+"0"+I2S(r)+" |r"
				else
					set OVD=OVD+WHITE+"| |r"+udg_Colors[GetPlayerId(Sentinels[i])]+I2S(r)+" |r"
				endif
			endif
			set OXD=OXD+1
		endif
		set i=i+1
	endloop
	if OXD>0 then
		set OVD=WHITE+"[Sentinel: |r"+OVD+WHITE+"]|r"
	endif
	set i=1
	loop
		exitwhen i>5
		set r=R2I(TimerGetRemaining(HeroRespawnTimer[GetPlayerId(Scourges[i])]))
		if r>0 then
			set OUD=OUD+OJD(r)
			if OYD==0 then
				if r<10 then
					set OWD=udg_Colors[GetPlayerId(Scourges[i])]+"0"+I2S(r)+" |r"
				else
					set OWD=udg_Colors[GetPlayerId(Scourges[i])]+I2S(r)+" |r"
				endif
			else
				if r<10 then
					set OWD=OWD+WHITE+"| |r"+udg_Colors[GetPlayerId(Scourges[i])]+"0"+I2S(r)+" |r"
				else
					set OWD=OWD+WHITE+"| |r"+udg_Colors[GetPlayerId(Scourges[i])]+I2S(r)+" |r"
				endif
			endif
			set OYD=OYD+1
		endif
		set i=i+1
	endloop
	if OYD>0 then
		set OWD=WHITE+"[Scourge: |r"+OWD+WHITE+"]|r"
	endif
	call MultiboardSetTitleText(ObsBoard,OVD+" "+OWD+" "+GetObjectName('n0E3')+"  - "+ModeNameString+" - "+("|c00ff0303"+I2S(Kills[GetPlayerId(Sentinels[0])])+"|r/|c0020c000"+I2S(Deaths[GetPlayerId(Sentinels[0])])+"|r"))//n0E3 -> DotA Scores
	set x=1
	set i=1
	loop
		exitwhen i>5
		if IsPlayer(Sentinels[i])or GetPlayerSlotState(Sentinels[i])==PLAYER_SLOT_STATE_LEFT then
			set PTD[x]=Sentinels[i]
			set x=x+1
		endif
		set i=i+1
	endloop
	set x=1
	set i=1
	loop
		exitwhen i>5
		if IsPlayer(Scourges[i])or GetPlayerSlotState(Scourges[i])==PLAYER_SLOT_STATE_LEFT then
			set PUD[x]=Scourges[i]
			set x=x+1
		endif
		set i=i+1
	endloop
	set i=0
	set curCol=0
	loop
		exitwhen i>numRows
		set mbitem=MultiboardGetItem(ObsBoard,i,curCol)
		call MultiboardSetItemWidth(mbitem,.075)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=0
	set curCol=0
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem," ")
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,false,false)
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,PBD(PTD[i]))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,PBD(PUD[i]))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,false,false)
	call MultiboardReleaseItem(mbitem)
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,true)
		call MultiboardSetItemValue(mbitem,"("+(I2S(GetUnitLevel(udg_Hero[GetPlayerId((PTD[i]))])))+")")
		call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[i]))])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,true)
		call MultiboardSetItemValue(mbitem,"("+I2S(GetUnitLevel(udg_Hero[GetPlayerId(PUD[i])]))+")")
		call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId(PUD[i])])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0EB')+e)//n0EB -> Items
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],1-1)))
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],2-1)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],1-1)))
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],2-1)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+" "+e)
	call MultiboardReleaseItem(mbitem)
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],3-1)))
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],4-1)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],3-1)))
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],4-1)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+" "+e)
	call MultiboardReleaseItem(mbitem)
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],5-1)))
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],6-1)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],5-1)))
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,GetItemIcon(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],6-1)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E2')+e)//n0E2 -> Current Gold
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,I2S(GetPlayerState(PTD[i],PLAYER_STATE_RESOURCE_GOLD)))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(GetPlayerState(PUD[i],PLAYER_STATE_RESOURCE_GOLD))))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0LT')+e)//n0LT -> Buyback Cost
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(BuybackUnitCost[DefineBuybackUnitIndex(GetHeroLevel(udg_Hero[GetPlayerId((PTD[i]))]))])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(BuybackUnitCost[DefineBuybackUnitIndex(GetHeroLevel(udg_Hero[GetPlayerId(PUD[i])]))])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DZ')+e)//n0DZ -> Creep Stats
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(PlayerCS[GetPlayerId((PTD[i]))]))+"/"+(I2S(CSDenies[GetPlayerId((PTD[i]))]))+"/"+(I2S((LoadInteger(HY,(400+GetPlayerId((PTD[i]))),79)))))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(PlayerCS[GetPlayerId(PUD[i])]))+"/"+(I2S(CSDenies[GetPlayerId(PUD[i])]))+"/"+(I2S((LoadInteger(HY,(400+GetPlayerId(PUD[i])),79)))))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E1')+e)//n0E1 -> Hero K/D/A
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(Kills[GetPlayerId((PTD[i]))]))+"/"+(I2S(Deaths[GetPlayerId((PTD[i]))]))+"/"+(I2S(Assists[GetPlayerId((PTD[i]))])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(Kills[GetPlayerId(PUD[i])]))+"/"+(I2S(Deaths[GetPlayerId(PUD[i])]))+"/"+(I2S(Assists[GetPlayerId(PUD[i])])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E0')+e)//n0E0 -> Wards
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(ItemStats_Wards[GetPlayerId((PTD[i]))])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(ItemStats_Wards[GetPlayerId(PUD[i])])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DT')+e)//n0DT -> Tower Stats
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,PCD(PTD[i]))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,PCD(PUD[i]))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DU')+e)//n0DU -> Hero Kill Gold
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(GoldEarnedByKills[GetPlayerId((PTD[i]))])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(GoldEarnedByKills[GetPlayerId(PUD[i])])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+"Skills"+e)
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+1]])
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],1)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+1]])
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],1)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+" "+e)
	call MultiboardReleaseItem(mbitem)
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+2]])
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],2)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+2]])
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],2)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+" "+e)
	call MultiboardReleaseItem(mbitem)
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+3]])
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],3)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+3]])
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],3)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curRow=curRow+1
	set curCol=0
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+" "+e)
	call MultiboardReleaseItem(mbitem)
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+4]])
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],4)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,false,true)
		call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+4]])
		call MultiboardSetItemWidth(mbitem,.015)
		call MultiboardReleaseItem(mbitem)
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],4)))
		call MultiboardSetItemWidth(mbitem,.054)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	if NumberOfExtraAbilities>=1 then
		set curRow=curRow+1
		set curCol=0
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,c0+" "+e)
		call MultiboardReleaseItem(mbitem)
		set i=1
		loop
			exitwhen i>PRD
			set curCol=curCol+1
			set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
			call MultiboardSetItemStyle(mbitem,false,true)
			call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+5]])
			call MultiboardSetItemWidth(mbitem,.015)
			call MultiboardReleaseItem(mbitem)
			set curCol=curCol+1
			set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
			call MultiboardSetItemStyle(mbitem,true,false)
			call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],5)))
			call MultiboardSetItemWidth(mbitem,.054)
			call MultiboardReleaseItem(mbitem)
			set i=i+1
		endloop
		set i=1
		loop
			exitwhen i>PSD
			set curCol=curCol+1
			set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
			call MultiboardSetItemStyle(mbitem,false,true)
			call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+5]])
			call MultiboardSetItemWidth(mbitem,.015)
			call MultiboardReleaseItem(mbitem)
			set curCol=curCol+1
			set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
			call MultiboardSetItemStyle(mbitem,true,false)
			call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],5)))
			call MultiboardSetItemWidth(mbitem,.054)
			call MultiboardReleaseItem(mbitem)
			set i=i+1
		endloop
	endif
	if NumberOfExtraAbilities>=2 then
		set curRow=curRow+1
		set curCol=0
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,c0+" "+e)
		call MultiboardReleaseItem(mbitem)
		set i=1
		loop
			exitwhen i>PRD
			set curCol=curCol+1
			set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
			call MultiboardSetItemStyle(mbitem,false,true)
			call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+6]])
			call MultiboardSetItemWidth(mbitem,.015)
			call MultiboardReleaseItem(mbitem)
			set curCol=curCol+1
			set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
			call MultiboardSetItemStyle(mbitem,true,false)
			call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],6)))
			call MultiboardSetItemWidth(mbitem,.054)
			call MultiboardReleaseItem(mbitem)
			set i=i+1
		endloop
		set i=1
		loop
			exitwhen i>PSD
			set curCol=curCol+1
			set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
			call MultiboardSetItemStyle(mbitem,false,true)
			call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+6]])
			call MultiboardSetItemWidth(mbitem,.015)
			call MultiboardReleaseItem(mbitem)
			set curCol=curCol+1
			set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
			call MultiboardSetItemStyle(mbitem,true,false)
			call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],6)))
			call MultiboardSetItemWidth(mbitem,.054)
			call MultiboardReleaseItem(mbitem)
			set i=i+1
		endloop
	endif
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DV')+e)//n0DV -> Time Dead
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,P3D(PTD[i]))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,P3D(PUD[i]))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DW')+e)//n0DW -> Gold Lost
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(PlayerGoldLost[GetPlayerId((PTD[i]))])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(PlayerGoldLost[GetPlayerId(PUD[i])])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DN')+e)//n0DN -> Consumables
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(ItemStats_Consumables[GetPlayerId((PTD[i]))])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,(I2S(ItemStats_Consumables[GetPlayerId(PUD[i])])))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	if PRD>0 and PSD>0 then
		set curCol=0
		set PZD=curRow
		set PAD=curCol
		set curRow=curRow+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemStyle(mbitem,true,false)
		call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DL')+e)//n0DL -> Kill Details
		call MultiboardReleaseItem(mbitem)
		set curRow=PZD
		set x=1
		loop
			exitwhen x>PRD
			set curCol=0
			set curRow=PZD
			set i=1
			loop
				exitwhen i>PSD
				set curCol=x+(x-1)
				set curRow=curRow+1
				set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
				call MultiboardSetItemStyle(mbitem,false,true)
				call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[x]))])))
				call MultiboardSetItemWidth(mbitem,.01)
				call MultiboardReleaseItem(mbitem)
				set curCol=curCol+1
				set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
				call MultiboardSetItemStyle(mbitem,true,true)
				call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId(PUD[i])])))
				call MultiboardSetItemValue(mbitem," "+P6D(PTD[x],PUD[i]))
				call MultiboardSetItemWidth(mbitem,.059)
				call MultiboardReleaseItem(mbitem)
				set i=i+1
			endloop
			set x=x+1
		endloop
		set x=PRD+1
		loop
			exitwhen x>(PSD+PRD)
			set curCol=0
			set curRow=PZD
			set i=1
			loop
				exitwhen i>PRD
				set curCol=x+(x-1)
				set curRow=curRow+1
				set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
				call MultiboardSetItemStyle(mbitem,false,true)
				call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PUD[x-PRD]))])))
				call MultiboardSetItemWidth(mbitem,.01)
				call MultiboardReleaseItem(mbitem)
				set curCol=curCol+1
				set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
				call MultiboardSetItemStyle(mbitem,true,true)
				call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[i]))])))
				call MultiboardSetItemValue(mbitem," "+P6D(PUD[x-PRD],PTD[i]))
				call MultiboardSetItemWidth(mbitem,.059)
				call MultiboardReleaseItem(mbitem)
				set i=i+1
			endloop
			set x=x+1
		endloop
	endif
	set curRow=curRow+1
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0HS')+e)//n0HS -> Cooldown
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
		if PLD(PTD[i])==" "then
			call MultiboardSetItemStyle(mbitem,true,false)
		else
			call MultiboardSetItemStyle(mbitem,true,false)
			call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[i]))])))
		endif
		call MultiboardSetItemValue(mbitem,P0D(PTD[i]))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
		if PLD(PUD[i])==" "then
			call MultiboardSetItemStyle(mbitem,true,false)
		else
			call MultiboardSetItemStyle(mbitem,true,false)
			call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId(PUD[i])])))
		endif
		call MultiboardSetItemValue(mbitem,P0D(PUD[i]))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set curCol=0
	set curRow=curRow+1
	set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
	call MultiboardSetItemStyle(mbitem,true,false)
	call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E4')+e)//n0E4 -> Respawn
	call MultiboardReleaseItem(mbitem)
	set curCol=0
	set i=1
	loop
		exitwhen i>PRD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		if PLD(PTD[i])==" "then
			call MultiboardSetItemStyle(mbitem,true,false)
		else
			call MultiboardSetItemStyle(mbitem,true,true)
			call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[i]))])))
		endif
		call MultiboardSetItemValue(mbitem,PLD(PTD[i]))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>PSD
		set curCol=curCol+1
		set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
		if PLD(PUD[i])==" "then
			call MultiboardSetItemStyle(mbitem,true,false)
		else
			call MultiboardSetItemStyle(mbitem,true,true)
			call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId(PUD[i])])))
		endif
		call MultiboardSetItemValue(mbitem,PLD(PUD[i]))
		call MultiboardSetItemWidth(mbitem,.07)
		call MultiboardReleaseItem(mbitem)
		set i=i+1
	endloop
	set mbitem=null
endfunction

function CreateObsBoard takes nothing returns nothing
	local trigger t
	if udg_ObserverMode then
		set t=CreateTrigger()
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddAction(t,function Q7D)
		set X37=t
	endif
	set t=null
endfunction

function IsUnitShop takes unit u returns boolean
	local integer i=GetUnitTypeId(u)
	return i=='hC95' or i=='n12B' or i=='n01K' or i=='nC38' or i=='n00V' or i=='n00W' or i=='n002' or i=='n00X' or i=='n009' or i=='n0HE' or i=='nC35' or i=='u00Q' or i=='uC74' or i=='u010' or i=='u00Z'//hC95 -> Cache of the Quel'thelan, n01K -> Weapons Dealer, nC38 -> Sena The Accessorizer, n00V -> Arcane Sanctum, n00W -> Ancient Weaponry, n002 -> Supportive Vestments, n00X -> Enchanted Artifacts, n009 -> Gateway Relics, n0HE -> Protectorate, nC35 -> Demonic Artifacts, u00Q -> Tomb of Relics, uC74 -> Leragas The Vile, u010 -> Goblin Merchant, u00Z -> Goblin Laboratory
endfunction

function Add2Log takes string p, real time, string target returns nothing
	local integer i=LoadInteger(UTable,-1,0)
	local integer mins=R2I(time/60 - 1/2)
	local integer seconds=R2I(time-mins*60)
	call SaveStr(UTable,-1,i,p+" selected "+target+" at "+I2S(mins)+":"+I2S(seconds))
	call SaveInteger(UTable,-1,0,i+1)
endfunction

function UnitSelected takes unit u returns nothing
	if GetUnitTypeId(u)!='hfoo' and IsUnitVisibleLoD(u,GetTriggerPlayer())==false then//hfoo ->  
		call Add2Log(PlayerNames[GetPlayerId(GetTriggerPlayer())],TimerGetElapsed(GlobalTimer),GetUnitName(u))
		//call echo("fog click by "+PlayerNames[GetPlayerId(GetTriggerPlayer())])
	endif
endfunction

function ShopAnimation takes nothing returns boolean
	local unit u=GetTriggerUnit()
	local integer id=GetUnitTypeId(u)
	local boolean b=GetOwningPlayer(u)==Player(15) and IsUnitShop(u) and GetLocalPlayer()==GetTriggerPlayer()
	local string s=""
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_DESELECTED then
		if b then
			call ResetUnitAnimation(u)
		endif
	else
		if Mode_AH then
			call UnitSelected(u)
		endif
		if b then
			if id=='hC95' or id=='n12B' or id=='n00X' or id=='n009' or id=='nC35' or id=='u00Q' or id=='u010' or id=='u00Z' then//hC95 -> Cache of the Quel'thelan, n00X -> Enchanted Artifacts, n009 -> Gateway Relics, nC35 -> Demonic Artifacts, u00Q -> Tomb of Relics, u010 -> Goblin Merchant, u00Z -> Goblin Laboratory
				set s="stand work"
			elseif id=='n01K' then//n01K -> Weapons Dealer
				set s="stand third"
			elseif id=='nC38' then//nC38 -> Sena The Accessorizer
				call SetUnitAnimationByIndex(u,3)
			elseif id=='n00V' then//n00V -> Arcane Sanctum
				set s="spell attack"
			elseif id=='n00W' then//n00W -> Ancient Weaponry
				set s="spell"
			elseif id=='n002' then//n002 -> Supportive Vestments
				call SetUnitAnimationByIndex(u,3)
			elseif id=='n0HE' then//n0HE -> Protectorate
				set s="stand victory"
			elseif id=='uC74' then//uC74 -> Leragas The Vile
				set s="stand work gold"
			endif
			if s!=""then
				call SetUnitAnimation(u,s)
				call QueueUnitAnimation(u,s)
			endif
		endif
	endif
	set u=null
	return false
endfunction

function AntiBackdoorHealing takes unit u, unit source, real dmg returns nothing
	local real mult=.25
	if Mode_AB then
		set mult=1
	endif
	call SetWidgetLife(u,GetWidgetLife(u)+mult*dmg)
endfunction

function IsCreep takes unit u returns boolean
	return (GetOwningPlayer(u)==Sentinels[0] or GetOwningPlayer(u)==Scourges[0]) and GetUnitTypeId(u)!='hFFD'
endfunction

function IsCreepFilter takes nothing returns boolean
	return (GetOwningPlayer(GetFilterUnit())==Sentinels[0] or GetOwningPlayer(GetFilterUnit())==Scourges[0]) and GetUnitTypeId(GetFilterUnit())!='hFFD'
endfunction

function ABD takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer hu=GetHandleId(u)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetUnitAbilityLevel(u,'A17R')==0 then//A17R -> Fortification Armor Bonus
			if LoadBoolean(MHT,hu,'isBD') and IsUnitEnemy(u,GetOwningPlayer(GetEventDamageSource())) then
				call AntiBackdoorHealing(u,GetEventDamageSource(),GetEventDamage())
			else
				call SaveReal(MHT,hu,'DMGR',LoadReal(MHT,hu,'DMGR')+GetEventDamage())
			endif
		endif
	else
		call FlushChildHashtable(MHT,hu)
		call GroupRemoveUnit(ABDGroup,u)
	endif
	set u=null
endfunction

function ABD_Check takes unit u returns nothing
	local integer hu
	local rect r
	local group g
	local unit u2=null
	local boolean b=false
	local player p=Sentinels[0]
	local integer i=0
	if IsDead(u) then
		return
	endif
	set hu=GetHandleId(u)
	set g=GetAvailableGroup()
	if GetOwningPlayer(u)==Sentinels[0] then
		set p=Scourges[0]
	endif
	loop
		set r=LoadRectHandle(MHT,hu,'ABDr'+i)
		call GroupEnumUnitsInRect(g,r,Condition(function IsCreepFilter))
		loop
			set u2=FirstOfGroup(g)
			exitwhen b or u2==null
			if GetOwningPlayer(u2)==p then
				set b=true
			else
				call GroupRemoveUnit(g,u2)
			endif
		endloop
		set i=i+1
		exitwhen b or HaveSavedHandle(MHT,hu,'ABDr'+i)==false
	endloop
	call SaveBoolean(MHT,hu,'isBD',b==false)
	call KillGroup(g)
	set u2=null
	set g=null
	set r=null
endfunction

function ABD_Timer takes nothing returns nothing
	local unit u
	local group g=GetAvailableGroup()
	call GroupAddGroup(ABDGroup,g)
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call ABD_Check(u)
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
	set g=null
	set u=null
endfunction

function ABD_Heal takes nothing returns nothing
	local unit u=GetEnumUnit()
	local integer hu=GetHandleId(u)
	local real life
	local real life2
	if hu==0 or IsDead(u) or GetUnitState(u,UNIT_STATE_MAX_LIFE)==GetWidgetLife(u) then
		return
	endif
	set life=GetWidgetLife(u)
	set life2=GetUnitState(u,UNIT_STATE_MAX_LIFE)-LoadReal(MHT,hu,'DMGR')
	if life <= life2 then
		if life+AntiBDRegenRate <= life2 then
			call SetWidgetLife(u,life+AntiBDRegenRate)
		else
			call SetWidgetLife(u,life2)
		endif
	endif
	set u=null
endfunction

function ABD_HealTimer takes nothing returns nothing
	call ForGroup(ABDGroup,function ABD_Heal)
endfunction

function FixCameraHeight takes nothing returns nothing
	if HaveSavedReal(HeroStats,GetHandleId(GetLocalPlayer()),'CAMD') and GetCameraField(CAMERA_FIELD_TARGET_DISTANCE)!=LoadReal(HeroStats,GetHandleId(GetLocalPlayer()),'CAMD') and LoadReal(HeroStats,GetHandleId(GetLocalPlayer()),'CAMD')!=1650 then
		call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_TARGET_DISTANCE,LoadReal(HeroStats,GetHandleId(GetLocalPlayer()),'CAMD'),0)
		call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_FARZ,100000,0)
		call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_ZOFFSET,0,0)
		call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_ROTATION,90,0)
		call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_ANGLE_OF_ATTACK,304,0)
		call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_ROLL,0,0)
		call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_FIELD_OF_VIEW,70,0)
	endif
endfunction

function AntiStuckUnitFilter takes nothing returns boolean
	return IsCreepId(GetUnitTypeId(GetFilterUnit())) and GetUnitCurrentOrder(GetFilterUnit())==0
endfunction

function AntiStuckUnitAct takes nothing returns nothing
	call IssuePointOrderLoc(GetEnumUnit(),"attack",WaypointLocations[GetUnitAbilityLevel(GetEnumUnit(),WaypointAbilID)])
endfunction

function CreepsAntiStuck takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,Sentinels[0],Condition(function AntiStuckUnitFilter))
	call ForGroup(g,function AntiStuckUnitAct)
	call GroupEnumUnitsOfPlayer(g,Scourges[0],Condition(function AntiStuckUnitFilter))
	call ForGroup(g,function AntiStuckUnitAct)
	call KillGroup(g)
endfunction

function SaveBaseRects takes unit u returns nothing
	local integer hu=GetHandleId(u)
	call GroupAddUnit(ABDGroup,u)
	if GetOwningPlayer(u)==Sentinels[0] then
		call SaveRectHandle(MHT,hu,'ABDr'+0,Rect(-8160.,-8192.,-3712.,-4352.))
		call SaveRectHandle(MHT,hu,'ABDr'+1,Rect(-8192.,-4960.,-4640.,-3552.))
		call SaveRectHandle(MHT,hu,'ABDr'+2,Rect(-4000.,-7744.,-3072.,-5152.))
		call SaveRectHandle(MHT,hu,'ABDr'+3,Rect(-3328.,-7200.,-2464.,-6368.))
		call SaveRectHandle(MHT,hu,'ABDr'+4,Rect(-4288.,-4544.,-3424.,-3712.))
		call SaveRectHandle(MHT,hu,'ABDr'+5,Rect(-6784.,-3616.,-5920.,-2784.))
	else
		call SaveRectHandle(MHT,hu,'ABDr'+0,Rect(2304.,4064.,8032.,7776.))
		call SaveRectHandle(MHT,hu,'ABDr'+1,Rect(4640.,1952.,8000.,4384.))
		call SaveRectHandle(MHT,hu,'ABDr'+2,Rect(3136.,2816.,5216.,4960.))
		call SaveRectHandle(MHT,hu,'ABDr'+3,Rect(5984.,1152.,6848.,1984.))
		call SaveRectHandle(MHT,hu,'ABDr'+4,Rect(1472.,5440.,2336.,6272.))
		call SaveRectHandle(MHT,hu,'ABDr'+5,Rect(2656.,2336.,3520.,3168.))
	endif
endfunction

function RSD takes nothing returns boolean
	call CleanTrigger(GetTriggeringTrigger())
	call TriggerEvaluate(NG)
	return false
endfunction

function IsTavernsUnit takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())=='ntav' then
		if udg_Hero[GetPlayerId(GetOwningPlayer(GetFilterUnit()))]!=null or IsPlayer(GetOwningPlayer(GetFilterUnit()))==false then
			call KillUnit(GetFilterUnit())
		else
			set tt_int1=tt_int1+1
		endif
	endif
	return false
endfunction

function CleanTavernsArea2 takes nothing returns nothing
	local group g=GetAvailableGroup()
	set tt_int1=0
	call GroupEnumUnitsOfPlayer(g,Sentinels[1],Condition(function IsTavernsUnit))
	call GroupEnumUnitsOfPlayer(g,Sentinels[2],Condition(function IsTavernsUnit))
	call GroupEnumUnitsOfPlayer(g,Sentinels[3],Condition(function IsTavernsUnit))
	call GroupEnumUnitsOfPlayer(g,Sentinels[4],Condition(function IsTavernsUnit))
	call GroupEnumUnitsOfPlayer(g,Sentinels[5],Condition(function IsTavernsUnit))
	call GroupEnumUnitsOfPlayer(g,Scourges[1],Condition(function IsTavernsUnit))
	call GroupEnumUnitsOfPlayer(g,Scourges[2],Condition(function IsTavernsUnit))
	call GroupEnumUnitsOfPlayer(g,Scourges[3],Condition(function IsTavernsUnit))
	call GroupEnumUnitsOfPlayer(g,Scourges[4],Condition(function IsTavernsUnit))
	call GroupEnumUnitsOfPlayer(g,Scourges[5],Condition(function IsTavernsUnit))
	
	if tt_int1==0 then
		call DestroyTimer(GetExpiredTimer())
		call TimedReveal(Sentinels[0],10,-7000,6800,1000)
		call TimedReveal(Scourges[0],10,-7000,6800,1000)
		call echo("all taverns destroyed")
	endif
	call KillGroup(g)
endfunction

function CleanTavernsArea takes nothing returns nothing
	if Mode_SD or Mode_MD then
		call TimerStart(CreateTimer(),5,true,function CleanTavernsArea2)
	endif
endfunction

function RTD takes nothing returns boolean
	local real r=TimerGetRemaining(NK)
	local real Y59=r
	local integer YO8=R2I(Y59)
	local integer Minutes=YO8/60 - 1/2
	local integer Seconds=ModuloInteger(YO8,60)
	local trigger t
	local integer i
	local integer pid
	if r==0 then
		if b_isPickTime then
			set b_isPickTime=false
			call RemoveUnit(AddTime1)
			call RemoveUnit(AddTime2)
			call RemoveUnit(AddTime3)
			call RemoveUnit(AddTime4)
			call RemoveUnit(AltarOfRandom)
			call ExecuteFunc("RUD")
			return false
		endif
		set YL7=true
		call FlushGameCache(InitGameCache("start"))
		call Traffic_RegisterCustomGlobalData("i","d",0x03)
		call TimedReveal(Sentinels[0],2,-6990.,6840,800)
		call TimedReveal(Scourges[0],2,-6990.,6840,800)
		call CleanTavernsArea()
		set i=1
		//call ThrowLog()
		loop
			if IsPlayer(Player(i)) then
				set pid=GetPlayerId(Player(i))
				call Traffic_RegisterData("SP1_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+1]])
				call Traffic_RegisterData("SP2_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+2]])
				call Traffic_RegisterData("SP3_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+3]])
				call Traffic_RegisterData("SP4_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]])
				if NumberOfExtraAbilities>=1 then
					call Traffic_RegisterData("SP5_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+5]])
				endif
				if NumberOfExtraAbilities>=2 then
					call Traffic_RegisterData("SP6_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+6]])
				endif
			endif
			set i=i+1
			if i==6 then//skip scourge
				set i=7
			endif
			exitwhen i>11
		endloop
		call SetTime(Minutes,Seconds,true)
		set IsGameStartedAnotherBool=true
		set GameStartsTime=TimerGetElapsed(GlobalTimer)
		call CleanTrigger(GetTriggeringTrigger())
		call SetFloatGameState(GAME_STATE_TIME_OF_DAY,6.)
		call SuspendTimeOfDay(false)
		if Mode_NP==false then
			call TriggerRegisterTimerEvent(RuneSpawnTrigger,120,true)
			call TriggerEvaluate(RuneSpawnTrigger)
		endif
		call TriggerRegisterTimerEvent(NG,60,true)
		if not Mode_FN then
			set t=CreateTrigger()
			call TriggerRegisterTimerEvent(t,30,false)
			call TriggerAddCondition(t,Condition(function RSD))
			set t=null
		endif
		call TriggerRegisterTimerEvent(AG,30,true)
		call TriggerExecute(AG)
		call TriggerRegisterTimerEvent(LG,450,true)
		call TriggerRegisterTimerEvent(AddExtraRangeCreepTrigger,2699-30,false)
		call TriggerRegisterTimerEvent(AddExtraMeleeCreepTrigger,999-150,false)
		call TriggerRegisterTimerEvent(AddExtraMeleeCreepTrigger,1999-240,false)
		call TriggerRegisterTimerEvent(AddExtraMeleeCreepTrigger,2999-330,false)
		call TriggerRegisterTimerEvent(RoshanUpdaterTrigger,240,true)
		call TriggerRegisterTimerEvent(ZI7,300,true)
		call TriggerRegisterTimerEvent(PN,30,true)
		call TriggerEvaluate(PN)
		if Mode_SC then
			call TriggerRegisterTimerEvent(SG,600,true)
		endif
	elseif r==7 and not b_isPickTime then
		set t=CreateTrigger()
		call TriggerRegisterTimerEvent(t,30,true)
		call TriggerAddCondition(t,Condition(function MKD))
	elseif Y59<12 and PK==false and not b_isPickTime then
		set PK=true
		call PlaySoundBJ(QD)
		call SetTime(Minutes,Seconds,true)
	elseif Y59==20 then
			
	elseif Y59==15 and b_isPickTime and (CanAddTime[0]>0 or CanAddTime[1]>0) then
		if not b_isPlayerReady[GetPlayerId(GetLocalPlayer())] then
			call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,TxtDur[GetPlayerId(GetLocalPlayer())],"|c006699CC"+"If you need more time to pick your skills, enter -addtime"+"|r")
		endif
	else
		call SetTime(Minutes,Seconds,true)
	endif
	return false
endfunction

function RWD takes nothing returns boolean
	if IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetAttacker()))and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(GetAttacker()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetWidgetLife(GetFilterUnit())>1 and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false and GetOwningPlayer(GetFilterUnit())!=Neutrals then//
		if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
			set Y17=GetFilterUnit()
		else
			set Y07=GetFilterUnit()
		endif
	endif
	return false
endfunction

function RXD takes nothing returns nothing
	local unit MQD=GetAttacker()
	local unit Target=GetTriggerUnit()
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(MQD),GetUnitY(MQD),900,Condition(function RWD))
	call KillGroup(g)
	call DisableTrigger(GetTriggeringTrigger())
	if Y17!=null then
		call IssueTargetOrderById(MQD,ORDER_attack,Y17)
		call GroupAddUnit(Y57,MQD)
	elseif IsUnitType(Target,UNIT_TYPE_HERO) and Y07!=null then
		call IssueTargetOrderById(MQD,ORDER_attack,Y07)
		call GroupAddUnit(Y57,MQD)
	endif
	call EnableTrigger(GetTriggeringTrigger())
	set Y17=null
	set Y07=null
	set MQD=null
	set Target=null
	set g=null
endfunction

function RYD takes nothing returns nothing
	if GetWidgetLife(GetEnumUnit())<1 then
		call GroupRemoveUnit(Y57,GetEnumUnit())
	endif
	if GetUnitCurrentOrder(GetEnumUnit())!=851983then
		call GroupRemoveUnit(Y57,GetEnumUnit())
		call IssuePointOrderByIdLoc(GetEnumUnit(),ORDER_attack,WaypointLocations[GetUnitAbilityLevel(GetEnumUnit(),WaypointAbilID)])
	endif
endfunction

function RZD takes nothing returns boolean
	call ForGroup(Y57,function RYD)
	return false
endfunction

function RAD takes string s returns nothing
	set Z77=Z77+1
	set Z87[Z77]=s
endfunction

function RBD takes nothing returns boolean
	local integer i=1
	loop
		exitwhen i>Z77
		call ExecuteFunc(Z87[i])
		set i=i+1
	endloop
	call ExecuteFunc("V59")
	call ExecuteFunc("D7D")
	return false
endfunction

function RCD takes unit Hero returns nothing
	local trigger t=CreateTrigger()
	call SaveBoolean(HY,(GetHandleId(GetTriggerUnit())),38,(true))
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function RBD))
	set t=null
endfunction

function R3D takes nothing returns boolean
	if b_isPickTime==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) and GetUnitTypeId(GetTriggerUnit())!='H0B8' and GetUnitTypeId(GetTriggerUnit())!='H00M' and GetUnitTypeId(GetTriggerUnit())!='H07G' and GetUnitTypeId(GetTriggerUnit())!='H00Y' and IsUnitIllusion(GetTriggerUnit())==false and HaveSavedBoolean(HY,GetHandleId(GetTriggerUnit()),38)==false then//H0B8 -> Ice Blast, H00M -> Bloodrune, H07G -> Storm Spirit unused, H00Y -> Preloader Hero
		if (GetUnitTypeId(GetTriggerUnit())!='O00P')then//O00P -> Morphling
			call RCD(GetTriggerUnit())
		endif
	endif
	return false
endfunction

function S7D takes nothing returns nothing
	if IsCourier(GetEnumUnit())and IsUnitAlly(GetEnumUnit(),Sentinels[0])==false and GetWidgetLife(GetEnumUnit())>.5 then
		call UnitRemoveAbility(GetEnumUnit(),'B08H')//B08H -> Courier Shield
		call DamageTarget(SentFountain,GetEnumUnit(),2,500)
	endif
endfunction

function S8D takes nothing returns nothing
	if IsCourier(GetEnumUnit())and IsUnitAlly(GetEnumUnit(),Scourges[0])==false and GetWidgetLife(GetEnumUnit())>.5 then
		call UnitRemoveAbility(GetEnumUnit(),'B08H')//B08H -> Courier Shield
		call DamageTarget(ScourgeFountain,GetEnumUnit(),2,500)
	endif
endfunction

function CourierFountainCheck takes nothing returns boolean
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRect(g,FountainRectFrogSent,Condition(function ReturnTrue))
	call ForGroup(g,function S7D)
	call GroupClear(g)
	call GroupEnumUnitsInRect(g,FountainRectFrogScourge,Condition(function ReturnTrue))
	call ForGroup(g,function S8D)
	call KillGroup(g)
	set g=null
	return false
endfunction

function DumpLogs takes nothing returns nothing
	local integer i=LoadInteger(UTable,-1,0)
	local integer k=0
	call PreloadEndEx()
	call PreloadGenClear()
	call PreloadGenStart()
	loop
		if HaveSavedString(UTable,-1,k)then
			call Preload(LoadStr(UTable,-1,k))
		endif
		set k=k+1
		exitwhen k>i
	endloop
	call PreloadGenEnd("FogClicks.txt")
	call PreloadGenClear()
	
endfunction

function SDD takes string winner returns nothing
	local integer i
	local player p
	local string id
	local integer YO8=R2I(TimerGetElapsed(GlobalTimer)-GameStartsTime)
	local integer Minutes=YO8/ 60-1/ 2
	local integer Seconds=ModuloInteger(YO8,60)
	local integer pid
	if winner=="1" then
		//31 = Slots 0-5
		call Traffic_RegisterCustomGlobalData("w","0",31)
	else
		//992 = Slots 6-10
		call Traffic_RegisterCustomGlobalData("w","0",992)
	endif
	call W18()
	if Mode_AH then
		call DumpLogs()
	endif
	set i=1
	loop
		exitwhen i>5
		set p=Sentinels[i]
		set id=I2S(GetPlayerId(p))
		set pid=GetPlayerId(p)
		call StoreInteger(GCM,id,"1",Kills[pid])
		call StoreInteger(GCM,id,"2",Deaths[pid])
		call StoreInteger(GCM,id,"3",PlayerCS[pid])
		call StoreInteger(GCM,id,"4",CSDenies[pid])
		call StoreInteger(GCM,id,"5",Assists[pid])
		call StoreInteger(GCM,id,"6",GetPlayerState((p),PLAYER_STATE_RESOURCE_GOLD))
		call StoreInteger(GCM,id,"7",LoadInteger(HY,400+pid,79))
		call StoreInteger(GCM,id,"8_0",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],0)))
		call StoreInteger(GCM,id,"8_1",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],1)))
		call StoreInteger(GCM,id,"8_2",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],2)))
		call StoreInteger(GCM,id,"8_3",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],3)))
		call StoreInteger(GCM,id,"8_4",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],4)))
		call StoreInteger(GCM,id,"8_5",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],5)))
		call StoreInteger(GCM,id,"9",HeroTypeId[pid])
		call StoreInteger(GCM,id,"id",i)
		set p=Scourges[i]
		set pid=GetPlayerId(p)
		set id=I2S(pid)
		call StoreInteger(GCM,id,"1",Kills[pid])
		call StoreInteger(GCM,id,"2",Deaths[pid])
		call StoreInteger(GCM,id,"3",PlayerCS[pid])
		call StoreInteger(GCM,id,"4",CSDenies[pid])
		call StoreInteger(GCM,id,"5",Assists[pid])
		call StoreInteger(GCM,id,"6",GetPlayerState((p),PLAYER_STATE_RESOURCE_GOLD))
		call StoreInteger(GCM,id,"7",LoadInteger(HY,400+pid,79))
		call StoreInteger(GCM,id,"8_0",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],0)))
		call StoreInteger(GCM,id,"8_1",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],1)))
		call StoreInteger(GCM,id,"8_2",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],2)))
		call StoreInteger(GCM,id,"8_3",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],3)))
		call StoreInteger(GCM,id,"8_4",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],4)))
		call StoreInteger(GCM,id,"8_5",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],5)))
		call StoreInteger(GCM,id,"9",HeroTypeId[pid])
		call StoreInteger(GCM,id,"id",i+5)
		if GetLocalPlayer()==PlayerModeTyper then
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"1")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"2")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"3")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"4")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"5")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"6")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"7")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_0")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_1")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_2")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_3")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_4")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_5")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"9")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"id")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"1")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"2")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"3")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"4")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"5")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"6")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"7")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_0")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_1")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_2")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_3")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_4")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_5")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"9")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"id")
		endif
		set i=i+1
	endloop
		call StoreInteger(GCM,"Global","Winner",ZD7)
		call StoreInteger(GCM,"Global","m",Minutes)
		call StoreInteger(GCM,"Global","s",Seconds)
		if GetLocalPlayer()==PlayerModeTyper then
			call SyncStoredInteger(GCM,"Global","Winner")
			call SyncStoredInteger(GCM,"Global","m")
			call SyncStoredInteger(GCM,"Global","s")
		endif
	set p=null
endfunction

function I09 takes nothing returns nothing
	call SDD("1")
endfunction

function I19 takes nothing returns nothing
	local player p=ZE7
	local integer pid=GetPlayerId(p)
	local string id=I2S(pid)
	call StoreInteger(GCM,id,"8_0",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],0)))
	call StoreInteger(GCM,id,"8_1",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],1)))
	call StoreInteger(GCM,id,"8_2",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],2)))
	call StoreInteger(GCM,id,"8_3",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],3)))
	call StoreInteger(GCM,id,"8_4",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],4)))
	call StoreInteger(GCM,id,"8_5",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],5)))
	if GetLocalPlayer()==PlayerModeTyper then
		call SyncStoredInteger(GCM,id,"8_0")
		call SyncStoredInteger(GCM,id,"8_1")
		call SyncStoredInteger(GCM,id,"8_2")
		call SyncStoredInteger(GCM,id,"8_3")
		call SyncStoredInteger(GCM,id,"8_4")
		call SyncStoredInteger(GCM,id,"8_5")
	endif
	set p=null
endfunction

function SED takes nothing returns boolean
	call ExecuteFunc("DisplayFinalMB")
	return false
endfunction

function SFD takes nothing returns nothing
	call V78(GetEnumUnit())
endfunction

function SGD takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,0,0,12000,Condition(function LR8))
	call ForGroup(g,function SFD)
	call KillGroup(g)
	set g=null
endfunction

function SHD takes nothing returns nothing
	local integer i=1
	local player p
	set bj_changeLevelShowScores=true
	call DisableTrigger(YK)
	call DisableTrigger(JK)
	call ExecuteFunc("L99")
	if udg_ObserverMode then
		call DisableTrigger(X37)
	endif
	call DisableTrigger(TriggerUpdateGameTime)
	call ClearTextMessages()
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,60,K3+" "+GetObjectName('n054')+" www.legendsofdota.com.")//n054 -> has won! Get the latest version from
	set GameEnded=true
	call AD8()
	call DisableTrigger(AG)
	call DisableTrigger(QG)
	call DisableTrigger(TriggerGoldPerSecond)
	call RMD_SendStats()
	call GroupsClose()
endfunction

function SID takes nothing returns nothing
	local trigger t=CreateTrigger()
	call PanCameraToTimed(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
	call TriggerRegisterTimerEvent(t,2.5,false)
	call TriggerAddCondition(t,Condition(function SED))
	set ZD7=2
	set K3="|c0020c000"+GetObjectName('n03O')+"|r"//n03O -> The Scourge
	call SHD()
	call SGD()
	call SDD("2")
	set t=null
endfunction

function SJD takes nothing returns boolean
	call SetUnitVertexColorBJ(FrozenThrone,100,100,100,GetTriggerEvalCount(GetTriggeringTrigger()))
	if GetTriggerEvalCount(GetTriggeringTrigger())==100 then
		call ShowUnit(FrozenThrone,false)
		call CleanTrigger(GetTriggeringTrigger())
	endif
	return false
endfunction

function SKD takes nothing returns nothing
	local trigger t=CreateTrigger()
	call PanCameraToTimed(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
	call TriggerRegisterTimerEvent(t,1.5,false)
	call TriggerAddCondition(t,Condition(function SED))
	set ZD7=1
	set K3="|c00ff0303"+GetObjectName('n03N')+"|r"//n03N -> The Sentinel
	call SHD()
	call SGD()
	call SDD("1")
	call AddSpecialEffect("war3mapImported\\FrozenThronesDeath2.mdx",GetUnitX(FrozenThrone)+150,GetUnitY(FrozenThrone)+100)
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function SJD))
	set t=null
endfunction

function SMD takes real Y08 returns boolean
	return(100*GetWidgetLife(GetTriggerUnit())/ GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE))<Y08
endfunction

function IsUnitUnderDenySpell takes unit u returns boolean
	return GetUnitAbilityLevel(u,'A464')>0 or GetUnitAbilityLevel(u,'BNdo')>0 or GetUnitAbilityLevel(u,'BEsh')>0 or GetUnitAbilityLevel(u,'B001')>0 or GetUnitAbilityLevel(u,'B0AQ')>0 or GetUnitAbilityLevel(u,'B0AP')>0//BNdo -> Doom, BEsh -> Shadow Strike, B001 -> Viper Strike, B0AQ -> Venomous Gale, B0AP -> Shadow Word
endfunction

function SOD takes nothing returns nothing
	if not((SMD(10)and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) and GetUnitTypeId(GetTriggerUnit())!='etol' and GetUnitTypeId(GetTriggerUnit())!='unpl')or(SMD(25)and IsUnitUnderDenySpell(GetTriggerUnit()))or(SMD(50)and IsUnitIdType( GetUnitTypeId( GetTriggerUnit()),UNIT_TYPE_HERO)==false and(IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false))or(GetUnitTypeId(GetTriggerUnit())=='u00S') or (LoadInteger(HY,GetHandleId(GetAttacker()),4328)==1)) then//etol -> The World Tree, unpl -> The Frozen Throne, u00S -> Power Cog, o01V -> Bomb Bomb
		call IssueImmediateOrderById(GetAttacker(),851972)
	endif
endfunction

function SPD takes nothing returns boolean
	local boolean b
	if IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(GetAttacker()))then
		call SOD()
	elseif IsUnitType(GetAttacker(),UNIT_TYPE_HERO) or IsSpiritBear(GetAttacker())then
		set b=IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitIllusion(GetAttacker())==false
		set ZF7=GetPlayerId(GetOwningPlayer(GetAttacker()))
		if HasItem_Javelin[ZF7]>0 and b and GetUnitTypeId(GetTriggerUnit())!='n00L'and EM9(GetAttacker(),Item_Real[javelin]) then//n00L -> Roshan
			call DND()
		endif
//		if HasItem_CraniumBasher[ZF7]>0 and b and(EM9(GetAttacker(),Item_Real[CraniumBasher]) or EM9(GetAttacker(),Item_Real[AbyssalBlade]))then
//			call CraniumBasherWrapper()
//		endif
		if HasItem_SangeNYasha[ZF7]>0 and b and EM9(GetAttacker(),Item_Real[SangeAndYasha]) then
			call DUD()
		elseif(HasItem_Sange[ZF7]>0 or HasItem_HeavensHalberd[ZF7]>0) and b and(EM9(GetAttacker(),Item_Real[Sange]) or EM9(GetAttacker(),Item_Real[HeavensHalberd]))then
			call DYD()
		endif
	elseif GetUnitAbilityLevel(GetAttacker(),'A17S')>0 and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false then//A17S -> SiegeUnit
		call RXD()
	endif
	return false
endfunction

function SRD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT or LoadBoolean(HY,GetHandleId(Hero),140) then
		if LoadBoolean(HY,GetHandleId(Hero),140) then
			call SaveBoolean(HY,GetHandleId(Hero),140,false)
			call SaveInteger(HY,GetHandleId(Hero),4259,2)
			call UnitRemoveAbility(Hero,'A04R')//
			call UnitRemoveAbility(Hero,'Avul')//Avul -> Invulnerable
			call PauseUnit(Hero,false)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		elseif GetSpellTargetUnit()==Hero and GetSpellAbilityId()==ZH7 and(GetPlayerSlotState(GetOwningPlayer(Hero))==PLAYER_SLOT_STATE_LEFT)and LoadInteger(HY,GetHandleId(Hero),4259)==1 then
			call SaveInteger(HY,GetHandleId(Hero),4259,2)
			call UnitRemoveAbility(Hero,'A04R')//
			call UnitRemoveAbility(Hero,'Avul')//Avul -> Invulnerable
			call PauseUnit(Hero,false)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	elseif IsDead(Hero)==false then
		call SetUnitX(Hero,x)
		call SetUnitY(Hero,y)
		call SaveInteger(HY,GetHandleId(Hero),4259,1)
		call UnitAddAbility(Hero,'A04R')//
		call UnitAddAbility2(Hero,'Avul')//Avul -> Invulnerable
		call PauseUnit(Hero,true)
	endif
	set Hero=null
	set t=null
	return false
endfunction

function SSD takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetSpellTargetUnit()
	call SaveBoolean(HY,GetHandleId(Hero),140,false)
	call SaveInteger(HY,GetHandleId(Hero),4259,1)
	call UnitAddAbility(Hero,'A04R')//
	call UnitAddAbility2(Hero,'Avul')//Avul -> Invulnerable
	call PauseUnit(Hero,true)
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveReal(HY,h,6,GetUnitX(Hero)*1.)
	call SaveReal(HY,h,7,GetUnitY(Hero)*1.)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function SRD))
	set t=null
	set Hero=null
endfunction

function MirrorImageDispells takes nothing returns nothing
	local integer i=GetSpellAbilityId()
	if i=='A1WE' or i=='A0B8' or i=='A063' or i=='A03O' or i=='A1AY' or i=='A0MQ' or i=='A1B6' then
		call PurgingTriggered(GetTriggerUnit(),false)
	endif
endfunction

function STD takes nothing returns boolean
	if GetSpellAbilityId()==ZG7 and GetPlayerSlotState(GetOwningPlayer(GetSpellTargetUnit()))==PLAYER_SLOT_STATE_LEFT and LoadInteger(HY,GetHandleId(GetSpellTargetUnit()),4259)!=1 then
		call SSD()
	elseif (GetSpellAbilityId()==ZH7 or GetSpellAbilityId()==ZG7) and GetPlayerSlotState(GetOwningPlayer(GetSpellTargetUnit()))!=PLAYER_SLOT_STATE_LEFT then
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n02N'))//n02N -> Can only target Heroes that have left the game
	endif
	if IsPurge(GetSpellAbilityId()) then
		if IsTwoSidePurge(GetSpellAbilityId())==false then
			call PurgingTriggered(GetSpellTargetUnit(),IsUnitEnemy(GetSpellTargetUnit(),GetTriggerPlayer()))
		else
			call PurgingTriggered(GetSpellTargetUnit(),IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(LoadUnitHandle(HY,GetHandleId(GetTriggerUnit()),0))))
		endif
	else
		call MirrorImageDispells()
	endif
	return false
endfunction

function SUD takes destructable d returns boolean
	local real x=GetDestructableX(d)
	local real y=GetDestructableY(d)
	local group g=GetAvailableGroup()
	local boolean SVD
	call GroupEnumUnitsInRange(g,x,y,250,Condition(function DI9))
	set SVD=FirstOfGroup(g)!=null
	call KillGroup(g)
	set g=null
	return SVD
endfunction

function SWD takes nothing returns nothing
	if IsValidTree(GetEnumDestructable())and GetDestructableLife(GetEnumDestructable())<1 and GetDestructableTypeId(GetEnumDestructable())!='B002' and GetDestructableTypeId(GetEnumDestructable())!='B003' then//B003 -> Haste
		if SUD(GetEnumDestructable())==false then
			call DestructableRestoreLife(GetEnumDestructable(),GetDestructableMaxLife(GetEnumDestructable()),false)
			call SetDestructableAnimation(GetEnumDestructable(),"birth")
			if SL[GetPlayerId(GetLocalPlayer())]==1 and GetDestructableTypeId(GetEnumDestructable())=='ATtr' then
				call SetDestructableAnimation(GetEnumDestructable(),"stand alternate")
			endif
		endif
	endif
endfunction

function SXD takes nothing returns nothing
	call EnumDestructablesInRectAll(bj_mapInitialPlayableArea,function SWD)
endfunction

function Roshan_IllusionKiller takes nothing returns boolean
	if GetUnitTypeId(GetTriggerUnit())=='n00L' then//n00L -> Roshan
		if IsUnitIllusion(GetAttacker()) then
			call KillUnit(GetAttacker())
		elseif IsUnitInRegion(ForbiddenWardsRegion,GetAttacker())==false or RectContainsUnit(RoshAbuseRect,GetAttacker()) then
			call Error(GetOwningPlayer(GetAttacker()),GetObjectName('n035'))//n035 -> You cannot attack Roshan from here
			call IssueImmediateOrderById(GetAttacker(),851972)
		endif
	endif
	return false
endfunction

function SZD takes nothing returns boolean
	return GetUnitTypeId(GetEnteringUnit())=='e00E' or GetUnitTypeId(GetEnteringUnit())=='e022'//e00E -> Spellcaster, e022 -> Spellcaster (vision)
endfunction

function DummyUtilize takes nothing returns nothing
	call ShowUnitHide(GetEnteringUnit())
	call SetUnitPathing(GetEnteringUnit(),false)
	call SetUnitInvulnerable(GetEnteringUnit(),true)
	call UnitApplyTimedLifeBJ(20.,'BTLF',GetEnteringUnit())
endfunction

function SBD takes nothing returns boolean
	return(GetUnitTypeId(GetDyingUnit())=='e00R')or(GetUnitTypeId(GetDyingUnit())=='e011')or(GetUnitTypeId(GetDyingUnit())=='e00S')or(GetUnitTypeId(GetDyingUnit())=='e019')//e00R -> Ancient Protector - level 1, e011 -> Ancient Protector - level 2, e00S -> Ancient Protector - level 3, e019 -> Ancient Protector - level 4
endfunction

function RefreshCircles takes integer id returns nothing
	if id==0 then
		call UnitResetCooldown(CirclesOfPower_1)
		call UnitResetCooldown(CirclesOfPower_2)
		call UnitResetCooldown(CirclesOfPower_3)
		call UnitResetCooldown(CirclesOfPower_4)
		call UnitResetCooldown(CirclesOfPower_5)
	else
		call UnitResetCooldown(CirclesOfPower_7)
		call UnitResetCooldown(CirclesOfPower_8)
		call UnitResetCooldown(CirclesOfPower_9)
		call UnitResetCooldown(CirclesOfPower_10)
		call UnitResetCooldown(CirclesOfPower_11)
	endif
endfunction

function IsTierOneTower takes unit tower returns boolean
	return GetUnitTypeId(tower)=='e00R' or GetUnitTypeId(tower)=='u00M'
endfunction

function TowerKillWrap takes unit tower, unit killer returns nothing
	local player p=GetOwningPlayer(killer)
	local integer pid=GetPlayerId(p)
	if IsUnitAlly(tower,p)then
		set PlayerTowersDenied[pid]=PlayerTowersDenied[pid]+1
		call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pid]+PlayerNames[pid]+"|r "+GetObjectName('n04P')+".")//n04P -> has denied a tower
	else
		set PlayerTowersKilled[pid]=PlayerTowersKilled[pid]+1
		call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pid]+PlayerNames[pid]+"|r "+GetObjectName('n0EN')+".")//n0EN -> has destroyed a tower
	endif
	if IsTierOneTower(tower) then
		if GetOwningPlayer(tower)==Sentinels[0]then
			call DisplayTimedTextToForceEx(Force_Elfs,TxtDur[GetPlayerId(GetLocalPlayer())],"Your Glyph of Fortification cooldown has been reset.")
		else
			call DisplayTimedTextToForceEx(Force_Unds,TxtDur[GetPlayerId(GetLocalPlayer())],"Your Glyph of Fortification cooldown has been reset.")
		endif
	endif
endfunction

function S6D takes nothing returns nothing
	local unit u=GetDyingUnit()
	local unit killer=GetKillingUnit()
	local player pk=GetOwningPlayer(killer)
	local integer pid=GetPlayerId(pk)
	call TowerKillWrap(u,killer)
	if u==Towers_Sent_Top_1 or u==Towers_Sent_Mid_1 or u==Towers_Sent_Bot_1 then
		call TowerKill(killer,1)
		if IsUnitAlly(u,pk)==false then
			call RefreshCircles(0)
		endif
		if u==Towers_Sent_Top_1 then
			call Traffic_RegisterData("Tower010",pid)
			call UnitRemoveAbility(Towers_Sent_Top_2,'Avul')//Avul -> Invulnerable
		elseif u==Towers_Sent_Mid_1 then
			call Traffic_RegisterData("Tower011",pid)
			call UnitRemoveAbility(Towers_Sent_Mid_2,'Avul')//Avul -> Invulnerable
		else
			call Traffic_RegisterData("Tower012",pid)
			call UnitRemoveAbility(Towers_Sent_Bot_2,'Avul')//Avul -> Invulnerable
		endif
	elseif u==Towers_Sent_Top_2 or u==Towers_Sent_Mid_2 or u==Towers_Sent_Bot_2 then
		call TowerKill(killer,2)
		if u==Towers_Sent_Top_2 then
			call Traffic_RegisterData("Tower020",pid)
			call UnitRemoveAbility(Towers_Sent_Top_3,'Avul')//Avul -> Invulnerable
		elseif u==Towers_Sent_Mid_2 then
			call Traffic_RegisterData("Tower021",pid)
			call UnitRemoveAbility(Towers_Sent_Mid_3,'Avul')//Avul -> Invulnerable
		else
			call Traffic_RegisterData("Tower022",pid)
			call UnitRemoveAbility(Towers_Sent_Bot_3,'Avul')//Avul -> Invulnerable
		endif
	elseif u==Towers_Sent_Top_3 or u==Towers_Sent_Mid_3 or u==Towers_Sent_Bot_3 then
		call TowerKill(killer,3)
		call UnitRemoveAbility(Towers_Sent_Tree1,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(Towers_Sent_Tree2,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EW7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EX7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EY7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EZ7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EK7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EM7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EN7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EO7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EP7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EQ7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(ER7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(ES7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(ET7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EU7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(EV7,'Avul')//Avul -> Invulnerable
		if u==Towers_Sent_Top_3 then
			call Traffic_RegisterData("Tower030",pid)
			call UnitRemoveAbility(Elf_Rax_Melee_Top,'Avul')//Avul -> Invulnerable
			call UnitRemoveAbility(Elf_Rax_Range_Top,'Avul')//Avul -> Invulnerable
		elseif u==Towers_Sent_Mid_3 then
			call Traffic_RegisterData("Tower031",pid)
			call UnitRemoveAbility(Elf_Rax_Melee_Mid,'Avul')//Avul -> Invulnerable
			call UnitRemoveAbility(Elf_Rax_Range_Mid,'Avul')//Avul -> Invulnerable
		else
			call Traffic_RegisterData("Tower032",pid)
			call UnitRemoveAbility(Elf_Rax_Melee_Bot,'Avul')//Avul -> Invulnerable
			call UnitRemoveAbility(Elf_Rax_Range_Bot,'Avul')//Avul -> Invulnerable
		endif
	elseif u==Towers_Sent_Tree1 or u==Towers_Sent_Tree2 then
		call Traffic_RegisterData("Tower041",pid)
		call TowerKill(killer,4)
		if (u==Towers_Sent_Tree1 and IsDead(Towers_Sent_Tree2)) or (u==Towers_Sent_Tree2 and IsDead(Towers_Sent_Tree1)) then
			call UnitRemoveAbility(TreeOfLife,'Avul')//Avul -> Invulnerable
		endif
	endif
	set u=null
	set killer=null
endfunction

function SLD takes nothing returns boolean
	return(GetUnitTypeId(GetDyingUnit())=='u00M')or(GetUnitTypeId(GetDyingUnit())=='u00D')or(GetUnitTypeId(GetDyingUnit())=='u00N')or(GetUnitTypeId(GetDyingUnit())=='u00T')//u00M -> Spirit Tower - level 1, u00D -> Spirit Tower - level 2, u00N -> Spirit Tower - level 3, u00T -> Spirit Tower - level 4
endfunction

function S5D takes nothing returns nothing
	local unit u=GetDyingUnit()
	local unit killer=GetKillingUnit()
	local player pk=GetOwningPlayer(killer)
	local integer pid=GetPlayerId(pk)
	call TowerKillWrap(u,killer)
	if u==Towers_Scourge_Top_1 or u==Towers_Scourge_Mid_1 or u==Towers_Scourge_Bot_1 then
		call TowerKill(killer,1)
		if IsUnitAlly(u,pk)==false then
			call RefreshCircles(1)
		endif
		if u==Towers_Scourge_Top_1 then
			call Traffic_RegisterData("Tower110",pid)
			call UnitRemoveAbility(Towers_Scourge_Top_2,'Avul')//Avul -> Invulnerable
		elseif u==Towers_Scourge_Mid_1 then
			call Traffic_RegisterData("Tower111",pid)
			call UnitRemoveAbility(Towers_Scourge_Mid_2,'Avul')//Avul -> Invulnerable
		else
			call Traffic_RegisterData("Tower112",pid)
			call UnitRemoveAbility(Towers_Scourge_Bot_2,'Avul')//Avul -> Invulnerable
		endif
	elseif u==Towers_Scourge_Top_2 or u==Towers_Scourge_Mid_2 or u==Towers_Scourge_Bot_2 then
		call TowerKill(killer,2)
		if u==Towers_Scourge_Top_2 then
			call Traffic_RegisterData("Tower120",pid)
			call UnitRemoveAbility(Towers_Scourge_Top_3,'Avul')//Avul -> Invulnerable
		elseif u==Towers_Scourge_Mid_2 then
			call Traffic_RegisterData("Tower121",pid)
			call UnitRemoveAbility(Towers_Scourge_Mid_3,'Avul')//Avul -> Invulnerable
		else
			call Traffic_RegisterData("Tower122",pid)
			call UnitRemoveAbility(Towers_Scourge_Bot_3,'Avul')//Avul -> Invulnerable
		endif
	elseif u==Towers_Scourge_Top_3 or u==Towers_Scourge_Mid_3 or u==Towers_Scourge_Bot_3 then
		call TowerKill(killer,3)
		call UnitRemoveAbility(Towers_Scourge_Throne1,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(Towers_Scourge_Throne2,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(IM7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(IN7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(IO7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(IP7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(I77,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(I87,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(I97,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(ID7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(IE7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(IF7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(IG7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(IH7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(II7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(IJ7,'Avul')//Avul -> Invulnerable
		call UnitRemoveAbility(IK7,'Avul')//Avul -> Invulnerable
		if u==Towers_Scourge_Top_3 then
			call Traffic_RegisterData("Tower130",pid)
			call UnitRemoveAbility(Und_Rax_Melee_Top,'Avul')//Avul -> Invulnerable
			call UnitRemoveAbility(Und_Rax_Range_Top,'Avul')//Avul -> Invulnerable
		elseif u==Towers_Scourge_Mid_3 then
			call Traffic_RegisterData("Tower131",pid)
			call UnitRemoveAbility(Und_Rax_Melee_Mid,'Avul')//Avul -> Invulnerable
			call UnitRemoveAbility(Und_Rax_Range_Mid,'Avul')//Avul -> Invulnerable
		else
			call Traffic_RegisterData("Tower132",pid)
			call UnitRemoveAbility(Und_Rax_Melee_Bot,'Avul')//Avul -> Invulnerable
			call UnitRemoveAbility(Und_Rax_Range_Bot,'Avul')//Avul -> Invulnerable
		endif
	elseif u==Towers_Scourge_Throne1 or u==Towers_Scourge_Throne2 then
		call Traffic_RegisterData("Tower141",pid)
		call TowerKill(killer,4)
		if (u==Towers_Scourge_Throne1 and IsDead(Towers_Scourge_Throne2)) or (u==Towers_Scourge_Throne2 and IsDead(Towers_Scourge_Throne1)) then
			call UnitRemoveAbility(FrozenThrone,'Avul')//Avul -> Invulnerable
		endif
	endif
	set u=null
	set killer=null
endfunction

function S2D takes nothing returns boolean
	local integer x=0
	if GetPlayerSlotState(Sentinels[1])==PLAYER_SLOT_STATE_EMPTY then
		set x=x+1
	endif
	if GetPlayerSlotState(Sentinels[2])==PLAYER_SLOT_STATE_EMPTY then
		set x=x+1
	endif
	if GetPlayerSlotState(Sentinels[3])==PLAYER_SLOT_STATE_EMPTY then
		set x=x+1
	endif
	if GetPlayerSlotState(Sentinels[4])==PLAYER_SLOT_STATE_EMPTY then
		set x=x+1
	endif
	if GetPlayerSlotState(Sentinels[5])==PLAYER_SLOT_STATE_EMPTY then
		set x=x+1
	endif
	if GetPlayerSlotState(Scourges[1])==PLAYER_SLOT_STATE_EMPTY then
		set x=x+1
	endif
	if GetPlayerSlotState(Scourges[2])==PLAYER_SLOT_STATE_EMPTY then
		set x=x+1
	endif
	if GetPlayerSlotState(Scourges[3])==PLAYER_SLOT_STATE_EMPTY then
		set x=x+1
	endif
	if GetPlayerSlotState(Scourges[4])==PLAYER_SLOT_STATE_EMPTY then
		set x=x+1
	endif
	if GetPlayerSlotState(Scourges[5])==PLAYER_SLOT_STATE_EMPTY then
		set x=x+1
	endif
	return x==9
endfunction

function Testmode_Spawnon takes nothing returns nothing
	set CreepSpawnDisabled=false
endfunction

function Testmode_Roshan takes nothing returns nothing
	set ZM7=true
endfunction

function Testmode_Spawnoff takes nothing returns nothing
	set CreepSpawnDisabled=true
endfunction

function Testmode_NHL takes nothing returns nothing
	set NoHeroLimitOff=false
endfunction

function TDD takes nothing returns boolean
	if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false then
		call KillUnit(GetFilterUnit())
	endif
	return false
endfunction

function Testmode_KillScrg takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,Scourges[0],Condition(function TDD))
	call KillGroup(g)
	set g=null
endfunction

function Testmode_KillSent takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,Sentinels[0],Condition(function TDD))
	call KillGroup(g)
	set g=null
endfunction

function TGD takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())=='o004' or GetUnitTypeId(GetFilterUnit())=='oeye' then//o004 -> Observer Ward, oeye -> Sentry Ward
		call KillUnit(GetFilterUnit())
	endif
	return false
endfunction

function Testmode_KillWards takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,0,0,9999,Condition(function TGD))
	call KillGroup(g)
	set g=null
endfunction

function Testmode_KillAll takes nothing returns nothing
	call Testmode_KillSent()
	call Testmode_KillScrg()
endfunction

function TJD takes nothing returns boolean
	if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) then
		call SmoothLvlup(GetFilterUnit(),IMaxIF(tt_int1,1),true,0)
	endif
	return false
endfunction

function Testmode_Lvlup takes nothing returns nothing
	local string s=SubString(GetEventPlayerChatString(),2,StringLength(GetEventPlayerChatString()))
	local integer lvl=S2I(s)
	local group g=GetAvailableGroup()
	if lvl==0 then
		set lvl=S2I(SubString(GetEventPlayerChatString(),6,StringLength(GetEventPlayerChatString())))
	endif
	if lvl<1 then
		set lvl=1
	endif
	if GetEventPlayerChatString()=="-l" then
		set lvl=25
	endif
	set tt_int1=lvl
	call GroupEnumUnitsOfPlayer(g,GetTriggerPlayer(),Condition(function TJD))
	call KillGroup(g)
	set g=null
endfunction

function Testmode_Spawncreeps takes nothing returns nothing
	call TriggerExecute(AG)
endfunction

function TOD takes nothing returns boolean
	local unit u = GetFilterUnit()
	if IsUnitType(u,UNIT_TYPE_HERO) then
		call UnitResetCooldown(u)
		call TimerStart(PrimUltiTimer[GetPlayerId((GetOwningPlayer(u)))],0,false,null)
		call TimerStart(SecUltiTimer[GetPlayerId((GetOwningPlayer(u)))],0,false,null)
		call SetWidgetLife(u,GetUnitState(u,UNIT_STATE_MAX_LIFE))
		call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MAX_MANA))
	endif
	set u = null
	return false
endfunction

function Testmode_Refresh takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,GetTriggerPlayer(),Condition(function TOD))
	call KillGroup(g)
	set g=null
endfunction

function Testmode_Kill takes nothing returns nothing
	call KillUnit(udg_Hero[GetPlayerId(GetTriggerPlayer())])
endfunction

function Testmode_Time takes nothing returns nothing
	local string TSD=SubString(GetEventPlayerChatString(),5,StringLength(GetEventPlayerChatString()))
	local integer Time=S2I(TSD)
	if Time<0 or Time>24 then
		set Time=0
	endif
	call SetFloatGameState(GAME_STATE_TIME_OF_DAY,Time)
endfunction

function Testmode_Gold takes nothing returns nothing
	local string s=SubString(GetEventPlayerChatString(),2,StringLength(GetEventPlayerChatString()))
	local integer g=S2I(s)
	if GetEventPlayerChatString()=="-g" then
		call SetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD,999999)
		return
	endif
	if g==0 then
		set g=S2I(SubString(GetEventPlayerChatString(),5,StringLength(GetEventPlayerChatString())))
	endif
	call SetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD)+g)
endfunction

function Testmode_Respawn takes nothing returns nothing
	local unit CE8=udg_Hero[GetPlayerId(GetTriggerPlayer())]
	local player WU9=GetTriggerPlayer()
	local location WQ9
	if IsScourge(WU9)then
		set WQ9=GetRectCenter(gg_rct_Hero_Creation_UD)
	else
		set WQ9=GetRectCenter(gg_rct_Hero_Creation_NE)
	endif
	if GameEnded==false and IsDead(CE8)then
		call J89(CE8,WU9,GetLocationX(WQ9),GetLocationY(WQ9),true)
		if WM9(CE8)==false or GetUnitAbilityLevel(CE8,'A0MW')==0 then//A0MW -> Divided We Stand
			call ReviveHeroLoc(CE8,WQ9,true)
		else
			call WP9(CE8,WQ9)
		endif
	endif
	call RemoveLocation(WQ9)
	set CE8=null
	set WU9=null
	set WQ9=null
endfunction

function Testmode_Dummy takes nothing returns nothing
	local unit Source=udg_Hero[GetPlayerId(GetTriggerPlayer())]
	local player p
	local unit u
	local string s=SubString(GetEventPlayerChatString(),2,StringLength(GetEventPlayerChatString()))
	local integer i=1
	if(S2I(s)>0)then
		set i=IMinIF(S2I(s),12)
	endif
	if IsScourge(GetOwningPlayer(Source))then
		set p=Sentinels[1]
	else
		set p=Scourges[1]
	endif
	loop
		if i>1 then
			set u=CreateUnit(p,MeleeHeroesArray[GetRandomInt(1,MeleeHeroesAmount)],-400,-400,0)
		else
			set u=CreateUnit(Scourges[1],'H000',-400,-400,0)//H000 -> Centaur Warchief
		endif
		call SetHeroLevel(u,10,false)
		set i=i-1
		exitwhen i==0
	endloop
	set udg_Hero[GetPlayerId(Scourges[1])]=u
	set Source=null
	set u=null
	set p=null
endfunction

function Testmode_Powerup takes nothing returns nothing
	call TriggerEvaluate(RuneSpawnTrigger)
endfunction

function Testmode_Neutrals takes nothing returns nothing
	call TriggerEvaluate(NG)
endfunction

function Testmode_Trees takes nothing returns nothing
	call EnumDestructablesInRectAll(bj_mapInitialPlayableArea,function SWD)
endfunction

function TCD takes nothing returns boolean
	call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60,"**** REMINDER ****")
	call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60,"Single player commands enabled. You may use commands like -lvlup xx, -refresh, -spawncreeps, -powerup, -neutrals, -kill, -gold xxxx, -time xx, -killsent, -killscourge, -killall, -noherolimit, -trees, -killwards, -spawnoff, -spawnon, -roshan, -respawn, -dummy")
	call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60,"**** REMINDER ****")
	return false
endfunction

function ActivateWTFTest takes nothing returns nothing
	set WTFModeActive=not WTFModeActive
	call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,10,"WTF status: "+B2S(WTFModeActive))
endfunction

function TestMode_levelupshort takes nothing returns nothing
	local string s=SubString(GetEventPlayerChatString(),2,99)
	local integer lvl=IMaxIF(S2I(s),1)
	local group g
	local unit u
	if S2I(SubString(GetEventPlayerChatString(),2,4))==0 then
		if GetEventPlayerChatString()=="-l" then
			set lvl=25
		else
			return
		endif
	endif
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),Condition(function ReturnTrue))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if IsUnitType(u,UNIT_TYPE_HERO)then
			call SetHeroLevel(u,GetHeroLevel(u)+IMaxIF(lvl,1),true)
		endif
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
endfunction


function T3D takes nothing returns nothing
	local player OnlyPlayer=PlayerModeTyper
	local trigger t
	set quest_test=true
	call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60,"Single player commands enabled. You may use commands like -lvlup xx, -refresh, -spawncreeps, -powerup, -neutrals, -kill, -gold xxxx, -time xx, -killsent, -killscourge, -killall, -noherolimit, -trees, -killwards, -spawnoff, -spawnon, -roshan, -respawn, -dummy")
	set t=CreateTrigger()
	call TriggerAddCondition(t,Condition(function TCD))
	call TriggerRegisterTimerEvent(t,GetRandomReal(60,100),false)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-lvlup",false)
	call TriggerRegisterPlayersChat(t,"-l ",false)
	call TriggerAddAction(t,function Testmode_Lvlup)
	call TriggerRegisterPlayersChat(t,"-l",false)
	call TriggerAddAction(t,function TestMode_levelupshort)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-spawncreeps",true)
	call TriggerRegisterPlayersChat(t,"-sc",true)
	call TriggerAddAction(t,function Testmode_Spawncreeps)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-refresh",true)
	call TriggerAddAction(t,function Testmode_Refresh)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-kill",true)
	call TriggerAddAction(t,function Testmode_Kill)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-wtf",true)
	call TriggerAddAction(t,function ActivateWTFTest)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-gold",false)
	call TriggerRegisterPlayersChat(t,"-g ",false)
	call TriggerRegisterPlayersChat(t,"-g",true)
	call TriggerAddAction(t,function Testmode_Gold)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-time",false)
	call TriggerAddAction(t,function Testmode_Time)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-powerup",true)
	call TriggerAddAction(t,function Testmode_Powerup)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-killall",true)
	call TriggerRegisterPlayersChat(t,"-ka",true)
	call TriggerAddAction(t,function Testmode_KillAll)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-killsent",true)
	call TriggerAddAction(t,function Testmode_KillSent)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-killscourge",true)
	call TriggerAddAction(t,function Testmode_KillScrg)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-neutrals",true)
	call TriggerRegisterPlayersChat(t,"-n",true)
	call TriggerAddAction(t,function Testmode_Neutrals)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-noherolimit",true)
	call TriggerRegisterPlayersChat(t,"-nhl",true)
	call TriggerAddAction(t,function Testmode_NHL)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-trees",true)
	call TriggerAddAction(t,function Testmode_Trees)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-killwards",true)
	call TriggerAddAction(t,function Testmode_KillWards)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-spawnoff",true)
	call TriggerAddAction(t,function Testmode_Spawnoff)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-spawnon",true)
	call TriggerAddAction(t,function Testmode_Spawnon)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-roshan",true)
	call TriggerAddAction(t,function Testmode_Roshan)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-respawn",true)
	call TriggerRegisterPlayersChat(t,"-res",true)
	call TriggerAddAction(t,function Testmode_Respawn)
	set t=CreateTrigger()
	call TriggerRegisterPlayersChat(t,"-dummy",true)
	call TriggerRegisterPlayersChat(t,"-d",true)
	call TriggerRegisterPlayersChat(t,"-d ",false)
	call TriggerAddAction(t,function Testmode_Dummy)
	set OnlyPlayer=null
	set t=null
endfunction

function T6D takes nothing returns boolean
	return not IsHeroesAvailable
endfunction

function TLD takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Unit=(LoadUnitHandle(HY,h,26))
	if GetUnitTypeId(Unit)!='ncop' then//ncop -> Circle of Power
		call UnitResetCooldown(Unit)
		call SetUnitManaPercentBJ(Unit,100)
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Unit=null
	return false
endfunction

function T1D takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function TLD))
	call SaveUnitHandle(HY,h,26,(GetTriggerUnit()))
	set t=null
endfunction

function T0D takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer T5D=CountPlayersInForce(Force_Elfs)+CountPlayersInForce(Force_Unds)
	local integer NumRequired=IMinIF(T5D,T5D/ 2+1)
	local integer h=GetHandleId(t)
	if AQ7==false then
		set ZN7=true
		call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60.," ")
		call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,90.,GetObjectName('n077'))//n077 -> WTF mode activated. In this mode spells have no cooldown or manacost.
		call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,90.,GetObjectName('n078'))//n078 -> This is a FOR FUN ONLY mode.
		set t=CreateTrigger()
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
		call TriggerAddAction(t,function T1D)
	endif
	set t=null
endfunction

function T2D takes nothing returns boolean
	if V99(GetTriggerUnit())and IsUnitIllusion(GetTriggerUnit())==false then
		call GR9(GetOwningPlayer(GetTriggerUnit()))
		call Traffic_RegisterData("Level"+I2S(GetHeroLevel(GetTriggerUnit())),GetPlayerId(GetOwningPlayer(GetTriggerUnit())))
	endif
	return false
endfunction

function U4D takes nothing returns nothing
	if AQ7==false then
		call T3D()
		call CleanTrigger(GetTriggeringTrigger())
	endif
endfunction

function U7D takes nothing returns boolean
	if IsHeroesAvailable==false and(bj_isSinglePlayer and S2D())==false then
		call U4D()
	endif
	return false
endfunction

function RestoreNormalCreepsAggro takes nothing returns nothing
	call SetUnitUserData(GetEnumUnit(),0)
	call IssuePointOrderByIdLoc(GetEnumUnit(),ORDER_attack,(WaypointLocations[GetUnitAbilityLevel((GetEnumUnit()),WaypointAbilID)]))
endfunction

function AggroCreepOnTarget takes nothing returns nothing
	call IssueTargetOrderById(GetEnumUnit(),ORDER_attack,HeroAttackedLogic_TempUnit)
	call GroupAddUnit(HeroAttackedLogic_TempGroup,GetEnumUnit())
	call SetUnitUserData(GetEnumUnit(),HeroAttackedLogic_TempInt)
endfunction

function HeroAttackedLogic_CreepsFilter takes nothing returns boolean
	local integer id=GetUnitTypeId(GetFilterUnit())
	if id=='ebal' or id=='e026' or id=='umtw' or id=='u00R' then//ebal -> Glaive Thrower, e026 -> Glaive Thrower, umtw -> Meat Wagon, u00R -> Meat Wagon
		return false
	endif
	if IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(HeroAttackedLogic_TempUnit))and(GetOwningPlayer(GetFilterUnit())==Sentinels[0]or GetOwningPlayer(GetFilterUnit())==Scourges[0])and GetUnitUserData(GetFilterUnit())==0 then
		return true
	endif
	return false
endfunction

function RestoreNormalCreepsAggroIf2Far takes nothing returns nothing
	if GetUnitCurrentOrder(GetEnumUnit())==0 and IsUnitInRange(GetEnumUnit(),HeroAttackedLogic_TempUnit,GetUnitAcquireRange(GetEnumUnit()))==false then
		call GroupRemoveUnit(HeroAttackedLogic_TempGroup,GetEnumUnit())
		call SetUnitUserData(GetEnumUnit(),0)
		call IssuePointOrderByIdLoc(GetEnumUnit(),ORDER_attack,(WaypointLocations[GetUnitAbilityLevel((GetEnumUnit()),WaypointAbilID)]))
	endif
endfunction

function HeroAttackedLogic_RestoreDefault takes nothing returns nothing
	local integer h=GetHandleId((LoadUnitHandle(HY,(GetHandleId(GetExpiredTimer())),2)))
	local integer id=(LoadInteger(HY,h,143))
	local group associatedGroup=(LoadGroupHandle(HY,h,144))
	set HeroAttackedLogic_Attackers[id]=null
	call ForGroup(associatedGroup,function RestoreNormalCreepsAggro)
	call GroupClear(associatedGroup)
	set associatedGroup=null
endfunction

function HeroAttackedLogic_Action takes unit victim,unit aggressor returns nothing
	local integer h=GetHandleId(victim)
	local group associatedGroup=LoadGroupHandle(HY,h,144)
	local integer id=LoadInteger(HY,h,143)
	local unit haunted=HeroAttackedLogic_Attackers[id]
	local group g
	if haunted!=null and haunted!=aggressor then
		call ForGroup(associatedGroup,function RestoreNormalCreepsAggro)
		call GroupClear(associatedGroup)
	endif
	set HeroAttackedLogic_Attackers[id]=aggressor
	set HeroAttackedLogic_TempGroup=associatedGroup
	set HeroAttackedLogic_TempUnit=aggressor
	set HeroAttackedLogic_TempInt=id
	call ForGroup(associatedGroup,function RestoreNormalCreepsAggroIf2Far)
	set g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(aggressor),GetUnitY(aggressor),500,Condition(function HeroAttackedLogic_CreepsFilter))
	call ForGroup(g,function AggroCreepOnTarget)
	call KillGroup(g)
	call TimerStart(LoadTimerHandle(HY,h,141),2,false,function HeroAttackedLogic_RestoreDefault)
	set associatedGroup=null
	set haunted=null
	set g=null
endfunction

function HeroAttackedLogic_OrderIssued takes nothing returns boolean
	local unit Hero=GetTriggerUnit()
	local unit Target=GetOrderTargetUnit()
	local integer order=GetIssuedOrderId()
	local integer id
	if IsUnitType(Target,UNIT_TYPE_HERO) and IsUnitIllusion(Target)==false and(order==ORDER_attack or order==851971)and IsUnitEnemy(Target,GetOwningPlayer(Hero))and IsUnitVisibleLoD(Hero,GetOwningPlayer(Target)) and IsOrbAttack==false then
		set id=(LoadInteger(HY,(GetHandleId(Target)),143))
		if HeroAttackedLogic_Attackers[id]==null or HeroAttackedLogic_Attackers[id]==Target or IsDead(HeroAttackedLogic_Attackers[id])then
			call HeroAttackedLogic_Action(Target,Hero)
		endif
	endif
	set Hero=null
	set Target=null
	return false
endfunction

function HeroAttackedLogic_Attacked takes nothing returns boolean
	local unit u=GetAttacker()
	local unit Hero=GetTriggerUnit()
	local integer id
	if IsCreep(u)==false and IsOrbAttack==false then
		set id=(LoadInteger(HY,(GetHandleId(Hero)),143))//load internal hero's number
		if HeroAttackedLogic_Attackers[id]==null or HeroAttackedLogic_Attackers[id]==Hero or IsDead(HeroAttackedLogic_Attackers[id])then//if 
			call HeroAttackedLogic_Action(Hero,u)
		endif
	endif
	set u=null
	set Hero=null
	return false
endfunction

function HeroAttackedLogic_Register takes unit Hero returns nothing
	local group g
	local trigger t
	local timer tm
	local integer h=GetHandleId(Hero)
	set HeroAttackedLogic_Counter=HeroAttackedLogic_Counter+1
	call SaveBoolean(HY,h,142,(true))
	call SaveInteger(HY,h,143,(HeroAttackedLogic_Counter))
	set g=GetAvailableGroup()
	call SaveGroupHandle(HY,h,144,(g))
	set t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call TriggerAddCondition(t,Condition(function HeroAttackedLogic_OrderIssued))
	set t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ATTACKED)
	call TriggerAddCondition(t,Condition(function HeroAttackedLogic_Attacked))
	set tm=CreateTimer()
	call SaveTimerHandle(HY,(GetHandleId(Hero)),141,(tm))
	call SaveUnitHandle(HY,(GetHandleId(tm)),2,(Hero))
	set g=null
	set t=null
	set tm=null
endfunction

function ProvideForbiddenSpellsForNeutralsAct takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer id
	local unit u
	if GetTriggerEventId()==EVENT_UNIT_CHANGE_OWNER then
		set u=GetTriggerUnit()
		set id=GetUnitTypeId(u)
		if id=='n026' or id=='n127' then//n026 -> Mud Golem, n127 -> Shard Golem
			call UnitAddAbility2(u,'A36I')//A36I -> Hurl Boulder (Golem)
		elseif id=='ndtw' then//ndtw -> Dark Troll Warlord
			call UnitAddAbility2(u,'ACen')//ACen -> Ensnare
		elseif id=='nomg' then//nomg -> Ogre Magi
			call UnitAddAbility2(u,'ACf2')//ACf2 -> Frost Armor
		elseif id=='n0HX' then//n0HX -> Harpy Storm
			call UnitAddAbility2(u,'ACcl')//ACcl -> Chain Lightning
		elseif id=='nsat' then//nsat -> Satyr Trickster
			call UnitAddAbility2(u,'ACpu')//ACpu -> Purge
		elseif id=='nstl' then//nstl -> Satyr Soulstealer
			call UnitAddAbility2(u,'Ambd')//Ambd -> Mana Burn
		endif
		set u=null
		call DestroyTrigger(t)
	else
		call DestroyTrigger(t)
	endif
	return false
endfunction

function ProvideForbiddenSpells takes unit u returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_CHANGE_OWNER)
	call TriggerRegisterDeathEvent(t,u)
	call TriggerAddCondition(t,Condition(function ProvideForbiddenSpellsForNeutralsAct))
	set t=null
endfunction

function NeutralEntersMap takes unit u returns nothing
	local integer id=GetUnitTypeId(u)
	if id=='n127' or id=='n128' then//n127 -> Shard Golem, n128 -> Doom Hatchling
		call UnitApplyTimedLife(u,'BTLF',60)
		if GetOwningPlayer(u)!=Neutrals then
			call UnitAddAbility2(u,'A36I')//A36I -> Hurl Boulder (Golem)
		endif
	endif
	if GetOwningPlayer(u)==Neutrals then
		if id=='n127' or id=='n026' or id=='ndtw' or id=='nomg' or id=='n0HX' or id=='nsat' or id=='nstl' then//n127 -> Shard Golem, n026 -> Mud Golem, ndtw -> Dark Troll Warlord, nomg -> Ogre Magi, n0HX -> Harpy Storm, nsat -> Satyr Trickster, nstl -> Satyr Soulstealer
			call ProvideForbiddenSpells(u)
		endif
		if id=='ndtw' or id=='ndtr' or id=='nftb' or id=='nfsh' or id=='ngns' or id=='n0HX' then
			call SetUnitAcquireRange(u,300)
		endif
	endif
endfunction

function HeroAttackedLogic_Init takes nothing returns boolean
	if IsRealHero(GetTriggerUnit())and(LoadBoolean(HY,(GetHandleId(GetTriggerUnit())),142))==false and (not b_isPickTime) then
		call HeroAttackedLogic_Register(GetTriggerUnit())
	endif
	if HaveSavedInteger(UnitStats,GetUnitTypeId(GetTriggerUnit()),EXP) then
		call NeutralEntersMap(GetTriggerUnit())
	endif
	return false
endfunction

function UZD takes nothing returns boolean
	if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
		call SetUnitAbilityLevel(GetTriggerUnit(),WaypointAbilID,5)
		if HeroAttackedLogic_Attackers[GetUnitUserData(GetTriggerUnit())]==null then
			call SetUnitUserData(GetTriggerUnit(),0)
			call IssuePointOrderByIdLoc(GetTriggerUnit(),ORDER_attack,(WaypointLocations[GetUnitAbilityLevel((GetTriggerUnit()),WaypointAbilID)]))
		endif
	elseif GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
		call SetUnitAbilityLevel(GetTriggerUnit(),WaypointAbilID,1)
		if HeroAttackedLogic_Attackers[GetUnitUserData(GetTriggerUnit())]==null then
			call SetUnitUserData(GetTriggerUnit(),0)
			call IssuePointOrderByIdLoc(GetTriggerUnit(),ORDER_attack,(WaypointLocations[GetUnitAbilityLevel((GetTriggerUnit()),WaypointAbilID)]))
		endif
	endif
	return false
endfunction

function UAD takes nothing returns nothing
	local unit H3D=GetTriggerUnit()
	local unit UBD=(LoadUnitHandle(HY,(GetHandleId(H3D)),145))
	call RemoveUnit(UBD)
	set H3D=null
	set UBD=null
endfunction

function UCD takes nothing returns nothing
	local group g
	local unit H3D
	local unit UBD
	local trigger t
	local integer i
	set t=CreateTrigger()
	call TriggerAddAction(t,function UAD)
	set g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,Sentinels[0],Condition(function ReturnTrue))
	loop
		set H3D=FirstOfGroup(g)
		exitwhen H3D==null
		call GroupRemoveUnit(g,H3D)
		if GetUnitAbilityLevel(H3D,'Adts')>0 or GetUnitAbilityLevel(H3D,'Atru')>0 then//Adts -> Tower Truesight, Atru -> True Sight
			call TriggerRegisterUnitEvent(t,H3D,EVENT_UNIT_DEATH)
			set UBD=CreateUnit(Sentinels[1],('u00B'),-5000,-5100,0)//u00B -> ObserverTruesight
			call SetUnitScale(UBD,0,0,0)
			call SetUnitPathing(UBD,false)
			call SetUnitInvulnerable(UBD,true)
			call SetUnitX(UBD,GetUnitX(H3D))
			call SetUnitY(UBD,GetUnitY(H3D))
			call SaveUnitHandle(HY,(GetHandleId(H3D)),145,(UBD))
		endif
	endloop
	call KillGroup(g)
	set g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,Scourges[0],Condition(function ReturnTrue))
	loop
		set H3D=FirstOfGroup(g)
		exitwhen H3D==null
		call GroupRemoveUnit(g,H3D)
		if GetUnitAbilityLevel(H3D,'Adts')>0 or GetUnitAbilityLevel(H3D,'Atru')>0 then//Adts -> Tower Truesight, Atru -> True Sight
			call TriggerRegisterUnitEvent(t,H3D,EVENT_UNIT_DEATH)
			set UBD=CreateUnit(Scourges[1],('u00B'),3400,4400,0)//u00B -> ObserverTruesight
			call SetUnitScale(UBD,0,0,0)
			call SetUnitPathing(UBD,false)
			call SetUnitInvulnerable(UBD,true)
			call SetUnitX(UBD,GetUnitX(H3D))
			call SetUnitY(UBD,GetUnitY(H3D))
			call SaveUnitHandle(HY,(GetHandleId(H3D)),145,(UBD))
		endif
	endloop
	call KillGroup(g)
	set g=null
	set t=null
	set UBD=null
	set H3D=null
endfunction

function U3D takes nothing returns nothing
	local unit U6D=GetTriggerUnit()
	local unit Target=HeroAttackedLogic_Attackers[GetUnitUserData(U6D)]
	call SetUnitPosition(U6D,GetUnitX(U6D),GetUnitY(U6D))
	if Target!=null and IsDead(Target)==false and IsUnitVisibleLoD(Target,GetOwningPlayer(Target))then
		call IssueTargetOrderById(U6D,ORDER_attack,Target)
	else
		call DisableTrigger(GetTriggeringTrigger())
		call IssuePointOrderByIdLoc(U6D,ORDER_attack,(WaypointLocations[GetUnitAbilityLevel((U6D),WaypointAbilID)]))
		call EnableTrigger(GetTriggeringTrigger())
	endif
	set U6D=null
	set Target=null
endfunction

function ULD takes nothing returns boolean
	if IsCreep(GetTriggerUnit())then
		call U3D()
	endif
	return false
endfunction

function U1D takes nothing returns nothing
	local unit U6D=GetTriggerUnit()
	local unit Target=HeroAttackedLogic_Attackers[GetUnitUserData(U6D)]
	call SetUnitPosition(U6D,GetUnitX(U6D),GetUnitY(U6D))
	if Target!=null and IsDead(Target)==false and IsUnitVisibleLoD(Target,GetOwningPlayer(Target))then
		call IssueTargetOrderById(U6D,ORDER_attack,Target)//attack
	else
		call DisableTrigger(GetTriggeringTrigger())
		call IssuePointOrderByIdLoc(U6D,ORDER_attack,(WaypointLocations[GetUnitAbilityLevel((U6D),WaypointAbilID)]))//attack
		call EnableTrigger(GetTriggeringTrigger())
	endif
	set U6D=null
	set Target=null
endfunction

function U0D takes nothing returns boolean
	if GetIssuedOrderId()==ORDER_move then//move
		call U1D()
	endif
	return false
endfunction

function U5D takes nothing returns boolean
	if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
		if IsUnitFogged(GetAttacker(),Sentinels[1])or IsUnitFogged(GetAttacker(),Scourges[1])then
			call A28(CreateFogModifierRadius(Sentinels[1],FOG_OF_WAR_VISIBLE,GetUnitX(GetAttacker()),GetUnitY(GetAttacker()),128,true,false),1)
		endif
	elseif GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
		if IsUnitFogged(GetAttacker(),Sentinels[1])or IsUnitFogged(GetAttacker(),Scourges[1])then
			call A28(CreateFogModifierRadius(Scourges[1],FOG_OF_WAR_VISIBLE,GetUnitX(GetAttacker()),GetUnitY(GetAttacker()),128,true,false),1)
		endif
	endif
	return false
endfunction

function U2D takes nothing returns boolean
	local trigger t
	local group g
	local unit u
	call ExecuteFunc("InitNeutralDots")
	if udg_ObserverMode then
		set t=CreateTrigger()
		call TriggerRegisterPlayerUnitEvent(t,Sentinels[0],EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER,Condition(function ReturnTrue))
		call TriggerRegisterPlayerUnitEvent(t,Scourges[0],EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER,Condition(function ReturnTrue))
		call TriggerAddCondition(t,Condition(function U0D))
		set t=CreateTrigger()
		set g=GetAvailableGroup()
		call GroupEnumUnitsOfPlayer(g,Sentinels[0],Condition(function ReturnTrue))
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			call GroupRemoveUnit(g,u)
			if GetUnitAcquireRange(u)!=0 then
				call TriggerRegisterUnitInRange(t,u,600,Condition(function ReturnTrue))
			endif
		endloop
		call KillGroup(g)
		set g=GetAvailableGroup()
		call GroupEnumUnitsOfPlayer(g,Scourges[0],Condition(function ReturnTrue))
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			call GroupRemoveUnit(g,u)
			if GetUnitAcquireRange(u)!=0 and IsUnitType(u,UNIT_TYPE_STRUCTURE)then
				call TriggerRegisterUnitInRange(t,u,600,Condition(function ReturnTrue))
			endif
		endloop
		call KillGroup(g)
		call TriggerAddCondition(t,Condition(function ULD))
		set t=CreateTrigger()
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
		call TriggerAddCondition(t,Condition(function U5D))
	endif
	call CleanTrigger(GetTriggeringTrigger())
	set t=null
	set g=null
	set u=null
	return false
endfunction

function V4D takes unit whichUnit returns nothing
	local integer i=0
	loop
		exitwhen(i==16)
		if IsUnitAlly(whichUnit,Player(i))then
			call UnitShareVision(whichUnit,Player(i),true)
		endif
		set i=i+1
	endloop
endfunction

function V7D takes nothing returns nothing
	call V4D(GetEnumUnit())
endfunction

function V8D takes nothing returns nothing
	local integer x
	local group g
	set x=1
	loop
		exitwhen x>5
		call SetPlayerAlliance(Sentinels[0],Sentinels[x],ConvertAllianceType(5),false)
		call SetPlayerAlliance(Scourges[0],Scourges[x],ConvertAllianceType(5),false)
		set x=x+1
	endloop
	set g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,Sentinels[0],Condition(function ReturnTrue))
	call ForGroup(g,function V7D)
	call KillGroup(g)
	set g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,Scourges[0],Condition(function ReturnTrue))
	call ForGroup(g,function V7D)
	call KillGroup(g)
	set g=null
endfunction

function V9D takes nothing returns nothing
	local integer x
	set x=0
	loop
		exitwhen x>5
		call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(0),false)
		call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(1),false)
		call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(2),false)
		call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(3),false)
		call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(4),false)
		call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(5),false)
		call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(6),false)
		call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(7),false)
		call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(0),false)
		call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(1),false)
		call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(2),false)
		call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(3),false)
		call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(4),false)
		call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(5),false)
		call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(6),false)
		call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(7),false)
		
		call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(0),false)
		call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(1),false)
		call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(2),false)
		call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(3),false)
		call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(4),false)
		call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(5),false)
		call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(6),false)
		call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(7),false)
		call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(0),false)
		call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(1),false)
		call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(2),false)
		call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(3),false)
		call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(4),false)
		call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(5),false)
		call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(6),false)
		call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(7),false)
		set x=x+1
	endloop
endfunction

function VDD takes nothing returns boolean
	return IsCreep(GetTriggerUnit())
endfunction

function VED takes nothing returns nothing
	call V4D(GetTriggerUnit())
endfunction

function VFD takes nothing returns nothing
	local trigger t
	if not udg_ObserverMode then
		return
	endif
	call V8D()
	call V9D()
	set t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddCondition(t,Condition(function VDD))
	call TriggerAddAction(t,function VED)
	set t=null
endfunction

function LOLWTF_OHGODWHAT takes nothing returns boolean
	local integer PlayerId=1
	local integer i
	local unit Hero
	local integer MorphID1
	local integer MorphID2
	loop
		exitwhen PlayerId>11
		set Hero=udg_Hero[PlayerId]
		if Hero!=null and IsDead(Hero)==false and GetUnitTypeId(Hero)==HeroTypeId[PlayerId] and IsHexed(Hero)==false then
			loop
				set i=GetRandomInt(1,108)
				exitwhen (IsUnitIdType(HeroID[i],UNIT_TYPE_MELEE_ATTACKER) and IsUnitIdType(HeroTypeId[PlayerId],UNIT_TYPE_MELEE_ATTACKER)) or (IsUnitIdType(HeroID[i],UNIT_TYPE_RANGED_ATTACKER) and IsUnitIdType(HeroTypeId[PlayerId],UNIT_TYPE_RANGED_ATTACKER))
			endloop
			call SaveInteger(HY,GetHandleId(LoadTriggerHandle(HY,GetHandleId(Hero),'0PAS')),100,1)
			call TriggerEvaluate(LoadTriggerHandle(HY,GetHandleId(Hero),'0PAS'))  //FORCE DISABLE PASSIVES WHEN MORPHING
			set MorphID1=GetMorphId(HeroTypeId[PlayerId])
			set MorphID2=GetMorphId(HeroID[i])
			call UnitAddAbility(Hero,MorphID1)
			call UnitRemoveAbility(Hero,MorphID1)
			call UnitAddAbility(Hero,MorphID2+1)
			call UnitRemoveAbility(Hero,MorphID2+1)
			set HeroTypeId[PlayerId]=HeroID[i]
		endif
		set PlayerId=PlayerId+1
	endloop
	set Hero=null
	return false
endfunction

function RemoveAntihack2 takes nothing returns nothing
	call UnitRemoveAbility(GetEnumUnit(),'A44F')
endfunction

function RemoveAntihack takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,0,0,18000,Condition(function ReturnTrue))
	call ForGroup(g,function RemoveAntihack2)
	call KillGroup(g)
	set g=null
endfunction

function TESTMYFAITH takes nothing returns nothing
	if bj_isSinglePlayer then
		call SetPlayerAlliance(Player(0),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(1),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(2),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(3),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(4),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(5),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(6),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(7),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(8),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(9),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(10),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(11),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(12),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(13),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(14),Player(1),ConvertAllianceType(6),true)
		call SetPlayerAlliance(Player(15),Player(1),ConvertAllianceType(6),true)
		call RemoveAntihack()
		call ClearTextMessages()
	endif
endfunction
//
//function FogClickSaver takes nothing returns nothing
//	local integer i=1
//	local player p=Sentinels[0]
//	loop
//		if i>5 then
//			set p=Scourges[0]
//		endif
//		if IsUnitVisibleLoD(udg_Hero[i],p) then
//			if 
//			call SaveReal(HeroStats,GetHandleId(udg_Hero[i]),106,TimerGetElapsed(GlobalTimer))
//		endif
//		set i=i+1
//		exitwhen i>11
//	endloop
//	
//endfunction

function ShowSkillsOnSelecting takes nothing returns nothing
	local player p=GetTriggerPlayer()
	local player t=GetOwningPlayer(GetTriggerUnit())
	local integer i
	if p!=t and ShowSkills[GetPlayerId(p)] and GetTriggerUnit()==udg_Hero[GetPlayerId(t)] and IsPlayerAlly(p,t) then
		set i=PlayerSkillNumber[GetPlayerId(t)*PlayerSkillOffset]
		call DisplayTimedTextToPlayer(p,0,0,10,"|c00a0a0f8"+GetObjectName(SkillID[i+1])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),1))+"|r")
		call DisplayTimedTextToPlayer(p,0,0,10,"|c00a0a0f8"+GetObjectName(SkillID[i+2])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),2))+"|r")
		call DisplayTimedTextToPlayer(p,0,0,10,"|c00a0a0f8"+GetObjectName(SkillID[i+3])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),3))+"|r")
		call DisplayTimedTextToPlayer(p,0,0,10,"|c00ff54f2"+GetObjectName(SkillID[i+4])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),4))+"|r")
		if NumberOfExtraAbilities>0 then
			call DisplayTimedTextToPlayer(p,0,0,10,"|c00a0a0f8"+GetObjectName(SkillID[i+5])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),5))+"|r")
			if(SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]]>0)then
				call DisplayTimedTextToPlayer(p,0,0,10,"|c00ff54f2"+GetObjectName(SkillID[i+6])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),6))+"|r")
			endif
		endif
	endif
	if GetUnitTypeId(GetTriggerUnit())!='hfoo' and IsUnitEnemy(GetTriggerUnit(),p) and IsUnitVisibleLoD(GetTriggerUnit(),p)==false then//hfoo ->  
		if GetObjectName('TEST')=="L1ch" then//TEST -> L1ch2
			call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,10,"|c00ff0303Possible MH click by|r "+udg_Colors[GetPlayerId(p)]+PlayerNames[GetPlayerId(p)]+"|r on "+GetUnitName(GetTriggerUnit()))
		endif
	endif
	
endfunction

function OwnerChanging takes nothing returns nothing
	//call echo("change from "+GetPlayerName(GetChangingUnitPrevOwner())+" by "+GetUnitName(GetChangingUnit()))
	call UnitRemoveAbility(GetChangingUnit(),'A44F')
endfunction

function HelpPlayerIfNotReady takes nothing returns nothing
	local integer i
	local integer aid
	local integer rnd
	local player p
	local integer k=1
	local integer te=0
	
	loop
		set p=Player(k)
		set i=k
		if b_isPlayerReady[i]==false and GetPlayerController(p)==MAP_CONTROL_USER and GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING then
		loop
			exitwhen b_isPlayerReady[i]
			if s_MainMode=="sd" or s_MainMode=="md" then
				loop
					set rnd=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
					exitwhen(b_HeroAvailableForPlayer[i*NumberOfHeroes+rnd] and IsHeroIngame[rnd]==false) 
				endloop
				set aid=(rnd*4)-4
				set aid=aid+GetRandomInt(1,4)
				call SaveInteger(HY,'0REA','0PID',i)
				call SaveInteger(HY,'0REA','0SID',aid)
				call SaveBoolean(HY,'0REA','000B',false)
				call ExecuteFunc("BUD")
			else
				loop
					set aid=(GetRandomInt(1,NumberOfHeroes*4))
					set te=AdjustHeroNumber((aid+3)/4)
					exitwhen IsHeroIngame[te]==false// and GetPlayerTechMaxAllowed(GetTriggerPlayer(),HeroID[te])>0
				endloop
				//set aid=GetRandomInt(1,NumberOfHeroes*4)
				call SaveInteger(HY,'0REA','0PID',i)
				call SaveInteger(HY,'0REA','0SID',aid)
				call SaveBoolean(HY,'0REA','000B',false)
				call ExecuteFunc("BUD")
			endif
		endloop
		endif
		set k=k+1
		if k==6 then
			set k=7
		endif
		exitwhen k>11
	endloop

	call ExecuteFunc("BMD")
endfunction

function AddSkillForGroup takes nothing returns nothing
	call UnitAddAbility2(GetEnumUnit(),TempInteger)
	if TempReal==1.0 then
		call SetPlayerAbilityAvailable(GetOwningPlayer(GetEnumUnit()),TempInteger,false)
		set TempReal=.0
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),TempInteger)==0 then
		call AddUnitToStock(GetEnumUnit(),TempInteger,1,1)
		call echo(Id2String(TempInteger)+" ("+GetObjectName(TempInteger)+") added")
	endif
endfunction

function AddSkillFn takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),4,99999)
	local group g
	if bj_isSinglePlayer then
		set TempInteger=String2Id(said)
		set TempReal=.0
		call TechHeroForAll(TempInteger)
		if SubString(said,0,2)=="QU" then
			set TempReal=1.0
		endif
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
		call ForGroup(g,function AddSkillForGroup)
		call KillGroup(g)
	endif
	set g=null
endfunction

function RSkillForGroup takes nothing returns nothing
	call UnitRemoveAbility(GetEnumUnit(),TempInteger)
endfunction

function RSkillFn takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),4,99999)
	local group g
	if bj_isSinglePlayer then
	set TempInteger=String2Id(said)
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	if FirstOfGroup(g)==null then
		call GroupAddUnit(g,udg_Hero[GetPlayerId(GetTriggerPlayer())])
	endif
	call ForGroup(g,function RSkillForGroup)
	call KillGroup(g)
	endif
	set g=null
endfunction

function GSkillForGroup takes nothing returns nothing
	call BJDebugMsg(GetObjectName(GetUnitTypeId(GetEnumUnit()))+"'s lvl of "+Id2String(TempInteger)+" is "+I2S(GetUnitAbilityLevel(GetEnumUnit(),TempInteger)))
endfunction

function GSkillFn takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),4,99999)
	local group g
	if bj_isSinglePlayer then
	set TempInteger=String2Id(said)
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call ForGroup(g,function GSkillForGroup)
	call KillGroup(g)
	endif
	set g=null
endfunction

function HSkillForGroup takes nothing returns nothing
	call SetPlayerAbilityAvailable(GetOwningPlayer(GetEnumUnit()),TempInteger,false)
endfunction

function HSkillFn takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),4,99999)
	local group g
	if bj_isSinglePlayer then
		set TempInteger=String2Id(said)
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
		call ForGroup(g,function HSkillForGroup)
		call KillGroup(g)
	endif
	set g=null
endfunction

function AddItemDebugForGroup takes nothing returns nothing
	local item it=UnitAddItemById(GetEnumUnit(),TempInteger)
	call SetItemPlayer(it,GetOwningPlayer(GetEnumUnit()),false)
	set it=null
endfunction

function AddItemDebug takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),4,99999)
	local group g
	if bj_isSinglePlayer then
	set TempInteger=String2Id(said)
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call ForGroup(g,function AddItemDebugForGroup)
	call KillGroup(g)
	endif
	set g=null
endfunction

function OUnitForGroup takes nothing returns nothing
	call SetUnitOwner(GetEnumUnit(),Player(TempInteger),true)
	if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)then
		set udg_Hero[TempInteger]=GetEnumUnit()
	endif
endfunction

function OUnitFn takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),3,5)
	local group g
	if bj_isSinglePlayer then
		set TempInteger=S2I(said)
		if TempInteger<0 or TempInteger>15 then
			return
		endif
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
		call ForGroup(g,function OUnitForGroup)
		call KillGroup(g)
	endif
	set g=null
endfunction

//function HidePassivesOnLearn takes nothing returns nothing
//	call HidePassivesFunction(GetOwningPlayer(TEMPUNIT))
//endfunction

function HidePassivesFunctionInit takes nothing returns nothing
//	local unit u=udg_Hero[GetPlayerId(GetTriggerPlayer())]
//	if u!=null and IsDead(u)==false and b_isPickTime==false  then//and Z3
	call HidePassivesFunction(GetTriggerPlayer(),false)
//	else
//		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,TxtDur[GetPlayerId(GetLocalPlayer())],"You cant use this command for a while")
//	endif
//	set u=null
endfunction

function DebugRemoveBuggedItem takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),18,19)
	local integer i=S2I(said)
	if i>0 and i<7 then
		if UnitItemInSlot(udg_Hero[GetPlayerId(GetTriggerPlayer())],i-1)!=null and GetIndex(UnitItemInSlot(udg_Hero[GetPlayerId(GetTriggerPlayer())],i-1))<0 then
			call UnitRemoveItemFromSlot(udg_Hero[GetPlayerId(GetTriggerPlayer())],i-1)
		else
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"This item isnt considered as bugged")
		endif
	endif
	
endfunction

function SetmsForGroup takes nothing returns nothing
	call SetUnitMoveSpeed(GetEnumUnit(),(TempReal))
endfunction


function setmsfunc takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),7,999)
	local group g
	if bj_isSinglePlayer then
	set TempReal=S2R(said)
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call ForGroup(g,function SetmsForGroup)
	call KillGroup(g)
	endif
	set g=null
	
endfunction


function ispawnableitemForGroup takes nothing returns nothing
	if IsItemPawnable(UnitItemInSlot(GetEnumUnit(),TempInteger)) then
		call BJDebugMsg("pawn")
	else
		call BJDebugMsg("unpawn")
	endif
endfunction

function ispawnableitem takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),4,999)
	local group g
	if bj_isSinglePlayer then
	set TempInteger=S2I(said)
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call ForGroup(g,function ispawnableitemForGroup)
	call KillGroup(g)
	endif
	set g=null
endfunction

function AddTypeForGroup takes nothing returns nothing
	call UnitAddType(GetEnumUnit(),ConvertUnitType(TempInteger))
	if IsUnitType(GetEnumUnit(),ConvertUnitType(TempInteger)) then
		call BJDebugMsg("added")
	endif
endfunction

function AddTypeDebug takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),4,999)
	local group g
	if bj_isSinglePlayer then
	set TempInteger=S2I(said)
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call ForGroup(g,function AddTypeForGroup)
	call KillGroup(g)
	endif
	set g=null
endfunction

function SetAnimFn takes nothing returns nothing
	local string s=SubString(GetEventPlayerChatString(),6,999)
	local group g
	local integer i=S2I(s)
	local boolean b=false
	local unit u
	if I2S(i)!=s then
		set b=true//string
	endif
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if b then
			call SetUnitAnimation(u,s)
		else
			call SetUnitAnimationByIndex(u,i)
		endif
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
	set g=null
endfunction

function SetHPFnForGroup takes nothing returns nothing
	call SetWidgetLife(GetEnumUnit(),TempInteger)
endfunction

function SetHPFn takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),4,999)
	local group g
	local integer i=S2I(said)
	if bj_isSinglePlayer then
		set TempInteger=S2I(said)
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
		call ForGroup(g,function SetHPFnForGroup)
		call KillGroup(g)
	endif
	set g=null
endfunction

function GetHPFnForGroup takes nothing returns nothing
	call echo(R2S(GetWidgetLife(GetEnumUnit())))
endfunction

function GetHPFn takes nothing returns nothing
	local group g
	if bj_isSinglePlayer then
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
		call ForGroup(g,function GetHPFnForGroup)
		call KillGroup(g)
	endif
	set g=null
endfunction

function KillFnForGroup takes nothing returns nothing
	call KillUnit(GetEnumUnit())
endfunction

function KillFn takes nothing returns nothing
	local group g
	if bj_isSinglePlayer then
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
		call ForGroup(g,function KillFnForGroup)
		call KillGroup(g)
	endif
	set g=null
endfunction



function SetMPFnForGroup takes nothing returns nothing
	call SetUnitState(GetEnumUnit(),UNIT_STATE_MANA,TempInteger)
endfunction

function SetMPFn takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),4,999)
	local group g
	local integer i=S2I(said)
	if bj_isSinglePlayer then
		set TempInteger=S2I(said)
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
		call ForGroup(g,function SetMPFnForGroup)
		call KillGroup(g)
	endif
	set g=null
endfunction

function AddRuneFnForGroup takes nothing returns nothing
	call CreateItem(TempInteger,GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()))
endfunction

function AddRuneFn takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),4,9)
	local group g
	local integer i=S2I(said)
	if bj_isSinglePlayer then
		set TempInteger=String2Id(said)
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
		call ForGroup(g,function AddRuneFnForGroup)
		call KillGroup(g)
	endif
	set g=null
endfunction

function GetXYofUnitForGroup takes nothing returns nothing
	call BJDebugMsg(R2S(GetUnitX(GetEnumUnit()))+" "+R2S(GetUnitY(GetEnumUnit())))
endfunction

function GetXYofUnit takes nothing returns nothing
	local group g
	if bj_isSinglePlayer then
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
		call ForGroup(g,function GetXYofUnitForGroup)
		call KillGroup(g)
	endif
	set g=null
endfunction

function ChangeCamDistance takes nothing returns nothing
	local real r=S2R(SubString(GetEventPlayerChatString(),5,15))
	call SetCameraFieldForPlayer(GetTriggerPlayer(),CAMERA_FIELD_FARZ,100000000,0)
	if r<=0 then
		call SetCameraFieldForPlayer(GetTriggerPlayer(),CAMERA_FIELD_TARGET_DISTANCE,1650,0)
		call SaveReal(HeroStats,GetHandleId(GetTriggerPlayer()),'CAMD',1650)
		call Error(GetTriggerPlayer(),"Incorrect multiplier, camera changed to default.")
	elseif r>0 and r<3 then
		call SetCameraFieldForPlayer(GetTriggerPlayer(),CAMERA_FIELD_TARGET_DISTANCE,1650*r,0)
		call SaveReal(HeroStats,GetHandleId(GetTriggerPlayer()),'CAMD',1650*r)
		//call Error(GetTriggerPlayer(),"Incorrect multiplier, camera changed to 3x distance.")
	elseif r>=600 and r<=4500 then
		call SetCameraFieldForPlayer(GetTriggerPlayer(),CAMERA_FIELD_TARGET_DISTANCE,r,0)
		call SaveReal(HeroStats,GetHandleId(GetTriggerPlayer()),'CAMD',r)
	else 
		call Error(GetTriggerPlayer(),"Incorrect camera distance.")
	endif
	
endfunction


function RemoveUnitFnForGroup takes nothing returns nothing
	call RemoveUnit(GetEnumUnit())
endfunction

function RemoveUnitFn takes nothing returns nothing
	local group g
	if bj_isSinglePlayer then
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
		call ForGroup(g,function RemoveUnitFnForGroup)
		call KillGroup(g)
	endif
	set g=null
endfunction

function RGCFFSendStats takes nothing returns nothing
	local integer i=1
	local integer k=5
	local integer votes=0
	local integer pid=GetPlayerId(GetTriggerPlayer())
	
	if RGCFFed[pid]==false then
		if pid>6 then
			set k=11
			set i=7
		endif
		loop
			if RGCFFed[i] then
				set votes=votes+1
			endif
			set i=i+1
			exitwhen i>k
		endloop
		if votes==4 then
			call RMD_SendStats()
			if pid<7 then
				call KillUnit(TreeOfLife)
			else
				call KillUnit(FrozenThrone)
			endif
		endif
		set RGCFFed[pid]=true
	endif
endfunction

function RemoveMorphIconFn takes nothing returns nothing
	local integer pid=GetPlayerId(GetTriggerPlayer())
	local unit u=udg_Hero[pid]
	if(u!=null and IsDead(u)==false)then
		if GetUnitAbilityLevel(u,'A0KW')>0 then//A0KW -> Morph
			call SetPlayerAbilityAvailable(Player(pid),'A0KW',HideMorphIcon[pid])//A0KW -> Morph
			call SetPlayerAbilityAvailable(Player(pid),'A0KX',HideMorphIcon[pid])//A0KX -> Morph
			set HideMorphIcon[pid]=not HideMorphIcon[pid]
		else
			call Error(GetTriggerPlayer(),"No Morph")
		endif
	else
		call Error(GetTriggerPlayer(),"No hero")
	endif
	set u=null
endfunction

function AltHUD takes nothing returns nothing
	local player p=GetTriggerPlayer()
	local integer i=1
	if IsScourge(p) then
		set i=7
	endif
	call SetPlayerAlliance(Player(i+0),p,ALLIANCE_SHARED_ADVANCED_CONTROL,not GetPlayerAlliance(Player(i+0),p,ALLIANCE_SHARED_ADVANCED_CONTROL))
	call SetPlayerAlliance(Player(i+1),p,ALLIANCE_SHARED_ADVANCED_CONTROL,not GetPlayerAlliance(Player(i+1),p,ALLIANCE_SHARED_ADVANCED_CONTROL))
	call SetPlayerAlliance(Player(i+2),p,ALLIANCE_SHARED_ADVANCED_CONTROL,not GetPlayerAlliance(Player(i+2),p,ALLIANCE_SHARED_ADVANCED_CONTROL))
	call SetPlayerAlliance(Player(i+3),p,ALLIANCE_SHARED_ADVANCED_CONTROL,not GetPlayerAlliance(Player(i+3),p,ALLIANCE_SHARED_ADVANCED_CONTROL))
	call SetPlayerAlliance(Player(i+4),p,ALLIANCE_SHARED_ADVANCED_CONTROL,not GetPlayerAlliance(Player(i+4),p,ALLIANCE_SHARED_ADVANCED_CONTROL))
	
endfunction

function CMDShowMyNetworth takes nothing returns nothing
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"Your Networth is "+I2S(NetWorths[GetPlayerId(GetTriggerPlayer())]))
endfunction

function ToggleStatusWindow takes nothing returns nothing
	local boolean b=LoadBoolean(HeroStats,GetHandleId(GetTriggerPlayer()),'UIds')
	if b then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"|c00aeae00Status window enabled|r")
	else
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"|c00fcfa00Status window disabled|r")
	endif
	call SaveBoolean(HeroStats,GetHandleId(GetTriggerPlayer()),'UIds',not b)
endfunction

function FastClear takes nothing returns nothing
	local player p=GetTriggerPlayer()
	local integer pid=GetPlayerId(p)
	if TxtDur[pid]==1. then
		call DisplayTimedTextToPlayer(p,0,0,3,"|c00aeae00 Fast Clear disabled|r - all death messages lasts 10 seconds.")
		set TxtDur[pid]=10.
	else
		call DisplayTimedTextToPlayer(p,0,0,3,"|c00fcfa00 Fast Clear enabled|r - all death messages lasts 3 seconds.")
		set TxtDur[pid]=1.
	endif
endfunction

function NoSameHotkeyCmd takes nothing returns nothing
	call SaveBoolean(HeroStats,GetHandleId(GetTriggerPlayer()),'NSHK',true)
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"|c00aeae00 No same hotkey|r option disabled - you can get any possible ability, regardless hotkey")
endfunction

function getunitidFn takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local integer i=0
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	set u=FirstOfGroup(g)
	loop
		exitwhen u==null
		call echo(Id2String(GetUnitTypeId(u)))
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
	call KillGroup(g)
	set g=null
endfunction

function ToggleChargesDisplay takes nothing returns nothing
	local boolean b=LoadBoolean(HeroStats,GetHandleId(GetTriggerPlayer()),'OptC')
	call SaveBoolean(HeroStats,GetHandleId(GetTriggerPlayer()),'OptC',not b)
	if b then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"|c00aeae00 Charges display|r disabled")
	else
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"|c00aeae00 Charges display|r enabled")
	endif
endfunction

function CMDShakingToggle takes nothing returns nothing
	local integer pid=GetPlayerId(GetTriggerPlayer())
	set ShakingOn[pid]=ShakingOn[pid]==false
	if ShakingOn[pid] then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"Camera shaking turned |c0000FF00ON|r")
	else
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"Camera shaking turned |c00FF0000OFF|r")
	endif
endfunction

function OldRunePickupStyle takes nothing returns nothing
	local integer pid=GetPlayerId(GetTriggerPlayer())
	set BottlePickupRunesOldfashion[pid]=BottlePickupRunesOldfashion[pid]==false
	if BottlePickupRunesOldfashion[pid] then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"|cffff0000Runes|r |c00FF0000won't|r go into bottle on right click")
	else
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"|cffff0000Runes|r now |c0000FF00will|r go into bottle on right click")
	endif
endfunction

function ToggleSkillShowing takes nothing returns nothing
	local player p=GetTriggerPlayer()
	local integer pid=GetPlayerId(p)
	if ShowSkills[pid] then
		call DisplayTimedTextToPlayer(p,0,0,5,"|cffff0000Show Skill|r turned |c00FF0000OFF|r")
	else
		call DisplayTimedTextToPlayer(p,0,0,5,"|cffff0000Show Skill|r turned |c0000FF00ON|r")
	endif
	set ShowSkills[pid]=not ShowSkills[pid]
endfunction

function ToggleSDD takes nothing returns nothing
	if GetEventPlayerChatString()=="-sddon" then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),.0,.0,10.,"|cffff0000[SDD] |r"+"|c006699CC"+"System Display Damage |c0000FF00ON|r"+"|c006699CC"+"."+"|r")
		set b_isDamageShowed[GetPlayerId(GetTriggerPlayer())]=true
	else
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),.0,.0,10.,"|cffff0000[SDD] |r"+"|c006699CC"+"System Display Damage |c00FF0000OFF|r"+"|c006699CC"+"."+"|r")
		set b_isDamageShowed[GetPlayerId(GetTriggerPlayer())]=false
	endif
endfunction

function Techies_ShowDetonateIcon takes nothing returns nothing
	local integer pid=GetPlayerId(GetTriggerPlayer())
	if GetUnitAbilityLevel(udg_Hero[pid],'A0AK')>0 or GetUnitAbilityLevel(udg_Hero[pid],'A1FY')>0 then//A0AK -> Remote Mines, A1FY -> Remote Mines
		if GetUnitAbilityLevel(udg_Hero[pid],'A1WF')==0 then//A1WF -> Focused Detonate
			call UnitAddAbility2(udg_Hero[pid],'A1WF')//A1WF -> Focused Detonate
		else
			call UnitRemoveAbility(udg_Hero[pid],'A1WF')//A1WF -> Focused Detonate
		endif
	endif
endfunction

function TogglePassiveCooldown takes nothing returns nothing
	local player p=GetTriggerPlayer()
	local boolean CD = LoadBoolean(MHT,GetHandleId(p),4)
	if CD then
		call DisplayTimedTextToPlayer(p,.0,.0,10.,"Turning passive cooldown display |c00FF0000OFF|r")
		call SaveBoolean(MHT,GetHandleId(p),4,false)
	else
		call DisplayTimedTextToPlayer(p,.0,.0,10.,"Turning passive cooldown display |c0000FF00ON|r")
		call SaveBoolean(MHT,GetHandleId(p),4,true)
	endif
endfunction

function ffWrapper takes nothing returns nothing
	if Mode_FF then
		call RN8(GetPlayerId(GetTriggerPlayer()),false)
	endif
endfunction

function whoffWrapper takes nothing returns nothing
	if Mode_FF then
		call RO8(GetTriggerPlayer())
	endif
endfunction

function AddTimeToTimer takes nothing returns nothing
	local integer i=R2I(TimerGetRemaining(NK))
	call TimerStart(NK,i+60,false,function HelpPlayerIfNotReady)
endfunction

function ReadyCMD takes player p returns nothing
	local integer BJD
	local integer SJ8
	local integer i
	local integer te
	if b_isPickTime then
		if TimerGetElapsed(GlobalTimer)>ReadyCooldown[GetPlayerId(p)] then
			if IsHeroesAvailable==false then
				call DisplayTimedTextToPlayer(p,.0,.0,10.,"|cff99ccff"+"You cannot use this command yet."+"|r")
			else
				if b_isPlayerReady[GetPlayerId(p)] then
					call DisplayTimedTextToPlayer(p,.0,.0,10.,"|cff99ccff"+"You have already chosen all your spells."+"|r")
				else
					set ReadyCooldown[GetPlayerId(p)]=TimerGetElapsed(GlobalTimer)+4
					set i=GetPlayerId(p)
					loop
						exitwhen b_isPlayerReady[i]
						if s_MainMode=="sd" or s_MainMode=="md" then
							loop
								set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
								exitwhen(b_HeroAvailableForPlayer[i*NumberOfHeroes+BJD] and IsHeroIngame[BJD]==false) 
							endloop
							set SJ8=(BJD*4)-4
							set SJ8=SJ8+GetRandomInt(1,4)
							call SaveInteger(HY,'0REA','0PID',i)
							call SaveInteger(HY,'0REA','0SID',SJ8)
							call SaveBoolean(HY,'0REA','000B',false)
							call ExecuteFunc("BUD")
						else
							loop
								set SJ8=(GetRandomInt(1,NumberOfHeroes*4))
								set te=AdjustHeroNumber((SJ8+3)/4)
								exitwhen(IsHeroIngame[te]==false and GetPlayerTechMaxAllowed(p,HeroID[te])>0)
							endloop
							call SaveInteger(HY,'0REA','0PID',i)
							call SaveInteger(HY,'0REA','0SID',SJ8)
							call SaveBoolean(HY,'0REA','000B',false)
							call ExecuteFunc("BUD")
						endif
					endloop
					call DisplayTimedTextToPlayer(p,.0,.0,10.,"|cff99ccff"+"You are now ready, your remaining spells have been chosen randomly."+"|r")
					call ExecuteFunc("BMD")
				endif
			endif
		else
			call DisplayTimedTextToPlayer(p,.0,.0,10.,"|cff99ccffYou can't use this command so often. Wait.|r")
		endif
	endif
endfunction

function ReadyCMDWrapper takes nothing returns nothing
	call ReadyCMD(GetTriggerPlayer())
endfunction

function ReadyCMDAltar takes nothing returns nothing
	call ReadyCMD(tt_player1)
endfunction

function LOLWTFWrapper takes nothing returns nothing
	if false then //HERPDERP
		if LOLWTF==false then
			set LOLWTF=true
			set LOLWTF_Trig=CreateTrigger()
			call TriggerRegisterTimerEvent(LOLWTF_Trig,2,true)
			call TriggerAddCondition(LOLWTF_Trig,Condition(function LOLWTF_OHGODWHAT))
		else
			call CleanTrigger(LOLWTF_Trig)
		endif
	endif
endfunction

function RandomHeroWrapper takes nothing returns nothing
	if b_isPickTime==false and s_MainMode!="md" then
		call ExecuteFunc("WWD")
	endif
endfunction

function RepickHeroWrapper takes nothing returns nothing
	if b_isPickTime==false  then
		call ExecuteFunc("WXD")
	endif
endfunction

function RGCFFWrapper takes nothing returns nothing
	if IsGameStartedAnotherBool and IsRGC then
		call ExecuteFunc("RGCFFSendStats")
	endif
endfunction

function SetUnitAbiLvlForGroup takes nothing returns nothing
	call SetUnitAbilityLevel(GetEnumUnit(),TempInteger,tt_int1)
endfunction

function SetUnitAbiLvl takes nothing returns nothing
	local string id=SubString(GetEventPlayerChatString(),4,8)
	local integer lvl=S2I(SubString(GetEventPlayerChatString(),9,11))
	local group g
	set TempInteger=String2Id(id)
	set tt_int1=lvl
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call ForGroup(g,function SetUnitAbiLvlForGroup)
	call KillGroup(g)
	set g=null
endfunction

function AddUnitOnMap takes nothing returns nothing
	local integer id=String2Id(SubString(GetEventPlayerChatString(),4,8))
	if id>0 then
		set tt_bool1=true
		call CreateUnit(Player(4),id,-510,-512,0)
		set tt_bool1=false
	endif
endfunction

function nerfedstunsFnFG takes nothing returns nothing
	call StunTargetLoD(GetEnumUnit(),1)
endfunction

function nerfedstunsFn takes nothing returns nothing
	local group g
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call ForGroup(g,function nerfedstunsFnFG)
	call KillGroup(g)
	set g=null
endfunction

function orderstun takes nothing returns nothing
	//call echo("Bonus: "+I2S(TempInteger)+"; Limit: "+I2S(tt_int1))
	//call CustomSpeed(GetEnumUnit(),TempInteger,tt_int1)
	call SetHeroAgi(GetEnumUnit(),123,false)
endfunction

function wannacheckpriceFn takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),7,10)
	local integer i=S2I(said)
	local string said2=SubString(GetEventPlayerChatString(),11,15)
	local integer i2=S2I(said2)
	local group g
	set TempInteger=i
	set tt_int1=i2
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call ForGroup(g,function orderstun)
	call KillGroup(g)
	set g=null
endfunction

function TargetRefreshFnForGroup takes nothing returns nothing
	call UnitResetCooldown(GetEnumUnit())
	call SetWidgetLife(GetEnumUnit(),99999999)
	call SetUnitState(GetEnumUnit(),UNIT_STATE_MANA,99999999)
	call TimerStart(PrimUltiTimer[GetPlayerId(GetOwningPlayer(GetEnumUnit()))],0,false,null)
	call TimerStart(SecUltiTimer[GetPlayerId(GetOwningPlayer(GetEnumUnit()))],0,false,null)
endfunction

function TargetRefreshFn takes nothing returns nothing
	local group g
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call ForGroup(g,function TargetRefreshFnForGroup)
	call KillGroup(g)
	set g=null
endfunction

function setorderFnFg takes nothing returns nothing
	if IssueTargetOrderById(GetEnumUnit(),TempInteger,GetEnumUnit()) then
		call echo(I2S(TempInteger)+" is target skill")
	elseif IssueImmediateOrderById(GetEnumUnit(),TempInteger) then
		call echo(I2S(TempInteger)+" is immediate skill")
	elseif IssuePointOrderById(GetEnumUnit(),TempInteger,0,0) then
		call echo(I2S(TempInteger)+" is point skill")
	endif
endfunction

function setorderFn takes nothing returns nothing
	local group g
	set TempInteger=S2I(SubString(GetEventPlayerChatString(),4,19))
	call echo("Started "+I2S(TempInteger))
	set g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call ForGroup(g,function setorderFnFg)
	call KillGroup(g)
	set g=null
endfunction

function ASDASD takes nothing returns nothing
	call SelectUnit(udg_Hero[1],false)
endfunction

function TestTimer takes nothing returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.005,true,function ASDASD)
	//call DestroyTimer(t)
endfunction

function revealFn takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local integer i=0
	local integer k
	local real x
	local real y
	local boolean array b
	//call TestTimer()
	//call TimerStart(CreateTimer(),1,true,function ASDASD)
	call GroupEnumUnitsOfPlayer(g,GetTriggerPlayer(),Condition(function ReturnTrue))
	
	call echo(I2S(StringHash("df")))//-107681000
	call CreateUnit(Player(10),'e00E',1388.500000,-5038.250000,0)
	set i=0
	
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
	call KillGroup(g)
	set g=null
endfunction

function testblinkFn takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local integer i=0
	
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	set u=FirstOfGroup(g)
	loop
		exitwhen u==null
		call UnitAddAbility2(u,'A44P')//A44P -> Test Blink
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
	call KillGroup(g)
endfunction

function Func1339 takes string s returns nothing
	local string sr=""
	local string sg=""
	local string sb=""
	local string sa=""
	local integer i=0
	local integer k=StringLength(s)
	local integer numb=1
	loop
		if SubString(s,i,i+1)==" "then
			set numb=numb+1
		else
			if numb==1 then
				set sr=sr+SubString(s,i,i+1)
			elseif numb==2 then
				set sg=sg+SubString(s,i,i+1)
			elseif numb==3 then
				set sb=sb+SubString(s,i,i+1)
			else
				set sa=sa+SubString(s,i,i+1)
			endif
		endif
		set i=i+1
		exitwhen i>k
	endloop
	set group_temp_integer[0]=S2I(sr)
	set group_temp_integer[1]=S2I(sg)
	set group_temp_integer[2]=S2I(sb)
	set tt_int1=S2I(sa)
endfunction

function settintFn takes nothing returns nothing
	local integer r
	local integer g
	local integer b
	local integer a
	local string s=SubString(GetEventPlayerChatString(),7,StringLength(GetEventPlayerChatString()))
	local unit u
	local group gg=GetAvailableGroup()
	
	call Func1339(s)
	set r=group_temp_integer[0]
	set g=group_temp_integer[1]
	set b=group_temp_integer[2]
	set a=tt_int1
	call GroupEnumUnitsSelected(gg,GetTriggerPlayer(),null)
	loop
		set u=FirstOfGroup(gg)
		exitwhen u==null
		call SetUnitVertexColor(u,r,g,b,a)
		call GroupRemoveUnit(gg,u)
	endloop
	call KillGroup(gg)
endfunction


function SubStringTillSpace takes string s returns string
	local integer i=0
	local integer k=StringLength(s)
	local string ss=""
	local string s3
	loop
		set s3=SubString(s,i,i+1)
		if s3!=" " then
			set ss=ss+s3
		else
			return ss
		endif
		set i=i+1
		exitwhen i+1>k
	endloop
	return ss
endfunction

function testeffectsPointFn takes nothing returns nothing
	local string path=SubString(GetEventPlayerChatString(),4,99)
	local group g=GetAvailableGroup()
	local unit u
	call echo("PATH: ["+path+"]")
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	set u=FirstOfGroup(g)
	loop
		exitwhen u==null
		call AddSpecialEffect(path,GetUnitX(u),GetUnitY(u))
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
	call KillGroup(g)
endfunction

function testeffectsTargetFn takes nothing returns nothing
	local string s=SubString(GetEventPlayerChatString(),4,99)
	local string attach=SubStringTillSpace(s)
	local string path=SubString(s,StringLength(attach)+1,99)
	local group g=GetAvailableGroup()
	local unit u
	call echo("ATTACH: ["+attach+"]; PATH: ["+path+"]")
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	set u=FirstOfGroup(g)
	loop
		exitwhen u==null
		call AddSpecialEffectTarget(path,u,attach)
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
	call KillGroup(g)
endfunction

function SetXYassistant takes string s returns nothing
	local string String1=""
	local string String2=""
	local integer i=0
	local integer Ebanaya_Peremennaya=StringLength(s)
	local integer k=1
	loop
		exitwhen i>Ebanaya_Peremennaya
		if SubString(s,i,i+1)==" "then
			set k=k+1
		else
			if k==1 then
				set String1=String1+SubString(s,i,i+1)
			else
				set String2=String2+SubString(s,i,i+1)
			endif
		endif
		set i=i+1
	endloop
	set TempReal=S2R(String1)
	set TempReal2=S2R(String2)
endfunction

function setxyFN takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local string s=GetEventPlayerChatString()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	call SetXYassistant(SubString(s,5,999))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if IsUnitType(u,UNIT_TYPE_STRUCTURE)==false then
			call SetUnitX(u,TempReal)
			call SetUnitY(u,TempReal2)
		else
			call SetUnitPosition(u,TempReal,TempReal2)
		endif
		call GroupRemoveUnit(g,u)
		
	endloop
	call KillGroup(g)
endfunction

function PathingOffTest takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call SetUnitPathing(u,false)
		call GroupRemoveUnit(g,u)
		
	endloop
	call KillGroup(g)
	
endfunction

function testBreakFn takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local integer i=0
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	set u=FirstOfGroup(g)
	loop
		exitwhen u==null
		call Break(u,9)
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
	call KillGroup(g)
endfunction

function testPathFnOn takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local integer i=0
	
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	set u=FirstOfGroup(g)
	loop
		exitwhen u==null
		call SetUnitPathing(u,true)
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
	call KillGroup(g)
endfunction

function testPathFnOff takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local integer i=0
	
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	set u=FirstOfGroup(g)
	loop
		exitwhen u==null
		call SetUnitPathing(u,false)
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
	call KillGroup(g)
endfunction

function addsoulsSF takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local integer i=0
	local integer k=0
	local string s=SubString(GetEventPlayerChatString(),7,StringLength(GetEventPlayerChatString()))
	set i=IMinIF(S2I(s),36)
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	set u=FirstOfGroup(g)
	if i>0 then
		loop
			exitwhen u==null
			set k=0
			loop
				exitwhen k==i
				set k=k+1
				call AddProjectile(CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u)+GetRandomReal(50,300)*Cos(GetRandomReal(0,6.14)),GetUnitY(u)+GetRandomReal(50,300)*Sin(GetRandomReal(0,6.14)),0),u,'h0CR',"EXG",3000,false)
				
			endloop
			call GroupRemoveUnit(g,u)
			set u=FirstOfGroup(g)
		endloop
	endif
	call KillGroup(g)
endfunction

function isPathableFn takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local integer i=0
	
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	set u=FirstOfGroup(g)
	loop
		exitwhen u==null
		call echo(B2S(IsTerrainPathable(GetUnitX(u),GetUnitY(u),PATHING_TYPE_WALKABILITY)==false))
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
	call KillGroup(g)
endfunction

function setscaleFn takes nothing returns nothing
	local string said=SubString(GetEventPlayerChatString(),7,99999)
	local real size=S2R(said)
	local group g=GetAvailableGroup()
	local unit u
	if size <= 0 then
		set size=1
	endif
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
	set u=FirstOfGroup(g)
	loop
		exitwhen u==null
		call SetUnitScale(u,size,0,0)
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
endfunction

function CheckSPtestCommands takes string s returns nothing
	local boolean AddSkill=SubString(s,0,4)=="-aa "
	local boolean AddUnit=SubString(s,0,4)=="-au "
	local boolean SetAbilLevel=SubString(s,0,4)=="-sa "
	local boolean AddType=SubString(s,0,4)=="-at "
	local boolean RSkill=SubString(s,0,4)=="-ra "
	local boolean TargetRefresh=s=="-r"
	local boolean GSkill=SubString(s,0,4)=="-ga "
	local boolean HSkill=SubString(s,0,4)=="-ha "
	local boolean AItem=SubString(s,0,4)=="-ai "
	local boolean OUnit=SubString(s,0,3)=="-o "
	local boolean testeffects_target=SubString(s,0,4)=="-et "
	local boolean testeffects_point=SubString(s,0,4)=="-ep "
	local boolean setms=SubString(s,0,7)=="-setms "
	local boolean setanim=SubString(s,0,6)=="-anim "
	local boolean sethp=SubString(s,0,4)=="-hp "
	local boolean gethp=s=="-hp"
	local boolean setmp=SubString(s,0,4)=="-mp "
	local boolean addrune=SubString(s,0,4)=="-ar "
	local boolean ispawnable=SubString(s,0,4)=="-ip "
	local boolean nerfedstuns=s=="-nerf"
	local boolean setorder=SubString(s,0,4)=="-or "
	local boolean wannacheckprice=SubString(s,0,7)=="-mytry "
	local boolean reveal=s=="-cc"
	local boolean testblink=s=="-b"
	local boolean control=s=="-control" or s=="-c"
	local boolean gxy=s=="-xy"
	local boolean gi=s=="-gi"
	local boolean setxy=SubString(s,0,5)=="-sxy "
	local boolean settint=SubString(s,0,6)=="-tint "
	local boolean getms=s=="-ms "
	local boolean pathoff=s=="-path"
	local boolean killf=s=="-k"
	local boolean testbreak=s=="-br"
	local boolean testpathingon=s=="-path on"
	local boolean testpathingoff=s=="-path off"
	local boolean ispathable=s=="-path"
	local boolean addsouls=SubString(s,0,7)=="-souls "
	local boolean setscale=SubString(s,0,7)=="-scale "
	local boolean fogcheat=s=="-fog"
	if fogcheat then
		call Cheat("iseedeadpeople")
	endif
	call RunIfTrue("setscaleFn",setscale)
	call RunIfTrue("addsoulsSF",addsouls)
	call RunIfTrue("isPathableFn",ispathable)
	call RunIfTrue("testPathFnOn",testpathingon)
	call RunIfTrue("testPathFnOff",testpathingoff)
	call RunIfTrue("testblinkFn",testblink)
	call RunIfTrue("testBreakFn",testbreak)
	call RunIfTrue("testBreakFn",testbreak)
	call RunIfTrue("PathingOffTest",pathoff)
	call RunIfTrue("W3Ds",getms)
	call RunIfTrue("setxyFN",setxy)
	call RunIfTrue("testeffectsPointFn",testeffects_point)
	call RunIfTrue("testeffectsTargetFn",testeffects_target)
	call RunIfTrue("TESTMYFAITH",control)
	call RunIfTrue("GetXYofUnit",gxy)
	call RunIfTrue("getunitidFn",gi)
	call RunIfTrue("testblinkFn",testblink)
	call RunIfTrue("settintFn",settint)
	call RunIfTrue("revealFn",reveal)
	call RunIfTrue("setorderFn",setorder)
	call RunIfTrue("wannacheckpriceFn",wannacheckprice)
	call RunIfTrue("TargetRefreshFn",TargetRefresh)
	call RunIfTrue("nerfedstunsFn",nerfedstuns)
	call RunIfTrue("AddUnitOnMap",AddUnit)
	call RunIfTrue("SetUnitAbiLvl",SetAbilLevel)
	call RunIfTrue("SetHPFn",sethp)
	call RunIfTrue("GetHPFn",gethp)
	call RunIfTrue("KillFn",killf)
	call RunIfTrue("AddRuneFn",addrune)
	call RunIfTrue("SetMPFn",setmp)
	call RunIfTrue("SetAnimFn",setanim)
	call RunIfTrue("AddTypeDebug",AddType)
	call RunIfTrue("setmsfunc",setms)
	call RunIfTrue("ispawnableitem",ispawnable)
	call RunIfTrue("AddSkillFn",AddSkill)
	call RunIfTrue("RSkillFn",RSkill)
	call RunIfTrue("GSkillFn",GSkill)
	call RunIfTrue("HSkillFn",HSkill)
	call RunIfTrue("OUnitFn",OUnit)
	call RunIfTrue("AddItemDebug",AItem)
endfunction

function SwapItems takes unit u, integer s1, integer s2 returns nothing
	local item it1=null
	local item it2=null
	call DisableTrigger(t_manipulateitem)
	if UnitItemInSlot(u,s2-1)!=null and Bottle_IsIndexRune(GetIndex(UnitItemInSlot(u,s2-1)))==false and GetIndexNoMute(UnitItemInSlot(u,s2-1))==AghanimUpgrader then
		set it2=UnitRemoveItemFromSlot(u,s2-1)
	endif
	if UnitItemInSlot(u,s1-1)!=null and Bottle_IsIndexRune(GetIndex(UnitItemInSlot(u,s1-1)))==false and GetIndexNoMute(UnitItemInSlot(u,s1-1))==AghanimUpgrader then
		set it1=UnitRemoveItemFromSlot(u,s1-1)
	endif
	call EnableTrigger(t_manipulateitem)
	if it1!=null then
		call AddItemInSlot(u,it1,s2-1)
	endif
	if it2!=null then
		call AddItemInSlot(u,it2,s1-1)
	endif
	
	set it1=null
	set it2=null
endfunction

function ItemSwapCmd takes nothing returns nothing
	local string s=SubString(GetEventPlayerChatString(),9,14)
	local integer s1
	local integer s2
	local integer offset=0
	if SubString(s,0,1)==" " then
		set offset=1
	endif
	set s1=S2I(SubString(s,offset,offset+1))
	set s=SubString(s,offset+1,5)
	set offset=0
	if SubString(s,0,1)==" " then
		set offset=1
	endif
	set s2=S2I(SubString(s,offset,offset+1))
	if s1>0 and s1<7 and s2>0 and s2<7 then
		call SwapItems(udg_Hero[GetPlayerId(GetTriggerPlayer())],s1,s2)
	else
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"Incorrect slot numbers. 1-6 allowed.")
	endif
	
endfunction

function VGDadv takes string s returns nothing
	local boolean b_swap=SubString(s,0,5)=="-swap"
	local boolean b_roll=SubString(s,0,5)=="-roll"
	local boolean b_kickafk=SubString(s,0,8)=="-kickafk"
	local boolean b_music=SubString(s,0,6)=="-music"
	local boolean b_water=SubString(s,0,6)=="-water"
	local boolean b_rickroll=SubString(s,0,9)=="-rickroll"
	local boolean b_switch=SubString(s,0,7)=="-switch"
	local boolean removeiteminslot=SubString(s,0,18)=="-removeiteminslot "
	local boolean resone=SubString(s,0,2)=="-r" and (SubString(s,2,3)==" " or S2I(SubString(s,2,3))>0)
	local boolean cam=SubString(s,0,4)=="-cam"
	local boolean itemswap=SubString(s,0,9)=="-itemswap"
	call RunIfTrue("ChangeCamDistance",cam)
	call RunIfTrue("SwapChatCmd",b_swap)
	call RunIfTrue("RollChatCmd",b_roll)
	call RunIfTrue("KickafkChatCmd",b_kickafk)
	call RunIfTrue("ResetSpellsSingle",resone)
	call RunIfTrue("DebugRemoveBuggedItem",removeiteminslot)
	call RunIfTrue("MusicChatCmd",b_music)
	call RunIfTrue("WaterChatCmd",b_water)
	call RunIfTrue("RickrollChatCmd",b_rickroll)
	call RunIfTrue("SwitchChatCmd",b_switch)
	call RunIfTrue("ItemSwapCmd",itemswap)
	if(bj_isSinglePlayer)then
		call CheckSPtestCommands(s)
	endif
endfunction

function VGD takes nothing returns nothing
	local string s=StringCase(GetEventPlayerChatString(),false)
	local integer h=StringHash(s)
	if HaveSavedString(SCMD,h,0) then
		call ExecuteFunc(LoadStr(SCMD,h,0))
		if(s!="-c") then
			return
		endif
	endif
	if(SubString(s,0,1)=="-")then
		call VGDadv(s)
	endif
endfunction

function RickrollChatCmd takes nothing returns nothing
	local integer a=S2I(SubString(GetEventPlayerChatString(),10,StringLength(GetEventPlayerChatString())))
	local integer pid=GetPlayerId(GetTriggerPlayer())
	set RickRollCounter[pid]=RickRollCounter[pid]+1
	if RickRollCounter[pid]>10 then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,TxtDur[GetPlayerId(GetLocalPlayer())],GetObjectName('n0DQ'))//n0DQ -> You have used this too much!
		return
	endif
	if a<1 or a>8 then
		set a=GetRandomInt(1,8)
	endif
	if a==1 then
		call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna give you up")
	elseif a==2 then
		call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna let you down")
	elseif a==3 then
		call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna run around")
	elseif a==4 then
		call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna desert you")
	elseif a==5 then
		call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna make you cry")
	elseif a==6 then
		call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna say goodbye")
	elseif a==7 then
		call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna tell a lie")
	elseif a==8 then
		call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna hurt you")
	endif
endfunction

function Y7D takes nothing returns boolean
	return RandomAllowed and HasUsedRandom[GetPlayerId(tt_player2)]==false and IsHeroesAvailable and udg_Hero[GetPlayerId(tt_player2)]==null and RepickHasBeenUsed[GetPlayerId(tt_player2)]==false and HasAlreadyPickedHero[GetPlayerId(tt_player2)]==false
endfunction


function GetRandomHeroSD takes player p,integer tip returns nothing
	local integer k=0
	local location l
	local integer rnd=0
	local integer i=0
	local boolean melee=tip==1
	local boolean range=tip==2
	local boolean common=tip==0
	set HasUsedRandom[GetPlayerId(p)]=true
	if IsSentinel(p) then
		set l=GetRectCenter(gg_rct_Hero_Creation_NE)
	else
		set l=GetRectCenter(gg_rct_Hero_Creation_UD)
	endif
	loop
		if common then
			set rnd=GetRandomInt(FirstSentinelHeroIndexid,LastScourgeHeroIndexid)
		elseif melee then
			set rnd=GetHeroIndexFromId(MeleeHeroesArray[GetRandomInt(1,MeleeHeroesAmount)])
		elseif range then
			set rnd=GetHeroIndexFromId(RangeHeroesArray[GetRandomInt(1,RangeHeroesAmount)])
		endif
		exitwhen GetPlayerTechMaxAllowed(p,HeroID[rnd])>0 and IsHeroIngame[rnd]==false
		set i=i+1
	endloop
	if Mode_DU==false then
		call VR8(HeroID[rnd])
		set b_isHeroPicked[rnd]=true
		set IsHeroIngame[rnd]=true
	endif
	call CreateUnitAtLoc(p,HeroID[rnd],l,0)
	call RemoveLocation(l)
	set l=null
endfunction

function getFromPlayersPool takes player p, integer tip returns integer
	local boolean melee=tip==1
	local boolean range=tip==2
	local boolean common=tip==0
	local integer i=0
	local integer limit=NumberOfHeroes
	local integer k=0
	loop
		exitwhen i>limit
		if GetPlayerTechMaxAllowed(p,HeroID[i])>0 then
			if melee and IsUnitIdType(HeroID[i],UNIT_TYPE_MELEE_ATTACKER) then
				set k=k+1
			elseif range and IsUnitIdType(HeroID[i],UNIT_TYPE_MELEE_ATTACKER)==false then
				set k=k+1
			elseif common then
				set k=k+1
			endif
		endif
		set i=i+1
	endloop
	return k
endfunction

function Y8D takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local player p=(LoadPlayerHandle(HY,h,54))
	local string Y9D=(LoadStr(HY,h,146))
	set tt_player2=p
	if Y7D()then
		set HasUsedRandom[GetPlayerId(p)]=true
		if Y9D=="-random int"then
			call GetRandomHeroByAttr(p,1)
			call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-150)
		elseif Y9D=="-random str"then
			call GetRandomHeroByAttr(p,3)
			call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-150)
		elseif Y9D=="-random agi"then
			call GetRandomHeroByAttr(p,2)
			call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-150)
		elseif Y9D=="-random melee"then
			call GetRandomHeroByAttack(p,1)
			call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-150)
		elseif Y9D=="-random range"then
			call GetRandomHeroByAttack(p,2)
			call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-150)
		else
			call WT8(p)
			call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-50)
		endif
	else
		call DisplayTimedTextToPlayer(p,0,0,TxtDur[GetPlayerId(GetLocalPlayer())],GetObjectName('n079'))//n079 -> You cannot be assigned a random hero.
	endif
	set t=null
	set p=null
	return false
endfunction

function WWD takes nothing returns nothing
	local player p=GetTriggerPlayer()
	local trigger t
	local string s=StringCase(GetEventPlayerChatString(),false)
	//call echo(s)
	set tt_player2=p
	if Y7D()and G3[GetPlayerId(p)]==false then
		if MeleeOrRangedRestricted[GetPlayerId(p)]==2 and s=="-random melee" then
			call DisplayTimedTextToPlayer(p,0,0,10,"You selected at least one |c00ff0000range only|r skill. You cant use melee units.")
		elseif MeleeOrRangedRestricted[GetPlayerId(p)]==1 and s=="-random range" then
			call DisplayTimedTextToPlayer(p,0,0,10,"You selected at least one |c00ff0000melee only|r skill. You cant use ranged units.")
		elseif s_MainMode=="sd" then
			if s=="-random melee"then
				if getFromPlayersPool(p,1)>0 then
					set G3[GetPlayerId(p)]=true
					call GetRandomHeroSD(p,1)
					call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-100)
					return
				else
					call DisplayTimedTextToPlayer(p,0,0,10,"You have no melee heroes to choose from.")
				endif
			elseif s=="-random range"then
				if getFromPlayersPool(p,2)>0 then
					set G3[GetPlayerId(p)]=true
					call GetRandomHeroSD(p,2)
					call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-100)
					return
				else
					call DisplayTimedTextToPlayer(p,0,0,10,"You have no range heroes to choose from.")
				endif
			elseif s=="-random"then
				set G3[GetPlayerId(p)]=true
				call GetRandomHeroSD(p,0)
				return
			endif
		else
			set G3[GetPlayerId(p)]=true
			call VS8(p)
			if s=="-random melee" then
				call DisplayTimedTextToPlayer(p,0,0,10,"You have been given a random melee hero.")
			elseif s=="-random range" then
				call DisplayTimedTextToPlayer(p,0,0,10,"You have been given a random range hero.")
			else
				call DisplayTimedTextToPlayer(p,0,0,10,GetObjectName('n07A'))//n07A -> You have been given a random hero.
			endif
			set t=CreateTrigger()
			call TriggerRegisterTimerEvent(t,0.1,false)
			call TriggerAddCondition(t,Condition(function Y8D))
			call SavePlayerHandle(HY,GetHandleId(t),54,p)
			call SaveStr(HY,GetHandleId(t),146,StringCase(GetEventPlayerChatString(),false))
		endif
	endif
	set t=null
	set p=null
endfunction

function YDD takes nothing returns boolean
	local unit Hero
	if Mode_NR2 then
		call Error(GetTriggerPlayer(),GetObjectName('n030'))//n030 -> Repicking has been disabled by the host
		return false
	endif
	if RepickAllowed==false then
		if Mode_SD==false and BB7==false and Mode_CD==false then
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"-repick "+GetObjectName('n05B'))//n05B -> is disabled for a few seconds
		endif
		return false
	endif
	if(RepickHasBeenUsed[GetPlayerId(GetTriggerPlayer())]) or (udg_Hero[GetPlayerId(GetTriggerPlayer())]==null)then
		return false
	endif
	if Mode_DM then
		return false
	endif
	if(Z3)then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n050'))//n050 -> Too late to repick
		return false
	endif
	if(GetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD)<MinGoldForRepick) or (GetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD) < 400 and (Mode_AP or Mode_SD) and HasUsedRandom[GetPlayerId(GetTriggerPlayer())]) then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n059'))//n059 -> Not enough gold to repick
		return false
	endif
	if GetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD)<250 and Mode_AP then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n05U'))//n05U -> Not enough gold to repick and buy a new hero
		return false
	endif
	set Hero=udg_Hero[GetPlayerId(GetTriggerPlayer())]
	if GetUnitState(Hero,UNIT_STATE_MANA)!=GetUnitState(Hero,UNIT_STATE_MAX_MANA)or GetWidgetLife(Hero)!=GetUnitState(Hero,UNIT_STATE_MAX_LIFE)then
		set Hero=null
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n05J'))//n05J -> You cannot repick without full hp and mana
		return false
	endif
	set Hero=null
	return true
endfunction

function YED takes nothing returns nothing
	local unit u=GetEnumUnit()
	local integer i=GetUnitTypeId(u)
	if(IsUnitType(u,UNIT_TYPE_HERO))then
		if(GetUnitAbilityLevel(u,'Z234')>0)then//U006 -> Broodmother
			call ExecuteFunc("XJ9")
		elseif GetUnitAbilityLevel(u,'Q231')>0 then//U008 -> Lycanthrope, E015 -> Lycanthrope
			set VK=u
			call ExecuteFunc("YD9")
		elseif GetUnitAbilityLevel(u,'A0CY')>0 then//Ucrl -> Stone Giant
			set VK=u
			call ExecuteFunc("YE9")
		endif
		call DisplayTimedTextToForceEx(S58(GetTriggerPlayer()),10.,GetObjectName('n05L')+" "+UQ8(u)+".")//n05L -> An enemy player has repicked
	endif
	if IsSpiritBear(u) or GetUnitTypeId(u)=='o01X' then
		call RemoveUnit(u)
	endif
	set u=null
endfunction

function HeroAttackTypeRestrictionForPlayer takes player p, integer i returns nothing
	local integer k=1
	local integer h=GetHandleId(p)
	local integer PlayerId=GetPlayerId(p)
	if Mode_SD or Mode_MD then
		set k=1
		loop
			if LoadBoolean(HY,h,HeroID[k]) and b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+k] and IsHeroIngame[k]==false and b_isHeroPicked[k]==false then
				call SetPlayerTechMaxAllowed(p,HeroID[k],999)
			else
				call SetPlayerTechMaxAllowed(p,HeroID[k],0)
			endif
			//call RemoveSavedBoolean(HY,h,HeroID[k])
			set k=k+1
			exitwhen k>NumberOfHeroes
		endloop
	endif
	if i==0 then
		return
	endif
	set k=1
	if i==1 then
		loop
			call SetPlayerTechMaxAllowed(p,RangeHeroesArray[k],0)
			set k=k+1
			exitwhen k>RangeHeroesAmount
		endloop
	elseif i==2 then
		loop
			call SetPlayerTechMaxAllowed(p,MeleeHeroesArray[k],0)
			set k=k+1
			exitwhen k>MeleeHeroesAmount
		endloop
	endif
endfunction

function IsUnitPickingStuff2 takes nothing returns nothing
	if GetUnitTypeId(GetFilterUnit())=='ntav' then
		call UnitAddAbility(GetFilterUnit(),'A1HX')
		call ShowUnit(GetFilterUnit(),true)
	elseif GetUnitTypeId(GetFilterUnit())=='n12C' then
		if GetLocalPlayer()==GetOwningPlayer(GetFilterUnit()) then
			call SetUnitVertexColor(GetFilterUnit(),255,255,255,255)
		endif
	endif
endfunction

function ResetPickTavernsRepick takes player p returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,p,Condition(function IsUnitPickingStuff2))
	call KillGroup(g)
endfunction

function YFD takes nothing returns nothing
	local player p=GetTriggerPlayer()
	local group g=GetAvailableGroup()
	local integer WO8
	local integer WP8
	local location WQ8
	local integer VA8
	local integer VT8
	local integer VU8
	local unit YGD
	local integer PlayerId=GetPlayerId(p)
	local location SpawnSent=GetRectCenter(gg_rct_Allpick_Sent)
	local location SpawnScourge=GetRectCenter(gg_rct_Allpick_Scourge)
	local integer i=0
	set tt_int1=PlayerId
	set bj_groupEnumOwningPlayer=p
	call GroupEnumUnitsInRect(g,GetWorldBounds(),filterGetUnitsInRectOfPlayer)
	if(IsSentinel(p))then
		set WO8=FirstSentinelHeroIndexid
		set WP8=LastSentinelHeroIndexid
		set WQ8=GetRectCenter(G4)
	else
		set WO8=FirstScourgeHeroIndexid
		set WP8=LastScourgeHeroIndexid
		set WQ8=GetRectCenter(F4)
	endif
	if Mode_AR then
		if(GetRandomInt(1,2)==1)then
			set WO8=FirstSentinelHeroIndexid
			set WP8=LastSentinelHeroIndexid
		else
			set WO8=FirstScourgeHeroIndexid
			set WP8=LastScourgeHeroIndexid
		endif
	endif
	if Mode_AP or Mode_SD then
		set MinGoldForRepick=0
	endif
	set YGD=(LoadUnitHandle(HY,(GetHandleId(GetTriggerPlayer())),147))
	if YGD!=null and GetUnitTypeId(YGD)=='e00C' then//e00C -> Self Caster
		call RemoveUnit(YGD)
	endif
	call AdjustPlayerStateBJ(-1*MinGoldForRepick,p,PLAYER_STATE_RESOURCE_GOLD)
	if (Mode_AP or Mode_SD) and HasUsedRandom[GetPlayerId(GetTriggerPlayer())] then
		call AdjustPlayerStateBJ(-150,p,PLAYER_STATE_RESOURCE_GOLD)
	endif
	set RepickHasBeenUsed[PlayerId]=true
	set PlayerHaveHero[PlayerId]=false
	call ForGroup(g,function YED)
	set i=GetUnitPointValueByType(GetUnitTypeId(udg_Hero[PlayerId]))
	set b_isHeroPicked[i]=false
	set IsHeroIngame[i]=false
	set b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+i]=false
	call RemoveHero(udg_Hero[PlayerId])
	set HeroTypeId[PlayerId]=0
	set udg_Hero[GetPlayerId(GetTriggerPlayer())]=null
	if Mode_AP or Mode_SD or Mode_MD then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,60,GetObjectName('n05Y'))//n05Y -> You can now pick a new hero
		if Mode_AP or Mode_SD or Mode_MD then
			set VT8=FirstSentinelHeroIndexid
			set VU8=LastScourgeHeroIndexid
		endif
		call PlacePickDummies(p)
		if IsSentinel(p)then
			call PanCameraToTimedLocForPlayer(p,SpawnSent,0)
		else
			call PanCameraToTimedLocForPlayer(p,SpawnScourge,0)
		endif
		if Mode_SD or Mode_MD then
			call ResetPickTavernsRepick(p)
		endif
		loop
			exitwhen VT8>VU8
			//if VT8!=i then
				if Mode_AP then
					if IsHeroIngame[VT8]==false then
						call SetPlayerTechMaxAllowed(p,HeroID[VT8],999)
					else
						call SetPlayerTechMaxAllowed(p,HeroID[VT8],0)
					endif
				elseif Mode_SD or Mode_MD then
					if b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+VT8] and IsHeroIngame[VT8]==false and b_isHeroPicked[VT8]==false then
						//call echo(GetObjectName(HeroID[VT8])+" is available")
						call SetPlayerTechMaxAllowed(p,HeroID[VT8],999)
					else
						//call echo(GetObjectName(HeroID[VT8])+" NOT AVA")
						call SetPlayerTechMaxAllowed(p,HeroID[VT8],0)
					endif
				endif
			//endif
			set VT8=VT8+1
		endloop
		call HeroAttackTypeRestrictionForPlayer(Player(PlayerId),MeleeOrRangedRestricted[PlayerId])
		call RemoveLocation(SpawnSent)
		call RemoveLocation(SpawnScourge)
		return
	endif
	loop
		set VA8=GetRandomInt(WO8,WP8)
		if(IsHeroIngame[VA8]==false)then
			set b_isHeroPicked[VA8]=true
			set IsHeroIngame[VA8]=true
			set udg_Hero[PlayerId]=CreateUnitAtLoc(p,HeroID[VA8],WQ8,bj_UNIT_FACING)
			set HeroTypeId[PlayerId]=HeroID[VA8]
			call TechHeroForAll(HeroID[VA8])
		endif
		exitwhen udg_Hero[PlayerId]!=null
	endloop
	call KillGroup(g)
	call RemoveLocation(WQ8)
	call RemoveLocation(SpawnSent)
	call RemoveLocation(SpawnScourge)
	set YGD=null
	set WQ8=null
	set SpawnSent=null
	set SpawnScourge=null
endfunction

function WXD takes nothing returns nothing
	if YDD()then
		call YFD()
	endif
endfunction

function WYD takes nothing returns nothing
	local player p=GetTriggerPlayer()
	local string color="|c006699CC"
	if Mode_DM then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Death Match"+"|r:		"+GetObjectName('n06Z'))//n06Z -> When you die, you must pick a new hero.
		call DisplayTimedTextToPlayer(p,0,0,20,"							  "+GetObjectName('n06Y')+" "+I2S(IMinIF(LastSentinelHeroIndexid,LastScourgeHeroIndexid-FirstScourgeHeroIndexid+1))+" "+GetObjectName('n07C'))//n06Y -> You will lose when your team uses up all, n07C -> heroes.
	endif
	if Mode_RD then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Random Draft|r:				 You may choose a hero from 24 choices which all have random skill sets")
	endif
	if Mode_MD then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Mirror Draft|r:				 You may pick a hero and abilities from 11 options which are mirrored to your opponent (Player 1 to 6, 2 to 7, etc)")
	endif
	if Mode_AP then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"All Pick"+"|r:				 "+GetObjectName('n06V'))//n06V -> You may pick a hero from any tavern.
	endif
	if Mode_SO then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Switch On"+"|r:				 "+"Allows players to switch teams via the -switch command. Unlock leaver items with -unlock.")
	endif
	if BB7 then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Random Draft"+"|r:				 "+GetObjectName('n072'))//n072 -> You may pick a hero draft style from the heroes available.
	endif
	if Mode_SD then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Single Draft"+"|r:				 You may pick a hero and abilities from 11 options")
	endif
	if Mode_RC then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Rearm combos"+"|r:				 You may pick Rearm with any spell you ever want")
	endif
	if Mode_AR then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"All Random"+"|r:		  "+GetObjectName('n071'))//n071 -> You have been given a random hero.
	endif
	if Mode_SP then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Shuffle Players"+"|r:	 "+GetObjectName('n07H'))//n07H -> All players will be shuffled across both sides.
	endif
	if Mode_AA then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"All Agility"+"|r:			 "+GetObjectName('n07L'))//n07L -> Only Agility heroes will be allowed.
	endif
	if Mode_AS then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"All Strength"+"|r:		 "+GetObjectName('n07K'))//n07K -> Only Strength heroes will be allowed.
	endif
	if Mode_AI then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"All Intelligence"+"|r:	"+GetObjectName('n07J'))//n07J -> Only Intelligence heroes will be allowed.
	endif
	if Mode_RO then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Range Only"+"|r:	"+GetObjectName('n0G4'))//n0G4 -> Only range heroes are available
	endif
	if Mode_MO then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Melee Only"+"|r:	"+GetObjectName('n0G5'))//n0G5 -> Only melee heroes are available
	endif
	if Mode_DU then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Duplicate Mode"+"|r:   "+GetObjectName('n07I'))//n07I -> The same heroes may be picked or randomed multiple times.
	endif
	if Mode_ID then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Item Drop"+"|r:			 "+GetObjectName('n07F'))//n07F -> When you die, a random inventory slot will drop an item.
	endif
	if Mode_NP then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"No Powerups"+"|r:		"+GetObjectName('n07M'))//n07M -> Powerups are disabled.
	endif
	if Mode_MA then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Mass Aghanims"+"|r:		"+"Allows both ultimates in -S6 mode to benefit from Aghanim's Scepter even outside of -BO")
	endif
	if Mode_SC then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Super Creeps"+"|r:		"+GetObjectName('n07N'))//n07N -> Siege Golems, Scary Fish, and Ancient Hydras
		call DisplayTimedTextToPlayer(p,0,0,20,"							 "+GetObjectName('n07O'))//n07O -> can spawn randomly with creep spawns.
	endif
	if Mode_EM then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Easy Mode"+"|r:		   "+GetObjectName('n07T'))//n07T -> Towers are weaker. Heroes gain more xp and gold.
	endif
	if Mode_SH then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Same Hero"+"|r:		   "+GetObjectName('n07U')+" "+(PlayerNames[GetPlayerId((PlayerModeTyper))])+"|r"+" "+GetObjectName('n07W'))//n07U -> All players will be given the same hero that, n07W -> has.
	endif
	if Mode_OM then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Only Mid"+"|r:		   "+GetObjectName('n080'))//n080 -> Only middle towers can be destroyed
	endif
	if Mode_NB then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"No Bot"+"|r:		   "+GetObjectName('n07V'))//n07V -> Creeps won't spawn from the bottom lane
	endif
	if Mode_NM then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"No Mid"+"|r:		   "+GetObjectName('n07S'))//n07S -> Creeps won't spawn from the middle lane
	endif
	if Mode_NT then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"No Top"+"|r:		   "+GetObjectName('n07R'))//n07R -> Creeps won't spawn from the top lane
	endif
	if Mode_NS then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"No Swap"+"|r:		   "+GetObjectName('n07X'))//n07X -> Swapping heroes is not allowed
	endif
	if Mode_NR then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"No Repick"+"|r:		   "+GetObjectName('n07Q'))//n07Q -> Repicking heroes is not allowed
	endif
	if Mode_PM then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Pool Mode"+"|r:		   "+GetObjectName('n07Y'))//n07Y -> Allows allies to pool each other items
	endif
	if Mode_OI then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Observer Info"+"|r:		   "+GetObjectName('n07Z'))//n07Z -> Disables extra information for Observers
	endif
	if Mode_FR then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Fast Respawn"+"|r:		   "+GetObjectName('n0DP'))//n0DP -> Reduces death times by 50%
	endif
	if Mode_ZM then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Zoom mode"+"|r:		   "+GetObjectName('n0KI'))//n0KI -> Observers will view the game from a zoomed out state.
	endif
	if Mode_UL then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Unlimited Level"+"|r:		   Hero levels are infinite")
	endif
	if Mode_SS then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"See skills"+"|r:		   You can see skills picked by enemies")
	endif
	if Mode_AB then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Antibackdoor"+"|r:		   Backdoor regeneration increased heavily")
	endif
	if Mode_S5 then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Five skills"+"|r:		   You can pick a 5th normal spell (slot 5)")
	endif
	if Mode_S6 then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Six skills"+"|r:		   You can pick a 2nd ultimate spell (slot 6)")
	endif
	if Mode_FN then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Fast neutrals"+"|r:		   First neutrals spawn already after drafting")
	endif
	if Mode_D2 then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Draft 20"+"|r:		   Draft of 20 heroes in the taverns")
	endif
	if Mode_D3 then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Draft 30"+"|r:		   Draft of 30 heroes in the taverns")
	endif
	if Mode_D4 then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Draft 40"+"|r:		   Draft of 40 heroes in the taverns")
	endif
	if Mode_D5 then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Draft 50"+"|r:				Draft of 50 heroes in the taverns")
	endif
	if Mode_OS then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"One skill"+"|r:		   Skills may only be chosen once in your team")
	endif
	if Mode_BO then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Balance off"+"|r:		   Balance turned off")
	endif
	if Mode_RA then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Random extra abilities"+"|r:		   Your 5th & 6th skills are randomed")
	endif
	if Mode_LS3 then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Limit skills 3"+"|r:		   You can only pick 3 skills from the same hero")
	endif
	if Mode_LS then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Limit skills"+"|r:		   You can only pick 2 skills from the same hero")
	endif
	if Mode_FF then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Fast Finish"+"|r:		   You can vote to fast finish the game using -ff command, -wff to check who ff'd")
	endif
	if Mode_AH then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"Anti Hack|r:				 Provides some features which could help against some kind of hackers")
	endif
	if Mode_NN then
		call DisplayTimedTextToPlayer(p,0,0,20,color+"No Neutrals|r:				 No neutral camps spawns")
	endif
endfunction

function YID takes nothing returns nothing
	if GetUnitTypeId(GetEnumUnit())=='n004' then//n004 -> Spirit Bear
		call RemoveUnit(GetEnumUnit())
	endif
	if GetUnitTypeId(GetEnumUnit())=='o003' then//o003 -> Spin Web
		call RemoveUnit(GetEnumUnit())
	endif
endfunction

function YJD takes unit u1,unit u2 returns nothing
	local player Me=GetOwningPlayer(u1)
	local player YKD=GetOwningPlayer(u2)
	local unit YMD=CreateUnit(Me,'e01F',0,0,0)//e01F -> ItemHolder
	local group g
	local item FWD
	local integer YND
	local integer i=1
	local integer array megusta
	if HasUsedRandom[GetPlayerId(Me)] then
		if GetPlayerState(Me,PLAYER_STATE_RESOURCE_GOLD)<100 then
			return
		endif
	endif
	if HasUsedRandom[GetPlayerId(YKD)] then
		if GetPlayerState(YKD,PLAYER_STATE_RESOURCE_GOLD)<100 then
			return
		endif
	endif
	if HasUsedRandom[GetPlayerId(Me)] and RepickHasBeenUsed[GetPlayerId(Me)]==false and Prevent100GoldPerSwap[GetPlayerId(Me)]==0 then
		set Prevent100GoldPerSwap[GetPlayerId(Me)]=1
		call SetPlayerState(Me,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Me,PLAYER_STATE_RESOURCE_GOLD)-100)
	endif
	if HasUsedRandom[GetPlayerId(YKD)] and RepickHasBeenUsed[GetPlayerId(YKD)]==false and Prevent100GoldPerSwap[GetPlayerId(YKD)]==0 then
		set Prevent100GoldPerSwap[GetPlayerId(YKD)]=1
		call SetPlayerState(YKD,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(YKD,PLAYER_STATE_RESOURCE_GOLD)-100)
	endif
	//set TempInteger=UltimatesHeroId[GetPlayerId(Me)]
	//set UltimatesHeroId[GetPlayerId(Me)]=UltimatesHeroId[GetPlayerId(YKD)]
	//set UltimatesHeroId[GetPlayerId(YKD)]=TempInteger
	set YND=ReliableGold[GetPlayerId(Me)]
	set ReliableGold[GetPlayerId(Me)]=ReliableGold[GetPlayerId(YKD)]
	set ReliableGold[GetPlayerId(YKD)]=YND
	call DisableTrigger(t_manipulateitem)
	if GetUnitAbilityLevel(u1,'A03E')>0 then//A03E -> Feral Impulse, QP0Q -> Feral Impulse
		set IM=u1
		set AM=u2
		call ExecuteFunc("YOD")
	elseif GetUnitAbilityLevel(u2,'A03E')>0 then//A03E -> Feral Impulse, QP0Q -> Feral Impulse
		set IM=u2
		set AM=u1
		call ExecuteFunc("YOD")
	endif
	if GetUnitAbilityLevel(u1,'A0CY')>0 then//A0CY -> Grow, QP1K -> Grow
		set IM=u1
		set AM=u2
		call ExecuteFunc("YPD")
	endif
	if GetUnitAbilityLevel(u2,'A0CY')>0 then//A0CY -> Grow, QP1K -> Grow
		set IM=u2
		set AM=u1
		call ExecuteFunc("YPD")
	endif
	call FlushChildHashtable(HY,(800+GetPlayerId(GetOwningPlayer(u1))))
	call FlushChildHashtable(HY,(800+GetPlayerId(GetOwningPlayer(u2))))
	set g=GetAvailableGroup()
	set bj_groupEnumOwningPlayer=Me
	call GroupEnumUnitsInRect(g,GetWorldBounds(),filterGetUnitsInRectOfPlayer)
	call ForGroup(g,function YID)
	call KillGroup(g)
	set g=GetAvailableGroup()
	set bj_groupEnumOwningPlayer=YKD
	call GroupEnumUnitsInRect(g,GetWorldBounds(),filterGetUnitsInRectOfPlayer)
	call ForGroup(g,function YID)
	call KillGroup(g)
	call SetUnitOwner(u2,Me,true)
	call SetUnitOwner(u1,YKD,true)
	set udg_Hero[GetPlayerId(Me)]=u2
	set HeroTypeId[GetPlayerId(Me)]=GetUnitTypeId(u2)
	call SaveInteger(HY,GetPlayerId(Me),'hHid',GetUnitPointValue(u2))//fix swap icons
	set udg_Hero[GetPlayerId(YKD)]=u1
	call SaveInteger(HY,GetPlayerId(YKD),'hHid',GetUnitPointValue(u1))//fix swap icons
	set HeroTypeId[GetPlayerId(YKD)]=GetUnitTypeId(u1)
	call SetPlayerName(Me,(PlayerNames[GetPlayerId((Me))])+" ("+UQ8(udg_Hero[GetPlayerId(Me)])+")")
	call SetPlayerName(YKD,(PlayerNames[GetPlayerId((YKD))])+" ("+UQ8(udg_Hero[GetPlayerId(YKD)])+")")
	call UnitAddItem(YMD,UnitItemInSlot(u2,0))
	call UnitAddItem(YMD,UnitItemInSlot(u2,1))
	call UnitAddItem(YMD,UnitItemInSlot(u2,2))
	call UnitAddItem(YMD,UnitItemInSlot(u2,3))
	call UnitAddItem(YMD,UnitItemInSlot(u2,4))
	call UnitAddItem(YMD,UnitItemInSlot(u2,5))
	set FWD=UnitItemInSlot(u1,0)
	if FWD!=null then
		call SetItemPlayer(FWD,Me,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u2,FWD)
	endif
	set FWD=UnitItemInSlot(u1,1)
	if FWD!=null then
		call SetItemPlayer(FWD,Me,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u2,FWD)
	endif
	set FWD=UnitItemInSlot(u1,2)
	if FWD!=null then
		call SetItemPlayer(FWD,Me,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u2,FWD)
	endif
	set FWD=UnitItemInSlot(u1,3)
	if FWD!=null then
		call SetItemPlayer(FWD,Me,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u2,FWD)
	endif
	set FWD=UnitItemInSlot(u1,4)
	if FWD!=null then
		call SetItemPlayer(FWD,Me,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u2,FWD)
	endif
	set FWD=UnitItemInSlot(u1,5)
	if FWD!=null then
		call SetItemPlayer(FWD,Me,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u2,FWD)
	endif
	set FWD=UnitItemInSlot(YMD,0)
	if FWD!=null then
		call SetItemPlayer(FWD,YKD,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u1,FWD)
	endif
	set FWD=UnitItemInSlot(YMD,1)
	if FWD!=null then
		call SetItemPlayer(FWD,YKD,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u1,FWD)
	endif
	set FWD=UnitItemInSlot(YMD,2)
	if FWD!=null then
		call SetItemPlayer(FWD,YKD,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u1,FWD)
	endif
	set FWD=UnitItemInSlot(YMD,3)
	if FWD!=null then
		call SetItemPlayer(FWD,YKD,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u1,FWD)
	endif
	set FWD=UnitItemInSlot(YMD,4)
	if FWD!=null then
		call SetItemPlayer(FWD,YKD,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u1,FWD)
	endif
	set FWD=UnitItemInSlot(YMD,5)
	if FWD!=null then
		call SetItemPlayer(FWD,YKD,false)
		call SetItemUserData(FWD,1)
		call UnitAddItem(u1,FWD)
	endif
	call RemoveUnit(YMD)
	call EnableTrigger(t_manipulateitem)
	call SetPlayerAbilityAvailable2(Me,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+1]],false)
	call SetPlayerAbilityAvailable2(Me,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+2]],false)
	call SetPlayerAbilityAvailable2(Me,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+3]],false)
	call SetPlayerAbilityAvailable2(Me,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+4]],false)
	call SetPlayerAbilityAvailable2(YKD,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+1]],false)
	call SetPlayerAbilityAvailable2(YKD,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+2]],false)
	call SetPlayerAbilityAvailable2(YKD,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+3]],false)
	call SetPlayerAbilityAvailable2(YKD,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+4]],false)
	loop
		exitwhen i>4+NumberOfExtraAbilities
		set megusta[i]=PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+i]
		set PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+i]=PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+i]
		set PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+i]=megusta[i]
		set i=i+1
	endloop
	call ClearSelectionForPlayer(Me)
	call SelectUnitAddForPlayer(u2,Me)
	call ClearSelectionForPlayer(YKD)
	call SelectUnitAddForPlayer(u1,YKD)
	call FlushChildHashtable(HY,(800+GetPlayerId(Me)))
	call FlushChildHashtable(HY,(800+GetPlayerId(YKD)))
	call Traffic_RegisterPlayerData(GetOwningPlayer(u1),"9",GetUnitTypeId(u1))
	call Traffic_RegisterPlayerData(GetOwningPlayer(u2),"9",GetUnitTypeId(u2))
	call Traffic_RegisterData("SWAP_"+I2S(GetPlayerId(GetOwningPlayer(u1)))+"_"+I2S(GetPlayerId(GetOwningPlayer(u2))),GetUnitTypeId(u1))
	call Traffic_RegisterData("SWAP_"+I2S(GetPlayerId(GetOwningPlayer(u2)))+"_"+I2S(GetPlayerId(GetOwningPlayer(u1))),GetUnitTypeId(u2))
	call GR9(Me)
	call GR9(YKD)
	if Mode_SD or Mode_MD then
		set RepickHasBeenUsed[GetPlayerId(Me)]=true
		set RepickHasBeenUsed[GetPlayerId(YKD)]=true
	endif
	set Me=null
	set YKD=null
	set g=null
	set YMD=null
	set FWD=null
endfunction

function YRD takes unit u1,unit u2 returns boolean
	return(LoadBoolean(HY,(800+GetPlayerId(GetOwningPlayer(u2))),(GetUnitTypeId(u1)+GetUnitTypeId(u2))))
endfunction

function YSD takes player p returns integer
	local integer i=1
	loop
		exitwhen i>5
		if Sentinels[i]==p or Scourges[i]==p then
			return i
		endif
		set i=i+1
	endloop
	return-1
endfunction

function YTD takes unit u1,unit u2,boolean YUD returns boolean
	call SaveBoolean(HY,(800+GetPlayerId(GetOwningPlayer(u1))),(GetUnitTypeId(u1)+GetUnitTypeId(u2)),(true))
	if YRD(u1,u2)then
		call YJD(u1,u2)
		return true
	else
		call DisplayTimedTextToPlayer(GetOwningPlayer(u2),0,0,30,"  ")
		call DisplayTimedTextToPlayer(GetOwningPlayer(u2),0,0,30,"						 "+udg_Colors[GetPlayerId(GetOwningPlayer(u1))]+GetUnitName(u1)+"|r |cff99ccff"+GetObjectName('n082')+" "+GetObjectName('n083')+"|r |c00ff0303-swap "+I2S(YSD(GetOwningPlayer(u1)))+"|r |cff99ccff"+GetObjectName('n081')+"|r")//n082 -> wants to swap with you., n083 -> Type, n081 -> to accept
		call DisplayTimedTextToPlayer(GetOwningPlayer(u2),0,0,30,"  ")
		if Mode_SD or Mode_MD then
			call DisplayTimedTextToPlayer(GetOwningPlayer(u2),0,0,30,"|c00ff0000WARNING:|r Selected game mode forbid to repick swapped hero.")
		endif
		if YUD then
			call DisplayTimedTextToPlayer(GetOwningPlayer(u1),0,0,30,"  ")
			call DisplayTimedTextToPlayer(GetOwningPlayer(u1),0,0,30,"|cff99ccff"+GetObjectName('n08C')+" |r"+udg_Colors[GetPlayerId(GetOwningPlayer(u2))]+GetUnitName(u2)+"|r")//n08C -> You have requested to swap with
			call DisplayTimedTextToPlayer(GetOwningPlayer(u1),0,0,30,"  ")
			if Mode_SD or Mode_MD then
				call DisplayTimedTextToPlayer(GetOwningPlayer(u1),0,0,30,"|c00ff0000WARNING:|r Selected game mode forbid to repick swapped hero.")
			endif
		endif
	endif
	return false
endfunction

function YVD takes nothing returns nothing
	local integer i=S2I(SubString(GetEventPlayerChatString(),6,StringLength(GetEventPlayerChatString())))
	if GetEventPlayerChatString()=="-swapall"then
		set i=1
		set tt_unit2=udg_Hero[GetPlayerId(GetTriggerPlayer())]
		loop
			exitwhen i>5
			if IsSentinel(GetTriggerPlayer())then
				set tt_player1=Sentinels[i]
			else
				set tt_player1=Scourges[i]
			endif
			set tt_unit1=udg_Hero[GetPlayerId(tt_player1)]
			if not(tt_unit2==null or GetOwningPlayer(tt_unit2)!=GetTriggerPlayer()or tt_unit1==null or GetOwningPlayer(tt_unit1)!=tt_player1 or tt_player1==GetTriggerPlayer())then
				if YTD(tt_unit2,tt_unit1,false)then
					return
				endif
			endif
			set i=i+1
		endloop
		return
	elseif i<1 or i>5 then
		call Error(GetTriggerPlayer(),GetObjectName('n02Z'))//n02Z -> Invalid swap selection
		return
	endif
	set tt_unit2=udg_Hero[GetPlayerId(GetTriggerPlayer())]
	if IsSentinel(GetTriggerPlayer())then
		set tt_player1=Sentinels[i]
	else
		set tt_player1=Scourges[i]
	endif
	set tt_unit1=udg_Hero[GetPlayerId(tt_player1)]
	if tt_unit2==null or GetOwningPlayer(tt_unit2)!=GetTriggerPlayer()or tt_unit1==null or GetOwningPlayer(tt_unit1)!=tt_player1 or tt_player1==GetTriggerPlayer()then
		call Error(GetTriggerPlayer(),GetObjectName('n02Z'))//n02Z -> Invalid swap selection
		return
	endif
	call YTD(tt_unit2,tt_unit1,true)
endfunction

function YWD takes nothing returns nothing
	local integer i
	local player p
	local unit u
	local string s
	if GetLocalPlayer()==GetTriggerPlayer()then
		call ClearTextMessages()
	endif
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,45,"|cff99ccff"+GetObjectName('n08B')+"|r")//n08B -> Swap Hero Options:
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,45," ")
	set i=1
	loop
		exitwhen i>5
		set p=Sentinels[i]
		set u=udg_Hero[GetPlayerId(p)]
		if IsPlayerAlly(GetTriggerPlayer(),p)and GetTriggerPlayer()!=p and u!=null and GetOwningPlayer(u)==p then
			set s=" "
			if YRD(udg_Hero[GetPlayerId(GetTriggerPlayer())],u)then
				set s=" |c00ff0303("+GetObjectName('n085')+")|r"//n085 -> Requested Swap With You
			endif
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,45,udg_Colors[GetPlayerId(p)]+I2S(i)+"|r"+" - "+"|cff99ccff"+GetUnitName(u)+"|r"+s)
		endif
		set p=Scourges[i]
		set u=udg_Hero[GetPlayerId(p)]
		if IsPlayerAlly(GetTriggerPlayer(),p)and GetTriggerPlayer()!=p and u!=null and GetOwningPlayer(u)==p then
			set s=" "
			if YRD(udg_Hero[GetPlayerId(GetTriggerPlayer())],u)then
				set s=" |c00ff0303("+GetObjectName('n085')+")|r"//n085 -> Requested Swap With You
			endif
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,45,udg_Colors[GetPlayerId(p)]+I2S(i)+"|r"+" - "+"|cff99ccff"+GetUnitName(u)+"|r"+s)
		endif
		set i=i+1
	endloop
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,45," ")
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,45,"|cff99ccff"+GetObjectName('n083')+"|r |c00ff0303-swap #|r |cff99ccff"+GetObjectName('n086')+" -swapcancel "+GetObjectName('n087')+"|r")//n083 -> Type, n086 -> to make a choice or, n087 -> to cancel swap requests
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,45," ")
	set u=null
	set p=null
endfunction

function YXD takes player whichPlayer returns boolean
	local integer VT8=1
	local integer YYD=0
	loop
		exitwhen VT8>5
		if IsSentinel(whichPlayer)then
			if udg_Hero[GetPlayerId(Sentinels[VT8])]!=null and Sentinels[VT8]!=whichPlayer and GetHeroLevel(udg_Hero[GetPlayerId(Sentinels[VT8])])==1 then
				set YYD=YYD+1
			endif
		else
			if udg_Hero[GetPlayerId(Scourges[VT8])]!=null and Scourges[VT8]!=whichPlayer and GetHeroLevel(udg_Hero[GetPlayerId(Scourges[VT8])])==1 then
				set YYD=YYD+1
			endif
		endif
		set VT8=VT8+1
	endloop
	if YYD>0 then
		return true
	else
		return false
	endif
endfunction

function YZD takes nothing returns boolean
	if Mode_NR or Mode_NS then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"-swaphero "+GetObjectName('n088'))//n088 -> has been disabled.
		return false
	endif
	if HasUsedRandom[GetPlayerId(GetTriggerPlayer())] then
		if GetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD)<100 then
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"Need at least 100 gold to swap after randoming.")
			return false
		endif
	else
		
	endif
	if GetWidgetLife(udg_Hero[GetPlayerId(GetTriggerPlayer())])<1 then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08F'))//n08F -> You must have a living hero in order to swap with someone.
		return false
	endif
	if IsGameStartedAnotherBool then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08G')+" -swaphero.")//n08G -> Too late to use
		return false
	endif
	if YXD(GetTriggerPlayer())==false then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08H'))//n08H -> No hero available to swap with.
		return false
	endif
	return true
endfunction

function SwapChatCmd takes nothing returns nothing
	if YZD()then
		if GetEventPlayerChatString()=="-swap"or GetEventPlayerChatString()=="-swaphero"then
			call YWD()
		elseif GetEventPlayerChatString()=="-swapcancel"then
			call FlushChildHashtable(HY,(800+GetPlayerId(GetTriggerPlayer())))
		else
			call YVD()
		endif
	endif
endfunction

function Y1D takes nothing returns boolean
	local integer UZ8=GetUnitTypeId(udg_Hero[GetPlayerId(GetTriggerPlayer())])
	return(UZ8=='U008' or UZ8=='U007' or UZ8=='Hlgr' or UZ8=='Eevi' or UZ8=='Ekee')and(RectContainsUnit(FountainRectFrogSent,udg_Hero[GetPlayerId(GetTriggerPlayer())])or RectContainsUnit(FountainRectFrogScourge,udg_Hero[GetPlayerId(GetTriggerPlayer())]))//U008 -> Lycanthrope, U007 -> Lifestealer, Hlgr -> Dragon Knight, Eevi -> Soul Keeper, Ekee -> Tormented Soul
endfunction

function Y0D takes nothing returns nothing
	local unit Hero=udg_Hero[GetPlayerId(GetTriggerPlayer())]
	call UnitAddAbility(Hero,'A0FI')
	call IssueImmediateOrderById(Hero,852663)
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,120.,"|c00ff0303"+GetObjectName('n08I')+" "+UQ8(GetEnumUnit())+". "+GetObjectName('n08J')+"|r")//n08I -> Recreate is being performed on, n08J -> Please wait about 2 minutes
	set Hero=null
endfunction

function WAD takes nothing returns nothing
	if Y1D()then
		call Y0D()
	endif
endfunction

function Y5D takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer Count=GetTriggerEvalCount(t)
	local real x
	local real y
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or Count>60 then
		if((LoadInteger(HY,(GetHandleId((Hero))),(4259)))==1)==false then
			if IsSentinel(GetOwningPlayer(Hero))then
				set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
				set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
			else
				set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
				set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
			endif
			call SetUnitPosition(Hero,x,y)
			call PauseUnit(Hero,false)
			call ShowUnit(Hero,true)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call PauseUnit(Hero,true)
	endif
	set t=null
	set Hero=null
	return false
endfunction

function Y2D takes player p returns nothing
	local unit Hero=udg_Hero[GetPlayerId(p)]
	local trigger t
	if IsDead(Hero)==false then
		set t=CreateTrigger()
		call DisplayTimedTextToPlayer(p,0,0,30.,GetObjectName('n08K'))//n08K -> You are using unstuck. You will be sent to your base in 60 seconds.
		call UnitRemoveBuffs(Hero,true,false)
		call UnitRemoveAbility(Hero,'Bcyc')//Bcyc -> Cyclone
		call UnitRemoveAbility(Hero,'Bcy2')//Bcy2 -> Cyclone
		call UnitRemoveAbility(Hero,'B02J')//B02J -> Song of the Siren
		call UnitRemoveAbility(Hero,'BUsp')
		call UnitRemoveAbility(Hero,'Bust')
		call UnitRemoveAbility(Hero,'B02F')//B02F -> Nightmare
		call PauseUnit(Hero,true)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerRegisterDeathEvent(t,Hero)
		call TriggerAddCondition(t,Condition(function Y5D))
		call SaveUnitHandle(HY,(GetHandleId(t)),14,(Hero))
	endif
	set p=null
	set Hero=null
	set t=null
endfunction

function Z4D takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local player p=(LoadPlayerHandle(HY,h,54))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		call Y2D(p)
	endif
	set t=null
	set p=null
	return false
endfunction

function WBD takes nothing returns nothing
	local player p=GetTriggerPlayer()
	local unit Hero=udg_Hero[GetPlayerId(p)]
	local trigger t
	if IsDead(Hero)==false then
		set t=CreateTrigger()
		call TriggerRegisterTimerEvent(t,3.5,false)
		call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(t,Condition(function Z4D))
		call SavePlayerHandle(HY,(GetHandleId(t)),54,(p))
	endif
	set p=null
	set Hero=null
	set t=null
endfunction

function Z7D takes player p returns string
	local string s=LeftAt[GetPlayerId(p)]
	if LeftAt[GetPlayerId(p)]!="Here"then
		return" |c00ff0303("+GetObjectName('n089')+" at "+SubString(s,10,StringLength(s))+"|c00ff0303)|r"//n089 -> Left
	endif
	return" "
endfunction

function WCD takes nothing returns nothing
	local integer VT8=1
	local integer VU8=5
	local integer ZG8
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,20," ")
	if(IsScourge(GetTriggerPlayer()))then
		loop
			exitwhen VT8>VU8
			set ZG8=GetPlayerId(Sentinels[VT8])
			if(udg_Hero[ZG8]!=null)then
				call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,20,udg_Colors[ZG8]+(PlayerNames[GetPlayerId((Sentinels[VT8]))])+"|r "+GetObjectName('n08M')+" "+GetUnitName(udg_Hero[ZG8])+" ("+GetObjectName('n08L')+" "+I2S(GetUnitLevel(udg_Hero[ZG8]))+")"+Z7D(Sentinels[VT8]))//n08M -> controls, n08L -> Level
			endif
			set VT8=VT8+1
		endloop
	else
		loop
			exitwhen VT8>VU8
			set ZG8=GetPlayerId(Scourges[VT8])
			if(udg_Hero[ZG8]!=null)then
				call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,20,udg_Colors[ZG8]+(PlayerNames[GetPlayerId((Scourges[VT8]))])+"|r "+GetObjectName('n08M')+" "+GetUnitName(udg_Hero[ZG8])+" ("+GetObjectName('n08L')+" "+I2S(GetUnitLevel(udg_Hero[ZG8]))+")"+Z7D(Scourges[VT8]))//n08M -> controls, n08L -> Level
			endif
			set VT8=VT8+1
		endloop
	endif
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,20," ")
endfunction

function Z8D takes unit u returns boolean
	return GetUnitTypeId(u)=='N01O' or GetUnitTypeId(u)=='N013' or GetUnitTypeId(u)=='N014' or GetUnitTypeId(u)=='N015'//N01O -> Lone Druid, N013 -> Lone Druid, N014 -> Lone Druid, N015 -> Lone Druid
endfunction

function Z9D takes unit u returns unit
	local integer h=GetHandleId(GetOwningPlayer(u))
	return(LoadUnitHandle(HY,h,333))
endfunction

function W3D takes nothing returns nothing
	local unit u
	local integer i=0
	if(udg_Hero[GetPlayerId(GetTriggerPlayer())]==null)then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10.,GetObjectName('n08A'))//n08A -> No Hero is selected
	else
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10.,GetUnitName(udg_Hero[GetPlayerId(GetTriggerPlayer())])+" "+GetObjectName('n08N')+" "+I2S(R2I(.5+GetUnitMoveSpeedLOD(udg_Hero[GetPlayerId(GetTriggerPlayer())]))))//n08N -> movespeed is
		if Z8D(udg_Hero[GetPlayerId(GetTriggerPlayer())])then
			set u=Z9D(udg_Hero[GetPlayerId(GetTriggerPlayer())])
			if u!=null then
				call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10.,GetUnitName(u)+" "+GetObjectName('n08N')+" "+I2S(R2I(.5+GetUnitMoveSpeedLOD(u))))//n08N -> movespeed is
			endif
		endif
	endif
	set u=null
endfunction

function W3Ds takes nothing returns nothing
	local unit u
	local integer i=0
	local group g=GetAvailableGroup()
	call GroupEnumUnitsSelected(g,GetTriggerPlayer(),Condition(function ReturnTrue))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call echo(GetUnitName(u)+" ms = "+R2S(GetUnitMoveSpeedLOD(u)))
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
endfunction

function W6D takes nothing returns nothing
	local unit u
	local integer i=0
	if(udg_Hero[GetPlayerId(GetTriggerPlayer())]==null)then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10.,GetObjectName('n08A'))//n08A -> No Hero is selected
	else
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10.,GetUnitName(udg_Hero[GetPlayerId(GetTriggerPlayer())])+" "+GetObjectName('n08N')+" "+I2S(R2I(.5+GetUnitMoveSpeedLOD(udg_Hero[GetPlayerId(GetTriggerPlayer())]))))//n08N -> movespeed is
		if Z8D(udg_Hero[GetPlayerId(GetTriggerPlayer())])then
			set u=Z9D(udg_Hero[GetPlayerId(GetTriggerPlayer())])
			if u!=null then
				call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10.,GetUnitName(u)+" "+GetObjectName('n08N')+" "+I2S(R2I(.5+GetUnitMoveSpeedLOD(u))))//n08N -> movespeed is
			endif
		endif
		loop
			exitwhen i>16
			set u=udg_Hero[i]
			if u!=null and u!=udg_Hero[GetPlayerId(GetTriggerPlayer())]and IsUnitAlly(u,GetTriggerPlayer()) then
				call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10.,GetUnitName(u)+" "+GetObjectName('n08N')+" "+I2S(R2I(.5+GetUnitMoveSpeedLOD(u))))//n08N -> movespeed is
			endif
			set i=i+1
		endloop
	endif
	set u=null
endfunction

function WLD takes nothing returns nothing
	call SaveBoolean(HY,GetHandleId(GetTriggerPlayer()),139,true)
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08R'))//n08R -> Disallowing help from certain abilities.
endfunction

function W1D takes nothing returns nothing
	call SaveBoolean(HY,GetHandleId(GetTriggerPlayer()),139,false)
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08O'))//n08O -> Allowing help from certain abilities.
endfunction

function W0D takes nothing returns nothing
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10.,"   "+GetObjectName('n08P')+" "+I2S(PlayerCS[GetPlayerId(GetTriggerPlayer())])+" "+GetObjectName('n08Q')+" "+I2S(CSDenies[GetPlayerId(GetTriggerPlayer())])+" "+GetObjectName('n08S')+" "+I2S(CSNeutrals[GetPlayerId(GetTriggerPlayer())]))//n08P -> Creeps Killed:, n08Q -> Creeps Denied:, n08S -> Neutrals Killed:
endfunction

function W5D takes nothing returns nothing
	local integer x=GetPlayerId(GetTriggerPlayer())
	if(GetEventPlayerChatString()=="-cson")then
		set CSONStatus1[x]=true
		set CSONStatus2[x]=true
	else
		set CSONStatus1[x]=false
		set CSONStatus2[x]=false
	endif
endfunction

function XLD takes nothing returns nothing
	set SelectionHelperEnabled[GetPlayerId(GetTriggerPlayer())]=false
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,GetObjectName('n0JZ'))//n0JZ -> Control selection helper has been disabled.
endfunction

function X1D takes nothing returns nothing
	set SelectionHelperEnabled[GetPlayerId(GetTriggerPlayer())]=true
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,GetObjectName('n0K0'))//n0K0 -> Control selection helper has been enabled.
endfunction

function X6D takes nothing returns nothing
	local integer i=0
	local integer id=GetPlayerId(GetTriggerPlayer())
	local integer Count=0
	local integer ZED=0
	local player p
	if SwitchUnlockingAvailable==false or Mode_SO==false then
		return
	endif
	if ZA7+90<(TimerGetElapsed(GlobalTimer))then
		loop
			exitwhen i>15
			set ZZ7[i]=false
			set i=i+1
		endloop
	endif
	set ZA7=(TimerGetElapsed(GlobalTimer))+90
	set ZZ7[id]=true
	set i=0
	loop
		exitwhen i>15
		if IsSentinel(GetTriggerPlayer())then
			if IsSentinel(Player(i))and IsPlayer(Player(i))then
				set ZED=ZED+1
				if ZZ7[i]then
					set Count=Count+1
				endif
			endif
		else
			if IsScourge(Player(i))and IsPlayer(Player(i))then
				set ZED=ZED+1
				if ZZ7[i]then
					set Count=Count+1
				endif
			endif
		endif
		set i=i+1
	endloop
	if Count*2>ZED then
		if IsSentinel(GetTriggerPlayer())then
			set i=0
			loop
				exitwhen i>5
				set p=Sentinels[i]
				if IsPlayerLeftGame[GetPlayerId(p)] and HeroHasBeenUnlocked[GetPlayerId(p)]==false then
					call DisplayTimedTextToForceEx(Force_Elfs,10,GetObjectName('n0KD')+" "+(PlayerNames[GetPlayerId((p))]))//n0KD -> Gold and Items have been unlocked for:
					call C08(p)
					set HeroHasBeenUnlocked[GetPlayerId(p)]=true
				endif
				set i=i+1
			endloop
		else
			set i=0
			loop
				exitwhen i>5
				set p=Scourges[i]
				if IsPlayerLeftGame[GetPlayerId(p)] and HeroHasBeenUnlocked[GetPlayerId(p)]==false then
					call DisplayTimedTextToForceEx(Force_Unds,10,GetObjectName('n0KD')+" "+(PlayerNames[GetPlayerId((p))]))//n0KD -> Gold and Items have been unlocked for:
					call C08(p)
					set HeroHasBeenUnlocked[GetPlayerId(p)]=true
				endif
				set i=i+1
			endloop
		endif
	else
		if IsSentinel(GetTriggerPlayer())then
			call DisplayTimedTextToForceEx(Force_Elfs,10,GetObjectName('n0KB')+" "+I2S(Count)+"/"+I2S(ZED)+" ("+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+")")//n0KB -> Unlock Count:
		else
			call DisplayTimedTextToForceEx(Force_Unds,10,GetObjectName('n0KB')+" "+I2S(Count)+"/"+I2S(ZED)+" ("+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+")")//n0KB -> Unlock Count:
		endif
	endif
	set p=null
endfunction

function UpdateMyLb takes nothing returns nothing
	local integer i=1
	local integer pid
	local boolean deadtimer
	local boolean courier
	local boolean movespeed
	local player p
	local boolean deadtimeron=not(Mode_NoDeath or GameEnded)
	local string s=""
	local integer time
	local integer lines
	local real speed
	local unit u
	local integer pid2
	local integer k=1
	local integer c=LoadInteger(HY,GetHandleId(GetExpiredTimer()),0)+1
	call SaveInteger(HY,GetHandleId(GetExpiredTimer()),0,c)
	loop
		set i=1
		loop
			set lines=0
			set s="	"
			if k==1 then
				set p=Sentinels[i]
			else
				set p=Scourges[i]
			endif
			if IsPlayer(p)!=false then
				set pid=GetPlayerId(p)
				set time=R2I(TimerGetRemaining(HeroRespawnTimer[pid]))
				set deadtimer=time>0 and ShowDeathTimer[pid] and deadtimeron
//				set speed=GetUnitMoveSpeedLOD(udg_Hero[pid])
//				set movespeed=false and speed>0
				if deadtimer then
					set s=s+"Respawn in: "+I2S(time)+"|n"
					set lines=1
				endif
//				if movespeed then
//					set s=s+"Hero's movespeed: "+I2S(R2I(speed))+"|n"
//					set lines=1
//				endif
				if ModuloInteger(c,2)==1 then
					call DefineCourierForPlayer(p)
				endif
				if HaveSavedHandle(HeroStats,GetHandleId(p),'COUR') and (LoadBoolean(HeroStats,GetHandleId(p),'UIds') or IsDead(LoadUnitHandle(HeroStats,GetHandleId(p),'COUR')))  then
					set lines=1
					set u=LoadUnitHandle(HeroStats,GetHandleId(p),'COUR')
					set pid2=GetPlayerId(GetOwningPlayer(u))
					set s=s+udg_Colors[pid2]+"Courier|r: "
					if IsDead(u) then
						set s=s+"|c00ff0000Dead|r ("+I2S(R2I(TimerGetElapsed(GlobalTimer)-LoadReal(HY,GetHandleId(u),'DEAD'))*-1)+"s)"
					else
						set s=s+LoadStr(HeroStats,GetHandleId(u),'ORDR')
					endif
				endif
				if lines>0 then
					call LeaderboardDisplay(MyLB[pid],true)
					call LeaderboardSetLabel(MyLB[pid],s)
					
					call PlayerSetLeaderboard(p,MyLB[pid])
				elseif IsLeaderboardDisplayed(MyLB[pid]) then
					call LeaderboardDisplay(MyLB[pid],false)
					//call LeaderboardSetLabel(MyLB[pid],"")
				endif
			endif
			set i=i+1
			exitwhen i>5
		endloop
		set k=k+1
		exitwhen k>2
	endloop
	
	set u=null
endfunction

function InitMyLb takes nothing returns nothing
	local integer i=1
	local integer pid
	local timer t=CreateTimer()
	call TimerStart(t,1,true,function UpdateMyLb)
	set t=null
	loop
		
		set pid=GetPlayerId(Sentinels[i])
		set MyLB[pid]=CreateLeaderboard()
		call PlayerSetLeaderboard(Sentinels[i],MyLB[pid])
		call LeaderboardDisplay(MyLB[pid],false)
		call LeaderboardSetLabel(MyLB[pid],"Default string")
		
		set pid=GetPlayerId(Scourges[i])
		set MyLB[pid]=CreateLeaderboard()
		call PlayerSetLeaderboard(Scourges[i],MyLB[pid])
		call LeaderboardDisplay(MyLB[pid],false)
		call LeaderboardSetLabel(MyLB[pid],"Default string")
		
		set i=i+1
		exitwhen i>5
	endloop
	
endfunction

function XDD takes nothing returns nothing
	local integer x=GetPlayerId(GetTriggerPlayer())
	if GetEventPlayerChatString()=="-don"or GetEventPlayerChatString()=="-deathon"then
		set ShowDeathTimer[x]=true
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08W'))//n08W -> The death timer will show up when you die.
	else
		set ShowDeathTimer[x]=false
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08X'))//n08X -> The death timer will not show up when you die.
	endif
endfunction

function X8D takes nothing returns nothing
	if(GetEventPlayerChatString()=="-showdeny")then
		set CSONStatus2[GetPlayerId(GetTriggerPlayer())]=true
	else
		set CSONStatus2[GetPlayerId(GetTriggerPlayer())]=false
	endif
endfunction

function X9D takes nothing returns nothing
	call Error(GetTriggerPlayer(),GetObjectName('n0HG'))//n0HG -> -di functionality is on by default. Use -cson and -csoff to toggle it on and off.
endfunction

function W2D takes nothing returns nothing
	call ForceRemovePlayer(AllPlayers,GetTriggerPlayer())
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08U'))//n08U -> You are now hiding messages.
endfunction

function X4D takes nothing returns nothing
	call ForceAddPlayer(AllPlayers,GetTriggerPlayer())
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08Z'))//n08Z -> You are now showing messages.
endfunction

function ZJD takes nothing returns boolean
	local integer x=GetRandomInt(1,4)
	if x==1 then
		set Weather_Random=Weather_Snow
	elseif x==2 then
		set Weather_Random=Weather_Rain
	elseif x==3 then
		set Weather_Random=Weather_Moonlight
	elseif x==4 then
		set Weather_Random=Weather_Wind
	endif
	if Z17[GetPlayerId(GetLocalPlayer())]then
		call EnableWeatherEffect(Weather_Snow,false)
		call EnableWeatherEffect(Weather_Rain,false)
		call EnableWeatherEffect(Weather_Moonlight,false)
		call EnableWeatherEffect(Weather_Wind,false)
		call EnableWeatherEffect(Weather_Random,true)
	endif
	return false
endfunction

function ZKD takes nothing returns nothing
	local integer x=GetRandomInt(1,4)
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,300,true)
	call TriggerAddCondition(t,Condition(function ZJD))
	set Z17[GetPlayerId(Sentinels[1])]=false
	set Z17[GetPlayerId(Sentinels[2])]=false
	set Z17[GetPlayerId(Sentinels[3])]=false
	set Z17[GetPlayerId(Sentinels[4])]=false
	set Z17[GetPlayerId(Sentinels[5])]=false
	set Z17[GetPlayerId(Scourges[1])]=false
	set Z17[GetPlayerId(Scourges[2])]=false
	set Z17[GetPlayerId(Scourges[3])]=false
	set Z17[GetPlayerId(Scourges[4])]=false
	set Z17[GetPlayerId(Scourges[5])]=false
	if udg_ObserverMode then
		set Z17[GetPlayerId(udg_Observer1)]=false
		set Z17[GetPlayerId(udg_Observer2)]=false
	endif
	if x==1 then
		set Weather_Random=Weather_Snow
	elseif x==2 then
		set Weather_Random=Weather_Rain
	elseif x==3 then
		set Weather_Random=Weather_Moonlight
	elseif x==4 then
		set Weather_Random=Weather_Wind
	endif
	set t=null
endfunction

function X7D takes nothing returns nothing
	local string VHD=StringCase(GetEventPlayerChatString(),false)
	
	if Z67 then
		set Z67=false
		call ZKD()
	endif
	//call echo(VHD)
	if VHD!="-weather random" then
		set Z17[GetPlayerId(GetTriggerPlayer())]=false
	else
		set Z17[GetPlayerId(GetTriggerPlayer())]=true
	endif
	if GetLocalPlayer()==GetTriggerPlayer() then
		call EnableWeatherEffect(Weather_Snow,false)
		call EnableWeatherEffect(Weather_Rain,false)
		call EnableWeatherEffect(Weather_Moonlight,false)
		call EnableWeatherEffect(Weather_Wind,false)
		if VHD=="-weather snow" then
			call EnableWeatherEffect(Weather_Snow,true)
		elseif VHD=="-weather rain" then
			call EnableWeatherEffect(Weather_Rain,true)
		elseif VHD=="-weather moonlight" then
			call EnableWeatherEffect(Weather_Moonlight,true)
		elseif VHD=="-weather wind" then
			call EnableWeatherEffect(Weather_Wind,true)
		elseif VHD=="-weather random" then
			call EnableWeatherEffect(Weather_Random,true)
		endif
	endif
//	if VHD=="-weather snow"and GetLocalPlayer()==GetTriggerPlayer()then
//		call echo("snow")
//		set Z17[GetPlayerId(GetTriggerPlayer())]=false
//		call EnableWeatherEffect(Weather_Snow,true)
//		call EnableWeatherEffect(Weather_Rain,false)
//		call EnableWeatherEffect(Weather_Moonlight,false)
//		call EnableWeatherEffect(Weather_Wind,false)
//	endif
//	if VHD=="-weather rain"and GetLocalPlayer()==GetTriggerPlayer()then
//		set Z17[GetPlayerId(GetTriggerPlayer())]=false
//		call EnableWeatherEffect(Weather_Snow,false)
//		call EnableWeatherEffect(Weather_Rain,true)
//		call EnableWeatherEffect(Weather_Moonlight,false)
//		call EnableWeatherEffect(Weather_Wind,false)
//	endif
//	if VHD=="-weather moonlight"and GetLocalPlayer()==GetTriggerPlayer()then
//		set Z17[GetPlayerId(GetTriggerPlayer())]=false
//		call EnableWeatherEffect(Weather_Snow,false)
//		call EnableWeatherEffect(Weather_Rain,false)
//		call EnableWeatherEffect(Weather_Moonlight,true)
//		call EnableWeatherEffect(Weather_Wind,false)
//	endif
//	if VHD=="-weather wind"and GetLocalPlayer()==GetTriggerPlayer()then
//		set Z17[GetPlayerId(GetTriggerPlayer())]=false
//		call EnableWeatherEffect(Weather_Snow,false)
//		call EnableWeatherEffect(Weather_Rain,false)
//		call EnableWeatherEffect(Weather_Moonlight,false)
//		call EnableWeatherEffect(Weather_Wind,true)
//	endif
//	if VHD=="-weather off"and GetLocalPlayer()==GetTriggerPlayer()then
//		set Z17[GetPlayerId(GetTriggerPlayer())]=false
//		call EnableWeatherEffect(Weather_Snow,false)
//		call EnableWeatherEffect(Weather_Rain,false)
//		call EnableWeatherEffect(Weather_Moonlight,false)
//		call EnableWeatherEffect(Weather_Wind,false)
//	endif
//	if VHD=="-weather random"then
//		set Z17[GetPlayerId(GetTriggerPlayer())]=true
//		if GetLocalPlayer()==GetTriggerPlayer()then
//			call EnableWeatherEffect(Weather_Snow,false)
//			call EnableWeatherEffect(Weather_Rain,false)
//			call EnableWeatherEffect(Weather_Moonlight,false)
//			call EnableWeatherEffect(Weather_Wind,false)
//			call EnableWeatherEffect(Weather_Random,true)
//		endif
//	endif
endfunction

function RollChatCmd takes nothing returns nothing
	local integer a=S2I(SubString(GetEventPlayerChatString(),6,StringLength(GetEventPlayerChatString())))
	local integer ZG8=GetPlayerId(GetTriggerPlayer())
	local integer rnd
	if GetEventPlayerChatString()=="-rollon"or GetEventPlayerChatString()=="-rolloff"then
		return
	endif
	set RollCounter[ZG8]=RollCounter[ZG8]+1
	if RollCounter[ZG8]>20 then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0DQ'))//n0DQ -> You have used this too much!
		return
	endif
	if a==0 then
		set a=100
	endif
	if a>0 and a<2001 then
		set rnd=GetRandomInt(1,a)
		if ShowRollNumbers[GetPlayerId(GetLocalPlayer())]then
			call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,5,udg_Colors[ZG8]+PlayerNames[ZG8]+"|r "+GetObjectName('n05I')+" "+I2S(rnd)+" "+GetObjectName('n05M')+" "+I2S(a))//n05I -> has rolled, n05M -> out of
		endif
		//call RollDisplaying(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r "+GetObjectName('n05I')+" "+I2S(GetRandomInt(1,a))+" "+GetObjectName('n05M')+" "+I2S(a))//n05I -> has rolled, n05M -> out of
	else
		call Error(GetTriggerPlayer(),GetObjectName('n02Y'))//n02Y -> Roll value must be between 1 and 2000
	endif
endfunction

function XYD takes nothing returns nothing
	local integer a
	if GetRandomInt(1,2)==1 then
		set a=GetRandomInt(FirstScourgeHeroIndexid,LastScourgeHeroIndexid)
	else
		set a=GetRandomInt(FirstSentinelHeroIndexid,LastSentinelHeroIndexid)
	endif
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0GS')+" "+UR8(a))//n0GS -> You randomly rolled
endfunction

function XQD takes nothing returns nothing
	set ShowRollNumbers[GetPlayerId(GetTriggerPlayer())]=false
endfunction

function XRD takes nothing returns nothing
	set ShowRollNumbers[GetPlayerId(GetTriggerPlayer())]=true
endfunction

function XFD takes nothing returns nothing
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n090'))//n090 -> Hero names in chat will now be hidden.
	set hhnActive[GetPlayerId(GetTriggerPlayer())]=true
	if GetLocalPlayer()==GetTriggerPlayer()then
		call SetPlayerName(Sentinels[1],PlayerNames[GetPlayerId(Sentinels[1])])
		call SetPlayerName(Sentinels[2],PlayerNames[GetPlayerId(Sentinels[2])])
		call SetPlayerName(Sentinels[3],PlayerNames[GetPlayerId(Sentinels[3])])
		call SetPlayerName(Sentinels[4],PlayerNames[GetPlayerId(Sentinels[4])])
		call SetPlayerName(Sentinels[5],PlayerNames[GetPlayerId(Sentinels[5])])
		call SetPlayerName(Scourges[1],PlayerNames[GetPlayerId(Scourges[1])])
		call SetPlayerName(Scourges[2],PlayerNames[GetPlayerId(Scourges[2])])
		call SetPlayerName(Scourges[3],PlayerNames[GetPlayerId(Scourges[3])])
		call SetPlayerName(Scourges[4],PlayerNames[GetPlayerId(Scourges[4])])
		call SetPlayerName(Scourges[5],PlayerNames[GetPlayerId(Scourges[5])])
	endif
endfunction

function XGD takes nothing returns nothing
	local integer id=GetPlayerId(GetTriggerPlayer())
	if SoundsMuted[id] then
		set SoundsMuted[id]=false
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08T'))//n08T -> Sounds have now be unmuted for you.
	else
		set SoundsMuted[id]=true
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n091'))//n091 -> Sounds have now be muted for you.
	endif
endfunction

function ShowSpellInfo takes nothing returns nothing
	local integer id=GetPlayerId(GetTriggerPlayer())
	set ItemInfoShown[id]=false
	set SpellInfoShown[id]=true
endfunction

function XBD takes nothing returns nothing
	local integer id=GetPlayerId(GetTriggerPlayer())
	set ItemInfoShown[id]=true
	set SpellInfoShown[id]=false
endfunction

function XJD takes nothing returns nothing
	local integer i=1
	local player p
	local real ZMD
	loop
		exitwhen i>5
		set p=Sentinels[i]
		if IsPlayer(p)then
			set ZMD=PlayerAPM[GetPlayerId(p)]/(TimerGetElapsed(GlobalTimer))*60
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n084')+" "+R2S(ZMD))//n084 -> has an APM of
		endif
		set p=Scourges[i]
		if IsPlayer(p)then
			set ZMD=PlayerAPM[GetPlayerId(p)]/(TimerGetElapsed(GlobalTimer))*60
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n084')+" "+R2S(ZMD))//n084 -> has an APM of
		endif
		set i=i+1
	endloop
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.," ")
	set p=null
endfunction

function XKD takes nothing returns nothing
	call BL8(GetTriggerPlayer())
	if GetTriggerEventId()==EVENT_PLAYER_END_CINEMATIC then
		return
	endif
	set ClearCounter[GetPlayerId(GetTriggerPlayer())]=ClearCounter[GetPlayerId(GetTriggerPlayer())]+1
	if(ClearCounter[GetPlayerId(GetTriggerPlayer())]==1)then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"Use command |c00ff0505-fc|r to reduce the duration of kill messages")
	endif
endfunction

function ZPD takes player whichPlayer returns nothing
	local integer ZQD
	local player ZRD
	set ZQD=0
	loop
		set ZRD=Player(ZQD)
		if(PlayersAreCoAllied(whichPlayer,ZRD)and whichPlayer!=ZRD)then
			call SetPlayerAlliance(whichPlayer,ZRD,ALLIANCE_SHARED_VISION,true)
			call SetPlayerAlliance(whichPlayer,ZRD,ALLIANCE_SHARED_CONTROL,true)
			call SetPlayerAlliance(ZRD,whichPlayer,ALLIANCE_SHARED_CONTROL,true)
		endif
		set ZQD=ZQD+1
		exitwhen ZQD==12
	endloop
	set ZRD=null
endfunction

function KickafkChatCmd takes nothing returns nothing
	local integer ZG8=S2I(SubString(GetEventPlayerChatString(),9,StringLength(GetEventPlayerChatString())))
	local integer i=1
	local player p
	local string Time
	if AFK_Check then
		if(SecondsForTime<10)then
			set Time=I2S(MinutesForTime)+":0"+I2S(SecondsForTime)
		else
			set Time=I2S(MinutesForTime)+":"+I2S(SecondsForTime)
		endif
		if ZG8<1 or A47[ZG8]==false then
			loop
				exitwhen i>5
				set p=Sentinels[i]
				if IsPlayer(p)and((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])>300. and A47[GetPlayerId(p)]==false and b_isPickTime==false then
					set A47[GetPlayerId(p)]=true
					call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05G')+" "+R2S(((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))//n05G -> has been afk for more than
					call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.,GetObjectName('n05O')+" |cff99ccff-kickafk "+I2S(GetPlayerId(p))+" |r "+GetObjectName('n05P'))//n05O -> You may type, n05P -> to boot this player from the game
					call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.," ")
				endif
				set p=Scourges[i]
				if IsPlayer(p)and((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])>300. and A47[GetPlayerId(p)]==false and b_isPickTime==false then
					set A47[GetPlayerId(p)]=true
					call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05G')+" "+R2S(((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))//n05G -> has been afk for more than
					call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.,GetObjectName('n05O')+" |cff99ccff-kickafk "+I2S(GetPlayerId(p))+" |r "+GetObjectName('n05P'))//n05O -> You may type, n05P -> to boot this player from the game
					call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.," ")
				endif
				set i=i+1
			endloop
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.," ")
		elseif IsPlayer(Player(ZG8)) and IsPlayerAlly(GetTriggerPlayer(),Player(ZG8)) then
			call DisplayTimedTextToPlayer(Player(ZG8),0,0,3600,"|c00ff0303"+GetObjectName('n05E')+"|r")//n05E -> has been booted for being afk too long!
			call I69(Player(ZG8))
			set LeftAt[GetPlayerId(Player(ZG8))]="|c00555555"+Time+"|r"
			call RemovePlayer(Player(ZG8),PLAYER_GAME_RESULT_DEFEAT)
			call ZPD(Player(ZG8))
			if Mode_SO then
				call CL8(Player(ZG8))
			endif
			set IsPlayerLeftGame[GetPlayerId(Player(ZG8))]=true
			call I39(Player(ZG8))
			call DisplayTimedTextToForceEx(AllPlayers,30.,"|c00ff0303"+(PlayerNames[GetPlayerId((Player(ZG8)))])+" "+GetObjectName('n05E')+"|r")//n05E -> has been booted for being afk too long!
		endif
	endif
	set p=null
endfunction

function XHD takes nothing returns nothing
	local integer i=1
	local player p
	local integer x=0
	if AFK_Check then
		loop
			exitwhen i>5
			set p=Sentinels[i]
			if IsPlayer(p)and((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60>.2 then
				set x=x+1
				call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05D')+" "+R2S(((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))//n05D -> has been afk for
			endif
			set p=Scourges[i]
			if IsPlayer(p)and((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60>.2 then
				set x=x+1
				call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05D')+" "+R2S(((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))//n05D -> has been afk for
			endif
			set i=i+1
		endloop
		if x<1 then
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.,GetObjectName('N05Q'))
		else
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15.," ")
		endif
	endif
	set p=null
endfunction

function HeroGPS takes nothing returns nothing
	local integer i=1
	local player p
	local integer pid
	local integer k=0
	loop
		set k=0
		set p=Sentinels[i]
		if IsPlayer(p)then
			set pid=GetPlayerId(p)
			call Traffic_RegisterData("LoD_HeroX_"+I2S(R2I(GetUnitX(udg_Hero[pid]))),pid)
			call Traffic_RegisterData("LoD_HeroY_"+I2S(R2I(GetUnitY(udg_Hero[pid]))),pid)
		endif
		set p=Scourges[i]
		if IsPlayer(p)then
			set pid=GetPlayerId(p)
			call Traffic_RegisterData("LoD_HeroX_"+I2S(R2I(GetUnitX(udg_Hero[pid]))),pid)
			call Traffic_RegisterData("LoD_HeroY_"+I2S(R2I(GetUnitY(udg_Hero[pid]))),pid)
		endif
		set i=i+1
		exitwhen i>5
	endloop
	
endfunction

function ZSD takes nothing returns boolean
	local integer i=1
	local player p
	local real Time=(TimerGetElapsed(GlobalTimer))
	if AFK_Check then
		loop
			exitwhen i>5
			set p=Sentinels[i]
			if IsPlayer(p)and(Time-LastTimeActivity[GetPlayerId(p)])>300. and A47[GetPlayerId(p)]==false then
				set A47[GetPlayerId(p)]=true
				call DisplayTimedTextToForceEx(Force_Elfs,15,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05G')+" "+R2S((Time-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))//n05G -> has been afk for more than
				call DisplayTimedTextToForceEx(Force_Elfs,15,GetObjectName('n05O')+" |cff99ccff-kickafk "+I2S(GetPlayerId(p))+" |r "+GetObjectName('n05P'))//n05O -> You may type, n05P -> to boot this player from the game
				call DisplayTimedTextToForceEx(Force_Elfs,15," ")
			endif
			set p=Scourges[i]
			if IsPlayer(p)and(Time-LastTimeActivity[GetPlayerId(p)])>300. and A47[GetPlayerId(p)]==false then
				set A47[GetPlayerId(p)]=true
				call DisplayTimedTextToForceEx(Force_Unds,15,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05G')+" "+R2S((Time-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))//n05G -> has been afk for more than
				call DisplayTimedTextToForceEx(Force_Unds,15,GetObjectName('n05O')+" |cff99ccff-kickafk "+I2S(GetPlayerId(p))+" |r "+GetObjectName('n05P'))//n05O -> You may type, n05P -> to boot this player from the game
				call DisplayTimedTextToForceEx(Force_Unds,15," ")
			endif
			set i=i+1
		endloop
	endif
//	if advancedTracking then
//		call HeroGPS()
//	endif
	set p=null
	return false
endfunction

function ZTD takes nothing returns boolean
	local unit u=GetTriggerUnit()
	local player p=GetOwningPlayer(u)
	local integer id=GetIssuedOrderId()
	local player p2
	if p!=Sentinels[0]and p!=Scourges[0]then
		set PlayerAPM[GetPlayerId(p)]=PlayerAPM[GetPlayerId(p)]+1
		if id!=ORDER_attack then
			set LastTimeActivity[GetPlayerId(p)]=TimerGetElapsed(GlobalTimer)
			set A47[GetPlayerId(p)]=false
		endif
		if(id==ORDER_attack or id==851971)and GetOrderTargetItem()!=null then
			if id==ORDER_attack or(id==851971 and LoadBoolean(HY,GetHandleId(GetItemPlayer(GetOrderTargetItem())),139))then
				set p2=GetItemPlayer(GetOrderTargetItem())
				if p2!=p and IsPlayerEnemy(p2,p)==false and IsPlayerLeaver(p2)==false and IsPointInRegion(KK,GetItemX(GetOrderTargetItem()),GetItemY(GetOrderTargetItem())) then
					call DisableTrigger(GetTriggeringTrigger())
					call InterruptUnit(u)
					call Error(p,GetObjectName('n0G7'))//n0G7 -> This Item does not belong to you and cannot be touched
					call EnableTrigger(GetTriggeringTrigger())
				endif
			endif
		endif
	endif
	set u=null
	return false
endfunction

function ZUD takes nothing returns boolean
	return IsCourier(GetFilterUnit())and GetOwningPlayer(GetFilterUnit())==GetTriggerPlayer()
endfunction

function XMD takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,0,0,12000,Condition(function ZUD))
	call KillGroup(g)
	set g=null
endfunction

function ZZD takes string s returns nothing
	call StopMusic(true)
	call PlayMusic(s)
endfunction

function MusicChatCmd takes nothing returns nothing
	local string s=GetEventPlayerChatString()
	local integer VA8=GetRandomInt(1,A87)
	if GetLocalPlayer()==GetTriggerPlayer()then
		if s=="-music off"then
			call StopMusic(false)
		elseif s=="-music random"then
			call ZZD(A77[VA8])
		elseif s=="-music nightelf1"then
			call ZZD(QC)
		elseif s=="-music nightelf2"then
			call ZZD(UC)
		elseif s=="-music nightelf3"then
			call ZZD(ODs)
		elseif s=="-music human1"then
			call ZZD(XC)
		elseif s=="-music human2"then
			call ZZD(YC)
		elseif s=="-music human3"then
			call ZZD(JC)
		elseif s=="-music orc1"then
			call ZZD(BD)
		elseif s=="-music orc2"then
			call ZZD(DD)
		elseif s=="-music orc3"then
			call ZZD(ED)
		elseif s=="-music undead1"then
			call ZZD(IE)
		elseif s=="-music undead2"then
			call ZZD(OE)
		elseif s=="-music undead3"then
			call ZZD(AE)
		elseif s=="-music other1"then
			call ZZD(FD)
		elseif s=="-music other2"then
			call ZZD(GD)
		elseif s=="-music other3"then
			call ZZD(HD)
		elseif s=="-music other4"then
			call ZZD(ZD)
		elseif s=="-music other5"then
			call ZZD(VD)
		elseif s=="-music other6"then
			call ZZD(DF)
		elseif s=="-music other7"then
			call ZZD(EF)
		elseif s=="-music other8"then
			call ZZD(FF)
		elseif s=="-music other9"then
			call ZZD(GF)
		elseif s=="-music special"then
			call ZZD(A97)
		else
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0CW')+" ")//n0CW -> Command is used by typing -music theme. Where theme is one of the following:
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"off, random, nightelf1, nightelf2, nightelf3, human1, human2, human3, orc1, orc2, orc3, undead1, undead2, undead3, other1, other2, other3, other4, other5, other6, other7, other8, other9, special")
		endif
	endif
endfunction

function ZAD takes nothing returns boolean
	set A87=A87+1
	set A77[A87]=QC
	set A87=A87+1
	set A77[A87]=UC
	set A87=A87+1
	set A77[A87]=ODs
	set A87=A87+1
	set A77[A87]=XC
	set A87=A87+1
	set A77[A87]=YC
	set A87=A87+1
	set A77[A87]=JC
	set A87=A87+1
	set A77[A87]=BD
	set A87=A87+1
	set A77[A87]=DD
	set A87=A87+1
	set A77[A87]=ED
	set A87=A87+1
	set A77[A87]=IE
	set A87=A87+1
	set A77[A87]=OE
	set A87=A87+1
	set A77[A87]=AE
	set A87=A87+1
	set A77[A87]=FD
	set A87=A87+1
	set A77[A87]=GD
	set A87=A87+1
	set A77[A87]=HD
	set A87=A87+1
	set A77[A87]=ZD
	set A87=A87+1
	set A77[A87]=VD
	set A87=A87+1
	set A77[A87]=DF
	set A87=A87+1
	set A77[A87]=EF
	set A87=A87+1
	set A77[A87]=FF
	set A87=A87+1
	set A77[A87]=GF
	set A87=A87+1
	set A77[A87]=A97
	return false
endfunction

function ZBD takes player p,integer r,integer g,integer b,integer a returns nothing
	if GetLocalPlayer()==p then
		call SetWaterBaseColor(r,g,b,a)
	endif
endfunction

function ZCD takes string s returns nothing
	local string Z3D=""
	local string Z6D=""
	local string ZLD=""
	local integer i=0
	local integer E29=StringLength(s)
	local integer Z1D=1
	loop
		exitwhen i>E29
		if SubString(s,i,i+1)==" "then
			set Z1D=Z1D+1
		else
			if Z1D==1 then
				set Z3D=Z3D+SubString(s,i,i+1)
			elseif Z1D==2 then
				set Z6D=Z6D+SubString(s,i,i+1)
			else
				set ZLD=ZLD+SubString(s,i,i+1)
			endif
		endif
		set i=i+1
	endloop
	set AE7=S2I(Z3D)
	set AF7=S2I(Z6D)
	set AG7=S2I(ZLD)
endfunction

function WaterChatCmd takes nothing returns nothing
	local string Z0D=SubString(GetEventPlayerChatString(),7,StringLength(GetEventPlayerChatString()))
	local player p=GetTriggerPlayer()
	local integer r
	local integer g
	local integer b
	set CustomWaterColor[GetPlayerId(p)]=true
	if Z0D=="red"then
		call ZBD(p,255,0,0,255)
	elseif Z0D=="blue"then
		call ZBD(p,0,0,255,255)
	elseif Z0D=="green"then
		call ZBD(p,0,255,0,255)
	elseif Z0D=="default"then
		call ZBD(p,0,0,255,255)
	elseif Z0D=="random"then
		set r=GetRandomInt(0,255)
		set g=GetRandomInt(0,255)
		set b=GetRandomInt(0,255)
		call ZBD(p,r,g,b,255)
		call DisplayTimedTextToPlayer(p,0,0,5,GetObjectName('n0HD')+" r="+I2S(r)+" g="+I2S(g)+" b="+I2S(b))//n0HD -> You have randomly set water colors to
	else
		call ZCD(Z0D)
		set r=AE7
		set g=AF7
		set b=AG7
		if r==0 and g==0 and b==0 and Z0D!="0 0 0"then
			return
		endif
		if r>=0 and r<=255 and g>=0 and g<=255 and b>=0 and b<=255 then
			call ZBD(p,r,g,b,255)
		endif
	endif
	set p=null
endfunction

function XXD takes nothing returns boolean
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10.,"Total Bonus XP/Gold: "+I2S(AssistsBonusExpCounter[GetPlayerId(GetTriggerPlayer())])+"/"+I2S(AssistsBonusGoldCounter[GetPlayerId(GetTriggerPlayer())]))
	return false
endfunction

function SFSoulsStats takes player p returns nothing
	local unit Hero=udg_Hero[GetPlayerId(p)]
	local integer i=GetUnitAbilityLevel(Hero,'A0CQ')-1//A0CQ -> Necromastery Effect
	local integer souls=0
	local integer Level=GetUnitAbilityLevel(Hero,'A0BR')//A0BR -> Necromastery
	if Level==1 then
		set souls=12
	elseif Level==2 then
		set souls=20
	elseif Level==3 then
		set souls=28
	elseif Level==4 then
		set souls=36
	endif
	set i=IMaxBJ(IMinBJ(i,souls),0)
	if isPlayerPickedAbility(p,318)and i>0 then
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0KE')+" "+I2S(i)+"/"+I2S(souls))//n0KE -> Souls Collected:
	endif
	set Hero=null
endfunction

function X5D takes nothing returns boolean
	local player p=GetTriggerPlayer()
	local integer pid=GetPlayerId(p)
	local integer h=GetHandleId(p)
	local integer i
	local integer k
	if E48>0 then
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0LO')+": "+I2S(E48))//n0LO -> Total Bounty Gold
	endif
	if LoadInteger(HeroStats,h,'DUEL')>0 then
		call DisplayTimedTextToPlayer(p,0,0,10.,"Duels: "+I2S(LoadInteger(HeroStats,h,'DUEL'))+" wins, "+I2S(LoadInteger(HeroStats,h,'DDUE'))+" bonus damage")
	endif
	if LoadInteger(MHT,h,'A0O3')>0 then//A0O3 -> Goblin's Greed
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0GQ')+" "+I2S(LoadInteger(MHT,h,'A0O3')))//n0GQ -> Goblins Greed:, A0O3 -> Goblin's Greed
	endif
	set i=LoadInteger(HeroStats,h,'ARRH')
	set k=LoadInteger(HeroStats,h,'ARRS')
	if k>0 then
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0GM')+" "+R2S(I2R(i)/ I2R(k)*100)+"% ("+I2S(i)+"/"+I2S(k)+")")//n0GM -> Arrow Accuracy:
	endif
	if LoadInteger(HeroStats,pid,'MC_T')>0 then
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0JH')+" "+I2S(LoadInteger(HeroStats,pid,'MC_T')))//n0JH -> Total Attempts:
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0JM')+" "+I2S(LoadInteger(HeroStats,pid,'MC_2')+LoadInteger(HeroStats,pid,'MC_3')+LoadInteger(HeroStats,pid,'MC_4'))+" ("+I2S((LoadInteger(HeroStats,pid,'MC_2')+LoadInteger(HeroStats,pid,'MC_3')+LoadInteger(HeroStats,pid,'MC_4'))*100/ LoadInteger(HeroStats,pid,'MC_T'))+"%)")//n0JM -> Total Successful:
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0JL')+" "+I2S(LoadInteger(HeroStats,pid,'MC_2'))+" ("+I2S(100*LoadInteger(HeroStats,pid,'MC_2')/ LoadInteger(HeroStats,pid,'MC_T'))+"%)")//n0JL -> 2x Casts:
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0JK')+" "+I2S(LoadInteger(HeroStats,pid,'MC_3'))+" ("+I2S(100*LoadInteger(HeroStats,pid,'MC_3')/ LoadInteger(HeroStats,pid,'MC_T'))+"%)")//n0JK -> 3x Casts:
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0JJ')+" "+I2S(LoadInteger(HeroStats,pid,'MC_4'))+" ("+I2S(100*LoadInteger(HeroStats,pid,'MC_4')/ LoadInteger(HeroStats,pid,'MC_T'))+"%)")//n0JJ -> 4x Casts:
	endif
	if StolenInt[pid]>0 then
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0HM')+" "+I2S(StolenInt[pid]))//n0HM -> Total Intelligence Stolen:
	endif
	call SFSoulsStats(p)
	if LoadInteger(MHT,GetHandleId(udg_Hero[pid]),'A06D')>0 then
		call DisplayTimedTextToPlayer(p,0,0,10.,"Flesh Heap victims count : "+I2S(FleshHeapCount[pid]))
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n09R')+" "+I2S(LoadInteger(MHT,GetHandleId(udg_Hero[pid]),'A06D'))+" "+GetObjectName('n09S'))//n09R -> You gained, A06D -> Flesh Heap, n09S -> str from Flesh Heap
	endif
	set i=LoadInteger(HeroStats,h,'HK_H')
	set k=LoadInteger(HeroStats,h,'HK_T')
	if k>0 then
		call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0EL')+" "+R2S(I2R(i)/ I2R(k)*100)+"% ("+I2S(i)+"/"+I2S(k)+")")//n0EL -> Hook Accuracy:
	endif
	if TrackBonusBounty[pid]>0 then
		call DisplayTimedTextToPlayer(p,0,0,10,"Track bonus gold: "+I2S(TrackBonusBounty[pid]))
	endif
	
	return false
endfunction

function Z5D takes player p1 returns string
	local string s=GetObjectName('n0GB')//n0GB -> $p1 $c1has rejected the switch offer.
	set s=str_replace(s,"$c1","|c00ff0303")
	set s=str_replace(s,"$p1",udg_Colors[GetPlayerId(p1)]+(PlayerNames[GetPlayerId((p1))])+"|r")
	return s
endfunction

function Z2D takes nothing returns string
	local string s=GetObjectName('n0GA')//$c1If you want veto this, type |r $c2-no|r//n0GA -> $c1If you want veto this, type |r $c2-no|r
	set s=str_replace(s,"$c1","|c006699CC")
	set s=str_replace(s,"$c2","|c00ff0303")
	return s
endfunction

function A4D takes nothing returns nothing
	local integer i=1
	local unit Hero
	if MK then
		loop
			exitwhen i>5
			set Hero=udg_Hero[GetPlayerId(Sentinels[i])]
			if Hero!=null then
				if LK==2 then
					call RestoreUnitColor(Hero)
				endif
				call UnitSetUsesAltIcon(Hero,false)
			endif
			set Hero=udg_Hero[GetPlayerId(Scourges[i])]
			if Hero!=null then
				if LK==2 then
					call RestoreUnitColor(Hero)
				endif
				call UnitSetUsesAltIcon(Hero,false)
			endif
			set i=i+1
		endloop
		set Hero=null
	endif
endfunction

function A7D takes player p1,player p2 returns string
	local string s=GetObjectName('n0G2')//$c1Type|r $c2-switch accept|r $c1or|r $c2-ok|r $c1to allow|r $p1 $c1to switch with|r $p2//n0G2 -> $c1Type|r $c2-switch accept|r $c1or|r $c2-ok|r $c1to allow|r $p1 $c1to switch with|r $p2
	set s=str_replace(s,"$c1","|c006699CC")
	set s=str_replace(s,"$c1","|c006699CC")
	set s=str_replace(s,"$c1","|c006699CC")
	set s=str_replace(s,"$c1","|c006699CC")
	set s=str_replace(s,"$c2","|c00ff0303")
	set s=str_replace(s,"$c2","|c00ff0303")
	set s=str_replace(s,"$p1",udg_Colors[GetPlayerId(p1)]+(PlayerNames[GetPlayerId((p1))])+"|r")
	set s=str_replace(s,"$p2",udg_Colors[GetPlayerId(p2)]+(PlayerNames[GetPlayerId((p2))])+"|r")
	return s
endfunction

function A8D takes string A9D,string ADD returns string
	local string s=GetObjectName('n0FV')//n0FV -> $c1The switch process between|r $p1 $c1and|r $p2 $c1has been completed successfully|r
	set s=str_replace(s,"$c1","|c006699CC")
	set s=str_replace(s,"$c1","|c006699CC")
	set s=str_replace(s,"$c1","|c006699CC")
	set s=str_replace(s,"$c1","|c006699CC")
	set s=str_replace(s,"$p1",A9D)
	set s=str_replace(s,"$p2",ADD)
	return s
endfunction

function AED takes player p2 returns string
	local string s=GetObjectName('n0FS')//n0FS -> $c1You have requested to switch places with|r $p2
	set s=str_replace(s,"$p2",udg_Colors[GetPlayerId(p2)]+(PlayerNames[GetPlayerId((p2))])+"|r")
	set s=str_replace(s,"$c1","|c006699CC")
	return s
endfunction

function AFD takes player p returns nothing
	local integer VT8
	local integer VU8
	if(IsSentinel(p))then
		set VT8=1
		set VU8=5
		loop
			exitwhen VT8>VU8
			if(Sentinels[VT8]!=p)then
				if(IsPlayer(Sentinels[VT8]))then
					call SetPlayerAllianceStateBJ(p,Sentinels[VT8],4)
				endif
			endif
			set VT8=VT8+1
		endloop
	else
		set VT8=1
		set VU8=5
		loop
			exitwhen VT8>VU8
			if(Scourges[VT8]!=p)then
				if(IsPlayer(Scourges[VT8]))then
					call SetPlayerAllianceStateBJ(p,Scourges[VT8],4)
				endif
			endif
			set VT8=VT8+1
		endloop
	endif
endfunction

function AGD takes nothing returns nothing
	if GetOwningPlayer(GetEnumUnit())==FM then
		call SetUnitOwner(GetEnumUnit(),GM,true)
	elseif GetOwningPlayer(GetEnumUnit())==GM then
		call SetUnitOwner(GetEnumUnit(),FM,true)
	endif
endfunction

function AHD takes unit u,player p returns nothing
	local real x1
	local real y1
	local real x2
	local real y2
	local integer i
	local item Item
	if IsSentinel(p)then
		set x1=GetRectCenterX(gg_rct_Hero_Creation_UD)
		set y1=GetRectCenterY(gg_rct_Hero_Creation_UD)
		set x2=GetRectCenterX(gg_rct_Hero_Creation_NE)
		set y2=GetRectCenterY(gg_rct_Hero_Creation_NE)
	else
		set x1=GetRectCenterX(gg_rct_Hero_Creation_NE)
		set y1=GetRectCenterY(gg_rct_Hero_Creation_NE)
		set x2=GetRectCenterX(gg_rct_Hero_Creation_UD)
		set y2=GetRectCenterY(gg_rct_Hero_Creation_UD)
	endif
	call SetUnitX(u,x1)
	call SetUnitY(u,y1)
	if IsCourier(u)then
		call IssueImmediateOrderById(u,852246)
	endif
	if IsUnitType(u,UNIT_TYPE_HERO) then
		call SaveBoolean(HY,(GetHandleId(u)),140,(true))
		call SaveInteger(HY,(GetHandleId((u))),(4259),2)
		call UnitRemoveAbility(u,'A04R')//
		call SetUnitInvulnerable(u,false)
		call PauseUnit(u,false)
		set i=0
		loop
			exitwhen i>5
			set Item=UnitItemInSlot(u,i)
			if GetUnitTypeId(u)!='H00J' and Item!=null and(GetItemPlayer(Item)!=GetOwningPlayer(u)and GetIndex(Item)!=DivineRapier and GetIndex(Item)!=DivineRapierFree)and GetItemTypeId(Item)!=Item_Real[Aegis]then//H00J -> Geomancer
				call UnitRemoveItem(u,Item)
			endif
			set i=i+1
		endloop
	endif
	call SetUnitX(u,x2)
	call SetUnitY(u,y2)
	call SetUnitColor(u,GetPlayerColor(p))
	set Item=null
endfunction

function AID takes nothing returns boolean
	if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) or IsCourier(GetFilterUnit())then
		call AHD(GetFilterUnit(),WM)
	elseif GetUnitTypeId(GetFilterUnit())=='ncop' then//ncop -> Circle of Power
		call IssueImmediateOrderById(GetFilterUnit(),852246)//drop item from circle
	elseif GetUnitTypeId(GetFilterUnit())=='u00B' then//u00B -> ObserverTruesight
		return true
	endif
	return false
endfunction

function AJD takes item i,player p returns nothing
	local real x
	local real y
	if IsSentinel(p)then
		set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
		set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
	else
		set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
		set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
	endif
	call SetItemPosition(i,x,y)
endfunction

function AKD takes nothing returns nothing
	if GetItemPlayer(GetEnumItem())==WM then
		call AJD(GetEnumItem(),WM)
	endif
endfunction

function AMD takes player p1,player p2 returns nothing
	local group g1=GetAvailableGroup()
	local group g2=GetAvailableGroup()
	set WM=p1
	set tt_player1=p2
	call GroupEnumUnitsOfPlayer(g1,p1,Condition(function AID))
	set WM=p2
	set tt_player1=p1
	call GroupEnumUnitsOfPlayer(g2,p2,Condition(function AID))
	call ForGroup(g1,function AGD)
	call ForGroup(g2,function AGD)
	set WM=p1
	call EnumItemsInRect(GetWorldBounds(),Condition(function ReturnTrue),function AKD)
	set WM=p2
	call EnumItemsInRect(GetWorldBounds(),Condition(function ReturnTrue),function AKD)
	call KillGroup(g1)
	call KillGroup(g2)
	set g1=null
	set g2=null
endfunction

function SwitchActFunc takes player p1,player p2 returns nothing
	local integer x
	local integer y
	local integer i
	local integer i1
	local integer i2
	local real x1
	local real y1
	local real x2
	local real y2
	local player p
	local string A9D=udg_Colors[GetPlayerId(p1)]+(PlayerNames[GetPlayerId((p1))])+"|r"
	local string ADD=udg_Colors[GetPlayerId(p2)]+(PlayerNames[GetPlayerId((p2))])+"|r"
	local integer YND
	local integer AOD
	local integer APD
	set YND=ReliableGold[GetPlayerId(p1)]
	set ReliableGold[GetPlayerId(p1)]=ReliableGold[GetPlayerId(p2)]
	set ReliableGold[GetPlayerId(p2)]=YND
	call Traffic_RegisterData("SWITCH_"+I2S(GetPlayerId(p1))+"_"+I2S(GetPlayerId(p2)),0)
	call Traffic_RegisterData("SWITCH_"+I2S(GetPlayerId(p2))+"_"+I2S(GetPlayerId(p1)),0)
	if IsSentinel(p1)then
		set x1=GetRectCenterX(gg_rct_Hero_Creation_UD)
		set y1=GetRectCenterY(gg_rct_Hero_Creation_UD)
	else
		set x1=GetRectCenterX(gg_rct_Hero_Creation_NE)
		set y1=GetRectCenterY(gg_rct_Hero_Creation_NE)
	endif
	if IsSentinel(p2)then
		set x2=GetRectCenterX(gg_rct_Hero_Creation_UD)
		set y2=GetRectCenterY(gg_rct_Hero_Creation_UD)
	else
		set x2=GetRectCenterX(gg_rct_Hero_Creation_NE)
		set y2=GetRectCenterY(gg_rct_Hero_Creation_NE)
	endif
	set i=1
	loop
		exitwhen i>5
		if Sentinels[i]==p1 or Scourges[i]==p1 then
			set i1=i
		endif
		if Sentinels[i]==p2 or Scourges[i]==p2 then
			set i2=i
		endif
		set i=i+1
	endloop
	if IsSentinel(p1)then
		set Scourges[i2]=p1
		set Sentinels[i1]=p2
	else
		set Sentinels[i2]=p1
		set Scourges[i1]=p2
	endif
	call SetPlayerTeam(Sentinels[0],0)
	call SetPlayerTeam(Sentinels[1],0)
	call SetPlayerTeam(Sentinels[2],0)
	call SetPlayerTeam(Sentinels[3],0)
	call SetPlayerTeam(Sentinels[4],0)
	call SetPlayerTeam(Sentinels[5],0)
	call SetPlayerTeam(Scourges[0],1)
	call SetPlayerTeam(Scourges[1],1)
	call SetPlayerTeam(Scourges[2],1)
	call SetPlayerTeam(Scourges[3],1)
	call SetPlayerTeam(Scourges[4],1)
	call SetPlayerTeam(Scourges[5],1)
	call HK9()
	set x=0
	set y=0
	loop
		exitwhen x>5
		loop
			exitwhen y>5
			call SetPlayerAllianceStateBJ(Sentinels[x],Sentinels[y],3)
			call SetPlayerAllianceStateBJ(Scourges[x],Scourges[y],3)
			call SetPlayerAllianceStateBJ(Sentinels[x],Scourges[y],0)
			call SetPlayerAllianceStateBJ(Scourges[x],Sentinels[y],0)
			set y=y+1
		endloop
		set y=0
		set x=x+1
	endloop
	call ForceClear(Force_Elfs)
	call ForceClear(Force_Unds)
	call ForceAddPlayer(Force_Elfs,Sentinels[0])
	call ForceAddPlayer(Force_Elfs,Sentinels[1])
	call ForceAddPlayer(Force_Elfs,Sentinels[2])
	call ForceAddPlayer(Force_Elfs,Sentinels[3])
	call ForceAddPlayer(Force_Elfs,Sentinels[4])
	call ForceAddPlayer(Force_Elfs,Sentinels[5])
	call ForceAddPlayer(Force_Unds,Scourges[0])
	call ForceAddPlayer(Force_Unds,Scourges[1])
	call ForceAddPlayer(Force_Unds,Scourges[2])
	call ForceAddPlayer(Force_Unds,Scourges[3])
	call ForceAddPlayer(Force_Unds,Scourges[4])
	call ForceAddPlayer(Force_Unds,Scourges[5])
	call ExecuteFunc("HM9")
	call AMD(p1,p2)
	set YM=true
	if AbilityDraftMultiboard==null then
		call PanCameraToTimedForPlayer(p1,x1,y1,0)
		call PanCameraToTimedForPlayer(p2,x2,y2,0)
	endif
	call StorePlayersColorValues()
	set BM=false
	if XM!=null then
		call TriggerEvaluate(XM)
	endif
	if GetPlayerSlotState(p2)==PLAYER_SLOT_STATE_EMPTY then
		set PlayerNames[GetPlayerId(p2)]=GetPlayerName(p2)
		set PlayerNamesHashes[i]=StringHash(PlayerNames[GetPlayerId(p2)])
	endif
	set i=1
	loop
		exitwhen i>5
		set p=Sentinels[i]
		if IsPlayerLeaver(p)then
			call AFD(p)
		endif
		set p=Scourges[i]
		if IsPlayerLeaver(p)then
			call AFD(p)
		endif
		set i=i+1
	endloop
	call A4D()
	call Trig_display_leaderboard_Actions()
	call ClearTextMessages()
	call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20," ")
	call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20,A8D(A9D,ADD))
	call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20," ")
	call GP9(p1)
	call GP9(p2)
	set AOD=RH8(GetPlayerId(p1))
	set APD=RH8(GetPlayerId(p2))
	set YND=PlayersId[AOD]
	set PlayersId[AOD]=PlayersId[APD]
	set PlayersId[APD]=YND
	set PlayerFFed[GetPlayerId(p1)]=false
	set PlayerFFed[GetPlayerId(p2)]=false
	if AbilityDraftMultiboard!=null then
		call UpdateSkillPickingMB_Switch()
	endif
	set p=null
endfunction

function AQD takes nothing returns nothing
	local integer i=1
	local player p
	set JM=0
	set KM=0
	loop
		exitwhen i>5
		set p=Sentinels[i]
		if IsPlayer(p)then
			set KM=KM+1
			if HM[GetPlayerId(p)] then
				set JM=JM+1
			endif
		endif
		set p=Scourges[i]
		if IsPlayer(p)then
			set KM=KM+1
			if HM[GetPlayerId(p)] then
				set JM=JM+1
			endif
		endif
		set i=i+1
	endloop
	set p=null
endfunction

function ARD takes nothing returns nothing
	set BM=false
	if XM!=null then
		call TriggerEvaluate(XM)
	endif
	call ClearTextMessages()
	call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20,Z5D(GetTriggerPlayer()))
endfunction

function ASD takes nothing returns nothing
	local integer i=1
	local player p
	local integer ATD=0
	local integer AUD=0
	local integer AVD=0
	if HM[GetPlayerId(GetTriggerPlayer())]==false then
		set HM[GetPlayerId(GetTriggerPlayer())]=true
		call AQD()
		call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r|c006699CC "+GetObjectName('n0FT')+"|r ("+I2S(JM)+"/"+I2S(KM)+")")//n0FT -> has accepted the switch offer
	endif
	loop
		exitwhen i>5
		set p=Sentinels[i]
		if IsPlayer(p)and HM[GetPlayerId(p)]==false then
			set ATD=ATD+1
			set AVD=AVD+1
		endif
		if IsPlayer(p)and HM[GetPlayerId(p)] then
			set AUD=AUD+1
			set AVD=AVD+1
		endif
		set p=Scourges[i]
		if IsPlayer(p)and HM[GetPlayerId(p)]==false then
			set ATD=ATD+1
			set AVD=AVD+1
		endif
		if IsPlayer(p)and HM[GetPlayerId(p)] then
			set AUD=AUD+1
			set AVD=AVD+1
		endif
		set i=i+1
	endloop
	if ATD<2 and AUD>=R2I(AVD/ 2)then
		if(AVD==2 and AUD>1)or AVD!=2 then
			call SwitchActFunc(FM,GM)
		endif
	endif
	set p=null
endfunction

function AWD takes nothing returns nothing
	local integer i=1
	local player p=GetTriggerPlayer()
	local player AXD
	local string s
	local string s2
	loop
		exitwhen i>5
		set s=""
		set s2=""
		if IsSentinel(p)then
			set AXD=Scourges[i]
		else
			set AXD=Sentinels[i]
		endif
		if GetPlayerSlotState(AXD)==PLAYER_SLOT_STATE_LEFT and GetPlayerController(AXD)==MAP_CONTROL_USER then
			set s="|c00ff0303["+GetObjectName('n0FY')+"]|r"//n0FY -> Left
		endif
		if udg_Hero[GetPlayerId(AXD)]!=null then
			set s2=" ("+GetUnitName(udg_Hero[GetPlayerId(AXD)])+")"
		endif
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15,GetObjectName('n083')+"|c006699CC "+"-switch "+I2S(i)+"|r "+GetObjectName('n0FQ')+" "+udg_Colors[GetPlayerId(AXD)]+(PlayerNames[GetPlayerId((AXD))])+s2+"|r "+s)//n083 -> Type, n0FQ -> to switch with
		set i=i+1
	endloop
	set p=null
endfunction

function AYD takes nothing returns boolean
	local integer i=0
	if BM then
		call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20,"|c00ff0303"+GetObjectName('n0FU')+"|r")//n0FU -> Switch time has expired without enough votes
	endif
	set SwitchUnlockingAvailable=true
	set BM=false
	set FM=null
	set GM=null
	loop
		exitwhen i>16
		set HM[i]=false
		set i=i+1
	endloop
	call CleanTrigger(GetTriggeringTrigger())
	set XM=null
	return false
endfunction

function AZD takes player p1,player p2 returns nothing
	local trigger t=CreateTrigger()
	local integer i=0
	local string s
	local string OZD
	local string msg2
	local string msg3
	local player p
	local string s2
	set SwitchUnlockingAvailable=false
	set BM=true
	set FM=p1
	set GM=p2
	loop
		exitwhen i>16
		set HM[i]=false
		set i=i+1
	endloop
	set HM[GetPlayerId(FM)]=true
	call TriggerRegisterTimerEvent(t,60,false)
	call TriggerAddCondition(t,Condition(function AYD))
	set XM=t
	set s=A7D(p1,p2)
	set s2=Z2D()
	set i=1
	loop
		exitwhen i>5
		set p=Sentinels[i]
		if p!=p1 then
			call DisplayTimedTextToPlayer(p,0,0,20,s)
			call DisplayTimedTextToPlayer(p,0,0,20,s2)
		endif
		set p=Scourges[i]
		if p!=p1 then
			call DisplayTimedTextToPlayer(p,0,0,20,s)
			call DisplayTimedTextToPlayer(p,0,0,20,s2)
		endif
		set i=i+1
	endloop
	set s=AED(p2)
	call DisplayTimedTextToPlayer(p1,0,0,20,s)
	set t=null
	set p=null
endfunction

function SwitchChatCmd takes nothing returns nothing
	if Mode_SO==false then
		call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0GX'))//n0GX -> -switch has been disabled for this game.
		return
	endif
	if GetEventPlayerChatString()=="-switch accept"or GetEventPlayerChatString()=="-ok"then
		if BM then
			call ASD()
		endif
	elseif GetEventPlayerChatString()=="-no"then
		if BM then
			call ARD()
		endif
	elseif GetEventPlayerChatString()=="-switch"then
		if BM==false then
			call AWD()
		endif
	elseif BM==false then
		set VM=S2I(SubString(GetEventPlayerChatString(),8,StringLength(GetEventPlayerChatString())))
		if VM>0 and VM<6 then
			if IsSentinel(GetTriggerPlayer())then
				if HeroHasBeenUnlocked[GetPlayerId(Scourges[VM])]==false then
					call AZD(GetTriggerPlayer(),Scourges[VM])
				else
					call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0HY'))//The enemy team has unlocked that hero's items. He cannot be switched.//n0HY -> The enemy team has unlocked that hero's items. He cannot be switched.
				endif
			else
				if HeroHasBeenUnlocked[GetPlayerId(Sentinels[VM])]==false then
					call AZD(GetTriggerPlayer(),Sentinels[VM])
				else
					call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0HY'))//n0HY -> The enemy team has unlocked that hero's items. He cannot be switched.
				endif
			endif
		endif
	endif
endfunction

function X0D takes nothing returns nothing
	call SetUnitAnimation(udg_Hero[GetPlayerId(GetTriggerPlayer())],"sleep")
endfunction

function X2D takes nothing returns nothing
	call SetUnitAnimationByIndex(udg_Hero[GetPlayerId(GetTriggerPlayer())],23)
endfunction

function RemindAboutSP takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer i=1
	local player p
	loop
		set p=Player(i)
		if HidePassivesForPlayer[i]==false then
			call DisplayTimedTextToPlayer(p,0,0,15,"|c006699CCTIP: Hide passive spells by writing -SP (You can still level them)|r")
		endif
		set i=i+1
		exitwhen i>11
	endloop
	call DestroyTimer(t)
	set t=null
endfunction

function RemindAboutSI takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer i=1
	local player p
	loop
		set p=Player(i)
		if SpellInfoShown[i]==false then
			call DisplayTimedTextToPlayer(p,0,0,15,"|c006699CCTIP: View your allies' spells in the scoreboard by writing -SI|r")
		endif
		
		set i=i+1
		exitwhen i>11
	endloop
	call DestroyTimer(t)
	set t=null
endfunction

function ModePicked takes nothing returns nothing
	local trigger t
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.25,true)
	call TriggerAddCondition(t,Condition(function RTD))
	set NK=CreateTimer()
	if b_isPickTime then
		if s_MainMode=="sd" then
			set CreepSpawnTime=CreepSpawnTimeForSD+(NumberOfExtraAbilities*30)
		elseif s_MainMode=="md" then
			set CreepSpawnTime=CreepSpawnTimeForMD+(NumberOfExtraAbilities*30)
		elseif s_MainMode=="ap" then
			set CreepSpawnTime=baseCreepSpawnTime+(NumberOfExtraAbilities*30)
		else
			set CreepSpawnTime=90
		endif
		if Mode_RA then
			set CreepSpawnTime=CreepSpawnTime-(NumberOfExtraAbilities*30)
		endif
	else
		if s_MainMode=="rd"then
			set CreepSpawnTime=CreepSpawnTimeForRD
		else
			set CreepSpawnTime=90
		endif
	endif
	call TimerStart(NK,CreepSpawnTime+1,false,function HelpPlayerIfNotReady)
	
	set TIMERIMG[1]=false
	set TIMERIMG[2]=false
	set TIMERIMG[3]=false
	if Mode_AR==false and Mode_RD==false then
		call ExecuteFunc("ShowTimersInit")
	endif
	set t=null
endfunction

function Reduced_Spell takes integer spell returns boolean
	return spell=='A0FW' or spell=='A0GP' or spell=='A1EL' or spell=='A2BE' or spell=='A1S4' or spell=='A020' or spell=='A02Z'//A0FW -> Viscous Nasal Goo, A0GP -> Quill Spray, A1EL -> Sticky Napalm, A2BE -> Arcane Bolt, A1S4 -> Shadow Poison, A020 -> Arc Lightning, A02Z -> Life Drain
endfunction

function Reduced_Spell_Proc takes unit u, integer spell returns nothing//boolean
	local integer info = GetHandleId(u)
	local boolean b = LoadBoolean(MHT,info,spell)
	call SaveBoolean(MHT,info,spell,b==false)
	//return b==false
endfunction

function Semi_Valid_Spell takes integer spell returns boolean
	if Reduced_Spell(spell)then
		return LoadBoolean(MHT,GetHandleId(GetTriggerUnit()),spell)
	endif
	return true
endfunction

function isItemSpellOrNoCd takes integer x returns boolean
	return x=='A3FJ' or x=='QM01' or x=='A0JT' or x=='A2TH' or x=='A0DI' or x=='A231' or x=='A1ZH' or x=='A1ZI' or x=='A1ZW' or x=='A28D' or x=='A2KG' or x=='A2K3' or x=='A2EA' or x=='A2K1' or x=='A2K4' or x=='A2K7' or x=='A06X' or x=='A0AQ' or x=='A14O' or x=='A0NE' or x=='A1C0' or x=='A418' or x=='A0K7' or x=='A1AC' or x=='A1QD' or x=='A0JL' or x=='AIpg' or x=='A11F' or x=='A0T9' or x=='A1T7' or x=='AIcy' or x=='A19M' or x=='A02O' or x=='A0FD' or x=='AChx' or x=='A1EW' or x=='A332' or x=='A2N1' or x=='A590' or x=='A591' or x=='A592' or x=='A593' or x=='A02Z' or x=='A0GC'
	//QM01 -> Spirit Form, A0JT -> Item Summon Flying Courier, A2TH -> Stone Caller, A0DI -> Aftershock Effect, A231 -> Boots of Travel (fixed), A1ZH -> Medallion of Courage Container, A1ZI -> Medallion of Courage, A1ZW -> Ancient Jangoo, A28D -> Veil of Discord, A2KG -> Ring of Aquila, A2K3 -> Rod of atos slow 3, A2EA -> Rod of atos, A2K1 -> Tranquil Boots, A2K4 -> Prudence, A2K7 -> Annihilator Stun, A14O -> Ball Lightning, A0NE -> Voodoo Restoration, A14O -> Ball Lightning, A1C0 -> Splitshot, A418 -> Splitshot, A0K7 -> Arcane Ring, A1AC -> Ghost Potion, A1QD -> Ether Blast, A0JL -> Static Charge, AIpg -> Item Purge, A11F -> Avatar, A0T9 -> ICEARMORNEW (NEW), A1T7 -> Eul Cyclone, AIcy -> Cyclone, A19M -> Force Staff, A02O -> Finger of Death, A0FD -> Orchid Malevolence, AChx -> Guinsoo's Scythe, A1EW -> Khadgar's Pipe of Insight, A332 -> Arctic Burn, A2N1 -> Shadow Amulet, A590 -> Unus, A591 -> Duos, A592 -> Tertius, A593 -> Denique, A02Z -> Life Drain, A0GC -> Morph Replicate
endfunction

function isFormlessAbility takes integer id returns boolean
	return id=='A40K' or id=='A40L' or id=='A40M' or id=='A40N' or id=='A590' or id=='A591' or id=='A592' or id=='A593'//A40K -> Unus, A40L -> Duos, A40M -> Tertius, A40N -> Denique, A590 -> Unus, A591 -> Duos, A592 -> Tertius, A593 -> Denique
endfunction

function isSkillWithZeroCD takes integer spell returns boolean
	return spell=='A02Z'//A02Z -> Life Drain
endfunction

function Valid_Spell takes integer spell returns boolean
	return spell!=0 and Semi_Valid_Spell(spell) and IsPoisonArrowSkill(spell)==false and isItemSpellOrNoCd(spell)==false and isDummyAbility(spell)==false and isAintItemAbility(spell) and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 and isFormlessAbility(spell)==false and isSkillWithZeroCD(spell)==false//
endfunction

function COE takes integer PlayerId,integer aid returns boolean
	//multicast addition restrictions...
	local integer index
	if aid==0 then
		return false
	endif
	if LoadBoolean(UTable,MCRESTRICTED,aid) or isItemSpellOrNoCd(aid)or IsPoisonArrowSkill(aid) or isAintItemAbility(aid)==false or isFormlessAbility(aid) then
		return false
	endif
	set index=SK8(PlayerId,aid)
	if index!=0 then
		if CheckStacking(index,-1,"metamorphosis",null)then
			return false
		elseif CheckStacking(index,-1,"arrows",null)then
			return false
		endif
	endif
	return true
endfunction

function IsSpellInMulticastRestrictionList takes integer id returns boolean
	return id=='A2T5' or id=='A2TJ' or id=='A2QI' or id=='A43J' or id=='A1A1' or id=='A1B3' or id=='A0QR' or id=='A1DP' or id=='A461' or id=='A46H' or id=='A46J'
	//A2T5 -> Fate's Edict, A2TJ -> Rolling Boulder, A2QI -> Geomagnetic Grip, A43J -> Earth Splitter, A1A1 -> Earth Splitter, A1B3 -> Life Break upgrade, A0QR -> Life Break, A0JC -> Lightning Bolt, A1DP -> Static Link, A461 -> Swoop Down, A46H -> Doppelganger, A46J -> Mind Control
endfunction

function BalanceOffSpellChecker takes integer spell returns boolean
	return IsPoisonArrowSkill(spell)==false and isItemSpellOrNoCd(spell)==false and isDummyAbility(spell)==false and isAintItemAbility(spell) and isFormlessAbility(spell)==false
endfunction

function MulticastSpellRestriction takes integer si returns boolean
	return IsSpellInMulticastRestrictionList(si)==false and isItemSpellOrNoCd(si)==false and isDummyAbility(si)==false and isAintItemAbility(si) and si!='A2M0' and si!='A32G' and si!='A32E' and si!='A32D' and si!='A32C' and si!='A32A' and si!='A0ZF'
	//A2M0 -> Tempest Double, A32G -> Drums of War, A32E -> Digest, A32D -> Digest Spit, A32C -> Trample, A32A -> Spit, A0ZF -> Howl
endfunction

function BHD takes nothing returns nothing
	local integer PlayerId
	local integer hn
	local integer xx
	local integer id
	set PlayerId=0

	if IsObserver(GetLocalPlayer())==false then
		call ClearSelection()
	endif
	
	loop
		if IsObserver(Player(PlayerId))==false then
			call HidePassivesFunction(Player(PlayerId),true)
			call BL8(Player(PlayerId))
			call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"|cff99ccff"+" "+"Your spells:"+"|r")
			set xx=1
			loop
				set id=PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]
				if id>600 then
					call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"	"+GetObjectName(SkillID[id])+"|cffffcc00"+" ("+"Invoker"+")"+"|r")
				else
					if xx==4 or xx==6 then
						call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"	"+"|c00ff0303"+GetObjectName(SkillID[id])+"|r"+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
					else
						call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"	"+GetObjectName(SkillID[id])+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
					endif
				endif
				set xx=xx+1
				exitwhen xx>4+NumberOfExtraAbilities
			endloop
			if MeleeOrRangedRestricted[PlayerId]==1 then
				call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15," ")
				call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"|c00FF0000[LoD]|r|c006699CC"+" "+"You can only pick MELEE heroes."+"|r")
			elseif MeleeOrRangedRestricted[PlayerId]==2 then
				call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15," ")
				call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"|c00FF0000[LoD]|r|c006699CC"+" "+"You can only pick RANGED heroes."+"|r")
			endif
			call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15," ")
			call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15," ")
			call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"|cff99ccff"+"You can now pick your hero."+"|r")
			call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15," ")
			call SoundForPlayer(Player(PlayerId),"Sound\\Interface\\Rescue.wav")
			call SuspendTimeOfDay(false)
			set hn=1
			call HeroAttackTypeRestrictionForPlayer(Player(PlayerId),MeleeOrRangedRestricted[PlayerId])
		endif
		set PlayerId=PlayerId+1
		exitwhen PlayerId>11
	endloop
endfunction

function BID takes integer i returns nothing
	local integer k=R2I((I2R(i)+3.)/ 4.)
	if k>151 then
		set k=151
	endif
	if not(b_IsHeroAlreadyPreloaded[k])then
		call InitHeroAndSkillsRelated(k,i)
		set b_IsHeroAlreadyPreloaded[k]=true
	endif
	if HaveSavedString(MHT,SkillID[i],600) and LoadBoolean(MHT,SkillID[i],600)==false then
		call SaveBoolean(MHT,SkillID[i],600,true)
		call ExecuteFunc(LoadStr(MHT,SkillID[i],600))
//		call echo(LoadStr(MHT,SkillID[i],600)+" preloaded")
	endif
	if HaveSavedString(MHT,SkillID[i],601) and LoadBoolean(MHT,SkillID[i],601)==false then
		call SaveBoolean(MHT,SkillID[i],601,true)
		call ExecuteFunc(LoadStr(MHT,SkillID[i],601))
//		call echo(LoadStr(MHT,SkillID[i],601)+" preloaded")
	endif
endfunction

function BKD takes integer PlayerId returns nothing
	local integer xx=1
	loop
		call BID(PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx])
		set xx=xx+1
		exitwhen xx>4+NumberOfExtraAbilities
	endloop
endfunction

function DelayedUpgradedCourier_Go takes nothing returns nothing
	call DestroyTimer(GetExpiredTimer())//n0KG
	set FlyingCourierAllowed=true
endfunction

function AddFlyingCourierIfSolo takes nothing returns nothing
	local unit u
	set FlyingCourierAllowed=true
	//call AddUnitToStock(ScourgeBuilding_ShopGraveyard,'h03Q',1,1)//h03Q -> Flying Courier
	//call AddUnitToStock(SentinelBuilding_ShopChimaera,'h03Q',1,1)//h03Q -> Flying Courier
	set u=CreateUnit(Player(15),'uC74',-7360-128,-6388,270)//uC74 -> Leragas The Vile
	call SetUnitVertexColor(u,255,100,0,255)
	set u=CreateUnit(Player(15),'uC74',6724,6592,270)//uC74 -> Leragas The Vile
	call SetUnitVertexColor(u,255,100,0,255)
	set u=null
endfunction

function DisableRepick takes nothing returns nothing
	set Z3=true
endfunction

function ShowCredits takes nothing returns nothing
	if Mode_S5 or Mode_S6 then
		call TimerStart(CreateTimer(),20+180,false,function RemindAboutSP)
	endif
	call TimerStart(CreateTimer(),20+300,false,function RemindAboutSI)
	call TimerStart(CreateTimer(),20,false,function DisableRepick)
	call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,"|c00FF0000MAP by:  DracoL1ch & ResQ|r")
	call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,"|c006699CCGet updates about LoD, view changelogs|r")
	call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,"|c006699CCand post any suggestions on:|r")
	call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15," ")
	call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15," |cFFFF8000www.LegendsOfDotA.com|r")
	call TimerStart(CreateTimer(),20+180,false,function DelayedUpgradedCourier_Go)
endfunction

function CleanTaverns takes nothing returns nothing
	//call TechHeroForAll('HIV2')//HIV2 -> Invoker
	//call TechHeroForAll('HIV3')//HIV3 -> Invoker
	//call TechHeroForAll('HnUT')//HnUT -> Utility Hero
endfunction

function IsPickingDummy takes nothing returns boolean
	return GetUnitTypeId(GetFilterUnit())=='n00C' or GetUnitTypeId(GetFilterUnit())=='ntav' //n00C -> Zone Indicator
endfunction

function ShowPickDummy takes nothing returns nothing
	call ShowUnit(GetEnumUnit(),true)
endfunction

function HidePickDummy takes nothing returns nothing
	call ShowUnit(GetEnumUnit(),false)
endfunction

function RevealPickers takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local group g=LoadGroupHandle(HY,h,0)
	call ForGroup(g,function ShowPickDummy)
	call KillGroup(g)
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	set g=null
	set t=null
endfunction

function PrePickHiding takes integer pid returns nothing
	local timer t=CreateTimer()
	local group g=GetAvailableGroup()
	call TimerStart(t,4,false,function RevealPickers)
	call GroupEnumUnitsOfPlayer(g,Player(pid),Condition(function IsPickingDummy))
	call ForGroup(g,function HidePickDummy)
	call SaveGroupHandle(HY,GetHandleId(t),0,g)
	set g=null
	set t=null
endfunction

function BMD takes nothing returns nothing
	local trigger t
	local integer PlayerId
	local timer credits
	if Mode_RD then
		return
	endif
	set PlayerId=0
	if TimerGetRemaining(NK)>0 then
		loop
			if QV8(PlayerId)then
				if not(b_isPlayerReady[PlayerId]) then
					return
				endif
			endif
			set PlayerId=PlayerId+1
			exitwhen PlayerId>12
		endloop
	endif
	set b_AllPlayersReady=true
	set PlayerId=0
	loop
		if QV8(PlayerId)then
			call VG9(Player(PlayerId))
			call PlacePickDummies(Player(PlayerId))
			call BKD(PlayerId)
		endif
		if bj_isSinglePlayer==false then
			call PrePickHiding(PlayerId)
		endif
		call FlushChildHashtable(HY,GetHandleId(SpellPickingDummy[PlayerId]))
		call RemoveUnit(SpellPickingDummy[PlayerId])
		set PlayerId=PlayerId+1
		exitwhen PlayerId>12
	endloop
	call PanCameraToTimed(-6990.,6840.,.0)		 //-7008.,6816.	changed because it was strangecam
	call RemoveUnit(AddTime1)
	call RemoveUnit(AddTime2)
	call RemoveUnit(AddTime3)
	call RemoveUnit(AddTime4)
	call RemoveUnit(AltarOfRandom)
	call CleanTaverns()
	call DestroyMultiboard(AbilityDraftMultiboard)
	call MultiboardDisplay(MainMB,true)
	call AddUnitToStock(ScourgeBuilding_ShopGraveyard,'h02C',2,4)//h02C -> Observer Wards
	call AddUnitToStock(SentinelBuilding_ShopChimaera,'h02C',2,4)//h02C -> Observer Wards
	call ClearSelection()
	set b_isPickTime=false
	call DestroyTimer(NK)
	set NK=CreateTimer()
	call TimerStart(NK,90+1,false,null)
	set credits=CreateTimer()
	call TimerStart(credits,70,false,function ShowCredits)
	if Mode_FN then
		call NeutralsRespawn()
		set t=CreateTrigger()
		call TriggerRegisterTimerEvent(t,30,false)
		call TriggerRegisterTimerEvent(t,90,false)
		call TriggerAddCondition(t,Condition(function NeutralsRespawn))
		set t=null
	endif
	call EnableTrigger(HeroEnters)
	set credits=null
	call BHD()
endfunction

function UpdateAbilityDraftMB takes integer pid,integer sn,integer aid returns nothing
	local multiboarditem mi
	local string s=SkillIcon[aid]
	if Mode_Debug then
		if IsScourge(Player(pid)) then
			set mi=MultiboardGetItem(AbilityDraftMultiboard,(pid+2)-1,sn-1)
		else
			set mi=MultiboardGetItem(AbilityDraftMultiboard,(pid+1)-1,sn-1)
		endif
	else
		set mi=MultiboardGetItem(AbilityDraftMultiboard,XK7[pid]-1,sn-1)
	endif
	if IsSentinel(Player(pid)) and Mode_SS==false then
		if IsScourge(GetLocalPlayer()) then
			if aid==0 then
				set s=SkillIcon[0]
			else
				set s="ReplaceableTextures\\CommandButtons\\BTNQuestion.blp"
			endif
		endif
	elseif IsScourge(Player(pid)) and Mode_SS==false then
		if IsSentinel(GetLocalPlayer()) then
			if aid==0 then
				set s=SkillIcon[0]
			else
				set s="ReplaceableTextures\\CommandButtons\\BTNQuestion.blp"
			endif
		endif
	endif
	call MultiboardSetItemIcon(mi,s)
	call MultiboardReleaseItem(mi)
	set mi=null
endfunction

function CheckDisablesPicked takes integer pid returns integer
	local integer k=0
	local integer c=0
	loop
		if DisablesList[k]!=0 then
			if PlayerSkillNumber[pid*PlayerSkillOffset+1]==DisablesList[k] or PlayerSkillNumber[pid*PlayerSkillOffset+2]==DisablesList[k]  or PlayerSkillNumber[pid*PlayerSkillOffset+3]==DisablesList[k] or PlayerSkillNumber[pid*PlayerSkillOffset+4]==DisablesList[k] or (NumberOfExtraAbilities>=1 and PlayerSkillNumber[pid*PlayerSkillOffset+5]==DisablesList[k]) or (NumberOfExtraAbilities>=2 and PlayerSkillNumber[pid*PlayerSkillOffset+6]==DisablesList[k]) then
				set c=c+1
			endif
		endif
		set k=k+1
		exitwhen k>DisablesListCount
	endloop
	return c
endfunction

function IfTrueshotPicked takes integer pid returns boolean
	local integer id=34*4+3
	local integer d=pid*PlayerSkillOffset
	if PlayerSkillNumber[d+1]==id or PlayerSkillNumber[d+2]==id  or PlayerSkillNumber[d+3]==id or PlayerSkillNumber[d+4]==id or (NumberOfExtraAbilities>=1 and PlayerSkillNumber[d+5]==id) or (NumberOfExtraAbilities>=2 and PlayerSkillNumber[d+6]==id) then
		return true
	endif
	return false
endfunction

function IsDisableSkill takes integer skillid returns boolean
	local integer k=0
	local boolean b=false
	loop
		if skillid==DisablesList[k] then
			set b=true
		endif
		set k=k+1
		exitwhen b or k>DisablesListCount
	endloop
	return b
endfunction

function IsMeleeUnitById takes integer hid returns boolean
	local integer i=1
	loop
		if HeroID[hid]==MeleeHeroesArray[i] then
			return true
		endif
		set i=i+1
		exitwhen i>MeleeHeroesAmount
	endloop
	return false
endfunction

function CheckAbilitiesForStacking takes integer newindex,integer PlayerId,boolean showMsgs returns boolean
	local boolean BRD=I2R(newindex/ 4)==I2R(newindex)/ 4.
	local boolean pr=true
	local integer ns=0  //stacking id for passives and number of abilities from the same hero
	local integer ns2=0 //2nd id
	local integer ns3=0 //3rd id
	local integer xx=0
	local integer RG8=0
	local integer BSD=0
	local integer BTD=0
	local string desc=""
	local integer abilityhero=0
	local integer abilityhero2=0
	local boolean toomanydisables=false
	local boolean toomanydisablescauseteam=false
	local player p=Player(PlayerId)
	local boolean isMeleeMorph
	local boolean isRangeMorph
	local boolean isMeleeOnly
	local boolean isRangeOnly
	local integer pidoff=PlayerId*PlayerSkillOffset
	local integer disablesmax
	local unit u
	if PlayerSkillNumber[pidoff+1]==newindex or PlayerSkillNumber[pidoff+2]==newindex or PlayerSkillNumber[pidoff+3]==newindex or PlayerSkillNumber[pidoff+4]==newindex or PlayerSkillNumber[pidoff+5]==newindex or PlayerSkillNumber[pidoff+6]==newindex then
		return false
	endif
	if newindex==(116-1)*4+4 or newindex==(115-1)*4+4  or newindex==(114-1)*4+4 then //Invoker has no ult :<
		set BRD=false
	endif
	if b_isPlayerReady[PlayerId]then
		call QB8(p,showMsgs,"You are ready")
		return false
	endif
	if IsAbilityDoesNotWork[newindex] then
		call QB8(p,showMsgs,"This skill doesn't work :(")
		return false
	endif
	if Mode_DM or s_MainMode=="ar" then
		if IsPermanentAbility[newindex] then
			return false
		endif
	endif
	if Mode_OS then
		if IsSentinel(p) then
			set RG8=1
		else
			set RG8=2
		endif
		if OneSkillCheckArray[RG8*OneSkillOffsetCheck+newindex]!=0 then
			call QB8(p,showMsgs,"A player has already picked this ability: "+udg_Colors[OneSkillCheckArray[RG8*OneSkillOffsetCheck+newindex]]+PlayerNames[OneSkillCheckArray[RG8*OneSkillOffsetCheck+newindex]]+"|r")
			return false
		endif
	endif
	set xx=1
	loop
		if BRD then
			if xx==4 or xx==6 then
				if PlayerSkillNumber[pidoff+xx]==0 then
					set BTD=xx
					exitwhen true
				endif
			endif
		else
			if not(xx==4 or xx==6)then
				if PlayerSkillNumber[pidoff+xx]==0 then
					set BSD=xx
					exitwhen true
				endif
			endif
		endif
		set xx=xx+1
		exitwhen xx>4+NumberOfExtraAbilities
	endloop
	if BTD==0 and BRD then
		call QB8(p,showMsgs,"You need to pick a regular skill (not an ultimate).")
		return false
	endif
	if BSD==0 and not(BRD)then
		call QB8(p,showMsgs,"You need to pick an ultimate.")
		return false
	endif
	if Mode_RA then
		if PlayerSkillNumber[pidoff+5]==0 and NumberOfExtraAbilities>=1 then
			set BSD=5
		endif
		if PlayerSkillNumber[pidoff+6]==0 and NumberOfExtraAbilities>=2 then
			set BTD=6
		endif
	endif
	set isMeleeOnly=CheckStacking(newindex,-1,"melee only",null)
	set isMeleeMorph=CheckStacking(newindex,-1,"melee morph",null)
	set isRangeOnly=CheckStacking(newindex,-1,"range only",null)
	set isRangeMorph=CheckStacking(newindex,-1,"range morph",null)
	if PlayerId==0 then
		set u=LoadUnitHandle(HY,'0REA','000U')
		if u!=null then
			if IsMeleeUnitById(GetUnitUserData(u))then
				if isRangeOnly then
					set u=null
					return false
				endif
			else
				if isMeleeOnly then
					set u=null
					return false
				endif
			endif
		endif
	endif
	if isMeleeOnly or isMeleeMorph then
		set xx=1
		loop
			if CheckStacking(PlayerSkillNumber[pidoff+xx],-1,"range only",null)or CheckStacking(PlayerSkillNumber[pidoff+xx],-1,"range morph",null)then
				set ns=xx
				if isMeleeMorph then
					set desc="You cannot pick a melee transformation skill"
				else
					set desc="You cannot pick a melee only skill"
				endif
				exitwhen true
			endif
			set xx=xx+1
			exitwhen xx>4+NumberOfExtraAbilities
		endloop
		set xx=1
		loop
			if CheckStacking(PlayerSkillNumber[pidoff+xx],newindex,null,"melee only")then
				set ns=xx
				set desc="buggy/orderids"
				exitwhen true
			endif
			set xx=xx+1
			exitwhen xx>4+NumberOfExtraAbilities
		endloop
	elseif isRangeOnly or isRangeMorph then
		set xx=1
		loop
			if CheckStacking(PlayerSkillNumber[pidoff+xx],-1,"melee only",null)or CheckStacking(PlayerSkillNumber[pidoff+xx],-1,"melee morph",null)then
				set ns=xx
				if isRangeMorph then
					set desc="You cannot pick a ranged transformation skill"
				else
					set desc="You cannot pick a ranged only skill"
				endif
				exitwhen true
			endif
			set xx=xx+1
			exitwhen xx>4+NumberOfExtraAbilities
		endloop
		set xx=1
		loop
			if CheckStacking(PlayerSkillNumber[pidoff+xx],newindex,null,"range only")then
				set ns=xx
				set desc="buggy/orderids"
				exitwhen true
			endif
			set xx=xx+1
			exitwhen xx>4+NumberOfExtraAbilities
		endloop
	else
		set xx=1
		loop
			if CheckStacking(PlayerSkillNumber[pidoff+xx],newindex,null,null)then
				set ns=xx
				set desc="buggy/orderids"
				exitwhen true
			endif
			set xx=xx+1
			exitwhen xx>4+NumberOfExtraAbilities
		endloop
	endif
	if IsMultiIconAbility[newindex] and (Mode_S5 or Mode_S6) then
		call QA8(p,showMsgs,"WARNING: This skill is Multi-icon type.")
	endif
//	call echo(B2S(IfTrueshotPicked(GetPlayerId(Sentinels[1]))))
	if newindex==(Trax-1)*4+3 then//trueshot wrapper
		if IsSentinel(p) then
			if IfTrueshotPicked(GetPlayerId(Sentinels[1])) or IfTrueshotPicked(GetPlayerId(Sentinels[2])) or IfTrueshotPicked(GetPlayerId(Sentinels[3])) or IfTrueshotPicked(GetPlayerId(Sentinels[4])) or IfTrueshotPicked(GetPlayerId(Sentinels[5])) then
				call QB8(p,showMsgs,"Your teammate already took this ability. Can't have another one.")
				return false
			endif
		else
			if IfTrueshotPicked(GetPlayerId(Scourges[1])) or IfTrueshotPicked(GetPlayerId(Scourges[2])) or IfTrueshotPicked(GetPlayerId(Scourges[3])) or IfTrueshotPicked(GetPlayerId(Scourges[4])) or IfTrueshotPicked(GetPlayerId(Scourges[5])) then
				call QB8(p,showMsgs,"Your teammate already took this ability. Can't have another one.")
				return false
			endif
		endif
	endif
//	if ns==0 then
//		if IsPassiveAbility[newindex] and (Mode_LS) then
//			set xx=1
//			loop
//				if IsPassiveAbility[PlayerSkillNumber[pidoff+xx]] then
//					if ns2==0 then
//						set ns2=xx
//					elseif Mode_LS3 then
//						if ns3==0 then
//							set ns3=xx
//						else
//							set ns=xx
//							set desc="no more than 3 passives"
//							exitwhen true
//						endif
//					else
//						set ns=xx
//						set desc="no more than 2 passives"
//						exitwhen true
//					endif
//				endif
//				set xx=xx+1
//				exitwhen (xx>4+NumberOfExtraAbilities) or (xx>4 and Mode_RA)
//			endloop
//		endif
//	endif
	if Mode_BO==false then
		set disablesmax=1
	else
		set disablesmax=2
	endif
	if IsDisableSkill(newindex) then
		set toomanydisables=CheckDisablesPicked(PlayerId)>=disablesmax
		if toomanydisables==false then
			if IsSentinel(p) then
				set toomanydisables=(CheckDisablesPicked(GetPlayerId(Sentinels[1]))+CheckDisablesPicked(GetPlayerId(Sentinels[2]))+CheckDisablesPicked(GetPlayerId(Sentinels[3]))+CheckDisablesPicked(GetPlayerId(Sentinels[4]))+CheckDisablesPicked(GetPlayerId(Sentinels[5])))>=7
			else
				set toomanydisables=(CheckDisablesPicked(GetPlayerId(Scourges[1]))+CheckDisablesPicked(GetPlayerId(Scourges[2]))+CheckDisablesPicked(GetPlayerId(Scourges[3]))+CheckDisablesPicked(GetPlayerId(Scourges[4]))+CheckDisablesPicked(GetPlayerId(Scourges[5])))>=7
			endif
			//call echo(I2S(CheckDisablesPicked(GetPlayerId(Sentinels[1]))+CheckDisablesPicked(GetPlayerId(Sentinels[2]))+CheckDisablesPicked(GetPlayerId(Sentinels[3]))+CheckDisablesPicked(GetPlayerId(Sentinels[4]))+CheckDisablesPicked(GetPlayerId(Sentinels[5]))))
			set toomanydisablescauseteam=toomanydisables
		endif
	endif
	if ns==0 then
		if (Mode_LS) then
			if toomanydisables==false then
				set ns2=0
				set ns3=0
				set abilityhero=(newindex-1)/4
				set xx=1
				loop
					if PlayerSkillNumber[pidoff+xx]!=0  then
						set abilityhero2=(PlayerSkillNumber[pidoff+xx]-1)/4
						if (abilityhero2==abilityhero) then
							if ns2==0 then
								set ns2=xx
							elseif Mode_LS3 then
								if ns3==0 then
									set ns3=xx
								else
									set ns=xx
									set desc="no more than 3 abilities from the same hero"
									exitwhen true
								endif
							else
								set ns=xx
								set desc="no more than 2 abilities from the same hero"
								exitwhen true
							endif
						endif
					endif
					set xx=xx+1
					exitwhen (xx>4+NumberOfExtraAbilities) or (xx>4 and Mode_RA)
				endloop
			endif
		endif
	endif
	if ns!=0 then
		if desc!="" then
			if ns3!=0 then
				call QB8(p,showMsgs,"Does not stack with : "+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns]])+"/"+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns2]])+"/"+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns3]])+" ("+desc+")")
			elseif ns2!=0 then
				call QB8(p,showMsgs,"Does not stack with : "+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns]])+"/"+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns2]])+" ("+desc+")")
			else
				call QB8(p,showMsgs,"Does not stack with : "+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns]])+" ("+desc+")")
			endif
		else
			call QB8(p,showMsgs,"Does not stack with : "+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns]]))
		endif
		return false
	endif
	if toomanydisables then
		if toomanydisablescauseteam==false then
			if disablesmax==2 then
				call QB8(p,showMsgs,"This spell cannot be picked, you already have 2 disables!")
			else
				call QB8(p,showMsgs,"This spell cannot be picked, you already have 1 disable!")
			endif
		else
			call QB8(p,showMsgs,"You cannot pick this disable! Your team already has 7 disables!")
		endif
		return false
	endif
	if HaveSavedString(UTable,SkillID[newindex],HOTKEY) then
		set xx=1
		loop
			if PlayerSkillNumber[pidoff+xx] > 0 and HaveSavedString(UTable,SkillID[PlayerSkillNumber[pidoff+xx]],HOTKEY) then
				if LoadStr(UTable,SkillID[newindex],HOTKEY)==LoadStr(UTable,SkillID[PlayerSkillNumber[pidoff+xx]],HOTKEY) then
					call QB8(p,showMsgs,"Hotkey issue with : "+GetObjectName(SkillID[PlayerSkillNumber[pidoff+xx]]))
					if HaveSavedBoolean(HeroStats,GetHandleId(Player(PlayerId)),'NSHK') and Mode_AR then
						return false
					endif
				endif
			endif
			set xx=xx+1
			exitwhen (xx>4+NumberOfExtraAbilities)
		endloop
	endif
	
	if BRD then
		set PlayerSkillNumber[pidoff+BTD]=newindex
		call UpdateAbilityDraftMB(PlayerId,BTD,newindex)
	else
		set PlayerSkillNumber[pidoff+BSD]=newindex
		call UpdateAbilityDraftMB(PlayerId,BSD,newindex)
	endif
	if Mode_OS then
		if OneSkillCheckArray[RG8*OneSkillOffsetCheck+newindex]==0 then
			set OneSkillCheckArray[RG8*OneSkillOffsetCheck+newindex]=PlayerId
		endif
	endif
	set xx=1
	loop
		if PlayerSkillNumber[pidoff+xx]==0 then
			set pr=false
			exitwhen true
		endif
		set xx=xx+1
		exitwhen xx>4+NumberOfExtraAbilities
	endloop
	set b_isPlayerReady[PlayerId]=pr
	if isMeleeOnly then
		set MeleeOrRangedRestricted[PlayerId]=1
		call DisplayWithoutClear(p,showMsgs,"WARNING: This skill is melee only.")
	elseif isRangeOnly then
		set MeleeOrRangedRestricted[PlayerId]=2
		call DisplayWithoutClear(p,showMsgs,"WARNING: This skill is ranged only.")
	endif
	if isMeleeMorph then
		call DisplayWithoutClear(p,showMsgs,"WARNING: This skill is a melee transformation.")
	elseif isRangeMorph then
		call DisplayWithoutClear(p,showMsgs,"WARNING: This skill is a ranged transformation.")
	endif
	if (not(Mode_BO)and BalanceStrings[newindex]!=null)then
		call DisplayWithoutClear(p,showMsgs,"BALANCE: "+BalanceStrings[newindex])
	endif
	return true
endfunction

function VV9 takes nothing returns nothing
	local unit u=LoadUnitHandle(HY,'hRUT',1)
	local integer PlayerId=GetPlayerId(GetOwningPlayer(u))
	local integer SJ8
	local integer i=0
	local integer te
	set PlayerSkillNumber[PlayerId*PlayerSkillOffset+1]=LoadInteger(HY,'hRUT',2)
	set PlayerSkillNumber[PlayerId*PlayerSkillOffset+2]=LoadInteger(HY,'hRUT',3)
	set PlayerSkillNumber[PlayerId*PlayerSkillOffset+3]=LoadInteger(HY,'hRUT',4)
	set PlayerSkillNumber[PlayerId*PlayerSkillOffset+4]=LoadInteger(HY,'hRUT',5)
	set PlayerSkillNumber[PlayerId*PlayerSkillOffset+5]=LoadInteger(HY,'hRUT',6)
	set PlayerSkillNumber[PlayerId*PlayerSkillOffset+6]=LoadInteger(HY,'hRUT',7)
	set ExtraAbilityLevel[PlayerId*2+1]=LoadInteger(HY,'hRUT',8)
	set ExtraAbilityLevel[PlayerId*2+2]=LoadInteger(HY,'hRUT',9)
	//set UltimatesHeroId[PlayerId]=LoadInteger(HY,'hRUT',10)
	loop
		set SJ8=(GetRandomInt(1,NumberOfHeroes*4))
		if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)then
			if not CheckStacking(SJ8,-1,"range only",null)then
				call SaveInteger(HY,'0REA','0PID',PlayerId)
				call SaveInteger(HY,'0REA','0SID',SJ8)
				call SaveBoolean(HY,'0REA','000B',false)
				call ExecuteFunc("BUD")
			endif
		else
			if not CheckStacking(SJ8,-1,"melee only",null)then
				call SaveInteger(HY,'0REA','0PID',PlayerId)
				call SaveInteger(HY,'0REA','0SID',SJ8)
				call SaveBoolean(HY,'0REA','000B',false)
				call ExecuteFunc("BUD")
			endif
		endif
		set i=i+1
		exitwhen b_isPlayerReady[PlayerId]
	endloop
	if not b_isPlayerReady[PlayerId] then
		call SaveInteger(HY,'hRUT',2,PlayerSkillNumber[PlayerId*PlayerSkillOffset+1])
		call SaveInteger(HY,'hRUT',3,PlayerSkillNumber[PlayerId*PlayerSkillOffset+2])
		call SaveInteger(HY,'hRUT',4,PlayerSkillNumber[PlayerId*PlayerSkillOffset+3])
		call SaveInteger(HY,'hRUT',5,PlayerSkillNumber[PlayerId*PlayerSkillOffset+4])
		call SaveInteger(HY,'hRUT',6,PlayerSkillNumber[PlayerId*PlayerSkillOffset+5])
		call SaveInteger(HY,'hRUT',7,PlayerSkillNumber[PlayerId*PlayerSkillOffset+6])
		call SaveInteger(HY,'hRUT',8,ExtraAbilityLevel[PlayerId*2+1])
		call SaveInteger(HY,'hRUT',9,ExtraAbilityLevel[PlayerId*2+2])
		//call SaveInteger(HY,'hRUT',10,UltimatesHeroId[PlayerId])
		call ExecuteFunc("VV9")
	endif
	call FlushChildHashtable(HY,'hRUT')
	call VP9(u,Player(PlayerId))
	call BKD(PlayerId)
	set b_isPlayerReady[PlayerId]=false
	set u=null
endfunction

function RUD takes nothing returns nothing
	local integer SJ8
	local integer BJD
	local integer PlayerId
	local integer te
	set PlayerId=0
	loop
		if QV8(PlayerId)then
			loop
				exitwhen b_isPlayerReady[PlayerId]
				if s_MainMode=="sd" or s_MainMode=="md" then
					loop
						set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
						exitwhen(b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+BJD] and IsHeroIngame[BJD]==false)
					endloop
					set SJ8=(BJD*4)-4
					set SJ8=SJ8+GetRandomInt(1,4)
					call SaveInteger(HY,'0REA','0PID',PlayerId)
					call SaveInteger(HY,'0REA','0SID',SJ8)
					call SaveBoolean(HY,'0REA','000B',false)
					call ExecuteFunc("BUD")
				else
					loop
						set SJ8=(GetRandomInt(1,NumberOfHeroes*4))
						set te=AdjustHeroNumber((SJ8+3)/4)
						exitwhen(IsHeroIngame[te]==false and GetPlayerTechMaxAllowed(GetTriggerPlayer(),HeroID[te])>0)
					endloop
					call SaveInteger(HY,'0REA','0PID',PlayerId)
					call SaveInteger(HY,'0REA','0SID',SJ8)
					call SaveBoolean(HY,'0REA','000B',false)
					call ExecuteFunc("BUD")
				endif
			endloop
			call BMD()
		endif
		set PlayerId=PlayerId+1
		exitwhen PlayerId>12
	endloop
endfunction

function BVD takes integer pid,integer sid returns boolean
	local integer xx
	local integer RG8
	local integer sn
	local integer pid2
	local integer uid=GetUnitPointValueByType(HeroID[sid/4])
	set sn=R2I((I2R(sid)+3.)/ 4.)
	set sn=sid-((sn-1)*4)
	if Mode_RA then
		if PlayerSkillNumber[pid*PlayerSkillOffset+5]==sid and NumberOfExtraAbilities>=1 then
			call QB8(Player(pid),true,"You cannot remove this skill on \"Random Extra Abilities\" mode.")
			return false
		endif
		if PlayerSkillNumber[pid*PlayerSkillOffset+6]==sid and NumberOfExtraAbilities>=2 then
			call QB8(Player(pid),true,"You cannot remove this skill on \"Random Extra Abilities\" mode.")
			return false
		endif
	endif
	set xx=1
	loop
		if(PlayerSkillNumber[pid*PlayerSkillOffset+xx]==sid)then
			set PlayerSkillNumber[pid*PlayerSkillOffset+xx]=0
			call UpdateAbilityDraftMB(pid,xx,0)
			exitwhen true
		endif
		set xx=xx+1
		exitwhen xx>4+NumberOfExtraAbilities
	endloop
	set MeleeOrRangedRestricted[pid]=0
	set xx=1
	loop
		if CheckStacking(PlayerSkillNumber[pid*PlayerSkillOffset+xx],-1,"melee only",null)then
			set MeleeOrRangedRestricted[pid]=1
			exitwhen true
		elseif CheckStacking(PlayerSkillNumber[pid*PlayerSkillOffset+xx],-1,"range only",null)then
			set MeleeOrRangedRestricted[pid]=2
			exitwhen true
		endif
		set xx=xx+1
		exitwhen xx>4+NumberOfExtraAbilities
	endloop
//	if Mode_SD or Mode_MD then
//		call FlushChildHashtable(HY,GetHandleId(SpellPickingDummy[pid]))
//		call KillUnit(SpellPickingDummy[pid])
//		return true
//	endif
	if GetUnitAbilityLevel(SpellPickingDummy[pid],'Z004'-1+sn)>0 then
		call UnitRemoveAbility(SpellPickingDummy[pid],('Z004'-1)+sn)//Z004 -> Remove Skill
		call UnitAddAbility(SpellPickingDummy[pid],('Z000'-1)+sn)//Z000 -> Select skill
	endif
	
	if Mode_OS then
		set xx=0
		loop
			if IsSentinel(Player(pid)) then
				set pid2=GetPlayerId(Sentinels[xx])
			else
				set pid2=GetPlayerId(Scourges[xx])
			endif
			if LoadBoolean(HY,GetHandleId(Player(pid2)),uid) then
				if GetUnitAbilityLevel(SpellPickingDummy[pid2],SkillID[sid])>0 then
					call UnitRemoveAbility(SpellPickingDummy[pid2],('Z010'-1)+sn)//Z010 -> Closed skill
					call UnitAddAbility(SpellPickingDummy[pid2],('Z000'-1)+sn)//Z000 -> Select skill
				endif
			endif
			set xx=xx+1
			exitwhen xx>5
		endloop
		if IsSentinel(Player(pid)) then
			set RG8=1
		else
			set RG8=2
		endif
		if OneSkillCheckArray[RG8*OneSkillOffsetCheck+sid]==pid then
			set OneSkillCheckArray[RG8*OneSkillOffsetCheck+sid]=0
		endif
	endif
	return true
endfunction

function ResetSpellsSingle takes nothing returns nothing
	local integer PlayerId=GetPlayerId(GetTriggerPlayer())
	local integer i=S2I(SubString(GetEventPlayerChatString(),2,3))
	if i==0 then
		set i=S2I(SubString(GetEventPlayerChatString(),3,4))
	endif
	if b_isPickTime then
		if TimerGetElapsed(GlobalTimer)>ResetCooldown[PlayerId]+2 then
			if i<7 and i>0 then
				set ResetCooldown[PlayerId]=TimerGetElapsed(GlobalTimer)
				call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+i])
				set b_isPlayerReady[PlayerId]=false
			else
				call Error(GetTriggerPlayer(),"Wrong index, try [1-6]")
			endif
		else
			call Error(GetTriggerPlayer(),"Do not spam. Try later.")
		endif
	endif
endfunction

function ResetSpells takes nothing returns nothing
	local integer PlayerId=GetPlayerId(GetTriggerPlayer())
	if b_isPickTime then
		if TimerGetElapsed(GlobalTimer)>ResetCooldown[PlayerId]+2 then
			set ResetCooldown[PlayerId]=TimerGetElapsed(GlobalTimer)
			call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+1])
			call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+2])
			call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+3])
			call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+4])
			call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+5])
			call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+6])
			set b_isPlayerReady[PlayerId]=false
		else
			call Error(GetTriggerPlayer(),"Do not spam. Try later.")
		endif
	endif
endfunction

function RemovePickingStuff takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())=='n00C' or GetUnitTypeId(GetFilterUnit())=='ntav' then
		call ShowUnit(GetFilterUnit(),true)
		call KillUnit(GetFilterUnit())
	endif
	return false
endfunction

function PlayerLeave_DropSkills takes nothing returns nothing
	local integer PlayerId=GetPlayerId(GetTriggerPlayer())
	local integer xx
	local group g=GetAvailableGroup()
	if not(b_AllPlayersReady)and s_MainMode!="ar" then
		set xx=1
		loop
			call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx])
			set xx=xx+1
			exitwhen xx>4+NumberOfExtraAbilities
		endloop
	endif
	call GroupEnumUnitsOfPlayer(g,GetTriggerPlayer(),Condition(function RemovePickingStuff))
	call KillGroup(g)
endfunction

function BXD takes nothing returns nothing
	local integer PlayerId=GetPlayerId(GetOwningPlayer(GetSpellAbilityUnit()))
	local integer VR9=(SelectedSkillHeroPointValue[PlayerId]*4)-4
	local integer sn
	if GetSpellAbilityId()=='Z004' then//Z004 -> Remove Skill
			set VR9=VR9+1
		set sn=1
	elseif GetSpellAbilityId()=='Z005' then//Z005 -> Remove Skill
			set VR9=VR9+2
		set sn=2
	elseif GetSpellAbilityId()=='Z006' then//Z006 -> Remove Skill
			set VR9=VR9+3
		set sn=3
	elseif GetSpellAbilityId()=='Z007' then//Z007 -> Remove Skill
			set VR9=VR9+4
		set sn=4
	else
		return
	endif
	if BVD(PlayerId,VR9)then
		set b_isPlayerReady[PlayerId]=false
	endif
endfunction

function BYD takes nothing returns nothing
	local integer pid=GetPlayerId(GetOwningPlayer(GetSpellAbilityUnit()))
	local integer VR9=(SelectedSkillHeroPointValue[pid]*4)-4
	local integer sn
	local integer xx
	local integer PlayerId2
	if not ((GetSpellAbilityId()>='Z000' and GetSpellAbilityId()<='Z003') or (GetSpellAbilityId()>='Z010' and GetSpellAbilityId()<='Z013')) then//Z000 -> Select skill, Z003 -> Select skill, Z010 -> Closed skill, Z013 -> Closed skill
		return
	endif
	if GetSpellAbilityId()=='Z000' or GetSpellAbilityId()=='Z010' then//Z000 -> Select skill, Z010 -> Closed skill
		set VR9=VR9+1
		set sn=1
	elseif GetSpellAbilityId()=='Z001' or GetSpellAbilityId()=='Z011' then//Z001 -> Select skill, Z011 -> Closed skill
		set VR9=VR9+2
		set sn=2
	elseif GetSpellAbilityId()=='Z002' or GetSpellAbilityId()=='Z012' then//Z002 -> Select skill, Z012 -> Closed skill
		set VR9=VR9+3
		set sn=3
	elseif GetSpellAbilityId()=='Z003' or GetSpellAbilityId()=='Z013' then//Z003 -> Select skill, Z013 -> Closed skill
		set VR9=VR9+4
		set sn=4
	else
		return
	endif
	if not CheckAbilitiesForStacking(VR9,pid,true) then
		return
	endif
	if isPlayerPickedAbility(Player(pid),VR9)then
		call UnitRemoveAbility(SpellPickingDummy[pid],('Z000'-1)+sn)//Z000 -> Select skill
		call UnitAddAbility(SpellPickingDummy[pid],('Z004'-1)+sn)//Z004 -> Remove Skill
		if Mode_OS then
			set xx=1
			loop
				if IsSentinel(Player(pid)) then
					set PlayerId2=GetPlayerId(Sentinels[xx])
				else
					set PlayerId2=GetPlayerId(Scourges[xx])
				endif
				if GetUnitAbilityLevel(SpellPickingDummy[PlayerId2],SkillID[VR9])>0 and pid!=PlayerId2 and GetUnitAbilityLevel(SpellPickingDummy[PlayerId2],'Z000'-1+sn)>0 then
					call UnitRemoveAbility(SpellPickingDummy[PlayerId2],('Z000'-1)+sn)//Z000 -> Select skill
					call UnitAddAbility(SpellPickingDummy[PlayerId2],('Z010'-1)+sn)//Z010 -> Closed skill
				endif
				set xx=xx+1
				exitwhen xx>5
			endloop
		endif
	endif
	if b_isPlayerReady[pid]then
		call BMD()
	endif
endfunction

//function DetectHiddingTavern takes nothing returns nothing
//	if GetTriggerEventId()==EVENT_UNIT_HIDDEN then
//		if IsSentinel(GetOwningPlayer(GetTriggerUnit())) then
//			call TimedReveal(Scourges[0],0.5,GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),400)
//		else
//			call TimedReveal(Sentinels[0],0.5,GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),400)
//		endif
//	endif
//endfunction
//
//function DetectHiddingTavern takes unit u returns nothing
//	local trigger t=CreateTrigger()
//	//call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DETECTED)
//	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_HIDDEN)
//	call TriggerAddCondition(t,Condition(function DetectHiddingTavern))
//	set t=null
//endfunction

function PopulatePlayersTavern takes player p, integer heroid returns nothing
	local integer h=GetHandleId(p)
	local integer c=LoadInteger(HeroStats,h,32)
	local integer i=R2I(c/11)
	local integer inc=32+i
	local real x=-7400+i*192
	local real y=7128-192*(ModuloInteger(GetPlayerId(p)-1,6))
	local integer h2
	local unit u
	if p==Player(12) then
		return
	endif
	if i==2 then
		set x=x+16
	endif
//	if GetPlayerId(p)>5 then
//		set x=x+576
//	endif
	if HaveSavedHandle(HeroStats,h,inc)==false then
		set u=CreateUnit(p,'ntav',x,y,270)
		if GetLocalPlayer()!=p then
			call SetUnitScale(u,0.3,0.3,0.3)
		endif
		call SaveUnitHandle(HeroStats,h,inc,u)//ntav -> Light Tavern
		if c==0 then
			call SelectUnitForPlayerSingle(u,p)
		endif
		set h2=GetHandleId(u)
		//call DetectHiddingTavern(u)
		call SaveUnitHandle(HY,h2,inc,CreateUnit(p,'n12C',x,y,0))
		if GetLocalPlayer()!=p then
			call SetUnitVertexColor(LoadUnitHandle(HY,h2,inc),0,0,0,0)
		endif
		set u=null
		//call echo(I2S(GetPlayerId(p)))
	endif
	call AddUnitToStock(LoadUnitHandle(HeroStats,h,inc),heroid,1,1)
	call SaveInteger(HeroStats,h,32,c+1)
	call SetPlayerTechMaxAllowed(p,heroid,999)
	call SaveBoolean(HY,h,heroid,true)
	
	//call SaveInteger(HY,h,'PICK'+c,heroid)
endfunction

function RandomizeHeroPool takes nothing returns nothing
	local integer PlayerId=0
	local integer i=1
	local integer j
	local integer n
	local integer f
	local integer limit=NumberOfHeroes
	local boolean mess=true
	if Mode_AA then
		loop
			set HeroNumArrayRandomized[i]=AgiHeroesArray[i]
			set i=i+1
			exitwhen AgiHeroesArray[i]==0
		endloop
	elseif Mode_AI then
		loop
			set HeroNumArrayRandomized[i]=IntHeroesArray[i]
			set i=i+1
			exitwhen IntHeroesArray[i]==0
		endloop
	elseif Mode_AS then
		loop
			set HeroNumArrayRandomized[i]=StrHeroesArray[i]
			set i=i+1
			exitwhen StrHeroesArray[i]==0
		endloop
//	elseif Mode_RO then
//		
//	elseif Mode_MO then
//		
	else
		loop
			set HeroNumArrayRandomized[i]=i
			set i=i+1
			exitwhen i>NumberOfHeroes
		endloop
		set mess=false
	endif
	set HeroSDLimit=i-1
	set limit=HeroSDLimit*4
	
	set i=1
	loop
		set j=GetRandomInt(1,HeroSDLimit)
		set n=GetRandomInt(1,HeroSDLimit)
		if j!=n then
			set f=HeroNumArrayRandomized[j]
			set HeroNumArrayRandomized[j]=HeroNumArrayRandomized[n]
			set HeroNumArrayRandomized[n]=f
		endif
		set i=i+1
		exitwhen i>limit
	endloop
	
	set SDBotherWithHeroDoubles=mess==false and (Mode_D2==false or Mode_MD) and Mode_D3==false and Mode_D4==false and Mode_D5==false
	if mess==false then
		return
	endif
	set i=1
	loop
		set HeroNumArrayRandomized[i]=GetHeroIndexFromId(HeroNumArrayRandomized[i])
		set i=i+1
		exitwhen HeroNumArrayRandomized[i]==0
	endloop
endfunction

function IsAvailableForAllies takes integer PlayerId, integer i returns boolean
	local boolean b=false
	set b=b_HeroAvailableForPlayer[GetPlayerId(Sentinels[1])*NumberOfHeroes+i]==false and b_HeroAvailableForPlayer[GetPlayerId(Sentinels[2])*NumberOfHeroes+i]==false and b_HeroAvailableForPlayer[GetPlayerId(Sentinels[3])*NumberOfHeroes+i]==false and b_HeroAvailableForPlayer[GetPlayerId(Sentinels[4])*NumberOfHeroes+i]==false and b_HeroAvailableForPlayer[GetPlayerId(Sentinels[5])*NumberOfHeroes+i]==false 
	set b=b and (b_HeroAvailableForPlayer[GetPlayerId(Scourges[1])*NumberOfHeroes+i]==false and b_HeroAvailableForPlayer[GetPlayerId(Scourges[2])*NumberOfHeroes+i]==false and b_HeroAvailableForPlayer[GetPlayerId(Scourges[3])*NumberOfHeroes+i]==false and b_HeroAvailableForPlayer[GetPlayerId(Scourges[4])*NumberOfHeroes+i]==false and b_HeroAvailableForPlayer[GetPlayerId(Scourges[5])*NumberOfHeroes+i]==false)
	return b
endfunction

function SDWrapper takes integer PlayerId, boolean double returns nothing
	local integer i
	local integer c=11+i_BonusDraftAmount
	if c <= LoadInteger(HY,PlayerId,'sdcn') then
		return
	endif
	
	loop
		set i=GetRandomInt(1,HeroSDLimit)
		if SDBotherWithHeroDoubles then
			exitwhen b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+HeroNumArrayRandomized[i]]==false and IsAvailableForAllies(PlayerId,HeroNumArrayRandomized[i])
		else
			exitwhen b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+HeroNumArrayRandomized[i]]==false 
		endif
		exitwhen HeroSDLimit < c
	endloop
	if b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+HeroNumArrayRandomized[i]]==false then
		call PopulatePlayersTavern(Player(PlayerId),HeroID[HeroNumArrayRandomized[i]])
		set b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+HeroNumArrayRandomized[i]]=true
		if double then
			call PopulatePlayersTavern(Player(PlayerId+6),HeroID[HeroNumArrayRandomized[i]])
			set b_HeroAvailableForPlayer[(PlayerId+6)*NumberOfHeroes+HeroNumArrayRandomized[i]]=true
		endif
	endif
//	call echo(I2S(PlayerId)+" -> "+I2S(c)+" HeroId="+Id2String(HeroID[HeroNumArrayRandomized[i]])+" i="+I2S(i)+" Num="+I2S(HeroNumArrayRandomized[i]))
	call SaveInteger(HY,PlayerId,'sdcn',LoadInteger(HY,PlayerId,'sdcn')+1)
endfunction

function BZD takes integer PlayerId,integer i returns nothing
	local integer PlayerId1=GetPlayerId(Sentinels[PlayerId])
	if PlayerId==0 or PlayerId==6 or i==0 then
		return
	endif
	if IsPlayer(Player(PlayerId))==false then
		if IsPlayer(Player(PlayerId+6)) then
			set PlayerId1=PlayerId+6
			call SDWrapper(PlayerId1,false)
		else
			return
		endif
	endif
	call SDWrapper(PlayerId1,true)
endfunction

function RemoveDefaultTaverns takes nothing returns nothing
	call RemoveUnit(TavernIntSent1)
	call RemoveUnit(TavernIntSent2)
	call RemoveUnit(TavernIntScourge1)
	call RemoveUnit(TavernIntScourge2)
	call RemoveUnit(TavernAgiSent1)
	call RemoveUnit(TavernAgiSent2)
	call RemoveUnit(TavernAgiScourge1)
	call RemoveUnit(TavernAgiScourge2)
	call RemoveUnit(TavernStrSent1)
	call RemoveUnit(TavernStrSent2)
	call RemoveUnit(TavernStrScourge1)
	call RemoveUnit(TavernStrScourge2)
endfunction

function Mode_MDRollHeroes takes nothing returns nothing
	local integer i
	local integer PlayerId=1
	local integer c=11+i_BonusDraftAmount
	loop
		set i=0
		loop
			call BZD(PlayerId,i)
			set i=i+1
			exitwhen(i>c)
		endloop
		set PlayerId=PlayerId+1
		exitwhen PlayerId>5
	endloop
endfunction

function BAD takes nothing returns nothing
	call RandomizeHeroPool()
	call RemoveDefaultTaverns()
	call ExecuteFunc("Mode_MDRollHeroes")
	call ExecuteFunc("VS9")
	call PanCameraToTimed(-7008.,6816.,.0)
endfunction

function BSFC takes integer id returns nothing
	set DisablesList[DisablesListCount]=id
	set DisablesListCount=DisablesListCount+1
endfunction

function BanStunsFomComboing takes nothing returns nothing
	call BSFC((ES-1)*4+1)//Fissure
	call BSFC((Sven-1)*4+1)//Storm bolt
	call BSFC((Enigma-1)*4+4)//Black Hole
	call BSFC((Tiny-1)*4+1)//Avalanche
	call BSFC((Admiral-1)*4+1)//Torrent
	call BSFC((Beastmaster-1)*4+4)//Primal roar
	call BSFC((indexid_DK-1)*4+2)//Dragon tail
	call BSFC((Alchemist-1)*4+2)//Unstable Conconction
	call BSFC((Treant-1)*4+4)//Overgrowth
	call BSFC((Pudge-1)*4+4)//Dismember
	call BSFC((SK-1)*4+1)//Burrowstrike
	call BSFC((Slardar-1)*4+2)//Slithereen crush
	call BSFC((Tide-1)*4+4)//Ravage
	call BSFC((Leoric-1)*4+1)//Hellfire blast
	call BSFC((Nessaj-1)*4+1)//Chaos bolt
	call BSFC((Magnus-1)*4+4)//Reverse polarity
	call BSFC((VS-1)*4+1)//Magic missile
	call BSFC((Potm-1)*4+2)//Elunes arrow
	call BSFC((Gyro-1)*4+2)//Homing missile
	call BSFC((NagaSiren-1)*4+2)//Ensnare
	call BSFC((Xin-1)*4+1)//Xin's chains
	call BSFC((Void-1)*4+4)//Chronosphere
	call BSFC((Geomancer-1)*4+1)//Earthbind
	call BSFC((NA-1)*4+1)//Impale
	call BSFC((Medusa-1)*4+4)//Stone gaze
	call BSFC((indexid_CM-1)*4+2)//Frostbite
	call BSFC((Storm-1)*4+2)//Storm's thing
	call BSFC((WR-1)*4+1)//Shackleshot
	call BSFC((Lina-1)*4+2)//Light strike array
	call BSFC((Rhasta-1)*4+2)//Hex
	call BSFC((Rhasta-1)*4+3)//Rhasta's net
	call BSFC((THD-1)*4+2)//Ice path
	call BSFC((OgreMagi-1)*4+1)//Fireblast
	call BSFC((Rubick-1)*4+1)//Telekinesis
	call BSFC((Bane-1)*4+3)//Nightmare
	call BSFC((Bane-1)*4+4)//Bane's ulti
	call BSFC((Lion-1)*4+1)//Impale
	call BSFC((Lion-1)*4+2)//Hex
	call BSFC((WD-1)*4+1)//WD's casks
	call BSFC((Enigma-1)*4+1)//Malefice
	call BSFC((Leshrak-1)*4+1)//Split earth
	call BSFC((indexid_AA-1)*4+1)//Cold feet
	call BSFC((OD-1)*4+2)//Astral imprisonment
	call BSFC((indexid_SD-1)*4+1)//Disruption
	call BSFC((Oracle-1)*4+1)//Oracle's purge
	call BSFC((Centaur-1)*4+1)//Hoof stomp
	call BSFC((Admiral-1)*4+4)//Ghost ship
	call BSFC((Earth-1)*4+1)//Boulder Smash
	call BSFC((Barathum-1)*4+1)//Charge of darkness
	call BSFC((Morphling-1)*4+2)//Adaptive strike
	call BSFC((FireLord-1)*4+2)//Fire stomp
	call BSFC((Pit-1)*4+2)//Pit of Malice
	call BSFC((Barathum-1)*4+4)//Nether Strike
	call BSFC((Axe-1)*4+1)
	call BSFC((Wyvern-1)*4+4)//Winter's Curse
	call BSFC((Batrider-1)*4+4)//Flaming Lasso
	
	
endfunction

function SunStrikeUniqueness takes integer id, integer id1, integer id2, integer id3, integer id4 returns nothing
	if Mode_RC==false and Mode_BO==false then
		if id1=='Z601' then//Z601 -> Sun Strike
			call ST(id*4+1,"r23")
		elseif id2=='Z601' then//Z601 -> Sun Strike
			call ST(id*4+2,"r23")
		elseif id3=='Z601' then//Z601 -> Sun Strike
			call ST(id*4+3,"r23")
		elseif id4=='Z601' then//Z601 -> Sun Strike
			call ST(id*4+4,"r23")
		endif
	endif
endfunction

function RollSpellsForInvokerSD takes nothing returns nothing
	local integer i=1
	local integer k=0
	local integer j=1
	local integer array s
	local string array imgs
	local string array orders
	local string array hotkeys
	local integer array ids
	local integer array upg
	local integer tmp
	local integer rndIndex
	set s[1]=1
	set s[2]=2
	set s[3]=3
	set s[4]=4
	set s[5]=5
	set s[6]=6
	set s[7]=7
	set s[8]=8
	set s[9]=9
	set s[10]=10
	set hotkeys[1]="t"
	set hotkeys[2]="d"
	set hotkeys[3]="f"
	set hotkeys[4]="y"
	set hotkeys[5]="v"
	set hotkeys[6]="g"
	set hotkeys[7]="z"
	set hotkeys[8]="x"
	set hotkeys[9]="c"
	set hotkeys[10]="b"
	loop
		exitwhen( i == 10 )
		set k = GetRandomInt(1,10)
		set tmp = s[i]
		set s[i] = s[k]
		set s[k] = tmp
		set i = i + 1
	endloop
	
	
	set orders[1]="request_hero"
	set orders[2]="mechanicalcritter"
	set orders[3]="militia"
	set orders[4]="militiaconvert"
	set orders[5]="windwalk"
	set orders[6]="militiaoff"
	set orders[7]="militiaunconvert"
	set orders[8]="mindrot"
	set orders[9]="monsoon"
	set orders[10]="mount"
	set i=1
	loop
		set ids[i]='Z600'+i
		set upg[i]='Y600'+i
		set imgs[i]=GetAbilitySoundById(ids[i],SOUND_TYPE_EFFECT_LOOPED)
		set i=i+1
		exitwhen i>9
	endloop
	set ids[10]='Z610'//Z610 -> Deafening Blast
	set upg[10]='Y610'
	set imgs[10]=GetAbilitySoundById(ids[10],SOUND_TYPE_EFFECT_LOOPED)
	
	set i=Sieger-1
	call ConvertSkillData(i*4+1,ST(i*4+1,orders[s[1]]),ids[s[1]],0,upg[s[1]],hotkeys[s[1]])
	call ConvertSkillData(i*4+2,ST(i*4+2,orders[s[2]]),ids[s[2]],0,upg[s[2]],hotkeys[s[2]])
	call ConvertSkillData(i*4+3,ST(i*4+3,orders[s[3]]),ids[s[3]],0,upg[s[3]],hotkeys[s[3]])
	call ConvertSkillData(i*4+4,null,0,0,0,"_")
	set IsAbilityDoesNotWork[i*4+4]=true
	call SunStrikeUniqueness(i,ids[s[1]],ids[s[2]],ids[s[3]],0)
	
	set i=Sorcesser-1
	call ConvertSkillData(i*4+1,ST(i*4+1,orders[s[4]]),ids[s[4]],0,upg[s[4]],hotkeys[s[4]])
	call ConvertSkillData(i*4+2,ST(i*4+2,orders[s[5]]),ids[s[5]],0,upg[s[5]],hotkeys[s[5]])
	call ConvertSkillData(i*4+3,ST(i*4+3,orders[s[6]]),ids[s[6]],0,upg[s[6]],hotkeys[s[6]])
	call ConvertSkillData(i*4+4,null,0,0,0,"_")
	set IsAbilityDoesNotWork[i*4+4]=true
	call SunStrikeUniqueness(i,ids[s[4]],ids[s[5]],ids[s[6]],0)
	
	set i=Invoker-1
	call ConvertSkillData(i*4+1,ST(i*4+1,orders[s[7]]),ids[s[7]],0,upg[s[7]],hotkeys[s[7]])
	call ConvertSkillData(i*4+2,ST(i*4+2,orders[s[8]]),ids[s[8]],0,upg[s[8]],hotkeys[s[8]])
	call ConvertSkillData(i*4+3,ST(i*4+3,orders[s[9]]),ids[s[9]],0,upg[s[9]],hotkeys[s[9]])
	call ConvertSkillData(i*4+4,ST(i*4+4,orders[s[10]]),ids[s[10]],0,upg[s[10]],hotkeys[s[10]])
	call SunStrikeUniqueness(i,ids[s[7]],ids[s[8]],ids[s[9]],ids[s[10]])
	
	set i=Sieger-1
	loop
		exitwhen i>Invoker-1
		if SkillID[i*4+1]=='Z610' then
			call BSFC(i*4+1)
			set i=1231
		elseif SkillID[i*4+2]=='Z610' then
			call BSFC(i*4+2)
			set i=1231
		elseif SkillID[i*4+3]=='Z610' then
			call BSFC(i*4+3)
			set i=1231
		elseif SkillID[i*4+4]=='Z610' then
			call BSFC(i*4+4)
			set i=1231
		endif
		set i=i+1
	endloop
	
endfunction

function BBD takes integer pid,integer i returns nothing//SD mode
	if pid==0 or pid==6 or i==0 then
		return
	endif
	if IsPlayer(Player(pid))==false and IsL1ch==false then
		return
	endif
	call SDWrapper(pid,false)
endfunction

function Mode_SDRollHeroes takes nothing returns nothing
	local integer PlayerId=0
	local integer i
	local integer c=11+i_BonusDraftAmount
	loop
		set i=1
		loop
			call BBD(PlayerId,i)
			set i=i+1
			exitwhen(i>c)
		endloop
		set PlayerId=PlayerId+1
		if PlayerId==6 then
			set PlayerId=7
		endif
		exitwhen(PlayerId>11)
	endloop
endfunction

function BCD takes nothing returns nothing
	call RemoveDefaultTaverns()
	call RandomizeHeroPool()
	call ExecuteFunc("Mode_SDRollHeroes")
	call ExecuteFunc("VS9")
	call PanCameraToTimed(-7008.,6816.,.0)
endfunction

function BUD takes nothing returns nothing
	local integer PlayerId=LoadInteger(HY,'0REA','0PID')
	local integer SJ8=LoadInteger(HY,'0REA','0SID')
	local boolean QY8=LoadBoolean(HY,'0REA','000B')
	call CheckAbilitiesForStacking(SJ8,PlayerId,QY8)
endfunction

function B3D takes nothing returns nothing
	local integer PlayerId=0
	local integer SJ8=0
	local integer BJD=0
	set PlayerId=1
	loop
		if QV8(PlayerId)then
			if NumberOfExtraAbilities>=1 then
				loop
					if s_MainMode=="sd" or s_MainMode=="md" then
						loop
							set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
							exitwhen b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+BJD] and IsHeroIngame[BJD]==false
						endloop
						set BJD=HeroNumArrayRandomized[BJD]
					else
						loop
							set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
							exitwhen(IsHeroIngame[BJD]==false and GetPlayerTechMaxAllowed(Player(PlayerId),HeroID[BJD-1])>0)
						endloop
					endif
					set SJ8=(BJD-1)*4
					set SJ8=SJ8+GetRandomInt(1,3)
					call SaveInteger(HY,'0REA','0PID',PlayerId)
					call SaveInteger(HY,'0REA','0SID',SJ8)
					call SaveBoolean(HY,'0REA','000B',false)
					call ExecuteFunc("BUD")
					exitwhen PlayerSkillNumber[PlayerId*PlayerSkillOffset+5]!=0
				endloop
			endif
			if NumberOfExtraAbilities>=2 then
				loop
					if s_MainMode=="sd" or s_MainMode=="md" then
						loop
							set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
							exitwhen b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+BJD] and IsHeroIngame[BJD]==false
						endloop
						set BJD=HeroNumArrayRandomized[BJD]
					else
						loop
							set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
							exitwhen(IsHeroIngame[BJD]==false and GetPlayerTechMaxAllowed(Player(PlayerId),HeroID[BJD])>0)
						endloop
					endif
					set SJ8=(BJD-1)*4+4
					call SaveInteger(HY,'0REA','0PID',PlayerId)
					call SaveInteger(HY,'0REA','0SID',SJ8)
					call SaveBoolean(HY,'0REA','000B',false)
					call ExecuteFunc("BUD")
					exitwhen PlayerSkillNumber[PlayerId*PlayerSkillOffset+6]!=0
				endloop
			endif
		endif
		set PlayerId=PlayerId+1
		if PlayerId==6 then
			set PlayerId=7
		endif
		exitwhen(PlayerId>12)
	endloop
endfunction

function RDDisplayTimers takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local image im
	local integer delay=LoadInteger(HY,h,0)-1
	local real x=LoadReal(HY,h,10)
	local real y=LoadReal(HY,h,11)
	local string s
	set im=LoadImageHandle(HY,h,1)
	call DestroyImage(im)
	set im=LoadImageHandle(HY,h,2)
	call DestroyImage(im)
	if delay<0 then
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
		set t=null
		return
	endif
	set s=I2S(delay)
	
	if delay<10 then
		set s="0"+s
	endif
	call WriteImageOnGround("Fonts\\"+SubString(s,0,1)+".blp",60,60,x,y,0,true)
	call SaveImageHandle(HY,h,1,tt_image1)
	call SetImageColor(tt_image1,255,255,255,255)
	call WriteImageOnGround("Fonts\\"+SubString(s,1,2)+".blp",60,60,x+40,y,0,true)
	call SaveImageHandle(HY,h,2,tt_image1)
	call SetImageColor(tt_image1,255,255,255,255)
	
	call SaveInteger(HY,h,0,delay)
	
	set t=null
endfunction

function RDDisplayTimersInit takes real delay returns nothing
	local integer ht=GetHandleId(GetTriggeringTrigger())
	local timer oldtimer=LoadTimerHandle(HY,ht,5)
	local integer oh=GetHandleId(oldtimer)
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local image im1
	local image im2
	local string s=I2S(R2I(delay))
	local real x=-7030
	local real y=6766
	if oh>1 then
		set im1=LoadImageHandle(HY,oh,1)
		set im2=LoadImageHandle(HY,oh,2)
		call DestroyImage(im1)
		call DestroyImage(im2)
		call PauseTimer(oldtimer)
		call DestroyTimer(oldtimer)
		call FlushChildHashtable(HY,oh)
	endif
	call SaveTimerHandle(HY,ht,5,t)
	call SaveReal(HY,h,10,x)
	call SaveReal(HY,h,11,y)
	call WriteImageOnGround("Fonts\\"+SubString(s,0,1)+".blp",60,60,x,y,0,true)
	call SaveImageHandle(HY,h,1,tt_image1)
	call SetImageColor(tt_image1,255,255,255,255)
	call WriteImageOnGround("Fonts\\"+SubString(s,1,2)+".blp",60,60,x+40,y,0,true)
	call SaveImageHandle(HY,h,2,tt_image1)
	call SetImageColor(tt_image1,255,255,255,255)
	call TimerStart(t,1,true,function RDDisplayTimers)
	call SaveInteger(HY,h,0,R2I(delay))
	set oldtimer=null
	set t=null
endfunction

function RDShowNoteYourPick takes integer h, real x, real y returns nothing
	local integer i=0
	local string s="YOUR PICK"
	local integer k=0
	call WriteImageOnGround("Fonts\\Y.blp",60,60,x-40*4,y,0,true)
	call SetImageColor(tt_image1,255,0,0,k)
	call SaveImageHandle(HY,h,200+0,tt_image1)
	call WriteImageOnGround("Fonts\\O.blp",60,60,x-40*3,y,0,true)
	call SetImageColor(tt_image1,255,0,0,k)
	call SaveImageHandle(HY,h,200+1,tt_image1)
	call WriteImageOnGround("Fonts\\U.blp",60,60,x-40*2,y,0,true)
	call SetImageColor(tt_image1,255,0,0,k)
	call SaveImageHandle(HY,h,200+2,tt_image1)
	call WriteImageOnGround("Fonts\\R.blp",60,60,x-40*1,y,0,true)
	call SetImageColor(tt_image1,255,0,0,k)
	call SaveImageHandle(HY,h,200+3,tt_image1)
	call WriteImageOnGround("Fonts\\P.blp",60,60,x+40*1,y,0,true)
	call SetImageColor(tt_image1,255,0,0,k)
	call SaveImageHandle(HY,h,200+4,tt_image1)
	call WriteImageOnGround("Fonts\\I.blp",60,60,x+40*2,y,0,true)
	call SetImageColor(tt_image1,255,0,0,k)
	call SaveImageHandle(HY,h,200+5,tt_image1)
	call WriteImageOnGround("Fonts\\C.blp",60,60,x+40*2.5,y,0,true)
	call SetImageColor(tt_image1,255,0,0,k)
	call SaveImageHandle(HY,h,200+6,tt_image1)
	call WriteImageOnGround("Fonts\\K.blp",60,60,x+40*3.5,y,0,true)
	call SetImageColor(tt_image1,255,0,0,k)
	call SaveImageHandle(HY,h,200+7,tt_image1)
endfunction

function RDSpawnHero takes player p, unit seller returns nothing
	local integer pid=GetPlayerId(p)
	local unit u
	local integer hu=GetHandleId(seller)
	local integer h=GetHandleId(GetTriggeringTrigger())
	local integer i=LoadInteger(HY,hu,0)
	set b_isPlayerReady[pid]=true
	set PlayerSkillNumber[pid*PlayerSkillOffset+1]=LoadInteger(HY,h,100*i+1)
	set PlayerSkillNumber[pid*PlayerSkillOffset+2]=LoadInteger(HY,h,100*i+2)
	set PlayerSkillNumber[pid*PlayerSkillOffset+3]=LoadInteger(HY,h,100*i+3)
	set PlayerSkillNumber[pid*PlayerSkillOffset+4]=LoadInteger(HY,h,100*i+4)
	set PlayerSkillNumber[pid*PlayerSkillOffset+5]=LoadInteger(HY,h,100*i+5)
	set PlayerSkillNumber[pid*PlayerSkillOffset+6]=LoadInteger(HY,h,100*i+6)
	call BID(PlayerSkillNumber[pid*PlayerSkillOffset+1])
	call BID(PlayerSkillNumber[pid*PlayerSkillOffset+2])
	call BID(PlayerSkillNumber[pid*PlayerSkillOffset+3])
	call BID(PlayerSkillNumber[pid*PlayerSkillOffset+4])
	call BID(PlayerSkillNumber[pid*PlayerSkillOffset+5])
	call BID(PlayerSkillNumber[pid*PlayerSkillOffset+6])
	call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-250)
	if IsSentinel(p)then
		set udg_Hero[pid]=CreateUnit(p,HeroID[GetUnitUserData(seller)],GetRectCenterX(gg_rct_Hero_Creation_NE),GetRectCenterY(gg_rct_Hero_Creation_NE),0)
		call ShowUnit(seller,false)
		call UnitApplyTimedLife(seller,'BTLF',120)
		set u=CreateUnit(p,HeroDummy[GetUnitUserData(seller)],-7250+(GetPlayerId(p)-1)*110,6900,270)
	else
		set udg_Hero[pid]=CreateUnit(p,HeroID[GetUnitUserData(seller)],GetRectCenterX(gg_rct_Hero_Creation_UD),GetRectCenterY(gg_rct_Hero_Creation_UD),0)
		call ShowUnit(seller,false)
		call UnitApplyTimedLife(seller,'BTLF',120)
		set u=CreateUnit(p,HeroDummy[GetUnitUserData(seller)],-7250+(GetPlayerId(p)-7)*110,6590,90)
	endif
	call PauseUnit(u,true)
	call SaveUnitHandle(HY,h,100+i,u)
	call SetUnitUserData(seller,0)
	set u=null
endfunction

function RDGetRandomHero takes integer pid returns nothing
	local player p=Player(pid)
	local integer i=0
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit u
	loop
		set i=GetRandomInt(1,Mode_RD_Count)
		set u=LoadUnitHandle(HY,h,50+i)
		exitwhen GetUnitUserData(u)!=0
	endloop
	call RDSpawnHero(p,u)
	set u=null
endfunction

function RDUnitSold takes nothing returns nothing
	local unit u=GetSoldUnit()
	local player p=GetOwningPlayer(u)
	local integer pid=GetPlayerId(p)
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit seller
	if GetUnitTypeId(u)=='h06N'then//h06N -> S|cffffcc00e|rlect Hero
		call RemoveUnit(u)
		set u=null
		if pid!=LoadInteger(HY,h,10) and pid!=LoadInteger(HY,h,11) then
			call Error(p,"It's not your turn.")
		else
			set seller=GetSellingUnit()
			call RDSpawnHero(p,seller)
			if pid==LoadInteger(HY,h,10) then
				call RemoveSavedInteger(HY,h,10)
			else
				call RemoveSavedInteger(HY,h,11)
			endif
			
		endif
	endif
endfunction

function RDDestroyYourPickLabel takes integer h returns nothing
	call DestroyImage(LoadImageHandle(HY,h,200+0))
	call DestroyImage(LoadImageHandle(HY,h,200+1))
	call DestroyImage(LoadImageHandle(HY,h,200+2))
	call DestroyImage(LoadImageHandle(HY,h,200+3))
	call DestroyImage(LoadImageHandle(HY,h,200+4))
	call DestroyImage(LoadImageHandle(HY,h,200+5))
	call DestroyImage(LoadImageHandle(HY,h,200+6))
	call DestroyImage(LoadImageHandle(HY,h,200+7))
endfunction

function RDHideYourPickLabel takes integer h returns nothing
	call SetImageColor(LoadImageHandle(HY,h,200+0),255,0,0,0)
	call SetImageColor(LoadImageHandle(HY,h,200+1),255,0,0,0)
	call SetImageColor(LoadImageHandle(HY,h,200+2),255,0,0,0)
	call SetImageColor(LoadImageHandle(HY,h,200+3),255,0,0,0)
	call SetImageColor(LoadImageHandle(HY,h,200+4),255,0,0,0)
	call SetImageColor(LoadImageHandle(HY,h,200+5),255,0,0,0)
	call SetImageColor(LoadImageHandle(HY,h,200+6),255,0,0,0)
	call SetImageColor(LoadImageHandle(HY,h,200+7),255,0,0,0)
endfunction

function RDShowYourPickLabel takes integer h returns nothing
	call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,10,GetObjectName('n068'))//n068 -> |c006699CCSelect a hero and accept him with the|r |c00ff0303Select Hero|r |c00ff0303button|r
	call SetImageColor(LoadImageHandle(HY,h,200+0),255,0,0,255)
	call SetImageColor(LoadImageHandle(HY,h,200+1),255,0,0,255)
	call SetImageColor(LoadImageHandle(HY,h,200+2),255,0,0,255)
	call SetImageColor(LoadImageHandle(HY,h,200+3),255,0,0,255)
	call SetImageColor(LoadImageHandle(HY,h,200+4),255,0,0,255)
	call SetImageColor(LoadImageHandle(HY,h,200+5),255,0,0,255)
	call SetImageColor(LoadImageHandle(HY,h,200+6),255,0,0,255)
	call SetImageColor(LoadImageHandle(HY,h,200+7),255,0,0,255)
endfunction

function RDPickingGoGo takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u
	local integer c=LoadInteger(HY,h,0)
	local integer i
	local string s
	local string s1
	local string s2
	local integer pid1
	local integer pid2
	local integer UDc
	local integer NEc
	if GetTriggerEventId()==EVENT_UNIT_SELL then
		call RDUnitSold()
		set t=null
		return false
	endif
	if LoadBoolean(HY,h,0) then//self destruct
		set i=1
		call DestroyMultiboard(AbilityDraftMultiboard)
		call MultiboardDisplay(MainMB,true)
		call AddUnitToStock(ScourgeBuilding_ShopGraveyard,'h02C',2,4)//h02C -> Observer Wards
		call AddUnitToStock(SentinelBuilding_ShopChimaera,'h02C',2,4)//h02C -> Observer Wards
		loop
			set u=LoadUnitHandle(HY,h,50+i)
			call FlushChildHashtable(HY,GetHandleId(u))
			call RemoveUnit(u)
			if HaveSavedHandle(HY,h,100+i)then
				set u=LoadUnitHandle(HY,h,100+i)
				call FlushChildHashtable(HY,GetHandleId(u))
				call RemoveUnit(u)
			endif
			set i=i+1
			exitwhen i>Mode_RD_Count
		endloop
		call RDDestroyYourPickLabel(h)
		call FogModifierStop(LoadFogModifierHandle(HY,h,220))
		call DestroyFogModifier(LoadFogModifierHandle(HY,h,220))
		call FogModifierStop(LoadFogModifierHandle(HY,h,221))
		call DestroyFogModifier(LoadFogModifierHandle(HY,h,221))
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
		set t=null
		return false
	endif
	if c==0 then
		set i=GetRandomInt(1,2)
		if i==1 then
			set s="1221122112"
			call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Sentinels[0])]+GetObjectName('n065')+"|r will now begin the 1-2-2-2-2-1 draft")//n065 -> Sentinel
		else
			set s="2112211221"
			call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Scourges[0])]+GetObjectName('n06C')+"|r will now begin the 1-2-2-2-2-1 draft")//n06C -> Scourge
		endif
		call SaveStr(HY,h,0,s)
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15.00," ")
		
	endif
	set s=LoadStr(HY,h,0)
	if LoadInteger(HY,h,10)>0 and udg_Hero[LoadInteger(HY,h,10)]==null then
		call RDGetRandomHero(LoadInteger(HY,h,10))
	endif
	if LoadInteger(HY,h,11)>0 and udg_Hero[LoadInteger(HY,h,11)]==null then
		call RDGetRandomHero(LoadInteger(HY,h,11))
	endif
	
	if StringLength(s)>=c+1 then
		call RDHideYourPickLabel(h)
		set s1=SubString(s,c,c+1)
		set s2=SubString(s,c+1,c+2)
		set NEc=LoadInteger(HY,h,5)+1
		set UDc=LoadInteger(HY,h,6)+1
		set pid1=S2I(s1)
		set pid2=S2I(s2)
		if pid1!=pid2 then
			if pid1==1 then
				call SaveInteger(HY,h,10,GetPlayerId(Sentinels[NEc]))
				call SaveInteger(HY,h,5,NEc)
				call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Sentinels[NEc])]+PlayerNames[GetPlayerId(Sentinels[NEc])]+"|r "+GetObjectName('n064'))//n064 -> has 20 seconds to pick a hero
				if GetLocalPlayer()==Sentinels[NEc] then
					call RDShowYourPickLabel(h)
				endif
			else
				call SaveInteger(HY,h,10,GetPlayerId(Scourges[UDc]))
				call SaveInteger(HY,h,6,UDc)
				call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Scourges[UDc])]+PlayerNames[GetPlayerId(Scourges[UDc])]+"|r "+GetObjectName('n064'))//n064 -> has 20 seconds to pick a hero
				if GetLocalPlayer()==Scourges[UDc] then
					call RDShowYourPickLabel(h)
				endif
			endif
			call SaveInteger(HY,h,0,c+1)
		else
			if pid1==1 then
				call SaveInteger(HY,h,10,GetPlayerId(Sentinels[NEc]))
				call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Sentinels[NEc])]+PlayerNames[GetPlayerId(Sentinels[NEc])]+"|r "+GetObjectName('n064'))//n064 -> has 20 seconds to pick a hero
				if GetLocalPlayer()==Sentinels[NEc] then
					call RDShowYourPickLabel(h)
				endif
				if NEc+1<6 then
					call SaveInteger(HY,h,11,GetPlayerId(Sentinels[NEc+1]))
					call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Sentinels[NEc+1])]+PlayerNames[GetPlayerId(Sentinels[NEc+1])]+"|r "+GetObjectName('n064'))//n064 -> has 20 seconds to pick a hero
					if GetLocalPlayer()==Sentinels[NEc+1] then
						call RDShowYourPickLabel(h)
					endif
				endif
				call SaveInteger(HY,h,5,NEc+1)
			else
				call SaveInteger(HY,h,10,GetPlayerId(Scourges[UDc]))
				call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Scourges[UDc])]+PlayerNames[GetPlayerId(Scourges[UDc])]+"|r "+GetObjectName('n064'))//n064 -> has 20 seconds to pick a hero
				if GetLocalPlayer()==Scourges[UDc] then
					call RDShowYourPickLabel(h)
				endif
				if UDc+1<6 then
					call SaveInteger(HY,h,11,GetPlayerId(Scourges[UDc+1]))
					call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Scourges[UDc+1])]+PlayerNames[GetPlayerId(Scourges[UDc+1])]+"|r "+GetObjectName('n064'))//n064 -> has 20 seconds to pick a hero
					if GetLocalPlayer()==Scourges[UDc+1] then
						call RDShowYourPickLabel(h)
					endif
				endif
				call SaveInteger(HY,h,6,UDc+1)
			endif
			call SaveInteger(HY,h,0,c+2)
		endif
		call TriggerRegisterTimerEvent(t,20,false)
		call RDDisplayTimersInit(20)
	else
		call SaveBoolean(HY,h,0,true)//self-destroy
		call TriggerRegisterTimerEvent(t,20,false)
	endif
	set t=null
	return false
endfunction

function PrepareSkillsRD takes integer c, unit u, integer h returns nothing
	local integer i=0
	local integer SJ8
	local integer te
	set b_isPlayerReady[i]=false
	set PlayerSkillNumber[1]=0
	set PlayerSkillNumber[2]=0
	set PlayerSkillNumber[3]=0
	set PlayerSkillNumber[4]=0
	set PlayerSkillNumber[5]=0
	set PlayerSkillNumber[6]=0
	loop
		exitwhen b_isPlayerReady[i]
		set SJ8=(GetRandomInt(1,NumberOfHeroes*4))
		set te=((SJ8+3)/4)
		call SaveInteger(HY,'0REA','0PID',i)
		call SaveInteger(HY,'0REA','0SID',SJ8)
		call SaveBoolean(HY,'0REA','000B',false)
		call SaveUnitHandle(HY,'0REA','000U',u)
		call ExecuteFunc("BUD")
	endloop
	call SaveInteger(HY,h,100*c+1,PlayerSkillNumber[1])
	call SaveInteger(HY,h,100*c+2,PlayerSkillNumber[2])
	call SaveInteger(HY,h,100*c+3,PlayerSkillNumber[3])
	call SaveInteger(HY,h,100*c+4,PlayerSkillNumber[4])
	call SaveInteger(HY,h,100*c+5,PlayerSkillNumber[5])
	call SaveInteger(HY,h,100*c+6,PlayerSkillNumber[6])
	call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[1]]))
	call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[1]]),4)
	call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[2]]))
	call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[2]]),4)
	call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[3]]))
	call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[3]]),4)
	call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[4]]))
	call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[4]]),4)
	call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[5]]))
	call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[5]]),4)
	call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[6]]))
	call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[6]]),4)
	call SaveInteger(HY,GetHandleId(u),'RDIN'+1,PlayerSkillNumber[1])
	call SaveInteger(HY,GetHandleId(u),'RDIN'+2,PlayerSkillNumber[2])
	call SaveInteger(HY,GetHandleId(u),'RDIN'+3,PlayerSkillNumber[3])
	call SaveInteger(HY,GetHandleId(u),'RDIN'+4,PlayerSkillNumber[4])
	call SaveInteger(HY,GetHandleId(u),'RDIN'+5,PlayerSkillNumber[5])
	call SaveInteger(HY,GetHandleId(u),'RDIN'+6,PlayerSkillNumber[6])
endfunction

function ModeRDInit takes nothing returns nothing
	local integer array ids
	local integer i=1
	local integer rnd=0
	local unit u
	local real x
	local real y
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local fogmodifier fm
	local timer credits=CreateTimer()
	call TimerStart(credits,180,false,function ShowCredits)
	set credits=null
	call RDShowNoteYourPick(h,-7000,7080)
	set b_isPickTime=false
	set RepickAllowed=false
	set RandomAllowed=false
	call ShowUnit(TavernIntSent1,false)
	call ShowUnit(TavernIntSent2,false)
	call ShowUnit(TavernIntScourge1,false)
	call ShowUnit(TavernIntScourge2,false)
	call ShowUnit(TavernAgiSent1,false)
	call ShowUnit(TavernAgiSent2,false)
	call ShowUnit(TavernAgiScourge1,false)
	call ShowUnit(TavernAgiScourge2,false)
	call ShowUnit(TavernStrSent1,false)
	call ShowUnit(TavernStrSent2,false)
	call ShowUnit(TavernStrScourge1,false)
	call ShowUnit(TavernStrScourge2,false)
	loop
		loop
			set rnd=GetRandomInt(1,NumberOfHeroes)
			exitwhen HaveSavedBoolean(HY,'00RD',rnd)==false
		endloop
		call SaveBoolean(HY,'00RD',rnd,true)
		set x=-7030+450*Cos(i*(360. / Mode_RD_Count * 1.)*bj_DEGTORAD)
		set y=6766+450*Sin(i*(360. / Mode_RD_Count * 1.)*bj_DEGTORAD)
		set u=CreateUnit(Player(15),HeroDummy[rnd],x,y,AngleBetweenXY(x,y,-7030,6766))
		call SetUnitPathing(u,false)
		call SetUnitPosition(u,x,y)
		call SetUnitUserData(u,rnd)
		call SaveUnitHandle(HY,h,50+i,u)
		set ids[i]=rnd
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SELL)
		call PrepareSkillsRD(i,u,h)
		call SaveInteger(HY,GetHandleId(u),0,i)
		set i=i+1
		exitwhen i>Mode_RD_Count
	endloop
	set fm=CreateFogModifierRadius(Sentinels[1],FOG_OF_WAR_VISIBLE,-7030,6766,900,true,true)
	call SaveFogModifierHandle(HY,h,220,fm)
	call FogModifierStart(fm)
	set fm=CreateFogModifierRadius(Scourges[1],FOG_OF_WAR_VISIBLE,-7030,6766,900,true,true)
	call SaveFogModifierHandle(HY,h,221,fm)
	call FogModifierStart(fm)
	set fm=null
	set u=CreateUnit(Scourges[0],'e00E',-7030,6766,0)//e00E -> Spellcaster
	call UnitAddAbility(u,'A457')
	call IssuePointOrder(u,"silence",-7030,6766)
	call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20,"All players have 60 seconds to prepare before pick starts")
	call TriggerRegisterTimerEvent(t,60,false)
	call TriggerAddCondition(t,Condition(function RDPickingGoGo))
	if Mode_FN then
		set t=CreateTrigger()
		call TriggerRegisterTimerEvent(t,210,false)
		call TriggerAddCondition(t,Condition(function NeutralsRespawn))
		set t=null
	endif
	set t=null
	set u=null
endfunction

function B6D takes nothing returns nothing
	local string mn=MainModeInTxt
	local trigger t
	local timer credits
	if mn=="Allrandom" or mn=="Deathmatch" then
		set s_MainMode="ar"
		set b_isPickTime=false
		call AddUnitToStock(ScourgeBuilding_ShopGraveyard,'h02C',2,4)//h02C -> Observer Wards
		call AddUnitToStock(SentinelBuilding_ShopChimaera,'h02C',2,4)//h02C -> Observer Wards
		call CleanTaverns()
		set credits=CreateTimer()
		call TimerStart(credits,70,false,function ShowCredits)
		set credits=null
		if Mode_FN then
			call NeutralsRespawn()
			set t=CreateTrigger()
			call TriggerRegisterTimerEvent(t,30,false)
			call TriggerRegisterTimerEvent(t,90,false)
			call TriggerAddCondition(t,Condition(function NeutralsRespawn))
			set t=null
		endif
	elseif mn=="Allpick" then
		set s_MainMode="ap"
		call VS9()
		if Mode_RA then
			call B3D()
		endif
	elseif mn=="Randomdraft" then
		set s_MainMode="rd"
		call ModeRDInit()
	elseif mn=="Singledraft" then
		set s_MainMode="sd"
		call BCD()
		if Mode_RA then
			call B3D()
		endif
	elseif mn=="Mirrordraft" then
		set s_MainMode="md"
		call BAD()
		if Mode_RA then
			call B3D()
		endif
	endif
endfunction

function Abaddon_Frostmourne_Tick takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u
	if TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0) or GetUnitAbilityLevel(LoadUnitHandle(HY,h,0),'QH00')==0 then//QH00 -> Frostmourne FX
		set u=LoadUnitHandle(HY,h,0)
		call UnitRemoveAbility(u,'C104')
		call UnitRemoveAbility(u,'C105')
		call UnitRemoveAbility(u,'C106')
		call UnitRemoveAbility(u,'C107')
		call UnitRemoveAbility(u,'QH00')//QH00 -> Frostmourne FX
		call UnitRemoveAbility(u,'D107')//D107 -> |cffff0000Frostmourne|r
		call RemoveSavedHandle(HY,GetHandleId(u),'A0MG')//A0MG -> Frostmourne
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
		set u=null
	endif
	set t=null
endfunction

function Abaddon_Frostmourne_Apply takes unit attacker, unit target returns nothing
	local timer t=LoadTimerHandle(HY,GetHandleId(target),'A0MG')//A0MG -> Frostmourne
	local integer h
	if t!=null then
		set h=GetHandleId(t)
	else
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,0.1,true,function Abaddon_Frostmourne_Tick)
		call UnitAddAbility2(target,'C103'+GetUnitAbilityLevel(attacker,'A0MG'))//A0MG -> Frostmourne, QP18 -> Frostmourne
		call UnitAddAbility2(target,'QH00')//QH00 -> Frostmourne FX
		call SaveUnitHandle(HY,h,0,target)
		call SaveTimerHandle(HY,GetHandleId(target),'A0MG',t)//A0MG -> Frostmourne
	endif
	call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+2.5)
	set t=null
endfunction

function Abbadon_Frostmourne_Attack takes unit u, unit t returns nothing
	local integer level=GetUnitAbilityLevel(u,'A0MG')//A0MG -> Frostmourne, QP18 -> Frostmourne
	if IsUnitType(u,UNIT_TYPE_STRUCTURE) or IsUnitType(t,UNIT_TYPE_STRUCTURE) or IsUnitAlly(u,GetOwningPlayer(t)) then
		return
	endif
	if level>0 then
		call Buff_Add(u,'C107' + level,'D105',4.5)//D105 -> |cff32cd32Mark of the Abyss|r
//		set level = GetHandleId(t)
//		if LoadBoolean(MHT,level,1)==false then
//			call SaveBoolean(MHT,level,1,true)
//			call TriggerRegisterUnitEvent(GAME_TRIGGER,t,EVENT_UNIT_DAMAGED)
//		endif
		return
	endif
	if GetUnitAbilityLevel(t,'D107')==1 then//D107 -> |cffff0000Frostmourne|r
		set level=GetUnitAbilityLevel(t,'C104') + 2*GetUnitAbilityLevel(t,'C105') + 3*GetUnitAbilityLevel(t,'C106') +  4*GetUnitAbilityLevel(t,'C107')
		if level > 4 then
			set level = 4
		endif
		if level>0 then
			call Buff_Add(u,'C107' + level,'D105',4.5)//D105 -> |cff32cd32Mark of the Abyss|r
		endif
	endif
endfunction

function SaveAghanimUpgrade takes integer base, integer upg, integer upgid, integer visualid returns nothing
	local integer id=GetSkillIndex(base)
	set AghaBaseSpellID[AghaCounter]=base
	set AghaUpgradeID[AghaCounter]=upg
	call HideAbility(upg)
	set AghaUpgradedSpellID[AghaCounter]=upgid
	set AghaVisualId[AghaCounter]=visualid
	if id>0 and AlternateSkillID[id]==0 then
		set AlternateSkillID[id]=upgid
	endif
	set AghaCounter=AghaCounter+1
endfunction

function ConvertPassiveData takes integer rid, integer sid, integer lid, integer bid, integer hid, integer vid returns nothing
	set PassivesCount=PassivesCount+1
	set PassivesRealID[PassivesCount]=rid
	set PassivesSpellbookID[PassivesCount]=sid
	set PassivesLearningSkill[PassivesCount]=lid
	set PassivesBuffID[PassivesCount]=bid
	set PassivesLearningSkillUpg[PassivesCount]=hid
	set PassivesVisualID[PassivesCount]=vid
	call HideAbility(sid)
endfunction

function Illusions_PassivesWrapper takes unit Illusion, unit IllusionOriginal returns nothing
	local integer i=1
	local integer lvl
	loop
		set lvl=GetUnitAbilityLevel(IllusionOriginal,PassivesLearningSkill[i])
		//call echo(GetUnitName(IllusionOriginal)+" level of "+GetObjectName(PassivesLearningSkill[i])+" = "+I2S(lvl))
		if PassivesRealID[i]=='P084' then
			set lvl=GetUnitAbilityLevel(IllusionOriginal,'A0DB')//get juxtapose lvl for phantom edge//A0DB -> Juxtapose, QP0B -> Juxtapose
		endif
		if lvl==0 then
			if PassivesSpellbookID[i]>0 or PassivesRealID[i]>0 then
				call UnitRemoveAbility(Illusion,PassivesRealID[i])
				call UnitRemoveAbility(Illusion,PassivesSpellbookID[i])
				call UnitRemoveAbility(Illusion,PassivesBuffID[i])
			endif
		else
			if PassivesSpellbookID[i]>0 or PassivesRealID[i]>0 then
				call UnitAddAbility2(Illusion,PassivesSpellbookID[i])
				call UnitMakeAbilityPermanent(Illusion,true,PassivesRealID[i])
				call UnitAddAbility2(Illusion,PassivesLearningSkillUpg[i])
				if PassivesVisualID[i]>0 then
					call UnitAddAbility2(Illusion,PassivesVisualID[i])
					call SetUnitAbilityLevel(Illusion,PassivesVisualID[i],lvl)
				endif
				call SetUnitAbilityLevel(Illusion,PassivesRealID[i],lvl)
				if PassivesSpellbookID[i]=='A23F' then//split shot//A23F -> Split Shot Spell Book
					call SetUnitAbilityLevel(Illusion,'A1ER',lvl)//A1ER -> Split Shot Reduction Level 4
					call UnitAddAbility2(Illusion,'A1ER')//A1ER -> Split Shot Reduction Level 4
					call SetUnitAbilityLevel(Illusion,'A1ER',lvl)//A1ER -> Split Shot Reduction Level 4
				endif
			endif
		endif
		set i=i+1
		exitwhen i>PassivesCount
	endloop
endfunction

function FixPassiveSkills_LevelIllusions takes nothing returns boolean
	local unit Illusion=GetSummonedUnit()
	local integer PlayerId=GetPlayerId(GetOwningPlayer(Illusion))
	local integer PassiveId
	local unit IllusionOriginal=LoadUnitHandle(HY,GetHandleId(GetSummoningUnit()),'0ILU')
	local integer MorphID1
	local integer MorphID2
	local integer UnitID
	local real hp
	local integer lvl
	if IsUnitIllusion(Illusion)==false or GetUnitTypeId(Illusion)<1 then
		set Illusion=null
		set IllusionOriginal=null
		return false
	endif
	if GetUnitAbilityLevel(Illusion,'B0EN')>0 then//B0EN -> Illusion
		set PlayerId=TempInteger
	endif
	if IllusionOriginal!=null then
		set PlayerId=GetPlayerId(GetOwningPlayer(IllusionOriginal))
	else
		set IllusionOriginal=udg_Hero[PlayerId]
	endif
	call SaveUnitHandle(HY,GetHandleId(Illusion),'0ILU',IllusionOriginal)
	set UnitID=GetUnitTypeId(IllusionOriginal)
	if GetUnitTypeId(Illusion)!=UnitID then
		set hp=GetUnitState(Illusion,UNIT_STATE_MAX_LIFE)
		call UnitMakeAbilityPermanent(Illusion,true,'A09J') //Split Shot fix//A09J -> Split Shot
		set MorphID1=GetMorphId(GetUnitTypeId(Illusion))
		set MorphID2=GetMorphId(UnitID)
		call UnitAddAbility(Illusion,MorphID1)
		call UnitRemoveAbility(Illusion,MorphID1)
		call UnitAddAbility(Illusion,MorphID2+1)
		call UnitRemoveAbility(Illusion,MorphID2+1)
		loop
			exitwhen GetUnitState(Illusion,UNIT_STATE_MAX_LIFE)<=hp
			call UnitAddAbility(Illusion,'Z999')
			call SetUnitAbilityLevel(Illusion,'Z999',2)
			call UnitRemoveAbility(Illusion,'Z999')
		endloop
	endif
	call Illusions_PassivesWrapper(Illusion,IllusionOriginal)
	//call BonusEffectWrapper(Illusion,IllusionOriginal)
	if GetUnitAbilityLevel(IllusionOriginal,'A0VC')>0 then
		call SaveUnitHandle(TempHash,'ILLU',0,Illusion)
		call SaveUnitHandle(TempHash,'ILLU',1,IllusionOriginal)
		call ExecuteFunc("Trax_Marksmanship_Illusion")
	endif
	if GetUnitAbilityLevel(udg_Hero[PlayerId],'A0A8')>0 then
		call UnitAddAbility3(Illusion,'A3L3',GetUnitAbilityLevel(udg_Hero[PlayerId],'A0A8'))
	endif
	call RemoveAbilsForUnit(Illusion)
	set Illusion=null
	set IllusionOriginal=null
	return false
endfunction

function FixPassiveSkills_ReincarnationFix takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,2)
	local integer ShouldHideSomeMore=LoadInteger(HY,h,100)
	local integer pid=GetPlayerId(GetOwningPlayer(Hero))
	if Hero==null then
		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)
		set Hero=null
		set t=null
		return false
	endif
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		if FindItemOfType(Hero,Item_Real[Aegis])!=null then
			call TriggerRegisterTimerEvent(t,5.01,false) //Aegis
			call FixVisionGlitchOnBuyBack(Hero)
		elseif (GetUnitAbilityLevel(Hero,'A01Y')>0 or GetUnitAbilityLevel(Hero,'A1AZ')>0) and GetUnitState(Hero,UNIT_STATE_MANA)>=120+40*GetUnitAbilityLevel(Hero,'A01Y')+GetUnitAbilityLevel(Hero,'A1AZ') and ((TimerGetRemaining(PrimUltiTimer[pid])==0 and SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]]=='A01Y') or TimerGetRemaining(SecUltiTimer[pid])==0) then
		//A01Y -> Reincarnation, A1AZ -> Reincarnation upgrade, A01Y -> Reincarnation
			call TriggerRegisterTimerEvent(t,3.01,false) //Leoric Reincarnation
			call FixVisionGlitchOnBuyBack(Hero)
		endif
	else
		call RemoveAbilsForUnit(Hero)
	endif
	set Hero=null
	set t=null
	return false
endfunction

function FixPassiveSkills_FixHero takes nothing returns boolean
	local unit Hero=GetTriggerUnit()
	local integer PlayerId=GetPlayerId(GetOwningPlayer(Hero))
	local trigger t
	local integer h
	if b_isPickTime or (IsUnitType(Hero,UNIT_TYPE_HERO)==false or GetUnitTypeId(Hero)=='H00M' or GetUnitTypeId(Hero)=='H00Y' or GetUnitTypeId(Hero)=='H07G' or GetUnitTypeId(Hero)=='H0B8') then//H00M -> Bloodrune, H00Y -> Preloader Hero, H07G -> Storm Spirit unused, H0B8 -> Ice Blast
		set Hero=null
		return false
	endif
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerAddCondition(t,Condition(function FixPassiveSkills_ReincarnationFix))
	call SaveUnitHandle(HY,h,2,Hero)
	call SaveInteger(HY,h,100,2)
	set Hero=null
	set t=null
	return false
endfunction

function ExorcismGhost2 takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local unit hero=LoadUnitHandle(HY,h,1)
	if IsDead(u)==false then
		if hero==null or IsUnitType(u,UNIT_TYPE_HERO) then
			if GetUnitCurrentOrder(u)==852558 then
				call SaveUnitHandle(HY,h,1,GetOrderTargetUnit())
			endif
		else
			if DistanceBetweenUnits(u,hero)>1500 then
				if GetUnitCurrentOrder(u)==852557 then
					call SetUnitPosition(u,GetUnitX(hero),GetUnitY(hero))
					call IssueImmediateOrderById(u,852557)
				elseif GetUnitCurrentOrder(u)==852558 then 
					call SetUnitPosition(u,GetUnitX(hero),GetUnitY(hero))
					call IssueTargetOrderById(u,852558,hero)
				endif
			endif
		endif
	else
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	endif
	set u=null
	set t=null
endfunction

function ExorcismGhost takes unit u returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0.02,true,function ExorcismGhost2)
	call SaveUnitHandle(HY,h,0,u)
	call SaveUnitHandle(HY,h,1,udg_Hero[GetPlayerId(GetOwningPlayer(u))])
	set t=null
endfunction

function BonusHPAuraFilter takes nothing returns boolean
	return GetUnitAbilityLevel(GetFilterUnit(),'B0HL')>0 and IsUnitAlly(GetFilterUnit(),tt_player1) and AliveNonBuildOrMarker(GetFilterUnit())//B0HL -> Solid Granite Aura
endfunction

function BonusHPAuraTick takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local group affected=LoadGroupHandle(HY,h,1)
	local unit u=LoadUnitHandle(HY,h,0)
	local unit u2
	local group g
	local group gg
	local integer bon
	local integer savedbon
	if IsDead(u) or u==null then
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
		loop
			set u2=FirstOfGroup(affected)
			exitwhen u2==null
			call GroupRemoveUnit(affected,u2)
			call ManageBonusHP(u2, -1 * LoadInteger(MHT,GetHandleId(u2),'BHPA') )
			call SaveInteger(MHT,GetHandleId(u2),'BHPA',0)
			call UnitRemoveAbility(u2,'B0HL')//B0HL -> Solid Granite Aura
		endloop
		call KillGroup(affected)
	else
		set g=GetAvailableGroup()
		set tt_player1=GetOwningPlayer(u)
		call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),925,Condition(function BonusHPAuraFilter))
		set gg=GetAvailableGroup()
		call GroupAddGroup(affected,gg)
		loop
			set u2=FirstOfGroup(gg)
			exitwhen u2==null
			if IsUnitInGroup(u2,g)==false then
				call GroupRemoveUnit(affected,u2)
				call ManageBonusHP(u2, -1 * LoadInteger(MHT,GetHandleId(u2),'BHPA') )
				call SaveInteger(MHT,GetHandleId(u2),'BHPA',0)
				call UnitRemoveAbility(u2,'B0HL')//B0HL -> Solid Granite Aura
			endif
			call GroupRemoveUnit(gg,u2)
		endloop
		call KillGroup(gg)
		loop
			set u2=FirstOfGroup(g)
			exitwhen u2==null
			set savedbon=LoadInteger(MHT,GetHandleId(u2),'BHPA')
			set bon=R2I(R2I(GetUnitState(u2,UNIT_STATE_MAX_LIFE) - savedbon) * 0.15)
			if savedbon !=0 then
				if savedbon != bon then
					//call echo(GetUnitName(u2)+" have "+R2S(GetUnitState(u2,UNIT_STATE_MAX_LIFE))+" hp and get "+I2S(bon)+" (old = "+I2S(savedbon))
					call ManageBonusHP(u2, bon-savedbon)
				endif
			else
				//call echo(GetUnitName(u2)+" have "+R2S(GetUnitState(u2,UNIT_STATE_MAX_LIFE))+" hp and get "+I2S(bon)+" (old = "+I2S(savedbon))
				call ManageBonusHP(u2, bon)
			endif
			call SaveInteger(MHT,GetHandleId(u2),'BHPA',bon)
			call GroupRemoveUnit(g,u2)
			call GroupAddUnit(affected,u2)
		endloop
		call KillGroup(g)
	endif
	set t=null
	set affected=null
	set u=null
	set g=null
	set gg=null
endfunction

function BonusHPAura takes unit u returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0.5,true,function BonusHPAuraTick)
	call SaveUnitHandle(HY,h,0,u)
	call SaveGroupHandle(HY,h,1,GetAvailableGroup())
	set t=null
endfunction

function SummonsDamagePenaltyS6 takes nothing returns nothing
	local integer i=1
	local player p
	local unit u
	loop
		set p=Player(i)
		set u=CreateUnit(p,'e00I',0,0,0)
		call ShowUnit(u,false)
		call PauseUnit(u,true)
		set i=i+1
		exitwhen i>11
	endloop
endfunction

function BLD takes string Y9D returns boolean
	if Y9D=="-ma"or Y9D=="-ms"or Y9D=="-cs"or Y9D=="-cson"or Y9D=="-disablehelp"or Y9D=="-enablehelp"or Y9D=="-unstuck"or Y9D=="-recreate"then
		return true
	elseif Y9D=="-swaphero"or Y9D=="-showmsg"or Y9D=="-hidemsg"or Y9D=="-showdeny"or Y9D=="-hidedeny"or Y9D=="-weather rain"or Y9D=="-weather snow"or Y9D=="-weather moonlight"or Y9D=="-weather wind"or Y9D=="-weather random"or Y9D=="-weather off"or Y9D=="-denyinfo"or Y9D=="-di"or Y9D=="-deathon"or Y9D=="-don"or Y9D=="-deathoff"or Y9D=="-doff"or Y9D=="-roll"or Y9D=="-hideheronames"or Y9D=="-hhn"or Y9D=="-test"or Y9D=="-mute"or Y9D=="-wtf"or Y9D=="-fleshstr"or Y9D=="-fs"or Y9D=="-switchon"then
		return true
	endif
	return false
endfunction

function B1D takes nothing returns boolean
	return not IsHeroesAvailable
endfunction

function B0D takes string B5D returns nothing
	if FullModesString==""then
		set FullModesString="|c006699CC"+B5D+"|r"
	else
		set FullModesString=FullModesString+"/|c006699CC"+B5D+"|r"
	endif
endfunction

function B2D takes string s returns nothing
	if FullModesString=="" then
		set FullModesString="|c00C83264"+s+"|r"
	else
		set FullModesString=FullModesString+"/|c00C83264"+s+"|r"
	endif
endfunction

function C4D takes string C7D,integer C8D,integer C9D returns string
	return SubString(C7D,0,C8D)+SubString(C7D,C9D,StringLength(C7D))
endfunction

function CDD takes string C7D returns string
	return StringCase(SubString(C7D,1,StringLength(C7D)),false)
endfunction

function DelayedInitB takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local string s=LoadStr(HY,GetHandleId(t),0)
	call ExecuteFunc("StoreAghaUpgrades1")
	call ExecuteFunc("StoreAghaUpgrades2")
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTimer(t)
	set t=null
endfunction

function DelayedInit takes nothing returns nothing
	call TimerStart(CreateTimer(),0.5,false,function DelayedInitB)
endfunction

function CED takes string CFD,integer A5D returns nothing
	local string VHD=CDD(CFD)
	local string array CGD
	local string array CHDs
	local string array GameModeString
	local boolean array CIDs
	local integer lim
	local integer len=StringLength(VHD)
	local integer x=0
	local integer y=0
	local integer z=0
	local trigger t
	local boolean AP=false
	local boolean AR=false
	local boolean LM=false
	local boolean MM=false
	local boolean TR=false
	local boolean DM=false
	local boolean MR=false
	local boolean SP=false
	local boolean AA=false
	local boolean AI=false
	local boolean AS=false
	local boolean ID=false
	local boolean NP=false
	local boolean SC=false
	local boolean EM=false
	local boolean DU=false
	local boolean SH=false
	local boolean VR=false
	local boolean RV=false
	local boolean RD=false
	local boolean OM=false
	local boolean NT=false
	local boolean NB=false
	local boolean NM=false
	local boolean NS=false
	local boolean NR=false
	local boolean XL=false
	local boolean SD=false
	local boolean PM=false
	local boolean OI=false
	local boolean MI=false
	local boolean CM=false
	local boolean FR=false
	local boolean MO=false
	local boolean RO=false
	local boolean CD=false
	local boolean RS=false
	local boolean CP=false
	local boolean ZM=false
	local boolean UB=false
	local boolean UL=false
	local boolean SS=false
	local boolean AB=false
	local boolean S5=false
	local boolean S6=false
	local boolean FN=false
	local boolean D2=false
	local boolean D3=false
	local boolean D4=false
	local boolean D5=false
	local boolean OS=false
	local boolean BO=false
	local boolean MD=false
	local boolean RA=false
	local boolean LS=false
	local boolean LS3=false
	local boolean FF=false
	local boolean FUNHERO=false
	local boolean EBa=false
	local boolean MassAgh=false
	local boolean RC=false
	local boolean AH=false
	local boolean NN=false
	local boolean SO=false
	set ModeForTitle=VHD
	set CHDs[1]="ap"
	set CHDs[2]="ar"
	set CHDs[3]="dm"
	set CHDs[4]="sp"
	set CHDs[5]="aa"
	set CHDs[6]="ai"
	set CHDs[7]="as"
	set CHDs[8]="id"
	set CHDs[9]="np"
	set CHDs[10]="sc"
	set CHDs[11]="em"
	set CHDs[12]="du"
	set CHDs[13]="sh"
	set CHDs[14]="om"
	set CHDs[15]="nm"
	set CHDs[16]="nt"
	set CHDs[17]="nb"
	set CHDs[18]="ns"
	set CHDs[19]="nr"
	set CHDs[20]="sd"
	set CHDs[21]="pm"
	set CHDs[22]="oi"
	set CHDs[23]="mi"
	set CHDs[24]="fr"
	set CHDs[25]="mo"
	set CHDs[26]="ro"
	set CHDs[27]="zm"
	set CHDs[28]="ul"
	set CHDs[29]="ss"
	set CHDs[30]="ab"
	set CHDs[31]="s5"
	set CHDs[32]="s6"
	set CHDs[33]="fn"
	set CHDs[34]="d2"
	set CHDs[35]="d3"
	set CHDs[36]="d4"
	set CHDs[37]="d5"
	set CHDs[38]="os"
	set CHDs[39]="bo"
	set CHDs[40]="md"
	set CHDs[41]="ra"
	set CHDs[42]="3ls"
	set CHDs[43]="ls"
	set CHDs[44]="ff"
	set CHDs[45]="eb"
	set CHDs[46]="fh"
	set CHDs[47]="ma"
	set CHDs[48]="rc"
	set CHDs[49]="rd"
	set CHDs[50]="ah"
	set CHDs[51]="nn"
	set CHDs[52]="so"
	set lim=52
	
	set x=-1
	loop
		exitwhen x==len-1
		set x=x+1
		set y=x
		loop
			exitwhen y==len
			set y=y+1
			set z=1
			loop
				exitwhen z>lim
				if CHDs[z]==SubString(VHD,x,y)then
					set CIDs[z]=true
					set z=lim+1
					set VHD=C4D(VHD,x,y)
					set x=-1
					set len=StringLength(VHD)
					set y=len
				else
					set z=z+1
				endif
			endloop
		endloop
	endloop
	set AP=CIDs[1]
	set AR=CIDs[2]
	set DM=CIDs[3]
	set SP=CIDs[4]
	set AA=CIDs[5]
	set AI=CIDs[6]
	set AS=CIDs[7]
	set ID=CIDs[8]
	set NP=CIDs[9]
	set SC=CIDs[10]
	set EM=CIDs[11]
	set DU=CIDs[12]
	set SH=CIDs[13]
	set OM=CIDs[14]
	set NM=CIDs[15]
	set NT=CIDs[16]
	set NB=CIDs[17]
	set NS=CIDs[18]
	set NR=CIDs[19]
	set SD=CIDs[20]
	set PM=CIDs[21]
	set OI=CIDs[22]
	set MI=CIDs[23]
	set FR=CIDs[24]
	set MO=CIDs[25]
	set RO=CIDs[26]
	set ZM=CIDs[27]
	set UL=CIDs[28]
	set SS=CIDs[29]
	set AB=CIDs[30]
	set S5=CIDs[31]
	set S6=CIDs[32]
	set FN=CIDs[33]
	set D2=CIDs[34]
	set D3=CIDs[35]
	set D4=CIDs[36]
	set D5=CIDs[37]
	set OS=CIDs[38]
	set BO=CIDs[39]
	set MD=CIDs[40]
	set RA=CIDs[41]
	set LS3=CIDs[42]
	set LS=CIDs[43]
	set FF=CIDs[44]
	set EBa=CIDs[45]
	set FUNHERO=CIDs[46]
	set MassAgh=CIDs[47]
	set RC=CIDs[48]
	set RD=CIDs[49]
	set AH=CIDs[50]
	set NN=CIDs[51]
	set SO=CIDs[52]
	if VHD!=""or BLD(CFD)then
		return
	endif
	if LS3 and LS then
		call Error(PlayerModeTyper,GetObjectName('n02U'))//n02U -> Invalid Game Mode Combination!
		return
	endif
	if(AR and(AP or SD or MD))then
		call Error(PlayerModeTyper,GetObjectName('n02U'))//n02U -> Invalid Game Mode Combination!
		return
	endif
	if(AA and(AI or AS or DM))or(AS and(AI or DM))or(AI and DM)then
		call Error(PlayerModeTyper,GetObjectName('n02U'))//n02U -> Invalid Game Mode Combination!
		return
	endif
	if(RO and(MO or DM))or(MO and DM)then
		call Error(PlayerModeTyper,GetObjectName('n02U'))//n02U -> Invalid Game Mode Combination!
		return
	endif
	if(DM and(SH or SD or MD))or(SH and DM)then
		call Error(PlayerModeTyper,GetObjectName('n02T'))//n02T -> Deathmatch is not compatible with these modes!
		return
	endif
	if SD and(AP or AR or DM or SH or RO or MO or MD)then
		call Error(PlayerModeTyper,GetObjectName('n02U'))//n02U -> Invalid Game Mode Combination!
		return
	endif
	if S5 and S6 then
		call Error(PlayerModeTyper,"Modes <s5> and <s6> do not stack.")
		return
	endif
	if RA and not(S5 or S6)then
		call Error(PlayerModeTyper,"Mode <ra> only works with modes <s5> and <s6>.")
		return
	endif
	if RA and not(AP or SD or MD)then
		call Error(PlayerModeTyper,"Mode <ra> only works with modes <sd>, <ap> and <md>.")
		return
	endif
	if(D2 and(D3 or D4 or D5))or(D3 and(D2 or D4 or D5))or(D4 and(D2 or D3 or D5))or(D5 and(D2 or D3 or D4))then
		call Error(PlayerModeTyper,"Modes <d#> do not stack.")
		return
	endif
	if not(SD or MD or RD)and(D2 or D3 or D4 or D5)then
		call Error(PlayerModeTyper,"Modes <d#> only work with modes <sd>, <rd> and <md>.")
		return
	endif
	if not(AP or SD or MD)and SS then
		call Error(PlayerModeTyper,"Modes <ss> only work with modes <sd>, <ap> and <md>.")
		return
	endif
	if not(AP or SD or MD)and SP then
		call Error(PlayerModeTyper,"Mode -sp only work with modes <sd>, <ap> and <md>.")
		return
	endif
	if AP or AR or SD or MD or RD then
		call DisableTrigger(AR7)
	else
		return
	endif
	call UnTechAll()
	call Trig_display_leaderboard_Actions()
	call CreateObsBoard()
	set IsHeroesAvailable=true
	set ModeNameString=CDD(CFD)
	if AQ7 then
		call Traffic_RegisterData("Mode"+ModeNameString,0)
	else
		call Traffic_RegisterData("Mode"+ModeNameString,GetPlayerId(PlayerModeTyper))
	endif
	set Mode_Normal=false
	if DM then
		set MainModeInTxt=GetObjectName('n0II')//n0II -> Deathmatch
	elseif AP then
		set MainModeInTxt=GetObjectName('n0ID')//n0ID -> Allpick
	elseif AR then
		set MainModeInTxt=GetObjectName('n0I7')//n0I7 -> Allrandom
	elseif SD then
		set MainModeInTxt=GetObjectName('n0I4')//n0I4 -> Singledraft
	elseif MD then
		set MainModeInTxt="Mirrordraft"
	elseif RD then
		set MainModeInTxt="Randomdraft"
	endif
	if MD then
		set Mode_MD=true
		call B2D("Mirror Draft")
	endif
	if RD then
		set Mode_RD=true
		if D2 then
			set Mode_RD_Count=Mode_RD_Count+4
		elseif D3 then
			set Mode_RD_Count=Mode_RD_Count+8
		elseif D4 then
			set Mode_RD_Count=Mode_RD_Count+12
		elseif D5 then
			set Mode_RD_Count=Mode_RD_Count+16
		endif
		call B0D("Random Draft")
	endif
	if DM then
		call B0D(GetObjectName('n0IA'))//n0IA -> Death Match
	endif
	if AP then
		call B0D(GetObjectName('n0IL'))//n0IL -> All Pick
	endif
	if AR then
		call B0D(GetObjectName('n0IQ'))//n0IQ -> All Random
	endif
	if SP then
		call B0D(GetObjectName('n0IO'))//n0IO -> Shuffle Players
	endif
	if AA then
		call B0D(GetObjectName('n0IU'))//n0IU -> All Agility
	endif
	if AS then
		call B0D(GetObjectName('n0IP'))//n0IP -> All Strength
	endif
	if AI then
		call B0D(GetObjectName('n0IS'))//n0IS -> All Intelligence
	endif
	if RO then
		call B0D(GetObjectName('n0IT'))//n0IT -> Range Only
	endif
	if MO then
		call B0D(GetObjectName('n032'))//n032 -> Melee Only
	endif
	if DU then
		call B0D(GetObjectName('n0IX'))//n0IX -> Duplicate Mode
	endif
	if ID then
		call B0D(GetObjectName('n0IZ'))//n0IZ -> Item Drop
	endif
	if NP then
		call B0D(GetObjectName('n0J6'))//n0J6 -> No Powerups
	endif
	if SC then
		call B0D(GetObjectName('n0J7'))//n0J7 -> Super Creeps
	endif
	if EM then
		call B0D(GetObjectName('n0J9'))//n0J9 -> Easy Mode
	endif
	if SH then
		call B0D(GetObjectName('n0JA'))//n0JA -> Same Hero
	endif
	if OM then
		call B0D(GetObjectName('n0IV'))//n0IV -> Only Mid
	endif
	if NM then
		call B0D(GetObjectName('n0IR'))//n0IR -> No Mid
	endif
	if NB then
		call B0D(GetObjectName('n0JB'))//n0JB -> No Bot
	endif
	if NT then
		call B0D(GetObjectName('n0J8'))//n0J8 -> No Top
	endif
	if NS then
		call B0D(GetObjectName('n0JC'))//n0JC -> No Swap
	endif
	if NR then
		call B0D(GetObjectName('n0JF'))//n0JF -> No Repick
	endif
	if SD then
		call B0D(GetObjectName('n0J0'))//n0J0 -> Single Draft
		set Mode_SD=true
	endif
	if PM then
		call B0D(GetObjectName('n0IY'))//n0IY -> Pooling Mode
	endif
	if OI then
		call B0D(GetObjectName('n0J5'))//n0J5 -> Observer Info
	endif
	if FR then
		call B0D(GetObjectName('n0JD'))//n0JD -> Fast Respawn
	endif
	if SO then
		call B0D(GetObjectName('n0J2'))//n0J2 -> Switch On
		set Mode_SO=true
	endif
	if ZM then
		call B0D(GetObjectName('n0KA'))//n0KA -> Zoom Mode
	endif
	if D2 then
		call B2D("Draft 20")
		set Mode_D2=true
		set i_BonusDraftAmount=10
	endif
	if D3 then
		call B2D("Draft 30")
		set Mode_D3=true
		set i_BonusDraftAmount=20
	endif
	if D4 then
		call B2D("Draft 40")
		set Mode_D4=true
		set i_BonusDraftAmount=30
	endif
	if D5 then
		call B2D("Draft 50")
		set Mode_D5=true
		set i_BonusDraftAmount=40
	endif
	if S5 then
		call B2D("Five Skills")
		set NumberOfExtraAbilities=1
		set Mode_S5=true
		call UnitAddAbility(ScourgeFountain,'ACrk')//ACrk -> Resistant Skin
		call UnitAddAbility(SentFountain,'ACrk')//ACrk -> Resistant Skin
		call UnitAddAbility(ScourgeFountain,'A1BY')//A1BY -> True Strike
		call UnitAddAbility(SentFountain,'A1BY')//A1BY -> True Strike
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30," ")
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,"|c0066FF66"+"ATTENTION: FIFTH SKILL IS ADDED AT LEVEL: <5>, <8>, <11>, <14>"+"|r")
	endif
	if S6 then
		call B2D("Six Skills")
		set NumberOfExtraAbilities=2
		call Trig_display_leaderboard_Actions()
		set Mode_S6=true
		call SummonsDamagePenaltyS6()
		call UnitAddAbility(ScourgeFountain,'ACrk')//ACrk -> Resistant Skin
		call UnitAddAbility(SentFountain,'ACrk')//ACrk -> Resistant Skin
		call UnitAddAbility(ScourgeFountain,'A1BY')//A1BY -> True Strike
		call UnitAddAbility(SentFountain,'A1BY')//A1BY -> True Strike
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30," ")
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,"|c0066FF66"+"ATTENTION: FIFTH SKILL IS ADDED AT LEVEL: <5>, <8>, <11>, <14>"+"|r")
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,"|c0066FF66"+"ATTENTION: SIXTH SKILL IS ADDED AT LEVEL: <8>, <13>, <18>"+"|r")
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30," ")
//		if Mode_BO==false and then
//			call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,"|c00FF0000"+"WARNING: AGHANIM'S SCEPTER ONLY WORKS WITH YOUR FIRST ULT (4>6)"+"|r")
//		else
//			call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,"|c00FF0000"+"Note: Aghanim's Scepter upgrade both ultimates you have"+"|r")
//		endif
	endif
	if FF then
		call B2D("Fast Finish")
		set Mode_FF=true
	endif
	if AH then
		set Mode_AH=true
		call B2D("Anti Hack")
	endif
	if OS then
		call B2D("One Skill")
		set Mode_OS=true
	endif
	if RA then
		call B2D("Random Extra Abilities")
		set Mode_RA=true
	endif
	if BO then
		call B2D("Balance Off")
		set Mode_BO=true
	endif
	
	if NN then
		call B2D("No Neutrals")
		set Mode_NN=true
	endif
	if UL then
		call B2D("Unlimited Level")
		set MaximumLevel=2048
		set Mode_UL=true
	endif
	if SS then
		call B2D("See Skills")
		set Mode_SS=true
	endif
	if AB then
		call B2D("Anti Backdoor")
		set Mode_AB=true
	endif
	if FN then
		call B2D("Fast Neutrals")
		set Mode_FN=true
	endif
	if LS then
		call B2D("Limit Skills")
		set Mode_LS=true
	endif
	if FUNHERO then
		call B0D("Fun heroes")
	endif
	if LS3 then
		call B2D("Limit Skills 3")
		set Mode_LS=true
		set Mode_LS3=true
	endif
	if RC then
		call B2D("Rearm combos")
		set Mode_RC=true
	endif
	if LS or LS3 then
		call BanStunsFomComboing()
	endif
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,20.," ")
	if A5D==1 then
		call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,20.,udg_Colors[GetPlayerId(PlayerModeTyper)]+(PlayerNames[GetPlayerId((PlayerModeTyper))])+"|r"+" has selected "+FullModesString)
	else
		call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,20.,"Game mode automatically set to "+FullModesString)
	endif
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,20.,"For more information about the game modes use -gameinfo.")
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,20.," ")
	call ExecuteFunc("InitAllSkillsTable")
	call RunIfTrue("CZD",SP)
	call RunIfTrue("CCD",DM)
	call RunIfTrue("C6D",SH)
	call RunIfTrue("CLD",AA)
	call RunIfTrue("C1D",AI)
	call RunIfTrue("C0D",AS)
	call RunIfTrue("C5D",RO)
	call RunIfTrue("C2D",MO)
	call RunIfTrue("L4D",DU)
	call RunIfTrue("L7D",AR)
	call RunIfTrue("L9D",AP)
	call RunIfTrue("LMD",ID)
	call RunIfTrue("LND",NP)
	call RunIfTrue("InitSuperCreepsMode",SC)
	call RunIfTrue("LPD",EM)
	call RunIfTrue("LQD",OM)
	call RunIfTrue("LRD",NB)
	call RunIfTrue("LSD",NT)
	call RunIfTrue("LTD",NM)
	call RunIfTrue("LVD",NS)
	call RunIfTrue("LWD",NR)
	call RunIfTrue("LXD",PM)
	call RunIfTrue("LYD",OI)
	call RunIfTrue("LAD",FR)
	call RunIfTrue("L3D",ZM)
	call RunIfTrue("AntihackInit",AH)
	call ExecuteFunc("FixPassiveSkills")
	call ExecuteFunc("DelayedInit")
	call ExecuteFunc("B6D")
	set ModePickedBool=true
	call SetTime(0,0,false)
	call ModePicked()
	set t=null
endfunction

function LLD takes nothing returns nothing
	call CED(GetEventPlayerChatString(),1)
endfunction

function L1D takes nothing returns boolean
	set IsRGC=udg_ObserverMode and (GetPlayerName(udg_Observer1)=="|cFFFF0000RGC" or GetPlayerName(udg_Observer2)=="|cFFFF0000RGC")
	if HCLstring=="rgc" then
		set HCLstring="sdzm3lsso"
	elseif HCLstring=="rgc2" then
		set HCLstring="sds5zm3lsso"
	elseif HCLstring=="rgc3" then
		set HCLstring="sdd2s6osso"
	elseif HCLstring=="rgc4" then
		set HCLstring="md3lszmso"
	elseif HCLstring=="rgc5" then
		set HCLstring="mdd2s5zmulos3lsso"
	elseif HCLstring=="rgc6" then
		set HCLstring="mdd2s6zmulosso"
	elseif HCLstring=="rgc7" then
		set HCLstring="rdd2s6zmso"
	elseif HCLstring=="rgc8" then
		set HCLstring="rdd2lszmso"
	elseif HCLstring=="md" then
		set HCLstring="mds6d5ulabosfnzmso"
	elseif HCLstring=="sd" then
		set HCLstring="sds6d5ulabosfnzmso"
	elseif HCLstring=="ap" then
		set HCLstring="aps6ulabosfnzmso"
	elseif HCLstring=="ar" then
		set HCLstring="ardms6omfrulabzmso"
	elseif HCLstring=="ru0" then
		set HCLstring="mdabduffso"
	elseif HCLstring=="ru1" then
		set HCLstring="mdulabfnduffso"
	elseif HCLstring=="ru2" then
		set HCLstring="mds6ulabfnduffso"
	elseif HCLstring=="ru3" then
		set HCLstring="mds6ulabfnduffso"
	elseif HCLstring=="ru4" then
		set HCLstring="mdd2s6ulabfnduffso"
	elseif HCLstring=="ru5" then
		set HCLstring="mdd2s6ulabfnduboffso"
	elseif HCLstring=="ru6" then
		set HCLstring="sds6ulabfnduffso"
	elseif HCLstring=="ru7" then
		set HCLstring="sdd2s6ulabfnduffso"
	elseif HCLstring=="ru8" then
		set HCLstring="sdd2s6ulabfnduboffso"
	elseif HCLstring=="ru9" then
		set HCLstring="sdd5s6ulabfnduboffso"
	elseif HCLstring=="ru10" then
		set HCLstring="ardms6ulabfndubofrscffso"
	elseif HCLstring=="ru11" then
		set HCLstring="ardms6ulabfndubofrnpomffso"
	elseif HCLstring=="ru12" then
		set HCLstring="ardms6ulfndubofrscffnpntnmnbso"
	elseif HCLstring=="i1" then
		set HCLstring="mds6omnpd2abnnso"
	elseif HCLstring=="i2" then
		set HCLstring="sds6omnpd2abnnso"
	elseif HCLstring=="i3" then
		set HCLstring="sds6omnpd3abnnso"
	elseif HCLstring=="ohs1" then
		set HCLstring="sds6fnulboabd3ahso"
	elseif HCLstring=="ohs2" then
		set HCLstring="ardms6fnulboabahso"
	elseif HCLstring=="ohs3" then
		set HCLstring="aps6fnulboabssoslsahso"
	elseif HCLstring=="ohs4" then
		set HCLstring="sdd5s6ulabbofnfrahso"
	elseif HCLstring=="ohs5" then
		set HCLstring="mds6d2omfnulboahso"
	elseif HCLstring=="o1" then
		set HCLstring="ardms6boomfnulso"
	elseif HCLstring=="o2" then
		set HCLstring="mds6d3scfnulbonmso"
	elseif HCLstring=="rm1" then
		set HCLstring="mdd2s6fnfrboulscduabrcffah"
	elseif HCLstring=="rm2" then
		set HCLstring="sdd3s6fnfrboulscduabrcffmaah"
	elseif HCLstring=="ib1" then
		set HCLstring="sds6d2ulabosfnzm"
	elseif HCLstring=="ib2" then
		set HCLstring="sds6d3ulabosfnzm"
	elseif HCLstring=="ib3" then
		set HCLstring="mds6d3fnffulosab"
	elseif HCLstring=="ib4" then
		set HCLstring="mds6d4fnffulosab"
	endif
	if(HCLstring)!=""and ModePickedBool==false then
		set AQ7=true
		call CED("-"+(HCLstring),2)
	else
		call TriggerRegisterPlayerChatEvent(AR7,PlayerModeTyper,"-",false)
	endif
	return false
endfunction

function L9D takes nothing returns nothing
	local location SpawnSent=GetRectCenter(gg_rct_Allpick_Sent)
	local location SpawnScourge=GetRectCenter(gg_rct_Allpick_Scourge)
	local integer x=1
	local trigger t
	local integer h
	set Mode_AP=true
	set CreepSpawnTime=120
	loop
		exitwhen x>5
		if IsPlayer(Sentinels[x])then
			call PlacePickDummies(Sentinels[x])
		endif
		if IsPlayer(Scourges[x])then
			call PlacePickDummies(Scourges[x])
		endif
		set x=x+1
	endloop
	call RemoveLocation(SpawnSent)
	call RemoveLocation(SpawnScourge)
	set SpawnSent=null
	set SpawnScourge=null
	set t=null
endfunction

function GIE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer B78=(LoadInteger(HY,h,55))
	local player p
	local integer VA8
	local location SpawnSent=GetRectCenter(gg_rct_Hero_Creation_NE)
	local location SpawnScourge=GetRectCenter(gg_rct_Hero_Creation_UD)
	if B78<6 then
		set p=Sentinels[B78]
	elseif B78<11 then
		set p=Scourges[B78-5]
	endif
	if B78>10 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if Mode_DM==false then
			set RepickAllowed=true
		endif
	elseif B78<6 then
		call SaveInteger(HY,h,55,(B78+1))
		set udg_Hero[GetPlayerId(p)]=null
		set HeroTypeId[GetPlayerId(p)]=0
		if IsPlayer(p)then
			loop
				exitwhen udg_Hero[GetPlayerId(p)]!=null
				set VA8=GetSetElement()
				if IsHeroIngame[VA8]==false then
					if not Mode_DU then
						set b_isHeroPicked[VA8]=true
						set IsHeroIngame[VA8]=true
					endif
					set udg_Hero[GetPlayerId(p)]=CreateUnitAtLoc(p,HeroID[VA8],SpawnSent,bj_UNIT_FACING)
					set HeroTypeId[GetPlayerId(p)]=HeroID[VA8]
				endif
			endloop
		endif
	elseif B78<11 then
		call SaveInteger(HY,h,55,(B78+1))
		set udg_Hero[GetPlayerId(p)]=null
		set HeroTypeId[GetPlayerId(p)]=0
		if IsPlayer(p)then
			loop
				exitwhen udg_Hero[GetPlayerId(p)]!=null
				set VA8=GetSetElement()
				if IsHeroIngame[VA8]==false then
					if not Mode_DU then
						set b_isHeroPicked[VA8]=true
						set IsHeroIngame[VA8]=true
					endif
					set udg_Hero[GetPlayerId(p)]=CreateUnitAtLoc(p,HeroID[VA8],SpawnScourge,bj_UNIT_FACING)
					set HeroTypeId[GetPlayerId(p)]=HeroID[VA8]
				endif
			endloop
		endif
	endif
	call RemoveLocation(SpawnSent)
	call RemoveLocation(SpawnScourge)
	set SpawnSent=null
	set SpawnScourge=null
	set p=null
	set t=null
	return false
endfunction

function L7D takes nothing returns nothing
	local location SpawnSent=GetRectCenter(gg_rct_Hero_Creation_NE)
	local location SpawnScourge=GetRectCenter(gg_rct_Hero_Creation_UD)
	local location GJE=GetRectCenter(gg_rct_Hero_Creation_NE)
	local location GKE=GetRectCenter(gg_rct_Hero_Creation_UD)
	local integer VT8=1
	local integer VU8=5
	local integer VA8
	local trigger t
	set Mode_AR=true
	set RandomAllowed=false
	if not Mode_DU then
		call TechAll()
	endif
	set MinGoldForRepick=250
	call PanCameraToTimedLocForPlayer(Sentinels[1],GJE,0)
	call PanCameraToTimedLocForPlayer(Sentinels[2],GJE,0)
	call PanCameraToTimedLocForPlayer(Sentinels[3],GJE,0)
	call PanCameraToTimedLocForPlayer(Sentinels[4],GJE,0)
	call PanCameraToTimedLocForPlayer(Sentinels[5],GJE,0)
	call PanCameraToTimedLocForPlayer(Scourges[1],GKE,0)
	call PanCameraToTimedLocForPlayer(Scourges[2],GKE,0)
	call PanCameraToTimedLocForPlayer(Scourges[3],GKE,0)
	call PanCameraToTimedLocForPlayer(Scourges[4],GKE,0)
	call PanCameraToTimedLocForPlayer(Scourges[5],GKE,0)
	if Mode_SH then
		loop
			set VA8=GetSetElement()
			exitwhen IsHeroIngame[VA8]==false
		endloop
		if IsSentinel(PlayerModeTyper)then
			set udg_Hero[GetPlayerId(PlayerModeTyper)]=CreateUnit(PlayerModeTyper,HeroID[VA8],GetLocationX(SpawnSent),GetLocationY(SpawnSent),270)
			set HeroTypeId[GetPlayerId(PlayerModeTyper)]=HeroID[VA8]
		else
			set udg_Hero[GetPlayerId(PlayerModeTyper)]=CreateUnit(PlayerModeTyper,HeroID[VA8],GetLocationX(SpawnScourge),GetLocationY(SpawnScourge),270)
			set HeroTypeId[GetPlayerId(PlayerModeTyper)]=HeroID[VA8]
		endif
		call RemoveLocation(SpawnSent)
		call RemoveLocation(SpawnScourge)
		call RemoveLocation(GJE)
		call RemoveLocation(GKE)
		set SpawnSent=null
		set SpawnScourge=null
		set GJE=null
		set GKE=null
		set t=null
		return
	endif
	set RepickAllowed=false
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddCondition(t,Condition(function GIE))
	call SaveInteger(HY,(GetHandleId(t)),55,1)
	call RemoveLocation(SpawnSent)
	call RemoveLocation(SpawnScourge)
	call RemoveLocation(GJE)
	call RemoveLocation(GKE)
	set SpawnSent=null
	set SpawnScourge=null
	set GJE=null
	set GKE=null
	set t=null
endfunction

function HXE takes nothing returns nothing
	set Mode_NoDeath=true
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10,GetObjectName('n06K')+" "+GetObjectName('n06L'))//n06K -> No Deaths has been enabled., n06L -> You will have no respawn time.
	call DisableTrigger(GetTriggeringTrigger())
endfunction

function HYE takes nothing returns nothing
	local integer HZE=S2I(SubString(GetEventPlayerChatString(),6,StringLength(GetEventPlayerChatString())))
	if HZE>666 then
		call Error(PlayerModeTyper,GetObjectName('n03C'))//n03C -> Too many lives
	elseif HZE<10 then
		call Error(PlayerModeTyper,GetObjectName('n02I'))//n02I -> Too few lives
	else
		set ModeDM_MaxLifes=HZE
		call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10,GetObjectName('n06X')+" "+I2S(ModeDM_MaxLifes)+" "+GetObjectName('n06N'))//n06X -> Each team has, n06N -> lives before they lose the game.
		call DisableTrigger(GetTriggeringTrigger())
	endif
endfunction

function HAE takes nothing returns nothing
	call DisableTrigger((LoadTriggerHandle(HY,(GetHandleId(GetTriggeringTrigger())),170)))
	call DisableTrigger((LoadTriggerHandle(HY,(GetHandleId(GetTriggeringTrigger())),171)))
	call DisableTrigger(GetTriggeringTrigger())
endfunction

function HBE takes nothing returns nothing
	local trigger HCE=CreateTrigger()
	local trigger H3E=CreateTrigger()
	local trigger nd=CreateTrigger()
	set ModeDM_MaxLifes=66
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10.," ")
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10.,GetObjectName('n06O')+" -nd "+GetObjectName('n067')+" -lives xx "+GetObjectName('n06Q'))//n06O -> Extra commands:, n067 -> and, n06Q -> can be entered in the following 15 seconds. 
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10.,GetObjectName('n060')+" "+I2S(ModeDM_MaxLifes))//n060 -> Current DM lives are
	call TriggerRegisterTimerEvent(HCE,15,false)
	call TriggerAddAction(HCE,function HAE)
	call SaveTriggerHandle(HY,(GetHandleId(HCE)),170,(nd))
	call SaveTriggerHandle(HY,(GetHandleId(HCE)),171,(H3E))
	call TriggerRegisterPlayerChatEvent(nd,PlayerModeTyper,"-nd",true)
	call TriggerAddAction(nd,function HXE)
	call TriggerRegisterPlayerChatEvent(H3E,PlayerModeTyper,"-lives",false)
	call TriggerAddAction(H3E,function HYE)
	set HCE=null
	set H3E=null
	set nd=null
endfunction

function H6E takes nothing returns nothing
	local integer HLE=(LoadInteger(HY,(GetHandleId(GetTriggeringTrigger())),173))
	local integer VT8
	local integer VU8
	local integer VA8
	local integer B78
	local location SpawnSent=GetRectCenter(gg_rct_Allpick_Sent)
	local location SpawnScourge=GetRectCenter(gg_rct_Allpick_Scourge)
	if GameEnded then
		return
	endif
	if IsSentinel(Player(HLE))then
		set VT8=FirstSentinelHeroIndexid
		set VU8=LastSentinelHeroIndexid
		set B78=0
	else
		set VT8=FirstScourgeHeroIndexid
		set VU8=LastScourgeHeroIndexid
		set B78=1
	endif
	set VT8=FirstSentinelHeroIndexid
	set VU8=LastScourgeHeroIndexid
	call PlacePickDummies(Player(HLE))
	set tt_int1=HLE
	if not Mode_AR then
		loop
			exitwhen VT8>VU8
			if IsHeroIngame[VT8]==false then
				call SetPlayerTechMaxAllowed(Player(HLE),HeroID[VT8],999)
			endif
			set VT8=VT8+1
		endloop
		if(GetPlayerState(Player(HLE),PLAYER_STATE_RESOURCE_GOLD)<250)then
			call SetPlayerState(Player(HLE),PLAYER_STATE_RESOURCE_GOLD,250)
		endif
	elseif(DM_LivesUsed[B78]<ModeDM_MaxLifes)then
		if udg_Hero[HLE]!=null then
			call RemoveUnit(udg_Hero[HLE])
		endif
		set udg_Hero[HLE]=null
		set HeroTypeId[HLE]=0
		if IsPlayer(Player(HLE))then
			loop
				if IsSentinel(Player(HLE))then
					set udg_Hero[HLE]=CreateUnitAtLoc(Player(HLE),QC8(),SpawnSent,bj_UNIT_FACING)
					set HeroTypeId[HLE]=GetUnitTypeId(udg_Hero[HLE])
				else
					set udg_Hero[HLE]=CreateUnitAtLoc(Player(HLE),QC8(),SpawnScourge,bj_UNIT_FACING)
					set HeroTypeId[HLE]=GetUnitTypeId(udg_Hero[HLE])
				endif
				exitwhen udg_Hero[HLE]!=null
			endloop
		endif
	endif
	call TimerStart(PrimUltiTimer[HLE],0,false,null)
	call TimerStart(SecUltiTimer[HLE],0,false,null)
	call RemoveLocation(SpawnSent)
	call RemoveLocation(SpawnScourge)
	if not Mode_AR then
	endif
	set SpawnSent=null
	set SpawnScourge=null
endfunction

function CCD takes nothing returns nothing
	local location YT9
	local real H1E
	local trigger t
	local integer H0E
	local integer x
	set Mode_DM=true
	set x=1
	loop
		exitwhen x>5
		set H0E=GetPlayerId(Sentinels[x])
		set t=CreateTrigger()
		call TriggerRegisterTimerExpireEvent(t,HeroRespawnTimer[H0E])
		call TriggerAddAction(t,function H6E)
		call SaveInteger(HY,(GetHandleId(t)),173,(H0E))
		set H0E=GetPlayerId(Scourges[x])
		set t=CreateTrigger()
		call TriggerRegisterTimerExpireEvent(t,HeroRespawnTimer[H0E])
		call TriggerAddAction(t,function H6E)
		call SaveInteger(HY,(GetHandleId(t)),173,(H0E))
		set x=x+1
	endloop
	call UnitRemoveAbility(CirclesOfPower_1,'Aawa')//Aawa -> Revive Hero Instantly
	call UnitRemoveAbility(CirclesOfPower_2,'Aawa')//Aawa -> Revive Hero Instantly
	call UnitRemoveAbility(CirclesOfPower_3,'Aawa')//Aawa -> Revive Hero Instantly
	call UnitRemoveAbility(CirclesOfPower_4,'Aawa')//Aawa -> Revive Hero Instantly
	call UnitRemoveAbility(CirclesOfPower_5,'Aawa')//Aawa -> Revive Hero Instantly
	call UnitRemoveAbility(CirclesOfPower_7,'Aawa')//Aawa -> Revive Hero Instantly
	call UnitRemoveAbility(CirclesOfPower_8,'Aawa')//Aawa -> Revive Hero Instantly
	call UnitRemoveAbility(CirclesOfPower_9,'Aawa')//Aawa -> Revive Hero Instantly
	call UnitRemoveAbility(CirclesOfPower_10,'Aawa')//Aawa -> Revive Hero Instantly
	call UnitRemoveAbility(CirclesOfPower_11,'Aawa')//Aawa -> Revive Hero Instantly
	call ExecuteFunc("HBE")
	set YT9=null
	set t=null
endfunction

function L4D takes nothing returns nothing
	set Mode_DU=true
endfunction

function CZD takes nothing returns nothing
	local integer elfs=CountPlayersInForce(Force_Elfs)
	local integer unds=CountPlayersInForce(Force_Unds)
	local integer total=elfs+unds
	local integer k
	local integer o
	local integer x
	local integer y
	local integer z
	local player array players1
	local player array players2
	local integer w
	local location GJE=GetRectCenter(gg_rct_Hero_Creation_NE)
	local location GKE=GetRectCenter(gg_rct_Hero_Creation_UD)
	local location SpawnSent=GetRectCenter(gg_rct_Allpick_Sent)
	local location SpawnScourge=GetRectCenter(gg_rct_Allpick_Scourge)
	local integer i
	set Mode_SP=true
	call VG9(Sentinels[1])
	call VG9(Sentinels[2])
	call VG9(Sentinels[3])
	call VG9(Sentinels[4])
	call VG9(Sentinels[5])
	call VG9(Scourges[1])
	call VG9(Scourges[2])
	call VG9(Scourges[3])
	call VG9(Scourges[4])
	call VG9(Scourges[5])
	set x=1
	loop
		exitwhen x>5
		if IsPlayer(Sentinels[x])then
			call PlacePickDummies(Sentinels[x])
		endif
		if IsPlayer(Scourges[x])then
			call PlacePickDummies(Scourges[x])
		endif
		set x=x+1
	endloop
	call RemoveLocation(SpawnSent)
	call RemoveLocation(SpawnScourge)
	set players1[1]=null
	set players1[2]=null
	set players1[3]=null
	set players1[4]=null
	set players1[5]=null
	set players1[6]=null
	set players1[7]=null
	set players1[8]=null
	set players1[9]=null
	set players1[10]=null
	set z=1
	set w=1
	set k=1
	loop
		exitwhen k>5
		if(IsPlayer(Sentinels[k]))then
			set players1[w]=Sentinels[k]
			set w=w+1
		else
			set players2[z]=Sentinels[k]
			set z=z+1
		endif
		set k=k+1
	endloop
	set k=1
	loop
		exitwhen k>5
		if(IsPlayer(Scourges[k]))then
			set players1[w]=Scourges[k]
			set w=w+1
		else
			set players2[z]=Scourges[k]
			set z=z+1
		endif
		set k=k+1
	endloop
	set Sentinels[1]=null
	set Sentinels[2]=null
	set Sentinels[3]=null
	set Sentinels[4]=null
	set Sentinels[5]=null
	set Scourges[1]=null
	set Scourges[2]=null
	set Scourges[3]=null
	set Scourges[4]=null
	set Scourges[5]=null
	set k=1
	loop
		exitwhen k>(total/ 2)
		set o=GetRandomInt(1,total)
		if(players1[o]!=null)then
			set Sentinels[k]=players1[o]
			set players1[o]=null
			set k=k+1
		endif
	endloop
	set x=k
	set k=1
	loop
		exitwhen k>total-x+1
		set o=GetRandomInt(1,total)
		if(players1[o]!=null)then
			set Scourges[k]=players1[o]
			set players1[o]=null
			set k=k+1
		endif
	endloop
	set z=k
	set k=x
	set y=1
	loop
		exitwhen k>5
		set Sentinels[k]=players2[y]
		set y=y+1
		set k=k+1
	endloop
	set k=z
	loop
		exitwhen k>5
		set Scourges[k]=players2[y]
		set y=y+1
		set k=k+1
	endloop
	set k=0
	loop
		exitwhen k>5
		set k=k+1
	endloop
	call SetPlayerTeam(Sentinels[0],0)
	call SetPlayerTeam(Sentinels[1],0)
	call SetPlayerTeam(Sentinels[2],0)
	call SetPlayerTeam(Sentinels[3],0)
	call SetPlayerTeam(Sentinels[4],0)
	call SetPlayerTeam(Sentinels[5],0)
	call SetPlayerTeam(Scourges[0],1)
	call SetPlayerTeam(Scourges[1],1)
	call SetPlayerTeam(Scourges[2],1)
	call SetPlayerTeam(Scourges[3],1)
	call SetPlayerTeam(Scourges[4],1)
	call SetPlayerTeam(Scourges[5],1)
	set i=1
	loop
		set PlayersId[i]=GetPlayerId(Sentinels[i])
		set i=i+1
		exitwhen i>5
	endloop
	set i=7
	loop
		set PlayersId[i]=GetPlayerId(Scourges[i-6])
		set i=i+1
		exitwhen i>11
	endloop
	call HK9()
	set x=0
	set y=0
	loop
		exitwhen x>5
		loop
			exitwhen y>5
			call SetPlayerAllianceStateBJ(Sentinels[x],Sentinels[y],3)
			call SetPlayerAllianceStateBJ(Scourges[x],Scourges[y],3)
			call SetPlayerAllianceStateBJ(Sentinels[x],Scourges[y],0)
			call SetPlayerAllianceStateBJ(Scourges[x],Sentinels[y],0)
			set y=y+1
		endloop
		set y=0
		set x=x+1
	endloop
	call ForceClear(Force_Elfs)
	call ForceClear(Force_Unds)
	call ForceAddPlayer(Force_Elfs,Sentinels[0])
	call ForceAddPlayer(Force_Elfs,Sentinels[1])
	call ForceAddPlayer(Force_Elfs,Sentinels[2])
	call ForceAddPlayer(Force_Elfs,Sentinels[3])
	call ForceAddPlayer(Force_Elfs,Sentinels[4])
	call ForceAddPlayer(Force_Elfs,Sentinels[5])
	call ForceAddPlayer(Force_Unds,Scourges[0])
	call ForceAddPlayer(Force_Unds,Scourges[1])
	call ForceAddPlayer(Force_Unds,Scourges[2])
	call ForceAddPlayer(Force_Unds,Scourges[3])
	call ForceAddPlayer(Force_Unds,Scourges[4])
	call ForceAddPlayer(Force_Unds,Scourges[5])
	call ExecuteFunc("HM9")
	call Trig_display_leaderboard_Actions()
	set elfs=CountPlayersInForce(Force_Elfs)
	set unds=CountPlayersInForce(Force_Unds)
	set k=1
	loop
		exitwhen k>5
		if(IsPlayer(Sentinels[k]))then
			call SetPlayerStateBJ(Sentinels[k],PLAYER_STATE_RESOURCE_GOLD,(4375/ elfs))
			call SetPlayerStateBJ(Sentinels[k],PLAYER_STATE_RESOURCE_LUMBER,0)
		endif
		if(IsPlayer(Scourges[k]))then
			call SetPlayerStateBJ(Scourges[k],PLAYER_STATE_RESOURCE_GOLD,(4375/ unds))
			call SetPlayerStateBJ(Scourges[k],PLAYER_STATE_RESOURCE_LUMBER,0)
		endif
		set k=k+1
	endloop
	if udg_ObserverMode then
		set x=0
		loop
			exitwhen x>5
			call SetPlayerAlliance(Player(0),Sentinels[x],ConvertAllianceType(0),true)
			call SetPlayerAlliance(Player(0),Sentinels[x],ConvertAllianceType(4),true)
			call SetPlayerAlliance(Player(0),Scourges[x],ConvertAllianceType(0),false)
			call SetPlayerAlliance(Player(0),Scourges[x],ConvertAllianceType(4),false)
			set x=x+1
		endloop
	endif
	call StorePlayersColorValues()
	call RemoveLocation(GJE)
	call RemoveLocation(GKE)
	set GJE=null
	set GKE=null
	set SpawnSent=null
	set SpawnScourge=null
endfunction

function CLD takes nothing returns nothing
	local integer i
	local integer k
	set Mode_AA=true
	set i=1
	set k=IntHeroesAmount
	loop
		exitwhen i>k
		call TechHeroForAll(IntHeroesArray[i])
		set b_isHeroPicked[GetHeroIndexFromId(IntHeroesArray[i])]=true
		set i=i+1
	endloop
	set i=1
	set k=StrHeroesAmount
	loop
		exitwhen i>k
		call TechHeroForAll(StrHeroesArray[i])
		set b_isHeroPicked[GetHeroIndexFromId(StrHeroesArray[i])]=true
		set i=i+1
	endloop
endfunction

function IDE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer UZ8=(LoadInteger(HY,h,172))
	local player p
	local integer x=1
	loop
		exitwhen x>5
		set p=Sentinels[x]
		if IsPlayer(p)and p!=PlayerModeTyper then
			set udg_Hero[GetPlayerId(p)]=CreateUnit(p,UZ8,GetRectCenterX(gg_rct_Hero_Creation_NE),GetRectCenterY(gg_rct_Hero_Creation_NE),270)
			set HeroTypeId[GetPlayerId(p)]=UZ8
		endif
		set p=Scourges[x]
		if IsPlayer(p)and p!=PlayerModeTyper then
			set udg_Hero[GetPlayerId(p)]=CreateUnit(p,UZ8,GetRectCenterX(gg_rct_Hero_Creation_UD),GetRectCenterY(gg_rct_Hero_Creation_UD),270)
			set HeroTypeId[GetPlayerId(p)]=UZ8
		endif
		set x=x+1
	endloop
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set p=null
	return false
endfunction

function IEE takes nothing returns nothing
	local integer x=1
	local player p
	local unit Hero=GetTriggerUnit()
	local integer UZ8=GetUnitTypeId(Hero)
	local trigger t
	local integer h
	if(GetOwningPlayer(Hero)==PlayerModeTyper and IsUnitType(Hero,UNIT_TYPE_HERO))then
		call DisableTrigger(GetTriggeringTrigger())
		if HasUsedRandom[GetPlayerId(PlayerModeTyper)]==false and Mode_AR==false and Mode_TR==false then
			call SetPlayerState(PlayerModeTyper,PLAYER_STATE_RESOURCE_GOLD,250+GetPlayerState(PlayerModeTyper,PLAYER_STATE_RESOURCE_GOLD))
		endif
		set RepickHasBeenUsed[GetPlayerId(PlayerModeTyper)]=true
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,.01,false)
		call TriggerAddCondition(t,Condition(function IDE))
		call SaveInteger(HY,h,172,(UZ8))
	endif
	set p=null
	set Hero=null
	set t=null
endfunction

function C6D takes nothing returns nothing
	local integer x=1
	local trigger t=CreateTrigger()
	local region r=CreateRegion()
	set Mode_SH=true
	loop
		exitwhen x>5
		if(Sentinels[x]!=PlayerModeTyper)then
			call VS8(Sentinels[x])
			set HasUsedRandom[GetPlayerId(Sentinels[x])]=true
			set RepickHasBeenUsed[GetPlayerId(Sentinels[x])]=true
		endif
		if(Scourges[x]!=PlayerModeTyper)then
			call VS8(Scourges[x])
			set HasUsedRandom[GetPlayerId(Scourges[x])]=true
			set RepickHasBeenUsed[GetPlayerId(Scourges[x])]=true
		endif
		set x=x+1
	endloop
	call RegionAddRect(r,bj_mapInitialPlayableArea)
	call TriggerRegisterEnterRegion(t,r,Condition(function ReturnTrue))
	call TriggerAddAction(t,function IEE)
	set r=null
	set t=null
endfunction

function C0D takes nothing returns nothing
	local integer i
	local integer k
	set Mode_AS=true
	set i=1
	set k=IntHeroesAmount
	loop
		exitwhen i>k
		call TechHeroForAll(IntHeroesArray[i])
		set b_isHeroPicked[GetHeroIndexFromId(IntHeroesArray[i])]=true
		set IsHeroIngame[GetHeroIndexFromId(IntHeroesArray[i])]=true
		set i=i+1
	endloop
	set i=1
	set k=AgilityHeroesAmount
	loop
		exitwhen i>k
		call TechHeroForAll(AgiHeroesArray[i])
		set i=i+1
	endloop
endfunction

function C1D takes nothing returns nothing
	local integer i
	local integer k
	set Mode_AI=true
	set i=1
	set k=AgilityHeroesAmount
	loop
		exitwhen i>k
		call TechHeroForAll(AgiHeroesArray[i])
		set b_isHeroPicked[GetHeroIndexFromId(AgiHeroesArray[i])]=true
		set IsHeroIngame[GetHeroIndexFromId(AgiHeroesArray[i])]=true
		set i=i+1
	endloop
	set i=1
	set k=StrHeroesAmount
	loop
		exitwhen i>k
		call TechHeroForAll(StrHeroesArray[i])
		set b_isHeroPicked[GetHeroIndexFromId(StrHeroesArray[i])]=true
		set IsHeroIngame[GetHeroIndexFromId(StrHeroesArray[i])]=true
		set i=i+1
	endloop
endfunction

function C2D takes nothing returns nothing
	local integer i
	local integer k
	set Mode_MO=true
	set i=1
	set k=RangeHeroesAmount
	loop
		exitwhen i>k
		call TechHeroForAll(RangeHeroesArray[i])
		set b_isHeroPicked[GetHeroIndexFromId(RangeHeroesArray[i])]=true
		set IsHeroIngame[GetHeroIndexFromId(RangeHeroesArray[i])]=true
		set i=i+1
	endloop
endfunction

function C5D takes nothing returns nothing
	local integer i
	local integer k
	set Mode_RO=true
	set i=1
	set k=MeleeHeroesAmount
	loop
		exitwhen i>k
		call TechHeroForAll(MeleeHeroesArray[i])
		set b_isHeroPicked[GetHeroIndexFromId(MeleeHeroesArray[i])]=true
		set IsHeroIngame[GetHeroIndexFromId(MeleeHeroesArray[i])]=true
		set i=i+1
	endloop
endfunction

function LMD takes nothing returns nothing
	set Mode_ID=true
endfunction

function LPD takes nothing returns nothing
	set Mode_EM=true
//	call SetPlayerTechResearched(Sentinels[0],'R004',1)
//	call SetPlayerTechResearched(Scourges[0],'R004',1)
//	call SetPlayerHandicapXP(Sentinels[1],1.5)
//	call SetPlayerHandicapXP(Sentinels[2],1.5)
//	call SetPlayerHandicapXP(Sentinels[3],1.5)
//	call SetPlayerHandicapXP(Sentinels[4],1.5)
//	call SetPlayerHandicapXP(Sentinels[5],1.5)
//	call SetPlayerHandicapXP(Scourges[1],1.5)
//	call SetPlayerHandicapXP(Scourges[2],1.5)
//	call SetPlayerHandicapXP(Scourges[3],1.5)
//	call SetPlayerHandicapXP(Scourges[4],1.5)
//	call SetPlayerHandicapXP(Scourges[5],1.5)
endfunction

function LND takes nothing returns nothing
	set Mode_NP=true
	call DestroyTrigger(RuneSpawnTrigger)
endfunction

function InitSuperCreepsMode takes nothing returns nothing
	set Mode_SC=true
endfunction

function IFE takes nothing returns nothing
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10,GetObjectName('n0HA'))//n0HA -> No Neutrals has been enabled. Neutrals will not spawn.
	call DisableTrigger(GetTriggeringTrigger())
endfunction

function IGE takes nothing returns nothing
	call DisableTrigger((LoadTriggerHandle(HY,(GetHandleId(GetTriggeringTrigger())),174)))
	call DisableTrigger(GetTriggeringTrigger())
endfunction

function IHE takes nothing returns nothing
	local trigger HCE=CreateTrigger()
	local trigger t=CreateTrigger()
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10.," ")
	call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10.,"Extra commands: -noneutrals can be entered in the following 15 seconds. ")
	call TriggerRegisterTimerEvent(HCE,15,false)
	call TriggerAddAction(HCE,function IGE)
	call SaveTriggerHandle(HY,(GetHandleId(HCE)),174,(t))
	call TriggerRegisterPlayerChatEvent(t,PlayerModeTyper,"-noneutrals",true)
	call TriggerAddAction(t,function IFE)
	set HCE=null
	set t=null
endfunction

function LQD takes nothing returns nothing
	set Mode_OM=true
	if Mode_NN==false then
		call ExecuteFunc("IHE")
	endif
endfunction

function LRD takes nothing returns nothing
	set Mode_NB=true
endfunction

function LTD takes nothing returns nothing
	set Mode_NM=true
endfunction

function LSD takes nothing returns nothing
	set Mode_NT=true
endfunction

function LVD takes nothing returns nothing
	set Mode_NR=true
	set Mode_NS=true
endfunction

function LWD takes nothing returns nothing
	set Mode_NR2=true
endfunction

function LXD takes nothing returns nothing
	set Mode_PM=true
endfunction

function IIE takes nothing returns nothing
	local integer i=0
	local integer pid
	loop
		exitwhen i>5
		set pid=GetPlayerId(Sentinels[i])
		call SetPlayerName(Sentinels[i],PlayerNames[pid]+" ("+I2S(Kills[pid])+"/"+I2S(Deaths[pid])+" | "+I2S(PlayerCS[pid])+"-"+I2S(CSDenies[pid])+")")
		set pid=GetPlayerId(Scourges[i])
		call SetPlayerName(Scourges[i],PlayerNames[pid]+" ("+I2S(Kills[pid])+"/"+I2S(Deaths[pid])+" | "+I2S(PlayerCS[pid])+"-"+I2S(CSDenies[pid])+")")
		set i=i+1
	endloop
endfunction

function IJE takes nothing returns boolean
	if Mode_OI==false then
		if GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2 then
			call IIE()
		endif
	endif
	return false
endfunction

function LYD takes nothing returns nothing
	set Mode_OI=true
endfunction

function LAD takes nothing returns nothing
	set Mode_FR=true
endfunction

function INE takes nothing returns boolean
	if GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2 then
		if GetTriggerEvalCount(GetTriggeringTrigger())==1 then
			call CameraSetupSetDestPosition(DM8,0,0,.0)
		else
			call CameraSetupSetDestPosition(DM8,GetCameraTargetPositionX(),GetCameraTargetPositionY(),.0)
		endif
		call CameraSetupApplyForPlayer(true,DM8,GetLocalPlayer(),0)
		call SetTerrainFogEx(0,.0,100000.,.5,.353,.314,.235)
	endif
	return false
endfunction

function L3D takes nothing returns nothing
	local trigger t=CreateTrigger()
	set Mode_ZM=true
	set DM8=CreateCameraSetup()
	call CameraSetupSetField(DM8,CAMERA_FIELD_ZOFFSET,.0,.0)
	call CameraSetupSetField(DM8,CAMERA_FIELD_ROTATION,90.,.0)
	call CameraSetupSetField(DM8,CAMERA_FIELD_ANGLE_OF_ATTACK,304.,.0)
	call CameraSetupSetField(DM8,CAMERA_FIELD_TARGET_DISTANCE,2500.,.0)
	call CameraSetupSetField(DM8,CAMERA_FIELD_ROLL,.0,.0)
	call CameraSetupSetField(DM8,CAMERA_FIELD_FIELD_OF_VIEW,70.,.0)
	call CameraSetupSetField(DM8,CAMERA_FIELD_FARZ,16000.,.0)
	call CameraSetupSetDestPosition(DM8,.0,.0,.0)
	call TriggerRegisterTimerEvent(t,180,true)
	call TriggerRegisterTimerEvent(t,.1,false)
	call TriggerAddCondition(t,Condition(function INE))
	set t=null
endfunction

function J9E takes nothing returns nothing
	local integer i=1
	local string id
	local player p
	loop
		exitwhen i>5
		set p=Sentinels[i]
		set id=I2S(GetPlayerId(p))
		call StoreInteger(GCM,id,"id",i)
		set p=Scourges[i]
		set id=I2S(GetPlayerId(p))
		call StoreInteger(GCM,id,"id",i+5)
		if GetLocalPlayer()==PlayerModeTyper then
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"id")
			call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"id")
		endif
		set i=i+1
	endloop
	set p=null
endfunction

function JDE takes nothing returns boolean
	if Mode_Normal then
		call CED("-sdzm3lseb",2)
	endif
	call J9E()
	call CleanTrigger(GetTriggeringTrigger())
	return false
endfunction

function JEE takes nothing returns boolean
	set IsHeroesAvailable=true
	call CleanTrigger(GetTriggeringTrigger())
	return false
endfunction

function RemoveAbilityForSurePeriod takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	if UnitRemoveAbility(LoadUnitHandle(HY,h,0),LoadInteger(HY,h,0)) and GetUnitAbilityLevel(LoadUnitHandle(HY,h,0),LoadInteger(HY,h,0))==0 then
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
		//call echo("destroya")
	endif
	set t=null
endfunction

function RemoveAbilityForSure takes unit u, integer id returns nothing
	local timer t
	local integer h
	//call echo("deleting")
	if UnitRemoveAbility(u,id)==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,0.5,true,function RemoveAbilityForSurePeriod)
		call SaveUnitHandle(HY,h,0,u)
		call SaveInteger(HY,h,0,id)
		set t=null
	else
		//call echo("destroyd first trye")
	endif
endfunction

function STFUDur takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local real timeout=LoadReal(HY,h,0)
	local integer buffid=LoadInteger(HY,h,0)
	local unit d
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call RemoveSavedHandle(HY,GetHandleId(u),'STFU')
		call RemoveAbilityForSure(u,'B463')//B463 -> Sealed
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		if timeout<TimerGetElapsed(GlobalTimer) or GetUnitAbilityLevel(u,buffid)==0 or LoadBoolean(HY,h,'SLDR') then
			call RemoveSavedHandle(HY,GetHandleId(u),'STFU')
			call UnitRemoveAbility(u,'B463')//B463 -> Sealed
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		elseif GetUnitAbilityLevel(u,buffid)>0 and GetUnitAbilityLevel(u,'B463')==0 then//B463 -> Sealed
			set d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
			call UnitAddAbility(d,'A463')
			call IssueTargetOrder(d,"soulburn",u)
			set d=null
		endif
	else
		if GetUnitAbilityLevel(u,buffid)>0 then
			if GetIssuedOrderId()>=852008 and GetIssuedOrderId()<=852013then
				call InterruptUnit(u)
			endif
		endif
	endif
	set u=null
	set t=null
endfunction

function STFU takes unit u, integer buffid, real dur returns nothing
	local trigger t
	local integer h
	local integer hu=GetHandleId(u)
	local unit d
	local real timeout
	if HaveSavedHandle(HY,hu,'STFU') then
		set t=LoadTriggerHandle(HY,hu,'STFU')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,hu,'STFU',t)
		call TriggerRegisterTimerEvent(t,0.02,true)
		call TriggerRegisterDeathEvent(t,u)
		call SaveUnitHandle(HY,h,0,u)
		call TriggerAddCondition(t,Condition(function STFUDur))
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_ORDER)
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_POINT_ORDER)
		set d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
		call UnitAddAbility(d,'A463')
		call IssueTargetOrder(d,"soulburn",u)
		set d=null
	endif
	set timeout=TimerGetElapsed(GlobalTimer)+dur*1.
	if timeout > LoadReal(HY,h,0) then
		call SaveInteger(HY,h,0,buffid)
		call SaveReal(HY,h,0,timeout)
	endif
	set t=null
endfunction

function RemoveSubSpellsFromUnit takes unit u returns nothing
	call UnitRemoveAbility(u,'A13D')//A13D -> X Marks The Spot Return
	call UnitRemoveAbility(u,'A21J')//A21J -> Ancestral Spirit
	call UnitRemoveAbility(u,'A1QV')//A1QV -> Sentinel
	call UnitRemoveAbility(u,'A1TU')//A1TU -> End Tether
	call UnitRemoveAbility(u,'A24A')//A24A -> Oscillate In
	call UnitRemoveAbility(u,'A24B')//A24B -> Oscillate Out
	call UnitRemoveAbility(u,'A1NH')//A1NH -> Unstable Concoction
	call UnitRemoveAbility(u,'A20N')//A20N -> Icarus Dive End
	call UnitRemoveAbility(u,'A1Z2')//A1Z2 -> Target Fire Spirits
	call UnitRemoveAbility(u,'A1Z3')//A1Z3 -> Sun Ray
	call UnitRemoveAbility(u,'A205')//A205 -> Sun Ray Movement
	call UnitRemoveAbility(u,'A1VU')//A1VU -> End Charge
	call UnitRemoveAbility(u,'A0GC')//A0GC -> Morph Replicate
	call UnitRemoveAbility(u,'A24E')//A24E -> Song of the Siren
	call UnitRemoveAbility(u,'A0RT')//A0RT -> Psionic Trap
	call UnitRemoveAbility(u,'A1RA')//A1RA -> Soulsteal End
	call UnitRemoveAbility(u,'A0HA')//A0HA -> Reality
	call UnitRemoveAbility(u,'A0SA')//A0SA -> Ethereal Jaunt
	call UnitRemoveAbility(u,'A121')//A121 -> Illuminate End
	call UnitRemoveAbility(u,'A1WF')//A1WF -> Focused Detonate
	call UnitRemoveAbility(u,'A02T')//A02T -> Detonate
	call UnitRemoveAbility(u,'A1S9')//A1S9 -> Release Poison
	call UnitRemoveAbility(u,'A21H')//A21H -> Pulse Nova turn off
	call UnitRemoveAbility(u,'A1MN')//A1MN -> Ice Blast Helper
	call UnitRemoveAbility(u,'A06K')//A06K -> Rot
	call UnitRemoveAbility(u,'A0NE')//A0NE -> Voodoo Restoration
	call UnitRemoveAbility(u,'A0MP')//A0MP -> Mana Shield
endfunction




function EnableSuicide takes unit u returns nothing
	local player p=GetOwningPlayer(u)
	call SaveUnitHandle(HY,GetHandleId(p),'wrth',CreateUnit(p,'e00K',0,0,0))//e00K -> Wraith state end
	call ShowUnit(LoadUnitHandle(HY,GetHandleId(p),'wrth'),false)
	call PauseUnit(LoadUnitHandle(HY,GetHandleId(p),'wrth'),true)
	call UnitRemoveAbility(u,'A3DC')
endfunction

function DisableSuicide takes unit u returns nothing
	local player p=GetOwningPlayer(u)
	call KillUnit(LoadUnitHandle(HY,GetHandleId(p),'wrth'))
	call UnitAddAbility2(u,'A3DC')
	call SetPlayerAbilityAvailable(p,'A3DC',false)
endfunction

function LotusOrbCasting takes unit u, unit target, integer order returns boolean
	local integer i=0
	local real a
	local boolean b=false
	if IssueTargetOrderById(u,order,target) then
//		call echo("++")
		return true
	else
		call UnitShareVision(target,GetOwningPlayer(u),true)
		if IssueTargetOrderById(u,order,target) then
//			call echo("shared ++")
			set b=true
		else
			set i=0
			set a=AngleBetweenUnits(u,target)
			loop
				call SetUnitX(u,GetUnitX(u)+20*Cos(a*bj_DEGTORAD))
				call SetUnitY(u,GetUnitY(u)+20*Sin(a*bj_DEGTORAD))
				set i=i+1
				if IssueTargetOrderById(u,order,target) then
					set b=true
				endif
				exitwhen DistanceBetweenUnits(u,target)>1200 or b
			endloop
//			call echo(I2S(i)+" steps")
		endif
		call UnitShareVision(target,GetOwningPlayer(u),false)
	endif
	call echo(I2S(i)+" steps")
	return b
endfunction

function DummyWave takes unit d, string order, real x, real y returns nothing
	local real cx=GetUnitX(d)
	local real cy=GetUnitY(d)
	local real a=AngleBetweenXY(cx,cy,x,y)*bj_DEGTORAD
	local real cosa=20*Cos(a)
	local real sina=20*Sin(a)
	local integer i=0
//	call echo("dummy wave")
	loop
		exitwhen IssuePointOrder(d,order,x,y) or i>20
		call SetUnitX(d,GetUnitX(d)+cosa)
		call SetUnitY(d,GetUnitY(d)+sina)
//		call echo("dummy wave #"+I2S(i)+" failed at x="+R2S(x)+" y="+R2S(y)+" from x="+R2S(GetUnitX(d))+" y="+R2S(GetUnitY(d)))
		call SaveReal(TempHash,'wave','000x',x)
		call SaveReal(TempHash,'wave','000y',y)
		set x=x+cosa
		set y=y+sina
		set i=i+1
	endloop
	if i>20 then
		call UnitRemoveAbility(d,'Avul')
		call IssueTargetOrder(d,order,d)
	endif
	//call echo("fired at "+I2S(i))
endfunction

function GetUnitLifesteal takes unit u returns real
	if GetUnitAbilityLevel(u,'A1CN')==1then//A1CN -> Item Life Steal 200%
		return 2.
	endif
	if GetUnitAbilityLevel(u,'A04T')==1then//A04T -> Item Life Steal 25%
		return 0.25
	endif
	if GetUnitAbilityLevel(u,'A0II')==1then//A0II -> Mask of Madness Life Steal
		return 0.2
	endif
	if GetUnitAbilityLevel(u,'A09P')==1then//A09P -> Item Life Steal 15%
		return 0.15
	endif
	return 0.
endfunction

function ApplyOnAttackDebuff takes unit attacker, unit target, integer id returns boolean
	local unit u=CreateUnit(GetOwningPlayer(attacker),'o00S',GetUnitX(target),GetUnitY(target),0)
	local boolean b=false
	call UnitApplyTimedLife(u,'BTLF',10.)
	call UnitAddAbility(u,id)
	call UnitShareVision(target,GetOwningPlayer(u),true)
	set b=IssueTargetOrder(u,"attack",target)
	call UnitShareVision(target,GetOwningPlayer(u),false)
	set u=null
	return b
endfunction

function ApplyDesolatorTriggered takes unit target returns nothing
	call UnitAddAbilityTimedExF(target,'A3K2',1,15,0)
	call UnitAddAbilityTimedExF(target,'A3K3',1,15,'BIcb')
endfunction

function ApplyDesolatorIfHas takes unit attacker, unit target returns boolean
	if GetUnitAbilityLevel(attacker,'AIcb')>0 then
		call ApplyDesolatorTriggered(target)
		return true
	endif
	return false
endfunction

function ApplyOrbOfVenom takes unit attacker, unit target returns boolean
	if GetUnitAbilityLevel(attacker,'A1V7')>0 or GetUnitAbilityLevel(attacker,'A1V8')>0 then
		return ApplyOnAttackDebuff(attacker,target,'A1V7')
	endif
	return false
endfunction

function ApplySkadiDebuff takes unit attacker, unit target returns boolean
	if GetUnitAbilityLevel(attacker,'A2KV')>0 then
		return ApplyOnAttackDebuff(attacker,target,'A2KV')
	endif
	return false
endfunction

function ActUnitFreezeHP takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer hu=LoadInteger(HY,h,0)
	local real oldhp=LoadReal(HY,h,0)
	local real hp=GetWidgetLife(u)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or u==null or LoadReal(HY,h,1)<TimerGetElapsed(GlobalTimer) then
		call RemoveSavedHandle(HY,hu,'FRZH')
		call DestroyTrigger(t)
		call FlushChildHashtable(HY,h)
	else
		if hp<oldhp or LoadInteger(HY,hu,'AFRZ')==1 then
			call SaveReal(HY,h,0,hp)
		else
			call SetWidgetLife(u,oldhp)
		endif
	endif
	set t=null
	set u=null
endfunction

function UnitFreezeHP takes unit u, real dur returns nothing
	local trigger t
	local integer h
	local integer hu=GetHandleId(u)
	if HaveSavedHandle(HY,hu,'FRZH') then
		set t=LoadTriggerHandle(HY,hu,'FRZH')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.1,true)
		call TriggerRegisterDeathEvent(t,u)
		call TriggerAddCondition(t,Condition(function ActUnitFreezeHP))
		call SaveTriggerHandle(HY,hu,'FRZH',t)
		call SaveInteger(HY,h,0,hu)
		call SaveUnitHandle(HY,h,0,u)
		call SaveReal(HY,h,0,GetWidgetLife(u))
	endif
	call SaveReal(HY,h,1,dur+TimerGetElapsed(GlobalTimer))
	set t=null
endfunction

//=================== Hero Spells down from here ==============

function Kodo_SpiteTimeout takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)==60 or GetUnitAbilityLevel(u,'A3K6')==0 then
		call SetHeroStr(u,GetHeroStr(u,false)+LoadInteger(HY,h,0),true)
		call SetHeroAgi(u,GetHeroAgi(u,false)+LoadInteger(HY,h,1),true)
		call SetHeroInt(u,GetHeroInt(u,false)+LoadInteger(HY,h,2),true)
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	endif
	set u=null
	set t=null
endfunction

function Kodo_SpiteForGroup takes nothing returns nothing
	local real duration=0
	local unit u=GetEnumUnit()
	local trigger t
	local real dur=12.
	local integer stolen=0
	local integer curstat=0
	local integer lvl=GetUnitAbilityLevel(SpitTempUnit,'A32A')//A32A -> Spit
	local integer stats=0
	local integer stolenSTR
	local integer stolenAGI
	local integer stolenINT
	local integer h
	if IsUnitType(u,UNIT_TYPE_HERO) then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.2,true)
		call TriggerRegisterDeathEvent(t,u)
		set stats=3
		set stolenSTR=IMinIF(GetHeroStr(u,false)-1,lvl*2)
		set stolenAGI=IMinIF(GetHeroAgi(u,false)-1,lvl*2)
		set stolenINT=IMinIF(GetHeroInt(u,false)-1,lvl*2)
		call SetHeroStr(u,GetHeroStr(u,false)-stolenSTR,true)
		call SetHeroAgi(u,GetHeroAgi(u,false)-stolenAGI,true)
		call SetHeroInt(u,GetHeroInt(u,false)-stolenINT,true)
		//call SaveEffectHandle(HY,h,2,AddSpecialEffectTarget("effects\\DeathFumesBreathDamage.mdx",u,"origin"))
		call TriggerAddCondition(t,Condition(function Kodo_SpiteTimeout))
		call UnitAddAbilityTimedExF(u,'A3K6',1,12,'B3K6')
		call SaveUnitHandle(HY,h,0,u)
		call SaveInteger(HY,h,0,stolenSTR)
		call SaveInteger(HY,h,1,stolenAGI)
		call SaveInteger(HY,h,2,stolenINT)
		set t=null
	endif
	call DamageTarget(SpitTempUnit,u,3,50+25*lvl)
	
	set u=null
endfunction

function Kodo_SpiteFilter takes nothing returns boolean
	return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(SpitTempUnit)) and AliveNonBuildOrMarker(GetFilterUnit()) and IsMagicImmune(GetFilterUnit())==false
endfunction


function Kodo_Spit takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local group gg=GetAvailableGroup()
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
	local real angle=AngleBetweenXY(GetUnitX(caster),GetUnitY(caster),GetSpellTargetX(),GetSpellTargetY())*bj_DEGTORAD
	local real x=GetUnitX(caster)
	local real y=GetUnitY(caster)
	local unit dummy=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),angle*bj_RADTODEG)//e00E -> Spellcaster
	call UnitAddAbility(dummy,'A32X')
	call IssuePointOrderById(dummy,852580,x+125*Cos(angle),y+125*Sin(angle))
	set dummy=null
	set SpitTempUnit=caster
	call GroupEnumUnitsInRange(g,x+125*Cos(angle),y+125*Sin(angle),175,Condition(function Kodo_SpiteFilter))
	call GroupAddGroup(g,gg)
	call GroupEnumUnitsInRange(g,x+300*Cos(angle),y+300*Sin(angle),200,Condition(function Kodo_SpiteFilter))
	call GroupAddGroup(g,gg)
	call GroupEnumUnitsInRange(g,x+500*Cos(angle),y+500*Sin(angle),200,Condition(function Kodo_SpiteFilter))
	call GroupAddGroup(g,gg)
	call GroupEnumUnitsInRange(g,x+700*Cos(angle),y+700*Sin(angle),250,Condition(function Kodo_SpiteFilter))
	call GroupAddGroup(g,gg)
	set SpitTempUnit=caster
	call ForGroup(gg,function Kodo_SpiteForGroup)
	call KillGroup(g)
	call KillGroup(gg)
	set caster=null
	set g=null
	set gg=null
endfunction

function kodo_TrampleTArgets takes nothing returns boolean
	return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(SpitTempUnit)) and AliveNonBuildOrMarker(GetFilterUnit()) and IsUnitType(GetFilterUnit(),UNIT_TYPE_MECHANICAL)==false and IsUnitInGroup(GetFilterUnit(),TrampleTempGroup)==false//Aloc -> Locust, 
endfunction

function Kodo_TrampleForGroup takes nothing returns nothing
	call DamageTarget(SpitTempUnit,GetEnumUnit(),1,TempReal)
	call UnitAddAbilityTimedExF(GetEnumUnit(),'A3LA',1,3.,'A32c')
	call GroupAddUnit(TrampleTempGroup,GetEnumUnit())
endfunction

function Kodo_trampleDuration takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local real angle=LoadReal(HY,h,0)
	local integer lvl=LoadInteger(HY,h,0)
	local real x=LoadReal(HY,h,1)
	local real y=LoadReal(HY,h,2)
	local real cx
	local real cy
	local real speed=LoadReal(HY,h,3)
	local group g
	local group affected=LoadGroupHandle(HY,h,2)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SetUnitPathing(u,true)
		call DestroyEffect(LoadEffectHandle(HY,h,4))
		call DestroyEffect(LoadEffectHandle(HY,h,5))
		call KillGroup(affected)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SetUnitPosition(u,SafeX50(GetUnitX(u)+speed*Cos(angle)),SafeY50(GetUnitY(u)+speed*Sin(angle)))
		if ModuloInteger(GetTriggerEvalCount(t),10)==0 then
			call KillTrees(GetUnitX(u),GetUnitY(u),150)
		endif
		call SetUnitFacing(u,angle*bj_RADTODEG)
		if DistanceBetweenXY(x,y,GetUnitX(u),GetUnitY(u))<50 or DistanceBetweenXY(x,y,GetUnitX(u),GetUnitY(u))>1200 or GetTriggerEvalCount(t)>1200./speed then
			call DestroyEffect(LoadEffectHandle(HY,h,4))
			call DestroyEffect(LoadEffectHandle(HY,h,5))
			call SetUnitPathing(u,true)
			call SetUnitPosition(u,SafeX50(GetUnitX(u)),SafeY50(GetUnitY(u)))
			call KillGroup(affected)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		else
			call SetUnitAnimationByIndex(u,LoadInteger(MHT,GetUnitTypeId(u),'A1P8'))//A1P8 -> Charge of Darkness
			set cx=GetUnitX(u)
			set cy=GetUnitY(u)
			set g=GetAvailableGroup()
			set SpitTempUnit=u
			set TrampleTempGroup=affected
			call GroupEnumUnitsInRange(g,cx,cy,275,Condition(function kodo_TrampleTArgets))
			set TempReal=lvl*50.0
			set TempInteger=lvl
			set SpitTempUnit=u
			call ForGroup(g,function Kodo_TrampleForGroup)
			call GroupAddGroup(g,affected)
			call KillGroup(g)
		endif
	endif
	set g=null
	set affected=null
	set u=null
	set t=null
endfunction

function Kodo_Trample takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
	local real cx=GetUnitX(u)
	local real cy=GetUnitY(u)
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real angle=AngleBetweenXY(cx,cy,x,y)*bj_DEGTORAD
	local trigger t
	local integer h
	local group g=GetAvailableGroup()
	local string s=GetProperAttachPoint_Foot(u)
	local string s2=""
	if s=="foot" then
		set s="foot,right"
		set s2="foot,left"
	endif
	if DistanceBetweenXY(cx,cy,x,y)>1000 then
		set x=cx+1000*Cos(angle)
		set y=cy+1000*Sin(angle)
	endif
	
	call SetUnitFacingTimed(u,angle*bj_RADTODEG,.3)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.02,true)
	call TriggerRegisterDeathEvent(t,u)
	call TriggerAddCondition(t,Condition(function Kodo_trampleDuration))
	call SaveUnitHandle(HY,h,0,u)
	call SaveEffectHandle(HY,h,4,AddSpecialEffectTarget("effects\\SandWaveMissile.mdx",u,s))
	call SaveEffectHandle(HY,h,5,AddSpecialEffectTarget("effects\\SandWaveMissile.mdx",u,s2))
	call SaveReal(HY,h,0,angle)
	call SaveReal(HY,h,1,x)
	call SaveReal(HY,h,2,y)
	call SaveReal(HY,h,3,1000.0*0.02)//speed
	call SaveInteger(HY,h,0,lvl)
	call SaveGroupHandle(HY,h,2,g)
	call SetUnitPathing(u,false)
	set t=null
	set u=null
	set g=null
endfunction

function Kodo_DigestSpitHit takes nothing returns nothing
	local unit caster=tt_unit1
	local unit target=tt_unit2
	local integer lvl=GetUnitAbilityLevel(caster,'A32E')//A32E -> Digest
	local real damage=lvl*40+40
	call DamageTarget(caster,target,1,damage)
	call UnitAddAbilityTimedEx(target,'A32F',1,4,'B32F')//B32F -> Digest Slow
	set caster=null
	set target=null
endfunction

function Kodo_DigestSpitEffect takes nothing returns nothing
	local trigger t=AddProjectile(GetTriggerUnit(),GetSpellTargetUnit(),'hKOD',"Kodo_DigestSpitHit",1000,true)
	set t=null
endfunction

function Kodo_DigestSpitEffectSup takes nothing returns nothing
	local integer i=LoadInteger(MHT,GetHandleId(GetTriggerUnit()),'A32D')-1//A32D -> Digest Spit
	if IsBlocked(GetSpellTargetUnit())==false then
		call Kodo_DigestSpitEffect()
	endif
	call SaveInteger(MHT,GetHandleId(GetTriggerUnit()),'A32D',i)//A32D -> Digest Spit
	if i<1 then
		call SaveBoolean(MHT,GetHandleId(GetTriggerUnit()),'A32D',false)//A32D -> Digest Spit
		call SetPlayerAbilityAvailable(GetOwningPlayer(GetTriggerUnit()),'A32D',false)//A32D -> Digest Spit
		//call SetPlayerAbilityAvailable(GetOwningPlayer(GetTriggerUnit()),'A32E',true)//A32E -> Digest
	endif
endfunction

function Kodo_DigestSpitCast takes nothing returns nothing
	local unit u=GetTriggerUnit()
	if LoadBoolean(MHT,GetHandleId(u),'A32D')==false or LoadInteger(MHT,GetHandleId(u),'A32D')<1 then//A32D -> Digest Spit, A32D -> Digest Spit
		call InterruptUnit(u)
		call Error(GetOwningPlayer(u),"No tree consumed")
		call SaveBoolean(MHT,GetHandleId(u),'A32D',false)//A32D -> Digest Spit
		call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A32D',false)//A32D -> Digest Spit
	endif
	set u=null
endfunction

function Kodo_Digest_RemoveOwl2 takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local destructable d=LoadDestructableHandle(HY,GetHandleId(t),0)
	local unit u=CreateUnit(Player(15),'e00E',GetDestructableX(d),GetDestructableY(d),0)//e00E -> Spellcaster
	call UnitAddAbility(u,'A1FD')
	call IssueTargetOrderById(u,852146,d)
	call FlushChildHashtable(HY,GetHandleId(t))
	call PauseTimer(t)
	call DestroyTimer(t)
	set u=null
	set t=null
endfunction

function Kodo_Digest_RemoveOwl takes destructable d returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.3,false,function Kodo_Digest_RemoveOwl2)
	call SaveDestructableHandle(HY,GetHandleId(t),0,d)
	set t=null
endfunction

function Kodo_Digest takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
	call UnitAddAbility2(caster,'A32D')//A32D -> Digest Spit
	call SaveBoolean(MHT,GetHandleId(caster),'A32D',true)//spit is available//A32D -> Digest Spit
	call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A32D',true)//A32D -> Digest Spit
	call SaveInteger(MHT,GetHandleId(caster),'A32D',LoadInteger(MHT,GetHandleId(caster),'A32D')+1)//A32D -> Digest Spit, A32D -> Digest Spit
	//call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A32E',false)//A32E -> Digest
	call Kodo_Digest_RemoveOwl(GetSpellTargetDestructable())
	set caster=null
endfunction

function Kodo_DigestLeveling takes nothing returns nothing
	call UnitAddAbility2(GetTriggerUnit(),'A32E')//A32E -> Digest
	call SetUnitAbilityLevel(GetTriggerUnit(),'A32E',GetUnitAbilityLevel(GetTriggerUnit(),'A32Y'))//A32E -> Digest, A32Y -> Digest
endfunction

function Kodo_DigestBonusesPeriodic takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer count=0
	local integer lvl=GetUnitAbilityLevel(u,'A32G')//A32G -> Drums of War
	local integer bonus=5+5*lvl
	local integer bonusAS=4+2*lvl
	local integer curbonus=LoadInteger(MHT,GetHandleId(u),'A32G')//A32G -> Drums of War
	local integer curbonusAS=LoadInteger(MHT,GetHandleId(u),'A32G'+1)
	local integer i=0
	local integer id=0
	local integer k=0
	local integer bonusDMG=0
	if lvl==0 then
		if curbonus>0 then
			call LoDStat_Sub(u,curbonus,"damage")
			call LoDStat_Sub(u,curbonusAS,"attack")
		endif
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	else
		loop
			set k=0
			set id=GetItemTypeId(UnitItemInSlot(u,i))
			if id>0 then
				if GetItemGoldCostById(id)>2000 then
					set count=count+1
				endif
			endif
			set i=i+1
			exitwhen i>5
		endloop
		set bonusDMG=count*bonus
		set bonusAS=count*bonusAS
		if bonusDMG!=curbonus then
			call LoDStat_Sub(u,curbonus,"damage")
			call LoDStat_Sub(u,curbonusAS,"attack")
			call LoDStat_Add(u,bonusDMG,"damage")
			call LoDStat_Add(u,bonusAS,"attack")
			call SaveInteger(MHT,GetHandleId(u),'A32G',bonusDMG)//A32G -> Drums of War
			call SaveInteger(MHT,GetHandleId(u),'A32G'+1,bonusAS)//A32G -> Drums of War
		endif
	endif
	set t=null
	set u=null
endfunction

function Kodo_DigestBonuses takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local timer t=CreateTimer()
	call TimerStart(t,1,true,function Kodo_DigestBonusesPeriodic)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(u,GetSpellAbilityId())+1)
	set t=null
	set u=null
endfunction


function Kodo_DrumsProvideBonusesStr takes unit u, integer str returns nothing
	local integer array b
	local integer a=str
	local integer c=1
	local integer i=0
	local integer z=5
	local real hp
	local integer array bonuses
	set bonuses[0]='A32N'
	set bonuses[1]='A32O'
	set bonuses[2]='A32P'
	set bonuses[3]='A32Q'
	set bonuses[4]='A32R'
	set bonuses[5]='A32S'
	if str<1 then
		set hp=GetWidgetLife(u)
		call UnitRemoveAbility(u,bonuses[0])
		call UnitRemoveAbility(u,bonuses[1])
		call UnitRemoveAbility(u,bonuses[2])
		call UnitRemoveAbility(u,bonuses[3])
		call UnitRemoveAbility(u,bonuses[4])
		call UnitRemoveAbility(u,bonuses[5])
		call SetWidgetLife(u,hp)
		return
	endif
	loop
		set c=a/2
		set b[i]=a-c*2
		set a=c
		set i=i+1
		exitwhen c==0
	endloop
	set i=0
	loop
		exitwhen i>z
		if b[i]==1 then
			call UnitAddAbility2(u,bonuses[i])
		else
			call UnitRemoveAbility(u,bonuses[i])
		endif
		set i=i+1
	endloop
endfunction

function Kodo_DrumsProvideBonuses takes unit u, integer str, integer others returns nothing
	local integer array b
	local integer a=others
	local integer c=1
	local integer i=0
	local integer z
	local real hp
	local integer array bonuses
	set bonuses[0]='A32H'
	set bonuses[1]='A32I'
	set bonuses[2]='A32J'
	set bonuses[3]='A32K'
	set bonuses[4]='A32L'
	set bonuses[5]='A32M'
	if others<1 then
		call UnitRemoveAbility(u,bonuses[0])
		call UnitRemoveAbility(u,bonuses[1])
		call UnitRemoveAbility(u,bonuses[2])
		call UnitRemoveAbility(u,bonuses[3])
		call UnitRemoveAbility(u,bonuses[4])
		call UnitRemoveAbility(u,bonuses[5])
		call Kodo_DrumsProvideBonusesStr(u,0)
		return
	endif
	loop
		set c=a/ 2
		set b[i]=a-c*2
		set a=c
		set i=i+1
		exitwhen c==0
	endloop
	set z=5
	set i=0
	loop
		exitwhen i>z
		if b[i]==1 then
			call UnitAddAbility2(u,bonuses[i])
		else
			call UnitRemoveAbility(u,bonuses[i])
		endif
		set i=i+1
	endloop
	call Kodo_DrumsProvideBonusesStr(u,str)
endfunction

function Kodo_DrumsDuration takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local integer hu=0
	local integer lvl=LoadInteger(HY,h,0)
	local unit caster=LoadUnitHandle(HY,h,0)
	local integer i=1
	local unit u=null
	local boolean isSc=LoadBoolean(HY,h,0)
	local player p
	local integer pid=0
	local integer counter=LoadInteger(HY,h,1)+1
	local integer herocount=0
	local integer curbonuses=0
	local integer totalbonuses=0
	local integer limit=LoadInteger(HY,h,-1)
	local unit array targets
	loop
		if isSc then
			set pid=GetPlayerId(Scourges[i])
		else
			set pid=GetPlayerId(Sentinels[i])
		endif
		set u=udg_Hero[pid]
		if u!=null then
			set hu=GetHandleId(u)
			if IsDead(u)==false and (DistanceBetweenXY(GetUnitX(caster),GetUnitY(caster),GetUnitX(u),GetUnitY(u))<925 or LoadBoolean(MHT,hu,'A32G'+1)) then//if hero is alive and in range or was in aoe when casted (key)//A32G -> Drums of War
				if counter==1 then//on cast
					call SaveBoolean(MHT,hu,'A32G'+1,true)//save flag that unit was there on cast//A32G -> Drums of War
				endif
				set herocount=herocount+1
				set targets[herocount]=u
			elseif IsDead(u)==false and DistanceBetweenXY(GetUnitX(caster),GetUnitY(caster),GetUnitX(u),GetUnitY(u))<925==false then
				call Kodo_DrumsProvideBonuses(u,0,0)
				call SaveInteger(MHT,GetHandleId(u),'A32G'+1,0)//A32G -> Drums of War
				call SaveBoolean(MHT,hu,'A32G'+1,false)//A32G -> Drums of War
			endif
		endif
		set i=i+1
		exitwhen i>5
	endloop
	set totalbonuses=(6+2*lvl)*herocount
	set i=1
	loop
		set u=targets[i]
		set hu=GetHandleId(u)
		if counter<limit and (DistanceBetweenXY(GetUnitX(caster),GetUnitY(caster),GetUnitX(u),GetUnitY(u))<925 or LoadBoolean(MHT,hu,'A32G'+1)) then//if hero is alive and in range or was in aoe when casted (key)//A32G -> Drums of War
			set curbonuses=LoadInteger(MHT,GetHandleId(u),'A32G'+1)//A32G -> Drums of War
			if curbonuses!=totalbonuses then
				call Kodo_DrumsProvideBonuses(u,0,0)
				if u!=caster then
					call Kodo_DrumsProvideBonuses(u,R2I(totalbonuses/2),totalbonuses)
				else
					call Kodo_DrumsProvideBonuses(u,totalbonuses,totalbonuses)
				endif
				call SaveInteger(MHT,GetHandleId(u),'A32G'+1,totalbonuses)//A32G -> Drums of War
			endif
		else
			call Kodo_DrumsProvideBonuses(u,0,0)
			call SaveInteger(MHT,GetHandleId(u),'A32G'+1,0)//A32G -> Drums of War
			call SaveBoolean(MHT,hu,'A32G'+1,false)//A32G -> Drums of War
		endif
		set i=i+1
		exitwhen i>herocount
	endloop
	call SaveInteger(HY,h,1,counter)
	if counter==limit then
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	endif
	set caster=null
	set t=null
	set u=null
	set targets[1]=null
	set targets[2]=null
	set targets[3]=null
	set targets[4]=null
	set targets[5]=null
endfunction

function Kodo_DrumWars takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
	local timer t=CreateTimer()
	call TimerStart(t,0.25,true,function Kodo_DrumsDuration)
	call SaveInteger(HY,GetHandleId(t),-1,R2I(8/0.25)+1)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call SaveInteger(HY,GetHandleId(t),0,lvl)
	call SaveBoolean(HY,GetHandleId(t),0,IsScourge(GetOwningPlayer(u)))
	set t=null
	set u=null
endfunction

function Queen_VitalStrikeActs takes nothing returns nothing
	local unit caster=tt_unit1
	local unit target=tt_unit2
	local real damage=100+60*GetUnitAbilityLevel(caster,'A45W')//A45W -> Vital Strike
	if GetWidgetLife(target) < GetUnitState(target,UNIT_STATE_MAX_LIFE)/2 then
		set damage=damage/2
	endif
	call DestroyEffect(LoadEffectHandle(HY,GetHandleId(GetTriggeringTrigger()),'00fx'))
	call DamageTarget(caster,target,3,damage)
	set caster=null
	set target=null
endfunction

function Queen_VitalStrike takes nothing returns nothing
	local trigger t
	local unit d
	if IsBlocked(GetSpellTargetUnit())==false then
		set t=AddProjectile(GetTriggerUnit(),GetSpellTargetUnit(),'h077',"Queen_VitalStrikeActs",1500,true)//h077 -> Shackleshot Arrow
		set d=LoadUnitHandle(HY,GetHandleId(t),45)
		call SaveEffectHandle(HY,GetHandleId(t),'00fx',AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathCoil\\DeathCoilMissile.mdl",d,"origin"))
		set t=null
		set d=null
	endif
endfunction

function Queen_ArrowShowerFilter takes nothing returns boolean
	if IsDead(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(Queen_TempUnit)) and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsMagicImmune(GetFilterUnit())==false then//
		if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) then
			set Queen_TempInt2=Queen_TempInt2+1
		endif
		return true
	endif
	return false
endfunction

function Queen_ArrowShowerForGroup takes nothing returns nothing
	local integer aid='A45Y'
	local integer lvl=1
	call DamageTarget(Queen_TempUnit,GetEnumUnit(),1,Queen_TempInt*40+40)
	if IsDead(GetEnumUnit())==false then
		if Queen_TempInt2<2 then
			set lvl=Queen_TempInt2+1
		else
			set lvl=Queen_TempInt2-1
			set aid=aid+1
		endif
		call UnitAddAbilityTimedExF(GetEnumUnit(),aid,lvl,1+Queen_TempInt,'B45Y')//B45Y -> Arrow Shower
	endif
endfunction

function Queen_ArrowShowerImpact takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local integer lvl=LoadInteger(HY,h,0)
	local group g=GetAvailableGroup()
	local integer i=0
	set Queen_TempInt=lvl
	set Queen_TempUnit=caster
	set Queen_TempInt2=0
	call GroupEnumUnitsInRange(g,LoadReal(HY,h,1),LoadReal(HY,h,2),300+50*lvl,Condition(function Queen_ArrowShowerFilter))
	call ForGroup(g,function Queen_ArrowShowerForGroup)
	call KillGroup(g)
	call PauseTimer(t)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set caster=null
	set t=null
endfunction

function Queen_ArrowShower takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),'A45X'))//A45X -> Arrow Shower
	call SaveUnitHandle(HY,h,0,GetTriggerUnit())
	call SaveReal(HY,h,1,x)
	call SaveReal(HY,h,2,y)
	call TimerStart(t,0.4,false,function Queen_ArrowShowerImpact)
	call SaveEffectHandle(HY,h,10,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x,y))
	call SaveEffectHandle(HY,h,11,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x+250,y))
	call SaveEffectHandle(HY,h,12,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x,y+250))
	call SaveEffectHandle(HY,h,13,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x+250,y+250))
	call SaveEffectHandle(HY,h,14,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x-250,y))
	call SaveEffectHandle(HY,h,15,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x,y-250))
	call SaveEffectHandle(HY,h,16,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x-250,y-250))
	set t=null
endfunction

function Queen_MortalWoundsDOT takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit queen=LoadUnitHandle(HY,h,0)
	local unit victim=LoadUnitHandle(HY,h,1)
	local real dmg=LoadReal(HY,h,0)
	local integer c=LoadInteger(HY,h,0)+1
	if queen==null or victim==null or dmg==0. or c>3 then
		call DestroyEffect(LoadEffectHandle(HY,h,3))
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	else
		set MortalWoundsDamage=true
		call DamageTarget(queen,victim,2,dmg)
		set MortalWoundsDamage=false
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\BloodRiteTarget.mdx",victim,"origin"))
		call SaveInteger(HY,h,0,c)
		if c==3 then
			call DestroyEffect(LoadEffectHandle(HY,h,3))
			call PauseTimer(t)
			call DestroyTimer(t)
			call FlushChildHashtable(HY,h)
		endif
	endif
	set t=null
	set queen=null
	set victim=null
endfunction

function MortalWoundsWrapper takes unit attacker, unit target returns nothing
	local timer tt
	local integer ht
	if GetEventDamage()>20 and MortalWoundsDamage==false and GetUnitAbilityLevel(attacker,'A36D')==0 and PRD_Get(attacker,'A460',30) then//A460 -> Mortal Wounds
		set tt=CreateTimer()
		set ht=GetHandleId(tt)
		call TimerStart(tt,1,true,function Queen_MortalWoundsDOT)
		call SaveUnitHandle(HY,ht,0,attacker)
		call SaveUnitHandle(HY,ht,1,target)
		call SaveReal(HY,ht,0,GetEventDamage()*(.05*(GetUnitAbilityLevel(attacker,'A460'))+.25))//A460 -> Mortal Wounds, QP27 -> Mortal Wounds hidden
		call SaveEffectHandle(HY,ht,3,AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",target,"origin"))
		set tt=null
	endif
endfunction

function Queen_SnatchFilter takes nothing returns boolean
	if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsDead(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(Queen_TempUnit)) and GetUnitAbilityLevel(GetFilterUnit(),'Avul')==0 and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 then//Avul -> Invulnerable, 
		if GetWidgetLife(GetFilterUnit())<Queen_SnatchedHP then
			set Queen_SnatchedHP=GetWidgetLife(GetFilterUnit())
			set Queen_SnatchedUnit=GetFilterUnit()
		endif
		return true
	endif
	return false
endfunction

function QueenSnatchStun takes unit u, boolean isSingle returns nothing
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
	local integer aid='A462'
	local integer lvl=1
	if isSingle then
		set lvl=2
	endif
	call UnitAddAbility(d,aid)
	call SetUnitAbilityLevel(d,aid,lvl)
	call IssueTargetOrder(d,"thunderbolt",u)
	call AddEffectTargetTimed("Abilities\\Spells\\Orc\\Ensnare\\ensnare_AirTarget.mdl",u,"origin",0.5)
	set d=null
endfunction

function Queen_SnatchDuration takes nothing returns nothing
	local integer h=GetHandleId(GetExpiredTimer())
	local unit caster=(LoadUnitHandle(HY,h,290))
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local real Ax=(LoadReal(HY,h,284))
	local real Ay=(LoadReal(HY,h,285))
	local real Cx=(LoadReal(HY,h,286))
	local real Cy=(LoadReal(HY,h,287))
	local real Bx=(LoadReal(HY,h,288))
	local real By=(LoadReal(HY,h,289))
	local real a=(LoadReal(HY,h,137))
	local real b=1-a
	local boolean MUE=(LoadBoolean(HY,h,291))
	local real MVE=RMaxBJ(DistanceBetweenXY(Ax,Ay,Cx,Cy)/ 1300,.2)
	local boolean bb=LoadBoolean(HY,h,0)
	local group g
	local real x=SafeX50(Ax*a*a+Bx*2*a*b+Cx*b*b)
	local real y=SafeY50(Ay*a*a+By*2*a*b+Cy*b*b)
	local unit u
	local real height
	
	call SetUnitFacing(caster,AngleBetweenXY(GetUnitX(caster),GetUnitY(caster),x,y))
	call SetUnitX(caster,x)
	call SetUnitY(caster,y)
	
	if DistanceBetweenXY(x,y,Cx,Cy)<50 and bb==false then
		call SaveBoolean(HY,h,0,true)
		set g=GetAvailableGroup()
		set Queen_TempUnit=caster
		set Queen_TempInt=GetUnitAbilityLevel(caster,'A461')//A461 -> Swoop Down
		set Queen_SnatchedUnit=null
		set Queen_SnatchedHP=999999
		call GroupEnumUnitsInRange(g,x,y,300,Condition(function Queen_SnatchFilter))
		if Queen_SnatchedUnit!=null then
			call SaveBoolean(HY,h,1,true)
			call SaveUnitHandle(HY,h,1,Queen_SnatchedUnit)
		endif
		loop
			set u=FirstOfGroup(g)
			
			exitwhen u==null
			
			call DamageTarget(caster,u,1,Queen_TempInt*50+50)
			call QueenSnatchStun(u,false)
			call GroupRemoveUnit(g,u)
			
		endloop
		call KillGroup(g)
		set g=null
	endif
	if LoadBoolean(HY,h,1)then
		call SetUnitPosition(LoadUnitHandle(HY,h,1),x,y)
	endif
	if(MUE)then
		call SaveReal(HY,h,137,((a-.02/ MVE)*1.))
		call SetUnitFlyHeight(caster,GetUnitFlyHeight(caster)+LoadReal(HY,h,291),0)
	else
		call SaveReal(HY,h,137,((a+.02/ MVE)*1.))
		call SetUnitFlyHeight(caster,GetUnitFlyHeight(caster)-LoadReal(HY,h,291),0)
	endif
	if(a<0 and MUE)then
		call SaveBoolean(HY,h,291,(false))
		call SaveReal(HY,h,288,((Ax+300*Cos(Atan2(Cy-Ay,Cx-Ax)+(LoadReal(HY,h,292))))*1.))
		call SaveReal(HY,h,289,((Ay+300*Sin(Atan2(Cy-Ay,Cx-Ax)+(LoadReal(HY,h,292))))*1.))
	endif
	if(a>1 and MUE==false)then
		if LoadBoolean(HY,h,1)then
			call DamageTarget(caster,LoadUnitHandle(HY,h,1),1,50+50*GetUnitAbilityLevel(caster,'A461'))//A461 -> Swoop Down
			call QueenSnatchStun(LoadUnitHandle(HY,h,1),true)
			call AddEffectTargetTimed("Abilities\\Spells\\Orc\\Ensnare\\ensnare_AirTarget.mdl",LoadUnitHandle(HY,h,1),"origin",1)
			call KillTrees(GetUnitX(LoadUnitHandle(HY,h,1)),GetUnitY(LoadUnitHandle(HY,h,1)),200)
		endif
		call SetUnitFlyHeight(caster,LoadReal(HY,h,290),0)
		call KillTrees(GetUnitX(caster),GetUnitY(caster),200)
		call PauseTimer(GetExpiredTimer())
		call FlushChildHashtable(HY,h)
		call DestroyTimer(GetExpiredTimer())
	endif
	set caster=null
	set Hero=null
endfunction

function Queen_Snatch takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local real Ax=GetUnitX(caster)
	local real Ay=GetUnitY(caster)
	local real Cx=SafeX50(GetSpellTargetX())
	local real Cy=SafeY50(GetSpellTargetY())
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local real a=AngleBetweenXY(Ax,Ay,Cx,Cy)*bj_DEGTORAD
	if DistanceBetweenXY(Ax,Ay,Cx,Cy)<300 then
		set Cx=SafeX50(Ax+300*Cos(a))
		set Cy=SafeY50(Ay+300*Sin(a))
	endif
	call SaveUnitHandle(HY,h,14,(caster))
	call SaveUnitHandle(HY,h,290,(caster))
	call SaveReal(HY,h,284,((Ax)*1.))
	call SaveReal(HY,h,285,((Ay)*1.))
	call SaveReal(HY,h,286,((Cx)*1.))
	call SaveReal(HY,h,287,((Cy)*1.))
	call SaveReal(HY,h,288,((Ax+300*Cos(Atan2(Cy-Ay,Cx-Ax)-45))*1.))
	call SaveReal(HY,h,289,((Ay+300*Sin(Atan2(Cy-Ay,Cx-Ax)-45))*1.))
	call SaveReal(HY,h,137,1.)
	call SaveReal(HY,h,292,45.)
	call SaveBoolean(HY,h,291,true)
	call SaveReal(HY,h,290,GetUnitFlyHeight(caster))
	call SaveReal(HY,h,291,1300/DistanceBetweenXY(Ax,Ay,Cx,Cy))
	if IsBuggyFlying(caster)==false then
		call UnitAddAbility2(caster,'Amrf')//Amrf -> Crow Form
		call UnitRemoveAbility(caster,'Amrf')//Amrf -> Crow Form
	endif
	call TimerStart(t,.020,true,function Queen_SnatchDuration)
	set caster=null
	set t=null
endfunction

function JIE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=GetTriggerEvalCount(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=LoadUnitHandle(HY,h,30)
	local integer Level=(LoadInteger(HY,h,5))
	local real JJE
	local unit Caster
	set JJE=.6*(Count-25)*(Count-25)
	if Count<51 and GetTriggerEventId()!=EVENT_WIDGET_DEATH then
		if ModuloInteger(Count,5)==0 then
			call DamageTarget(Source,Target,1,3+3*Level)
		endif
		if IsBuggyFlying(Target)==false then
			call SetUnitFlyHeight(Target,500-JJE,0)
		endif
	else
		set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
		call UnitAddAbility2(Caster,'A11L')//A11L -> Ghost Ship Slow
		call SetUnitAbilityLevel(Caster,'A11L',Level)//A11L -> Ghost Ship Slow
		call IssueTargetOrderById(Caster,852075,Target)
		if IsBuggyFlying(Target)==false then
			call SetUnitFlyHeight(Target,GetUnitDefaultFlyHeight(Target),0)
		endif
		if GameEnded==false then
			call PauseUnit(Target,false)
		endif
		call SetUnitPathing(Target,true)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	set Caster=null
	return false
endfunction

function JKE takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=tt_unit1
	local unit Target=GetEnumUnit()
	local integer Level=tt_int1
	call PauseUnit(Target,true)
	call SetUnitPathing(Target,false)
	if IsBuggyFlying(Target)==false then
		call UnitAddAbility2(Target,'Amrf')//Amrf -> Crow Form
		call UnitRemoveAbility(Target,'Amrf')//Amrf -> Crow Form
	endif
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function JIE))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,30,((Target)))
	call SaveInteger(HY,h,5,(Level))
	call DamageTarget(Source,Target,1,30+30*Level)
	set t=null
	set Source=null
	set Target=null
endfunction

function JME takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local integer Level=LoadInteger(HY,h,5)
	local group g=GetAvailableGroup()
	local ubersplat Splat=CreateUbersplat(x,y,"THNN",255,255,255,255,false,false)
	call SetUbersplatRenderAlways(Splat,true)
	call TimedReveal(GetOwningPlayer(Hero),4,x,y,400)
	call DestroyEffect(LoadEffectHandle(HY,h,175))
	call DestroyEffect(LoadEffectHandle(HY,h,176))
	call DestroyEffect(LoadEffectHandle(HY,h,177))
	call DestroyEffect(LoadEffectHandle(HY,h,178))
	call DestroyEffect(LoadEffectHandle(HY,h,179))
	call DestroyEffect(LoadEffectHandle(HY,h,180))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",x,y))
	call DestroyEffect(AddSpecialEffect("effects\\TidalErruption.mdx",x,y))
	set tt_unit1=Hero
	set tt_int1=Level
	call GroupEnumUnitsInRange(g,x,y,225+25,Condition(function NonImmuneEnemyFilterWithAncients))
	call ForGroup(g,function JKE)
	call KillGroup(g)
	set t=null
	set Hero=null
	set g=null
	set Splat=null
	return false
endfunction

function Admiral_Torrent takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Hero,'A136')//A136 -> Torrent
	local string s=""
	local real a
	local real r
	if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Hero)) or IsObserver(GetLocalPlayer())then
		set s="Objects\\Spawnmodels\\Other\\IllidanFootprint\\IllidanWaterSpawnFootPrint.mdl"
	endif
	call SaveInteger(HY,h,5,Level)
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveReal(HY,h,6,x*1.)
	call SaveReal(HY,h,7,y*1.)
	call SaveInteger(HY,h,5,Level)
	set r=60*bj_DEGTORAD
	set a=0
	call SaveEffectHandle(HY,h,175,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
	set a=1
	call SaveEffectHandle(HY,h,176,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
	set a=2
	call SaveEffectHandle(HY,h,177,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
	set a=3
	call SaveEffectHandle(HY,h,178,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
	set a=4
	call SaveEffectHandle(HY,h,179,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
	set a=5
	call SaveEffectHandle(HY,h,180,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
	call TriggerRegisterTimerEvent(t,1.6,false)
	call TriggerAddCondition(t,Condition(function JME))
	set Hero=null
	set t=null
endfunction

function Kunka_Tidebringer_Restart_IfDead takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(MHT,h,0)
	local integer level=LoadInteger(MHT,h,1)
	if IsDead(u)==false then
		call LoDStat_Add(u,15*level+5,"damage")
		call UnitAddAbility2(u,'A147')//A147 -> Water Sword Container 1
		
		call SetUnitAbilityLevel(u,'A146',level)//A146 -> Water Sword Cleave 1
		call UnitMakeAbilityPermanent(u,true,'A146')//A146 -> Water Sword Cleave 1
		set level = GetHandleId(u)
		call SaveBoolean(MHT,level,'A13T',true)//A13T -> Tidebringer
		call SaveEffectHandle(MHT,level,StringHash("tidebringer_effect"),AddSpecialEffectTarget("effects\\WaterHands.mdx",u,GetProperAttachPoint_Weapon(u)))
		call CleanTrigger(t)
		call FlushChildHashtable(MHT,h)
	endif
	set t=null
	set u=null
	return false
endfunction

function Kunka_Tidebringer_Restart takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local trigger tt
	local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)
	local integer level = GetUnitAbilityLevel(u,'A522')//A522 -> Tidebringer
	call SaveBoolean(MHT,GetHandleId(u),'A13T',true)//A13T -> Tidebringer

	if UA8(u) then
		set tt=CreateTrigger()
		call TriggerRegisterTimerEvent(tt,1,true)
		call TriggerAddCondition(tt,Condition(function Kunka_Tidebringer_Restart_IfDead))
		call SaveUnitHandle(MHT,GetHandleId(tt),0,u)
		call SaveInteger(MHT,GetHandleId(tt),1,level)
		set tt=null
	else
		call LoDStat_Add(u,15*level+5,"damage")
		call UnitAddAbility2(u,'A147')//A147 -> Water Sword Container 1
		call SetUnitAbilityLevel(u,'A146',level)//A146 -> Water Sword Cleave 1
		call UnitMakeAbilityPermanent(u,true,'A146')//A146 -> Water Sword Cleave 1
		set level = GetHandleId(u)
		call SaveBoolean(MHT,level,'A13T',true)//A13T -> Tidebringer
		call SaveEffectHandle(MHT,level,StringHash("tidebringer_effect"),AddSpecialEffectTarget("effects\\WaterHands.mdx",u,GetProperAttachPoint_Weapon(u)))
	endif

	call Timer_End(t)
	set t = null
	set u = null
	
endfunction

function Kunka_Tidebringer_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()

	if IsUnitEnemy(t,group_temp_player) and GetUnitAbilityLevel(t,'A04R')==0 and  IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and t!=group_temp_unit[1]then//
		call DamageTarget(group_temp_unit[0],t,8,group_temp_real[0])
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\WaterElementalMissile\\WaterElementalMissile.mdl",t,"chest"))
	endif

	set t = null
	return false
endfunction

function Kunka_Tidebringer_Range_End takes unit u, unit d, real damage, integer info returns nothing
	local timer t = CreateTimer()
	local integer level = GetUnitAbilityLevel(u,'A522') //A13T//A522 -> Tidebringer
	local real x1 = GetWidgetX(d)
	local real y1 = GetWidgetY(d)
	local real range = 525 + 100*(level/4)
	set group_temp_unit[0] = u
	set group_temp_unit[1] = d
	if Mode_BO then
		set group_temp_real[0] = damage
	else
		set group_temp_real[0] = damage*0.8//(0.4+0.1*level)
	endif
	set group_temp_player = GetOwningPlayer(u)
	call GroupEnumUnitsInRange(temp_group,x1,y1,range,Condition(function Kunka_Tidebringer_Targets)) //splash aoe
	if LoadBoolean(MHT,GetHandleId(group_temp_player),4)then //check to see if passive cooldowns are enabled for the player
		call Passive_Cooldown(u,'A13T',level)//A13T -> Tidebringer
	endif
	call LoDStat_Sub(u,level*15+5,"damage")
	call UnitRemoveAbility(u,'A147') //remove cleave (incase the attack transforms into a melee unit)//A147 -> Water Sword Container 1
	call SaveUnitHandle(MHT,GetHandleId(t),0,u)
	call TimerStart(t,16 - 3*level,false,function Kunka_Tidebringer_Restart)
	set level = StringHash("tidebringer_effect")
	call DestroyEffect(LoadEffectHandle(MHT,info,level))
	call RemoveSavedHandle(MHT,info,level)
	set t = null
endfunction

function Kunka_Tidebringer_Melee_End takes unit u, integer info returns nothing
	local timer t = CreateTimer()
	local integer level = GetUnitAbilityLevel(u,'A522') //A13T//A522 -> Tidebringer
	call SaveUnitHandle(MHT,GetHandleId(t),0,u)
	call TimerStart(t,16 - 3*level,false,function Kunka_Tidebringer_Restart)
	if LoadBoolean(MHT,GetHandleId(GetOwningPlayer(u)),4)then //check to see if passive cooldowns are enabled for the player
		call Passive_Cooldown(u,'A13T',level)//A13T -> Tidebringer
	endif
	call LoDStat_Sub(u,level*15+5,"damage")
	call UnitRemoveAbility(u,'A147') //remove cleave//A147 -> Water Sword Container 1
	set level = StringHash("tidebringer_effect")
	call DestroyEffect(LoadEffectHandle(MHT,info,level))
	call RemoveSavedHandle(MHT,info,level)
	set t = null
endfunction

function Kunka_Tidebringer_Effect takes unit u, unit t, real d returns nothing
	local integer info = GetHandleId(u)
	local integer load = StringHash("tidebringer_delay")
	if LoadBoolean(MHT,info,load)then
		call SaveBoolean(MHT,info,load,false)   // should the next damage proc
		call SaveBoolean(MHT,info,'A13T',false) // is tidebringer ready//A13T -> Tidebringer
		set load = StringHash("tidebringer_timer")
		call Timer_End(LoadTimerHandle(MHT,info,load))
		call RemoveSavedHandle(MHT,info,load)
		if IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER) then
			call Kunka_Tidebringer_Range_End(u,t,d,info)
		else
			call Kunka_Tidebringer_Melee_End(u,info)
		endif
	endif
endfunction

function Kunka_Tidebringer_Start takes unit u, unit d, integer load, integer level returns nothing
	local timer t = LoadTimerHandle(MHT,load,StringHash("tidebringer_timer"))
	local integer info = GetHandleId(d)
	call SaveBoolean(MHT,load,StringHash("tidebringer_delay"),true)
	if LoadBoolean(MHT,info,1)==false then
		call SaveBoolean(MHT,info,1,true)
		call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_DAMAGED)
	endif
	if t==null then
		set t = CreateTimer()
		call SaveTimerHandle(MHT,load,StringHash("tidebringer_timer"),t)
	endif
	call SaveInteger(MHT,GetHandleId(t),0,load)
	set t = null
endfunction

function Kunka_Tidebringer_Condition takes unit u, unit t returns nothing
	local boolean b
	local integer info = GetHandleId(u)
	if LoadBoolean(MHT,info,'A13T')and IsUnitEnemy(u,GetOwningPlayer(t)) and (IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) or IsUnitIllusion(t)==false) then//A13T -> Tidebringer
		call Kunka_Tidebringer_Start(u,t,info,GetUnitAbilityLevel(u,'A13T'))//A13T -> Tidebringer
	endif
endfunction

function Kunka_Tidebringer_Learn takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local integer info = GetHandleId(u)
	local boolean break=GetUnitAbilityLevel(u,'A36D')==1
	if LoadBoolean(MHT,info,'A13T') and break==false then //not on cooldown//A13T -> Tidebringer
		call LoDStat_Add(u,15+5,"damage")
	elseif GetUnitAbilityLevel(u,'A522')==1then //first time learning//A522 -> Tidebringer
		if break==false  then
			call LoDStat_Add(u,15+5,"damage")
			call SaveEffectHandle(MHT,info,StringHash("tidebringer_effect"),AddSpecialEffectTarget("effects\\WaterHands.mdx",u,GetProperAttachPoint_Weapon(u)))
		endif
		call SaveBoolean(MHT,info,'A13T',true)//A13T -> Tidebringer
		if break==false  then
			if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) then //adds the cleave ability to melee units
				call UnitAddAbility2(u,'A147')//A147 -> Water Sword Container 1
				call UnitMakeAbilityPermanent(u,true,'A146')//A146 -> Water Sword Cleave 1
				call SetUnitAbilityLevel(u,'A146',GetUnitAbilityLevel(u,'A13T'))//A146 -> Water Sword Cleave 1, A13T -> Tidebringer
			endif
		endif
	endif
	set u = null
endfunction

function Admiral_XMark_Return takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,30)
	local image i=LoadImageHandle(HY,h,185)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local unit Source=LoadUnitHandle(HY,h,2)
	if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A13D')then//A13D -> X Marks The Spot Return
		if GetTriggerEventId()!=EVENT_WIDGET_DEATH and (IsMagicImmune(Target)==false or IsUnitAlly(Target,GetOwningPlayer(Source))) then
			if IsUnitHidden(Target)then
				call SetUnitX(Target,x)
				call SetUnitY(Target,y)
			else
				call SetUnitPosition(Target,x,y)
			endif
		endif
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A13D',false)//A13D -> X Marks The Spot Return
		if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A11N' then//A11N -> X Marks The Spot
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A11N',true)//A11N -> X Marks The Spot
		endif
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call ShowImage(i,false)
		call DestroyImage(i)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	set i=null
	set Source=null
	return false
endfunction

function Admiral_XMark_Effect takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local real x=GetUnitX(Target)
	local real y=GetUnitY(Target)
	local real size=90
	local image i=CreateImage("Fonts\\X.blp",size,size,0,x-size/2,y-size/2,0,0,0,0,2)
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local string fx=""
	local integer Level=GetUnitAbilityLevel(Source,'A11N')//A11N -> X Marks The Spot
	local real duration=4.0
	if IsPlayerAlly(GetOwningPlayer(Source),GetOwningPlayer(Target)) then
		set duration=duration*2
	endif
	call AddTimedKeyToUnit(Target,4401,5)
	call UnitAddAbility2(Source,'A13D')//A13D -> X Marks The Spot Return
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A13D',true)//A13D -> X Marks The Spot Return
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A11N',false)//A11N -> X Marks The Spot
	call SetImageRenderAlways(i,true)
	if IsUnitAlly(Source,GetOwningPlayer(Target))==false or IsUnitAlly(Target,GetLocalPlayer()) or IsObserver(GetLocalPlayer())then
		set fx="effects\\BlackTide.mdx"
		call ShowImage(i,true)
	else
		call ShowImage(i,false)
	endif
	call SetImageColor(i,255,0,0,255)
	call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(Source),'o00G',x,y,0),'BTLF',5)//o00G -> Vision Dummy 1000/1000
	call TriggerRegisterTimerEvent(t,duration,false)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function Admiral_XMark_Return))
	call SaveImageHandle(HY,h,185,i)
	call SaveUnitHandle(HY,h,30,(Target))
	call SaveReal(HY,h,6,x*1.)
	call SaveReal(HY,h,7,y*1.)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget(fx,Target,"overhead"))
	call SaveUnitHandle(HY,h,2,Source)
	set Source=null
	set Target=null
	set i=null
	set t=null
endfunction

function Admiral_XMark_Learn takes nothing returns nothing
	call SetPlayerAbilityAvailable2(GetOwningPlayer(GetTriggerUnit()),'A13D',false)//A13D -> X Marks The Spot Return
	call UnitAddAbility2(GetTriggerUnit(),'A13D')//A13D -> X Marks The Spot Return
endfunction

function Admiral_XMark_Effectsup takes nothing returns nothing
	if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))or IsBlocked(GetSpellTargetUnit())==false then
		call Admiral_XMark_Effect()
	endif
endfunction

function Admiral_XMark_OnCastsup takes nothing returns nothing
	if(LoadBoolean(HY,(GetHandleId(GetOwningPlayer(GetSpellTargetUnit()))),139))and IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))//n038 -> This target has disablehelp on
	elseif IsMagicImmune(GetSpellTargetUnit()) and IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),"Cannot target magic immune enemies")
	endif
endfunction

function JAE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer B78=1
	local player p
	local real d
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer JBE=LoadInteger(HY,h,136)
	local integer DP9=LoadInteger(HY,h,188)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)>DP9 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		loop
			exitwhen B78>JBE
			set p=LoadPlayerHandle(HY,h,1300+B78)
			set d=LoadReal(HY,h,1200+B78)
			if p==null then
				set B78=JBE
			else
				call SetWidgetLife(Target,RMaxIF(1,GetWidgetLife(Target)-d/DP9))
			endif
			set B78=B78+1
		endloop
	endif
	set t=null
	set p=null
	set Target=null
	return false
endfunction

function JCE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,17)
	local player p=LoadPlayerHandle(HY,h,54)
	local trigger J3E=LoadTriggerHandle(HY,h,135)
	local integer B78=GetTriggerEvalCount(t)
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call TriggerRegisterTimerEvent(J3E,1,true)
		call TriggerAddCondition(J3E,Condition(function JAE))
		call UnitRemoveAbility(Target,'B09U')//B09U -> Captain CoCo's Rum
	elseif IsRealDamage then
		set h=GetHandleId(J3E)
//		call SetWidgetLife(Target,GetWidgetLife(Target)+.5*GetEventDamage())
		call SavePlayerHandle(HY,h,1300+B78,GetOwningPlayer(GetEventDamageSource()))
		call SaveReal(HY,h,1200+B78,.5*GetEventDamage()*1.)
		call SaveInteger(HY,h,136,B78)
	endif
	set t=null
	set Target=null
	set p=null
	set J3E=null
	return false
endfunction

function J6E takes nothing returns nothing
	local unit Source=DB8
	local unit Target=GetEnumUnit()
	local integer Level=DC8
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer DP9=10
	local trigger J3E=CreateTrigger()
	call UnitAddAbilityTimedExF(Target,'A12D',1,DP9,'B09U')
	call TriggerRegisterTimerEvent(t,DP9+.01,false)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function JCE))
	call SavePlayerHandle(HY,h,54,(GetOwningPlayer(Source)))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveTriggerHandle(HY,h,135,(J3E))
	call SaveUnitHandle(HY,(GetHandleId(J3E)),17,(Target))
	call SaveInteger(HY,(GetHandleId(J3E)),188,(DP9))
	set Source=null
	set Target=null
	set t=null
	set J3E=null
endfunction

function JLE takes nothing returns boolean
	if(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and IsUnitInGroup(GetFilterUnit(),DA8)==false then
		call GroupAddUnit(DA8,GetFilterUnit())
		return true
	endif
	return false
endfunction

function J1E takes nothing returns nothing
	local unit Source=DB8
	local unit Target=GetEnumUnit()
	local integer Level=DC8
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A13X')//A13X -> Ghostship stun
	call IssueTargetOrderById(Caster,852095,Target)
	call DamageTarget(Source,Target,1,300+100*Level)
	set Source=null
	set Target=null
	set Caster=null
endfunction

function J0E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=(LoadUnitHandle(HY,h,45))
	local unit J5E
	local real a=(LoadReal(HY,h,13))
	local real SourceX=GetUnitX(Projectile)
	local real SourceY=GetUnitY(Projectile)
	local real TargetX=(LoadReal(HY,h,66))
	local real TargetY=(LoadReal(HY,h,67))
	local integer Count=GetTriggerEvalCount(t)
	local real AO8=SafeX50(TargetX+13.33*Count*Cos(a))
	local real AP8=SafeY50(TargetY+13.33*Count*Sin(a))
	local integer Level=(LoadInteger(HY,h,5))
	local group AlreadyHit=(LoadGroupHandle(HY,h,187))
	local group g
	if Count<19 then
		call SetUnitVertexColor(Projectile,255,255,255,5+Count*10)
		set J5E=(LoadUnitHandle(HY,h,186))
		call SetUnitVertexColor(J5E,255,255,255,5+Count*10)
	elseif Count<125 then
		call SetUnitVertexColor(Projectile,255,255,255,190)
	elseif Count<150 then
	endif
	set g=GetAvailableGroup()
	set DA8=AlreadyHit
	set tt_unit1=Projectile
	set DB8=Projectile
	set DC8=Level
	call GroupEnumUnitsInRange(g,GetUnitX(Projectile),GetUnitY(Projectile),425,Condition(function JLE))
	call ForGroup(g,function J6E)
	call KillGroup(g)
	call SetUnitX(Projectile,AO8)
	call SetUnitY(Projectile,AP8)
	if Count==140 then
		set J5E=(LoadUnitHandle(HY,h,186))
		call KillUnit(J5E)
	elseif Count<140 then
		set J5E=(LoadUnitHandle(HY,h,186))
		call SetUnitX(J5E,AO8)
		call SetUnitY(J5E,AP8)
	endif
	if Count==150 then
		set g=GetAvailableGroup()
		set tt_unit1=Projectile
		call GroupEnumUnitsInRange(g,AO8,AP8,450,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function J1E)
		call KillGroup(g)
		call KillUnit(Projectile)
		call KillGroup(AlreadyHit)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Projectile=null
	set J5E=null
	set AlreadyHit=null
	set g=null
	return false
endfunction

function Admiral_GhostShip takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real SourceX=GetUnitX(Hero)
	local real SourceY=GetUnitY(Hero)
	local real x0=GetSpellTargetX()
	local real y0=GetSpellTargetY()
	local real a
	local real x1
	local real y1
	local real x2
	local real y2
	local trigger t
	local integer h
	local integer Level
	local unit Projectile
	local unit J5E
	local string s=""
	local integer K8E='h06U'//h06U -> Ghost Ship
	if GetRandomInt(0,5)==0 then
		set K8E='h0DJ'//h0DJ -> Ghost Ship 2
	endif
	if IsPlayerAlly(GetOwningPlayer(Hero),GetLocalPlayer())or IsObserver(GetLocalPlayer())then
		set s="war3mapImported\\Whirlpool.mdx"
	endif
	if x0==GetUnitX(Hero)and y0==GetUnitY(Hero)then
		set x0=x0+50*Cos(GetUnitFacing(Hero)*bj_DEGTORAD)
		set y0=y0+50*Sin(GetUnitFacing(Hero)*bj_DEGTORAD)
	endif
	set a=Atan2(y0-SourceY,x0-SourceX)
	set x1=SourceX-1000*Cos(a)
	set y1=SourceY-1000*Sin(a)
	set x2=SourceX+1000*Cos(a)
	set y2=SourceY+1000*Sin(a)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	set Level=GetUnitAbilityLevel(Hero,'A11K')//A11K -> Ghost Ship
	set Projectile=CreateUnit(GetOwningPlayer(Hero),K8E,x1,y1,Atan2(y0-SourceY,x0-SourceX)*bj_RADTODEG)
	set J5E=CreateUnit(GetOwningPlayer(Hero),'h06V',x1,y1,Atan2(y0-SourceY,x0-SourceX)*bj_RADTODEG)//h06V -> Ghost Ship Trail
	call SetUnitVertexColor(Projectile,255,255,255,0)
	call SetUnitPathing(Projectile,false)
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveUnitHandle(HY,h,45,(Projectile))
	call SaveUnitHandle(HY,h,186,(J5E))
	call SaveReal(HY,h,66,((x1)*1.))
	call SaveReal(HY,h,67,((y1)*1.))
	call SaveGroupHandle(HY,h,187,(GetAvailableGroup()))
	call DestroyEffect(AddSpecialEffect(s,SafeX50(x2),SafeY50(y2)))
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function J0E))
	set Hero=null
	set t=null
	set Projectile=null
	set J5E=null
endfunction

function Kunkka_Torrent_Preload takes nothing returns nothing
	call PreloadQueryAdd('A11L')//A11L -> Ghost Ship Slow
endfunction


function Alchemist_Unstable_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	if IsUnitEnemy(group_temp_unit[0],GetOwningPlayer(t)) and AliveNonBuildOrMarker(t) then
		if group_temp_real[4]==1 and GetUnitAbilityLevel(t,'A3E9')==1 and IsMagicImmune(group_temp_unit[1])==false then
			call SaveInteger(TempHash,'A3E9','0lvl',R2I(group_temp_real[2]))
			call SaveUnitHandle(TempHash,'A3E9','targ',group_temp_unit[1])
			call SaveUnitHandle(TempHash,'A3E9','cstr',t)
			call SaveReal(TempHash,'A3E9','0dur',group_temp_real[3])
			call ExecuteFunc("LotusOrbUnstableConcoctionReflection")
		endif
		if IsBlocked(t)==false then
			call DamageTarget(group_temp_unit[0],t,2,group_temp_real[0])
			call StunTargetLoD(t,group_temp_real[1])
		else
			call RemoveLinkenBuff(t)
		endif
	endif
	set t = null
	return false
endfunction

function KEE takes unit u, real duration, real x, real y, boolean b, integer level, boolean canReflect returns nothing
	set group_temp_real[3]=duration
	set duration = duration/5.
	set group_temp_real[0] = (60 + 70*level) * duration
	set group_temp_real[1] = (1 + 0.75*level)*duration
	set group_temp_real[2]=level
	set group_temp_real[4]=0
	set group_temp_unit[0]=GetInvulDamager(u)
	set group_temp_unit[1]=u
	if canReflect then
		set group_temp_real[4]=1
	endif
	call GroupEnumUnitsInRange(temp_group,x,y,200,Condition(function Alchemist_Unstable_Targets))
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherFireMissile\\DemolisherFireMissile.mdl",x,y))
	if b then
		call DamageTarget(group_temp_unit[0],u,2,group_temp_real[0])
		call StunTargetLoD(u,group_temp_real[1])
	endif
endfunction

function KFE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local unit Projectile=LoadUnitHandle(HY,h,45)
	local real V19=LoadReal(HY,h,444)
	local real a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),GetUnitX(Target),GetUnitY(Target))
	local real x=GetUnitX(Projectile)+18*Cos(a*bj_DEGTORAD)
	local real y=GetUnitY(Projectile)+18*Sin(a*bj_DEGTORAD)
	local integer lvl=LoadInteger(HY,h,0)
	call SetUnitX(Projectile,x)
	call SetUnitY(Projectile,y)
	if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<=18 or (GetUnitX(Target)==0 and GetUnitY(Target)==0) then
		call KillUnit(Projectile)
		call KEE(Source,V19,x,y,false,lvl,LoadBoolean(HY,h,0))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	set Projectile=null
	return false
endfunction

function UnstableConcoctionThrow takes unit from,unit to,real channeltime, integer lvl, boolean lotus returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=CreateUnit(GetOwningPlayer(from),'h0BD',GetUnitX(from),GetUnitY(from),GetUnitFacing(from))//h0BD -> Unstable Concoction
	call SaveUnitHandle(HY,h,2,from)
	call SaveUnitHandle(HY,h,17,to)
	call SaveUnitHandle(HY,h,45,Projectile)
	call SaveReal(HY,h,444,channeltime*1.)
	call SaveInteger(HY,h,0,lvl)
	call SaveBoolean(HY,h,0,lotus)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function KFE))
	set Projectile=null
	set t=null
endfunction

function LotusOrbUnstableConcoctionReflection takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9','cstr')
	local unit target=LoadUnitHandle(TempHash,'A3E9','targ')
	local real channel=LoadReal(TempHash,'A3E9','0dur')
	local integer lvl=LoadInteger(TempHash,'A3E9','0lvl')
//	call echo("ref")
	call UnstableConcoctionThrow(caster,target,channel,lvl,true)
	call LotusOrbFX(caster)
	call FlushChildHashtable(TempHash,'A3E9')
	set caster=null
	set target=null
endfunction

function KIE takes string s,unit Target,unit Hero returns nothing
	local texttag tt=CreateTextTag()
	call SetTextTagPosUnit(tt,Target,64)
	call SetTextTagColor(tt,255,0,0,255)
	call SetTextTagVelocity(tt,0,.0355)
	call SetTextTagFadepoint(tt,.15)
	call SetTextTagPermanent(tt,false)
	call SetTextTagLifespan(tt,.65)
	if (IsUnitAlly(Hero,GetLocalPlayer()) or IsObserver(GetLocalPlayer()))==false  then
		set s = ""
	endif
	call SetTextTagText(tt,s,.033)
	call SetTextTagVisibility(tt,true)
	set tt=null
endfunction

function KKE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real KGE=LoadReal(HY,h,442)
	local real Time=TimerGetElapsed(GlobalTimer)
	local real Y59=5.-(Time-KGE)
	local real YO8=RMinIF(Time-KGE,5.)
	local integer Count=LoadInteger(HY,h,34)+1
	local integer i
	local string s
	local integer lvl=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1NI' then//A1NI -> Unstable Concoction
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NI',true)//A1NI -> Unstable Concoction
		endif
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NH',false)//A1NH -> Unstable Concoction
		call RestoreTint(Source)
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if GetSpellAbilityId()=='A1NH' then//A1NH -> Unstable Concoction
			//if IsBlocked(GetSpellTargetUnit())==false then
				call UnstableConcoctionThrow(Source,GetSpellTargetUnit(),YO8,lvl,false)
			//endif
			if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1NI' then//A1NI -> Unstable Concoction
				call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NI',true)//A1NI -> Unstable Concoction
			endif
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NH',false)//A1NH -> Unstable Concoction
			call RestoreTint(Source)
			call DestroyEffect(LoadEffectHandle(HY,h,32))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	else
		call SaveInteger(HY,h,34,Count)
		if Y59>=0 then
			set i = R2I(Y59)
			set s = I2S(i)
			if Y59 - i >= .5 then
				set s = s + ".5"
			else
				set s = s + ".0"
			endif
			set i = ModuloInteger(Count,2)*75
			call KIE(s,Source,Source)
			call SetTint(Source,255,100 + i,100 + i,-1)
		else
			call SetTint(Source,255,0,0,-1)
		endif
		if Time-KGE>(5.+.5)then
			call KEE(Source,5.,GetWidgetX(Source),GetWidgetY(Source),true,lvl,true)
			if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1NI' then//A1NI -> Unstable Concoction
				call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NI',true)//A1NI -> Unstable Concoction
			endif
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NH',false)//A1NH -> Unstable Concoction
			call RestoreTint(Source)
			call DestroyEffect(LoadEffectHandle(HY,h,32))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set Source=null
	return false
endfunction

function Alchemist_UnstableConcoction takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local string s="war3mapImported\\UnstableConcoctionRangeDisplay3.mdx"
	if GetLocalPlayer()!=GetOwningPlayer(Source)then
		set s=""
	endif
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,442,TimerGetElapsed(GlobalTimer))
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,'A1NI'))//A1NI -> Unstable Concoction
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget(s,Source,"origin"))
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function KKE))
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NI',false)//A1NI -> Unstable Concoction
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NH',true)//A1NH -> Unstable Concoction
	call UnitAddAbility2(Source,'A1NH')//A1NH -> Unstable Concoction
	call TriggerEvaluate(t)
	set Source=null
	set t=null
endfunction

function Alchemist_Greed_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer load = LoadInteger(MHT,info,0)
	call SaveInteger(MHT,load,'A0O3',LoadInteger(MHT,load,'A0O3') - LoadInteger(MHT,info,1))//A0O3 -> Goblin's Greed, A0O3 -> Goblin's Greed
	call Timer_End(t)
	set t = null
endfunction

function Alchemist_Greed_Start takes unit u, unit d, player p, integer level returns nothing
	local timer t = CreateTimer()
	local texttag text
	local integer h = GetHandleId(t)
	local integer hu = GetHandleId(u)
	local integer gold = LoadInteger(MHT,hu,'A0O3')+level*2+2//A0O3 -> Goblin's Greed
	local boolean b=IsUnitType(d,UNIT_TYPE_HERO)
	if gold>8*level then
		set gold = 8*level
	endif
	if b then
		set text = CreateTextTag()
		set gold=AddGold(p,gold)
		call SetTextTagText(text,"+"+I2S(gold),.025)
		call SetTextTagPosUnit(text,d,0.3)
		call SetTextTagColor(text,255,220,0,255)
		call SetTextTagVelocity(text,0,.05)
		call SetTextTagVisibility(text,GetLocalPlayer()==p)
		call SetTextTagFadepoint(text,2)
		call SetTextTagLifespan(text,3)
		call SetTextTagPermanent(text,false)
		set text=null
		
	endif
	call SaveInteger(MHT,hu,'A0O3',3 + LoadInteger(MHT,hu,'A0O3'))//last bonus gold amount//A0O3 -> Goblin's Greed, A0O3 -> Goblin's Greed
	call SaveInteger(MHT,h,0,hu)
	call SaveInteger(MHT,h,1,3)
	call TimerStart(t,25,false,function Alchemist_Greed_End)
	set hu = GetHandleId(p)
	call SaveInteger(MHT,hu,'A0O3',LoadInteger(MHT,hu,'A0O3') + gold)//stats counter//A0O3 -> Goblin's Greed, A0O3 -> Goblin's Greed
	set t = null
endfunction

function Alchemist_Greed_Condition takes unit u, unit t returns nothing
	local player p = GetOwningPlayer(u)
	local integer level
	if GetUnitAbilityLevel(u,'Aloc')==1 then//Aloc -> Locust
		set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
	endif
	set level=GetUnitAbilityLevel(u,'P155')
	if GetUnitAbilityLevel(u,'A36D')!=0 then
		set level=0
	endif
	if level > 0 and IsUnitEnemy(t,p) and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and IsUnitIllusion(t)==false and (GetUnitAbilityLevel(t,'A04R')==0) then//
		call Alchemist_Greed_Start(u,t,p,level)
	endif
endfunction

function Alchemist_Acidspray_Targets takes nothing returns nothing
	local integer key
	local integer info
	local unit t = GetFilterUnit()

	if IsDead(t)==false and IsUnitEnemy(t,group_temp_player) and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(t)!='n0F5' then//, n0F5 -> Living Dead
		call GroupAddUnit(temp_group2,t)
		call DamageTarget(group_temp_unit[0],t,2,group_temp_integer[0])
		if IsUnitInGroup(t,group_temp_group)==false then
			set info = GetHandleId(t)
			set key = StringHash("acidspray_count")
			call LoDStat_Add(t,group_temp_integer[1],"armourneg")
			call SaveInteger(MHT,GetHandleId(t),StringHash("acidspray"),LoadInteger(MHT,GetHandleId(t),StringHash("acidspray")+group_temp_integer[1]))
			call Buff_Add(t,'C014','D014',-1)
			call SaveInteger(MHT,info,key,LoadInteger(MHT,info,key) + 1)
			set t = null
			return
		endif
		call GroupRemoveUnit(group_temp_group,t)
	endif

	set t = null
endfunction

function RemoveAcidSprayDebuff_Helper takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(MHT,h,2)
	if UA8(u)==false then
		call Buff_Remove(u,'D014')
		call LoDStat_Sub(u,LoadInteger(MHT,h,0),"armourneg")
		call DisableTrigger(t)
		call DestroyTrigger(t)
		call FlushChildHashtable(MHT,h)
	endif
	set u=null
	set t=null
	return false
endfunction

function Alchemist_Acidspray_Duration takes nothing returns nothing
	local unit u = null
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer key = StringHash("acidspray_count")
	local integer count = LoadInteger(MHT,info,0)
	local trigger tt
	local integer h
	set group_temp_integer[1] = LoadInteger(MHT,info,2) //armour reduction
	set group_temp_group = LoadGroupHandle(MHT,info,1)
	if count==17 then
		set count = LoadInteger(MHT,info,2)
		call DestroyEffect(LoadEffectHandle(MHT,info,2))
		loop
			set u = FirstOfGroup(group_temp_group)
			exitwhen u==null
			set info = GetHandleId(u)
			set count = LoadInteger(MHT,info,key)
			if UA8(u)==false then
				if count==1then
					call Buff_Remove(u,'D014')
				endif
				call SaveInteger(MHT,GetHandleId(u),StringHash("acidspray"),IMinBJ(LoadInteger(MHT,GetHandleId(u),StringHash("acidspray")-group_temp_integer[1]),0))
				call LoDStat_Sub(u,group_temp_integer[1],"armourneg")
			else
				set tt=CreateTrigger()
				call TriggerRegisterTimerEvent(tt,1,true)
				call TriggerAddCondition(tt,Condition(function RemoveAcidSprayDebuff_Helper))
				set h=GetHandleId(tt)
				call SaveInteger(MHT,h,0,group_temp_integer[1])
				call SaveUnitHandle(MHT,h,2,u)
				set tt=null
			endif
			call SaveInteger(MHT,info,key,count - 1)
			call GroupRemoveUnit(group_temp_group,u)
		endloop
		call KillGroup(group_temp_group)
		call Timer_End(t)
		set t = null
		return
	endif
	call SaveInteger(MHT,info,0,count + 1)
	set group_temp_player = LoadPlayerHandle(MHT,info,3)
	set group_temp_unit[0] = LoadUnitHandle(MHT,info,0)
	set group_temp_integer[0] = LoadInteger(MHT,info,1) //damage
	call GroupEnumUnitsInRange(temp_group,LoadReal(MHT,info,0),LoadReal(MHT,info,1),650,Condition(function Alchemist_Acidspray_Targets))
	//removes the bonuses from any unit out of range
	loop
		set u = FirstOfGroup(group_temp_group)
		exitwhen u==null
		set info = GetHandleId(u)
		set count = LoadInteger(MHT,info,key)
		if count==1then
			call Buff_Remove(u,'D014')
		endif
		call SaveInteger(MHT,info,key,count - 1)
		call SaveInteger(MHT,info,StringHash("acidspray"),LoadInteger(MHT,info,StringHash("acidspray")-group_temp_integer[1]))
		call LoDStat_Sub(u,group_temp_integer[1],"armourneg")
		call GroupRemoveUnit(group_temp_group,u)
	endloop
	//updates the current group with the newly affected units
	loop
		set u = FirstOfGroup(temp_group2)
		exitwhen u==null
		call GroupRemoveUnit(temp_group2,u)
		call GroupAddUnit(group_temp_group,u)
	endloop
	set u=null
	set tt=null
	set t = null
endfunction

function Alchemist_Acidspray_Start takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local integer level = GetUnitAbilityLevel(u,'A0IL')//A0IL -> Acid Spray
	local integer info = GetHandleId(t)
	local real x = GetSpellTargetX()
	local real y = GetSpellTargetY()
	call SaveUnitHandle(MHT,info,0,u)
	call SaveGroupHandle(MHT,info,1,GetAvailableGroup())
	call SaveEffectHandle(MHT,info,2,AddSpecialEffect("effects\\Radioactivecloud_2c.mdl",x,y))
	call SavePlayerHandle(MHT,info,3,GetOwningPlayer(u))
	call SaveInteger(MHT,info,0,0)
	call SaveInteger(MHT,info,1,level*6 + 8)
	call SaveInteger(MHT,info,2,level + 3)
	call SaveReal(MHT,info,0,x)
	call SaveReal(MHT,info,1,y)
	call TimerStart(t,1,true,function Alchemist_Acidspray_Duration)
	set t = null
	set u = null
endfunction

function K1E takes unit Hero, unit Target returns nothing
	local integer Level=GetUnitAbilityLevel(Hero,'A0E3')//A0E3 -> Mana Void
	local real Damage=(.35+.25*Level)*(GetUnitState(Target,UNIT_STATE_MAX_MANA)-GetUnitState(Target,UNIT_STATE_MANA))
	local group g=GetAvailableGroup()
	local unit u2
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\DragonHawkMissile\\DragonHawkMissile.mdl",Target,"chest"))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\SpiritOfVengeanceMissile\\SpiritOfVengeanceMissile.mdl",Target,"chest"))
	call DestroyEffect(AddSpecialEffect("war3mapImported\\Enchantment.mdx",GetUnitX(Target),GetUnitY(Target)))
	set tt_unit1=Hero
	call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),500+25,Condition(function DefaultEnemyFilterWithAncients))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call DamageTarget(Hero,u2,1,Damage)
		call GroupRemoveUnit(g,u2)
	endloop
	call PlaySoundOnUnitBJ(NC,100,Target)
	call KillGroup(g)
endfunction

function AM_ManaVoid takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit target=LoadUnitHandle(HY,h,1)
	if IsBlocked(target)==false then
		call K1E(LoadUnitHandle(HY,h,0),target)
	endif
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set target=null
endfunction

function AM_ManaVoidWrap takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,GetTriggerUnit())
	call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
	call TimerStart(t,0,false,function AM_ManaVoid)
	set t=null
endfunction

function MHE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local integer Count=GetTriggerEvalCount(t)
	local integer MIE=R2I(((.9-.3)/ .5)/ .03)
	local integer MJE=R2I((175/ MIE))
	local integer MKE=R2I((255/ MIE)*1.75)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	if Count>MIE then
		call SetUnitVertexColor(Caster,255,255,255,0)
		call SetTint(Hero,-1,-1,-1,255)
		//call SetUnitVertexColor(Hero,255,255,255,255)
		call ShowUnit(Caster,false)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SetUnitVertexColor(Caster,255,255,255,175-MJE*Count)
		call SetUnitX(Caster,x)
		call SetUnitY(Caster,y)
		//call SetUnitVertexColor(Hero,255,255,255,MKE*Count)
		call SetTint(Hero,-1,-1,-1,MKE*Count)
	endif
	set t=null
	set Caster=null
	set Hero=null
	return false
endfunction

function AM_Blink takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Caster=(LoadUnitHandle(HY,(GetHandleId(Hero)),293))
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real x=GetUnitX(Hero)
	local real y=GetUnitY(Hero)
	call SetUnitX(Caster,x)
	call SetUnitY(Caster,y)
	call SetUnitX(Hero,x)
	call SetUnitY(Hero,y)
	//call SetUnitVertexColor(Hero,255,255,255,0)
	call SetTint(Hero,-1,-1,-1,0)
	call SetUnitVertexColor(Caster,255,255,255,175)
	call SetUnitTimeScale(Caster,.5)
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function MHE))
	set Hero=null
	set Caster=null
	set t=null
endfunction

function AM_Blink_OnCast takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Caster
	local integer h=GetHandleId(Hero)
	local real a=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetSpellTargetX(),GetSpellTargetY())
	local real x=GetUnitX(Hero)
	local real y=GetUnitY(Hero)
	call SetUnitPathing(Hero,false)
	call UnitAddAbility2(Hero,'Aeth')//Aeth -> Ghost
	set Caster=CreateUnit(GetOwningPlayer(Hero),'h06K',GetUnitX(Hero),GetUnitY(Hero),a)//h06K -> Magina Dummy
	call BT8(Caster,5)
	call SetUnitPathing(Caster,false)
	call UnitAddAbility2(Caster,'Aeth')//Aeth -> Ghost
	call UnitAddAbility2(Caster,'Aloc')//Aloc -> Locust
	call UnitAddAbility2(Caster,'A04R')//
	call SetUnitVertexColor(Caster,255,255,255,0)
	call SetUnitX(Caster,x)
	call SetUnitY(Caster,y)
	call SetUnitX(Hero,x)
	call SetUnitY(Hero,y)
	call SetUnitAnimation(Caster,"Spell Throw")
	call SetUnitPathing(Hero,true)
	call UnitRemoveAbility(Hero,'Aeth')//Aeth -> Ghost
	call SaveUnitHandle(HY,h,293,(Caster))
	set Hero=null
	set Caster=null
endfunction



function ManaBreakNonOrb takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'P133')>0 and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 and GetUnitState(UDSG_Target,UNIT_STATE_MANA)>0 then
		call ManaBurnCommon(UDSG_Attacker,UDSG_Target,16+12*GetUnitAbilityLevel(UDSG_Attacker,'P133'))
	endif
endfunction

function ManaBreakNonOrbIllus takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'P133')>0 and IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER) and IsUnitIllusion(UDSG_Attacker) and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 and GetUnitState(UDSG_Target,UNIT_STATE_MANA)>0 and AliveNonBuildOrMarker(UDSG_Target) then
		call ManaBurnCommon(UDSG_Attacker,UDSG_Target,16+12*GetUnitAbilityLevel(UDSG_Attacker,'P133'))
	endif
endfunction

function AddWrapperForAMManabreak takes nothing returns nothing
	call AddWrapper("ManaBreakNonOrb",4)
	call AddWrapper("ManaBreakNonOrbIllus",0)
endfunction

function MQE takes unit u,real x,real y,group HND, integer lvl returns nothing
	local group g=GetAvailableGroup()
	local unit u2
	call KillTrees(x,y,150)
	call GroupEnumUnitsInRange(g,x,y,150,Condition(function ReturnTrue))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		if(IsUnitInGroup(u2,HND)==false and IsUnitEnemy(u2,GetOwningPlayer(u)))then
			if(GetUnitAbilityLevel(u2,'A04R')!=1 and IsDead(u2)==false and IsUnitType(u2,UNIT_TYPE_STRUCTURE)==false)then//
				call GroupAddUnit(HND,u2)
				call DamageTarget(u,u2,5,60+lvl*30)
				call AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",u2,"overhead")
			endif
		endif
		call GroupRemoveUnit(g,u2)
	endloop
	call KillGroup(g)
	set g=null
	set u2=null
endfunction

function MSE takes nothing returns nothing
	local integer h=GetHandleId(GetExpiredTimer())
	local unit MTE=LoadUnitHandle(HY,h,290)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real Ax=LoadReal(HY,h,284)
	local real Ay=LoadReal(HY,h,285)
	local real Cx=LoadReal(HY,h,286)
	local real Cy=LoadReal(HY,h,287)
	local real Bx=LoadReal(HY,h,288)
	local real By=LoadReal(HY,h,289)
	local real a=LoadReal(HY,h,137)
	local real b=1-a
	local boolean MUE=LoadBoolean(HY,h,291)
	local group HND=LoadGroupHandle(HY,h,133)
	local real MVE=RMaxBJ(DistanceBetweenXY(Ax,Ay,Cx,Cy)/ 1300,.4)
	call SetUnitX(MTE,SafeX50(Ax*a*a+Bx*2*a*b+Cx*b*b))
	call SetUnitY(MTE,SafeY50(Ay*a*a+By*2*a*b+Cy*b*b))
	call MQE(Hero,GetUnitX(MTE),GetUnitY(MTE),HND,LoadInteger(HY,h,0))
	if(MUE)then
		call SaveReal(HY,h,137,((a-.02/ MVE)*1.))
	else
		call SaveReal(HY,h,137,((a+.02/ MVE)*1.))
		call SaveReal(HY,h,284,GetUnitX(Hero))
		call SaveReal(HY,h,285,GetUnitY(Hero))
	endif
	if(a<0 and MUE)then
		call SaveBoolean(HY,h,291,false)
		call SaveReal(HY,h,288,(Ax+300*Cos(Atan2(Cy-Ay,Cx-Ax)+LoadReal(HY,h,292)))*1.)
		call SaveReal(HY,h,289,(Ay+300*Sin(Atan2(Cy-Ay,Cx-Ax)+LoadReal(HY,h,292)))*1.)
	endif
	if(a>1 and MUE==false)then
		call PauseTimer(GetExpiredTimer())
		call KillGroup(HND)
		call FlushChildHashtable(HY,h)
		call RemoveUnit(MTE)
		call DestroyTimer(GetExpiredTimer())
	endif
	set MTE=null
	set Hero=null
	set HND=null
endfunction

function Beastmaster_WildAxes takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local real Ax=GetUnitX(u)
	local real Ay=GetUnitY(u)
	local real Cx=GetSpellTargetX()
	local real Cy=GetSpellTargetY()
	local unit a1=CreateUnit(GetOwningPlayer(u),'e01T',Ax,Ay,270.)//e01T -> Wild Axes
	local unit a2=CreateUnit(GetOwningPlayer(u),'e01T',Ax,Ay,270.)//e01T -> Wild Axes
	local integer h1
	local integer h2
	local timer t1=CreateTimer()
	local timer t2=CreateTimer()
	if GetSpellTargetUnit()!=null then
		set Cx=GetUnitX(GetSpellTargetUnit())
		set Cy=GetUnitY(GetSpellTargetUnit())
	endif
	call UnitAddAbility2(a1,'Amrf')//Amrf -> Crow Form
	call UnitRemoveAbility(a1,'Amrf')//Amrf -> Crow Form
	call SetUnitFlyHeight(a1,150,0)
	call UnitAddAbility2(a2,'Amrf')//Amrf -> Crow Form
	call UnitRemoveAbility(a2,'Amrf')//Amrf -> Crow Form
	call SetUnitFlyHeight(a2,150,0)
	set h1=GetHandleId(t1)
	call SaveUnitHandle(HY,h1,14,u)
	call SaveUnitHandle(HY,h1,290,a1)
	call SaveGroupHandle(HY,h1,133,GetAvailableGroup())
	call SaveReal(HY,h1,284,Ax*1.)
	call SaveReal(HY,h1,285,Ay*1.)
	call SaveReal(HY,h1,286,Cx*1.)
	call SaveReal(HY,h1,287,Cy*1.)
	call SaveReal(HY,h1,288,(Ax+300*Cos(Atan2(Cy-Ay,Cx-Ax)+45))*1.)
	call SaveReal(HY,h1,289,(Ay+300*Sin(Atan2(Cy-Ay,Cx-Ax)+45))*1.)
	call SaveReal(HY,h1,137,1.)
	call SaveReal(HY,h1,292,-45.)
	call SaveBoolean(HY,h1,291,true)
	set h2=GetHandleId(t2)
	call SaveUnitHandle(HY,h2,14,u)
	call SaveUnitHandle(HY,h2,290,a2)
	call SaveGroupHandle(HY,h2,133,GetAvailableGroup())
	call SaveReal(HY,h2,284,Ax*1.)
	call SaveReal(HY,h2,285,Ay*1.)
	call SaveReal(HY,h2,286,Cx*1.)
	call SaveReal(HY,h2,287,Cy*1.)
	call SaveReal(HY,h2,288,(Ax+300*Cos(Atan2(Cy-Ay,Cx-Ax)-45))*1.)
	call SaveReal(HY,h2,289,(Ay+300*Sin(Atan2(Cy-Ay,Cx-Ax)-45))*1.)
	call SaveReal(HY,h2,137,1.)
	call SaveReal(HY,h2,292,45.)
	call SaveBoolean(HY,h2,291,true)
	call SaveInteger(HY,h2,0,GetUnitAbilityLevel(u,GetSpellAbilityId()))
	call SaveInteger(HY,h1,0,GetUnitAbilityLevel(u,GetSpellAbilityId()))
	call TimerStart(t1,.025,true,function MSE)
	call TimerStart(t2,.025,true,function MSE)
	set u=null
	set a1=null
	set a2=null
	set t1=null
	set t2=null
endfunction


function M3E takes nothing returns nothing
	local real x=GetUnitX(GetEnumUnit())
	local real y=GetUnitY(GetEnumUnit())
	local real a=bj_RADTODEG*Atan2(y-TJ,x-tt_real1)
	local real M6E
	local real MLE
	local real abc
	if Sin((a-RJ)*bj_DEGTORAD)<0 then
		set abc=-90
	else
		set abc=90
	endif
	set M6E=GetUnitX(GetEnumUnit())+15*Cos((RJ+abc)*bj_DEGTORAD)
	set MLE=GetUnitY(GetEnumUnit())+15*Sin((RJ+abc)*bj_DEGTORAD)
	call SetUnitPosition(GetEnumUnit(),M6E,MLE)
	call SetUnitFacingTimed(GetEnumUnit(),RJ-abc,.3)
	if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
		call SaveBoolean(HeroStats,GetHandleId(GetEnumUnit()),99,true)
	endif
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GetEnumUnit(),"origin"))
endfunction

function M1E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real a=LoadReal(HY,h,13)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local group g=LoadGroupHandle(HY,h,22)
	if GetTriggerEvalCount(t)>20 then
		call KillGroup(g)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set tt_real1=x
		set TJ=y
		set RJ=a
		call ForGroup(g,function M3E)
	endif
	set t=null
	set g=null
	return false
endfunction

function M0E takes nothing returns nothing
	call DamageTarget(tt_unit1,GetEnumUnit(),1,tt_real1)
endfunction

function M5E takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(Hero,'A0O2')//A0O2 -> Primal Roar
	local unit Caster
	local real a=bj_RADTODEG*Atan2(GetUnitY(Target)-GetUnitY(Hero),GetUnitX(Target)-GetUnitX(Hero))
	local real x
	local real y
	local group g=GetAvailableGroup()
	local group g2=GetAvailableGroup()
	if Level==0 then
		set Level=GetUnitAbilityLevel(Hero,'A289')//A289 -> Primal Roar
	endif
	call SaveGroupHandle(HY,h,22,(g))
	call SaveReal(HY,h,13,a*1.)
	call SaveReal(HY,h,6,GetUnitX(Hero))
	call SaveReal(HY,h,7,GetUnitY(Hero))
	call TriggerRegisterTimerEvent(t,.025,true)
	call TriggerAddCondition(t,Condition(function M1E))
	set x=GetUnitX(Hero)+50*Cos(a*bj_DEGTORAD)
	set y=GetUnitY(Hero)+50*Sin(a*bj_DEGTORAD)
	call GroupEnumUnitsInRange(g2,x,y,275,Condition(function LR8))
	call GroupAddGroup(g2,g)
	call GroupClear(g2)
	set Caster=CreateUnit(GetOwningPlayer(Hero),'o00Y',x,y,a)//o00Y -> Lion Roar Effect
	call UnitApplyTimedLife(Caster,'BTLF',1)
	call UnitAddAbility2(Caster,'A0NY')//A0NY -> Primal Roar (Side slow Effect)
	call SetUnitAbilityLevel(Caster,'A0NY',Level)//A0NY -> Primal Roar (Side slow Effect)
	call IssueImmediateOrderById(Caster,852096)
	set x=GetUnitX(Hero)+250*Cos(a*bj_DEGTORAD)
	set y=GetUnitY(Hero)+250*Sin(a*bj_DEGTORAD)
	call GroupEnumUnitsInRange(g2,x,y,275,Condition(function LR8))
	call GroupAddGroup(g2,g)
	call GroupClear(g2)
	set Caster=CreateUnit(GetOwningPlayer(Hero),'o00Y',x,y,a)//o00Y -> Lion Roar Effect
	call UnitApplyTimedLife(Caster,'BTLF',1)
	call UnitAddAbility2(Caster,'A0NY')//A0NY -> Primal Roar (Side slow Effect)
	call SetUnitAbilityLevel(Caster,'A0NY',Level)//A0NY -> Primal Roar (Side slow Effect)
	call IssueImmediateOrderById(Caster,852096)
	set x=GetUnitX(Hero)+450*Cos(a*bj_DEGTORAD)
	set y=GetUnitY(Hero)+450*Sin(a*bj_DEGTORAD)
	call GroupEnumUnitsInRange(g2,x,y,275,Condition(function LR8))
	call GroupAddGroup(g2,g)
	call GroupClear(g2)
	set Caster=CreateUnit(GetOwningPlayer(Hero),'o00Y',x,y,a)//o00Y -> Lion Roar Effect
	call UnitApplyTimedLife(Caster,'BTLF',1)
	call UnitAddAbility2(Caster,'A0NY')//A0NY -> Primal Roar (Side slow Effect)
	call SetUnitAbilityLevel(Caster,'A0NY',Level)//A0NY -> Primal Roar (Side slow Effect)
	call IssueImmediateOrderById(Caster,852096)
	if GetUnitAbilityLevel(Hero,'A0O2')==0 then//A0O2 -> Primal Roar
		set x=GetUnitX(Hero)+650*Cos(a*bj_DEGTORAD)
		set y=GetUnitY(Hero)+650*Sin(a*bj_DEGTORAD)
		call GroupEnumUnitsInRange(g2,x,y,275,Condition(function LR8))
		call GroupAddGroup(g2,g)
		call GroupClear(g2)
		set Caster=CreateUnit(GetOwningPlayer(Hero),'o00Y',x,y,a)//o00Y -> Lion Roar Effect
		call UnitApplyTimedLife(Caster,'BTLF',1)
		call UnitAddAbility2(Caster,'A0NY')//A0NY -> Primal Roar (Side slow Effect)
		call SetUnitAbilityLevel(Caster,'A0NY',Level)//A0NY -> Primal Roar (Side slow Effect)
		call IssueImmediateOrderById(Caster,852096)
	endif
	call KillGroup(g2)
	call GroupRemoveUnit(g,Target)
	set tt_real1=150+50*Level
	set tt_unit1=Hero
	call ForGroup(g,function M0E)
	//call KillGroup(g)
	set t=null
	set Hero=null
	set Target=null
	set Caster=null
	set g=null
	set g2=null
endfunction

function Beastmaster_PrimalRoar takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call M5E()
	endif
endfunction


function N4E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call UnitRemoveAbility(Source,'A140')//A140 -> Permanent Invisibility (rexxar)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function Beastmaster_HawkInvis takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call UnitAddAbility2(Source,'A140')//A140 -> Permanent Invisibility (rexxar)
	call TriggerRegisterTimerEvent(t,6,false)
	call TriggerAddCondition(t,Condition(function N4E))
	call SaveUnitHandle(HY,h,2,(Source))
	set t=null
	set Source=null
endfunction

function NDE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit NEE=(LoadUnitHandle(HY,h,2))
	local real LastX=(LoadReal(HY,h,6))
	local real LastY=(LoadReal(HY,h,7))
	local real NHE=GetUnitX(NEE)
	local real NIE=GetUnitY(NEE)
	call SaveReal(HY,h,6,((NHE)*1.))
	call SaveReal(HY,h,7,((NIE)*1.))
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if LastX==NHE and LastY==NIE then
			if GetUnitAbilityLevel(NEE,'A1WG')==0 then//A1WG -> Permanent Invisibility (hawk)
				call UnitAddAbility2(NEE,'A1WG')//A1WG -> Permanent Invisibility (hawk)
			endif
		else
			if GetUnitAbilityLevel(NEE,'A1WG')>0 then//A1WG -> Permanent Invisibility (hawk)
				call UnitRemoveAbility(NEE,'A1WG')//A1WG -> Permanent Invisibility (hawk)
			endif
		endif
	endif
	set t=null
	set NEE=null
	return false
endfunction

function Beastmaster_CallOfTheWild_Learned takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local integer level = GetUnitAbilityLevel(u,'A0OO')//A0OO -> Call of the Wild
	if(level==1)then
		call UnitAddAbility2(u,'A300')//A300 -> Summon Hawk
		call UnitAddAbility2(u,'A301')//A301 -> Summon Quilbeast
	endif
	call SetUnitAbilityLevel(u,'A300',level)//A300 -> Summon Hawk
	call SetUnitAbilityLevel(u,'A301',level)//A301 -> Summon Quilbeast
	set u=null
endfunction

function Beastmaster_CallBeast takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer i=GetUnitAbilityLevel(u,'A301')//A301 -> Summon Quilbeast
	local group g
	local unit boar=null
	local integer id
	if GetUnitTypeId(u)=='e00E' then//e00E -> Spellcaster
		set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
	endif
	if i==1 then
		set id='h30A'//h30A -> Baby Quilbeast
	elseif i==2 then
		set id='n01M'//n01M -> Quilbeast
	elseif i==3 then
		set id='n01S'//n01S -> Greater Quilbeast
	else
		set id='h30B'//h30B -> Legendary Quilbeast
	endif
	set boar=CreateUnit(GetOwningPlayer(u),id,GetUnitX(u),GetUnitY(u),GetUnitFacing(u))
	call UnitApplyTimedLife(boar,'BTLF',60)
	call SetUnitAbilityLevel(boar,'A0OP',i)//A0OP -> Quilbeast Poison
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",boar,"chest"))
	set i=GetUnitAbilityLevel(u,'A0A8')
	if i>0 then
		call AddMaxHPFx(boar,100*i)
		call UnitAddAbility3(boar,'A3IM',i)
	endif
	set boar=null
	set u=null
endfunction

function Beastmaster_CallHawk takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer i=GetUnitAbilityLevel(u,'A300')//A300 -> Summon Hawk
	local trigger t
	local integer h
	local unit hawk
	local integer id
	if GetUnitTypeId(u)=='e00E' then//e00E -> Spellcaster
		set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
	endif
	if i==1 then
		set id='h308'//h308 -> Hawk
	elseif i==2 then
		set id='n01Q'//n01Q -> Scout Hawk
	elseif i==3 then
		set id='n01R'//n01R -> Greater Hawk
	else
		set id='h309'//h309 -> Legendary Hawk
	endif
	set hawk=CreateUnit(GetOwningPlayer(u),id,GetUnitX(u),GetUnitY(u),GetUnitFacing(u))
	call UnitApplyTimedLife(hawk,'BTLF',60)
	if i>2 then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,.05,true)
		call TriggerRegisterUnitEvent(t,hawk,EVENT_UNIT_DEATH)
		call SaveReal(HY,h,6,((GetUnitX(hawk))*1.))
		call SaveReal(HY,h,7,((GetUnitY(hawk))*1.))
		call SaveUnitHandle(HY,h,2,(hawk))
		call TriggerAddCondition(t,Condition(function NDE))
		set t=null
	endif
	set i=GetUnitAbilityLevel(u,'A0A8')
	if i>0 then
		call SetUnitMoveSpeed(hawk,GetUnitDefaultMoveSpeed(hawk)+50*i)
		call UnitAddAbility2(hawk,'Amim')
	endif
	set u=null
	set hawk=null
endfunction

function NME takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local integer h=GetHandleId(Source)
	local player p=(LoadPlayerHandle(HY,h,54))
	local integer Level=(LoadInteger(HY,h,5))
	local texttag tt=CreateTextTag()
	local integer gold
	local integer i=1
	local unit u
	local player p2
	if Level==1 then
		set gold=150
	elseif Level==2 then
		set gold=200
	else
		set gold=250
	endif
	set gold=AddGold(p,gold)
	call SetTextTagText(tt,"+"+I2S(gold),.025)
	call SetTextTagPosUnit(tt,udg_Hero[GetPlayerId(p)],100)
	call SetTextTagColor(tt,255,220,0,255)
	call SetTextTagVelocity(tt,0,.03)
	call SetTextTagVisibility(tt,GetLocalPlayer()==p)
	call SetTextTagFadepoint(tt,2)
	call SetTextTagLifespan(tt,3)
	call SetTextTagPermanent(tt,false)
	set ReliableGold[GetPlayerId(p)]=ReliableGold[GetPlayerId(p)]+gold
	//set E48=E48+gold
	set TrackBonusBounty[GetPlayerId(p)]=TrackBonusBounty[GetPlayerId(p)]+gold
	
	loop
		exitwhen i>5
		if IsSentinel(p)then
			set p2=Sentinels[i]
		else
			set p2=Scourges[i]
		endif
		if p2!=p then
			set u=udg_Hero[GetPlayerId(p2)]
			if DistanceBetweenUnits(u,Source)<950 then
				set tt=CreateTextTag()
				if Level==1 then
					set gold=40
				elseif Level==2 then
					set gold=80
				else
					set gold=120
				endif
				set gold=AddGold(p2,gold)
				call SetTextTagText(tt,"+"+I2S(gold),.025)
				call SetTextTagPosUnit(tt,u,100)
				call SetTextTagColor(tt,255,220,0,255)
				call SetTextTagVelocity(tt,0,.03)
				call SetTextTagVisibility(tt,GetLocalPlayer()==p2)
				call SetTextTagFadepoint(tt,2)
				call SetTextTagLifespan(tt,3)
				call SetTextTagPermanent(tt,false)
				set ReliableGold[GetPlayerId(p2)]=ReliableGold[GetPlayerId(p2)]+gold
				//set E48=E48+gold
				set TrackBonusBounty[GetPlayerId(p2)]=TrackBonusBounty[GetPlayerId(p2)]+gold
			endif
		endif
		set i=i+1
	endloop
	set Source=null
	set p=null
	set p2=null
	set u=null
	set tt=null
endfunction

function BH_TrackKill takes nothing returns nothing
	if LoadReal(HY,GetHandleId(GetTriggerUnit()),314) > TimerGetElapsed(GlobalTimer) then
		call NME()
	endif
endfunction

function NOE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,17)
	local unit Caster=LoadUnitHandle(HY,h,19)
	call SetUnitX(Caster,GetUnitX(Target))
	call SetUnitY(Caster,GetUnitY(Target))
	if (GetTriggerEvalCount(t)>10 and GetUnitAbilityLevel(Target,'B00L')==0) or LoadReal(HY,GetHandleId(Target),314)==0 then//B00L -> Track
		//call UnitRemoveAbility(Target,'A311')
		call UnitRemoveAbility(Target,'B00L')//B00L -> Track
		call RemoveSavedHandle(HY,GetHandleId(Target),'B00L')
		call SaveReal(HY,GetHandleId(Target),314,0)
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call KillUnit(Caster)
		call RemoveUnit(Caster)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	set Caster=null
	return false
endfunction

function Bounty_Track takes nothing returns nothing
	local trigger t
	local integer h
	local unit Target=GetSpellTargetUnit()
	local unit Source=GetTriggerUnit()
	local unit Caster
	local string FX="war3mapImported\\TrackBuff.mdx"
	if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Target))and IsObserver(GetLocalPlayer())==false then
		set FX=""
	endif
	if HaveSavedHandle(HY,GetHandleId(Target),'B00L') then
		set t=LoadTriggerHandle(HY,GetHandleId(Target),'B00L')
		set h=GetHandleId(t)
		call UnitRemoveAbility(Target,'B00L')//B00L -> Track
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,GetHandleId(Target),'B00L',t)
		set Caster=CreateUnit(GetOwningPlayer(Target),'e01V',GetUnitX(Target),GetUnitY(Target),0)//e01V -> Spellcaster #3
		call UnitAddAbility2(Caster,'A115')//A115 -> Track Speed
		call TriggerRegisterTimerEvent(t,.02,true)
		call TriggerAddCondition(t,Condition(function NOE))
		call SaveUnitHandle(HY,h,17,Target)
		call SaveUnitHandle(HY,h,19,Caster)
		call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget(FX,Target,"overhead"))
	endif
	call SaveReal(HY,GetHandleId(Target),314,TimerGetElapsed(GlobalTimer)+30*1.)
	call SavePlayerHandle(HY,GetHandleId(Target),54,GetOwningPlayer(Source))
	call SaveInteger(HY,GetHandleId(Target),5,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	set t=null
	set Target=null
	set Source=null
	set Caster=null
endfunction

function NRE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,17)
	call UnitRemoveAbility(Target,'A1IW')//A1IW -> Jinada Maim
	call UnitRemoveAbility(Target,'B0CA')//B0CA -> Jinada
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Target=null
	return false
endfunction

function NSE takes unit Source,unit Target returns nothing
	call UnitAddAbilityTimedExF(Target,'A1IX',1,3,'B0CA')
endfunction

function NTE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,30)
	local unit Source=(LoadUnitHandle(HY,h,2))
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==Source and(GetEventDamage()>40 or IsUnitType(Target,UNIT_TYPE_STRUCTURE) or GetUnitTypeId(Target)=='umtw' or GetUnitTypeId(Target)=='ebal')and(LoadBoolean(HY,(GetHandleId(Source)),('A1IQ'+183))) then//umtw -> Meat Wagon, ebal -> Glaive Thrower, A1IQ -> Jinada
			call NSE(Source,Target)
			call SaveBoolean(HY,GetHandleId(Source),'A1IQ'+183,false)//A1IQ -> Jinada
			call SaveReal(HY,GetHandleId(Source),'A1IQ'+184,TimerGetElapsed(GlobalTimer)*1.)//A1IQ -> Jinada
			call UnitRemoveAbility(Source,'A1IS')//A1IS -> Jinada FX
			call UnitRemoveAbility(Source,'A1J4')//A1J4 -> Jinada Container - 1
			call UnitRemoveAbility(Source,'A1J3')//A1J3 -> Jinada Container - 2
			call UnitRemoveAbility(Source,'A1J5')//A1J5 -> Jinada Container - 3
			call UnitRemoveAbility(Source,'A1IU')//A1IU -> Jinada Container - 4
			call FlushChildHashtable(HY,GetHandleId(LoadTriggerHandle(HY,h,35)))
			call CleanTrigger(LoadTriggerHandle(HY,h,35))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	else
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function JinadaASFixSup takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	call UnitRemoveAbility(u,'A1J4')//A1J4 -> Jinada Container - 1
	call UnitRemoveAbility(u,'A1J3')//A1J3 -> Jinada Container - 2
	call UnitRemoveAbility(u,'A1J5')//A1J5 -> Jinada Container - 3
	call UnitRemoveAbility(u,'A1IU')//A1IU -> Jinada Container - 4
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set u=null
endfunction

function JinadaASFix takes unit u returns nothing
	local timer t=CreateTimer()
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call TimerStart(t,0.2,false,function JinadaASFixSup)
	set t=null
endfunction

function NUE takes nothing returns boolean
	local trigger t
	local integer h
	local unit Target
	local unit Source
	local integer Level
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SaveBoolean(HY,GetHandleId(GetTriggerUnit()),'A1IQ'+183,false)//A1IQ -> Jinada
		call SaveReal(HY,GetHandleId(GetTriggerUnit()),'A1IQ'+184,TimerGetElapsed(GlobalTimer)*1.)//A1IQ -> Jinada
		call UnitRemoveAbility(GetTriggerUnit(),'A1IS')//A1IS -> Jinada FX
		call UnitRemoveAbility(GetTriggerUnit(),'A1J4')//A1J4 -> Jinada Container - 1
		call UnitRemoveAbility(GetTriggerUnit(),'A1J3')//A1J3 -> Jinada Container - 2
		call UnitRemoveAbility(GetTriggerUnit(),'A1J5')//A1J5 -> Jinada Container - 3
		call UnitRemoveAbility(GetTriggerUnit(),'A1IU')//A1IU -> Jinada Container - 4
		call FlushChildHashtable(HY,GetHandleId(GetTriggeringTrigger()))
		call CleanTrigger(GetTriggeringTrigger())
	elseif GetAttacker()==(LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),182))then
		if IsUnitAlly(GetAttacker(),GetOwningPlayer(GetTriggerUnit()))==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetAttacker(),'A36D')==0 then
			set t=CreateTrigger()
			set h=GetHandleId(t)
			set Target=GetTriggerUnit()
			set Source=GetAttacker()
			call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
			call TriggerRegisterTimerEvent(t,2.5,false)
			call TriggerAddCondition(t,Condition(function NTE))
			call SaveUnitHandle(HY,h,30,(Target))
			call SaveUnitHandle(HY,h,2,Source)
			if IsRangedUnitHasOverAS(Source) then
				call JinadaASFix(Source)
			endif
			call SaveTriggerHandle(HY,h,35,GetTriggeringTrigger())
			set Level=GetUnitAbilityLevel(Source,'A524')//A524 -> Jinada
			if Level==0 then
				call UnitRemoveAbility(Source,'A1J4')//A1J4 -> Jinada Container - 1
				call UnitRemoveAbility(Source,'A1J3')//A1J3 -> Jinada Container - 2
				call UnitRemoveAbility(Source,'A1J5')//A1J5 -> Jinada Container - 3
				call UnitRemoveAbility(Source,'A1IU')//A1IU -> Jinada Container - 4
			elseif Level==1 then
				call UnitRemoveAbility(Source,'A1J3')//A1J3 -> Jinada Container - 2
				call UnitRemoveAbility(Source,'A1J5')//A1J5 -> Jinada Container - 3
				call UnitRemoveAbility(Source,'A1IU')//A1IU -> Jinada Container - 4
			elseif Level==2 then
				call UnitRemoveAbility(Source,'A1J4')//A1J4 -> Jinada Container - 1
				call UnitRemoveAbility(Source,'A1J5')//A1J5 -> Jinada Container - 3
				call UnitRemoveAbility(Source,'A1IU')//A1IU -> Jinada Container - 4
			elseif Level==3 then
				call UnitRemoveAbility(Source,'A1J4')//A1J4 -> Jinada Container - 1
				call UnitRemoveAbility(Source,'A1J3')//A1J3 -> Jinada Container - 2
				call UnitRemoveAbility(Source,'A1IU')//A1IU -> Jinada Container - 4
			elseif Level==4 then
				call UnitRemoveAbility(Source,'A1J4')//A1J4 -> Jinada Container - 1
				call UnitRemoveAbility(Source,'A1J3')//A1J3 -> Jinada Container - 2
				call UnitRemoveAbility(Source,'A1J5')//A1J5 -> Jinada Container - 3
			endif
			set Target=null
			set Source=null
			set t=null
		endif
	endif
	return false
endfunction

function NVE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real YP8=TimerGetElapsed(GlobalTimer)
	local integer Level=GetUnitAbilityLevel(Hero,'A524')//A524 -> Jinada
	local real JSE=LoadReal(HY,GetHandleId(Hero),'A1IQ'+184)//A1IQ -> Jinada
	local boolean NWE=LoadBoolean(HY,GetHandleId(Hero),'A1IQ'+183)//A1IQ -> Jinada
	if GetUnitAbilityLevel(Hero,'A1IQ')>0 and GetUnitAbilityLevel(Hero,'A1IQ')!=Level then//A1IQ -> Jinada, A1IQ -> Jinada
		call SetUnitAbilityLevel(Hero,'A1IQ',Level)//A1IQ -> Jinada
	endif
	if YP8-JSE>14-Level*2 and NWE==false and isPlayerPickedAbility(GetOwningPlayer(Hero),31*4+2) and IsDead(Hero)==false then
		call SaveBoolean(HY,GetHandleId(Hero),'A1IQ'+183,true)//A1IQ -> Jinada
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
		call TriggerRegisterDeathEvent(t,Hero)
		call TriggerAddCondition(t,Condition(function NUE))
		call SaveUnitHandle(HY,h,182,Hero)
		call UnitAddAbility2(Hero,'A1IS')//A1IS -> Jinada FX
		if GetUnitAbilityLevel(Hero,'B068')==0 then//B068 -> Wind Walk
			if Level==1 then
				call UnitAddAbility2(Hero,'A1J4')//A1J4 -> Jinada Container - 1
				call UnitMakeAbilityPermanent(Hero,true,'A1J2')//A1J2 -> Jinada Critical - 1
				if Mode_BO==false and (GetUnitAbilityLevel(Hero,'A0CY')>0 or (GetUnitAbilityLevel(Hero,'Y315')>0 and IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER))) then//A0CY -> Grow, QP1K -> Grow
					call SetUnitAbilityLevel(Hero,'A1J2',2)//A1J2 -> Jinada Critical - 1
				endif
			elseif Level==2 then
				call UnitAddAbility2(Hero,'A1J3')//A1J3 -> Jinada Container - 2
				call UnitMakeAbilityPermanent(Hero,true,'A1IT')//A1IT -> Jinada Critical - 2
				if Mode_BO==false and (GetUnitAbilityLevel(Hero,'A0CY')>0 or (GetUnitAbilityLevel(Hero,'Y315')>0 and IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER))) then//A0CY -> Grow, QP1K -> Grow
					call SetUnitAbilityLevel(Hero,'A1IT',2)//A1IT -> Jinada Critical - 2
				endif
			elseif Level==3 then
				call UnitAddAbility2(Hero,'A1J5')//A1J5 -> Jinada Container - 3
				call UnitMakeAbilityPermanent(Hero,true,'A1J1')//A1J1 -> Jinada Critical - 3
				if Mode_BO==false and (GetUnitAbilityLevel(Hero,'A0CY')>0 or (GetUnitAbilityLevel(Hero,'Y315')>0 and IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER))) then//A0CY -> Grow, QP1K -> Grow
					call SetUnitAbilityLevel(Hero,'A1J1',2)//A1J1 -> Jinada Critical - 3
				endif
			elseif Level==4 then
				call UnitAddAbility2(Hero,'A1IU')//A1IU -> Jinada Container - 4
				call UnitMakeAbilityPermanent(Hero,true,'A1J0')//A1J0 -> Jinada Critical - 4
				if Mode_BO==false and (GetUnitAbilityLevel(Hero,'A0CY')>0 or (GetUnitAbilityLevel(Hero,'Y315')>0 and IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER)))  then//A0CY -> Grow, QP1K -> Grow
					call SetUnitAbilityLevel(Hero,'A1J0',2)//A1J0 -> Jinada Critical - 4
				endif
			endif
		endif
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A1J4',false)//A1J4 -> Jinada Container - 1
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A1J3',false)//A1J3 -> Jinada Container - 2
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A1J5',false)//A1J5 -> Jinada Container - 3
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A1IU',false)//A1IU -> Jinada Container - 4
	elseif NWE==false and GetUnitAbilityLevel(Hero,'B068')==0 then//B068 -> Wind Walk
		call UnitRemoveAbility(Hero,'A1IS')//A1IS -> Jinada FX
		call UnitRemoveAbility(Hero,'A1J4')//A1J4 -> Jinada Container - 1
		call UnitRemoveAbility(Hero,'A1J3')//A1J3 -> Jinada Container - 2
		call UnitRemoveAbility(Hero,'A1J5')//A1J5 -> Jinada Container - 3
		call UnitRemoveAbility(Hero,'A1IU')//A1IU -> Jinada Container - 4
	endif
	set t=null
	set Hero=null
	return false
endfunction

function Bounty_Jinada_Learn takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call UnitAddAbility2(Hero,'A1IQ')//A1IQ -> Jinada
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddCondition(t,Condition(function NVE))
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveInteger(HY,h,181,0)
	set Hero=null
	set t=null
endfunction

function Bounty_Jinada_LearnTrigger takes nothing returns nothing
	if IsUnitIllusion(GetTriggerUnit())==false then
		call Bounty_Jinada_Learn()
	endif
endfunction

function NZE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=GetUnitAbilityLevel(Source,'A07A')//A07A -> Wind Walk
	if Level<1 then
		set Level=GetUnitAbilityLevel(Source,'QB09')//QB09 -> Wind Walk
	endif
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==Source then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			if((LoadInteger(HY,(GetHandleId((Source))),(2487)))==1)==false then
				call AddTimedKeyToUnit(Source,2487,.5)
				if IsUnitType(Target,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(Target,GetOwningPlayer(Source))then
					call DamageTarget(Source,Target,2,30*Level)
					call TextTagOnUnit(I2S(R2I(30*Level)),1,Source,.027,216,0,0,216)
				endif
			endif
		endif
	else
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function NAE takes nothing returns nothing
	local trigger t=CreateTrigger()
	local unit Target=GetTriggerUnit()
	local unit Source=GetAttacker()
	local integer h=GetHandleId(t)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerRegisterTimerEvent(t,2,false)
	call TriggerAddCondition(t,Condition(function NZE))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveUnitHandle(HY,h,2,(Source))
	set Target=null
	set Source=null
	set t=null
endfunction

function NBE takes nothing returns boolean
	local integer Level
	local unit Hero
	if GetTriggerEventId()==EVENT_UNIT_SPELL_CAST or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		set Hero=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),14))
		//set Level=GetUnitAbilityLevel(Hero,'A1IQ')//A1IQ -> Jinada
		set Level=GetUnitAbilityLevel(GetAttacker(),'A524')//A524 -> Jinada
		if(LoadBoolean(HY,(GetHandleId(Hero)),('A1IQ'+183)))then//A1IQ -> Jinada
			set Level=GetUnitAbilityLevel(Hero,'A1IQ')//A1IQ -> Jinada
			if Level==0 then
				call UnitRemoveAbility(Hero,'A1J4')//A1J4 -> Jinada Container - 1
				call UnitRemoveAbility(Hero,'A1J3')//A1J3 -> Jinada Container - 2
				call UnitRemoveAbility(Hero,'A1J5')//A1J5 -> Jinada Container - 3
				call UnitRemoveAbility(Hero,'A1IU')//A1IU -> Jinada Container - 4
			elseif Level==1 then
				call UnitRemoveAbility(Hero,'A1J3')//A1J3 -> Jinada Container - 2
				call UnitRemoveAbility(Hero,'A1J5')//A1J5 -> Jinada Container - 3
				call UnitRemoveAbility(Hero,'A1IU')//A1IU -> Jinada Container - 4
			elseif Level==2 then
				call UnitRemoveAbility(Hero,'A1J4')//A1J4 -> Jinada Container - 1
				call UnitRemoveAbility(Hero,'A1J5')//A1J5 -> Jinada Container - 3
				call UnitRemoveAbility(Hero,'A1IU')//A1IU -> Jinada Container - 4
			elseif Level==3 then
				call UnitRemoveAbility(Hero,'A1J4')//A1J4 -> Jinada Container - 1
				call UnitRemoveAbility(Hero,'A1J3')//A1J3 -> Jinada Container - 2
				call UnitRemoveAbility(Hero,'A1IU')//A1IU -> Jinada Container - 4
			elseif Level==4 then
				call UnitRemoveAbility(Hero,'A1J4')//A1J4 -> Jinada Container - 1
				call UnitRemoveAbility(Hero,'A1J3')//A1J3 -> Jinada Container - 2
				call UnitRemoveAbility(Hero,'A1J5')//A1J5 -> Jinada Container - 3
			endif
		else
			call UnitRemoveAbility(Hero,'A1J4')//A1J4 -> Jinada Container - 1
			call UnitRemoveAbility(Hero,'A1J3')//A1J3 -> Jinada Container - 2
			call UnitRemoveAbility(Hero,'A1J5')//A1J5 -> Jinada Container - 3
			call UnitRemoveAbility(Hero,'A1IU')//A1IU -> Jinada Container - 4
		endif
		call FlushChildHashtable(HY,(GetHandleId(GetTriggeringTrigger())))
		call CleanTrigger(GetTriggeringTrigger())
	elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
		if GetAttacker()==(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),14))then
			if((LoadInteger(HY,(GetHandleId((GetAttacker()))),(2488)))==1)==false then
				call FlushChildHashtable(HY,(GetHandleId(GetTriggeringTrigger())))
				call CleanTrigger(GetTriggeringTrigger())
				call NAE()
			endif
			if(LoadBoolean(HY,(GetHandleId(GetAttacker())),('A1IQ'+183)))then//A1IQ -> Jinada
				//set Level=GetUnitAbilityLevel(GetAttacker(),'A1IQ')//A1IQ -> Jinada
				set Level=GetUnitAbilityLevel(GetAttacker(),'A524')//A524 -> Jinada
				if Level==0 then
					call UnitRemoveAbility(GetAttacker(),'A1J4')//A1J4 -> Jinada Container - 1
					call UnitRemoveAbility(GetAttacker(),'A1J3')//A1J3 -> Jinada Container - 2
					call UnitRemoveAbility(GetAttacker(),'A1J5')//A1J5 -> Jinada Container - 3
					call UnitRemoveAbility(GetAttacker(),'A1IU')//A1IU -> Jinada Container - 4
				elseif Level==1 then
					call UnitRemoveAbility(GetAttacker(),'A1J3')//A1J3 -> Jinada Container - 2
					call UnitRemoveAbility(GetAttacker(),'A1J5')//A1J5 -> Jinada Container - 3
					call UnitRemoveAbility(GetAttacker(),'A1IU')//A1IU -> Jinada Container - 4
				elseif Level==2 then
					call UnitRemoveAbility(GetAttacker(),'A1J4')//A1J4 -> Jinada Container - 1
					call UnitRemoveAbility(GetAttacker(),'A1J5')//A1J5 -> Jinada Container - 3
					call UnitRemoveAbility(GetAttacker(),'A1IU')//A1IU -> Jinada Container - 4
				elseif Level==3 then
					call UnitRemoveAbility(GetAttacker(),'A1J4')//A1J4 -> Jinada Container - 1
					call UnitRemoveAbility(GetAttacker(),'A1J3')//A1J3 -> Jinada Container - 2
					call UnitRemoveAbility(GetAttacker(),'A1IU')//A1IU -> Jinada Container - 4
				elseif Level==4 then
					call UnitRemoveAbility(GetAttacker(),'A1J4')//A1J4 -> Jinada Container - 1
					call UnitRemoveAbility(GetAttacker(),'A1J3')//A1J3 -> Jinada Container - 2
					call UnitRemoveAbility(GetAttacker(),'A1J5')//A1J5 -> Jinada Container - 3
				endif
			else
				call UnitRemoveAbility(GetAttacker(),'A1J4')//A1J4 -> Jinada Container - 1
				call UnitRemoveAbility(GetAttacker(),'A1J3')//A1J3 -> Jinada Container - 2
				call UnitRemoveAbility(GetAttacker(),'A1J5')//A1J5 -> Jinada Container - 3
				call UnitRemoveAbility(GetAttacker(),'A1IU')//A1IU -> Jinada Container - 4
			endif
		endif
	else
		if LoadBoolean(HY,GetHandleId(GetTriggeringTrigger()),0) then
			set Hero=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),14))
			call RemoveEndlessFadetime(Hero)
			call Func0404(Hero,'I0TG')
			call RemoveSavedBoolean(HY,GetHandleId(GetTriggeringTrigger()),0)
		else
			set Hero=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),14))
			if(LoadBoolean(HY,(GetHandleId(Hero)),'A1IQ'+183))==false then
				call UnitRemoveAbility(Hero,'A1J4')//A1J4 -> Jinada Container - 1
				call UnitRemoveAbility(Hero,'A1J3')//A1J3 -> Jinada Container - 2
				call UnitRemoveAbility(Hero,'A1J5')//A1J5 -> Jinada Container - 3
				call UnitRemoveAbility(Hero,'A1IU')//A1IU -> Jinada Container - 4
			endif
			call FlushChildHashtable(HY,(GetHandleId(GetTriggeringTrigger())))
			call CleanTrigger(GetTriggeringTrigger())
		endif
	endif
	set Hero=null
	return false
endfunction

function Bounty_Windwalk takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Target=GetSpellTargetUnit()
	local unit Source=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Source,GetSpellAbilityId())
	call AddTimedKeyToUnit(Source,2488,1.25-.25*Level-.01)
	call TriggerRegisterTimerEvent(t,10+5*Level,false)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_CAST)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterTimerEvent(t,0,false)
	call SaveBoolean(HY,h,0,true)
	call TriggerAddCondition(t,Condition(function NBE))
	call SaveUnitHandle(HY,h,14,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call UnitAddAbility2(Source,'A1J4')//A1J4 -> Jinada Container - 1
	call UnitAddAbility2(Source,'A1J3')//A1J3 -> Jinada Container - 2
	call UnitAddAbility2(Source,'A1J5')//A1J5 -> Jinada Container - 3
	call UnitAddAbility2(Source,'A1IU')//A1IU -> Jinada Container - 4
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1J4',false)//A1J4 -> Jinada Container - 1
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1J3',false)//A1J3 -> Jinada Container - 2
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1J5',false)//A1J5 -> Jinada Container - 3
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1IU',false)//A1IU -> Jinada Container - 4
	set t=null
	set Target=null
	set Source=null
endfunction

function Bounty_ShurikenToss_Hit takes nothing returns nothing
	local unit caster=tt_unit1
	local unit target=tt_unit2
	local group g
	local group tg
	local unit u
	local integer jumpsleft
	local real dmg=0.
	local integer lvl
	local boolean bounce=false
	local integer h
	if LoadUnitHandle(MHT,GetHandleId(caster),'A004'+1)!=null then//A004 -> Shuriken Toss
		set caster=LoadUnitHandle(MHT,GetHandleId(caster),'A004'+1)//A004 -> Shuriken Toss
		set bounce=true
		call RemoveSavedHandle(MHT,GetHandleId(tt_unit1),'A004'+1)//A004 -> Shuriken Toss
	endif
	set h=GetHandleId(caster)
	set g=LoadGroupHandle(MHT,h,'A004')//A004 -> Shuriken Toss
	set jumpsleft=LoadInteger(MHT,h,'A004')//A004 -> Shuriken Toss
	set lvl=LoadInteger(MHT,h,'A005')//A005 -> Double Damage
	
	call StunFor001(target)
	call GroupAddUnit(g,target)
	if bounce then
		set dmg=25+50*lvl
	else
		set dmg=75*(lvl+1)
	endif
	call DamageTarget(caster,target,1,dmg)
//	call echo(GetUnitName(caster)+" damages "+GetUnitName(target))
	if GetUnitAbilityLevel(target,'A3E9')==1 and LoadBoolean(MHT,h,'A004')==false then//A004 -> Shuriken Toss
		if IsMagicImmune(caster)==false and GetUnitAbilityLevel(caster,'Aloc')==0 then//Aloc -> Locust
			call SaveUnitHandle(TempHash,'A3E9',0,target)
			call SaveUnitHandle(TempHash,'A3E9',1,caster)
			call SaveInteger(TempHash,'A3E9',0,lvl)
			call ExecuteFunc("Bounty_ShurikenTossLotused")
		endif
	endif
	if jumpsleft>0 then
		set tg=GetAvailableGroup()
		set tt_unit1=caster
		call GroupEnumUnitsInRange(tg,GetUnitX(target),GetUnitY(target),425,Condition(function NonImmuneVisibleEnemyFilter))
		call GroupRemoveGroup(g,tg)//remove already hit units
		set u=FirstOfGroup(tg)
		if u!=null then
			call AddProjectile(target,u,'h02K',"Bounty_ShurikenToss_Hit",1000,true)//h02K -> Boots of Travel
			
			call SaveUnitHandle(MHT,GetHandleId(target),'A004'+1,caster)//A004 -> Shuriken Toss
			call SaveInteger(MHT,h,'A004',jumpsleft-1)//A004 -> Shuriken Toss
//			call echo("from "+GetUnitName(target)+" to "+GetUnitName(u)+", saved caster="+GetUnitName(caster))
		else
//			call echo("no targets, end")
			call KillGroup(g)
			call RemoveSavedInteger(MHT,h,'A004')//A004 -> Shuriken Toss
			call RemoveSavedHandle(MHT,h,'A004')//A004 -> Shuriken Toss
			call RemoveSavedBoolean(MHT,h,'A004')//A004 -> Shuriken Toss
			call RemoveSavedInteger(MHT,h,'A005')//A005 -> Double Damage
		endif
		call KillGroup(tg)
		set tg=null
	else
		call KillGroup(g)
		call RemoveSavedInteger(MHT,h,'A004')//A004 -> Shuriken Toss
		call RemoveSavedHandle(MHT,h,'A004')//A004 -> Shuriken Toss
		call RemoveSavedBoolean(MHT,h,'A004')//A004 -> Shuriken Toss
		call RemoveSavedInteger(MHT,h,'A005')//A005 -> Double Damage
		
	endif
	
	set caster=null
	set target=null
	set u=null
	set g=null
	set tg=null
endfunction

function Bounty_ShurikenTossLotused takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	local integer lvl=LoadInteger(TempHash,'A3E9',0)
	call LotusOrbFX(caster)
	if IsBlocked(target)==false then
		call AddProjectile(caster,target,'h02K',"Bounty_ShurikenToss_Hit",1000,true)//h02K -> Boots of Travel
		call SaveInteger(MHT,GetHandleId(caster),'A004',lvl-1)//A004 -> Shuriken Toss
		call SaveInteger(MHT,GetHandleId(caster),'A005',lvl)//A005 -> Double Damage
		call SaveGroupHandle(MHT,GetHandleId(caster),'A004',GetAvailableGroup())//A004 -> Shuriken Toss
		call SaveBoolean(MHT,GetHandleId(caster),'A004',true)//A004 -> Shuriken Toss
	else
		call RemoveLinkenBuff(target)
	endif
	
	call FlushChildHashtable(TempHash,'A3E9')
	set caster=null
	set target=null
endfunction

function Bounty_ShurikenToss takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call AddProjectile(GetTriggerUnit(),GetSpellTargetUnit(),'h02K',"Bounty_ShurikenToss_Hit",1000,true)//h02K -> Boots of Travel
		call SaveInteger(MHT,GetHandleId(GetTriggerUnit()),'A004',GetUnitAbilityLevel(GetTriggerUnit(),'A004')-1)//A004 -> Shuriken Toss, A004 -> Shuriken Toss
		call SaveGroupHandle(MHT,GetHandleId(GetTriggerUnit()),'A004',GetAvailableGroup())//A004 -> Shuriken Toss
		call SaveInteger(MHT,GetHandleId(GetTriggerUnit()),'A005',GetUnitAbilityLevel(GetTriggerUnit(),'A004'))//A005 -> Double Damage, A004 -> Shuriken Toss
	endif
endfunction

function Bristleback_Warpath_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer load = LoadInteger(MHT,info,0)
	local integer count = LoadInteger(MHT,load,'A0FV')-1//A0FV -> Warpath
	local unit u = LoadUnitHandle(MHT,info,0)
	local integer oldspeed=LoadInteger(MHT,GetHandleId(u),'WARP')
	local integer speed
	local integer level=LoadInteger(MHT,GetHandleId(u),'WARL')
	local integer i=R2I(0.5*level*level+0.5*level+4)
	if oldspeed>0 then
		call SubBonusMSPercent(u,oldspeed)
	endif
	set speed=i+(count)*level
	if(count>0)then
		call AddBonusMSPercent(u,speed)
		call SaveInteger(MHT,GetHandleId(u),'WARP',speed)
	else
		call SaveInteger(MHT,GetHandleId(u),'WARP',0)
		call UnitRemoveAbility(u,'A30P')
	endif

	call SaveInteger(MHT,load,'A0FV',count)//A0FV -> Warpath
	call LoDStat_Sub(u,LoadInteger(MHT,info,1),"damage")

	call Timer_End(t)

	set t = null
	set u = null
endfunction

function Bristleback_Warpath_Start takes unit u, integer level returns nothing
	local timer t = null
	local integer save
	local integer speed
	local integer damage
	local integer info = GetHandleId(u)
	local integer count = LoadInteger(MHT,info,'A0FV')+1//A0FV -> Warpath
	local integer i
	local integer oldspeed
	set damage = 15 + 5*level
	if count==5+level then
		return
	endif
	set t = CreateTimer()
	set save = GetHandleId(t)
	set speed=count*(level+2)
	if LoadInteger(MHT,info,'WARP')>0 then
		call SubBonusMSPercent(u,LoadInteger(MHT,info,'WARP'))
	endif
	call LoDStat_Add(u,damage,"damage")
	call SaveInteger(MHT,info,'A0FV',count)//A0FV -> Warpath
	call SaveInteger(MHT,info,'WARP',speed)
	call SaveInteger(MHT,info,'WARL',level)
	call AddBonusMSPercent(u,speed)
	call SaveUnitHandle(MHT,save,0,u)
	call SaveInteger(MHT,save,0,info)
	call SaveInteger(MHT,save,1,damage)
	call TimerStart(t,14.,false,function Bristleback_Warpath_End)
	call UnitAddAbility2(u,'A30P')
	call UnitMakeAbilityPermanent(u,true,'A0EF')//A0EF -> Warpath visual
	set t = null
endfunction

function Bristleback_Warpath_Condition takes unit u, integer spell returns nothing
	local integer level = GetUnitAbilityLevel(u,'A0FV')//A0FV -> Warpath, QP1N -> Warpath
	if level>0 and (spell=='A0FW' or spell=='A0GP' or Valid_Spell(spell)) then//A0FW -> Viscous Nasal Goo, A0GP -> Quill Spray
		call Bristleback_Warpath_Start(u,level)
	endif
endfunction

//function BB_Spray_Filter takes nothing returns boolean
//	return AliveNonBuildOrMarker(GetFilterUnit()) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1))
//endfunction
//
//function QuillSprayOff takes nothing returns nothing
//	local timer t=GetExpiredTimer()
//	local integer h=GetHandleId(t)
//	local unit u
//	local integer i=1
//	local integer hu
//	local integer offset=LoadInteger(HY,h,0)
//	local real dmg
//	loop
//		exitwhen HaveSavedHandle(HY,h,i)==false
//		set u=LoadUnitHandle(HY,h,i)
//		set hu=GetHandleId(u)
//		if hu <= 0 then
//			set hu=LoadInteger(HY,h,i)
//			call FlushChildHashtable(MHT,hu)
//		else
//			set dmg=RMaxIF(LoadReal(MHT,hu,offset)-LoadReal(HY,h,i),0)
//			if dmg==0 then
//				call RemoveSavedReal(MHT,hu,offset)
//			else
//				call SaveReal(MHT,hu,offset,dmg)
//			endif
//		endif
//		set i=i+1
//	endloop
//	call FlushChildHashtable(HY,h)
//	call DestroyTimer(t)
//	set u=null
//	set t=null
//endfunction

//function myBB_Spray takes nothing returns nothing
//	local unit u=GetTriggerUnit()
//	local group g=GetAvailableGroup()
//	local timer t=CreateTimer()
//	local integer h=GetHandleId(t)
//	local integer lvl=GetUnitAbilityLevel(u,'A0GP')//A0GP -> Quill Spray
//	local unit dummy
//	local unit u2
//	local integer hu
//	local real dmg
//	local real stackeddmg
//	local integer offset='A0GP'+GetPlayerId(GetOwningPlayer(u))//A0GP -> Quill Spray
//	local integer i=1
//	if IsUnitType(u,UNIT_TYPE_HERO)==false and GetUnitUserData(u)!=1 then
//		set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
//	endif
//	if GetUnitAbilityLevel(u,'Aloc')>0 or GetUnitAbilityLevel(u,'Avul')>0 then
//		set dummy=u
//	else
//		set dummy=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
//	endif
//	set dmg=lvl*20
//	set tt_unit1=u
//	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),650,Condition(function BB_Spray_Filter))
//	call SaveInteger(HY,h,0,offset)
//	loop
//		set u2=FirstOfGroup(g)
//		exitwhen u2==null
//		set hu=GetHandleId(u2)
//		set stackeddmg=LoadReal(MHT,hu,offset)
//		call SaveUnitHandle(HY,h,i,u2)
//		call DamageTarget(dummy,u2,2,RMinIF(dmg+stackeddmg,400))
//		call SaveReal(MHT,hu,offset,stackeddmg+(28+2*lvl))
//		call SaveInteger(HY,h,i,hu)
//		call SaveReal(HY,h,i,(28+2*lvl))
//		set i=i+1
//		call GroupRemoveUnit(g,u2)
//	endloop
//	call TimerStart(t,14,false,function QuillSprayOff)
//	call KillGroup(g)
//	set u=null
//	set g=null
//	set t=null
//endfunction

function Func1740 takes nothing returns boolean
	return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) and AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function Func1743 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer ht=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,(ht),0))
	local integer hc=GetHandleId(caster)
	local integer i=0
	local unit u
	local integer hu
	loop
		set i=i+1
		exitwhen HaveSavedHandle(HY,ht,i)==false
		set u=LoadUnitHandle(HY,ht,i)
		set hu=GetHandleId(u)
		if hu<1 then
			set hu=LoadInteger(HY,ht,i)
			call FlushChildHashtable(HY,hu)
		else
			call SaveReal(HY,hc,hu,RMaxIF(LoadReal(HY,hc,hu)-LoadReal(HY,ht,i),0))
		endif
	endloop
	call FlushChildHashtable(HY,(ht))
	call CleanTrigger(t)
	set u=null
	set caster=null
	set t=null
	return false
endfunction

function myBB_Spray takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer hc=GetHandleId(caster)
	local group g=GetAvailableGroup()
	local trigger t=CreateTrigger()
	local integer ht=GetHandleId(t)
	local unit u
	local integer h
	local real saveddmg
	local real dmg
	local integer lvl=GetUnitAbilityLevel(caster,'A0GP')//A0GP -> Quill Spray
	local integer stackeddmg=28+2*lvl
	local integer i=0
	local unit dummy
	if IsUnitType(caster,UNIT_TYPE_HERO)==false then
		set caster=udg_Hero[GetPlayerId(GetOwningPlayer(caster))]
		set hc=GetHandleId(caster)
	endif
	call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),650,Condition(function Func1740))
	if GetUnitAbilityLevel(caster,'Aloc')>0 or GetUnitAbilityLevel(caster,'Avul')>0 then
		set dummy=caster
	else
		set dummy=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
	endif
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		set i=i+1
		set h=GetHandleId(u)
		set saveddmg=LoadReal(HY,hc,h)
		set dmg=RMinIF(lvl*20+saveddmg,400)
		call TextTagOnUnit("+"+I2S(R2I(dmg)),1,u,0.023,255,0,0,216)
		call SaveReal(HY,ht,i,stackeddmg)
		call SaveUnitHandle(HY,ht,i,u)
		call SaveInteger(HY,ht,i,h)
		call DamageTarget(dummy,u,2,dmg)
		call SaveReal(HY,hc,h,saveddmg+stackeddmg)
		call GroupRemoveUnit(g,u)
	endloop
	call SaveUnitHandle(HY,ht,0,(caster))
	call KillGroup(g)
	call TriggerRegisterTimerEvent(t,14,false)
	call TriggerAddCondition(t,Condition(function Func1743))
	set t=null
endfunction

function OZE takes unit Hero returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
	call SetUnitUserData(Caster,1)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,Caster,EVENT_UNIT_SPELL_EFFECT)
	call UnitAddAbility2(Caster,'A0GP')//A0GP -> Quill Spray
	if GetUnitAbilityLevel(Hero,'A0GP')>0 then//A0GP -> Quill Spray
		call SetUnitAbilityLevel(Caster,'A0GP',GetUnitAbilityLevel(Hero,'A0GP'))//A0GP -> Quill Spray, A0GP -> Quill Spray
	else
		call SetUnitAbilityLevel(Caster,'A0GP',4)//A0GP -> Quill Spray
	endif
	//call SetUnitAbilityLevel(Caster,'A0GP',GetUnitAbilityLevel(Hero,'A0M3'))//A0GP -> Quill Spray, A0M3 -> Bristleback
	call IssueImmediateOrderById(Caster,852526)
	set Caster=null
endfunction

function OAE takes unit Hero,real damage returns nothing
	local integer h=GetHandleId(Hero)
	local real E89 = LoadReal(HY,h,278) + damage
	if E89 > 230 and LoadInteger(HY,GetHandleId(Hero),'bbcd')!=1 then
		call SaveReal(HY,h,278,0)
		call OZE(Hero)
		call AddTimedKeyToUnit(Hero,'bbcd',0.1)
	else
		call SaveReal(HY,h,278,E89)
	endif
endfunction

function BB_Bristleback_Act takes nothing returns boolean
	local unit Hero=GetTriggerUnit()
	local unit Attacker=GetEventDamageSource()
	local real O3E=AngleBetweenUnits(Attacker,Hero)
	local real HFace=GetUnitFacing(Hero)
	local real OLE
	local real Damage=GetEventDamage()
	local real hp
	local real finalAngle
	local real life = GetWidgetLife(Hero)
	if(Damage>5)and life>0.405 and IsRealDamage and GetUnitAbilityLevel(Hero,'A36D')==0 then
		if((HFace-O3E)<(-180.))then
			set OLE=(HFace-O3E+360)
		else
			if((HFace-O3E)>180.)then
				set OLE=(HFace-O3E-360)
			else
				set OLE=(HFace-O3E)
			endif
		endif
		set finalAngle=RAbsBJ(OLE)
		if finalAngle<=70 then
			set hp=((GetUnitAbilityLevel(Hero,'A0M3'))*.08+.08)*Damage//A0M3 -> Bristleback, QP1M -> Bristleback
			call OAE(Hero,Damage-hp)
			call HealUnitFor(Hero,hp)
		elseif finalAngle<=110 then
			set hp=((GetUnitAbilityLevel(Hero,'A0M3'))*.04+.04)*Damage//A0M3 -> Bristleback, QP1M -> Bristleback
			call HealUnitFor(Hero,hp)
		endif
	endif
	set Hero=null
	set Attacker=null
	return false
endfunction

function Bristleback_Bristleback_Learn takes nothing returns nothing
	local trigger t = CreateTrigger()
	call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function BB_Bristleback_Act))
	set t = null
//	call echo("BB lears")
endfunction

function BB_BB_Learn takes nothing returns nothing
	call Bristleback_Bristleback_Learn()
endfunction

function BBGooEnds takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer hu=LoadInteger(HY,h,0)
	local integer slowid=LoadInteger(HY,hu,'A0Fw')
	call RemoveSavedHandle(HY,hu,'A0FW')//A0FW -> Viscous Nasal Goo
	call RemoveSavedInteger(HY,hu,'A0FW')//A0FW -> Viscous Nasal Goo
	call RemoveSavedInteger(HY,hu,'A0Fw')
	if GetHandleId(u)!=0 then
		call UnitRemoveAbility(u,slowid)
		call UnitRemoveAbility(u,'B37Y')//B37Y -> Viscous Nasal Goo
	endif
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set u=null
endfunction

function BBGooLanding takes nothing returns nothing
	local integer h
	local unit caster=tt_unit1
	local unit target=tt_unit2
	local integer lvl=GetUnitAbilityLevel(caster,'A0FW')//A0FW -> Viscous Nasal Goo
	local integer armor
	local integer slow
	local integer currstacks
	local timer t
	local integer hu=GetHandleId(target)
	local boolean reflected=false
	if lvl==0 and GetUnitAbilityLevel(target,'A0FW')>0 then//A0FW -> Viscous Nasal Goo
		set lvl=GetUnitAbilityLevel(target,'A0FW')//A0FW -> Viscous Nasal Goo
		set reflected=true
	endif
	set armor='A37U'-1+lvl
	set slow='A3F0'+4*(lvl-1)-1
	
	
	if GetUnitAbilityLevel(target,'B37Y')==0 then//B37Y -> Viscous Nasal Goo
		set currstacks=0
	else
		set currstacks=LoadInteger(HY,hu,'A0FW')//A0FW -> Viscous Nasal Goo
	endif
	
	if lvl>0 then
		if currstacks>0 then//del armor first
			call UnitRemoveAbility(target,'A37U')
			call UnitRemoveAbility(target,'A37V')
			call UnitRemoveAbility(target,'A37W')
			call UnitRemoveAbility(target,'A37X')
			
			call UnitRemoveAbility(target,LoadInteger(HY,hu,'A0Fw'))
			call UnitRemoveAbility(target,'B37Y')//B37Y -> Viscous Nasal Goo
			
		endif
		if HaveSavedHandle(HY,hu,'A0FW') then//A0FW -> Viscous Nasal Goo
			set t=LoadTimerHandle(HY,hu,'A0FW')//A0FW -> Viscous Nasal Goo
		else
			set t=CreateTimer()
			call SaveTimerHandle(HY,hu,'A0FW',t)//A0FW -> Viscous Nasal Goo
			call SaveUnitHandle(HY,GetHandleId(t),0,target)
			call SaveInteger(HY,GetHandleId(t),0,hu)
		endif
		//call echo(I2S(currstacks))
		call SaveInteger(HY,hu,'A0FW',IMinIF(4,currstacks+1))//A0FW -> Viscous Nasal Goo
		call TimerStart(t,5.,false,function BBGooEnds)
		set t=null
		set slow=slow+IMinIF(4,currstacks+1)
		call UnitAddAbility2(target,slow)
		call SaveInteger(HY,hu,'A0Fw',slow)
		call UnitAddAbilityTimedExF(target,armor,currstacks+1,5,0)
		
	endif
	if GetUnitAbilityLevel(target,'A3E9')==1 and IsMagicImmune(caster) and reflected==false then
		if IsBlocked(caster)==false then
			call AddProjectile(target,caster,'h01K',"BBGooLanding",1000,true)//h01K -> Kelen's Dagger
		else
			call RemoveLinkenBuff(caster)
		endif
	endif
	set t=null
	set caster=null
	set target=null
endfunction

function BB_Goo takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call AddProjectile(GetTriggerUnit(),GetSpellTargetUnit(),'h01K',"BBGooLanding",1000,true)//h01K -> Kelen's Dagger
	endif
endfunction

function Centaur_Return takes unit attacker, unit target returns nothing
	local integer Level=GetUnitAbilityLevel(target,'P123')
	local real Damage=(14+2*Level)+(.18+.12*Level)*GetHeroHighestStatValue(target)
	call DamageTarget(GetInvulDamager(target),attacker,2,Damage)
endfunction

function Stampede_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local unit u = group_temp_unit[0]
	local group g = LoadGroupHandle(HY,group_temp_integer[0],1)

	if IsUnitInGroup(t,g)==false and IsUnitEnemy(u,GetOwningPlayer(t)) and IsDead(t)==false and IsMagicImmune(t)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(t)!='n00L' then//, n00L -> Roshan
		call GroupAddUnit(g,t)
		call Buff_Add(t,'C017','D017',1.0+0.5*GetUnitAbilityLevel(u,'A2O4'))//A2O4 -> Stampede MS Bonus
		call DamageTarget(u,t,1,group_temp_integer[1])
	endif

	set g = null //dat gut :3
	set u = null
	set t = null
	return false
endfunction

function Stampede_Duration takes nothing returns boolean
	local trigger trig = GetTriggeringTrigger()
	local integer info = GetHandleId(trig)
	local integer count = LoadInteger(HY,info,0)
	local unit u = LoadUnitHandle(HY,info,0)
	local group g = LoadGroupHandle(HY,info,1)

	if GetTriggerEventId()==EVENT_WIDGET_DEATH or count==76 then
		call SetUnitPathing(u,true)
		call UnitRemoveAbility(u,'A2O4')//A2O4 -> Stampede MS Bonus
		call UnitRemoveAbility(u,'B0GB')//B0GB -> Stampede

		call DestroyEffect(LoadEffectHandle(HY,info,3))
		call DestroyEffect(LoadEffectHandle(HY,info,2))
		call KillGroup(g)

		call FlushChildHashtable(HY,info)
		call CleanTrigger(trig)

		set trig = null
		set u = null
		set g = null
		return false
	endif

	//set tt_unit1=u // I don't know if this is needed :S :Z /( .__.)/ \(.-.)/ \(.__. )\
	//its not, but da comment is too awesome to remove :D

	set group_temp_unit[0] = u
	set group_temp_integer[0] = info
	set group_temp_integer[1] = LoadInteger(HY,info,1)*GetHeroMainStatValue(u)
	call SaveInteger(HY,info,0,count+1)
	call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),175,Condition(function Stampede_Targets))
	
	call KillTrees(GetUnitX(u),GetUnitY(u),150)
	
	set trig = null
	set u = null
	set g = null
	return false
endfunction

function Stampede_Start takes unit u, integer lvl returns nothing
	local trigger trig = CreateTrigger()
	local integer info = GetHandleId(trig)
	local boolean isAgh=GetUnitAbilityLevel(group_temp_unit[0],'A384')>0//A384 -> Stampede
	call SetUnitPathing(u,false)
	call UnitAddAbility2(u,'A2O4')//A2O4 -> Stampede MS Bonus
	call SetUnitAbilityLevel(u,'A2O4',lvl)//A2O4 -> Stampede MS Bonus
	if isAgh then
		call SetUnitAbilityLevel(u,'A2O4',2)//A2O4 -> Stampede MS Bonus
	endif
	call TriggerRegisterTimerEvent(trig,0.05,true)
	call TriggerRegisterDeathEvent(trig,u)
	call TriggerAddCondition(trig,Condition(function Stampede_Duration))
	call SaveUnitHandle(HY,info,0,u)
	call SaveGroupHandle(HY,info,1,GetAvailableGroup())
	call SaveEffectHandle(HY,info,2,AddSpecialEffectTarget("war3mapImported\\SandBreathDamageSmall.mdx",u,GetProperAttachPoint_Foot(u)))
	call SaveEffectHandle(HY,info,3,AddSpecialEffectTarget("war3mapImported\\SandBreathDamageSmall.mdx",u,GetProperAttachPoint_Foot(u)))
	call SaveInteger(HY,info,0,0)
	call SaveInteger(HY,info,1,3)
	set trig = null
endfunction

function Stampede_Allies takes nothing returns boolean
	local unit t = GetFilterUnit()
	local unit u = group_temp_unit[0]
	if (IsUnitType(t,UNIT_TYPE_HERO))!=null and IsUnitAlly(u,GetOwningPlayer(t)) and IsDead(t)==false and (IsRearmPicked(u)==false or LoadInteger(HY,GetHandleId(t),'STMP')!=1) then
		if t!=u then
			call AddTimedKeyToUnit(t,'STMP',45)
		endif
		call Stampede_Start(t,GetUnitAbilityLevel(u,'A2O6')+GetUnitAbilityLevel(u,'A384'))//A2O6 -> Stampede, A384 -> Stampede
	endif
	set t = null
	set u = null
	return false
endfunction

function CentaurAghBonus takes unit u returns nothing
	call HealUnitFor(u,GetEventDamage()*0.6)
endfunction

function Stampede_Cast takes nothing returns nothing
	local sound s = CreateSound("abilities\\Spells\\Other\\Stampede\\StampedeCaster1.wav",false,false,false,10,10,"DefaultEAXON")
	call StartSound(s)
	call KillSoundWhenDone(s)
	set group_temp_unit[0] = GetTriggerUnit()
	set group_temp_integer[0] = GetUnitAbilityLevel(group_temp_unit[0],'A2O6')+GetUnitAbilityLevel(group_temp_unit[0],'A384')//A2O6 -> Stampede, A384 -> Stampede
	call GroupEnumUnitsInRange(temp_group,0,0,99999,Condition(function Stampede_Allies))
	set s = null
endfunction

function Stampede_Init takes nothing returns nothing
	local sound s = CreateSound("abilities\\Spells\\Other\\Stampede\\StampedeCaster1.wav",false,false,false,10,10,"DefaultEAXON")
	call StartSound(s)
	call KillSoundWhenDone(s)
	set s = null
	
endfunction

function Centaur_HoofStompStun takes unit attacker, unit victim returns nothing
	local integer lvl=GetUnitAbilityLevel(attacker,'A3IA')
	if lvl>0 then
		call StunTargetLoD(victim,lvl*0.25+1.75)
	endif
endfunction

function Centaur_HoofStomp takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
	call UnitAddAbility(d,'A3IA')
	call DummyDamageTracking(1)
	call SetUnitAbilityLevel(d,'A3IA',GetUnitAbilityLevel(GetTriggerUnit(),'A00S'))
	call IssueImmediateOrder(d,"stomp")
	call UnitRemoveAbility(d,'A3IA')
	set d=null
endfunction

function Double_Edge_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local unit u = DoubleEdgeCaster

	if IsUnitEnemy(u,GetOwningPlayer(t)) and IsDead(t)==false and IsMagicImmune(t)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false then//
		call DamageTarget(u,t,1,DoubleEdgeDamage)
	endif

	set u = null
	set t = null
	return false
endfunction

function Double_Edge_Start takes unit u, unit t, integer lvl, boolean lotus returns nothing
	local real x = GetWidgetX(t)
	local real y = GetWidgetY(t)
	local group g
	if GetUnitAbilityLevel(t, 'A3E9') == 1 and not lotus and GetUnitAbilityLevel(u,'A04R')==0 then//
		call SaveUnitHandle(TempHash,'A3E9',0,t)
		call SaveUnitHandle(TempHash,'A3E9',1,u)
		call SaveInteger(TempHash,'A3E9',0,lvl)
		call ExecuteFunc("DoubleEdge_LotusOrb")
	endif
	if IsBlocked(t)==false then
		set g=GetAvailableGroup()
		set DoubleEdgeCaster = u
		set DoubleEdgeDamage=100 + lvl*75
		call GroupEnumUnitsInRange(g,x,y,215,Condition(function Double_Edge_Targets))
		call DestroyEffect(AddSpecialEffect("war3mapImported\\DoubleEdgeTarget.mdx",x,y))
		if GetWidgetLife(u)<DoubleEdgeDamage*.75 then
			set DoubleEdgeDamage = R2I(GetWidgetLife(u)/.75) - 10
		endif
		call DamageTarget(u,u,1,DoubleEdgeDamage)
		call KillGroup(g)
	elseif lotus then
		call RemoveLinkenBuff(t)
	endif
endfunction

function Double_Edge_StartWrapper takes nothing returns nothing
	call Double_Edge_Start(GetTriggerUnit(),GetSpellTargetUnit(),GetUnitAbilityLevel(GetTriggerUnit(),'A00L'),false)//A00L -> Double Edge
endfunction

function DoubleEdge_LotusOrb takes nothing returns nothing
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	call Double_Edge_Start(LoadUnitHandle(TempHash,'A3E9',0),LoadUnitHandle(TempHash,'A3E9',1),LoadInteger(TempHash,'A3E9',0),true)
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function Double_Edge_Condtionsup takes nothing returns nothing
	call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\DoubleEdgeCaster.mdx",GetTriggerUnit(),"hand, right"))
endfunction

function Chen_Teleport_End takes nothing returns nothing
	local trigger t = GetTriggeringTrigger()
	local integer h = GetHandleId(t)
	local unit u = LoadUnitHandle(MHT,h,0)
	if GetUnitAbilityLevel(u,'A3KA')==1 then
		call SetUnitX(u,LoadReal(MHT,h,0))
		call SetUnitY(u,LoadReal(MHT,h,1))
	endif
	call UnitRemoveAbility(u,'A3KA')
	call FlushChildHashtable(MHT,h)
	call CleanTrigger(t)
	set t = null
	set u = null
endfunction

function Chen_Teleport_Start takes unit u, real x, real y, integer lvl returns nothing
	local trigger t = CreateTrigger()
	local integer h = GetHandleId(t)
	local integer delay=7-lvl
	call SaveUnitHandle(MHT,h,0,u)
	call UnitAddAbility2(u,'A3KA')
	//call SaveEffectHandle(MHT,h,1,AddSpecialEffectTarget("effects\\Test_of_Faith_FX.mdx",u,"overhead"))
	call SaveReal(MHT,h,0,x)
	call SaveReal(MHT,h,1,y)
	call TriggerRegisterTimerEvent(t,delay,false)
	call TriggerAddCondition(t,Condition(function Chen_Teleport_End))
	set t = null
endfunction

function PRE takes nothing returns boolean
	return IsDead(GetFilterUnit())==false and ((GetUnitAbilityLevel(GetFilterUnit(),'A0KO')==1)or(GetUnitAbilityLevel(GetFilterUnit(),'A0KQ')==1)or(GetUnitAbilityLevel(GetFilterUnit(),'A0KR')==1)or(GetUnitAbilityLevel(GetFilterUnit(),'A0KP')==1))//Aeth -> Ghost, A0KO -> Faith Effect, A0KQ -> Faith Effect, A0KR -> Faith Effect, A0KP -> Faith Effect
endfunction

function ChenSelfCastTest takes nothing returns boolean
	return IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitIdType(GetUnitTypeId(GetFilterUnit()),UNIT_TYPE_HERO)==false//
endfunction

function CreepTPToChenFinal takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit chen=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	else
		call SetUnitPosition(target,GetUnitX(chen)+GetRandomReal(50,100)*Cos(GetRandomReal(0,359)*bj_DEGTORAD),GetUnitY(chen)+GetRandomReal(50,100)*Sin(GetRandomReal(0,359)*bj_DEGTORAD))
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	endif
	set chen=null
	set target=null
	set t=null
	return false
endfunction

function CreepTPToChen takes unit chen, unit target returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer delay=7-GetUnitAbilityLevel(chen,'A0LV')//A0LV -> Test of Faith
	call TriggerRegisterTimerEvent(t,delay,false)
	call TriggerRegisterDeathEvent(t,chen)
	call TriggerRegisterDeathEvent(t,target)
	call TriggerAddCondition(t,Condition(function CreepTPToChenFinal))
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("effects\\Test_of_Faith_FX.mdx",target,"overhead"))
	call SaveUnitHandle(HY,h,0,chen)
	call SaveUnitHandle(HY,h,1,target)
	set t=null
endfunction

function Chen_Teleport_Condition takes nothing returns nothing
	local unit u = GetSpellTargetUnit()
	local unit chen=GetTriggerUnit()
	local player p = GetOwningPlayer(u)
	local integer lvl= GetUnitAbilityLevel(chen,'A2MC')//A2MC -> Test of Faith
	local real x
	local real y
	local group g
	local unit u2
	if IsSentinel(p)then
		set x = GetRectCenterX(gg_rct_Hero_Creation_NE)
		set y = GetRectCenterY(gg_rct_Hero_Creation_NE)
	else
		set x = GetRectCenterX(gg_rct_Hero_Creation_UD)
		set y = GetRectCenterY(gg_rct_Hero_Creation_UD)
	endif
	if IsUnitType(u,UNIT_TYPE_HERO)and p!=GetOwningPlayer(chen)then
		if LoadBoolean(HY,GetHandleId(u),80) then
			call Error(GetOwningPlayer(chen),GetObjectName('n036'))//n036 -> Cannot Teleport a unit casting Grapple
		elseif LoadBoolean(HY,GetHandleId(p),139)==false then
			call Chen_Teleport_Start(u,x,y,lvl)
		else
			call Error(GetOwningPlayer(chen),GetObjectName('n038'))//disable help on
		endif
	elseif u==chen then
		set g=GetAvailableGroup()
		set tt_unit1=chen
		call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(chen),Condition(function ChenSelfCastTest))
		loop
			set u2=FirstOfGroup(g)
			exitwhen u2==null
			call CreepTPToChen(chen,u2)
			//call echo(GetUnitName(u2))
			call GroupRemoveUnit(g,u2)
		endloop
		call KillGroup(g)
	else
		call SetUnitX(u,x)
		call SetUnitY(u,y)
	endif
	set p=null
	set u = null
	set chen=null
endfunction

function Chen_Test_Start takes unit u, unit t returns nothing
	local integer level = GetUnitAbilityLevel(u,'A0LV')//A0LV -> Test of Faith
	local integer damage =0
	if level==4 then
		set damage=GetRandomInt(275,400)
	elseif level==3 then
		set damage=GetRandomInt(225,300)
	elseif level==2 then
		set damage=GetRandomInt(125,200)
	elseif level==1 then
		set damage=GetRandomInt(75,150)
	endif
	call DamageTarget(u,t,3,damage)
	call TextTagOnUnit(I2S(damage),1,t,0.023,255,255,0,216)
endfunction

function Chen_Test_Condition takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call Chen_Test_Start(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1))
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
endfunction

function Chen_TestOfFaith_Wrapper takes nothing returns nothing
	local timer t
	local integer h
	if IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,0,false,function Chen_Test_Condition)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		set t=null
	endif
endfunction

function Chen_Test_Learn takes nothing returns nothing
	local unit u = GetTriggerUnit()
	if GetUnitAbilityLevel(u,'A2MC')==0 then//A2MC -> Test of Faith
		call UnitAddAbility2(u,'A2MC')//A2MC -> Test of Faith
	endif
	call SetUnitAbilityLevel(u,'A2MC',GetUnitAbilityLevel(u,'A0LV'))//A2MC -> Test of Faith, A0LV -> Test of Faith
	set u = null
endfunction

function PME takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer lvl=(LoadInteger(HY,(h),5))
	local real dmg
	local integer hu
	local unit target=LoadUnitHandle(HY,h,0)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED and GetUnitAbilityLevel(target,'B05H')==1 then
		if LoadBoolean(HY,h,0)==false then
			call SaveBoolean(HY,h,0,true)
			set dmg=GetEventDamage()*LoadReal(HY,h,5)
			call DamageTarget(GetEventDamageSource(),target,3,dmg)
//			call echo(R2S(dmg))
			call SaveBoolean(HY,h,0,false)
		endif
	else
		set hu=LoadInteger(HY,h,0)
		call UnitRemoveAbility(target,LoadInteger(HY,h,1))
		call UnitRemoveAbility(target,'B05H')
		//call SaveReal(HY,hu,'AMPL',RMaxIF(LoadReal(HY,hu,'AMPL')-0.1-0.04*lvl,0))
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	endif
	set t=null
	set target=null
endfunction

function Chen_Penitence takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit target=GetSpellTargetUnit()
	local unit chen=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(chen,'A0KM')//A0KM -> Penitence
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl",chen,"chest"))
	call SaveInteger(HY,(h),5,(lvl))
	call TriggerRegisterTimerEvent(t,7,false)
	call TriggerRegisterDeathEvent(t,target)
	call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
	call SaveInteger(HY,h,0,GetHandleId(target))
	call SaveUnitHandle(HY,h,0,target)
	call UnitAddAbility2(target,'A3QU'-1+lvl)
	call SaveInteger(HY,h,1,'A3QU'-1+lvl)
	call SaveReal(HY,h,5,0.1+0.05*lvl)
	//call SaveReal(HY,GetHandleId(target),'AMPL',LoadReal(HY,GetHandleId(target),'AMPL')+0.1+0.04*lvl)
	call TriggerAddCondition(t,Condition(function PME))
	set t=null
	set target=null
	set chen=null
endfunction

function Chen_AncientFilter takes nothing returns boolean
	return PRE() and IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)
endfunction

function Chen_GetOldestCreep takes group g returns unit
	local unit u
	local real oldest=99999.
	set tt_unit1=null
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if LoadReal(HY,GetHandleId(u),'0age')<oldest then
			set tt_unit1=u
			set oldest=LoadReal(HY,GetHandleId(u),'0age')
		endif
		call GroupRemoveUnit(g,u)
	endloop
	set u=null
	return tt_unit1
endfunction

function Chen_CreepSteal takes unit target returns nothing
	local unit chen=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(chen,'A28T')+GetUnitAbilityLevel(chen,'A361')//A28T -> Holy Persuasion, A361 -> Holy Persuasion
	local integer limit=lvl
	local integer i
	local integer anc
	local group g=GetAvailableGroup()
	local integer anclimit
	if IsUnitType(target,UNIT_TYPE_ANCIENT) then
		call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(chen),Condition(function Chen_AncientFilter))
		set anc=CountUnitsInGroup(g)
		set anclimit=IMinIF(R2I((GetUnitLevel(chen)-1)/5),3)
		if anc >= anclimit then
			call KillUnit(Chen_GetOldestCreep(g))
		endif
	endif
	call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(chen),Condition(function PRE))
	set i=CountUnitsInGroup(g)
//	call echo(I2S(i))
	if i==limit then
		call KillUnit(Chen_GetOldestCreep(g))
	endif
	call KillGroup(g)
	set g=null
	if IsSentinel(GetOwningPlayer(chen)) then
		call UnitShareVision(target,Scourges[0],false)
		call UnitShareVision(target,Scourges[1],false)
		call UnitShareVision(target,Scourges[2],false)
		call UnitShareVision(target,Scourges[3],false)
		call UnitShareVision(target,Scourges[4],false)
		call UnitShareVision(target,Scourges[5],false)
	else
		call UnitShareVision(target,Sentinels[0],false)
		call UnitShareVision(target,Sentinels[1],false)
		call UnitShareVision(target,Sentinels[2],false)
		call UnitShareVision(target,Sentinels[3],false)
		call UnitShareVision(target,Sentinels[4],false)
		call UnitShareVision(target,Sentinels[5],false)
	endif
	call UnitRefillMana(target)
	
	call UnitAddAbility2(target,'A0KO')//A0KO -> Faith Effect
	if GetUnitState(target,UNIT_STATE_MAX_LIFE) < 600+100*lvl then
		call AddMaxHPFx(target,R2I(600+100*lvl - GetUnitState(target,UNIT_STATE_MAX_LIFE)))
	endif
	call SaveReal(HY,GetHandleId(target),'0age',TimerGetElapsed(GlobalTimer))
	call UnitAddAbility2(target,'A12G')//A12G -> Marker - Dispellable
	set i=GetUnitAbilityLevel(chen,'A0A8')
	if i>0 then
		call SetUnitMoveSpeed(target,GetUnitDefaultMoveSpeed(target)+20+10*i)
	endif
	set chen=null
endfunction

function PWE takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local unit Caster
	if IsUnitEnemy(Target,GetOwningPlayer(Source))then
		set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
		call UnitAddAbility(Caster,'A069')//A069 -> Holy Persuasion
		//call SetUnitAbilityLevel(Caster,'A069',GetUnitAbilityLevel(Source,'A28T'))//A069 -> Holy Persuasion, A28T -> Holy Persuasion
		call IssueTargetOrderById(Caster,852581,Target)
		call Chen_CreepSteal(Target)
	endif
	set Source=null
	set Target=null
	set Caster=null
endfunction

function Chen_HolyPersuation takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call PWE()
	endif
endfunction

function Chen_HolyPersuation_OnCast takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	if IsUnitEnemy(target,GetOwningPlayer(caster)) then
		if IsUnitType(target,UNIT_TYPE_HERO) or IsUnitIllusion(target) or IsUnitSpiritBear(target) then
			call InterruptUnit(caster)
			call Error(GetOwningPlayer(caster),GetObjectName('n0K9'))//n0K9 -> Invalid Target
		elseif IsUnitType(target,UNIT_TYPE_ANCIENT) and GetSpellAbilityId()!='A361' then//A361 -> Holy Persuasion
			call InterruptUnit(caster)
			call Error(GetOwningPlayer(caster),"Can persuate ancient creeps only when Aghanim scepter acquired!")
		endif
	endif
	set caster=null
	set target=null
endfunction

function PAE takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and GetWidgetLife(GetFilterUnit())>1)!=null
endfunction

function Chen_HandOfGod takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A0LT')//A0LT -> Hand of God
	local group g=GetAvailableGroup()
	local unit u2
	local boolean b=false
	if lvl==0 then
		set lvl=GetUnitAbilityLevel(u,'A1CS')//A1CS -> Hand of God upgraded
		set b=true
	endif
	call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function PAE))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		if(IsUnitAlly(u2,GetOwningPlayer(u)))then
			if IsUnitHPFreezed(u2)==false then
				if b then
					call SetWidgetLife(u2,GetWidgetLife(u2)+0.1*GetUnitState(u2,UNIT_STATE_MAX_LIFE))
				endif
				call SetWidgetLife(u2,GetWidgetLife(u2)+100+100*lvl)
			endif
			call DestroyEffect(AddSpecialEffectTargetUnitBJ("chest",u2,"Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl"))
		endif
		call GroupRemoveUnit(g,u2)
	endloop
	call KillGroup(g)
	set g=GetAvailableGroup()
	set bj_groupEnumOwningPlayer=GetOwningPlayer(u)
	call GroupEnumUnitsInRect(g,GetWorldBounds(),filterGetUnitsInRectOfPlayer)
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		if(IsUnitType(u2,UNIT_TYPE_HERO)==false and GetUnitTypeId(u2)!='n00C')then//n00C -> Zone Indicator
			call SetWidgetLife(u2,99999999)
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl",u2,"chest"))
		endif
		call GroupRemoveUnit(g,u2)
	endloop
	call KillGroup(g)
	set g=null
	set u=null
	set u2=null
endfunction

function PCE takes nothing returns nothing
	if IsCourier(GetEnumUnit())==false then
		call DamageTarget(E98,GetEnumUnit(),1,E88)
	endif
endfunction

function P3E takes unit Source,real x,real y, integer Level returns nothing
	local real x1
	local real y1
	local group g=GetAvailableGroup()
	local real Damage=40+40*Level
	set tt_unit1=Source
	set E98=Source
	set E88=Damage
	call GroupEnumUnitsInRange(g,x,y,600,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(g,function PCE)
	call KillGroup(g)
	set x1=x
	set y1=y
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x1,y1))
	set x1=x+200
	set y1=y+200
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x1,y1))
	set x1=x+200
	set y1=y-200
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x1,y1))
	set x1=x-200
	set y1=y+200
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x1,y1))
	set x1=x-200
	set y1=y-200
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x1,y1))
	call TimedReveal(GetOwningPlayer(Source),10,x,y,600)
	set g=null
endfunction

function P6E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero
	local unit Projectile=LoadUnitHandle(HY,h,45)
	local real TargetX=LoadReal(HY,h,47)
	local real TargetY=LoadReal(HY,h,48)
	local real a=LoadReal(HY,h,13)
	local real SourceX=LoadReal(HY,h,189)
	local real SourceY=LoadReal(HY,h,190)
	local real AO8=SafeX50(SourceX+44*Cos(a))
	local real AP8=SafeY50(SourceY+44*Sin(a))
	local real PLE
	local real P1E
	local integer lvl=LoadInteger(HY,h,0)
	call SetUnitX(Projectile,AO8)
	call SetUnitY(Projectile,AP8)
	call SaveReal(HY,h,189,AO8*1.)
	call SaveReal(HY,h,190,AP8*1.)
	if DistanceBetweenXY(TargetX,TargetY,AO8,AP8)<=35 then
		call KillUnit(Projectile)
		set Hero=LoadUnitHandle(HY,h,14)
		call P3E(Hero,AO8,AP8,lvl)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Hero=null
	set Projectile=null
	return false
endfunction

function Clockwerk_RocketFlare takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real SourceX=SafeX50(GetUnitX(Hero))
	local real SourceY=SafeY50(GetUnitY(Hero))
	local real TargetX=SafeX50(GetSpellTargetX())
	local real TargetY=SafeY50(GetSpellTargetY())
	local real a=Atan2(TargetY-SourceY,TargetX-SourceX)
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=CreateUnit(GetOwningPlayer(Hero),'h03Y',SourceX,SourceY,a*bj_RADTODEG)//h03Y -> Rocket Flare
	call SetUnitFacing(Projectile,a*bj_RADTODEG)
	call SetUnitPathing(Projectile,false)
	call UnitAddAbility2(Projectile,'Aloc')//Aloc -> Locust
	call ShowUnit(Projectile,false)
	call UnitRemoveAbility(Projectile,'Aloc')//Aloc -> Locust
	call ShowUnit(Projectile,true)
	call SaveReal(HY,h,191,SourceX*1.)
	call SaveReal(HY,h,192,SourceY*1.)
	call SaveReal(HY,h,189,SourceX*1.)
	call SaveReal(HY,h,190,SourceY*1.)
	call SaveReal(HY,h,47,TargetX*1.)
	call SaveReal(HY,h,48,TargetY*1.)
	call SaveReal(HY,h,13,a*1.)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveUnitHandle(HY,h,45,Projectile)
	call TriggerRegisterTimerEvent(t,.025,true)
	call TriggerAddCondition(t,Condition(function P6E))
	set Hero=null
	set t=null
	set Projectile=null
endfunction

function P2E takes real s,real d1,real d2,real d3 returns boolean
	return s<=d1 and s<=d2 and s<=d3
endfunction

function Q4E takes unit u,real x,real y,real d returns real
	local real x2=GetUnitX(u)
	local real y2=GetUnitY(u)
	local real Q7E=DistanceBetweenXY(x-d,y,x2,y2)
	local real Q8E=DistanceBetweenXY(x+d,y,x2,y2)
	local real Q9E=DistanceBetweenXY(x,y+d,x2,y2)
	local real QDE=DistanceBetweenXY(x,y-d,x2,y2)
	if P2E(Q7E,Q8E,QDE,Q9E)then
		return 180.
	elseif P2E(Q8E,Q7E,QDE,Q9E)then
		return .0
	elseif P2E(QDE,Q8E,Q7E,Q9E)then
		return 270.
	endif
	return 90.
endfunction

function QEE takes real s,real d1,real d2,real d3,real d4,real d5,real d6,real d7 returns boolean
	return s<=d1 and s<=d2 and s<=d3 and s<=d4 and s<=d5 and s<=d6 and s<=d7
endfunction

function QFE takes unit u,integer h returns unit
	local real x1=GetUnitX(u)
	local real y1=GetUnitY(u)
	local unit QGE=(LoadUnitHandle(HY,h,(1100+1)))
	local unit QHE=(LoadUnitHandle(HY,h,(1100+2)))
	local unit QIE=(LoadUnitHandle(HY,h,(1100+3)))
	local unit QJE=(LoadUnitHandle(HY,h,(1100+4)))
	local unit QKE=(LoadUnitHandle(HY,h,(1100+5)))
	local unit QME=(LoadUnitHandle(HY,h,(1100+6)))
	local unit QNE=(LoadUnitHandle(HY,h,(1100+7)))
	local unit QOE=(LoadUnitHandle(HY,h,(1100+8)))
	local real d1=DistanceBetweenXY(x1,y1,GetUnitX(QGE),GetUnitY(QGE))
	local real d2=DistanceBetweenXY(x1,y1,GetUnitX(QHE),GetUnitY(QHE))
	local real d3=DistanceBetweenXY(x1,y1,GetUnitX(QIE),GetUnitY(QIE))
	local real d4=DistanceBetweenXY(x1,y1,GetUnitX(QJE),GetUnitY(QJE))
	local real d5=DistanceBetweenXY(x1,y1,GetUnitX(QKE),GetUnitY(QKE))
	local real d6=DistanceBetweenXY(x1,y1,GetUnitX(QME),GetUnitY(QME))
	local real d7=DistanceBetweenXY(x1,y1,GetUnitX(QNE),GetUnitY(QNE))
	local real d8=DistanceBetweenXY(x1,y1,GetUnitX(QOE),GetUnitY(QOE))
	
	if QEE(d1,d2,d3,d4,d5,d6,d7,d8)then
		set QHE=null
		set QIE=null
		set QJE=null
		set QKE=null
		set QME=null
		set QNE=null
		set QOE=null
		return QGE
	elseif QEE(d2,d1,d3,d4,d5,d6,d7,d8)then
		set QGE=null
		set QIE=null
		set QJE=null
		set QKE=null
		set QME=null
		set QNE=null
		set QOE=null
		return QHE
	elseif QEE(d3,d2,d1,d4,d5,d6,d7,d8)then
		set QGE=null
		set QHE=null
		set QJE=null
		set QKE=null
		set QME=null
		set QNE=null
		set QOE=null
		return QIE
	elseif QEE(d4,d2,d3,d1,d5,d6,d7,d8)then
		set QGE=null
		set QHE=null
		set QIE=null
		set QKE=null
		set QME=null
		set QNE=null
		set QOE=null
		return QJE
	elseif QEE(d5,d2,d3,d4,d1,d6,d7,d8)then
		set QGE=null
		set QHE=null
		set QIE=null
		set QJE=null
		set QME=null
		set QNE=null
		set QOE=null
		return QKE
	elseif QEE(d6,d2,d3,d4,d5,d1,d7,d8)then
		set QGE=null
		set QHE=null
		set QIE=null
		set QJE=null
		set QKE=null
		set QNE=null
		set QOE=null
		return QME
	elseif QEE(d7,d2,d3,d4,d5,d6,d1,d8)then
		set QGE=null
		set QHE=null
		set QIE=null
		set QJE=null
		set QKE=null
		set QME=null
		set QOE=null
		return QNE
	elseif QEE(d8,d2,d3,d4,d5,d6,d7,d1)then
		set QGE=null
		set QHE=null
		set QIE=null
		set QJE=null
		set QKE=null
		set QME=null
		set QNE=null
		return QOE
	endif
	return null
endfunction

function QPE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real a=(LoadReal(HY,h,13))
	local real x=GetUnitX(Target)
	local real y=GetUnitY(Target)
	local real QQE=7.5
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=(LoadInteger(HY,h,5))
	local integer QRE=40+40*Level
	if GetTriggerEvalCount(t)>34 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SaveInteger(HY,(GetHandleId((Target))),(4260),2)
		call DamageTarget(Source,Target,1,QRE)
		call SetUnitState(Target,UNIT_STATE_MANA,RMaxIF(GetUnitState(Target,UNIT_STATE_MANA)-QRE,0))
	else
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",x,y))
		call KillTrees(x,y,150)
		if((LoadInteger(HY,(GetHandleId((Target))),(4261)))==1)==false then
			call SetUnitPosition(Target,x+QQE*Cos(a*bj_DEGTORAD),y+QQE*Sin(a*bj_DEGTORAD))
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function QSE takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Target=GetEnumUnit()
	local real x=tt_real1
	local real y=TJ
	local real d=RJ
	local real a=Q4E(Target,x,y,d)
	local real x2 = GetWidgetX(Target)
	local real y2 = GetWidgetY(Target)
	local real d2 = d - SquareRoot((x-x2)*(x-x2)+(y-y2)*(y-y2)) + 100
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",Target,"chest"))
	call SaveInteger(HY,(GetHandleId((Target))),(4260),1)
	if d2 > 0 then
		call SetUnitX(Target,x2 + d2*Cos(a*bj_DEGTORAD))
		call SetUnitY(Target,y2 + d2*Sin(a*bj_DEGTORAD))
	endif
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveInteger(HY,h,5,(tt_int1))
	call SaveUnitHandle(HY,h,2,(tt_unit1))
	call TriggerRegisterTimerEvent(t,.025,true)
	call TriggerAddCondition(t,Condition(function QPE))
	set t=null
	set Target=null
endfunction

function QTE takes unit u,integer h returns boolean
	local unit QUE=QFE(u,h)
	local boolean result=true
	if IsDead(QUE)or(LoadInteger(HY,(GetHandleId(QUE)),156))==1 then
		set result=false
	endif
	call SaveInteger(HY,(GetHandleId(QUE)),156,1)
	call SetUnitVertexColor(QUE,25,25,25,175)
	set QUE=null
	return result
endfunction

function QVE takes nothing returns nothing
	if GetUnitState(GetEnumUnit(),UNIT_STATE_MANA)>0 and IsUnitInGroup(GetEnumUnit(),DK)==false and((LoadInteger(HY,GetHandleId(GetEnumUnit()),4260))==1)==false and QTE(GetEnumUnit(),ED8) then
		call SaveInteger(HY,GetHandleId(GetEnumUnit()),4260,1)
		call GroupAddUnit(EK,GetEnumUnit())
	endif
endfunction

function QWE takes trigger t,unit Hero,real x,real y,real d,integer Level returns nothing
	local integer h=GetHandleId(t)
	local real QXE=200
	local rect r1=Rect(x-d,y-d,x+d,y+d)
	local rect r2=Rect(x-d-QXE,y-d-QXE,x+d+QXE,y+d+QXE)
	local group g1=GetAvailableGroup()
	local group g2=GetAvailableGroup()
	local group g3=GetAvailableGroup()
	set tt_unit1=Hero
	call GroupEnumUnitsInRect(g1,r1,Condition(function NonImmuneEnemyFilter))
	call GroupEnumUnitsInRect(g2,r2,Condition(function NonImmuneEnemyFilter))
	set DK=g1
	set EK=g3
	set tt_real1=x
	set TJ=y
	set RJ=d
	set ED8=h
	call ForGroup(g2,function QVE)
	set tt_int1=Level
	call ForGroup(g3,function QSE)
	call KillGroup(g1)
	call KillGroup(g2)
	call KillGroup(g3)
	call RemoveRect(r1)
	call RemoveRect(r2)
	set g1=null
	set g2=null
	set g3=null
	set r1=null
	set r2=null
endfunction

function QYE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local player p=(LoadPlayerHandle(HY,h,54))
	local boolean QZE=(LoadBoolean(HY,h,155))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	if QZE then
		call TimedReveal(p,.2,x,y,500)
	endif
	set t=null
	set p=null
	return false
endfunction

function QAE takes unit QBE returns nothing
	local real x=GetUnitX(QBE)
	local real y=GetUnitY(QBE)
	local player p=GetOwningPlayer(QBE)
	local unit Caster=CreateUnit(p,'u00W',x,y,0)//u00W -> Power Cog Effect
	call KillUnit(Caster)
	set p=null
	set Caster=null
endfunction

function QCE takes integer h,real x,real y,boolean QZE,player p returns nothing
	local unit QGE=(LoadUnitHandle(HY,h,(1100+1)))
	local unit QHE=(LoadUnitHandle(HY,h,(1100+2)))
	local unit QIE=(LoadUnitHandle(HY,h,(1100+3)))
	local unit QJE=(LoadUnitHandle(HY,h,(1100+4)))
	local unit QKE=(LoadUnitHandle(HY,h,(1100+5)))
	local unit QME=(LoadUnitHandle(HY,h,(1100+6)))
	local unit QNE=(LoadUnitHandle(HY,h,(1100+7)))
	local unit QOE=(LoadUnitHandle(HY,h,(1100+8)))
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.1,false)
	call TriggerAddCondition(t,Condition(function QYE))
	call SaveReal(HY,(GetHandleId(t)),6,((x)*1.))
	call SaveReal(HY,(GetHandleId(t)),7,((y)*1.))
	call SavePlayerHandle(HY,(GetHandleId(t)),54,(p))
	call SaveBoolean(HY,(GetHandleId(t)),155,(QZE))
	call QAE(QGE)
	call RemoveUnit(QGE)
	call QAE(QHE)
	call RemoveUnit(QHE)
	call QAE(QIE)
	call RemoveUnit(QIE)
	call QAE(QJE)
	call RemoveUnit(QJE)
	call QAE(QKE)
	call RemoveUnit(QKE)
	call QAE(QME)
	call RemoveUnit(QME)
	call QAE(QNE)
	call RemoveUnit(QNE)
	call QAE(QOE)
	call RemoveUnit(QOE)
	set t=null
	set QGE=null
	set QHE=null
	set QIE=null
	set QJE=null
	set QKE=null
	set QME=null
	set QNE=null
	set QOE=null
endfunction

function Q3E takes unit QBE,integer h,integer ZG8,player p returns nothing
	if IsUnitVisibleLoD(QBE,p)then
		call SaveBoolean(HY,h,155,(true))
	endif
	call SaveUnitHandle(HY,h,(1100+ZG8),(QBE))
endfunction

function Q6E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real DP9=(LoadReal(HY,h,57))
	local integer Count=GetTriggerEvalCount(t)
	if Count>R2I(DP9*10)then
		call QCE(h,(LoadReal(HY,h,6)),(LoadReal(HY,h,7)),(LoadBoolean(HY,h,155)),(LoadPlayerHandle(HY,h,154)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call QWE(t,(LoadUnitHandle(HY,h,14)),(LoadReal(HY,h,6)),(LoadReal(HY,h,7)),(LoadReal(HY,h,138)),(LoadInteger(HY,h,5)))
	endif
	set t=null
	return false
endfunction

function QLE takes nothing returns nothing
	call SetUnitX(GetEnumUnit(),GetUnitX(tt_unit1))
	call SetUnitY(GetEnumUnit(),GetUnitY(tt_unit1))
endfunction

function Clockwerk_PowerCogs_Action takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer Level=GetUnitAbilityLevel(Hero,'A0Z5')//A0Z5 -> Power Cog
	local integer ID='u00S'//u00S -> Power Cog
	local real x1=R2I(GetUnitX(Hero))-ModuloInteger(R2I(GetUnitX(Hero)),64)
	local real y1=R2I(GetUnitY(Hero))-ModuloInteger(R2I(GetUnitY(Hero)),64)
	local real x2
	local real y2
	local real d=128
	local unit QBE
	local real DP9=4+Level
	local real BufferDuration=5
	local group g
	local rect Q0E
	local player AXD
	local real life=3
	if Level<4 then
		set life=2
	endif
	if IsSentinel(GetOwningPlayer(Hero))then
		set AXD=Scourges[0]
	else
		set AXD=Sentinels[0]
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call SaveBoolean(HY,h,155,(false))
	set g=GetAvailableGroup()
	set d=d+110
	set Q0E=Rect(x1-d,y1-d,x1+d,y1+d)
	set d=d-110
	set tt_unit1=Hero
	call GroupEnumUnitsInRect(g,Q0E,Condition(function DE9))
	set x2=x1+d
	set y2=y1
	set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
	call SetWidgetLife(QBE,life)
	call SetUnitPosition(QBE,x2,y2)
	call Q3E(QBE,h,1,AXD)
	set x2=x1+d
	set y2=y1+d
	set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
	call SetUnitPosition(QBE,x2,y2)
	call SetWidgetLife(QBE,life)
	call Q3E(QBE,h,2,AXD)
	set x2=x1
	set y2=y1+d
	set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
	call SetUnitPosition(QBE,x2,y2)
	call SetWidgetLife(QBE,life)
	call Q3E(QBE,h,3,AXD)
	set x2=x1-d
	set y2=y1+d
	set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
	call SetUnitPosition(QBE,x2,y2)
	call SetWidgetLife(QBE,life)
	call Q3E(QBE,h,4,AXD)
	set x2=x1-d
	set y2=y1
	set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
	call SetUnitPosition(QBE,x2,y2)
	call SetWidgetLife(QBE,life)
	call Q3E(QBE,h,5,AXD)
	set x2=x1-d
	set y2=y1-d
	set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
	call SetUnitPosition(QBE,x2,y2)
	call SetWidgetLife(QBE,life)
	call Q3E(QBE,h,6,AXD)
	set x2=x1
	set y2=y1-d
	set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
	call SetUnitPosition(QBE,x2,y2)
	call SetWidgetLife(QBE,life)
	call Q3E(QBE,h,7,AXD)
	set x2=x1+d
	set y2=y1-d
	set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
	call SetUnitPosition(QBE,x2,y2)
	call SetWidgetLife(QBE,life)
	call Q3E(QBE,h,8,AXD)
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddCondition(t,Condition(function Q6E))
	call SaveReal(HY,h,57,((DP9)*1.))
	call SaveReal(HY,h,6,((x1)*1.))
	call SaveReal(HY,h,7,((y1)*1.))
	call SaveReal(HY,h,138,((d)*1.))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveInteger(HY,h,5,(Level))
	call SavePlayerHandle(HY,h,154,(AXD))

	call ForGroup(g,function QLE)
	call KillGroup(g)
	set t=null
	set g=null
	set Hero=null
	set QBE=null
	set Q0E=null
	set AXD=null
	return false
endfunction

function Clockwerk_PowerCogs_Start takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	call TriggerRegisterTimerEvent(t,.1,false)
	call TriggerAddCondition(t,Condition(function Clockwerk_PowerCogs_Action))
	call SaveUnitHandle(HY,h,14,(Hero))
	set t=null
	set Hero=null
endfunction

function R4E takes unit Source,unit Target returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	local integer Level=GetUnitAbilityLevel(Source,'A0Z8')//A0Z8 -> Hookshot
	if Level==0 then
		set Level=GetUnitAbilityLevel(Source,'A1CV')//A1CV -> Hookshot Upgrade
	endif
	call UnitAddAbility2(Caster,'A0Z9')//A0Z9 -> Hookshot Stun
	call SetUnitAbilityLevel(Caster,'A0Z9',Level)//A0Z9 -> Hookshot Stun
	call IssueTargetOrderById(Caster,852095,Target)
	set Caster=null
endfunction

function R7E takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),DK)==false then
		call GroupAddUnit(DK,GetEnumUnit())
		call R4E(tt_unit1,GetEnumUnit())
	endif
endfunction

function R8E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer R9E=LoadInteger(HY,h,18)
	local integer Count=GetTriggerEvalCount(t)
	local unit RDE
	local group REE=LoadGroupHandle(HY,h,16)
	local group g
	local real RFE=200
	if Target==null then
		set RDE=LoadUnitHandle(HY,h,700+R9E+1-Count)
		call RemoveUnit(RDE)
	else
		set RDE=LoadUnitHandle(HY,h,700+Count)
		if IsUnitType(Hero,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(Hero),99,true)
		endif
		call SetUnitX(Hero,GetUnitX(RDE))
		call SetUnitY(Hero,GetUnitY(RDE))
		call RemoveUnit(RDE)
		if Count==R9E then
			set RFE=225
		endif
		set g=GetAvailableGroup()
		set tt_unit1=Hero
		set DK=REE
		call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),RFE,Condition(function LW8))
		call ForGroup(g,function R7E)
		call KillGroup(g)
	endif
	if Count==(R9E)then
		if Target!=null then
			call PauseUnit(Target,false)
		endif
		call KillTrees(GetUnitX(Hero),GetUnitY(Hero),100)
		call KillGroup(REE)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Hero=null
	set Target=null
	set RDE=null
	set REE=null
	set g=null
	return false
endfunction

function RGE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real a=LoadReal(HY,h,13)
	local integer RHE=LoadInteger(HY,h,12)
	local integer Count=GetTriggerEvalCount(t)
	local real x=GetUnitX(Hero)+Count*50*Cos(a*bj_DEGTORAD)
	local real y=GetUnitY(Hero)+Count*50*Sin(a*bj_DEGTORAD)
	local boolean RIE=LoadBoolean(HY,h,15)
	local unit RJE
	local integer lvl=LoadInteger(HY,h,0)
	local trigger RKE=LoadTriggerHandle(HY,h,11)
	local integer RME=GetHandleId(RKE)
	local group g=GetAvailableGroup()
	local unit Target=null
	local integer ID='u00V'//u00V -> Hookshot Link
	local real RFE=125
	if Count==1 then
		set RFE=100
	endif
	set tt_unit1=Hero
	call GroupEnumUnitsInRange(g,x,y,RFE,Condition(function LO8))
	call GroupRemoveUnit(g,Hero)
	set Target=GroupPickRandomUnit(g)
	call KillGroup(g)
	if Target!=null or Count==RHE or Count==(RHE-1)or Count==(RHE-2)then
		set ID='u00U'//u00U -> Hookshot Head
	endif
	set RJE=CreateUnit(GetOwningPlayer(Hero),ID,x,y,a)
	call SaveUnitHandle(HY,RME,700+Count,RJE)
	if Target!=null then
		if GetOwningPlayer(Target)==Neutrals or LoadInteger(HY,GetHandleId(Target),4259)==1 then
			set Target=null
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if Target!=null and IsUnitAlly(Target,GetOwningPlayer(Hero))==false then
			call PauseUnit(Target,true)
		endif
		call TriggerRegisterTimerEvent(RKE,.5/ RHE,true)
		call TriggerAddCondition(RKE,Condition(function R8E))
		call SaveInteger(HY,RME,18,Count)
		call SaveInteger(HY,RME,0,lvl)
		call SaveUnitHandle(HY,RME,17,Target)
		call SaveUnitHandle(HY,RME,14,Hero)
		call SaveGroupHandle(HY,RME,16,GetAvailableGroup())
	elseif Count>RHE then
		set Target=null
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call TriggerRegisterTimerEvent(RKE,.5/ RHE,true)
		call TriggerAddCondition(RKE,Condition(function R8E))
		call SaveInteger(HY,RME,18,Count)
		call SaveInteger(HY,RME,0,lvl)
		call SaveUnitHandle(HY,RME,17,Target)
		call SaveUnitHandle(HY,RME,14,Hero)
		call SaveGroupHandle(HY,RME,16,GetAvailableGroup())
	endif
	set t=null
	set Hero=null
	set RJE=null
	set RKE=null
	set g=null
	set Target=null
	return false
endfunction

function Clockwerk_Hookshot takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local real a=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetSpellTargetX(),GetSpellTargetY())
	local integer Level=GetUnitAbilityLevel(Hero,'A0Z8')//A0Z8 -> Hookshot
	local integer ROE
	local integer RHE
	local boolean RIE=false
	local trigger RPE=CreateTrigger()
	if Level==0 then
		set Level=GetUnitAbilityLevel(Hero,'A1CV')//A1CV -> Hookshot Upgrade
		set RIE=true
	endif
	set ROE=1500+500*Level
	set RHE=ROE/ 50
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveInteger(HY,h,5,Level)
	call SaveReal(HY,h,13,a*1.)
	call SaveInteger(HY,h,12,RHE)
	call SaveTriggerHandle(HY,h,11,RPE)
	call SaveBoolean(HY,h,15,RIE)
	call TriggerRegisterTimerEvent(t,.5/ RHE,true)
	call TriggerAddCondition(t,Condition(function RGE))
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
	set t=null
	set Hero=null
	set RPE=null
endfunction

function Clock_BatteryAssaultFilter takes nothing returns boolean
	return NonImmuneEnemyFilter() and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))
endfunction

function RRE takes unit Source, integer Level returns nothing
	local group g=GetAvailableGroup()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local unit Target
	local unit Caster
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,300,Condition(function Clock_BatteryAssaultFilter))
	set Target=GroupPickRandomUnit(g)
	call KillGroup(g)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",Source,"origin"))
	if Target!=null then
		set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)//e00E -> Spellcaster
		call UnitAddAbility2(Caster,'A0Z7')//A0Z7 -> Battery Assault
		call SetUnitAbilityLevel(Caster,'A0Z7',Level)//A0Z7 -> Battery Assault
		call IssueTargetOrderById(Caster,852095,Target)
	set Caster=null
	endif
	set Target=null
endfunction

function RSE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=GetTriggerEvalCount(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	if Count>14 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call RRE(Hero,LoadInteger(HY,h,0))
	endif
	set t=null
	set Hero=null
	return false
endfunction

function Clockwerk_BatteryAssault takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	call TriggerRegisterTimerEvent(t,.7,true)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerAddCondition(t,Condition(function RSE))
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
	call TriggerEvaluate(t)
	set t=null
	set Hero=null
endfunction

function RVE takes nothing returns nothing
	call DamageTarget(EE8,GetEnumUnit(),1,EF8)
endfunction

function RWE takes unit Source,real x,real y,integer Level, boolean isUpgraded returns nothing
	local group g=GetAvailableGroup()
	set EF8=20+50*Level
	
	if isUpgraded then
		set EF8=EF8+50
//		if Level==1 then
//			set EF8=120
//		elseif Level==2 then
//			set EF8=170
//		elseif Level==3 then
//			set EF8=220
//		endif
//	else
//		if Level==1 then
//			set EF8=70
//		elseif Level==2 then
//			set EF8=120
//		elseif Level==3 then
//			set EF8=170
//		endif
	endif
//	call echo(B2S(isUpgraded)+" "+I2S(Level)+" "+I2S(EF8))
	set EE8=Source
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,275,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	call ForGroup(g,function RVE)
	call KillGroup(g)
	set g=null
endfunction

function RYE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer Level=(LoadInteger(HY,h,5))
	local integer c=GetTriggerEvalCount(t)
	local integer RZE=ModuloInteger(c,4)+1
	local real a
	local real d
	local real x
	local real y
	local group g//=GetAvailableGroup()
	set tt_unit1=Hero
	if RZE==1 then
		set a=GetRandomReal(0,90)
	elseif RZE==2 then
		set a=GetRandomReal(90,180)
	elseif RZE==3 then
		set a=GetRandomReal(180,270)
	else
		set a=GetRandomReal(270,360)
	endif
	set d=GetRandomReal(140,710)
	if c > 150 or GetUnitAbilityLevel(Hero,'A03R')+GetUnitAbilityLevel(Hero,'A0AV')==0 or (GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and(GetSpellAbilityId()=='A03R' or GetSpellAbilityId()=='A0AV'))then
		//A03R -> Freezing Field, A0AV -> Freezing Field
		if GetSpellAbilityId()=='A0AV' and LoadBoolean(HY,h,0)==false then//A0AV -> Freezing Field
			call UnitRemoveAbility(Hero,'A0ST')//A0ST -> Magic Immunity Container
			call DestroyEffect(LoadEffectHandle(HY,h,0))
		endif
		call UnitRemoveAbility(Hero,'A347')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call StopSound(AC,false,true)
	else
		if LoadBoolean(HY,h,0)==false and (R2I(2/LoadReal(HY,h,5))<GetTriggerEvalCount(t))then
			call UnitRemoveAbility(Hero,'A0ST')//A0ST -> Magic Immunity Container
			call UnitRemoveAbility(Hero,'A347')
			call DestroyEffect(LoadEffectHandle(HY,h,0))
			call SaveBoolean(HY,h,0,true)
		endif
		set x=GetUnitX(Hero)+d*Cos(a*bj_DEGTORAD)
		set y=GetUnitY(Hero)+d*Sin(a*bj_DEGTORAD)
		call DestroyEffect(AddSpecialEffect("effects\\SnowyBlizzardTarget.mdx",x,y))
		call RWE(Hero,x,y,Level,LoadBoolean(HY,h,2))
	endif
	set t=null
	set Hero=null
	set g=null
	return false
endfunction

function CM_FreezingField takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level
	local real r=0.07
	call PlaySoundAtPos(AC,GetUnitX(Hero),GetUnitY(Hero))
	call UnitAddAbility(Hero,'A347')
	if GetSpellAbilityId()=='A03R' then//A03R -> Freezing Field
		set Level=GetUnitAbilityLevel(Hero,'A03R')//A03R -> Freezing Field
		call SaveBoolean(HY,h,2,false)
	else
		call SetUnitAbilityLevel(Hero,'A347',2)
		call SaveBoolean(HY,h,2,true)
		set Level=GetUnitAbilityLevel(Hero,'A0AV')//A0AV -> Freezing Field
		call UnitAddAbility2(Hero,'A0ST')//mag immune cont//A0ST -> Magic Immunity Container
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl",Hero,"origin"))
		call SaveEffectHandle(HY,h,0,AddSpecialEffectTarget("Abilities\\Spells\\Human\\DivineShield\\DivineShieldTarget.mdl",Hero,"origin"))
		call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A0ST',false)//A0ST -> Magic Immunity Container
	endif
	call TriggerRegisterTimerEvent(t,r,true)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function RYE))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,5,r)
	set t=null
	set Hero=null
endfunction

function BrillianceAuraSelf takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer lvl=LoadInteger(HY,h,0)
	if GetHandleId(u)>0 then
		if GetWidgetLife(u)>1 then
			call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+lvl*0.1+0.1)
		endif
	else
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	
	set t=null
	set u=null
endfunction

function Maiden_Brilliance_Learn takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'AHab')
	local trigger t
	local integer h
	if HaveSavedHandle(HY,GetHandleId(u),'AHab') then
		set t=LoadTriggerHandle(HY,GetHandleId(u),'AHab')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call FlushChildHashtable(HY,h)
		call SaveTriggerHandle(HY,GetHandleId(u),'AHab',t)
		call SaveUnitHandle(HY,h,0,u)
		call TriggerRegisterTimerEvent(t,0.2,true)
		call TriggerAddCondition(t,Condition(function BrillianceAuraSelf))
	endif
	call SaveInteger(HY,h,0,lvl)
	
	set u = null
endfunction

function CM_Nova takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local integer lvl=GetUnitAbilityLevel(caster,'A1E9')//A1E9 -> Crystal Nova
	local group g=GetAvailableGroup()
	local unit u2
	set tt_unit1=caster
	call GroupEnumUnitsInRange(g,x,y,425,Condition(function NonImmuneEnemyFilter))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call DamageTarget(caster,u2,1,50+50*lvl)
		call UnitAddAbilityTimedExF(u2,'A3EO'-1+lvl,1,4.5,'B386')//B386 -> Crystal Nova
		call GroupRemoveUnit(g,u2)
	endloop
	call KillGroup(g)
	call DestroyEffect(AddSpecialEffect("war3mapImported\\IceNova.mdx",x,y))
	set caster=null
endfunction

function CM_FrostBite_Periodic takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	if GetUnitAbilityLevel(target,'B017')>0 and (target!=Roshan or LoadInteger(HY,h,0) < 2+LoadInteger(HY,h,1)) then//B017 -> Frostbite
		call DamageTarget(caster,target,1,37.5)
		call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
	else
		call UnitRemoveAbility(target,'B017')
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	endif
	set caster=null
	set target=null
	set t=null
endfunction

function CM_FrostBite takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local timer t=CreateTimer()
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
	call TimerStart(t,0.5,true,function CM_FrostBite_Periodic)
	call SaveUnitHandle(HY,GetHandleId(t),0,caster)
	call SaveInteger(HY,GetHandleId(t),1,lvl)
	call SaveUnitHandle(HY,GetHandleId(t),1,GetSpellTargetUnit())
	call DamageTarget(caster,GetSpellTargetUnit(),1,37.5)
	set t=null
	set caster=null
endfunction

function CM_FrostBiteWrapper takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call CM_FrostBite()
	endif
endfunction

function ConvertUnitLosingSight takes unit u returns nothing
	local boolean sent=IsSentinel(GetOwningPlayer(u))
	local boolean scrg=IsScourge(GetOwningPlayer(u))
	if scrg then
		call UnitShareVision(u,Scourges[0],false)
		call UnitShareVision(u,Scourges[1],false)
		call UnitShareVision(u,Scourges[2],false)
		call UnitShareVision(u,Scourges[3],false)
		call UnitShareVision(u,Scourges[4],false)
		call UnitShareVision(u,Scourges[5],false)
	elseif sent then
		call UnitShareVision(u,Sentinels[0],false)
		call UnitShareVision(u,Sentinels[1],false)
		call UnitShareVision(u,Sentinels[2],false)
		call UnitShareVision(u,Sentinels[3],false)
		call UnitShareVision(u,Sentinels[4],false)
		call UnitShareVision(u,Sentinels[5],false)
	endif
endfunction

function OgreLord_AnteUp takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local real dmg=GetPlayerState(GetOwningPlayer(target),PLAYER_STATE_RESOURCE_GOLD)*(GetUnitAbilityLevel(caster,'A44U')*0.05+0.15)//A44U -> Ante Up
	call DamageTarget(caster,target,1,dmg)
	call TextTagOnUnit("+"+I2S(R2I(dmg)),1,target,.03,255,200,0,255)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\ResourceItems\\ResourceEffectTarget.mdl",target,"origin"))
	call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Other\\ToonBoom\\ToonBoom.mdl",target,"origin"))
	set caster=null
	set target=null
endfunction

function OgreLord_AnteUpWrap takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call OgreLord_AnteUp()
	endif
endfunction

function OgreLord_CashIn takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()//LoadUnitHandle(HY,GetHandleId(GetTriggerUnit()),796)
	local integer diff=GetPlayerState(GetOwningPlayer(target),PLAYER_STATE_RESOURCE_GOLD)-GetPlayerState(GetOwningPlayer(caster),PLAYER_STATE_RESOURCE_GOLD)
	local real dmg
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
	local integer lvl=GetUnitAbilityLevel(caster,'A44V')//A44V -> Cash In
	local integer lim=400+400*lvl
	call UnitAddAbility(d,'A44W')
	call IssueTargetOrder(d,"thunderbolt",target)
	set d=null
	if diff<-lim then
		set diff=-lim
	elseif diff > lim then
		set diff=lim
	endif
	if diff<0 then
		set dmg=diff*(lvl*0.1+0.6)*-1
		call DamageTarget(caster,target,1,dmg)
		call TextTagOnUnit("+"+I2S(R2I(dmg)),1,target,.03,255,100,0,255)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\ResourceItems\\ResourceEffectTarget.mdl",target,"origin"))
		call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Other\\ToonBoom\\ToonBoom.mdl",target,"origin"))
	else
		call SetPlayerState(GetOwningPlayer(target),PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(GetOwningPlayer(target),PLAYER_STATE_RESOURCE_GOLD)+diff)
		call SetPlayerState(GetOwningPlayer(caster),PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(GetOwningPlayer(caster),PLAYER_STATE_RESOURCE_GOLD)+diff)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\ResourceItems\\ResourceEffectTarget.mdl",target,"origin"))
		call TextTagOnUnit("+"+I2S(diff),1,target,.03,255,200,0,255)
		call TextTagOnUnit("+"+I2S(diff),1,caster,.03,255,200,0,255)
	endif
	
	set caster=null
	set target=null
endfunction

function OgreLord_CashInWrap takes nothing returns nothing
	call OgreLord_CashIn()
endfunction

function OgreLord_MindControlConvertIllus takes unit target, player p, real dur returns nothing
	call ConvertUnitLosingSight(target)
	call SetUnitOwner(target,p,true)
	call UnitApplyTimedLife(target,'BTLF',dur)
	call UnitAddAbility2(target,'A46M')
	call DestroyEffect(AddSpecialEffectTarget(GetAbilityEffectById('A46K',EFFECT_TYPE_TARGET,0),target,GetAbilityEffectById('A46K',EFFECT_TYPE_TARGET,1)))
endfunction

function OgreLord_MindControlConvert takes unit d, unit target, real dur, integer bonuslife returns nothing
	if IsUnitIllusion(target) then
		call OgreLord_MindControlConvertIllus(target,GetOwningPlayer(d),dur)
	elseif IssueTargetOrderById(d,852581,target)==false then
		call UnitShareVision(target,GetOwningPlayer(d),true)
		if IssueTargetOrderById(d,852581,target)==false then
			call UnitShareVision(target,GetOwningPlayer(d),false)
		else
			call UnitApplyTimedLife(target,'BTLF',dur)
			call UnitRefillMana(target)
			call UnitAddAbility2(target,'A46M')
			call AddMaxHPFx(target,bonuslife)
		endif
	else
		call UnitApplyTimedLife(target,'BTLF',dur)
		call UnitRefillMana(target)
		call UnitAddAbility2(target,'A46M')
		call AddMaxHPFx(target,bonuslife)
	endif
endfunction

function OgreLord_MindControlFilter1 takes nothing returns boolean
	return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and AliveNonBuildOrMarker(GetFilterUnit()) and IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT) and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false and IsSpiritBear(GetFilterUnit())==false and IsPrimalSplitUnit(GetUnitTypeId(GetFilterUnit()))==false and IsFamiliarId(GetUnitTypeId(GetFilterUnit()))==false and IsInfernalGolem(GetFilterUnit())==false
endfunction

function OgreLord_MindControlFilter2 takes nothing returns boolean
	return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and AliveNonBuildOrMarker(GetFilterUnit()) and IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false and IsSpiritBear(GetFilterUnit())==false and IsPrimalSplitUnit(GetUnitTypeId(GetFilterUnit()))==false and IsFamiliarId(GetUnitTypeId(GetFilterUnit()))==false and IsInfernalGolem(GetFilterUnit())==false
endfunction

function OgreLord_MindControl takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit caster=GetTriggerUnit()
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
	local unit u
	local integer lvl=GetUnitAbilityLevel(caster,'A46J')//A46J -> Mind Control
	local boolean b=IsSentinel(GetOwningPlayer(caster))
	local integer c
	local group gg
	local integer alreadyAffected=0
	local integer synergylvl=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetTriggerPlayer())],'A0A8')
	local real dur=30+5*synergylvl
	local integer bonuslife=synergylvl*50
	call UnitAddAbility(d,'A46K')
	call DestroyEffect(AddSpecialEffect("MindControl.mdx",GetSpellTargetX(),GetSpellTargetY()))
	set tt_unit1=caster
	call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),350+25,Condition(function OgreLord_MindControlFilter1))
	set gg=GetAvailableGroup()
	set tt_unit1=caster
	call GroupEnumUnitsInRange(gg,GetSpellTargetX(),GetSpellTargetY(),350+25,Condition(function OgreLord_MindControlFilter2))
	call GroupAddGroup(gg,g)
	call KillGroup(gg)
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if IsUnitType(u,UNIT_TYPE_ANCIENT) then
			if lvl==3 then
				call OgreLord_MindControlConvert(d,u,dur,bonuslife)
			endif
		elseif IsUnitIllusion(u) or (GetOwningPlayer(u)!=Sentinels[0] and GetOwningPlayer(u)!=Scourges[0] and GetOwningPlayer(u)!=Neutrals) then
			if lvl>1 then
				call OgreLord_MindControlConvert(d,u,dur,bonuslife)
			endif
		else
			call OgreLord_MindControlConvert(d,u,dur,bonuslife)
		endif
		call GroupRemoveUnit(g,u)
	endloop
	
	
	call KillGroup(g)
	set d=null
	set caster=null
endfunction

function BloodRitePaintG takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local real x=LoadReal(HY,h,10)
	local real y=LoadReal(HY,h,11)
	local integer c=LoadInteger(HY,h,0)+1
	local string s="Objects\\Spawnmodels\\NightElf\\NightElfBlood\\NightElfBloodArcher.mdl"
	if c==1 then
		call DestroyEffect(AddSpecialEffect(s,x,y))
		call DestroyEffect(AddSpecialEffect(s,x+50*Cos(15*bj_DEGTORAD),y+50*Sin(15*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+100*Cos(7*bj_DEGTORAD),y+100*Sin(7*bj_DEGTORAD)))
	elseif c==2 then
		call DestroyEffect(AddSpecialEffect(s,x+150*Cos(0*bj_DEGTORAD),y+150*Sin(0*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+200*Cos(340*bj_DEGTORAD),y+200*Sin(340*bj_DEGTORAD)))
	elseif c==3 then
		call DestroyEffect(AddSpecialEffect(s,x+250*Cos(325*bj_DEGTORAD),y+250*Sin(325*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+300*Cos(300*bj_DEGTORAD),y+300*Sin(300*bj_DEGTORAD)))
	elseif c==4 then
		call DestroyEffect(AddSpecialEffect(s,x+350*Cos(275*bj_DEGTORAD),y+350*Sin(270*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+400*Cos(250*bj_DEGTORAD),y+400*Sin(250*bj_DEGTORAD)))
	elseif c==5 then
		call DestroyEffect(AddSpecialEffect(s,x+450*Cos(225*bj_DEGTORAD),y+450*Sin(225*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+500*Cos(200*bj_DEGTORAD),y+500*Sin(200*bj_DEGTORAD)))
	elseif c==6 then
		call DestroyEffect(AddSpecialEffect(s,x+550*Cos(175*bj_DEGTORAD),y+550*Sin(175*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+570*Cos(150*bj_DEGTORAD),y+570*Sin(150*bj_DEGTORAD)))
	elseif c==7 then
		call DestroyEffect(AddSpecialEffect(s,x+570*Cos(125*bj_DEGTORAD),y+570*Sin(125*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+570*Cos(100*bj_DEGTORAD),y+570*Sin(100*bj_DEGTORAD)))
	elseif c==8 then
		call DestroyEffect(AddSpecialEffect(s,x+550*Cos(100*bj_DEGTORAD),y+550*Sin(100*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+550*Cos(90*bj_DEGTORAD),y+550*Sin(90*bj_DEGTORAD)))
	elseif c==9 then
		call DestroyEffect(AddSpecialEffect(s,x+500*Cos(70*bj_DEGTORAD),y+500*Sin(70*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+450*Cos(45*bj_DEGTORAD),y+450*Sin(45*bj_DEGTORAD)))
	elseif c==10 then
		call DestroyEffect(AddSpecialEffect(s,x+450*Cos(20*bj_DEGTORAD),y+450*Sin(20*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+450*Cos(0*bj_DEGTORAD),y+450*Sin(0*bj_DEGTORAD)))
	elseif c==11 then
		call DestroyEffect(AddSpecialEffect(s,x+400*Cos(345*bj_DEGTORAD),y+400*Sin(345*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+350*Cos(330*bj_DEGTORAD),y+350*Sin(330*bj_DEGTORAD)))
	elseif c==12 then
		call DestroyEffect(AddSpecialEffect(s,x+350*Cos(315*bj_DEGTORAD),y+350*Sin(315*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+350*Cos(300*bj_DEGTORAD),y+350*Sin(300*bj_DEGTORAD)))
	elseif c==13 then
		call DestroyEffect(AddSpecialEffect(s,x+350*Cos(275*bj_DEGTORAD),y+350*Sin(275*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+300*Cos(250*bj_DEGTORAD),y+300*Sin(250*bj_DEGTORAD)))
	elseif c==14 then
		call DestroyEffect(AddSpecialEffect(s,x+300*Cos(225*bj_DEGTORAD),y+300*Sin(225*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+350*Cos(200*bj_DEGTORAD),y+350*Sin(200*bj_DEGTORAD)))
	elseif c==15 then
		call DestroyEffect(AddSpecialEffect(s,x+350*Cos(180*bj_DEGTORAD),y+350*Sin(180*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+400*Cos(160*bj_DEGTORAD),y+400*Sin(160*bj_DEGTORAD)))
	elseif c==16 then
		call DestroyEffect(AddSpecialEffect(s,x+400*Cos(130*bj_DEGTORAD),y+400*Sin(130*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+400*Cos(110*bj_DEGTORAD),y+400*Sin(110*bj_DEGTORAD)))
	elseif c==17 then
		call DestroyEffect(AddSpecialEffect(s,x+400*Cos(90*bj_DEGTORAD),y+400*Sin(90*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+400*Cos(70*bj_DEGTORAD),y+400*Sin(70*bj_DEGTORAD)))
	elseif c==18 then
		call DestroyEffect(AddSpecialEffect(s,x+350*Cos(45*bj_DEGTORAD),y+350*Sin(45*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+350*Cos(30*bj_DEGTORAD),y+350*Sin(30*bj_DEGTORAD)))
	elseif c==19 then
		call DestroyEffect(AddSpecialEffect(s,x+250*Cos(0*bj_DEGTORAD),y+250*Sin(0*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+250*Cos(345*bj_DEGTORAD),y+250*Sin(345*bj_DEGTORAD)))
	elseif c==20 then
		call DestroyEffect(AddSpecialEffect(s,x+150*Cos(330*bj_DEGTORAD),y+150*Sin(330*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+100*Cos(300*bj_DEGTORAD),y+100*Sin(300*bj_DEGTORAD)))
	elseif c==21 then
		call DestroyEffect(AddSpecialEffect(s,x+50*Cos(275*bj_DEGTORAD),y+50*Sin(275*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+0*Cos(250*bj_DEGTORAD),y+0*Sin(250*bj_DEGTORAD)))
	elseif c==22 then
		call DestroyEffect(AddSpecialEffect(s,x-100*Cos(225*bj_DEGTORAD),y-100*Sin(225*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x-150*Cos(200*bj_DEGTORAD),y-150*Sin(200*bj_DEGTORAD)))
	elseif c==23 then
		call DestroyEffect(AddSpecialEffect(s,x-200*Cos(175*bj_DEGTORAD),y-200*Sin(175*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x-250*Cos(150*bj_DEGTORAD),y-250*Sin(150*bj_DEGTORAD)))
	elseif c==24 then
		call DestroyEffect(AddSpecialEffect(s,x-250*Cos(180*bj_DEGTORAD),y-250*Sin(180*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x-300*Cos(180*bj_DEGTORAD),y-300*Sin(180*bj_DEGTORAD)))
	elseif c==25 then
		call DestroyEffect(AddSpecialEffect(s,x-350*Cos(270*bj_DEGTORAD),y-350*Sin(270*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x-400*Cos(270*bj_DEGTORAD),y-400*Sin(270*bj_DEGTORAD)))
	elseif c==26 then
		call DestroyEffect(AddSpecialEffect(s,x+350*Cos(90*bj_DEGTORAD),y+350*Sin(90*bj_DEGTORAD)))
		call DestroyEffect(AddSpecialEffect(s,x+400*Cos(90*bj_DEGTORAD),y+400*Sin(90*bj_DEGTORAD)))
	endif
	if c>26 then
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	else
		call SaveInteger(HY,h,0,c)
	endif
	set t=null
endfunction

function BloodRitePaint takes real x, real y returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveReal(HY,h,10,x)
	call SaveReal(HY,h,11,y)
	call TimerStart(t,0.1,true,function BloodRitePaintG)
	set t=null
endfunction

function BloodRiteBlast takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local effect fx=LoadEffectHandle(HY,h,1)
	local real dmg=LoadReal(HY,h,0)
	local integer lvl=LoadInteger(HY,h,0)
	local group g=GetAvailableGroup()
	local real x=LoadReal(HY,h,10)
	local real y=LoadReal(HY,h,11)
	local unit u2
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',x,y,0)//e00E -> Spellcaster
	call PlaySoundAtPos(gg_snd_PossessionMissileLaunch1,x,y)
	call UnitAddAbility(d,'A450')
	call SetUnitAbilityLevel(d,'A450',lvl)
	call IssuePointOrder(d,"silence",x,y)
	set d=null
	set tt_unit1=u
	call GroupEnumUnitsInRange(g,x,y,625,Condition(function DefaultEnemyFilterWithAncients))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call DamageTarget(u,u2,3,dmg)
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\BloodRiteTarget.mdx",u2,"chest"))
		call GroupRemoveUnit(g,u2)
	endloop
	call DestroyEffect(fx)
	call KillGroup(g)
	set g=null
	set fx=null
	set t=null
	set u=null
endfunction

function BloodRite takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A44Z')//A44Z -> Blood Rite
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local effect fx=AddSpecialEffect("war3mapImported\\Bloodrite.mdx",x,y)
	
	call TimedReveal(GetOwningPlayer(u),2.5,x,y,300)
	call PlaySoundAtPos(gg_snd_DarkSummoningLaunch1,x,y)
	call TimerStart(t,2.6,false,function BloodRiteBlast)
	call SaveUnitHandle(HY,h,0,u)
	call SaveReal(HY,h,0,lvl*40+80)
	call SaveInteger(HY,h,0,lvl)
	call SaveEffectHandle(HY,h,1,fx)
	call SaveReal(HY,h,10,x)
	call SaveReal(HY,h,11,y)
	call BloodRitePaint(x,y)
	set t=null
	set fx=null
	set u=null
endfunction

function BloodrageDuration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local unit adjhero
	local real limit
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_DEATH then
		if GetKillingUnit()==u then
			if GetUnitAbilityLevel(u,'A44Y')>0 then
				if IsDead(u)==false and IsUnitIllusion(GetTriggerUnit())==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetTriggerUnit()!=Roshan then
					call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\HeroBloodElfBlood.mdl",u,"overhead"))
					call SetWidgetLife(u,GetWidgetLife(u)+GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)*.2)
				endif
			endif
		elseif GetTriggerUnit()==u then
			if GetUnitAbilityLevel(u,'A44Y')>0 then
				set adjhero=GetKillingUnit()
				if GetUnitAbilityLevel(adjhero,'Aloc')>0 or GetUnitAbilityLevel(adjhero,'A04R')>0 then//Aloc -> Locust, 
					set adjhero=udg_Hero[GetPlayerId(GetOwningPlayer(adjhero))]
				endif
				if IsDead(adjhero)==false and IsUnitIllusion(u)==false and u!=Roshan and IsUnitType(adjhero,UNIT_TYPE_STRUCTURE)==false then//n00L -> Roshan
					call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\HeroBloodElfBlood.mdl",adjhero,"overhead"))
					call SetWidgetLife(adjhero,GetWidgetLife(adjhero)+GetUnitState(u,UNIT_STATE_MAX_LIFE)*(.2))
				endif
				set adjhero=null
			endif
			//call SaveReal(HY,GetHandleId(u),'AMPL',LoadReal(HY,GetHandleId(u),'AMPL')-LoadReal(HY,h,10))
			call UnitRemoveAbility(u,'A44Y')
			call UnitRemoveAbility(u,'B44Y')//B44Y -> Bloodrage
			call FlushChildHashtable(HY,h)
			call RemoveSavedHandle(MHT,GetHandleId(u),'A2X9')
			call RemoveSavedReal(HY,GetHandleId(u),'A2X9')
			call CleanTrigger(t)
//			call echo("clear")
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if LoadBoolean(HY,h,0)==false then
			call SaveBoolean(HY,h,0,true)
			set limit=GetEventDamage()*LoadReal(HY,h,10)
			call DamageTarget(GetEventDamageSource(),GetTriggerUnit(),3,limit)
//			call echo(R2S(limit))
			call SaveBoolean(HY,h,0,false)
		endif
		
	else
		set limit=LoadReal(HY,h,1)
		if limit < TimerGetElapsed(GlobalTimer) or GetUnitAbilityLevel(u,'A44Y')==0 then
			call UnitRemoveAbility(u,'A44Y')
			call UnitRemoveAbility(u,'B44Y')//B44Y -> Bloodrage
			//call SaveReal(HY,GetHandleId(u),'AMPL',LoadReal(HY,GetHandleId(u),'AMPL')-LoadReal(HY,h,10))
			call FlushChildHashtable(HY,h)
			call RemoveSavedHandle(MHT,GetHandleId(u),'A2X9')
			call RemoveSavedReal(HY,GetHandleId(u),'A2X9')
			call CleanTrigger(t)
//			call echo("clear2")
		endif
//		call echo("tick #"+I2S(GetTriggerEvalCount(t)))
	endif
	set t=null
	set u=null
	return false
endfunction

function BloodrageNewAct takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
	local real dur=8+lvl
	local real amplify=0.15+0.05*lvl
	local trigger t//=CreateTrigger()
	local integer h//=GetHandleId(t)
	local real oldampl
	if HaveSavedHandle(MHT,GetHandleId(target),'A2X9') then
		set t=LoadTriggerHandle(MHT,GetHandleId(target),'A2X9')
		set h=GetHandleId(t)
		set oldampl=LoadReal(HY,h,10)
		if oldampl!=amplify then
			//call SaveReal(HY,GetHandleId(target),'AMPL',LoadReal(HY,GetHandleId(target),'AMPL')+amplify-oldampl)
			call SaveReal(HY,h,10,amplify)
			call SaveReal(HY,GetHandleId(target),'A2X9',amplify)
		endif
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.1,true)
		call SaveUnitHandle(HY,h,0,target)
		call SaveTriggerHandle(MHT,GetHandleId(target),'A2X9',t)
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
		call TriggerAddCondition(t,Condition(function BloodrageDuration))
		call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
		//call SaveReal(HY,h,0,amplify)
		//call SaveReal(HY,GetHandleId(target),'AMPL',LoadReal(HY,GetHandleId(target),'AMPL')+amplify)
		call SaveReal(HY,GetHandleId(target),'A2X9',amplify)
		call SaveReal(HY,h,10,amplify)
	endif
	call UnitAddAbility2(target,'A44Y')
	call SetUnitAbilityLevel(target,'A44Y',lvl)
	call SaveReal(HY,h,1,dur+TimerGetElapsed(GlobalTimer))
	
	set t=null
	set caster=null
	set target=null
endfunction

function BloodrageNewStart takes nothing returns nothing
	if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) or IsBlocked(GetSpellTargetUnit())==false then
		call BloodrageNewAct()
	endif
endfunction

function FirewallDuration takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer lvl=LoadInteger(HY,h,0)
	local group g
	local unit u2
	local real dmg
	if IsDead(u) then
		call FlushChildHashtable(HY,h)
		call DestroyTimer(t)
	else
		set g=GetAvailableGroup()
		set tt_unit1=u
		set dmg=(lvl*15+10.)/2.
		call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),175,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
		loop
			set u2=FirstOfGroup(g)
			exitwhen u2==null
			call GroupRemoveUnit(g,u2)
			if LoadInteger(HY,GetHandleId(u2),'frwl')!=1 then
				call AddTimedKeyToUnit(u2,'frwl',0.49)
				call UnitAddAbilityTimedExF(u2,'A452',1,1,'B452')
				call DamageTarget(u,u2,1,dmg)
			endif
		endloop
		call KillGroup(g)
	endif
	
	set t=null
endfunction

function FirewallWrapper takes unit d, integer lvl returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0.5,true,function FirewallDuration)
	call SaveUnitHandle(HY,h,0,d)
	call SaveInteger(HY,h,0,lvl)
	set t=null
endfunction

function FirewallAct takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
	local unit dummy
	local integer i=0
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real step=12
	loop
		set dummy=CreateUnit(GetOwningPlayer(u),'ho03',x+450*Cos(step*i),y+450*Sin(step*i),0)
		call FirewallWrapper(dummy,lvl)
		call UnitApplyTimedLife(dummy,'BTLF',5)
		call SetUnitX(dummy,x+450*Cos(15*i))
		call SetUnitY(dummy,y+450*Sin(15*i))
		set i=i+1
		exitwhen i*step>360
	endloop
	set u=null
	set dummy=null
endfunction

function FirewallOnCast takes nothing returns nothing
	call DestroyEffect(AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire2.mdl",GetTriggerUnit(),"left hand"))
	call DestroyEffect(AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire2.mdl",GetTriggerUnit(),"weapon"))
endfunction

function FireStompActEffect takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A454')//A454 -> Fire Stomp
	local unit u2
	local group g=GetAvailableGroup()
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
	call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
	set tt_unit1=u
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),350+25,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call DamageTarget(u,u2,1,100*lvl)
		call StunTargetLoD(u2,lvl*1.0)
		call GroupRemoveUnit(g,u2)
	endloop
	call KillGroup(g)
	set u=null
endfunction

function FireStompRemoveVisual takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	call DestroyEffect(LoadEffectHandle(HY,h,0))
	call DestroyEffect(LoadEffectHandle(HY,h,1))
	call DestroyEffect(LoadEffectHandle(HY,h,2))
	call DestroyEffect(LoadEffectHandle(HY,h,3))
	call DestroyEffect(LoadEffectHandle(HY,h,4))
	call DestroyEffect(LoadEffectHandle(HY,h,5))
	call FlushChildHashtable(HY,h)
	call DestroyTrigger(t)
	set t=null
	return false
endfunction

function FireStompAct takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit u=GetTriggerUnit()
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterTimerEvent(t,1.2,false)
	call TriggerAddCondition(t,Condition(function FireStompRemoveVisual))
	call SaveEffectHandle(HY,h,0,AddSpecialEffectTarget("Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl",u,"hand right"))
	call SaveEffectHandle(HY,h,1,AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlameStrike\\FlameStrikeEmbers.mdl",u,"hand right"))
	call SaveEffectHandle(HY,h,2,AddSpecialEffectTarget("Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl",u,"weapon left"))
	call SaveEffectHandle(HY,h,3,AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlameStrike\\FlameStrikeEmbers.mdl",u,"weapon left"))
	call SaveEffectHandle(HY,h,4,AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlameStrike\\FlameStrikeEmbers.mdl",u,"right foot"))
	call SaveEffectHandle(HY,h,5,AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlameStrike\\FlameStrikeEmbers.mdl",u,"left foot"))
	set t=null
	set u=null
endfunction

function InfernoDmgFix takes nothing returns nothing
	call LoDStat_Sub(GetEnumUnit(),LoadInteger(HY,GetHandleId(GetEnumUnit()),'MDMG'),"damageneg")
endfunction

function InfernoTick takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer dmg
	local integer lvl=LoadInteger(HY,h,0)
	local real burndmg
	local group g=LoadGroupHandle(HY,h,100)
	local unit u2
	local group gg
	if LoadBoolean(HY,h,0)==false and GetTriggerEventId()==EVENT_UNIT_ATTACKED then
		set dmg=LoadInteger(HY,GetHandleId(GetAttacker()),'MDMG')+5+5*lvl
		call LoDStat_Add(GetAttacker(),5+5*lvl,"damageneg")
		call SaveInteger(HY,GetHandleId(GetAttacker()),'MDMG',dmg)
		call GroupAddUnit(g,GetAttacker())
	elseif LoadBoolean(HY,h,0)==false and TimerGetElapsed(GlobalTimer) > LoadReal(HY,h,0) or GetTriggerEventId()==EVENT_WIDGET_DEATH then//end
		call SaveBoolean(HY,h,0,true)
		call SaveInteger(HY,h,-1,5*4)
		call DestroyEffect(LoadEffectHandle(HY,h,1))
		call DestroyEffect(LoadEffectHandle(HY,h,2))
		call DestroyEffect(LoadEffectHandle(HY,h,3))
		call DestroyEffect(LoadEffectHandle(HY,h,4))
		call DestroyEffect(LoadEffectHandle(HY,h,5))
		call DestroyEffect(LoadEffectHandle(HY,h,6))
		call DestroyEffect(LoadEffectHandle(HY,h,7))
		call DestroyEffect(LoadEffectHandle(HY,h,8))
	elseif LoadBoolean(HY,h,0) then
		call SaveInteger(HY,h,-1,LoadInteger(HY,h,-1)-1)
		if LoadInteger(HY,h,-1)<=0 then
			call ForGroup(g,function InfernoDmgFix)
			call KillGroup(g)
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		endif
	else
		set gg=GetAvailableGroup()
		set tt_unit1=u
		call GroupEnumUnitsInRange(gg,GetUnitX(u),GetUnitY(u),350+25,Condition(function DefaultEnemyFilterWithAncients))
		set burndmg=(lvl*25+50) / 5
		loop
			set u2=FirstOfGroup(gg)
			exitwhen u2==null
			call DamageTarget(u,u2,1,burndmg)
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\ImmolationRed\\ImmolationRedDamage.mdl",u2,"chest"))
			call GroupRemoveUnit(gg,u2)
		endloop
		call KillGroup(gg)
	endif
	set g=null
	set u=null
	set t=null
	return false
endfunction

function InfernoAct takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
	local group g=GetAvailableGroup()
	local string ss="Objects\\Spawnmodels\\Other\\FlameThrower\\FlameThrowerSpawnObj.mdl"
	local string s="Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl"
	call TriggerRegisterTimerEvent(t,0.2,true)
	call TriggerRegisterDeathEvent(t,u)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ATTACKED)
	call SaveUnitHandle(HY,h,0,u)
	call SaveGroupHandle(HY,h,100,g)
	call SaveInteger(HY,h,0,lvl)
	call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+14)
	call SaveEffectHandle(HY,h,1,AddSpecialEffectTarget("Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl",u,"origin"))
	
	call DestroyEffect(AddSpecialEffectTarget(ss,u,"weapon"))
	call DestroyEffect(AddSpecialEffectTarget(ss,u,"hand left"))
	call DestroyEffect(AddSpecialEffectTarget(ss,u,"hand right"))
	call DestroyEffect(AddSpecialEffectTarget(ss,u,"foot left"))
	call DestroyEffect(AddSpecialEffectTarget(ss,u,"foot right"))
	call DestroyEffect(AddSpecialEffectTarget(ss,u,"head"))
	call DestroyEffect(AddSpecialEffectTarget(ss,u,"chest"))
	
	call SaveEffectHandle(HY,h,2,AddSpecialEffectTarget(s,u,"weapon"))
	call SaveEffectHandle(HY,h,3,AddSpecialEffectTarget(s,u,"hand left"))
	call SaveEffectHandle(HY,h,4,AddSpecialEffectTarget(s,u,"hand right"))
	call SaveEffectHandle(HY,h,5,AddSpecialEffectTarget(s,u,"foot left"))
	call SaveEffectHandle(HY,h,6,AddSpecialEffectTarget(s,u,"foot right"))
	call SaveEffectHandle(HY,h,7,AddSpecialEffectTarget(s,u,"head"))
	call SaveEffectHandle(HY,h,8,AddSpecialEffectTarget(s,u,"chest"))
	call TriggerAddCondition(t,Condition(function InfernoTick))
	set t=null
	set u=null
endfunction

function FireLord_FireshowRanged takes nothing returns nothing
	//wrapper lvl 3
	local group g
	local unit u
	local real a
	local integer lvl
	local real dmg=0
	local integer chance
	local real x
	local real y
	set lvl=GetUnitAbilityLevel(UDSG_Attacker,'A455')
	if IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER) then
		set chance=lvl*5+20
	else
		set chance=lvl*5+5
	endif
	if PRD_Get(UDSG_Attacker,'A455',chance) then
		set a=AngleBetweenUnits(UDSG_Attacker,UDSG_Target)
		set g=GetAvailableGroup()
		set tt_unit1=UDSG_Attacker
		set x=GetUnitX(UDSG_Target)+250*Cos(a*bj_DEGTORAD)
		set y=GetUnitY(UDSG_Target)+250*Sin(a*bj_DEGTORAD)
		call GroupEnumUnitsInRange(g,x,y,275,Condition(function DefaultEnemyFilterWithAncients))
		call GroupAddUnit(g,UDSG_Target)
		if IsUnitType(UDSG_Target,UNIT_TYPE_HERO) then
			set dmg=GetHeroStr(UDSG_Target,true)+GetHeroAgi(UDSG_Target,true)+GetHeroInt(UDSG_Target,true)+GetHeroStr(UDSG_Attacker,true)+GetHeroAgi(UDSG_Attacker,true)+GetHeroInt(UDSG_Attacker,true)
			set dmg=dmg/2
		else
			set dmg=GetHeroStr(UDSG_Attacker,true)+GetHeroAgi(UDSG_Attacker,true)+GetHeroInt(UDSG_Attacker,true)
		endif
		
		
		call KillUnit(CreateUnit(GetOwningPlayer(UDSG_Attacker),'h02I',GetUnitX(UDSG_Target),GetUnitY(UDSG_Target),0))
		
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			call DestroyEffect(AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire2.mdl",u,"origin"))
			call DamageTarget(UDSG_Attacker,u,1,dmg)
			call GroupRemoveUnit(g,u)
		endloop
		call KillGroup(g)
	endif
endfunction

function FireLord_FireshowRangedWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'A455')>0 and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 then
		call FireLord_FireshowRanged()
	endif
endfunction

function R6E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call SetUnitAnimationByIndex(Source,8)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function RLE takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SetUnitAnimationByIndex(Source,7)
	call TriggerRegisterTimerEvent(t,2.5,false)
	call TriggerAddCondition(t,Condition(function R6E))
	call SaveUnitHandle(HY,h,2,(Source))
	set t=null
	set Source=null
endfunction

function XinModel_Death takes nothing returns nothing
	if GetUnitTypeId(GetTriggerUnit())=='N0M0' then//N0M0 -> Ember Spirit
		call RLE()
	endif
endfunction

function R0E takes nothing returns nothing
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\ChimaeraLightningMissile\\ChimaeraLightningMissile.mdl",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
	call DamageTarget(EG8,GetEnumUnit(),1,EH8)
endfunction

function R5E takes nothing returns boolean
	local trigger t2=GetTriggeringTrigger()
	local integer Cache2=GetHandleId(t2)
	local trigger t1=(LoadTriggerHandle(HY,(Cache2),9))
	local integer R2E=GetHandleId(t1)
	local unit S4E=(LoadUnitHandle(HY,(Cache2),8))
	local group g
	local integer Level=(LoadInteger(HY,(Cache2),5))
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call ShowUnit(S4E,false)
		call KillUnit(S4E)
		call FlushChildHashtable(HY,(R2E))
		call CleanTrigger(t1)
		call FlushChildHashtable(HY,(Cache2))
		call CleanTrigger(t2)
	elseif IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(S4E)) and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 then//
		set g=GetAvailableGroup()
		set tt_unit1=S4E
		set EG8=S4E
		set EH8=100+40*Level
		call GroupEnumUnitsInRange(g,GetUnitX(S4E),GetUnitY(S4E),285,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function R0E)
		call KillGroup(g)
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",GetUnitX(S4E),GetUnitY(S4E)))
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",GetUnitX(S4E),GetUnitY(S4E)))
		call ShowUnit(S4E,false)
		call KillUnit(S4E)
		call FlushChildHashtable(HY,(R2E))
		call CleanTrigger(t1)
		call FlushChildHashtable(HY,(Cache2))
		call CleanTrigger(t2)
	endif
	set t1=null
	set t2=null
	set S4E=null
	set g=null
	return false
endfunction

function S7E takes nothing returns boolean
	local trigger t1=GetTriggeringTrigger()
	local integer R2E=GetHandleId(t1)
	local trigger t2
	local integer Cache2
	local unit S4E
	local integer Level
	local real x=(LoadReal(HY,(R2E),6))
	local real y=(LoadReal(HY,(R2E),7))
	local real H1E
	local integer Count=GetTriggerEvalCount(t1)
	if Count==1 then
		call DestroyEffect((LoadEffectHandle(HY,(R2E),3)))
	elseif Count==2 then
		call DestroyEffect((LoadEffectHandle(HY,(R2E),4)))
		set t2=CreateTrigger()
		set Cache2=GetHandleId(t2)
		set Level=(LoadInteger(HY,(R2E),5))
		set H1E=(LoadReal(HY,(R2E),1))
		set S4E=CreateUnit(GetOwningPlayer((LoadUnitHandle(HY,(R2E),2))),'h07F',x,y,H1E)//h07F -> Static Remnant
		call SetUnitVertexColor(S4E,255,255,255,100)
		call UnitApplyTimedLife(S4E,'BTLF',12)
		call SaveUnitHandle(HY,(R2E),8,(S4E))
		call SaveUnitHandle(HY,(Cache2),8,(S4E))
		call SaveTriggerHandle(HY,(Cache2),9,(t1))
		call SaveInteger(HY,(Cache2),5,(Level))
		call TriggerRegisterUnitInRange(t2,S4E,235,Condition(function ReturnTrue))
		call TriggerRegisterUnitEvent(t2,S4E,EVENT_UNIT_DEATH)
		call TriggerAddCondition(t2,Condition(function R5E))
		call DestroyEffect(AddSpecialEffectTarget("effects\\ManaFlareBoltImpact_NoSound.mdx",S4E,"origin"))
	elseif Count>2 then
		set S4E=(LoadUnitHandle(HY,(R2E),8))
		call DestroyEffect(AddSpecialEffectTarget("effects\\ManaFlareBoltImpact_NoSound.mdx",S4E,"origin"))
	endif
	set t1=null
	set t2=null
	set S4E=null
	return false
endfunction

function Storm_StaticRemnant takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t1=CreateTrigger()
	local integer R2E=GetHandleId(t1)
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	call TriggerRegisterTimerEvent(t1,.5,true)
	call TriggerAddCondition(t1,Condition(function S7E))
	call SaveReal(HY,(R2E),6,((x)*1.))
	call SaveReal(HY,(R2E),7,((y)*1.))
	call SaveInteger(HY,(R2E),5,(GetUnitAbilityLevel(Source,'A14P')))//A14P -> Static Remnant
	call SaveUnitHandle(HY,(R2E),2,(Source))
	call SaveReal(HY,(R2E),1,((GetUnitFacing(Source))*1.))
	call SaveEffectHandle(HY,(R2E),3,(AddSpecialEffect("Abilities\\Spells\\Orc\\LightningShield\\LightningShieldTarget.mdl",x,y)))
	call SaveEffectHandle(HY,(R2E),4,(AddSpecialEffect("effects\\Static_Remnant_FX.mdx",x,y)))
	set Source=null
	set t1=null
endfunction

function SDE takes nothing returns nothing
	call DamageTarget(EI8,GetEnumUnit(),1,EJ8)
	call UnitAddAbilityTimedExF(GetEnumUnit(),'A335',1,0.6,'B08B')
endfunction

function SEE takes unit Source,unit Target returns nothing
	local integer h=GetHandleId(Source)
	local group g=GetAvailableGroup()
	call DestroyEffect((LoadEffectHandle(HY,h,200)))
	call DestroyEffect((LoadEffectHandle(HY,h,201)))
	call SaveInteger(HY,(GetHandleId((Source))),(4264),2)
	set tt_unit1=Source
	set EI8=Source
	set EJ8=GetUnitAbilityLevel(Source,'A0QW')*20+10//A0QW -> Overload, QP1V -> Overload
	call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),300,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(g,function SDE)
	call KillGroup(g)
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl",GetUnitX(Target),GetUnitY(Target)))
	set g=null
endfunction

function SFE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,30)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local trigger SGE=(LoadTriggerHandle(HY,h,202))
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==Source and((LoadInteger(HY,(GetHandleId((Source))),(4264)))==1) then
			call DisableTrigger(t)
			call SEE(Source,Target)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call FlushChildHashtable(HY,(GetHandleId(SGE)))
			call CleanTrigger(SGE)
		endif
	else
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	set Source=null
	set SGE=null
	return false
endfunction

function SHE takes nothing returns nothing
	local trigger t=CreateTrigger()
	local unit Target=GetTriggerUnit()
	local unit Source=GetAttacker()
	local integer h=GetHandleId(t)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerRegisterTimerEvent(t,2.5,false)
	call TriggerAddCondition(t,Condition(function SFE))
	call SaveUnitHandle(HY,h,30,((Target)))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveTriggerHandle(HY,h,202,(GetTriggeringTrigger()))
	set t=null
	set Target=null
	set Source=null
endfunction

function SIE takes nothing returns boolean
	if GetAttacker()==(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2))and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitAlly(GetAttacker(),GetOwningPlayer(GetTriggerUnit()))==false then
		call SHE()
	endif
	return false
endfunction

function SJE takes nothing returns nothing
	local trigger t=CreateTrigger()
	local unit Source=GetTriggerUnit()
	local integer h=GetHandleId(Source)
	local string fx=""
	if IsUnitAlly(Source,GetLocalPlayer())or IsObserver(GetLocalPlayer())then
		set fx="Abilities\\Weapons\\FarseerMissile\\FarseerMissile.mdl"
	endif
	call SaveEffectHandle(HY,h,200,(AddSpecialEffectTarget(fx,Source,"right hand")))
	call SaveEffectHandle(HY,h,201,(AddSpecialEffectTarget(fx,Source,"left hand")))
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerAddCondition(t,Condition(function SIE))
	call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
	set t=null
	set Source=null
endfunction

function SKE takes nothing returns boolean
	local integer spell = GetSpellAbilityId()

	if (spell=='A14O' or spell=='A3FJ' or spell=='A0SB' or Valid_Spell(spell))and(LoadInteger(HY,GetHandleId(GetTriggerUnit()),4264)!=1) and GetUnitAbilityLevel(GetTriggerUnit(),'A36D')==0 then//A14O -> Ball Lightning, A0SB -> Phase Shift
		call SaveInteger(HY,GetHandleId(GetTriggerUnit()),4264,1)
		call SJE()
	endif
	return false
endfunction

function StormSpirit_Overload_Learn takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function SKE))
	set Source=null
	set t=null
endfunction

function SOE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real a=(LoadReal(HY,h,13))
	local real x=GetUnitX(Target)-5*Cos(a)
	local real y=GetUnitY(Target)-5*Sin(a)
	local integer Level=(LoadInteger(HY,h,5))
	local real x0=(LoadReal(HY,h,6))
	local real y0=(LoadReal(HY,h,7))
	if((x0-x)*(x0-x))+((y0-y)*(y0-y))<100 then
		set x=x0
		set y=y0
	endif
	call SetUnitX(Target,x)
	call SetUnitY(Target,y)
	if GetTriggerEvalCount(t)==(10+10*Level)or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	return false
endfunction

function SPE takes unit Source, integer Level returns nothing
	local unit Target=GetSpellTargetUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'u00X',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))//u00X -> Electric Vortex
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function SOE))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveReal(HY,h,13,((Atan2(GetUnitY(Target)-GetUnitY(Source),GetUnitX(Target)-GetUnitX(Source)))*1.))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,6,((GetUnitX(Source))*1.))
	call SaveReal(HY,h,7,((GetUnitY(Source))*1.))
	call UnitAddAbility2(Caster,'A14Q')//A14Q -> Electric Vortext leashes
	call SetUnitAbilityLevel(Caster,'A14Q',Level)//A14Q -> Electric Vortext leashes
	call IssueTargetOrderById(Caster,852480,Target)
	call UnitApplyTimedLife(Caster,'BTLF',1+.5*Level)
	//set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))//e00E -> Spellcaster
	//call UnitAddAbility2(Caster,'A14S')//A14S -> Electric Vortex selfslow
	//call IssueTargetOrderById(Caster,852075,Source)
	set Target=null
	set Caster=null
	set t=null
endfunction

function Storm_ElectricVortex takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A14R')//A14R -> Electric Vortex
	if GetUnitAbilityLevel(caster,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(caster),0) then//Aloc -> Locust
		set caster=LoadUnitHandle(HY,GetHandleId(caster),0)
	endif
	if GetUnitTypeId(GetSpellTargetUnit())!='n00L' and IsBlocked(GetSpellTargetUnit())==false then//n00L -> Roshan
		call SPE(caster,lvl)
	endif
	set caster=null
endfunction

function SRE takes nothing returns nothing
	if(LoadBoolean(HY,(EK8),(GetHandleId(GetEnumUnit()))))==false then
		call SaveBoolean(HY,(EK8),(GetHandleId(GetEnumUnit())),(true))
		call DamageTarget(EN8,GetEnumUnit(),1,EO8*(EM8*4+4)/ 100)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",GetEnumUnit(),"origin"))
	endif
endfunction

function SSE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Level=(LoadInteger(HY,h,5))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit STE=(LoadUnitHandle(HY,h,195))
	local integer Y59=(LoadInteger(HY,h,194))
	local real TargetX=(LoadReal(HY,h,6))
	local real TargetY=(LoadReal(HY,h,7))
	local real NHE=GetUnitX(Source)
	local real NIE=GetUnitY(Source)
	local real a=Atan2(TargetY-NIE,TargetX-NHE)
	local real step=LoadReal(HY,h,0)
	local real AO8=NHE+(step)*Cos(a)
	local real AP8=NIE+(step)*Sin(a)
	local lightning ZQ8=(LoadLightningHandle(HY,h,196))
	local real lx=(LoadReal(HY,h,197))
	local real ly=(LoadReal(HY,h,198))
	local real IVD=GetUnitState(Source,UNIT_STATE_MANA)
	local real SUE
	local group g=GetAvailableGroup()
	local real SVE=(LoadReal(HY,h,199))
	local boolean agh=LoadBoolean(HY,h,0)
	if agh then
		set SUE=(step)*(10+.006*GetUnitState(Source,UNIT_STATE_MAX_MANA))/ 100
	else
		set SUE=(step)*(12+.007*GetUnitState(Source,UNIT_STATE_MAX_MANA))/ 100
	endif
	set SVE=SVE+step
	call SaveReal(HY,h,199,((SVE)*1.))
	if GetTriggerEvalCount(t)>25 then
		set lx=lx+(step)*Cos(a)
		set ly=ly+(step)*Sin(a)
		call SaveReal(HY,h,197,((lx)*1.))
		call SaveReal(HY,h,198,((ly)*1.))
	endif
	call SetUnitState(Source,UNIT_STATE_MANA,RMaxBJ(IVD-SUE,0))
	call MoveLightning(ZQ8,true,lx,ly,AO8,AP8)
	if IsUnitType(Source,UNIT_TYPE_HERO)then
		call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
	endif
	call SetUnitX(Source,AO8)
	call SetUnitY(Source,AP8)
	call SetUnitPosition(Caster,AO8,AP8)
	call SetUnitPosition(STE,AO8,AP8)
	set tt_unit1=Source
	set EN8=Source
	set EK8=h
	set EM8=Level
	set EO8=SVE
	call GroupEnumUnitsInRange(g,AO8,AP8,75+75*Level,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(g,function SRE)
	call KillGroup(g)
	set Y59=Y59-1
	call SaveInteger(HY,h,194,(Y59))
	call SetTint(Source,-1,-1,-1,0)
	if Y59==0 or GetUnitState(Source,UNIT_STATE_MANA)<1 then
		call DestroyLightning(ZQ8)
		call KillTrees(AO8,AP8,75)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call RemoveUnit(Caster)
		call RemoveUnit(STE)
		call SetTint(Source,-1,-1,-1,255)
		call SetUnitPathing(Source,true)
		call SetUnitInvulnerable(Source,false)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call KillTrees(AO8,AP8,75)
	endif
	set t=null
	set Caster=null
	set Source=null
	set ZQ8=null
	set g=null
	set STE=null
	return false
endfunction

function Storm_BallLightning takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local unit Caster
	local unit STE
	local real x
	local real y
	local trigger t
	local integer h
	local lightning ZQ8
	local integer Level=GetUnitAbilityLevel(Source,'A14O')+GetUnitAbilityLevel(Source,'A3FJ')//A14O -> Ball Lightning
	local real IVD=GetUnitState(Source,UNIT_STATE_MANA)
	local real SUE=30+.08*GetUnitState(Source,UNIT_STATE_MAX_MANA)
	local boolean agh=false
	local real dist
	if GetUnitAbilityLevel(Source,'A3FJ')>0 then
		set SUE=15+0.05*GetUnitState(Source,UNIT_STATE_MAX_MANA)
		set agh=true
	endif
	call SetUnitState(Source,UNIT_STATE_MANA,RMaxBJ(IVD-SUE,0))
	if GetUnitState(Source,UNIT_STATE_MANA)>10 then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		set Caster=CreateUnit(GetOwningPlayer(Source),'o010',SourceX,SourceY,0)//o010 -> Ball Lightning
		set STE=CreateUnit(GetOwningPlayer(Source),'H07G',SourceX,SourceY,0)//H07G -> Storm Spirit unused
		set ZQ8=AddLightning("FORK",true,SourceX,SourceY,SourceX,SourceY)
		if GetSpellTargetUnit()==null then
			set x=GetSpellTargetX()
			set y=GetSpellTargetY()
		else
			set x=GetUnitX(GetSpellTargetUnit())
			set y=GetUnitY(GetSpellTargetUnit())
		endif
		set dist=DistanceBetweenXY(x,y,SourceX,SourceY)
		if dist < 25+25*Level then
			call SaveReal(HY,h,0,dist)
		else
			call SaveReal(HY,h,0,25+25*Level)
		endif
		//call SetUnitVertexColor(Source,255,255,255,0)
		call SetTint(Source,-1,-1,-1,0)
		call SetUnitVertexColor(STE,255,255,255,0)
		call SetUnitPathing(Source,false)
		call SetUnitPathing(Caster,false)
		call SetUnitInvulnerable(Source,true)
		call SaveUnitHandle(HY,h,19,(Caster))
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveUnitHandle(HY,h,195,(STE))
		call SaveLightningHandle(HY,h,196,(ZQ8))
		call SaveInteger(HY,h,5,(Level))
		call SaveReal(HY,h,6,((x)*1.))
		call SaveReal(HY,h,7,((y)*1.))
		call SaveReal(HY,h,197,((SourceX)*1.))
		call SaveReal(HY,h,198,((SourceY)*1.))
		call SaveReal(HY,h,199,(0*1.))
		call SaveInteger(HY,h,194,(IMaxIF(R2I(SquareRoot((x-SourceX)*(x-SourceX)+(y-SourceY)*(y-SourceY))/(25+25*Level)),1)))
		call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("effects\\Lightning_Ball_Tail_FX.mdx",STE,"origin")))
		call TriggerRegisterTimerEvent(t,.04,true)
		call TriggerAddCondition(t,Condition(function SSE))
		call ShowUnit(Source,false)
		call ShowUnit(Source,true)
		call SelectUnitAddForPlayer(Source,GetOwningPlayer(Source))
		call SaveBoolean(HY,h,0,agh)
	endif
	set Source=null
	set Caster=null
	set STE=null
	set t=null
	set ZQ8=null
endfunction

function Storm_BallLightning_OnCast takes nothing returns nothing
	local real mp=GetUnitState(GetTriggerUnit(),UNIT_STATE_MANA)
	local real min
	if GetSpellAbilityId()=='A3FJ'then
		set min=15+.05*GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_MANA)
	else
		set min=30+.08*GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_MANA)
	endif
	if mp<min then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0G8'))//n0G8 -> Not enough mana
	endif
endfunction


function StormOld_LightningGrapple_ForGroup2 takes nothing returns nothing
	call SetUnitPathing(GetEnumUnit(),true)
	if IsUnitEnemy(GetEnumUnit(),GetOwningPlayer(LightningGrappleUnit)) then
		call DamageTarget(LightningGrappleUnit,GetEnumUnit(),1,LightningGrappleDmg)
		call UnitAddAbilityTimedExF(GetEnumUnit(),'A3B7',1,1.0,'B3B7')//B3B7 -> Lightning Grappled
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",GetEnumUnit(),"origin"))
	endif
endfunction

function StormOld_LightningGrapple_ForGroup takes nothing returns nothing
	call SetUnitPosition(GetEnumUnit(),GetUnitX(GetEnumUnit())+40*Cos(LightningGrappleAngle),GetUnitY(GetEnumUnit())+40*Sin(LightningGrappleAngle))
	call KillTrees(GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),200)
	call SetUnitPathing(GetEnumUnit(),false)
endfunction

function StormOld_LightningGrapple_Periodic takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local real a=LoadReal(HY,h,0)
	local integer c=LoadInteger(HY,h,0)-1
	local unit caster=LoadUnitHandle(HY,h,0)
	local real x=GetUnitX(caster)
	local real y=GetUnitY(caster)
	local group g
	if c<1 or DistanceBetweenXY(x,y,LoadReal(HY,h,1),LoadReal(HY,h,2))<50 then//its time to land
		set LightningGrappleUnit=caster
		set LightningGrappleDmg=LoadInteger(HY,h,5)*50+50
		set g=GetAvailableGroup()
		set tt_unit1=caster
		call GroupEnumUnitsInRange(g,x,y,275,Condition(function DefaultEnemyFilterWithAncients))
		call GroupAddGroup(g,LoadGroupHandle(HY,h,10))
		call ForGroup(LoadGroupHandle(HY,h,10),function StormOld_LightningGrapple_ForGroup2)
		call KillGroup(g)
		call KillTrees(x,y,200)
		call DestroyLightning(LoadLightningHandle(HY,h,11))
		call KillGroup(LoadGroupHandle(HY,h,10))
		call CleanTimer(t)
	else
		set LightningGrappleAngle=a
		call ForGroup(LoadGroupHandle(HY,h,10),function StormOld_LightningGrapple_ForGroup)
		call MoveLightning(LoadLightningHandle(HY,h,11),true,x,y,LoadReal(HY,h,1),LoadReal(HY,h,2))
		call SaveInteger(HY,h,0,c)
	endif
	
	set caster=null
	set t=null
endfunction

function StormOld_LightningGrapple_Filter takes nothing returns boolean
	return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsDead(GetFilterUnit())==false
endfunction

function StormOld_LightningGrapple takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local real x=GetUnitX(caster)
	local real y=GetUnitY(caster)
	local real dx=GetSpellTargetX()
	local real dy=GetSpellTargetY()
	local real angle=AngleBetweenXY(x,y,dx,dy)*bj_DEGTORAD
	local group g=GetAvailableGroup()
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local lightning l
	local real limit=800+200*GetUnitAbilityLevel(caster,GetSpellAbilityId())
	if DistanceBetweenXY(x,y,dx,dy)>limit then
		set dx=x+limit*Cos(angle)
		set dy=y+limit*Sin(angle)
	endif
	set l=AddLightning("CLPB",true,x,y,dx,dy)
  call SetLightningColor(l,.75,.75,1,.75)
	call GroupEnumUnitsInRange(g,x,y,350,Condition(function StormOld_LightningGrapple_Filter))
	call TimerStart(t,0.03,true,function StormOld_LightningGrapple_Periodic)
	call SaveInteger(HY,h,0,R2I(DistanceBetweenXY(x,y,dx,dy)/40)+1)
	call SaveReal(HY,h,0,angle)
	call SaveInteger(HY,h,5,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
	call SaveGroupHandle(HY,h,10,g)
	call SaveLightningHandle(HY,h,11,l)
	call SaveUnitHandle(HY,h,0,caster)
	call SaveReal(HY,h,1,dx)
	call SaveReal(HY,h,2,dy)
	set l=null
	set t=null
	set caster=null
	set g=null
endfunction

function CheatDeath_InvulAfter takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	local unit source=LoadUnitHandle(HY,GetHandleId(t),1)
	local real dmg=LoadReal(HY,GetHandleId(t),0)
	call SetUnitInvulnerable(u,false)
	call DamageTarget(source,u,2,dmg)
	call CleanTimer(t)
	set t=null
	set u=null
	set source=null
endfunction

function CheatDeath_invul takes unit u, real dmgleft, unit source returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0,false,function CheatDeath_InvulAfter)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call SaveUnitHandle(HY,GetHandleId(t),1,source)
	call SaveReal(HY,GetHandleId(t),0,dmgleft)
	call SetUnitInvulnerable(u,true)
	set t=null
endfunction

function CheatDeath_ResetAct takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	call UnitAddAbility2(u,'A34D')
	call SaveInteger(HY,GetHandleId(u),'DEAT',2)
	call CleanTimer(t)
	set t=null
	set u=null
endfunction

function CheatDeath_Reset takes unit u, real cd returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,cd,false,function CheatDeath_ResetAct)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call UnitRemoveAbility(u,'A34D')
	call UnitRemoveAbility(u,'B0H7')//B0H7 -> Cheat Death
	call SaveInteger(HY,GetHandleId(u),'DEAT',1)
	call IssueImmediateOrder(u,"magicdefense")
	set t=null
endfunction

function CheatDeath_Tick takes nothing returns nothing
	local unit u
	local real dmg
	local real curhp
	local real heal
	local integer lvl
	local trigger t=GetTriggeringTrigger()
	local boolean b=false
	local real maxHP
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		set u=GetTriggerUnit()
		set dmg=GetEventDamage()
		set curhp=GetWidgetLife(u)
		if GetUnitAbilityLevel(u,'A36D')==0 then
			set maxHP=GetUnitState(u,UNIT_STATE_MAX_LIFE)
			if curhp/maxHP>0.2 and curhp>300 then
				if dmg>=curhp/2 and IsDead(u)==false and GetUnitAbilityLevel(u,'B0H7')==1 then//B0H7 -> Cheat Death
					set b=true
					call TextTagOnUnit(GetUnitName(u)+" just Cheated Death!!",5,u,.03,255,0,0,255)
					set lvl=GetUnitAbilityLevel(u,'A34A')//A34A -> Cheat Death
					if dmg>=GetUnitState(u,UNIT_STATE_MAX_LIFE) then
						call CheatDeath_invul(u,dmg*(0.45-0.05*lvl),GetEventDamageSource())
					else
						call HealUnitFor(u,dmg*(0.55+0.05*lvl))
					endif
					call DamageTarget(u,GetEventDamageSource(),3,dmg*(0.55+0.05*lvl))
					call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(u),'h028',GetUnitX(u),GetUnitY(u),AngleBetweenXY(GetUnitX(u),GetUnitY(u),GetUnitX(GetEventDamageSource()),GetUnitY(GetEventDamageSource()))),'BTLF',0.4)//h028 -> Clarity Potion
					call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\DispelMagic\\DispelMagicTarget.mdl",u,"overhead"))
	//				if LoadBoolean(HY,GetHandleId(t),0)==false then
	//					call CheatDeath_Reset(u,14-lvl)
	//				else
	//					call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'A34D')
	//					call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'B0H7')//B0H7 -> Cheat Death
	//					call FlushChildHashtable(HY,GetHandleId(t))
	//					call CleanTrigger(t)
	//				endif
				endif
			elseif b==false and dmg>1000 then
				call HealUnitFor(u,dmg-1000)
			endif
		endif
	else
		
		
	endif
	set u=null
	set t=null
endfunction

function CheatDeath_Learn takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function CheatDeath_Tick))
	call UnitAddAbility2(u,'A34D')
	call SaveBoolean(HY,GetHandleId(t),0,false)
	set t=null
	set u=null
endfunction

function CheatDeath_Use takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
	call CheatDeath_Reset(u,14-lvl)
	call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
	call TriggerRegisterTimerEvent(t,14-lvl,false)
	call TriggerAddCondition(t,Condition(function CheatDeath_Tick))
	call UnitAddAbility2(target,'A34D')
	call SaveUnitHandle(HY,GetHandleId(t),0,target)
	call SaveBoolean(HY,GetHandleId(t),0,true)
	set t=null
	set target=null
	set u=null
endfunction

function CheatDeath_Cast takes nothing returns nothing
	if IsUnitIllusion(GetSpellTargetUnit()) then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),"Can't be used on illusions")
	endif
endfunction

function DK_DragonForm_TailFix takes unit Source returns nothing
	local integer Level=GetUnitAbilityLevel(Source,'A2AI')//A2AI -> Dragon Tail
	call SetUnitAbilityLevel(Source,'A0AR',Level)//A0AR -> Dragon Tail
endfunction

function DragonKnight_DragonTail_Leveling takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A2AI')//A2AI -> Dragon Tail
	if Level==1 then
		call UnitAddAbility2(Source,'A0AR')//A0AR -> Dragon Tail
	endif
	call DK_DragonForm_TailFix(Source)
	set Source=null
endfunction

function DK_DragonTailHit takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
			call StunTargetLoD(GetTriggerUnit(), (LoadReal(HY,h,0)*0.25)+2.25)
			call DamageTarget(LoadUnitHandle(HY,h,1),GetTriggerUnit(),1,25*LoadReal(HY,h,0))
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		endif
	else
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	endif
	set t=null
endfunction

function DK_DragonTail_Stun takes nothing returns nothing
	local trigger t
	local integer h
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A42F')
	if IssueTargetOrder(d,"thunderbolt",target) then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,3.5,false)
		call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(t,Condition(function DK_DragonTailHit))
		call SaveUnitHandle(HY,h,0,d)
		call SaveUnitHandle(HY,h,1,caster)
		call SaveReal(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
		set t=null
	endif
	set d=null
	set caster=null
	set target=null
endfunction

function DK_DragonTail takes nothing returns nothing
	local unit u=GetTriggerUnit()
	if GetUnitTypeId(u)=='H00G' or GetUnitTypeId(u)=='H00F' or GetUnitTypeId(u)=='H00E' then//H00G -> Dragon Knight, H00F -> Dragon Knight, H00E -> Dragon Knight
		call SetUnitAnimation(u,"stand")
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Defend\\DefendCaster.mdl",u,"head"))
	elseif GetUnitTypeId(u)=='Hlgr' then//Hlgr -> Dragon Knight
		call SetUnitAnimation(u,"stand defend")
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Defend\\DefendCaster.mdl",u,"origin"))
	endif
	set u=null
	if IsBlocked(GetSpellTargetUnit())==false then
		call DK_DragonTail_Stun()
	endif
endfunction

function DK_Tail_Preload takes nothing returns nothing
	call PreloadQueryAdd('A0AR')//A0AR -> Dragon Tail
	call PreloadQueryAdd('QB0G')//QB0G -> Dragon Tail
	call HideAbility('A389')
endfunction

function DummyCastWave takes unit u, string order returns nothing
	local unit target=GetSpellTargetUnit()
	local real x
	local real y
	local real a
	local real r=500
	local boolean b=false
	if target!=null then
		if target==GetTriggerUnit() then
			set a=GetUnitFacing(GetTriggerUnit())
		else
			set a=AngleBetweenUnits(u,target)
		endif
	else
		set a=AngleBetweenXY(GetUnitX(u),GetUnitY(u),GetSpellTargetX(),GetSpellTargetY())
	endif
	set x=GetUnitX(u)+r*Cos(a*bj_DEGTORAD)
	set y=GetUnitY(u)+r*Sin(a*bj_DEGTORAD)
	loop
		exitwhen r<20
		if IssuePointOrder(u,order,x,y) then
			set b=true
			exitwhen true
		endif
		set r=r-20.
		set x=GetUnitX(u)+r*Cos(a*bj_DEGTORAD)
		set y=GetUnitY(u)+r*Sin(a*bj_DEGTORAD)
	endloop
	if b==false then
		call IssuePointOrder(u,order,GetSpellTargetX(),GetSpellTargetX())
	endif
	set target=null
	
endfunction

function BreatheFireBonus takes unit u returns nothing
	local integer i=GetUnitAbilityLevel(GetEventDamageSource(),'A3ES')
	if GetUnitAbilityLevel(GetEventDamageSource(),'A3ES')>0 then
		call UnitAddAbilityTimedExF(u,'A3KW'-1+i,1,11,'B387')//B387 -> Breathe Fire
		call UnitMakeAbilityPermanent(u,true,'A3KS'-1+i)
		call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A3KW'-1+i,false)
	endif
endfunction

function DK_BreatheFire takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A3ES')
	call SetUnitAbilityLevel(d,'A3ES',GetUnitAbilityLevel(caster,'A03F'))//A03F -> Breathe Fire
	call DummyDamageTracking(3)
	if GetSpellTargetUnit()==caster then
		call DummyWave(d,"breathoffire",GetUnitX(caster)+1*Cos(bj_DEGTORAD*GetUnitFacing(caster)),GetUnitY(caster)+1*Sin(bj_DEGTORAD*GetUnitFacing(caster)))
	else
		call DummyWave(d,"breathoffire",GetSpellTargetX(),GetSpellTargetY())
	endif
	
	//call DummyCastWave(d,"breathoffire")
	set d=null
	set caster=null
endfunction

function DK_DragonBlood_Act takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A0CL')//A0CL -> Dragon Blood, QP0J -> Dragon Blood
	call SetPlayerTechResearched(GetOwningPlayer(u),'R006',lvl)
	set u=null
endfunction

function DK_DragonForm_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call DK_DragonForm_TailFix(Source)
	call CleanTrigger(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set Source=null
	return false
endfunction

function DK_DragonForm_OnDeath takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call DK_DragonForm_TailFix(Source)
	call CleanTrigger(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set Source=null
	return false
endfunction

function DK_DragonForm_ChangeTail takes nothing returns nothing
	if GetUnitAbilityLevel(tt_unit1,'A0AR')>0 or GetUnitAbilityLevel(tt_unit1,'QB0G')>0 then//A0AR -> Dragon Tail, QB0G -> Dragon Tail
		call DK_DragonForm_TailFix(tt_unit1)
	endif
endfunction

function DK_DragonForm_Act takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.01,false)
	call TriggerAddCondition(t,Condition(function DK_DragonForm_Duration))
	call SaveUnitHandle(HY,h,2,(Source))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function DK_DragonForm_OnDeath))
	call SaveUnitHandle(HY,h,2,(Source))
	set Source=null
	set t=null
endfunction

function Func1889 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit attacker=(LoadUnitHandle(HY,(h),2))
	local unit target=(LoadUnitHandle(HY,(h),17))
	local real r=(LoadReal(HY,(GetHandleId(target)),'A0O4'))//A0O4 -> Corrosive Breath
	local real dmg=20
	call DamageTarget(attacker,target,1,20)
	if(TimerGetElapsed(GlobalTimer))>=r or IsDead(target) then
		call RemoveSavedReal(HY,GetHandleId(target),805)
		call UnitRemoveAbility(target,'A0O4')
		call UnitRemoveAbility(target,'B0O4')
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	endif
	set t=null
	set attacker=null
	set target=null
	return false
endfunction

function ElderDragon_CorrosiveBreath takes unit attacker,unit target returns nothing
	local trigger t
	local integer h
	local real r=(LoadReal(HY,(GetHandleId(target)),'A0O4'))//A0O4 -> Corrosive Breath
	if r>(TimerGetElapsed(GlobalTimer))==false then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddCondition(t,Condition(function Func1889))
		call SaveUnitHandle(HY,(h),2,(attacker))
		call SaveUnitHandle(HY,(h),17,(target))
	endif
	call UnitAddAbility2(target,'A0O4')
	call SaveReal(HY,(GetHandleId(target)),'A0O4',(((TimerGetElapsed(GlobalTimer))+5)*1.0))//A0O4 -> Corrosive Breath
	set t=null
endfunction

function Kaolin_GG_RestorePathing takes nothing returns nothing
	local unit u=GetEnumUnit()
	if GetUnitTypeId(u)!='o01X' then//o01X -> Stone Rock
		call SetUnitPathing(u,true)
	endif
	call SaveInteger(HY,(GetHandleId((u))),(4336),2)
	set u=null
endfunction

function Kaolin_GG_STFU takes unit target returns nothing
	local unit d=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A2TG')
	call SetUnitAbilityLevel(d,'A2TG',KaolinGGTempLvl)
	call IssueTargetOrder(d,"soulburn",target)
	set d=null
endfunction

function Kaolin_GG_StunEnemy takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),KaolinGGTempGroup)==false then
		call GroupAddUnit(KaolinGGTempGroup,GetEnumUnit())
		call Kaolin_GG_STFU(GetEnumUnit())
		if KaolinGGBuffedByStone==1 then
			call DamageTarget(KaolinGGTempUnit,GetEnumUnit(),1,50*KaolinGGTempLvl)
		endif
	endif
endfunction

function Kaolin_GeomagneticGrip_AddEffect takes nothing returns nothing
	local unit u=GetEnumUnit()
	local real angle=(LoadReal(HY,(GetHandleId(u)),801))
	local real speed=(LoadReal(HY,(GetHandleId(u)),802))
	local real newX=KaolinGeoGripTempX+speed*Cos(angle)
	local real newY=KaolinGeoGripTempY+speed*Sin(angle)
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",newX,newY))
	if GetUnitTypeId(u)=='o01X' or GetUnitTypeId(u)=='o020' then//o01X -> Stone Rock
		set KaolinGGBuffedByStone=1
		call SetUnitPosition(u,newX,newY)
		call SetUnitX(u,newX)
		call SetUnitY(u,newY)
	else
		call SetUnitX(u,newX)
		call SetUnitY(u,newY)
		call KillTrees(newX,newY,100)
	endif
	set u=null
endfunction

function Kaolin_GG_RemoveSomeTarget takes nothing returns nothing
	local unit u=GetEnumUnit()
	if IsDead(u) or((LoadInteger(HY,(GetHandleId((u))),(4306)))==1) or GetUnitAbilityLevel(u,'B08V')>0 or((LoadInteger(HY,(GetHandleId((u))),(4335)))==1) then//B08V -> Black Hole
		call GroupRemoveUnit(KaolinGGTempGroup,u)
		call SaveInteger(HY,(GetHandleId((u))),(4336),2)
		if GetUnitTypeId(u)!='o01X' then//o01X -> Stone Rock
			call SetUnitPathing(u,true)
		endif
	endif
	set u=null
endfunction

function Kaolin_GeomagneticGrip_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local group g=(LoadGroupHandle(HY,h,803))
	local real casterX=(LoadReal(HY,h,6))
	local real casterY=(LoadReal(HY,h,7))
	local real targetX=(LoadReal(HY,h,23))
	local real targetY=(LoadReal(HY,h,24))
	local real angle=bj_DEGTORAD*AngleBetweenXY(targetX,targetY,casterX,casterY)
	local real newTX
	local real newTY
	local boolean b=false
	local group gg=(LoadGroupHandle(HY,h,187))
	local group lol3rdgroup
	set KaolinGGBuffedByStone=0
	set KaolinGGTempGroup=g
	call ForGroup(g,function Kaolin_GG_RemoveSomeTarget)
	if GetTriggerEvalCount(t)>200 or FirstOfGroup(g)==null then
		set b=true
	else
		set newTX=targetX+1000*0.03*Cos(angle)
		set newTY=targetY+1000*0.03*Sin(angle)
		if DistanceBetweenXY(newTX,newTY,casterX,casterY)<30 then
			set newTX=casterX
			set newTY=casterY
			set b=true
		endif
		set newTX=SafeX50(newTX)
		set newTY=SafeY50(newTY)
		set KaolinGGTempGroup=g
		set KaolinGeoGripTempX=newTX
		set KaolinGeoGripTempY=newTY
		call ForGroup(g,function Kaolin_GeomagneticGrip_AddEffect)
		call SaveReal(HY,h,23,((newTX)*1.0))
		call SaveReal(HY,h,24,((newTY)*1.0))
		set lol3rdgroup=GetAvailableGroup()
		set tt_unit1=caster
		set KaolinGGTempGroup=gg
		set KaolinGGTempUnit=caster
		set KaolinGGTempLvl=GetUnitAbilityLevel(caster,'A2QI')//A2QI -> Geomagnetic Grip
		call GroupEnumUnitsInRange(lol3rdgroup,newTX,newTY,205,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
		call ForGroup(lol3rdgroup,function Kaolin_GG_StunEnemy)
		call KillGroup(lol3rdgroup)
		set lol3rdgroup=null
	endif
	if b then
		call ForGroup(g,function Kaolin_GG_RestorePathing)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillGroup(gg)
		call KillGroup(g)
	endif
	set caster=null
	set t=null
	set gg=null
	set g=null
	return false
endfunction

function IsStone takes nothing returns boolean
	return GetUnitTypeId(GetFilterUnit())=='o01X' and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(tt_unit1)//o01X -> Stone Rock
endfunction

function Kaolin_GeomagneticGrip_ForGroup takes nothing returns nothing
	local unit u=GetEnumUnit()
	call SetUnitPathing(u,false)
	call SaveInteger(HY,(GetHandleId((u))),(4336),1)
	call SaveReal(HY,(GetHandleId(u)),801,((bj_DEGTORAD*AngleBetweenXY(KaolinGeoGripTempX,KaolinGeoGripTempY,GetUnitX(u),GetUnitY(u)))*1.0))
	call SaveReal(HY,(GetHandleId(u)),802,((DistanceBetweenXY(KaolinGeoGripTempX,KaolinGeoGripTempY,GetUnitX(u),GetUnitY(u)))*1.0))
	set u=null
endfunction

function Kaolin_GeomagneticGrip_Effect takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local trigger t
	local integer h
	local real targetX=GetUnitX(GetSpellTargetUnit())
	local real targetY=GetUnitY(GetSpellTargetUnit())
	local real casterX=GetUnitX(caster)
	local real casterY=GetUnitY(caster)
	local real angle=AngleBetweenXY(casterX,casterY,targetX,targetY)
	local unit target=GetSpellTargetUnit()
	local group g
	if target==null then
		set g=GetAvailableGroup()
		set tt_unit1=caster
		call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),265,Condition(function IsStone))
		if FirstOfGroup(g)==null then
			call KillGroup(g)
			set caster=null
			set g=null
			return
		endif
		set target=FirstOfGroup(g)
		call KillGroup(g)
	endif
	set g=GetAvailableGroup()
	call GroupAddUnit(g,target)
	set targetX=GetUnitX(target)
	set targetY=GetUnitY(target)
	set angle=AngleBetweenXY(casterX,casterY,targetX,targetY)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	set KaolinGeoGripTempX=targetX
	set KaolinGeoGripTempY=targetY
	call ForGroup(g,function Kaolin_GeomagneticGrip_ForGroup)
	set casterX=casterX+100*Cos(angle*bj_DEGTORAD)
	set casterY=casterY+100*Sin(angle*bj_DEGTORAD)
	call TriggerRegisterTimerEvent(t,0.03,true)
	call TriggerAddCondition(t,Condition(function Kaolin_GeomagneticGrip_Duration))
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveReal(HY,h,6,((casterX)*1.0))
	call SaveReal(HY,h,7,((casterY)*1.0))
	call SaveReal(HY,h,23,((targetX)*1.0))
	call SaveReal(HY,h,24,((targetY)*1.0))
	call SaveGroupHandle(HY,h,187,(GetAvailableGroup()))
	call SaveGroupHandle(HY,h,803,(g))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\MagneticGripTarget.mdx",target,"chest")))
	set caster=null
	set t=null
	set g=null
	set target=null
endfunction

function Kaolin_GeomagneticGrip_Cast takes nothing returns nothing
	local unit target=GetSpellTargetUnit()
	local group g
	if target==null then
		set g=GetAvailableGroup()
		set tt_unit1=GetTriggerUnit()
		call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),265,Condition(function IsStone))
		if FirstOfGroup(g)==null then
			call InterruptUnit(GetTriggerUnit())
			if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
				call Error(GetOwningPlayer(GetTriggerUnit()),"No nearby Rock found")
			endif
		endif
		call KillGroup(g)
	endif
	set g=null
	set target=null
endfunction

function Kaolin_RollingBoulder_SlowFilter takes nothing returns boolean
	return IsDead(GetFilterUnit())==false and IsUnitEnemy(KaolinTempRollingCaster,GetOwningPlayer(GetFilterUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),(809)))==1)//
endfunction

function Kaolin_RollingBoulder_SlowApply takes nothing returns nothing
	call UnitAddAbilityTimedEx((GetEnumUnit()),'A2QN',1,2,'B0GK')//B0GK -> Boulder Smash Slow
endfunction

function Kaolin_RollingBoulder_Slow takes unit target returns nothing
	local group g=GetAvailableGroup()
	if((LoadInteger(HY,(GetHandleId((target))),(809)))==1) then
		call GroupEnumUnitsInRange(g,0,0,99999,Condition(function Kaolin_RollingBoulder_SlowFilter))
	endif
	call GroupAddUnit(g,target)
	call ForGroup(g,function Kaolin_RollingBoulder_SlowApply)
	call KillGroup(g)
	set g=null
endfunction

function Kaolin_RollingBoulder_Damage takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),KaolinTempRollingGroup)==false then
		call GroupAddUnit(KaolinTempRollingGroup,GetEnumUnit())
		if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
			set KaolinRollingBoulderTempBool=true
			set KaolinClosestTarget=GetEnumUnit()
			if((LoadInteger(HY,(GetHandleId((GetEnumUnit()))),(809)))==1)then
				set KaolinRollingTempUnit=GetEnumUnit()
			endif
			if KaolinTempRollingBuffed==1 then
				call DamageTarget(KaolinTempRollingCaster,GetEnumUnit(),1,KaolinTempRollingDamage*1.5)
				call Kaolin_RollingBoulder_Slow(GetEnumUnit())
			else
				call DamageTarget(KaolinTempRollingCaster,GetEnumUnit(),1,KaolinTempRollingDamage)
			endif
		else
			if KaolinTempRollingBuffed==1 then
				call DamageTarget(KaolinTempRollingCaster,GetEnumUnit(),1,KaolinTempRollingDamage*1.5)
			else
				call DamageTarget(KaolinTempRollingCaster,GetEnumUnit(),1,KaolinTempRollingDamage)
			endif
		endif
	endif
endfunction

function Kaolin_RollingBoulder_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local group g=(LoadGroupHandle(HY,h,187))
	local group gg
	local unit dummy=(LoadUnitHandle(HY,h,19))//vision only
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local real curX=GetUnitX(caster)
	local real curY=GetUnitY(caster)
	local real distTraveled=DistanceBetweenXY(x,y,curX,curY)
	local real newX
	local real newY
	local real savedAngle=(LoadReal(HY,h,137))
	local real speed=800
	local integer RollingWithStone=(LoadInteger(HY,h,34))
	local real totalTraveled=(LoadReal(HY,h,138))
	local boolean b=false
	local unit target=(LoadUnitHandle(HY,h,810))
	local integer c=GetTriggerEvalCount(t)
	set KaolinRollingBoulderTempBool=false
	call SetUnitTimeScale(caster,3)
	call SetUnitFacing(caster,savedAngle)
	call SetUnitAnimationByIndex(caster,0)
	if c>30 then
		if RollingWithStone==0 then
			set gg=GetAvailableGroup()
			set tt_unit1=caster
			call GroupEnumUnitsInRange(gg,curX,curY,175,Condition(function IsStone))
			if FirstOfGroup(gg)!=null then
				call KillUnit(FirstOfGroup(gg))
				set RollingWithStone=1
				call SaveInteger(HY,h,34,(RollingWithStone))
			endif
			call KillGroup(gg)
		endif
		if RollingWithStone==1 then
			set speed=speed*2
		endif
		if target!=null then
			set savedAngle=AngleBetweenUnits(caster,target)
			call SaveReal(HY,h,137,((savedAngle)*1.0))
		endif
		set newX=x+0.02*speed*Cos(savedAngle*bj_DEGTORAD)
		set newY=y+0.02*speed*Sin(savedAngle*bj_DEGTORAD)
		if IsUnitType(caster,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(caster),99,true)
		endif
		call SetUnitX(caster,SafeX50(newX))
		call SetUnitY(caster,SafeY50(newY))
		call SaveReal(HY,h,6,((GetUnitX(caster))*1.0))
		call SaveReal(HY,h,7,((GetUnitY(caster))*1.0))
		call SetUnitX(dummy,GetUnitX(caster))
		call SetUnitY(dummy,GetUnitY(caster))
		call KillTrees(GetUnitX(caster),GetUnitY(caster),100)
		set distTraveled=DistanceBetweenXY(x,y,GetUnitX(caster),GetUnitY(caster))
		set totalTraveled=totalTraveled+distTraveled
		call SaveReal(HY,h,138,((totalTraveled)*1.0))
		set gg=GetAvailableGroup()
		set tt_unit1=caster
		set KaolinTempRollingCaster=caster
		set KaolinTempRollingGroup=g
		set KaolinTempRollingLvl=GetUnitAbilityLevel(caster,'A2TJ')//A2TJ -> Rolling Boulder
		set KaolinClosestTarget=null
		set KaolinTempRollingDamage=60+30*KaolinTempRollingLvl
		set KaolinTempRollingBuffed=RollingWithStone
		set KaolinRollingTempUnit=null
		if c<40 then
			if c<35 then
				call GroupEnumUnitsInRange(gg,GetUnitX(caster),GetUnitY(caster),RMinIF(100,(c-30)*25),Condition(function DefaultEnemyFilterWithAncientsNonImmune))
			else
				call GroupEnumUnitsInRange(gg,GetUnitX(caster),GetUnitY(caster),125,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
			endif
		else
			call GroupEnumUnitsInRange(gg,GetUnitX(caster),GetUnitY(caster),175,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
		endif
		call GroupEnumUnitsInRange(gg,GetUnitX(caster),GetUnitY(caster),175,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
		call ForGroup(gg,function Kaolin_RollingBoulder_Damage)
		call KillGroup(gg)
		if KaolinRollingTempUnit!=null then
			set gg=GetAvailableGroup()
			set KaolinClosestTarget=null
			set KaolinDistanceTemp=9999
			call GroupEnumUnitsInRange(gg,GetUnitX(KaolinRollingTempUnit),GetUnitY(KaolinRollingTempUnit),625,Condition(function Kaolin_RollingBoulder_SlowFilter))
			call KillGroup(gg)
			if KaolinClosestTarget==null then
				set b=true
				set KaolinClosestTarget=KaolinRollingTempUnit
			else
				set target=KaolinClosestTarget
				call SaveUnitHandle(HY,h,810,(target))
			endif
		endif
	else
		if IsUnitType(caster,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(caster),99,true)
		endif
		call SetUnitX(caster,x)
		call SetUnitY(caster,y)
	endif
	if IsUnitDisabled(caster)or GetTriggerEventId()==EVENT_WIDGET_DEATH or b or(target==null and(c>130 or KaolinRollingBoulderTempBool or(RollingWithStone==0 and totalTraveled>800)or(RollingWithStone==1 and totalTraveled>1600)))then
		call KillUnit(dummy)
		call KillGroup(g)
		call DestroyEffect(LoadEffectHandle(HY,h,5))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SetUnitTimeScale(caster,1)
		if KaolinRollingBoulderTempBool then
			set newX=GetUnitX(KaolinClosestTarget)+50*Cos(savedAngle*bj_DEGTORAD)
			set newY=GetUnitY(KaolinClosestTarget)+50*Sin(savedAngle*bj_DEGTORAD)
			if IsUnitType(caster,UNIT_TYPE_HERO)then
				call SaveBoolean(HeroStats,GetHandleId(caster),99,true)
			endif
			call SetUnitX(caster,SafeX50(newX))
			call SetUnitY(caster,SafeY50(newY))
			call IssueTargetOrder(caster,"attack",KaolinClosestTarget)
		endif
	endif
	set caster=null
	set t=null
	set gg=null
	set g=null
	set dummy=null
	set target=null
	return false
endfunction

function Kaolin_RollingBoulder_Start takes unit caster,unit target returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit d=CreateUnit(GetOwningPlayer(caster),'o01P',GetUnitX(caster),GetUnitY(caster),0)//o01P -> Vision Dummy (1800/800)
	local real angle=AngleBetweenXY(GetUnitX(caster),GetUnitY(caster),GetSpellTargetX(),GetSpellTargetY())
	call SaveEffectHandle(HY,h,5,AddSpecialEffectTarget("war3mapImported\\RollingBoulder.mdx",caster,"origin"))
	call SetUnitTimeScale(caster,3)
	call TriggerRegisterDeathEvent(t,caster)
	call TriggerRegisterTimerEvent(t,0.02,true)
	call TriggerAddCondition(t,Condition(function Kaolin_RollingBoulder_Duration))
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveGroupHandle(HY,h,187,(GetAvailableGroup()))
	call SaveUnitHandle(HY,h,19,(d))
	call SaveReal(HY,h,6,((GetUnitX(caster))*1.0))
	call SaveReal(HY,h,7,((GetUnitY(caster))*1.0))
	call SaveReal(HY,h,137,((angle)*1.0))
	call SaveInteger(HY,h,34,0)
	call SaveReal(HY,h,138,(0*1.0))
	call SaveUnitHandle(HY,h,810,(null))
	if target!=null and GetUnitTypeId(target)=='o01X' then//o01X -> Stone Rock
		call KillUnit(target)
	endif
	set t=null
	set d=null
endfunction

function Kaolin_RollingBoulder_Check takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local real cooldown=(LoadReal(HY,h,442))
	local integer stonesLeft=(LoadInteger(HY,(GetHandleId(caster)),800))
	if GetTriggerEventId()==EVENT_UNIT_SPELL_CAST then
		if(GetSpellAbilityId()=='A2TH')and stonesLeft<=0 then//A2TH -> Stone Caller
			call Error(GetOwningPlayer(caster),"No stones left")
			call InterruptUnit(caster)
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if GetSpellAbilityId()=='A2TH' or GetSpellAbilityId()=='A2TJ' then//A2TH -> Stone Caller, A2TJ -> Rolling Boulder
			if GetSpellAbilityId()=='A2TJ' then//A2TJ -> Rolling Boulder
				call Kaolin_RollingBoulder_Start(caster,null)
			endif
		endif
	elseif stonesLeft<6 then
		set cooldown=cooldown-0.2
		call SaveReal(HY,h,442,((cooldown)*1.0))
		if cooldown<=0.then
			set stonesLeft=stonesLeft+1
			call SaveInteger(HY,(GetHandleId(caster)),800,(stonesLeft))
			call SaveReal(HY,h,442,(25*1.0))
		endif
	endif
	set caster=null
	set t=null
	return false
endfunction

function Kaolin_RollingBoulder_Init takes unit u returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.2,true)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_CAST)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_EFFECT)
	
	call TriggerAddCondition(t,Condition(function Kaolin_RollingBoulder_Check))
	call SaveUnitHandle(HY,h,2,(u))
	call SaveReal(HY,h,442,30.0)//stone recharging time
	call SaveInteger(HY,(GetHandleId(u)),800,6)
	//call UnitAddAbility2(u,Kaolin_StoneChargesIndicator[6])
	set t=null
endfunction

function Kaolin_Stones_DeathAct takes unit deadStone returns nothing
	local unit kaolin=udg_Hero[GetPlayerId(GetOwningPlayer(deadStone))]
	local integer h=GetHandleId(kaolin)
	local integer lvl=GetUnitAbilityLevel(kaolin,'A2TH')//A2TH -> Stone Caller
	local integer alreadyPlaced=(LoadInteger(HY,h,279))
	local integer i=1
	local integer k=1
	local unit tempStone
	loop
		exitwhen i>alreadyPlaced
		set tempStone=(LoadUnitHandle(HY,h,(1400+i)))
		if IsDead(tempStone)==false then
			call SaveUnitHandle(HY,h,(1400+k),(tempStone))
			set k=k+1
		endif
		set i=i+1
	endloop
	set alreadyPlaced=alreadyPlaced-1
	call SaveInteger(HY,h,279,(alreadyPlaced))
	set tempStone=null
	set kaolin=null
endfunction

function Kaolin_Stones_Death takes nothing returns boolean
	if GetUnitTypeId(GetTriggerUnit())=='o01X' then//o01X -> Stone Rock
		call Kaolin_Stones_DeathAct(GetTriggerUnit())
	endif
	return false
endfunction

function Kaolin_Stones_SummonStart takes nothing returns nothing
	local unit newStone
	local unit caster=GetTriggerUnit()
	local integer h=GetHandleId(caster)
	local integer lvl=GetUnitAbilityLevel(caster,'A2TH')//A2TH -> Stone Caller
	local integer alreadyPlaced=(LoadInteger(HY,h,279))
	local unit firstStone=(LoadUnitHandle(HY,h,1401))
	local real x
	local real y
	local integer stonesLeft=(LoadInteger(HY,(GetHandleId(caster)),800))
	if stonesLeft>0 then
		//call UnitRemoveAbility(caster,Kaolin_StoneChargesIndicator[stonesLeft])
		set stonesLeft=IMaxBJ(0,stonesLeft-1)
		if stonesLeft<2 then
			call DisplayTimedTextToPlayer(GetOwningPlayer(caster),0,0,10,I2S(stonesLeft)+" stones left")
		endif
			
		//call UnitAddAbility2(caster,Kaolin_StoneChargesIndicator[stonesLeft])
		call SaveInteger(HY,(GetHandleId(caster)),800,(stonesLeft))
		if GetSpellTargetUnit()==null then
			set x=GetSpellTargetX()
			set y=GetSpellTargetY()
		else
			set x=GetUnitX(GetSpellTargetUnit())
			set y=GetUnitY(GetSpellTargetUnit())
		endif
		set newStone=CreateUnit(GetOwningPlayer(caster),'o01X',x,y,0)//o01X -> Stone Rock
		call SaveInteger(HY,GetHandleId(newStone),4335,0)
		call SaveInteger(HY,GetHandleId(newStone),4340,0)
		call UnitApplyTimedLife(newStone,'BTLF',120)
		call SetUnitPathing(newStone,false)
		set alreadyPlaced=alreadyPlaced+1
		call SaveUnitHandle(HY,h,(1400+alreadyPlaced),(newStone))
		call SaveInteger(HY,h,279,(alreadyPlaced))
		if(alreadyPlaced>6)then
			call KillUnit(firstStone)
		endif
	else
		call Error(GetOwningPlayer(caster),"No stones available")
	endif
	set newStone=null
	set caster=null
	set firstStone=null
endfunction

function Kaolin_Stones_Summon takes nothing returns boolean
	if GetSpellAbilityId()=='A2TH' then//A2TH -> Stone Caller
		call Kaolin_Stones_SummonStart()
	endif
	return false
endfunction

function Kaolin_Stones_Reg takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function Kaolin_Stones_Death))
	set t=null
endfunction

function Kaolin_BoulderSmash_Filter takes nothing returns boolean
	return IsDead(GetFilterUnit())==false and IsUnitEnemy(KaolinTempCaster,GetOwningPlayer(GetFilterUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),(809)))==1)//
endfunction

function Kaolin_BoulderSmash_Helper takes nothing returns nothing
	call StunTargetLoD(GetEnumUnit(),0.25+0.5*KaolinsPushLevelStorage)
endfunction

function Kaolin_BoulderSmash_StunApp takes unit u returns nothing
	local group g=GetAvailableGroup()
	if((LoadInteger(HY,(GetHandleId((u))),(809)))==1) then
		call GroupEnumUnitsInRange(g,0,0,99999,Condition(function Kaolin_BoulderSmash_Filter))
	endif
	call GroupAddUnit(g,u)
	call ForGroup(g,function Kaolin_BoulderSmash_Helper)
	call KillGroup(g)
	set g=null
endfunction

function Kaolin_BoulderSmash_PassThrough takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),Kaolin_PushSmashedGroup)==false then
		call GroupAddUnit(Kaolin_PushSmashedGroup,GetEnumUnit())
		call DamageTarget(KaolinTempCaster,GetEnumUnit(),1,KaolinPushDamage)
		if KaolinTempInteger==1 then
			call Kaolin_BoulderSmash_StunApp(GetEnumUnit())
		endif
		if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) and(LoadInteger(HY,GetHandleId(GetEnumUnit()),809)==1)then
			set KaolinSmashTempUnit=GetEnumUnit()
		endif
	endif
endfunction

function Kaolin_BoulderSmash_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local unit target=(LoadUnitHandle(HY,h,17))
	local real dx=(LoadReal(HY,h,6))
	local real dy=(LoadReal(HY,h,7))
	local real rads
	local real targetX=(LoadReal(HY,h,23))
	local real targetY=(LoadReal(HY,h,24))
	local real newX
	local real newY
	local boolean b=false
	local group g=(LoadGroupHandle(HY,h,187))
	local group gg
	local unit pushed=(LoadUnitHandle(HY,h,810))
	if pushed!=null then
		set dx=GetUnitX(pushed)
		set dy=GetUnitY(pushed)
	endif
	set rads=bj_DEGTORAD*AngleBetweenXY(GetUnitX(target),GetUnitY(target),dx,dy)
	set newX=targetX+1200*0.03*Cos(rads)
	set newY=targetY+1200*0.03*Sin(rads)
	if DistanceBetweenXY(newX,newY,dx,dy)<(5+1200*0.03)then
		set newX=dx
		set newY=dy
		set b=true
	endif
	set newX=SafeX50(newX)
	set newY=SafeY50(newY)
	set Kaolin_PushSmashedGroup=g
	set KaolinTempCaster=caster
	set KaolinsPushLevelStorage=GetUnitAbilityLevel(caster,'A2QM')//A2QM -> Boulder Smash
	set KaolinPushDamage=50*KaolinsPushLevelStorage
	set KaolinSmashTempUnit=null
	if((LoadInteger(HY,(GetHandleId(target)),4306))==1) or GetTriggerEventId()==EVENT_WIDGET_DEATH or GetUnitAbilityLevel(target,'B08V')>0 or((LoadInteger(HY,(GetHandleId(target)),4336))==1) or(pushed==null and GetTriggerEvalCount(t)>200)then//B08V -> Black Hole
		set b=true
	else
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",newX,newY))
		if GetUnitTypeId(target)=='o01X' or GetUnitTypeId(target)=='o020' then//o01X -> Stone Rock
			set KaolinTempInteger=1
			call SetUnitPosition(target,newX,newY)
			call SetUnitX(target,SafeX50(newX))
			call SetUnitY(target,SafeY50(newY))
		else
			set KaolinTempInteger=0
			call SetUnitX(target,SafeX50(newX))
			call SetUnitY(target,SafeY50(newY))
		endif
		call KillTrees(newX,newY,150)
		call SaveReal(HY,h,23,((newX)*1.0))
		call SaveReal(HY,h,24,((newY)*1.0))
		set gg=GetAvailableGroup()
		set tt_unit1=caster
		call GroupEnumUnitsInRange(gg,newX,newY,225,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
		call GroupRemoveUnit(gg,target)
		call ForGroup(gg,function Kaolin_BoulderSmash_PassThrough)
		call KillGroup(gg)
		if KaolinSmashTempUnit!=null and KaolinTempInteger==1 then
			set gg=GetAvailableGroup()
			set KaolinPushedUnit=null
			set KaolinDistanceTemp=9999
			call GroupEnumUnitsInRange(gg,GetUnitX(KaolinSmashTempUnit),GetUnitY(KaolinSmashTempUnit),625,Condition(function Kaolin_BoulderSmash_Filter))
			call KillGroup(gg)
			if KaolinPushedUnit!=null then
				set pushed=KaolinPushedUnit
				call SaveUnitHandle(HY,h,810,(pushed))
				set b=false
			endif
		endif
		set gg=null
	endif
	if b then
		if GetUnitTypeId(target)!='o01X' then//o01X -> Stone Rock
			call SetUnitPathing(target,true)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillGroup(g)
		call SaveInteger(HY,(GetHandleId((target))),(4335),2)
		if GetTriggerEventId()!=EVENT_WIDGET_DEATH then
			if IsPlayerAlly(GetOwningPlayer(caster),GetOwningPlayer(target))==false then
				call DamageTarget(KaolinTempCaster,target,1,KaolinPushDamage)
			endif
		endif
	endif
	set target=null
	set t=null
	set g=null
	set caster=null
	set pushed=null
	return false
endfunction

function Kaolin_BoulderSmash_Start takes nothing returns nothing
	local unit target=GetSpellTargetUnit()
	local unit caster=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real angle
	local real dx
	local real dy
	local real x=GetUnitX(caster)
	local real y=GetUnitY(caster)
	local integer i=-1
	local boolean b=false
	local real pushDistance=400+100*GetUnitAbilityLevel(caster,GetSpellAbilityId())
	local group g
	
	if target==null then
		set g=GetAvailableGroup()
		set tt_unit1=caster
		call GroupEnumUnitsInRange(g,x,y,225,Condition(function IsStone))
		set target=GetClosestOfGroup(g,x,y)
		call KillGroup(g)
		set g=null
		set angle=AngleBetweenXY(GetUnitX(target),GetUnitY(target),GetSpellTargetX(),GetSpellTargetY())
	else
		set angle=AngleBetweenUnits(caster,target)
	endif
	if target==null then
		return
	endif
	
	if GetUnitTypeId(target)=='o01X' then//o01X -> Stone Rock
		set pushDistance=2000
	endif
	loop
		exitwhen b or i==R2I(pushDistance/25)
		set i=i+1
		set dx=SafeX50(GetUnitX(target)+(pushDistance-i*25)*Cos(angle*bj_DEGTORAD))
		set dy=SafeY50(GetUnitY(target)+(pushDistance-i*25)*Sin(angle*bj_DEGTORAD))
		if(IsPointInRegion(RestrictedRegion,((dx)*1.0),((dy)*1.0)))==false then
			set b=true
		endif
	endloop
	call SetUnitPathing(target,false)
	call TriggerRegisterTimerEvent(t,0.03,true)
	call TriggerRegisterDeathEvent(t,target)
	call TriggerAddCondition(t,Condition(function Kaolin_BoulderSmash_Duration))
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveUnitHandle(HY,h,17,(target))
	call SaveReal(HY,h,6,((dx)*1.0))
	call SaveReal(HY,h,7,((dy)*1.0))
	call SaveReal(HY,h,23,((GetUnitX(target))*1.0))
	call SaveReal(HY,h,24,((GetUnitY(target))*1.0))
	call SaveInteger(HY,h,34,0)
	call SaveGroupHandle(HY,h,187,(GetAvailableGroup()))
	call SaveUnitHandle(HY,h,810,(null))
	call SaveInteger(HY,(GetHandleId((target))),(4335),1)
	set target=null
	set caster=null
	set t=null
endfunction

function KaolinGetCloserPeriodic takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,1)
	local integer hu=GetHandleId(u)
	local unit target=LoadUnitHandle(HY,h,0)
	local integer oid=GetUnitCurrentOrder(u)
	if oid!=LoadInteger(HY,h,0) then
		if oid!=851973 then
			call CleanTrigger(t)
			call FlushChildHashtable(HY,h)
			call RemoveSavedHandle(HY,hu,'A2UU')
//			call echo("destroyed cause wrong order "+I2S(oid)+" "+OrderId2String(oid))
		else
			call IssuePointOrderById(u,ORDER_move,GetUnitX(target),GetUnitY(target))
		endif
	else
		if DistanceBetweenUnits(u,target) <= 200 then
			call CleanTrigger(t)
			call FlushChildHashtable(HY,h)
			call RemoveSavedHandle(HY,hu,'A2UU')
//			call echo("destroyed cause reached")
			call IssueTargetOrder(u,"cripple",target)
		endif
	endif
	set target=null
	set u=null
	set t=null
	return false
endfunction

function KaolinGetCloser takes unit u, unit target returns nothing
	local trigger t
	local integer h
	local integer hu=GetHandleId(u)
	if HaveSavedHandle(HY,hu,'A2UU') then
		set t=LoadTriggerHandle(HY,hu,'A2UU')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.02,true)
		call TriggerAddCondition(t,Condition(function KaolinGetCloserPeriodic))
		call SaveTriggerHandle(HY,hu,'A2UU',t)
		call SaveUnitHandle(HY,h,1,u)
	endif
	call IssueTargetOrder(u,"move",target)
	call SaveUnitHandle(HY,h,0,target)
	call SaveInteger(HY,h,0,ORDER_move)
	set t=null
endfunction

function Kaolin_BoulderSmash_OnGround takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local group g=GetAvailableGroup()
	set tt_unit1=u
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),205,Condition(function IsStone))
	if FirstOfGroup(g)==null then
		call InterruptUnit(u)
		if IsUnitType(u,UNIT_TYPE_HERO) then
			call Error(GetOwningPlayer(u),"Invalid Target")
		endif
	endif
	call KillGroup(g)
	set u=null
	set target=null
endfunction

function Kaolin_BoulderSmash_OnTarget takes nothing returns nothing
	if DistanceBetweenUnits(GetTriggerUnit(),GetSpellTargetUnit()) > 200 then
		call KaolinGetCloser(GetTriggerUnit(),GetSpellTargetUnit())
	endif
endfunction

function Kaolin_BoulderSmash_InitSup takes nothing returns nothing
	if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) or IsBlocked(GetSpellTargetUnit())==false then
		call Kaolin_BoulderSmash_Start()
	endif
endfunction

function Kaolin_BoulderSmash_OnCast_Wrap takes nothing returns nothing
	if GetSpellTargetUnit()==null then
		call Kaolin_BoulderSmash_OnGround()
	elseif (DistanceBetweenUnits(GetTriggerUnit(),GetSpellTargetUnit())>170 and GetUnitTypeId(GetSpellTargetUnit())!='n00L') then//n00L -> Roshan
		call Kaolin_BoulderSmash_OnTarget()
	elseif GetUnitTypeId(GetSpellTargetUnit())=='n00L' then//n00L -> Roshan
		call InterruptUnit(GetTriggerUnit())
		if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
			call Error(GetOwningPlayer(GetTriggerUnit()),"Invalid Target")
		endif
	endif
endfunction

function Kaolin_Magnetize_ForNewGroup takes nothing returns nothing
	set KaolinMagnetizeTempVictim=GetEnumUnit()
	call ExecuteFunc("Kaolin_Magnetize_PreStart")
endfunction

function Kaolin_Magnetize_Filter takes nothing returns boolean
	return IsDead(GetFilterUnit())==false and GetUnitTypeId(GetFilterUnit())=='o01X' and((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),(4335)))==1)==false and((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),(4340)))==1)==false//o01X -> Stone Rock
endfunction

function Kaolin_Magnetize_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,2)
	local unit victim=LoadUnitHandle(HY,h,17)
	local real x=GetUnitX(victim)
	local real y=GetUnitY(victim)
	local group g=GetAvailableGroup()
	local integer counter=GetTriggerEvalCount(t)
	local integer lvl=GetUnitAbilityLevel(caster,'A2TI')//A2TI -> Magnetize
	local real TimeLeft=(LoadReal(HY,(GetHandleId(victim)),807))
	if ModuloInteger(counter,5)==0 then
		call DamageTarget(caster,victim,1,(25+25*lvl)/2)
	endif
	set KaolinMagnetizeTempCaster=caster
	set tt_unit1=caster
	call GroupEnumUnitsInRange(g,x,y,325,Condition(function Kaolin_Magnetize_Filter))
	call ForGroup(g,function Kaolin_Magnetize_ForNewGroup)
	call KillGroup(g)
	if(TimerGetElapsed(GlobalTimer))>TimeLeft or IsDead(victim)then
		call SaveInteger(HY,GetHandleId(victim),809,2)
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set caster=null
	set victim=null
	set g=null
	return false
endfunction

function Kaolin_Magnetize_DurationReset takes unit u,unit victim returns nothing
	local trigger t
	local integer h
	local real CurTime=LoadReal(HY,GetHandleId(victim),807)
	call SaveReal(HY,(GetHandleId(victim)),807,(((TimerGetElapsed(GlobalTimer))+6)*1.0))
	if CurTime<(TimerGetElapsed(GlobalTimer))then
		call SaveInteger(HY,(GetHandleId((victim))),809,1)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(u))
		call SaveUnitHandle(HY,h,17,(victim))
		call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\MagnetizeTargetOverhead.mdx",victim,"origin")))
		call TriggerRegisterTimerEvent(t,0.1,true)
		call TriggerAddCondition(t,Condition(function Kaolin_Magnetize_Duration))
	endif
	set t=null
endfunction

function Kaolin_Magnetize_ForGroup takes nothing returns nothing
	call Kaolin_Magnetize_DurationReset(KaolinMagnetizeTempCaster,GetEnumUnit())
endfunction

function Kaolin_Magnetize_Start takes unit u,unit target returns nothing
	local group g=GetAvailableGroup()
	local real x=GetUnitX(target)
	local real y=GetUnitY(target)
	local real aoe=300
	if GetUnitTypeId(target)=='o01X' then//o01X -> Stone Rock
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherMissile\\DemolisherMissile.mdx",GetUnitX(target),GetUnitY(target)))
		call UnitApplyTimedLife(target,'BTLF',5)
		call SaveInteger(HY,(GetHandleId((target))),(4340),1)
		call SetUnitVertexColor(target,0,0,0,100)
		set aoe=600
	else
		call DestroyEffect(AddSpecialEffect("war3mapImported\\MagnetizeCastAoE.mdx",GetUnitX(target),GetUnitY(target)))
	endif
	set tt_unit1=u
	set KaolinMagnetizeTempCaster=u
	set KaolinMagnetizeTempVictim=target
	call GroupEnumUnitsInRange(g,x,y,aoe+25,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	call ForGroup(g,function Kaolin_Magnetize_ForGroup)
	call KillGroup(g)
	set u=null
	set g=null
endfunction

function Kaolin_Magnetize_PreStart takes nothing returns nothing
	call Kaolin_Magnetize_Start(KaolinMagnetizeTempCaster,KaolinMagnetizeTempVictim)
endfunction

function Kaolin_Magnetize_Init takes nothing returns nothing
	call Kaolin_Magnetize_Start(GetTriggerUnit(),GetTriggerUnit())
endfunction

function IsStoneDM takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())=='o01X' then//o01X -> Stone Rock
		call KillUnit(GetFilterUnit())
	endif
	return false
endfunction

function StoneOwnerDeath takes unit u returns nothing
	local group g
	local player p
	if Mode_DM==false or IsUnitType(u,UNIT_TYPE_HERO)==false or LoadBoolean(HY,GetHandleId(u),TEMPEST) then
		return
	endif
	if Mode_DM and GetUnitAbilityLevel(u,'A2TH')>0  then//A2TH -> Stone Caller
		set g=GetAvailableGroup()
		set p=GetOwningPlayer(u)
		call GroupEnumUnitsOfPlayer(g,p,Condition(function IsStoneDM))
		call KillGroup(g)
		set g=null
	endif
endfunction

function Kaolin_Death_End takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call SetUnitAnimationByIndex(LoadUnitHandle(HY,h,2),8)
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function KaolinModel_Death takes nothing returns nothing
	local timer t
	local unit u=GetTriggerUnit()
	if GetUnitTypeId(u)=='N0MU' then//N0MU -> Earth Spirit
		set t=CreateTimer()
		call SetUnitAnimationByIndex(u,7)
		call TimerStart(t,2.5,false,function Kaolin_Death_End)
		call SaveUnitHandle(HY,GetHandleId(t),2,u)
		set t=null
	endif
	set u=null
endfunction

function Oracle_FortunesEnd_Damage takes nothing returns nothing
	call Z48("war3mapImported\\FortunesEndTarget.mdx",GetEnumUnit(),"origin",3)
	call IssueTargetOrder(Oracle_TempDummy,"purge",GetEnumUnit())
	call UnitRemoveAbility(GetEnumUnit(),'A2T4')
	call DamageTarget(Oracle_TempCaster,GetEnumUnit(),1,60+30*Oracle_TempLvl)
endfunction

function Oracle_FortunesEnd_EndCast takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=(LoadUnitHandle(HY,(GetHandleId(caster)),796))
	local real time=RMinIF((TimerGetElapsed(GlobalTimer))-(LoadReal(HY,(GetHandleId(caster)),358)),3)
	local integer lvl=GetUnitAbilityLevel(caster,'A2QT')//A2QT -> Fortune's End
	local integer dummyLevel=R2I(2.0*time)
	local unit dummy=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),GetUnitFacing(caster))//e00E -> Spellcaster
	local unit visionDummy
	local group g
	local integer aid='A594'
	if dummyLevel>3 then
		set aid='A595'
		set dummyLevel=dummyLevel-3
	endif
	if target!=null then
		set visionDummy=CreateUnit(GetOwningPlayer(caster),'o00Z',GetUnitX(target),GetUnitY(target),0)//o00Z -> Vision Dummy 600/600
		call UnitApplyTimedLife(visionDummy,'BTLF',0.5)
		call UnitAddAbility(dummy,aid)
		call SetUnitAbilityLevel(dummy,aid,dummyLevel)
		set tt_unit1=caster
		set Oracle_TempCaster=caster
		set Oracle_TempDummy=dummy
		set Oracle_TempLvl=lvl
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),325,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function Oracle_FortunesEnd_Damage)
		if GetUnitAbilityLevel(target,'A3E9')==1 and IsMagicImmune(caster)==false then
			if IsBlocked(caster)==false then
				call SetUnitOwner(dummy,GetOwningPlayer(target),true)
				call SetUnitX(dummy,GetUnitX(caster))
				call SetUnitY(dummy,GetUnitY(caster))
				set tt_unit1=target
				set Oracle_TempCaster=target
				set Oracle_TempDummy=dummy
				set Oracle_TempLvl=lvl
				call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),325,Condition(function DefaultEnemyFilterWithAncients))
				call ForGroup(g,function Oracle_FortunesEnd_Damage)
			else
				call RemoveLinkenBuff(caster)
			endif
		endif
		call KillGroup(g)
	endif
	set caster=null
	set target=null
	set dummy=null
	set visionDummy=null
	set g=null
endfunction

function Oracle_FortunesEnd_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,14))
	local unit target=(LoadUnitHandle(HY,h,17))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SaveReal(HY,(GetHandleId(caster)),356,((GetUnitX(target))*1.0))
		call SaveReal(HY,(GetHandleId(caster)),357,((GetUnitY(target))*1.0))
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set caster=null
	set target=null
	return false
endfunction

function Oracle_FortunesEnd_OnCast takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit caster=GetTriggerUnit()
	call SaveReal(HY,(GetHandleId(caster)),358,(((TimerGetElapsed(GlobalTimer)))*1.0))
	call SaveUnitHandle(HY,(GetHandleId(caster)),796,(GetSpellTargetUnit()))
	call DestroyEffect(AddSpecialEffect("war3mapImported\\CleanseTargetArea.mdx",GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit())))
	call SaveUnitHandle(HY,h,14,(caster))
	call SaveUnitHandle(HY,h,17,(GetSpellTargetUnit()))
	call TriggerRegisterTimerEvent(t,10,false)
	call TriggerRegisterDeathEvent(t,GetSpellTargetUnit())
	call TriggerAddCondition(t,Condition(function Oracle_FortunesEnd_Duration))
	set t=null
	set caster=null
endfunction

function Oracle_FortunesEnd_Sup takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call SaveBoolean(HY,(GetHandleId(GetTriggerUnit())),360,(true))
	endif
endfunction

function Oracle_FortunesEnd_PreEnd takes nothing returns nothing
	if LoadBoolean(HY,GetHandleId(GetTriggerUnit()),360) then
		call Oracle_FortunesEnd_EndCast()
	endif
endfunction

function Oracle_FortunesEnd_OnCastSup takes nothing returns nothing
	call SaveBoolean(HY,(GetHandleId(GetTriggerUnit())),360,(false))
	call Oracle_FortunesEnd_OnCast()
endfunction

function Oracle_FatesEdict_Amplify takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit target=(LoadUnitHandle(HY,h,17))
	local integer lvl=LoadInteger(HY,h,5)
	local integer c=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if LoadBoolean(HY,h,0)==false then
			call SaveBoolean(HY,h,0,true)
			call DamageTarget(GetEventDamageSource(),GetTriggerUnit(),3,GetEventDamage()*0.5)
//			call echo(R2S(GetEventDamage()*0.5))
			call SaveBoolean(HY,h,0,false)
		endif
	elseif GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveAbility(target,'A2T4')
		call UnitRemoveAbility(target,'A3KE')
		call UnitRemoveAbility(target,'B3KE')
		call UnitRemoveAbility(target,'A3KD')
		call RemoveSavedHandle(HY,GetHandleId(target),'A2T5')
	elseif c > (lvl+2)*10 or GetUnitAbilityLevel(target,'A2T4')==0 then
		//call SaveReal(HY,GetHandleId(target),'AMPL',RMaxIF(LoadReal(HY,GetHandleId(target),'AMPL')-0.5,0))
		//call DestroyEffect((LoadEffectHandle(HY,h,175)))
		//call DestroyEffect((LoadEffectHandle(HY,h,176)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveAbility(target,'A2T4')
		call UnitRemoveAbility(target,'A3KE')
		call UnitRemoveAbility(target,'B3KE')
		call UnitRemoveAbility(target,'A3KD')
		call RemoveSavedHandle(HY,GetHandleId(target),'A2T5')
	else
		set c=c+1
		call SaveInteger(HY,h,0,c)
	endif
	set t=null
	set target=null
	return false
endfunction

function Oracle_FatesEdict_Start takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A2T5')//A2T5 -> Fate's Edict
	local trigger t
	local integer h
	if HaveSavedHandle(HY,GetHandleId(target),'A2T5') then
		set t=LoadTriggerHandle(HY,GetHandleId(target),'A2T5')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,GetHandleId(target),'A2T5',t)
		call TriggerRegisterTimerEvent(t,0.1,true)
		call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
		call TriggerRegisterDeathEvent(t,target)
		call TriggerAddCondition(t,Condition(function Oracle_FatesEdict_Amplify))
		call SaveUnitHandle(HY,h,17,(target))
		call SetPlayerAbilityAvailable(GetOwningPlayer(target),'A2T4',false)
	endif
	call UnitAddAbility2(target,'A3KE')
	call UnitAddAbility2(target,'A3KD')
	call UnitAddAbility2(target,'A2T4')
	call SaveInteger(HY,h,0,0)
	call SaveInteger(HY,h,5,lvl)
	//call SaveReal(HY,GetHandleId(target),'AMPL',LoadReal(HY,GetHandleId(target),'AMPL')+0.5)
	//call SaveEffectHandle(HY,h,175,(AddSpecialEffectTarget("war3mapImported\\FatesEdict.mdx",target,"origin")))
	set caster=null
	set target=null
	set t=null
endfunction

function Oracle_FatesEdict_Sup takes nothing returns nothing
	if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) or IsBlocked(GetSpellTargetUnit())==false then
		call Oracle_FatesEdict_Start()
	endif
endfunction

function Oracle_PurifingFlames_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit target=(LoadUnitHandle(HY,h,17))
	local integer lvl=LoadInteger(HY,h,5)
	local integer counter=(LoadInteger(HY,h,34))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or counter>9*5 or LoadInteger(HY,GetHandleId(target),'A2SG')==0 then
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call SaveInteger(HY,GetHandleId(target),'A2SG',IMaxIF(LoadInteger(HY,GetHandleId(target),'A2SG')-1,0))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set counter=counter+1
		call SaveInteger(HY,h,34,(counter))
		if ModuloInteger(counter,5)==0 then
			call SetWidgetLife(target,GetWidgetLife(target)+11*lvl)
		endif
	endif
	set t=null
	set target=null
	return false
endfunction

function Oracle_PurifingFlames_Start takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A2SG')
	local real dmg=lvl*90
	local real resist=0.75
	call SaveInteger(HY,GetHandleId(target),'A2SG',LoadInteger(HY,GetHandleId(target),'A2SG')+1)
	call TriggerRegisterDeathEvent(t,target)
	call TriggerRegisterTimerEvent(t,0.2,true)
	call TriggerAddCondition(t,Condition(function Oracle_PurifingFlames_Duration))
	call SaveUnitHandle(HY,h,17,(target))
	call SaveInteger(HY,h,5,(lvl))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\DarkMending.mdx",target,"origin")))
	if IsUnitType(target,UNIT_TYPE_HERO)==false then
		set resist=1.0
	endif
	if GetWidgetLife(target)<=dmg*resist and IsUnitAlly(target,GetOwningPlayer(caster)) then
		set dmg=GetWidgetLife(target)/0.75-10
	endif
	call DamageTarget(caster,target,1,dmg)
	set t=null
	set caster=null
	set target=null
endfunction

function Oracle_PurifingFlames_InitSup takes nothing returns nothing
	if IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))==false or IsBlocked(GetSpellTargetUnit())==false then
		call Oracle_PurifingFlames_Start()
	endif
endfunction

function Oracle_FalsePromise_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local unit target=(LoadUnitHandle(HY,h,17))
	local integer instances=(LoadInteger(HY,h,34))
	local integer counter=(LoadInteger(HY,h,25))
	local integer lvl=(LoadInteger(HY,h,5))
	local integer i=0
	local real storedHP=(LoadReal(HY,h,697))
	local real storedMP=(LoadReal(HY,h,811))
	local real curLife=GetWidgetLife(target)
	local real curMana=GetUnitState(target,UNIT_STATE_MAX_LIFE)
	local real TotalHeal=(LoadReal(HY,h,808))
	local real HPHeal
	local real dmg
	local boolean isBalanced=LoadBoolean(HY,h,5)
	local integer limit=lvl+6
	if isBalanced then
		set limit=limit-2
	endif
	if counter>(limit)*50 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call DisableTrigger(t)
		call UnitRemoveAbility(target,'A3KN')
		call UnitRemoveAbility(target,'B3KN')
		if GetTriggerEventId()!=EVENT_WIDGET_DEATH then
			set TotalHeal=TotalHeal*2
			loop
				exitwhen i>instances
				set i=i+1
				set curLife=GetWidgetLife(target)
				set HPHeal=RMinBJ(curMana-curLife,TotalHeal)
				call SetWidgetLife(target,curLife+HPHeal)
				set TotalHeal=TotalHeal-HPHeal
				set dmg=(LoadReal(HY,h,(20000+i)))
				if(LoadUnitHandle(HY,h,(22000+i)))==caster or((LoadInteger(HY,(GetHandleId((target))),(2485)))==1)then
					if GetWidgetLife(target)<=dmg+2 then
						set dmg=GetWidgetLife(target)-2
					endif
				endif
				call DamageTarget((LoadUnitHandle(HY,h,(22000+i))),target,6,dmg)
			endloop
			set curLife=GetWidgetLife(target)
			set HPHeal=RMinBJ(curMana-curLife,TotalHeal)
			call SetWidgetLife(target,curLife+HPHeal)
			set TotalHeal=TotalHeal-HPHeal
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED and IsDamageReal(GetEventDamage())then
		set instances=instances+1
		call SaveInteger(HY,h,34,(instances))
		call SaveUnitHandle(HY,h,(22000+instances),(GetEventDamageSource()))
		call SaveReal(HY,h,(20000+instances),((GetEventDamage())*1.0))
		//call HealUnitFor(target,GetEventDamage())
	elseif GetTriggerEventId()!=EVENT_UNIT_DAMAGED and GetTriggerEventId()!=EVENT_WIDGET_DEATH then
		set counter=counter+1
		call SaveInteger(HY,h,25,(counter))
		if curMana!=storedMP then
			set storedMP=curMana
			set storedHP=curLife
			call SaveReal(HY,h,697,((storedHP)*1.0))
			call SaveReal(HY,h,811,((storedMP)*1.0))
		endif
		if curLife>storedHP then
			if((LoadInteger(HY,(GetHandleId((target))),(4298)))!=1) then
				set TotalHeal=TotalHeal+curLife-storedHP
				call SaveReal(HY,h,808,((TotalHeal)*1.0))
			else
				call SetWidgetLife(target,curLife)
			endif
		endif
		call SetWidgetLife(target,storedHP)
		call RemoveDispellableBuffs(target)
	endif
	set t=null
	set target=null
	set caster=null
	return false
endfunction

function Oracle_FalsePromise_Start takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer lvl=GetUnitAbilityLevel(caster,'A2TF')//A2TF -> False Promise, QB11 -> False Promise
	local boolean isBalanced=false
	call UnitAddAbility2(target,'A3KN')
	call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
	call TriggerRegisterDeathEvent(t,target)
	call TriggerRegisterTimerEvent(t,0.02,true)
	call TriggerAddCondition(t,Condition(function Oracle_FalsePromise_Duration))
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveUnitHandle(HY,h,17,(target))
	call SaveInteger(HY,h,34,0)
	call SaveInteger(HY,h,25,0)
	call SaveInteger(HY,h,5,(lvl))
	call SaveBoolean(HY,h,5,isBalanced)
	call SaveReal(HY,h,808,0.0)
	call SaveReal(HY,h,697,((GetWidgetLife(target))*1.0))
	call SaveReal(HY,h,811,((GetUnitState(target,UNIT_STATE_MAX_LIFE))*1.0))
//	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\FalsePromise.mdx",target,"chest")))
	call RemoveDispellableBuffs(target)
	set caster=null
	set target=null
	set t=null
endfunction


function ES_AS_ForGroup takes nothing returns nothing
	call TriggerRegisterUnitEvent(ES_Aftershock,GetEnumUnit(),EVENT_UNIT_DAMAGED)
	call SaveInteger(HY,GetHandleId(ES_Aftershock),0,LoadInteger(HY,GetHandleId(ES_Aftershock),0)+1)
endfunction

function ES_AS_Group takes unit u returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),500,Condition(function ReturnTrue))
	call ForGroup(g,function ES_AS_ForGroup)
	call KillGroup(g)
	set g=null
endfunction

function ES_Aftershock_Hit takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer c
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
			call StunTargetLoD(GetTriggerUnit(),LoadReal(HY,h,0))
			call DamageTarget(LoadUnitHandle(HY,h,1),GetTriggerUnit(),1,LoadReal(HY,h,1))
			set c=LoadInteger(HY,h,0)
			if c==1 then
				call FlushChildHashtable(HY,h)
				call DestroyTrigger(t)
				set ES_Aftershock=null
			else
				call SaveInteger(HY,h,0,c-1)
			endif
		endif
	else
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
		set ES_Aftershock=null
	endif
	set t=null
endfunction

function Earthshaker_Aftershock_Effect takes unit u, integer lvl returns nothing
	local trigger t
	local integer h
	local unit d
	local real dur
	local real dmg
	if GetUnitAbilityLevel(u,'A36D')==1 then
		return
	endif
	set d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A42H')
	set ES_Aftershock=CreateTrigger()
	set h=GetHandleId(ES_Aftershock)
	call ES_AS_Group(d)
	call TriggerRegisterTimerEvent(ES_Aftershock,0.02,false)
	call TriggerAddCondition(ES_Aftershock,Condition(function ES_Aftershock_Hit))
	call SaveUnitHandle(HY,h,0,d)
	set dur=0.3+0.3*lvl
	set dmg=25+25*lvl
	//if Mode_BO==false then
		call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)*0.95)
	//endif
	call SaveReal(HY, h, 0, dur)
	call SaveReal(HY, h, 1, dmg)
	call SaveUnitHandle(HY,h,1,u)
	set t=null
	call IssueImmediateOrder(d,"stomp")
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",GetUnitX(d),GetUnitY(d)))
	set d=null
endfunction

function Earthshaker_Aftershock_Condition takes unit u, integer spell returns nothing
	local integer level = GetUnitAbilityLevel(u,'A0DJ')+GetUnitAbilityLevel(u,'QF85')//A0DJ -> Aftershock, QF85 -> Aftershock, QP1G -> Aftershock, QP1H -> Aftershock
	if level>0 then
		if BalanceOffSpellChecker(spell) then
			call Earthshaker_Aftershock_Effect(u,level)
		endif
	endif
endfunction

function T8E takes nothing returns nothing
	call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,tt_real1)
	call StunTargetLoD(GetEnumUnit(),tt_int1*0.25+0.75)
endfunction

function ES_Fissure takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local location l=GetSpellTargetLoc()
	local integer i=1
	local real SourceX=GetUnitX(Hero)
	local real SourceY=GetUnitY(Hero)
	local real TargetX
	local real TargetY
	local real x
	local real y
	local real a
	local group g=GetAvailableGroup()
	local group g2=GetAvailableGroup()
	if Target==null then
		set TargetX=GetLocationX(l)
		set TargetY=GetLocationY(l)
	else
		set TargetX=GetUnitX(Target)
		set TargetY=GetUnitY(Target)
	endif
	set a=bj_DEGTORAD*AngleBetweenXY(SourceX,SourceY,TargetX,TargetY)
	call RemoveLocation(l)
	loop
		exitwhen i>22
		set x=SafeX50(SourceX+i*60*Cos(a))
		set y=SafeY50(SourceY+i*60*Sin(a))
		call GroupEnumUnitsInRange(g2,x,y,250,Condition(function LR8))
		call GroupAddGroup(g2,g)
		call GroupClear(g2)
		call B88(CreateDestructable('B000',x,y,GetRandomReal(0,360),.5,GetRandomInt(0,2)),8)//B000 -> Shapeshift
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Volcano\\VolcanoDeath.mdl",x,y))
		set i=i+1
	endloop
	set tt_int1=GetUnitAbilityLevel(Hero,'A0SK')//A0SK -> Fissure
	set tt_real1=tt_int1*50+60
	call ForGroup(g,function T8E)
	call KillGroup(g)
	call KillGroup(g2)
	set g=null
	set g2=null
	set Target=null
	set Hero=null
	set l=null
endfunction

function AfterShock_Orbs_RemoveBuff takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call UnitRemoveAbility(Source,'Broa')//Broa -> Enchant Totem
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function AfterShock_Orbs_Condition takes nothing returns boolean
	local trigger t
	local integer h
	if GetUnitAbilityLevel(GetTriggerUnit(),'Broa')>0 then//Broa -> Enchant Totem
		if IsPoisonArrowSkill(GetSpellAbilityId()) then
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call TriggerRegisterTimerEvent(t,0.1,false)
			call TriggerAddCondition(t,Condition(function AfterShock_Orbs_RemoveBuff))
			call SaveUnitHandle(HY,h,2,(GetTriggerUnit()))
		endif
	endif
	set t=null
	return false
endfunction

function AfterShock_Orbs takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function AfterShock_Orbs_Condition))
	set t=null
endfunction

function EnchantTotemRangedFixAct takes nothing returns nothing
	local timer t=GetExpiredTimer()
	call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'Broa')//Broa -> Enchant Totem
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTimer(t)
	set t=null
endfunction

function EnchantTotemRangedFix takes nothing returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.15,false,function EnchantTotemRangedFixAct)
	call SaveUnitHandle(HY,GetHandleId(t),0,UDSG_Attacker)
	set t=null
endfunction

function ES_EchoSlam_ForGroup takes nothing returns nothing
	local real x=GetUnitX(GetEnumUnit())
	local real y=GetUnitY(GetEnumUnit())
	local integer id=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
	call SetUnitX(EchoSlamDummiesFull[id],x)
	call SetUnitY(EchoSlamDummiesFull[id],y)
	call IssueImmediateOrderById(EchoSlamDummiesFull[id],852526)
endfunction

function ES_EchoSlam_AghanimPart takes nothing returns nothing
	local real x=GetUnitX(GetEnumUnit())
	local real y=GetUnitY(GetEnumUnit())
	local integer id=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
	if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) or IsUnitIllusion(GetEnumUnit()) then
		call SetUnitX(EchoSlamDummiesFull[id],x)
		call SetUnitY(EchoSlamDummiesFull[id],y)
		call IssueImmediateOrderById(EchoSlamDummiesFull[id],852526)
	endif
endfunction

function ES_EchoSlam_Filter takes nothing returns boolean
	return(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) and IsDead(GetFilterUnit())==false)!=null//
endfunction

function EchoSlam_ShareVisionOff takes nothing returns nothing
	call UnitShareVision(GetEnumUnit(),GetOwningPlayer(EchoSlam_Caster),false)
endfunction

function EchoSlam_ShareVision takes nothing returns nothing
	call UnitShareVision(GetEnumUnit(),GetOwningPlayer(EchoSlam_Caster),true)
endfunction

function EchoSlam_ShareVisionTimer takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local group g=LoadGroupHandle(HY,h,0)
	set EchoSlam_Caster=LoadUnitHandle(HY,h,1)
	call ForGroup(g,function EchoSlam_ShareVisionOff)
	call KillGroup(g)
	call CleanTimer(t)
	set g=null
	set t=null
endfunction

function EchoSlam_InitSharingVision takes group g, unit u returns nothing
	local group gg=GetAvailableGroup()
	local timer t=CreateTimer()
	call TimerStart(t,0,false,function EchoSlam_ShareVisionTimer)
	call GroupAddGroup(g,gg)
	call SaveGroupHandle(HY,GetHandleId(t),0,gg)
	call SaveUnitHandle(HY,GetHandleId(t),1,u)
	set gg=null
	set t=null
endfunction

function ES_EchoSlam_Act takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local group g=GetAvailableGroup()
	local integer pid=GetPlayerId(GetOwningPlayer(Source))
	local integer Level=GetUnitAbilityLevel(Source,'A0DH')//A0DH -> Echo Slam
	call Earthshaker_Aftershock_Effect(Source,4)
	if Level==0 then
		set Level=GetUnitAbilityLevel(Source,'A1OB')//A1OB -> Echo Slam
	endif
	set EchoSlamDummiesFull[pid]=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)//e00E -> Spellcaster
	
	call UnitAddAbility(EchoSlamDummiesFull[pid],'A3L6')
	call SetUnitAbilityLevel(EchoSlamDummiesFull[pid],'A3L6',Level)
	call IssueImmediateOrder(EchoSlamDummiesFull[pid],"fanofknives")
	call UnitRemoveAbility(EchoSlamDummiesFull[pid],'A3L6')
	call SetUnitScale(EchoSlamDummiesFull[pid],.25,.25,.25)
	call UnitAddAbility2(EchoSlamDummiesFull[pid],'A0DM')//A0DM -> Echo Slam reverberate
	call SetUnitAbilityLevel(EchoSlamDummiesFull[pid],'A0DM',Level)//A0DM -> Echo Slam reverberate
	set EchoSlam_Caster=Source
	
	call GroupEnumUnitsInRange(g,x,y,1200,Condition(function ES_EchoSlam_Filter))
	call ForGroup(g,function EchoSlam_ShareVision)
	call EchoSlam_InitSharingVision(g,Source)
	
	call GroupEnumUnitsInRange(g,x,y,600,Condition(function ES_EchoSlam_Filter))
	call ForGroup(g,function ES_EchoSlam_ForGroup)
	if GetUnitAbilityLevel(Source,'A1OB')>0 then//A1OB -> Echo Slam
		call ForGroup(g,function ES_EchoSlam_AghanimPart)
	endif
	
	call KillGroup(g)
	set Source=null
	set g=null
endfunction

function ES_EchoSlam_Reg takes nothing returns nothing
	call PreloadQueryAdd('A0DM')//A0DM -> Echo Slam reverberate
	call PreloadQueryAdd('A0SJ')//A0SJ -> Fissure_Stun
endfunction

function TRE takes nothing returns nothing
	local unit Source
	local unit Target
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
		set Source=GetSpellTargetUnit()
		set Target=GetTriggerUnit()
	else
		set Source=GetTriggerUnit()
		set Target=GetAttacker()
	endif
	if IsUnitEnemy(Target,GetOwningPlayer(Source)) and IsUnitType(Target,UNIT_TYPE_STRUCTURE)==false and IsMagicImmune(Target)==false then
		call UnitAddAbilityTimedExF(Target,'A3EK'-1+GetUnitAbilityLevel(Source,'A0DW'),1,4.,'B38B')
	endif
	
	set Source=null
	set Target=null
endfunction

function TQE takes nothing returns boolean
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
		return GetUnitAbilityLevel(GetSpellTargetUnit(),'A0DW')>0 and GetUnitAbilityLevel(GetSpellTargetUnit(),'A36D')==0 //A0DW
	else
		return GetUnitAbilityLevel(GetTriggerUnit(),'A0DW')>0 and GetUnitAbilityLevel(GetTriggerUnit(),'A36D')==0 //A0DW
	endif
endfunction

function KU9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function TQE))
	call TriggerAddAction(t,function TRE)
	set t=null
endfunction

function TSE takes nothing returns boolean
	return((IsUnitAlly(tt_unit1,GetOwningPlayer(GetFilterUnit())) and AliveNonBuildOrMarker(GetFilterUnit()))and GetWidgetLife(GetFilterUnit())!=GetUnitState(GetFilterUnit(),UNIT_STATE_MAX_LIFE))!=null
endfunction

function TTE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer KAE=(LoadInteger(HY,h,28))
	local group g
	local unit MRE
	if KAE>10 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SaveInteger(HY,h,28,(KAE+1))
		set tt_unit1=Source
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),300,Condition(function TSE))
		set MRE=GroupPickRandomUnit(g)
		call KillGroup(g)
		call SetWidgetLife(MRE,GetWidgetLife(MRE)+10)
	endif
	set t=null
	set Source=null
	set g=null
	set MRE=null
	return false
endfunction

function TUE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call AddUnitAnimationProperties(Source,"alternate",false)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function Enchantress_NaturesAttendants takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local integer i=1
	local trigger t
	local integer h
	loop
		exitwhen i>(2+2*GetUnitAbilityLevel(Source,'A01B'))//A01B -> Nature's Attendants
		set t=CreateTrigger()
		call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
		call SaveInteger(HY,(GetHandleId(t)),28,0)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddCondition(t,Condition(function TTE))
		set i=i+1
	endloop
	if GetUnitTypeId(Source)=='E02X' then//E02X -> Grand Magus
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0,false)
		call TriggerAddCondition(t,Condition(function TUE))
		call SaveUnitHandle(HY,h,2,(Source))
		set t=null
	endif
	set t=null
	set Source=null
endfunction

function Ench_Impetus_Hit takes unit attacker, unit target returns nothing
	local real dist=RMinIF(DistanceBetweenXY(GetUnitX(target),GetUnitY(target),GetUnitX(attacker),GetUnitY(attacker)),2500)
	local integer lvl=GetUnitAbilityLevel(attacker,'A0DY')+GetUnitAbilityLevel(attacker,'A1WB')//A0DY -> Impetus, A1WB -> Impetus
	local real d=(.1+.05*lvl)*dist
	local real ls=GetUnitLifesteal(attacker)
	if IsUnitIllusion(target)==false and ls>0 and GetWidgetLife(attacker)>1 then
		call SetWidgetLife(attacker,GetWidgetLife(attacker)+GetEventDamage()*ls)
	else
		call ApplyDesolatorIfHas(attacker,target)
	endif
	call UnitRemoveAbility(target,'B03U')//B03U -> Impetus
	call TextTagOnUnit("+"+I2S(R2I(d)),1,target,.023,3,216,216,216)
	call DamageTarget(attacker,target,7,d)
endfunction

function TLE takes unit u returns boolean
	return IsUnitType(u,UNIT_TYPE_HERO)==false and IsUnitType(u,UNIT_TYPE_ANCIENT)==false and GetUnitTypeId(u)!='n01E' and GetUnitTypeId(u)!='n019'//n01E -> Spiderite, n019 -> Spiderling
endfunction

function T1E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	call UnitRemoveAbility(Target,'Bslo')//Bslo -> Enchant
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Target=null
	return false
endfunction

function T0E takes nothing returns nothing
	local unit Target=GetSpellTargetUnit()
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call ConvertUnitLosingSight(Target)
	call TriggerRegisterTimerEvent(t,.01,false)
	call TriggerAddCondition(t,Condition(function T1E))
	call SaveUnitHandle(HY,h,17,(Target))
	call SetUnitOwner(Target,GetOwningPlayer(Source),true)
	if GetUnitAbilityLevel(Source,'A0A8')==0 then
		call UnitApplyTimedLife(Target,'BTLF',80)
	else
		call UnitApplyTimedLife(Target,'BTLF',180)
		call AddMaxHPFx(Target,100*GetUnitAbilityLevel(Source,'A0A8'))
	endif
	call UnitAddAbility2(Target,'Aeth')//Aeth -> Ghost
	call UnitAddAbility2(Target,'A12G')//A12G -> Marker - Dispellable
	
	call UnitRefillMana(Target)
	set Target=null
	set Source=null
	set t=null
endfunction

function Enchantress_Enchant takes nothing returns nothing
	if TLE(GetSpellTargetUnit())then
		call T0E()
	endif
endfunction

function Enigma_MidnightPulse_OnCast takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit u=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
	call UnitAddAbility(u,'A415')
	if IssuePointOrderById(u,852221,GetSpellTargetX(),GetSpellTargetY())==false then
		call SetUnitX(u,GetUnitX(caster))
		call SetUnitY(u,GetUnitY(caster))
		call UnitResetCooldown(u)
		if IssuePointOrderById(u,852221,GetSpellTargetX(),GetSpellTargetY())==false then
			call InterruptUnit(caster)
			call Error(GetOwningPlayer(caster),"Cannot cast Midnight Pulse here")
		endif
	endif
	call KillUnit(u)
	set caster=null
	set u=null
endfunction

function Enigma_MidnightPulse takes nothing returns nothing
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local unit Source=GetTriggerUnit()
	local real x0=GetUnitX(Source)
	local real y0=GetUnitY(Source)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x0,y0,0)//e00E -> Spellcaster
	call UnitApplyTimedLife(Caster,'BTLF',8)
	call UnitAddAbility(Caster,'A0B2')//A0B2 -> Midnight Pulse effect
	call SetUnitAbilityLevel(Caster,'A0B2',GetUnitAbilityLevel(Source,'A0B1'))//A0B2 -> Midnight Pulse effect, A0B1 -> Midnight Pulse
	if IssuePointOrderById(Caster,852221,x,y)==false then
		
	endif
	set Source=null
	set Caster=null
endfunction

function Enigma_Malefice_Damage takes unit Source,unit Target,integer Level returns nothing
	local real Damage =10+15*Level
	local real stundur=0.25*Level
	call StunTargetLoD(Target,stundur)
	call DamageTarget(Source,Target,1,Damage)
endfunction

function Enigma_Malefice_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Level=(LoadInteger(HY,h,5))
	call Enigma_Malefice_Damage(Source,Target,Level)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function Enigma_Malefice_Act takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t
	local integer h
	local integer Level=GetUnitAbilityLevel(Source,'A0I7')//A0I7 -> Malefice
	call Enigma_Malefice_Damage(Source,Target,Level)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,5,(Level))
	call TriggerRegisterTimerEvent(t,2,false)
	call TriggerAddCondition(t,Condition(function Enigma_Malefice_Duration))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,5,(Level))
	call TriggerRegisterTimerEvent(t,4,false)
	call TriggerAddCondition(t,Condition(function Enigma_Malefice_Duration))
	set t=null
	set Source=null
	set Target=null
endfunction

function Enigma_Malefice_InitSup takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Enigma_Malefice_Act()
	endif
endfunction

function Enigma_DemonicConversion takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local real x=GetUnitX(Target)
	local real y=GetUnitY(Target)
	local integer Level=GetUnitAbilityLevel(Source,'A180')//A180 -> Demonic Conversion
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)//e00E -> Spellcaster
	local integer synergy=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetTriggerPlayer())],'A0A8')
	local integer id='A17Z'//A17Z -> Demonic Conversion
	call SetWidgetLife(Target,1)
	call DamageTarget(Source,Target,2,20)
	call DamageTarget(Source,Target,1,20)
	call DamageTarget(Source,Target,3,20)
	if synergy==1 then
		set id='A3IU'
	elseif synergy<4 then
		set id='A3IV'
	elseif synergy==4 then
		set id='A3IW'
	endif
	call UnitAddAbility2(Caster,id)
	call SetUnitAbilityLevel(Caster,id,Level)
	call IssueImmediateOrderById(Caster,852667)
	set Source=null
	set Target=null
	set Caster=null
endfunction

function Enigma_DemonicConversion_OnCast takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer UHE=GetUnitLevel(Target)
	if GetOwningPlayer(Target)!=Sentinels[0]and GetOwningPlayer(Target)!=Scourges[0] and LoadInteger(UnitStats,GetUnitTypeId(Target),EXP)>88 then
		call InterruptUnit(Hero)
		call Error(GetOwningPlayer(Hero),GetObjectName('n0CX'))//n0CX -> That creature is too powerful.
	endif
	set Hero=null
	set Target=null
endfunction

function UKE takes real x returns real
	local real X38=GetRectMinX(bj_mapInitialPlayableArea)+150
	if(x<X38)then
		return X38
	endif
	set X38=GetRectMaxX(bj_mapInitialPlayableArea)-150
	if(x>X38)then
		return X38
	endif
	return x
endfunction

function UME takes real y returns real
	local real X38=GetRectMinY(bj_mapInitialPlayableArea)+150
	if(y<X38)then
		return X38
	endif
	set X38=GetRectMaxY(bj_mapInitialPlayableArea)-150
	if(y>X38)then
		return X38
	endif
	return y
endfunction

function UNE takes nothing returns boolean//IsPrimalSplitUnit
	return(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or IsPrimalSplitUnit(GetUnitTypeId(GetFilterUnit()))or IsUnitSpiritBear(GetFilterUnit())or GetUnitTypeId(GetFilterUnit())=='n00U' or GetUnitTypeId(GetFilterUnit())=='n00Y' or GetUnitTypeId(GetFilterUnit())=='n00Z' or GetUnitTypeId(GetFilterUnit())=='n0KU' or GetUnitTypeId(GetFilterUnit())=='n0KV' or GetUnitTypeId(GetFilterUnit())=='n0KW' or IsFamiliarId(GetUnitTypeId(GetFilterUnit())))and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer((LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),318)))))!=null//, n00U -> Infernal, n00Y -> Infernal, n00Z -> Infernal, n0KU -> Infernal, n0KV -> Infernal, n0KW -> Infernal
endfunction

function UOE takes nothing returns nothing
	local location uloc=GetUnitLoc(GetEnumUnit())
	local location bhloc=GetUnitLoc(LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),318))
	local location destloc=S38(bhloc,DistanceBetweenPoints(bhloc,uloc)-2,AngleBetweenPoints(bhloc,uloc))
	local integer dadl=4
	local real dmg=0
	if GetUnitAbilityLevel(BlackholeCaster,'A30L')>0 and AghBlackHoleDamage then//A30L -> Black Hole
		set AghBlackHoleDamage=false
		set dmg=GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)/100*(dadl+3)
		call DamageTarget(BlackholeCaster,GetEnumUnit(),7,dmg)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayTarget.mdl",GetEnumUnit(),"origin"))
	endif
	call SetUnitFacing(GetEnumUnit(),AngleBetweenPoints(bhloc,uloc))
	call SetUnitPositionLoc(GetEnumUnit(),destloc)
	call RemoveLocation(uloc)
	call RemoveLocation(bhloc)
	call RemoveLocation(destloc)
	set uloc=null
	set bhloc=null
	set destloc=null
endfunction

function USE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local group g
	local integer h=GetHandleId(t)
	local unit bh=LoadUnitHandle(HY,h,318)
	local unit Caster
	local real x
	local real y
	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and (GetSpellAbilityId()=='A1BX' or GetSpellAbilityId()=='A30L') then//A1BX -> Black Hole, A30L -> Black Hole
		call KillUnit(bh)
		set Caster=LoadUnitHandle(HY,h,19)
		call UnitApplyTimedLife(LoadUnitHandle(HY,h,250),'BTLF',1)
		call UnitApplyTimedLife(LoadUnitHandle(HY,h,251),'BTLF',1)
		call UnitApplyTimedLife(LoadUnitHandle(HY,h,252),'BTLF',1)
		call UnitApplyTimedLife(LoadUnitHandle(HY,h,253),'BTLF',1)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(Caster)
	elseif GetTriggerEvalCount(t)>90 then
		set Caster=LoadUnitHandle(HY,h,19)
		call UnitApplyTimedLife(LoadUnitHandle(HY,h,250),'BTLF',1)
		call UnitApplyTimedLife(LoadUnitHandle(HY,h,251),'BTLF',1)
		call UnitApplyTimedLife(LoadUnitHandle(HY,h,252),'BTLF',1)
		call UnitApplyTimedLife(LoadUnitHandle(HY,h,253),'BTLF',1)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(bh)
		call KillUnit(Caster)
		call InterruptUnit(LoadUnitHandle(HY,h,2))
	else
		set x=GetUnitX(bh)
		set y=GetUnitY(bh)
		set BlackholeCaster=LoadUnitHandle(HY,h,2)
		set AghBlackHoleDamage=GetTriggerEvalCount(t)==20 or GetTriggerEvalCount(t)==40 or GetTriggerEvalCount(t)==60 or GetTriggerEvalCount(t)==80
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,x,y,445,Condition(function UNE))
		call ForGroup(g,function UOE)
		call KillGroup(g)
	endif
	set Caster=null
	set bh=null
	set t=null
	set g=null
	return false
endfunction

function Enigma_BlackHole takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)//e00E -> Spellcaster
	local unit bh=CreateUnit(GetOwningPlayer(Source),'u004',x,y,0)//u004 -> Black Hole
	call SetUnitAbilityLevel(bh,'A0C0',GetUnitAbilityLevel(Source,'A1BX')+GetUnitAbilityLevel(Source,'A30L'))//A0C0 -> Tidal Forces, A1BX -> Black Hole, A30L -> Black Hole
	if IsScourge(GetOwningPlayer(Source))then
		call UnitAddAbility2(Caster,'A0X4')//A0X4 -> Blackhole effect - scourge
	else
		call UnitAddAbility2(Caster,'A0X3')//A0X3 -> Blackhole effect - sent
	endif
	call IssuePointOrderById(Caster,852473,x,y)
	call SaveUnitHandle(HY,h,19,Caster)
	call SaveUnitHandle(HY,h,250,CreateUnit(GetOwningPlayer(Source),'h06R',x,y,0))//h06R -> Blackhole Shadow
	call SaveUnitHandle(HY,h,251,CreateUnit(GetOwningPlayer(Source),'h06R',x,y,0))//h06R -> Blackhole Shadow
	call SaveUnitHandle(HY,h,252,CreateUnit(GetOwningPlayer(Source),'h06R',x,y,0))//h06R -> Blackhole Shadow
	call SaveUnitHandle(HY,h,253,CreateUnit(GetOwningPlayer(Source),'h06R',x,y,0))//h06R -> Blackhole Shadow
	call SaveUnitHandle(HY,h,318,bh)
	call SaveUnitHandle(HY,h,2,Source)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function USE))
	set Source=null
	set bh=null
	set t=null
	set Caster=null
endfunction

function Enigma_BlackHole_OnCast takes nothing returns nothing
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	if(x!=UKE(x)and y!=UME(y))or RectContainsCoords(IA,x,y)or RectContainsCoords(OA,x,y)or RectContainsCoords(BA,x,y)or RectContainsCoords(CA,x,y)or RectContainsCoords(DA,x,y)or RectContainsCoords(EA,x,y)then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),"Cannot cast Blackhole here")
	endif
endfunction

function KV9 takes nothing returns nothing
	call PreloadQueryAdd('A0C0')//A0C0 -> Tidal Forces
endfunction

function UXE takes nothing returns nothing
	call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,tt_real1)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\StaffOfPurification\\PurificationTarget.mdx",GetEnumUnit(),"chest"))
endfunction

function Puck_WaningRift takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit Hero=GetTriggerUnit()
	local real x=GetUnitX(Hero)
	local real y=GetUnitY(Hero)
	local integer Level=GetUnitAbilityLevel(Hero,'A0SC')//A0SC -> Waning Rift
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',x,y,0)//e00E -> Spellcaster
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\StaffOfPurification\\PurificationCaster.mdx",x,y))
	call UnitAddAbility2(Caster,'A0SD')//A0SD -> Silence
	call SetUnitAbilityLevel(Caster,'A0SD',Level)//A0SD -> Silence
	call IssuePointOrderById(Caster,852592,x,y)
	set tt_real1=Level*60+40
	call GroupEnumUnitsInRange(g,x,y,425,Condition(function LS8))
	call ForGroup(g,function UXE)
	call KillGroup(g)
	set Caster=null
	set g=null
	set Hero=null
endfunction

function Puck_DreamCoilUpg_UnleashStun takes unit u, integer lvl returns nothing
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A42T')
	call SetUnitAbilityLevel(d,'A42T',lvl)
	call IssueTargetOrder(d,"thunderbolt",u)
	set d=null
endfunction

function Puck_DreamCoil_SnappingBackDur takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local integer Level
	local unit Target
	local real x1
	local real y1
	local real d
	local real a
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set Target=(LoadUnitHandle(HY,h,17))
		set d=(LoadReal(HY,h,138))
		set x=(LoadReal(HY,h,6))
		set y=(LoadReal(HY,h,7))
		set a=(LoadReal(HY,h,137))
		set x1=GetUnitX(Target)+d/ 15*Cos(a)
		set y1=GetUnitY(Target)+d/ 15*Sin(a)
		call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
		call SetUnitPosition(Target,x1,y1)
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",x1,y1))
		if GetTriggerEvalCount(t)>15 then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
		set Target=null
	endif
	set t=null
	set Target=null
	return false
endfunction

function Puck_DreamCoil_SnappingBackInit takes unit Target, unit center returns nothing
	local trigger t
	local integer h
	if IsUnitInvulnerable(Target) then
		return
	endif
	set t = CreateTrigger()
	set h = GetHandleId(t)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterTimerEvent(t,.025,true)
	call TriggerAddCondition(t,Condition(function Puck_DreamCoil_SnappingBackDur))
	call SaveReal(HY,h,6,GetUnitX(center))
	call SaveReal(HY,h,7,GetUnitY(center))
	call SaveReal(HY,h,138,DistanceBetweenXY(GetUnitX(center),GetUnitY(center),GetUnitX(Target),GetUnitY(Target)))
	call SaveReal(HY,h,137,Atan2(GetUnitY(center)-GetUnitY(Target),GetUnitX(center)-GetUnitX(Target)))
	call SaveUnitHandle(HY,h,17,(Target))
	set t=null
endfunction

function UAE takes unit Source,unit Target,integer Level,integer A5D returns nothing
	if A5D==1 then
		call DamageTarget(Source,Target,1,Level*50+50)
		call StunTargetLoD(Target,.75+.75*Level)
	else
		call DamageTarget(Source,Target,1,Level*50+150)
		call Puck_DreamCoilUpg_UnleashStun(Target,Level)
	endif
endfunction

function UBE takes unit Source,unit Target returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A0SF')//A0SF -> PrismaticPrison_Ministun
	call IssueTargetOrderById(Caster,852095,Target)
	set Caster=null
endfunction

function UCE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Level=(LoadInteger(HY,h,5))
	local integer A5D=(LoadInteger(HY,h,152))
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=LoadUnitHandle(HY,h,30)
	local lightning ZQ8=(LoadLightningHandle(HY,h,196))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		if A5D==2 and GetTriggerUnit()==Source then
			call Puck_DreamCoil_SnappingBackInit(Target,Source)
		endif
		call DestroyLightning(ZQ8)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call MoveLightning(ZQ8,true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
		if DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))>600 then
			call DestroyLightning(ZQ8)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call UAE(Source,Target,Level,A5D)
			if A5D==2 then
				call Puck_DreamCoil_SnappingBackInit(Target,Source)
			endif
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set ZQ8=null
	return false
endfunction

function U3E takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local lightning ZQ8=AddLightning("HWPB",true,GetUnitX(EV8),GetUnitY(EV8),GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()))
	call SetLightningColor(ZQ8,0,.7,1,1)
	call SaveLightningHandle(HY,h,196,(ZQ8))
	call SaveUnitHandle(HY,h,2,(EV8))
	call SaveUnitHandle(HY,h,30,((GetEnumUnit())))
	call SaveInteger(HY,h,5,(ER8))
	call SaveInteger(HY,h,152,(ES8))
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerRegisterDeathEvent(t,GetEnumUnit())
	call TriggerRegisterDeathEvent(t,EV8)
	call TriggerAddCondition(t,Condition(function UCE))
	call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,ET8)
	call UBE(GetTriggerUnit(),GetEnumUnit())
	set t=null
	set ZQ8=null
endfunction

function Puck_DreamCoil_Filter takes nothing returns boolean
  return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and AliveNonBuildOrMarker(GetFilterUnit()) and (IsUnitIllusion(GetFilterUnit()) or IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO))
endfunction

function Puck_DreamCoil takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00U',x,y,0)//e00U -> Prismatic Prison
	local group g=GetAvailableGroup()
	local integer Level=GetUnitAbilityLevel(Hero,'A0S8')//A0S8 -> Dream Coil
	local real DP9=6
	local integer A5D=1
	if Level==0 then
		set Level=GetUnitAbilityLevel(Hero,'A1QP')//A1QP -> Dream Coil
		set DP9=8
		set A5D=2
	endif
	call SetUnitAnimation(Caster,"channel")
	call BW8(Caster,DP9)
	set EV8=Caster
	set ET8=Level*50+50
	set ER8=Level
	set ES8=A5D
	set tt_unit1=Hero
	call GroupEnumUnitsInRange(g,x,y,400,Condition(function Puck_DreamCoil_Filter))
	call ForGroup(g,function U3E)
	call KillGroup(g)
	set g=null
	set Caster=null
	set Hero=null
endfunction

function U1E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer Level
	local integer KAE
	local integer d
	if(GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER and GetIssuedOrderId()!=852514)or GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SetUnitInvulnerable(Hero,false)
		call UnitRemoveAbility(Hero,'A04R')//
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set Level=(LoadInteger(HY,h,5))
		set d=3*Level
		if Level==4 then
			set d=d+1
		endif
		set KAE=(LoadInteger(HY,h,28))+1
		call SaveInteger(HY,h,28,(KAE))
		if KAE>d or DistanceBetweenXY(GetUnitX(Hero),GetUnitY(Hero),(LoadReal(HY,h,6)),(LoadReal(HY,h,7)))>125 then
			call SetUnitInvulnerable(Hero,false)
			call UnitRemoveAbility(Hero,'A04R')//
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set Hero=null
	return false
endfunction

function Puck_Phaseshift_Delay takes nothing returns nothing
	local timer t = GetExpiredTimer()

	call UnitAddAbility(LoadUnitHandle(MHT,GetHandleId(t),0),'A04R')//

	call Timer_End(t)
	set t = null
endfunction

function U0E takes nothing returns nothing
	local timer time = CreateTimer()
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)

	//delay the adding of the marker ability so other spells can detect phase shift
	call SaveUnitHandle(MHT,GetHandleId(time),0,Hero)
	call TimerStart(time,0,false,function Puck_Phaseshift_Delay)

	call SetUnitInvulnerable(Hero,true)

	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Hero,'A0SB')))//A0SB -> Phase Shift
	call SaveInteger(HY,h,28,0)
	call SaveReal(HY,h,6,((GetUnitX(Hero))*1.))
	call SaveReal(HY,h,7,((GetUnitY(Hero))*1.))
	call TriggerRegisterTimerEvent(t,.25,true)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_ORDER)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerAddCondition(t,Condition(function U1E))
	call AddTimedKeyToUnit(Hero,4266,5.9)
	set t=null
	set Hero=null
	set time=null
endfunction

function LE2 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	call IssueImmediateOrderById(Hero,852516)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	return false
endfunction

function LF2 takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,14,(Hero))
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function LE2))
	set t=null
	set Hero=null
endfunction

function U5E takes nothing returns boolean
	if GetIssuedOrderId()==852514 and IsUnitIllusion(GetTriggerUnit())==false and((LoadInteger(HY,GetHandleId(GetTriggerUnit()),4266))!=1)then
		call U0E()
	elseif GetIssuedOrderId()==852515 then
		call LF2()
	endif
	return false
endfunction

function Puck_PhaseShift_Init takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
	call TriggerAddCondition(t,Condition(function U5E))
	set t=null
endfunction

function U2E takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),DK)==false then
		call GroupAddUnit(DK,GetEnumUnit())
		call DamageTarget(tt_unit1,GetEnumUnit(),1,tt_real1)
	endif
endfunction

function V4E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local group g=(LoadGroupHandle(HY,h,22))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local integer Level=(LoadInteger(HY,h,5))
	local real a=(LoadReal(HY,h,13))
	local unit Source=(LoadUnitHandle(HY,h,14))
	local group V7E
	local real x
	local real y
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		if GetUnitTypeId(Source)=='e00E' then//e00E -> Spellcaster
			set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
		endif
		set tt_unit1=CreateUnit(GetOwningPlayer(Caster),'h06O',GetUnitX(Source),GetUnitY(Source),0)//h06O -> Illusory Orb
		call SetUnitScale(tt_unit1,2.5,2.5,2.5)
		call KillUnit(tt_unit1)
		call SetUnitPosition(Source,GetUnitX(Caster),GetUnitY(Caster))
		call ShowUnit(Source,false)
		call ShowUnit(Source,true)
		call SelectUnitAddForPlayer(Source,GetOwningPlayer(Source))
		set EW8[GetPlayerId(GetOwningPlayer(Caster))]=null
		call KillGroup(g)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEvalCount(t)>120 then
		set EW8[GetPlayerId(GetOwningPlayer(Caster))]=null
		call KillGroup(g)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SetUnitScale(Caster,2.5,2.5,2.5)
		call KillUnit(Caster)
	else
		set x=GetUnitX(Caster)
		set y=GetUnitY(Caster)
		set V7E=GetAvailableGroup()
		set DK=g
		set tt_unit1=Caster
		set tt_real1=Level*70
		call GroupEnumUnitsInRange(V7E,x,y,250,Condition(function LA8))
		call ForGroup(V7E,function U2E)
		call KillGroup(V7E)
		call SetUnitX(Caster,SafeX50(x+16.25*Cos(a*bj_DEGTORAD)))
		call SetUnitY(Caster,SafeY50(y+16.25*Sin(a*bj_DEGTORAD)))
	endif
	set t=null
	set g=null
	set V7E=null
	set Caster=null
	set Source=null
	return false
endfunction

function Puck_IllusoryOrb takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local group g=GetAvailableGroup()
	local unit Hero=GetTriggerUnit()
	local real x1=GetUnitX(Hero)
	local real y1=GetUnitY(Hero)
	local real x2=GetSpellTargetX()
	local real y2=GetSpellTargetY()
	local real a=AngleBetweenXY(x1,y1,x2,y2)
	local integer Level=GetUnitAbilityLevel(Hero,'A0S9')//A0S9 -> Illusory Orb
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'h06O',x1,y1,a)//h06O -> Illusory Orb
	call PlaySoundAtPos(KC,x1,y1)
	call UnitAddAbility2(GetTriggerUnit(),'A0SA')//A0SA -> Ethereal Jaunt
	set EW8[GetPlayerId(GetOwningPlayer(Hero))]=Caster
	call SetUnitScale(Caster,3.5,3.5,3.5)
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveInteger(HY,h,5,(Level))
	call SaveGroupHandle(HY,h,22,(g))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveUnitHandle(HY,h,14,(Hero))
	call TriggerRegisterTimerEvent(t,.025,true)
	call TriggerRegisterDeathEvent(t,Caster)
	call TriggerAddCondition(t,Condition(function V4E))
	set t=null
	set Caster=null
	set g=null
	set Hero=null
endfunction

function Puck_EtherealJaunt takes nothing returns nothing
	local integer i=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
	if EW8[i]==null then
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n037'))//n037 -> Illusory Orb not found
	else
		call SetUnitScale(EW8[i],2.5,2.5,2.5)
		call KillUnit(EW8[i])
	endif
endfunction

function VFE takes nothing returns nothing
	call SetUnitX(GetEnumUnit(),EX8)
	call SetUnitY(GetEnumUnit(),EY8)
endfunction

function Prophet_Sprout takes nothing returns nothing
	local destructable array dx
	local integer VT8
	local integer VU8
	local fogmodifier VHE
	local unit Caster=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local location PKE
	local real x
	local real y
	local group g=GetAvailableGroup()
	if Target==null then
		set PKE=GetSpellTargetLoc()
	else
		set PKE=GetUnitLoc(Target)
	endif
	set x=GetLocationX(PKE)
	set y=GetLocationY(PKE)
	set EX8=x
	set EY8=y
	if IsUnitAlly(Caster,GetOwningPlayer(Target)) or IsBlocked(GetSpellTargetUnit())==false then
		set tt_unit1=Caster
		call GroupEnumUnitsInRange(g,x,y,150,Condition(function DefaultEnemyFilterWithAncients))
		call A28(CreateFogModifierRadiusLocBJ(true,GetOwningPlayer(Caster),FOG_OF_WAR_VISIBLE,PKE,1000.),2+GetUnitAbilityLevel(Caster,'A21E'))//A21E -> Sprout
		set VT8=1
		set VU8=8
		loop
			exitwhen VT8>VU8
			call B88(CreateDestructableLoc('B005',S38(PKE,150.,(I2R(VT8)*45.)),GetRandomReal(0,360),1,0),2+GetUnitAbilityLevel(Caster,'A21E'))//B005 -> Haste, A21E -> Sprout
			set VT8=VT8+1
		endloop
	endif
	call RemoveLocation(PKE)
	call ForGroup(g,function VFE)
	call KillGroup(g)
	set VHE=null
	set Caster=null
	set Target=null
	set PKE=null
	set g=null
endfunction

function Prophet_NaturesWrath_OnCast takes nothing returns nothing
	if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))and(LoadBoolean(HY,(GetHandleId(GetOwningPlayer(GetSpellTargetUnit()))),139))then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))//n038 -> This target has disablehelp on
	endif
endfunction

function VME takes unit Source,real x,real y returns nothing
	local unit u=CreateUnit(GetOwningPlayer(Source),'efon',x,y,0)//efon -> Treant
	call UnitApplyTimedLife(u,'BEfn',60)//BEfn -> Force of Nature
	call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\NightElf\\EntBirthTarget\\EntBirthTarget.mdl",u,"origin"))
	//call SetUnitVertexColor(u,175,255,175,175)
	call SetUnitFlyHeight(u,0,0)
	set u=null
endfunction

function ForceOfNatureEntering takes unit u returns nothing
	local integer i=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A0A8')
	if i>0 then
		call UnitAddAbility3(u,'A3IN',i)
		call UnitAddAbility2(u,'AId1'-1+i)
	endif
endfunction

function TreeHasBecomeAlive_RemoveFlag takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local destructable d=LoadDestructableHandle(HY,GetHandleId(t),0)
	call RemoveSavedBoolean(MHT,GetHandleId(d),'0FON')
	call PauseTimer(t)
	call DestroyTimer(t)
	set d=null
	set t=null
endfunction

function ThisTreeHasBecomeAlive takes destructable d returns nothing
	local timer t=CreateTimer()
	call SaveBoolean(MHT,GetHandleId(d),'0FON',true)
	call SaveDestructableHandle(HY,GetHandleId(t),0,d)
	call TimerStart(t,5,false,function TreeHasBecomeAlive_RemoveFlag)
	set t=null
endfunction

function VOE takes nothing returns nothing
	if(IsValidTree(GetEnumDestructable())or GetDestructableTypeId(GetEnumDestructable())=='B005')and EZ8<=EA8 and (GetDestructableLife(GetEnumDestructable())>0 or (ForceOfNatureMC and LoadBoolean(MHT,GetHandleId(GetEnumDestructable()),'0FON'))) then//B005 -> Haste
		set EZ8=EZ8+1
		call VME(GetTriggerUnit(),ForceOfNatureX,ForceOfNatureY)
		if not ForceOfNatureMC then
			call ThisTreeHasBecomeAlive(GetEnumDestructable())
			call KillDestructable(GetEnumDestructable())
		endif
	elseif EZ8>EA8 then
		call KillDestructable(GetEnumDestructable())
	endif
endfunction

function Furion_ForceOfNature takes nothing returns nothing
	local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A333')//A333 -> Force of Nature
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real d=75+75*Level+25
	local rect r=Rect(x-d,y-d,x+d,y+d)
	set ForceOfNatureX=x
	set ForceOfNatureY=y
	set ForceOfNatureMC=GetUnitTypeId(GetTriggerUnit())=='e00E'//e00E -> Spellcaster
	set EZ8=0
	set EA8=Level
	call EnumDestructablesInRect(r,Condition(function ReturnTrue),function VOE)
	call RemoveRect(r)
	set ForceOfNatureMC=false
	set r=null
endfunction

function VKE takes nothing returns nothing
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(GetTriggerUnit()))then
		call PingMinimapEx(x,y,3,255,255,255,false)
	endif
	call DestroyEffect(AddSpecialEffect("war3mapImported\\FurionTeleportTarget.mdx",x,y))
	call DestroyEffect(AddSpecialEffect("war3mapImported\\FurionTeleportTarget.mdx",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
endfunction

function VQE takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local real d=DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),E38,E68)
	if d<EC8 and IsUnitVisibleLoD(Target,GetOwningPlayer(EL8)) then
		set EB8=GetEnumUnit()
		set EC8=d
	endif
	set Target=null
endfunction

function Prophet_WrathOfNature takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A1W8')//A1W8 -> Wrath of Nature
	local integer A38='A07X'//A07X -> Wrath of Nature
	local group g
	local unit Caster
	call DummyDamageTracking(13)
	if Level==0 then
		set Level=GetUnitAbilityLevel(GetTriggerUnit(),'A1W9')//A1W9 -> Wrath of Nature upgrade
		set A38='A0AL'//A0AL -> Wrath of Nature
	endif
	if Target==null then
		set EB8=null
		set EL8=Source
		set EC8=999999
		set E38=GetSpellTargetX()
		set E68=GetSpellTargetY()
		set tt_unit1=Source
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,0,0,9999,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function VQE)
		call KillGroup(g)
		set Target=EB8
		set g=null
	endif
	if Target!=null then
		set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
		call UnitAddAbility2(Caster,A38)
		call SetUnitAbilityLevel(Caster,A38,Level)
		call IssueTargetOrderById(Caster,852119,Target)
		set Caster=null
	endif
	set Source=null
	set Target=null
endfunction

function WrathOfNatureKills takes nothing returns nothing
	if LoadInteger(HY,GetHandleId(ADSG_Victim),'A3JO')>0 then
		if IsUnitType(ADSG_Victim,UNIT_TYPE_HERO) then
			call UnitApplyTimedLife(CreateUnit(Player(LoadInteger(HY,GetHandleId(ADSG_Victim),'A3JO')),'efo2',GetUnitX(ADSG_Victim),GetUnitY(ADSG_Victim),0),'BEfn',60)//efo2 -> Mega Treant, BEfn -> Force of Nature
		else
			call UnitApplyTimedLife(CreateUnit(Player(LoadInteger(HY,GetHandleId(ADSG_Victim),'A3JO')),'efon',GetUnitX(ADSG_Victim),GetUnitY(ADSG_Victim),0),'BEfn',60)//efon -> Treant, BEfn -> Force of Nature
		endif
		call DestroyEffect(AddSpecialEffect("war3mapImported\\NatureExplosion.mdx",GetUnitX(ADSG_Victim),GetUnitY(ADSG_Victim)))
	endif
endfunction

function WrathOfNatureAgh takes unit dummy, unit target returns nothing
	if GetUnitAbilityLevel(dummy,'A0AL')>0 then
		call UnitAddAbilityTimedExF(target,'A3JO',1,4,'B3JO')
		call AddTimedValueToUnit(target,'A3JO',GetPlayerId(GetOwningPlayer(dummy)),4.01)
	endif
endfunction

function VTE takes unit Source,unit Target, integer lvl, boolean isagh returns nothing
	local real selfcost
	local real targetcost=.35
	call UnitAddAbilityTimedEx(Target,'A334',lvl,3+lvl,'B083')//B083 -> Life Break
	if isagh then
		set targetcost=.65
	endif
	set selfcost=.35
	call DamageTarget(Source,Source,1,GetWidgetLife(Source)*selfcost)
	call DamageTarget(Source,Target,1,GetWidgetLife(Target)*targetcost)
	call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Source,"chest"))
	call DestroyEffect(AddSpecialEffectTarget("effects\\LifeBreak.mdx",Target,"chest"))
endfunction

function VWE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local real LastX=LoadReal(HY,h,23)
	local real LastY=LoadReal(HY,h,24)
	local real x
	local real y
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real TargetX=GetUnitX(Target)
	local real TargetY=GetUnitY(Target)
	local real a=Atan2(TargetY-SourceY,TargetX-SourceX)
	local integer lvl=LoadInteger(HY,h,0)
	local boolean isagh=LoadInteger(HY,h,1)=='A1B3'//A1B3 -> Life Break upgrade
	call SetUnitAnimationByIndex(Source,LoadInteger(MHT,GetUnitTypeId(Source),'A1P8'))//A1P8 -> Charge of Darkness
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or DistanceBetweenXY(LastX,LastY,TargetX,TargetY)>1400 or IsUnitDisabled(Source)then
		call SetUnitPathing(Source,true)
		call DestroyEffect(LoadEffectHandle(HY,h,175))
		call DestroyEffect(LoadEffectHandle(HY,h,176))
		call UnitRemoveAbility(Source,'A0ST')//A0ST -> Magic Immunity Container
		call SetUnitTimeScale(Source,1.)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)<125 then
		call SetUnitPathing(Source,true)
		call DestroyEffect(LoadEffectHandle(HY,h,175))
		call DestroyEffect(LoadEffectHandle(HY,h,176))
		call UnitRemoveAbility(Source,'A0ST')//A0ST -> Magic Immunity Container
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SetUnitTimeScale(Source,1.)
		if Target!=null and IsDead(Target)==false then
			call IssueTargetOrderById(Source,ORDER_attack,Target)
			call VTE(Source,Target,lvl,isagh)
		endif
	else
		call SetUnitPathing(Source,false)
		set LastX=TargetX
		set LastY=TargetY
		call SaveReal(HY,h,23,LastX*1.)
		call SaveReal(HY,h,24,LastY*1.)
		set x=SourceX+15*Cos(a)
		set y=SourceY+15*Sin(a)
		if IsUnitType(Source,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
		endif
		call SetUnitPosition(Source,x,y)
		call SetUnitFacing(Source,a*bj_RADTODEG)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function VXE takes unit Source,unit Target,integer id, integer lvl returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.015,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function VWE))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveInteger(HY,h,0,lvl)
	call SaveInteger(HY,h,1,id)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveReal(HY,h,23,GetUnitX(Target)*1.)
	call SaveReal(HY,h,24,GetUnitY(Target)*1.)
	call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("war3mapImported\\LifeBreakCharge.mdx",Source,"hand right alternate"))
	call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("war3mapImported\\LifeBreakCharge.mdx",Source,"hand left alternate"))
	call SetUnitPathing(Source,false)
	call UnitAddAbility2(Source,'A0ST')//A0ST -> Magic Immunity Container
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A0ST',false)//A0ST -> Magic Immunity Container
	call SetUnitAnimationByIndex(Source,LoadInteger(MHT,GetUnitTypeId(Source),'A1P8'))//A1P8 -> Charge of Darkness
	call PurgingTriggered(Source,false)
	call PurgingTriggeredSpellImmune(Source)
	call SetUnitTimeScale(Source,3.)
	set t=null
endfunction

function Huskar_LifeBreakStart takes nothing returns nothing
local string teststring=StringCase("124",false)
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local integer id=LoadInteger(HY,h,0)
	local integer lvl=LoadInteger(HY,h,1)
	if GetUnitAbilityLevel(caster,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(caster),0) then//Aloc -> Locust
		set caster=LoadUnitHandle(HY,GetHandleId(caster),0)
	endif
	call VXE(caster,target,id,lvl)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set caster=null
	set target=null
endfunction

function Huskar_LifeBreakWrapper takes nothing returns nothing
	local timer t
	local integer h
	if IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		call SaveInteger(HY,h,0,GetSpellAbilityId())
		call SaveInteger(HY,h,1,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
		call TimerStart(t,0,false,function Huskar_LifeBreakStart)
		set t=null
	endif
endfunction

function VZE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Level=(LoadInteger(HY,h,5))
	local unit target=(LoadUnitHandle(HY,h,17))
	local integer stat=GetHeroMainStatValue(target)
	local real life=GetWidgetLife(target)
	local real maxlife=GetUnitState(target,UNIT_STATE_MAX_LIFE)
	local real heal
	local integer c=LoadInteger(HY,h,0)+1
	if life/ maxlife>.4 then
		set heal=(Level*1.0)/ 4*.2*stat+2*Level
	else
		set heal=(Level*1.0/4 +0.25)*.6*stat+2*Level
	endif
	set heal=heal/ 8.
	if c>16*8. or GetUnitAbilityLevel(target,'A0QO')==0 or GetTriggerEventId()==EVENT_WIDGET_DEATH then//A0QO -> Inner Vitality
		//call DestroyEffect((LoadEffectHandle(HY,h,31)))
		call RemoveSavedHandle(HY,GetHandleId(target),'A0QP')
		call UnitRemoveAbility(target,'A0QO')//A0QO -> Inner Vitality
		call UnitRemoveAbility(target,'B080')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SetWidgetLife(target,life+heal)
		call SaveInteger(HY,h,0,c)
	endif
	set target=null
	set t=null
	return false
endfunction

function Huskar_InnerVitality takes nothing returns nothing
	local unit Target=GetSpellTargetUnit()
	local unit Source=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A0QP')//A0QP -> Inner Vitality
	local trigger t
	local integer h
	if HaveSavedHandle(HY,GetHandleId(Target),'A0QP') then
		set t=LoadTriggerHandle(HY,GetHandleId(Target),'A0QP')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,GetHandleId(Target),'A0QP',t)
		call TriggerRegisterTimerEvent(t,1/ 8.,true)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerAddCondition(t,Condition(function VZE))
		call SaveUnitHandle(HY,h,17,(Target))
	endif
	call SaveInteger(HY,h,5,(Level))
	call SaveInteger(HY,h,0,0)
	call UnitAddAbility2(Target,'A0QO')
	call SetUnitAbilityLevel(Target,'A0QO',Level)//A0QO -> Inner Vitality
	set Target=null
	set Source=null
	set t=null
endfunction

function V6E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,30)
	local unit Source=LoadUnitHandle(HY,h,2)
	if GetTriggerEvalCount(t)>8 or IsDead(Target)then
		call DestroyEffect(LoadEffectHandle(HY,h,31))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call DamageTarget(Source,Target,1,5*GetUnitAbilityLevel(Source,'A0QN'))//A0QN -> Burning Spear
	endif
	set t=null
	set Target=null
	set Source=null
	return false
endfunction

function Huskar_BurningSpears_Damage takes unit attacker,unit Target returns nothing
	local integer hu=GetHandleId(attacker)
	local integer h
	local trigger t
	if LoadBoolean(MHT,hu,'A0QN'+1) then//A0QN -> Burning Spear
		call UnitRemoveAbility(attacker,'A40H')
		call SaveBoolean(MHT,hu,'A0QN'+1,false)//A0QN -> Burning Spear
	endif
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function V6E))
	set h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,attacker)
	call SaveUnitHandle(HY,h,30,Target)
	call SetWidgetLife(attacker,RMaxIF(GetWidgetLife(attacker)-15,1))
	call SaveEffectHandle(HY,h,31,AddSpecialEffectTarget("Abilities\\Spells\\Other\\BreathOfFire\\BreathOfFireDamage.mdl",Target,"chest"))
	set t=null
endfunction

function Huskar_BurningSpears_Wrapper takes unit attacker, unit target returns nothing
	if GetUnitAbilityLevel(attacker,'A0QN')>0 and not IsUnitSilenced(attacker) and IsUnitType(target,UNIT_TYPE_MECHANICAL)==false then//A0QN -> Burning Spear
		if LoadBoolean(MHT,GetHandleId(attacker),'A0QN') then//if autocast//A0QN -> Burning Spear
			call Huskar_BurningSpears_Damage(attacker,target)
		endif
		if LoadBoolean(MHT,GetHandleId(attacker),'A0QN'+1) then//A0QN -> Burning Spear
			if LoadUnitHandle(MHT,GetHandleId(attacker),'A0QN'+1)==target then//A0QN -> Burning Spear
				call Huskar_BurningSpears_Damage(attacker,target)
			else
				call SaveBoolean(MHT,GetHandleId(attacker),'A0QN'+1,false)//A0QN -> Burning Spear
				call UnitRemoveAbility(attacker,'A40H')
			endif
		endif
	endif
endfunction

function Huskar_BurningSpears_OnAttack takes unit attacker, unit target returns nothing
	if LoadBoolean(MHT,GetHandleId(attacker),'A0QN'+1) then//A0QN -> Burning Spear
		if LoadUnitHandle(MHT,GetHandleId(attacker),'A0QN'+1)!=target then//A0QN -> Burning Spear
			call SaveBoolean(MHT,GetHandleId(attacker),'A0QN'+1,false)//A0QN -> Burning Spear
			call UnitRemoveAbility(attacker,'A40H')
		endif
	endif
endfunction

function Huskar_BerserkerBlood_Resist takes unit Hero,integer amount returns nothing
	local integer i=0
	loop
		if i!=amount/3 and GetUnitAbilityLevel(Hero,BerserkerBloodResistCont[i])>0 then
			call UnitRemoveAbility(Hero,BerserkerBloodResistCont[i])
		endif
		set i=i+1
		exitwhen i>28
	endloop
	if GetUnitAbilityLevel(Hero,BerserkerBloodResistCont[amount/3])==0 then
		call UnitAddAbility2(Hero,BerserkerBloodResistCont[amount/3])
	endif
endfunction

function Huskar_BerserkerBlood_Act takes nothing returns boolean
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real curHP=GetWidgetLife(Hero)
	local integer curPercent
	local integer i
	local integer Level=GetUnitAbilityLevel(Hero,'A0QQ')//A0QQ -> Berserker's Blood, QP1L -> Berserker's Blood
	local boolean effectHere=LoadBoolean(HY,h,319)
	local integer bas
	local integer res
	if IsUnitType(Hero,UNIT_TYPE_HERO) and Level>0 and IsDead(Hero)==false then
		set curPercent=R2I(100*curHP/GetUnitState(Hero,UNIT_STATE_MAX_LIFE))
		set i=IMaxIF(IMinIF(R2I(100-curPercent)/7,14),1)
		set res=(2+Level)*i
		set bas=(6+2*Level)*i
		if GetUnitAbilityLevel(Hero,'A36D')==1  then
			set res=0
			set bas=0
		endif
		if res!=LoadInteger(HY,h,1) then
			call Huskar_BerserkerBlood_Resist(Hero,res)
			call SaveInteger(HY,h,1,res)
		endif
		if bas!=LoadInteger(HY,h,0) then
			if bas-LoadInteger(HY,h,0) > 0 then
				call LoDStat_Add(Hero,bas-LoadInteger(HY,h,0),"attack")
			else
				call LoDStat_Sub(Hero,LoadInteger(HY,h,0)-bas,"attack")
			endif
			call SaveInteger(HY,h,0,bas)
		endif
		if curPercent<40 then
			if effectHere==false then
				call SaveBoolean(HY,h,319,true)
				call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\TrollBerserk\\HeadhunterWEAPONSLeft.mdl",Hero,"left weapon"))
				call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("effects\\HeadhunterWEAPONSRight_NoSound.mdx",Hero,"right weapon"))
			endif
		else
			if effectHere then
				call SaveBoolean(HY,h,319,false)
				call DestroyEffect(LoadEffectHandle(HY,h,175))
				call DestroyEffect(LoadEffectHandle(HY,h,176))
			endif
		endif
	endif
	set Hero=null
	return false
endfunction

function Huskar_BerserkerBlood_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddCondition(t,Condition(function Huskar_BerserkerBlood_Act))
	call SaveUnitHandle(HY,GetHandleId(t),14,GetTriggerUnit())
	call SaveBoolean(HY,GetHandleId(t),319,false)
	call SaveInteger(HY,GetHandleId(t),0,0)
	set t=null
	set BerserkerBloodResistCont[1]='A2PD'
	set BerserkerBloodResistCont[2]='A2PA'
	set BerserkerBloodResistCont[3]='A2P9'
	set BerserkerBloodResistCont[4]='A2P8'
	set BerserkerBloodResistCont[5]='A2PE'
	set BerserkerBloodResistCont[6]='A2PC'
	set BerserkerBloodResistCont[7]='A2PB'
	set BerserkerBloodResistCont[8]='A2OW'
	set BerserkerBloodResistCont[9]='A2OX'
	set BerserkerBloodResistCont[10]='A2OY'
	set BerserkerBloodResistCont[11]='A2P0'
	set BerserkerBloodResistCont[12]='A2P1'
	set BerserkerBloodResistCont[13]='A2P2'
	set BerserkerBloodResistCont[14]='A2P7'
	set BerserkerBloodResistCont[15]='A2P6'
	set BerserkerBloodResistCont[16]='A2P5'
	set BerserkerBloodResistCont[17]='A2P4'
	set BerserkerBloodResistCont[18]='A2P3'
	set BerserkerBloodResistCont[19]='A2OZ'
	set BerserkerBloodResistCont[20]='A2PF'
	set BerserkerBloodResistCont[21]='A2PG'
	set BerserkerBloodResistCont[22]='A2T8'
	set BerserkerBloodResistCont[23]='A2T9'
	set BerserkerBloodResistCont[24]='A2T7'
	set BerserkerBloodResistCont[25]='A46N'
	set BerserkerBloodResistCont[26]='A46O'
	set BerserkerBloodResistCont[27]='A46P'
	set BerserkerBloodResistCont[28]='A46Q'
	call HideAbility(BerserkerBloodResistCont[1])
	call HideAbility(BerserkerBloodResistCont[2])
	call HideAbility(BerserkerBloodResistCont[3])
	call HideAbility(BerserkerBloodResistCont[4])
	call HideAbility(BerserkerBloodResistCont[5])
	call HideAbility(BerserkerBloodResistCont[6])
	call HideAbility(BerserkerBloodResistCont[7])
	call HideAbility(BerserkerBloodResistCont[8])
	call HideAbility(BerserkerBloodResistCont[9])
	call HideAbility(BerserkerBloodResistCont[10])
	call HideAbility(BerserkerBloodResistCont[11])
	call HideAbility(BerserkerBloodResistCont[12])
	call HideAbility(BerserkerBloodResistCont[13])
	call HideAbility(BerserkerBloodResistCont[14])
	call HideAbility(BerserkerBloodResistCont[15])
	call HideAbility(BerserkerBloodResistCont[16])
	call HideAbility(BerserkerBloodResistCont[17])
	call HideAbility(BerserkerBloodResistCont[18])
	call HideAbility(BerserkerBloodResistCont[19])
	call HideAbility(BerserkerBloodResistCont[20])
	call HideAbility(BerserkerBloodResistCont[21])
	call HideAbility(BerserkerBloodResistCont[22])
	call HideAbility(BerserkerBloodResistCont[23])
	call HideAbility(BerserkerBloodResistCont[24])
	call HideAbility(BerserkerBloodResistCont[25])
	call HideAbility(BerserkerBloodResistCont[26])
	call HideAbility(BerserkerBloodResistCont[27])
	call HideAbility(BerserkerBloodResistCont[28])
endfunction

function WKE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer Level=LoadInteger(HY,h,5)
	local real a=LoadReal(HY,h,137)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local integer id=GetPlayerId(GetOwningPlayer(Source))
	local integer Count=GetTriggerEvalCount(t)
	local real AO8=x+150*Count*Cos(a)
	local real AP8=y+150*Count*Sin(a)
	local integer WME=6
	if LoadBoolean(HY,h,0) then
		set WME=12
	endif
	call IssuePointOrderById(E18[id],852488,AO8,AP8)
	if Count==(WME)then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SetUnitAnimation(Source,"stand")
	endif
	set t=null
	set Source=null
	return false
endfunction

function THD_Macropyre takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
	local integer Level=GetUnitAbilityLevel(Source,'A0O5')//A0O5 -> Macropyre
	local integer WOE='A0OE'//A0OE -> Macropyre Flame
	call SaveBoolean(HY,h,0,false)
	if Level==0 then
		set Level=GetUnitAbilityLevel(Source,'A1B1')//A1B1 -> Macropyre upgrade
		set WOE='A1B2'//A1B2 -> Macropyre Flame upgrade
		call SaveBoolean(HY,h,0,true)
	endif
	call SetUnitAnimation(Source,"spell")
	set E18[GetPlayerId(GetOwningPlayer(Source))]=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)//e00E -> Spellcaster
	call UnitAddAbility2(E18[GetPlayerId(GetOwningPlayer(Source))],WOE)
	call SetUnitAbilityLevel(E18[GetPlayerId(GetOwningPlayer(Source))],WOE,Level)
	call SaveInteger(HY,h,5,Level)
	call SaveReal(HY,h,6,GetUnitX(Source))
	call SaveReal(HY,h,7,GetUnitY(Source))
	call SaveReal(HY,h,137,a*1.)
	call SaveUnitHandle(HY,h,2,Source)
	if WOE=='A0OE' then//A0OE -> Macropyre Flame
		call TriggerRegisterTimerEvent(t,.1,true)
	else
		call TriggerRegisterTimerEvent(t,.05,true)
	endif
	call TriggerAddCondition(t,Condition(function WKE))
	set t=null
	set Source=null
endfunction

function THD_LiquidFire takes nothing returns nothing
	
endfunction

function Jakiro_Icepath_End takes timer t, integer info returns nothing
	local integer i = 0
	loop
		call DestroyUbersplat(LoadUbersplatHandle(MHT,info,i + 500))
		call DestroyEffect(LoadEffectHandle(MHT,info,i + 3))
		set i = i + 1
		exitwhen i == 14
	endloop
	call RemoveUnit(LoadUnitHandle(MHT,info,1))
	call KillGroup(LoadGroupHandle(MHT,info,2))
	call Timer_End(t)
	set t = null
endfunction

function Jakiro_Icepath_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local unit u = group_temp_unit[0]
	local player p = GetOwningPlayer(t)
	local group g
	if IsUnitEnemy(u,p) and AliveNonBuildOrMarker(t) and IsMagicImmune(t)==false then
		set g = LoadGroupHandle(MHT,group_temp_integer[0],2)
		if IsUnitInGroup(t,g)==false then
			call GroupAddUnit(g,t)
			call DamageTarget(u,t,1,group_temp_integer[1])
			call StunTargetLoD(t,(group_temp_integer[2]*1.0)*0.4+0.6)
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FreezingBreath\\FreezingBreathMissile.mdl",GetUnitX(t),GetUnitY(t)))
		endif
		set g = null
	endif
	set u = null
	set t = null
	return false
endfunction

function Jakiro_Icepath_Duration takes nothing returns nothing
	local ubersplat u = null
	local timer t = GetExpiredTimer()
	local integer loopA
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0) + 1
	local integer max = LoadInteger(MHT,info,1)
	local real angle
	local real ax
	local real ay
	local real x
	local real y
	if count==max then
		call Jakiro_Icepath_End(t,info)
		set t = null
		return
	endif
	call SaveInteger(MHT,info,0,count)
	if count<14 then
		set angle = LoadReal(MHT,info,0)
		set x = LoadReal(MHT,info,1) + 100*count*Cos(angle)
		set y = LoadReal(MHT,info,2) + 100*count*Sin(angle)
		call SaveEffectHandle(MHT,info,2 + count,AddSpecialEffect("effects\\IcePath.mdx",x,y))
		set u = CreateUbersplat(x,y,"IPTH",255,255,255,255,false,false) //doesnt seem to display the effect \:3/
		call SetUbersplatRenderAlways(u,true)
		call SaveUbersplatHandle(MHT,info,500 + count,u)
		set t = null
		set u = null
		return
	endif
	set group_temp_unit[0] = LoadUnitHandle(MHT,info,0)
	set group_temp_unit[1] = LoadUnitHandle(MHT,info,1)
	set group_temp_integer[2] = LoadInteger(MHT,info,3)
	set group_temp_integer[1] = LoadInteger(MHT,info,2)
	set group_temp_integer[0] = info
	set angle = LoadReal(MHT,info,0)
	set x = LoadReal(MHT,info,1)
	set y = LoadReal(MHT,info,2)
	set ax = Cos(angle)
	set ay = Sin(angle)
	set loopA = 0
	loop
		call GroupEnumUnitsInRange(temp_group,x,y,175,Condition(function Jakiro_Icepath_Targets))
		set x = x + 100*ax
		set y = y + 100*ay
		set loopA = loopA + 1
		exitwhen loopA == 13
	endloop
	set t = null
endfunction

function Jakiro_Icepath_Start2 takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local integer info = GetHandleId(t)
	local integer level = GetUnitAbilityLevel(u,'A0O6')//A0O6 -> Ice Path
	local real x = GetWidgetX(u)
	local real y = GetWidgetY(u)
	call SaveUnitHandle(MHT,info,0,u)
	set u = CreateUnit(Player(15),'e00E',0,0,0)//e00E -> Spellcaster
	call SaveUnitHandle(MHT,info,1,u)
	call SaveGroupHandle(MHT,info,2,GetAvailableGroup())
	call SaveInteger(MHT,info,0,0)
	call SaveInteger(MHT,info,1,level*8 + 12)
	call SaveInteger(MHT,info,2,50)
	call SaveInteger(MHT,info,3,level)
	call SaveReal(MHT,info,0,Atan2(GetSpellTargetY()-y,GetSpellTargetX()-x))
	call SaveReal(MHT,info,1,x)
	call SaveReal(MHT,info,2,y)
	call TimerStart(t,0.05,true,function Jakiro_Icepath_Duration)
	set t = null
	set u = null
endfunction

function Func2047 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real x=(LoadReal(HY,(h),6))
	local real y=(LoadReal(HY,(h),7))
	local real a=(LoadReal(HY,(h),137))
	local unit caster=(LoadUnitHandle(HY,(h),2))
	local integer c=GetTriggerEvalCount(t)
	local real dx
	local real dy
	local group g
	local integer i
	local group gg=(LoadGroupHandle(HY,(h),187))
	local integer lvl=LoadInteger(HY,h,5)
	local unit u
	local real stun
	set i=0
	set g=GetAvailableGroup()
	loop
		set dx=x+100*i*Cos(a*bj_DEGTORAD)
		set dy=y+100*i*Sin(a*bj_DEGTORAD)
		set tt_unit1=caster
		set stun=(0.6+0.4*lvl)-(c*0.05)
		call GroupEnumUnitsInRange(g,dx,dy,175,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
		call GroupRemoveGroup(gg,g)
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			if IsUnitInGroup(u,gg)==false and IsUnitCycloned(u)==false then
				call GroupAddUnit(gg,u)
				call StunTargetLoD(u,stun)
				call DamageTarget(caster,u,1,50)
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FreezingBreath\\FreezingBreathMissile.mdl",GetUnitX(u),GetUnitY(u)))
			endif
			call GroupRemoveUnit(g,u)
		endloop
		//call ForGroup(g,function Func2046)
		set i=i+1
		exitwhen i>13
	endloop
	call KillGroup(g)
	if c==20*(0.6+0.4*lvl)then
		call KillGroup(gg)
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	endif
	set t=null
	set caster=null
	set g=null
	set gg=null
	return false
endfunction

function Func2048 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local real a=(LoadReal(HY,h,137))
	local integer c=GetTriggerEvalCount(t)
	local real dx=x+100*c*Cos(a*bj_DEGTORAD)
	local real dy=y+100*c*Sin(a*bj_DEGTORAD)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local integer lvl=LoadInteger(HY,h,5)
	local ubersplat ub
	local integer i
	if c < 13+1 then
		call SaveEffectHandle(HY,h,(609+c),(AddSpecialEffect("effects\\IcePath.mdx",dx,dy)))
		set ub=CreateUbersplat(dx,dy,"IPTH",255,255,255,255,false,false)
		call SetUbersplatRenderAlways(ub,true)
		call SaveUbersplatHandle(HY,h,(760+c),(ub))
	endif
	if c==14 then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.05,true)
		call TriggerAddCondition(t,Condition(function Func2047))
		call SaveInteger(HY,h,5,lvl)
		call SaveReal(HY,h,6,((x)*1.0))
		call SaveReal(HY,h,7,((y)*1.0))
		call SaveReal(HY,h,137,((a)*1.0))
		call SaveUnitHandle(HY,h,2,(caster))
		call SaveGroupHandle(HY,h,187,(GetAvailableGroup()))
		call TriggerEvaluate(t)
	elseif c>=(0.4+0.6+0.4*lvl)/.05 then
		set i=0
		loop
			call DestroyEffect((LoadEffectHandle(HY,h,(609+i))))
			call DestroyUbersplat((LoadUbersplatHandle(HY,h,(760+i))))
			set i=i+1
			exitwhen i==14
		endloop
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	endif
	set t=null
	set caster=null
	return false
endfunction

function Jakiro_Icepath_Start takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit caster=GetTriggerUnit()
	local real x=GetUnitX(caster)
	local real y=GetUnitY(caster)
	local real a=AngleBetweenXY(x,y,GetSpellTargetX(),GetSpellTargetY())
	call TriggerRegisterTimerEvent(t,0.05,true)
	call TriggerAddCondition(t,Condition(function Func2048))
	call SaveReal(HY,(h),6,((x)*1.0))
	call SaveReal(HY,(h),7,((y)*1.0))
	call SaveInteger(HY,h,5,GetUnitAbilityLevel(caster,'A0O6'))
	call SaveReal(HY,(h),137,((a)*1.0))
	call SaveUnitHandle(HY,(h),2,(caster))
	call TriggerEvaluate(t)
	set t=null
	set caster=null
endfunction

//function THD_DualBreath_MOREMATH takes real r1,real r2,real r3,real r4,real r5,real r6,real x,real y returns boolean
//	local real r7=(y-r2)*(r3-r1)-(x-r1)*(r4-r2)
//	local real r8=(y-r6)*(r1-r5)-(x-r5)*(r2-r6)
//	local real r9=(y-r4)*(r5-r3)-(x-r3)*(r6-r4)
//	return(r7*r8>0)and(r9*r8>0)
//endfunction
//
//function THD_DualBreath_Filter takes nothing returns boolean
//	local real r1=THD_TempReal1
//	local real r2=THD_TempReal2
//	local real r3=THD_TempReal3
//	local real r4=THD_TempReal4
//	local real r5=THD_TempReal5
//	local real r6=THD_TempReal6
//	return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and THD_DualBreath_MOREMATH(r1,r2,r3,r4,r5,r6,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()))
//endfunction
//
//function THD_DualBreath_MATH takes real angle,real x,real y returns nothing
//	local real dist=600
//	local real startWidth=200
//	local real finalWidth=250
//	local real asin=Asin((finalWidth-startWidth)/dist)
//	local real r1=startWidth/Sin(asin)
//	local real r2=(dist+finalWidth+r1)*Tan(asin)
//	local real r3=x+r1*Cos((angle-180)*bj_DEGTORAD)
//	local real r4=y+r1*Sin((angle-180)*bj_DEGTORAD)
//	local real r5=(x+(dist+finalWidth)*Cos(angle*bj_DEGTORAD))+r2*Cos((angle-90)*bj_DEGTORAD)
//	local real r6=(y+(dist+finalWidth)*Sin(angle*bj_DEGTORAD))+r2*Sin((angle-90)*bj_DEGTORAD)
//	local real r7=(x+(dist+finalWidth)*Cos(angle*bj_DEGTORAD))+r2*Cos((angle+90)*bj_DEGTORAD)
//	local real r8=(y+(dist+finalWidth)*Sin(angle*bj_DEGTORAD))+r2*Sin((angle+90)*bj_DEGTORAD)
//	set THD_TempReal1=r3
//	set THD_TempReal2=r4
//	set THD_TempReal3=r5
//	set THD_TempReal4=r6
//	set THD_TempReal5=r7
//	set THD_TempReal6=r8
//endfunction
//
//function THD_DualBreath_ForGroup takes nothing returns nothing
//	local unit u=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)//e00E -> Spellcaster
//	call UnitAddAbility2(u,'A0OA')//A0OA -> Dual Breath Slow
//	call IssueTargetOrder(u,"frostnova",GetEnumUnit())
//	set u=null
//endfunction
//
//function THD_DualBreath_BurnBaby takes nothing returns boolean
//	local trigger t=GetTriggeringTrigger()
//	local integer h=GetHandleId(t)
//	local player p=LoadPlayerHandle(MHT,h,54)
//	local unit caster=LoadUnitHandle(MHT,h,14)
//	local real sourceX=LoadReal(MHT,h,6)
//	local real sourceY=LoadReal(MHT,h,7)
//	local real targetX=LoadReal(MHT,h,47)
//	local real targetY=LoadReal(MHT,h,48)
//	local integer lvl=LoadInteger(MHT,h,5)
//	local unit dummy
//	if GetTriggerEvalCount(t)>1 then
//		call SetUnitAnimation(caster,"stand")
//		call FlushChildHashtable(MHT,h)
//		call CleanTrigger(t)
//	else
//		call SetUnitAnimation(caster,"spell")
//		set dummy=CreateUnit(p,'e00E',sourceX,sourceY,0)//e00E -> Spellcaster
//		call UnitAddAbility2(dummy,'A0OC')//A0OC -> Dual Breath Fire
//		call SetUnitAbilityLevel(dummy,'A0OC',lvl)//A0OC -> Dual Breath Fire
//		call IssuePointOrder(dummy,"breathoffrost",targetX,targetY)
//	endif
//	set t=null
//	set p=null
//	set caster=null
//	set dummy=null
//	return false
//endfunction
//
//function THD_DualBreath_FireFrei takes unit u,player p,integer lvl,location l,real x,real y returns nothing
//	local trigger t=CreateTrigger()
//	local integer h=GetHandleId(t)
//	call SavePlayerHandle(MHT,h,54,p)
//	call SaveReal(MHT,h,6,x*1.0)
//	call SaveReal(MHT,h,7,y*1.0)
//	call SaveReal(MHT,h,47,GetLocationX(l)*1.0)
//	call SaveReal(MHT,h,48,GetLocationY(l)*1.0)
//	call SaveInteger(MHT,h,5,lvl)
//	call SaveUnitHandle(MHT,h,14,u)
//	call TriggerRegisterTimerEvent(t,0.3,true)
//	call TriggerAddCondition(t,Condition(function THD_DualBreath_BurnBaby))
//	set t=null
//endfunction
//
//function THD_DualBreath takes nothing returns nothing
//	local unit caster=GetTriggerUnit()
//	local integer lvl=GetUnitAbilityLevel(caster,'A0O7')//A0O7 -> Dual Breath
//	local real x=GetUnitX(caster)
//	local real y=GetUnitY(caster)
//	local location l
//	local unit dummy
//	local group g=GetAvailableGroup()
//	if GetSpellTargetUnit()==null then
//		set l=GetSpellTargetLoc()
//	else
//		set l=GetUnitLoc(GetSpellTargetUnit())
//	endif
//	call THD_DualBreath_MATH(bj_RADTODEG*Atan2(GetLocationY(l)-y,GetLocationX(l)-x),x,y)
//	call GroupEnumUnitsInRange(g,x,y,2000,Condition(function THD_DualBreath_Filter))
//	call ForGroup(g,function THD_DualBreath_ForGroup)
//	call KillGroup(g)
//	set dummy=CreateUnit(GetOwningPlayer(caster),'e00E',x,y,0)//e00E -> Spellcaster
//	call UnitAddAbility2(dummy,'A0OB')//A0OB -> Dual Breath Frost
//	call SetUnitAbilityLevel(dummy,'A0OB',lvl)//A0OB -> Dual Breath Frost
//	call IssuePointOrder(dummy,"breathoffire",GetLocationX(l),GetLocationY(l))
//	call THD_DualBreath_FireFrei(caster,GetOwningPlayer(caster),lvl,l,x+50*Cos(Atan2(GetLocationY(l)-y,GetLocationX(l)-x)),y+50*Sin(Atan2(GetLocationY(l)-y,GetLocationX(l)-x)))
//	call RemoveLocation(l)
//	set caster=null
//	set l=null
//	set g=null
//	set dummy=null
//endfunction

function DualBreathDummySlow takes unit d, unit t returns nothing
	local integer i=GetUnitAbilityLevel(d,'A0OB')
	if i>0 and GetUnitAbilityLevel(d,'A3JI'-1+i)==0 then
		call UnitAddAbilityTimedExF(t,'A3JI'-1+GetUnitAbilityLevel(d,'A0OB'),1,5,'B3J1')
	endif
endfunction

function DualBreathRecoded2ndWave takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit d=LoadUnitHandle(HY,h,0)
	call IssuePointOrderById(d,852560,LoadReal(HY,h,0),LoadReal(HY,h,1))
	call FlushChildHashtable(HY,h)
	call DestroyTrigger(t)
	set d=null
	set t=null
endfunction

function DualBreathRecodedInit takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local trigger t=CreateTrigger()
	local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
	local integer h=GetHandleId(t)
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
	call DummyDamageTracking(3)
	call TriggerRegisterTimerEvent(t,0.3,false)
	call TriggerAddCondition(t,Condition(function DualBreathRecoded2ndWave))
	call UnitAddAbility(d,'A0OB')
	call SetUnitAbilityLevel(d,'A0OB',lvl)
	call IssuePointOrderById(d,852580,x,y)
	set d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
	call UnitAddAbility(d,'A0OC')
	call SetUnitAbilityLevel(d,'A0OC',lvl)
	call SaveUnitHandle(HY,h,0,d)
	call SaveReal(HY,h,0,x)
	call SaveReal(HY,h,1,y)
	set d=null
	set t=null
	set u=null
endfunction

function THD_DualBreath_Preload takes nothing returns nothing
	call PreloadQueryAdd('A0OB')//A0OB -> Dual Breath Frost
	call PreloadQueryAdd('A0OC')//A0OC -> Dual Breath Fire
	call PreloadQueryAdd('A0OA')//A0OA -> Dual Breath Slow
	call PreloadQueryAdd('A0OE')//A0OE -> Macropyre Flame
endfunction

function XXE takes unit Hero,unit Target returns nothing
	local real a=GetRandomReal(0,360)
	local real x=GetUnitX(Target)+50*Cos(a*bj_DEGTORAD)
	local real y=GetUnitY(Target)+50*Sin(a*bj_DEGTORAD)
	local real XYE=GetRandomReal(200,225)
	call SetUnitX(Hero,x)
	call SetUnitY(Hero,y)
	call SetUnitFacing(Hero,bj_RADTODEG*Atan2(GetUnitY(Target)-GetUnitY(Hero),GetUnitX(Target)-GetUnitX(Hero)))
	call SetUnitAnimation(Hero,"Attack")
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl",Hero,"chest"))
	if IsPlayerBelongToTeams(GetOwningPlayer(Target))==false and IsUnitType(Target,UNIT_TYPE_ANCIENT)==false then
		set XYE = 99999
	endif
	call DamageTarget(Hero,Target,2,XYE)
	//call IssueTargetOrderById(Hero,ORDER_attack,Target)
endfunction

function XZE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local unit Target=(LoadUnitHandle(HY,h,17))
	call XXE(Hero,Target)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	set Target=null
	return false
endfunction

function XAE takes unit Hero returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=Hero
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),450,Condition(function Juggernaut_Omnislash_Filter))
	set tt_unit1=GroupPickRandomUnit(g)
	if tt_unit1!=null then
		call XXE(Hero,tt_unit1)
	endif
	call KillGroup(g)
	set g=null
endfunction

function XBE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local unit VisionDummy=(LoadUnitHandle(HY,h,19))
	local integer XCE=(LoadInteger(HY,h,216))
	local integer X3E=(LoadInteger(HY,h,325))
	local integer KAE=(LoadInteger(HY,h,28))
	local unit X6E
	if KAE>XCE then
		if LoadInteger(HY,h,0)>0 then
			call LoDStat_Sub(Hero,LoadInteger(HY,h,0),"attack")
		endif
		call KillUnit(VisionDummy)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A05G',true)//A05G -> Blade Fury
		call SetUnitPathing(Hero,true)
		call SetUnitInvulnerable(Hero,false)
		call SaveInteger(HY,(GetHandleId((Hero))),(4253),2)
		//call SetUnitVertexColor(Hero,255,255,255,255)
		call SetTint(Hero,-1,-1,-1,255)
	else
		call SaveInteger(HY,h,28,(KAE+1))
		call XAE(Hero)
		if tt_unit1==null then
			if LoadInteger(HY,h,0)>0 then
				call LoDStat_Sub(Hero,LoadInteger(HY,h,0),"attack")
			endif
			call KillUnit(VisionDummy)
			call DestroyEffect((LoadEffectHandle(HY,h,32)))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A05G',true)//A05G -> Blade Fury
			call SetUnitPathing(Hero,true)
			call SetUnitInvulnerable(Hero,false)
			call SaveInteger(HY,(GetHandleId((Hero))),(4253),2)
			//call SetUnitVertexColor(Hero,255,255,255,255)
			call SetTint(Hero,-1,-1,-1,255)
		endif
	endif
	set t=null
	set Hero=null
	set X6E=null
	set VisionDummy=null
	return false
endfunction

function Juggernaut_Omnislash takes nothing returns nothing
	local timer t2=GetExpiredTimer()
	local integer h2=GetHandleId(t2)
	local unit Hero=LoadUnitHandle(HY,h2,0)
	local unit Target=LoadUnitHandle(HY,h2,1)
	local integer Level=GetUnitAbilityLevel(Hero,'A0M1')//A0M1 -> Omnislash
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer X3E=GetUnitAbilityLevel(Hero,'A05G')//A05G -> Blade Fury
	local player p=GetOwningPlayer(Hero)
	local integer XCE=3
	local unit VisionDummy=CreateUnit(GetOwningPlayer(Hero),'o00D',GetUnitX(Hero),GetUnitY(Hero),0)//o00D -> Vision Dummy 200/200
	local integer maxstat
	local integer asbonus
	if GetUnitAbilityLevel(Hero,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(Hero),0) then//Aloc -> Locust
		set Hero=LoadUnitHandle(HY,GetHandleId(Hero),0)
	endif
	set maxstat=IMaxIF(GetHeroStr(Hero,true),IMaxIF(GetHeroAgi(Hero,true),GetHeroInt(Hero,true)))
	set asbonus=maxstat-GetHeroAgi(Hero,true)
	if Level==0 then
		set Level=GetUnitAbilityLevel(Hero,'A1AX')//A1AX -> Omnislash upgrade
		if Level==1 then
			set XCE=6
		elseif Level==2 then
			set XCE=9
		elseif Level==3 then
			set XCE=12
		endif
	elseif Level==2 then
		set XCE=6
	elseif Level==3 then
		set XCE=9
	endif
	call SetPlayerAbilityAvailable2(p,'A05G',false)//A05G -> Blade Fury
	//call SetUnitVertexColor(Hero,255,255,255,125)
	call SetTint(Hero,-1,-1,-1,125)
	call SetUnitPathing(Hero,false)
	call SetUnitInvulnerable(Hero,true)
	call SaveInteger(HY,GetHandleId(Hero),4253,1)
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveUnitHandle(HY,h,17,(Target))
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function XZE))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveUnitHandle(HY,h,19,(VisionDummy))
	call SaveInteger(HY,h,216,(XCE))
	call SaveInteger(HY,h,325,(X3E))
	call SaveInteger(HY,h,28,2)
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile_mini.mdl",Hero,GetProperAttachPoint_Weapon(Hero))))
	call TriggerRegisterTimerEvent(t,.4,true)
	call TriggerAddCondition(t,Condition(function XBE))
	if asbonus>0 then
		call LoDStat_Add(Hero,asbonus,"attack")
		call SaveInteger(HY,h,0,asbonus)
	endif
	call DestroyTimer(t2)
	call FlushChildHashtable(HY,h2)
	set t2=null
	set Hero=null
	set Target=null
	set t=null
	set p=null
	set VisionDummy=null
endfunction

function Juggernaut_OmnislashWrapper takes nothing returns nothing
	local timer t
	local integer h
	if IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		call TimerStart(t,0,false,function Juggernaut_Omnislash)
		set t=null
	endif
	
endfunction

function X0E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call SetUnitAnimationByIndex(Source,4)
	set t=null
	set Source=null
	return false
endfunction

function Juggernaut_Omnislash_OnCast takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.01,false)
	call TriggerAddCondition(t,Condition(function X0E))
	call SaveUnitHandle(HY,h,2,(Source))
	set t=null
	set Source=null
endfunction

function Y4E takes nothing returns nothing
	call DamageTarget(E28,GetEnumUnit(),1,(55.+25.*F48)*.25)
endfunction

function Y7E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Count=GetTriggerEvalCount(t)
	local group g
	if Count==20 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set tt_unit1=Source
		set E28=Source
		set F48=LoadInteger(HY,h,0)
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),275,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function Y4E)
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Source=null
	return false
endfunction

function Juggernaut_Bladefury takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.25,true)
	call TriggerRegisterDeathEvent(t,GetTriggerUnit())
	call TriggerAddCondition(t,Condition(function Y7E))
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),'A05G'))//A05G -> Blade Fury
	call SaveUnitHandle(HY,h,2,(GetTriggerUnit()))
	if (GetUnitTypeId(GetTriggerUnit())!='Nbbc' and GetUnitTypeId(GetTriggerUnit())!='Opgh')then//Nbbc -> Juggernaut, Opgh -> Axe
		call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\SpinFX2.mdx",GetTriggerUnit(),"origin")))
	endif
	call TriggerEvaluate(t)
	call AddTimedKeyToUnit(GetTriggerUnit(),4252,5)
	call PurgingTriggered(GetTriggerUnit(),false)
	call PurgingTriggeredSpellImmune(GetTriggerUnit())
	set t=null
endfunction

function YDE takes nothing returns boolean
	return GetUnitTypeId(GetSummonedUnit())=='o00C' or GetUnitTypeId(GetSummonedUnit())=='o01G' or GetUnitTypeId(GetSummonedUnit())=='o01H' or GetUnitTypeId(GetSummonedUnit())=='o01I'//o00C -> Healing Ward - Level 1, o01G -> Healing Ward - Level 2, o01H -> Healing Ward - Level 3, o01I -> Healing Ward - Level 4
endfunction

function YEE takes nothing returns nothing
	call SetUnitAbilityLevel(GetSummonedUnit(),'A058',GetUnitAbilityLevel(GetSummoningUnit(),'A047'))//A058 -> Healing Ward Aura, A047 -> Healing Ward
endfunction

function K39 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function YDE))
	call TriggerAddAction(t,function YEE)
	set t=null
endfunction

function YFE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real x1
	local real y1
	local real x2
	local real y2
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or(GetTriggerEventId()==EVENT_UNIT_DAMAGED and GetEventDamage()>2 and IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource())))then
		call DestroyEffect((LoadEffectHandle(HY,h,175)))
		call DestroyEffect((LoadEffectHandle(HY,h,176)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()!=EVENT_UNIT_DAMAGED and GetTriggerEventId()!=EVENT_WIDGET_DEATH then
		set x1=GetUnitX(Source)
		set y1=GetUnitY(Source)
		set x2=GetUnitX(Target)
		set y2=GetUnitY(Target)
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl",x1,y1))
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl",x2,y2))
		call AddTimedKeyToUnit(Target,4410,1)
		call SetUnitPosition(Target,GetUnitX(Source),GetUnitY(Source))
		call DestroyEffect(LoadEffectHandle(HY,h,175))
		call DestroyEffect(LoadEffectHandle(HY,h,176))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function YGE takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local real d=DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),F98,FD8)
	if d<F88 and LoadBoolean(HY,GetHandleId(GetOwningPlayer(Target)),139)==false then
		set F78=Target
		set F88=d
	endif
	set Target=null
endfunction

function Kotl_Recall takes nothing returns nothing
	local unit Target=GetSpellTargetUnit()
	local unit Source=GetTriggerUnit()
	local trigger t
	local integer h
	local real DP9
	local group g
	local integer lvl=GetUnitAbilityLevel(Source,'A10U')//A10U -> Recall
	if Target==null then
		set F78=null
		set F88=999999
		set F98=GetSpellTargetX()
		set FD8=GetSpellTargetY()
		set tt_unit1=Source
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,0,0,9999,Condition(function D79))
		call GroupRemoveUnit(g,Source)
		call ForGroup(g,function YGE)
		call KillGroup(g)
		set Target=F78
		set g=null
	endif
	if Target!=null then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerRegisterDeathEvent(t,Source)
		call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
		call TriggerRegisterTimerEvent(t,6-lvl,false)
		call TriggerAddCondition(t,Condition(function YFE))
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveUnitHandle(HY,h,17,(Target))
		call SaveEffectHandle(HY,h,175,(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTo.mdl",Source,"origin")))
		call SaveEffectHandle(HY,h,176,(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTo.mdl",Target,"origin")))
	endif
	set Target=null
	set Source=null
	set t=null
endfunction

function Kotl_Recall_OnCast takes nothing returns nothing
	if GetSpellTargetUnit()!=null and LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetSpellTargetUnit())),139) then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetSpellTargetUnit()),"This player has disabled help from allies.")
	endif
endfunction

function YKE takes integer Level returns integer
	if Level==1 then
		return 'A10Z'//A10Z -> Mana Leak buff
	elseif Level==2 then
		return 'A111'//A111 -> Mana Leak buff
	elseif Level==3 then
		return 'A10Y'//A10Y -> Mana Leak buff
	elseif Level==4 then
		return 'A110'//A110 -> Mana Leak buff
	endif
	return 0
endfunction

function YME takes integer Level returns integer
	if Level==1 then
		return 'B09M'//B09M -> |cffff0000Mana Leak|r|n|cff4F4F4FLevel:|r 1
	elseif Level==2 then
		return 'B09N'//B09N -> |cffff0000Mana Leak|r|n|cff4F4F4FLevel:|r 2
	elseif Level==3 then
		return 'B09O'//B09O -> |cffff0000Mana Leak|r|n|cff4F4F4FLevel:|r 3
	elseif Level==4 then
		return 'B09L'//B09L -> |cffff0000Mana Leak|r|n|cff4F4F4FLevel:|r 4
	endif
	return 0
endfunction

function YNE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Level=(LoadInteger(HY,h,5))
	local real LastX=(LoadReal(HY,h,23))
	local real LastY=(LoadReal(HY,h,24))
	local real x=GetUnitX(Target)
	local real y=GetUnitY(Target)
	local real d=SquareRoot(LastX-x)*(LastX-x)+(LastY-y)*(LastY-y)
	local real YOE=(.0005)*d*GetUnitState(Target,UNIT_STATE_MAX_MANA)
	local integer EZE=GetTriggerEvalCount(t)
	if IsMagicImmune(Target) then
		set YOE=0
	endif
	if d>300 then
		set YOE=0
	endif
	if YOE>1 and ModuloInteger(GetTriggerEvalCount(t),3)==0 then
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\WingedSerpentMissile\\WingedSerpentMissile.mdl",Target,"chest"))
	endif
	if YOE>0 then
		call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-YOE)
	endif
	call SaveReal(HY,h,23,(x)*1.)
	call SaveReal(HY,h,24,(y)*1.)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or EZE==(Level+4)*10 or GetUnitAbilityLevel(Target,YKE(Level))==0 then
		call UnitRemoveAbility(Target,YKE(Level))
		call UnitRemoveAbility(Target,YME(Level))
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetUnitState(Target,UNIT_STATE_MANA)<1 then
		call StunTargetLoD(Target,1+.5*Level)
		call UnitRemoveAbility(Target,YKE(Level))
		call UnitRemoveAbility(Target,YME(Level))
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	return false
endfunction

function YPE takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A10X')//A10X -> Mana Leak
	call UnitAddAbility2(Target,YKE(Level))
	call SaveUnitHandle(HY,h,17,Target)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,23,(GetUnitX(Target)*1.))
	call SaveReal(HY,h,24,(GetUnitY(Target)*1.))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("effects\\BasicWaterFlash.mdx",Target,"chest")))
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function YNE))
	set Source=null
	set Target=null
	set t=null
endfunction

function Kotl_ManaLeak takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call YPE()
	endif
endfunction

function Kotl_SpiritForm_MoveDummy takes nothing returns nothing
	local integer h=GetHandleId(GetExpiredTimer())
	local unit u=LoadUnitHandle(HY,h,0)
	local unit d=LoadUnitHandle(HY,h,1)
	if GetUnitTypeId(u)=='H06X' and IsDead(u)==false and GetWidgetLife(u)>0 and IsUnitHidden(u)==false then//H06X -> Keeper of the Light
		if IsUnitHidden(d) then
			call ShowUnit(d,true)
		endif
		call SetUnitPosition(d,GetUnitX(u),GetUnitY(u))
	else
		if IsUnitHidden(d)==false then
			call ShowUnit(d,false)
		endif
	endif
	
	set u=null
	set d=null
endfunction

function Kotl_SpiritForm_Init takes unit u returns nothing
	local unit d=CreateUnit(GetOwningPlayer(u),'hSPR',GetUnitX(u),GetUnitY(u),0)
	local timer t=CreateTimer()
	//call SaveUnitHandle(MHT,GetHandleId(u),'SPRT',d)
	call TimerStart(t,0.25,true,function Kotl_SpiritForm_MoveDummy)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call SaveUnitHandle(HY,GetHandleId(t),1,d)
	call SaveBoolean(MHT,GetHandleId(u),'SPRT',true)
	set t=null
	set d=null
endfunction

function Kotl_SpiritForm takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'QM01')//QM01 -> Spirit Form
	local player p=GetOwningPlayer(u)
	local boolean morphOn=GetUnitTypeId(u)!='H06X'//H06X -> Keeper of the Light
	call SetPlayerAbilityAvailable(p,'A11X',morphOn)//A11X -> Blinding Light
	call SetPlayerAbilityAvailable(p,'A10U',morphOn)//A10U -> Recall
	call SetUnitAbilityLevel(u,'A11X',lvl)//A11X -> Blinding Light
	call SetUnitAbilityLevel(u,'A10U',lvl)//A10U -> Recall
	if morphOn then
		if LoadBoolean(MHT,GetHandleId(u),'SPRT')!=true then//no dummy
			call Kotl_SpiritForm_Init(u)
		endif
	endif
	set u=null
endfunction

function Keeper_Illuminate_End takes nothing returns nothing
	call SaveBoolean(MHT,GetHandleId(GetTriggerUnit()),'A085',false)//A085 -> Illuminate
endfunction

function Keeper_Illuminate_Check takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local integer id =  GetUnitTypeId(u)
	if id<'H06W' or id>'H06Y' then//H06W -> Keeper of the Light 3, H06Y -> Keeper of the Light 2
		call SaveBoolean(MHT,GetHandleId(u),'A085',false)//A085 -> Illuminate
	endif
	set u = null
endfunction

function Keeper_Illuminate_Targets takes nothing returns boolean
	local unit u = GetFilterUnit()
	local integer id = GetUnitTypeId(u)
	if IsDead(u)==false and IsUnitInGroup(u,ILLUMINATEGROUP)==false and GetUnitAbilityLevel(u,'A04R')==0 and IsUnitType(u,UNIT_TYPE_STRUCTURE)==false then//
		call GroupAddUnit(ILLUMINATEGROUP,u)
		if IsUnitEnemy(u,group_temp_player) then
			call DamageTarget(group_temp_unit[0],u,1,group_temp_integer[0])
		elseif tt_bool1 then
			call SetWidgetLife(u,GetWidgetLife(u)+group_temp_integer[0]*0.75)
		endif
	endif
	set u = null
	return false
endfunction

function Keeper_Illuminate_Effect takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local unit u = LoadUnitHandle(MHT,info,0)
	local real x
	local real y
	local real s = LoadReal(MHT,info,StringHash("scale"))
	local unit cho = LoadUnitHandle(MHT,info,1)
	if count==1then
		call KillGroup(LoadGroupHandle(MHT,info,2))
		call Timer_End(t)
		call KillUnit(u)
		set t = null
		set u = null
		return
	endif
	call SaveInteger(MHT,info,0,count - 1)
	set x = GetWidgetX(u) + LoadReal(MHT,info,3)
	set y = GetWidgetY(u) + LoadReal(MHT,info,4)
	call SetUnitX(u,x)
	call SetUnitY(u,y)
	if s<0.4 then
		set s=s+0.025
	elseif s<1.5 and s>0.4 then
		set s=s+0.09
	else
		set s=1.5
	endif
	call SetUnitScale(u,s,s,s)
	call SaveReal(MHT,info,StringHash("scale"),s)
	call TimedReveal(GetOwningPlayer(cho),2.5,x,y,375)
	set group_temp_player = LoadPlayerHandle(MHT,info,2)
	set group_temp_unit[0] = cho
	set group_temp_integer[0] = LoadInteger(MHT,info,1)
	set ILLUMINATEGROUP = LoadGroupHandle(MHT,info,3)
	set tt_bool1=IsUnitHasAghanim(u)
	call GroupEnumUnitsInRange(temp_group,x,y,375,Condition(function Keeper_Illuminate_Targets))
	set cho=null
	set t = null
	set u = null
endfunction

function Keeper_Illuminate_Charge takes nothing returns nothing
	local real s
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0) - 1
	local unit u = LoadUnitHandle(MHT,info,0)
	local unit cho

	if count==0 or LoadBoolean(MHT,GetHandleId(LoadUnitHandle(MHT,info,1)),'A085')==false then//A085 -> Illuminate
		call KillUnit(u)

		set cho=CreateUnit(Player(15),'h070',LoadReal(MHT,info,0),LoadReal(MHT,info,1),LoadReal(MHT,info,2))//h070 -> Coco's Rum
		call SetUnitScale(cho,0.1,0.1,0.1)
		call SaveReal(MHT,info,StringHash("scale"),0.15)
		call SaveInteger(MHT,info,0,61)
		call SaveInteger(MHT,info,1,(LoadInteger(MHT,info,1) - count)*10)
		call SaveUnitHandle(MHT,info,0,cho)
		call SaveGroupHandle(MHT,info,3,GetAvailableGroup())

		call TimerStart(t,0.025,true,function Keeper_Illuminate_Effect)

		call SaveBoolean(MHT,GetHandleId(LoadUnitHandle(MHT,info,1)),'A085',false)//A085 -> Illuminate
		call SetPlayerAbilityAvailable2(LoadPlayerHandle(MHT,info,2),'A121',false)//A121 -> Illuminate End
		call SetPlayerAbilityAvailable2(LoadPlayerHandle(MHT,info,2),'A085',true)//A085 -> Illuminate

		call RemoveUnit(LoadUnitHandle(MHT,info,4))
		set cho=null
		set t = null
		set u = null
		return
	endif

	set s = 1 + (LoadInteger(MHT,info,1) - count) * 0.1
	call SetUnitScale(u,s,s,s)

	call SaveInteger(MHT,info,0,count)

	set t = null
	set u = null
endfunction

function Keeper_Illuminate_Start takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local player p = GetOwningPlayer(u)
	local real x = GetWidgetX(u)
	local real y = GetWidgetY(u)
	local real a = Atan2(GetSpellTargetY()-y,GetSpellTargetX()-x)
	local real x1 = x + 150*Cos(a)
	local real y1 = y + 150*Sin(a)
	local integer info = GetHandleId(t)
	local integer i = GetUnitAbilityLevel(u,'A085')*10 + 10//A085 -> Illuminate

	call SetPlayerAbilityAvailable2(p,'A085',false)//A085 -> Illuminate
	call SetPlayerAbilityAvailable2(p,'A121',true)//A121 -> Illuminate End
	call UnitAddAbility2(u,'A121')//A121 -> Illuminate End

	call SaveUnitHandle(MHT,info,0,CreateUnit(Player(15),'u00J',x1,y1,a*bj_RADTODEG))//u00J -> Illuminate Orb


	call SavePlayerHandle(MHT,info,2,p)
	call SaveInteger(MHT,info,0,i)
	call SaveInteger(MHT,info,1,i)

	call SaveReal(MHT,info,0,x1)
	call SaveReal(MHT,info,1,y1)
	call SaveReal(MHT,info,2,a*bj_RADTODEG)
	call SaveReal(MHT,info,3,26.25*Cos(a))
	call SaveReal(MHT,info,4,26.25*Sin(a))


	if GetUnitTypeId(u)=='e00E' then //multicast//e00E -> Spellcaster
		call SaveUnitHandle(MHT,info,1,udg_Hero[GetPlayerId(p)])

		call SaveBoolean(MHT,GetHandleId(udg_Hero[GetPlayerId(p)]),'A085',true)//A085 -> Illuminate
	else
		call SaveUnitHandle(MHT,info,1,u)
		call SaveBoolean(MHT,GetHandleId(u),'A085',true)//A085 -> Illuminate

		if GetUnitTypeId(u)>='H06W' and GetUnitTypeId(u)<='H06Y' then//H06W -> Keeper of the Light 3, H06Y -> Keeper of the Light 2
			set u = CreateUnit(p,'h06Z',x,y,a*bj_RADTODEG)//h06Z -> Ezalor Dummy
			call SetUnitX(u,x)
			call SetUnitY(u,y)
			call SetUnitAnimation(u,"spell")
			call QueueUnitAnimation(u,"spell")
			call SetUnitVertexColor(u,255,255,255,75)
			call SaveUnitHandle(MHT,info,4,u)
		endif
	endif
	call TimerStart(t,0.1,true,function Keeper_Illuminate_Charge)
	set t = null
	set u = null
endfunction

function YLE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real RLD=(LoadReal(HY,h,242))
	call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)+RLD)
	call UnitAddAbilityTimedExF(Target,'A3DU'-1+LoadInteger(HY,h,5),1,12,'B3DU')//B3DU -> |c0000ff00Chakra Magic|r
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIim\\AIimTarget.mdl",Target,"origin"))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set Target=null
	set t=null
	return false
endfunction

function Kotl_ChakraMagic takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,5,GetUnitAbilityLevel(Hero,'A112'))//A112 -> Chakra Magic
	call SaveReal(HY,h,242,((75*GetUnitAbilityLevel(Hero,'A112'))*1.))//A112 -> Chakra Magic
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function YLE))
	set t=null
	set Hero=null
	set Target=null
endfunction

function Y5E takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local real x=GetUnitX(Target)
	local real y=GetUnitY(Target)
	local real a=Atan2(y-FG8,x-FF8)
	set x=SafeX50(x+40*Cos(a))
	set y=SafeY50(y+40*Sin(a))
	call KillTrees(x,y,150)
	call SetUnitX(Target,x)
	call SetUnitY(Target,y)
	set Target=null
endfunction

function Y2E takes nothing returns nothing
	call UnitAddAbilityTimedExF(GetEnumUnit(),'A3PZ',1,3+FE8,'B09K')
endfunction

function Z4E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local player p=(LoadPlayerHandle(HY,h,54))
	local real SourceX=(LoadReal(HY,h,189))
	local real SourceY=(LoadReal(HY,h,190))
	local integer CG8=(LoadInteger(HY,h,59))
	local group g=(LoadGroupHandle(HY,h,22))
	local integer Count=GetTriggerEvalCount(t)
	set FF8=SourceX
	set FG8=SourceY
	call ForGroup(g,function Y5E)
	if Count==10 then
		set FE8=CG8
		set tt_player1=p
		call ForGroup(g,function Y2E)
		call KillGroup(g)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set p=null
	set g=null
	return false
endfunction

function Z7E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local player p=(LoadPlayerHandle(HY,h,54))
	local real SourceX=(LoadReal(HY,h,189))
	local real SourceY=(LoadReal(HY,h,190))
	local integer CG8=(LoadInteger(HY,h,59))
	local group g=(LoadGroupHandle(HY,h,22))
	call CleanTrigger(t)
	call FlushChildHashtable(HY,h)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.04,true)
	call TriggerAddCondition(t,Condition(function Z4E))
	call SavePlayerHandle(HY,h,54,(p))
	call SaveReal(HY,h,189,((SourceX)*1.))
	call SaveReal(HY,h,190,((SourceY)*1.))
	call SaveGroupHandle(HY,h,22,(g))
	call SaveInteger(HY,h,59,(CG8))
	set t=null
	set p=null
	set g=null
	return false
endfunction

function Kotl_BlindingLight takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local group g=GetAvailableGroup()
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	call KillUnit(CreateUnit(GetOwningPlayer(Source),'h06P',x,y,0))//h06P -> Blinding Light
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,700,Condition(function NonImmuneEnemyFilter))
	call TriggerRegisterTimerEvent(t,.4,false)
	call TriggerAddCondition(t,Condition(function Z7E))
	call SavePlayerHandle(HY,h,54,(GetOwningPlayer(Source)))
	call SaveReal(HY,h,189,((x)*1.))
	call SaveReal(HY,h,190,((y)*1.))
	call SaveGroupHandle(HY,h,22,(g))
	call SaveInteger(HY,h,59,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call EvasionSourceActivate(EVASION_DEBUFF_BLINDINGLIGHT,8)
	set t=null
	set g=null
	set Source=null
endfunction

function FierySoul_Tick takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u
	local integer stacks
	if TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0) then
		set u=LoadUnitHandle(HY,h,0)
		call RemoveSavedHandle(HY,GetHandleId(u),'A18X')//A18X -> Fiery Soul
		call LoDStat_Sub(u,LoadInteger(HY,h,1),"attack")
		call SubBonusMSPercent(u,LoadInteger(HY,h,2))
		set stacks=LoadInteger(HY,h,0)
		call DestroyEffect(LoadEffectHandle(HY,h,10+1))
		call DestroyEffect(LoadEffectHandle(HY,h,20+1))
		if stacks>=2 then
			call DestroyEffect(LoadEffectHandle(HY,h,10+2))
			call DestroyEffect(LoadEffectHandle(HY,h,20+2))
		endif
		if stacks>=3 then
			call DestroyEffect(LoadEffectHandle(HY,h,10+3))
			call DestroyEffect(LoadEffectHandle(HY,h,20+3))
		endif
		call UnitRemoveAbility(u,'C021')
		call UnitRemoveAbility(u,'D021')//D021 -> |cff32cd32Fiery Soul|r
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		set u=null
	endif
	set t=null
endfunction

function FierySoul_Start takes unit u returns nothing
	local trigger t=LoadTriggerHandle(HY,GetHandleId(u),'A18X')//A18X -> Fiery Soul
	local integer h
	local integer stacks
	local integer as
	local integer ms
	if t==null then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.5,true)
		call TriggerAddCondition(t,Condition(function FierySoul_Tick))
		call SaveUnitHandle(HY,h,0,u)
		call UnitAddAbility2(u,'C021')
		call SaveTriggerHandle(HY,GetHandleId(u),'A18X',t)//A18X -> Fiery Soul
	else
		set h=GetHandleId(t)
	endif
	call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+9)
	set stacks=LoadInteger(HY,h,0)
	if stacks<3 then
		call SaveInteger(HY,h,0,stacks+1)
		set as = 20 + 10*(GetUnitAbilityLevel(u,'A18X'))//A18X -> Fiery Soul, QP1U -> Fiery Soul
		set ms = 4+1*(GetUnitAbilityLevel(u,'A18X'))//A18X -> Fiery Soul, QP1U -> Fiery Soul
		call LoDStat_Add(u,as,"attack")
		call AddBonusMSPercent(u,ms)
		call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+as)
		call SaveInteger(HY,h,2,LoadInteger(HY,h,2)+ms)
		call SaveEffectHandle(HY,h,10 + stacks+1,AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile_mini.mdl",u,"head"))
		call SaveEffectHandle(HY,h,20 + stacks+1,AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile_mini.mdl",u,"chest"))
	endif
	
	set t=null
endfunction

function ZIE takes nothing returns boolean
	if GetUnitAbilityLevel(GetTriggerUnit(),'A36D')==0 and (Valid_Spell(GetSpellAbilityId()) or (Mode_BO and BalanceOffSpellChecker(GetSpellAbilityId()))) then
		call FierySoul_Start(GetTriggerUnit())
	endif
	return false
endfunction

function Lina_FierySoul_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function ZIE))
	set t=null
endfunction

function Lina_LagunaBlade_OnCast takes nothing returns nothing
	if IsMagicImmune(GetSpellTargetUnit())then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0LR'))//n0LR -> Target is magic immune
	endif
endfunction

function LightStrikArrayHit takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local integer lvl=LoadInteger(HY,h,0)
	local unit u
	local group g=GetAvailableGroup()
	local real stun=1.6
	local real damage=40+40*lvl
	set tt_unit1=caster
	call GroupEnumUnitsInRange(g,LoadReal(HY,h,10),LoadReal(HY,h,11),225+20,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call DamageTarget(caster,u,1,damage)
		if IsDead(u)==false then
			call StunTargetLoD(u,stun)
		endif
		
		call GroupRemoveUnit(g,u)
	endloop
//	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',LoadReal(HY,h,10),LoadReal(HY,h,11),0)//e00E -> Spellcaster
//	call UnitAddAbility(d,'A33U')
//	call SetUnitAbilityLevel(d,'A33U',lvl)
//	call IssueImmediateOrder(d,"stomp")
	call KillTrees(LoadReal(HY,h,10),LoadReal(HY,h,11),225)
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
//	set d=null
	set caster=null
	set t=null
endfunction

function LoDLightStrikeArray_Cast takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0.5,false,function LightStrikArrayHit)
	//call AddEffectPointTimed("Abilities\\Spells\\Other\\Awaken\\Awaken.mdl",GetSpellTargetX(),GetSpellTargetY(),0.5)
	call SaveUnitHandle(HY,h,0,GetTriggerUnit())
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))//A027 -> Light Strike Array
	call SaveReal(HY,h,10,GetSpellTargetX())
	call SaveReal(HY,h,11,GetSpellTargetY())
	
	set t=null
endfunction

function Lina_LagunaBladeUpgAct takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local real dmg=0
	local integer lvl=LoadInteger(HY,h,0)
	if lvl==1 then
		set dmg=450
	elseif lvl==2 then
		set dmg=650
	elseif lvl==3 then
		set dmg=850
	endif
	call DamageTarget(caster,target,LoadInteger(HY,h,1),dmg)
	call CleanTimer(t)
	set caster=null
	set target=null
	set t=null
endfunction

function Lina_LagunaBladeUpg takes nothing returns nothing
	local timer t
	if IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		call TimerStart(t,0.25,false,function Lina_LagunaBladeUpgAct)
		call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
		call SaveUnitHandle(HY,GetHandleId(t),1,GetSpellTargetUnit())
		call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
		if GetSpellAbilityId()=='A01P'then
			call SaveInteger(HY,GetHandleId(t),1,1)
		else
			call SaveInteger(HY,GetHandleId(t),1,7)
		endif
		set t=null
	endif
endfunction

function Lina_DragonSlave takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetUnitFacing(GetTriggerUnit()))
	call UnitAddAbility(d,'A3IJ')
	call SetUnitAbilityLevel(d,'A3IJ',GetUnitAbilityLevel(GetTriggerUnit(),'A01F'))
	if GetSpellTargetUnit()==GetTriggerUnit() then
		call DummyWave(d,"carrionswarm",GetUnitX(GetTriggerUnit())+1*Cos(bj_DEGTORAD*GetUnitFacing(GetTriggerUnit())),GetUnitY(GetTriggerUnit())+1*Sin(bj_DEGTORAD*GetUnitFacing(GetTriggerUnit())))
	else
		call DummyWave(d,"carrionswarm",GetSpellTargetX(),GetSpellTargetY())
	endif
	//call IssuePointOrder(d,"carrionswarm",GetSpellTargetX(),GetSpellTargetY())
	set d=null
endfunction

function Luna_Aura_Targets takes nothing returns nothing
	local integer key
	local integer info
	local unit u = GetFilterUnit()

	if IsUnitType(u,UNIT_TYPE_HERO)and IsUnitAlly(u,group_temp_player)and IsDead(u)==false then
		call GroupAddUnit(temp_group2,u)		 //adds the unit to group of currently affected units

		if IsUnitInGroup(u,group_temp_group)==false then  //hasn't been affected by the aura
			set info = GetHandleId(u)
			set key = StringHash("lunar_count")

			call Buff_Add(u,'C032','D032',-1) //adds the buff
			call LoDStat_Add(u,group_temp_integer[1],"damage")		//adds new damage

			call SaveInteger(MHT,info,key,LoadInteger(MHT,info,key) + 1) //keeps track of the number of times the unit has been affected for correct buff removal

			set u = null
			return
		endif

		call GroupRemoveUnit(group_temp_group,u) //removes the unit from the group of previously affected units

		if LoadBoolean(MHT,99999,99998)then			  //checks to see if the amount of bonus damage has changed
			call LoDStat_Add(u,group_temp_integer[1],"damage") //updates damage amount
			call LoDStat_Sub(u,group_temp_integer[0],"damage") //removes old damage
		endif
	endif

	set u = null
endfunction

function Luna_Aura_Duration takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer key = StringHash("lunar_count")
	local integer info = GetHandleId(t)
	local unit u = LoadUnitHandle(MHT,info,0)
	set group_temp_group = LoadGroupHandle(MHT,info,1)
	set group_temp_integer[0] = LoadInteger(MHT,info,0)
	if IsDead(u)then
		set u = FirstOfGroup(group_temp_group)
		if u!=null then //checks to see if any units are still being affected by the aura and removes the bonuses if they are
			loop
				set info = GetHandleId(u)
				call SaveInteger(MHT,info,key,LoadInteger(MHT,info,key) - 1)
				if LoadInteger(MHT,info,key)==0then
					call Buff_Remove(u,'D032')
				endif
				call LoDStat_Sub(u,group_temp_integer[0],"damage")
				call GroupRemoveUnit(group_temp_group,u)
				set u = FirstOfGroup(group_temp_group)
				exitwhen u==null
			endloop
		endif
		set u=null
		set t = null
		return
	endif
	set group_temp_integer[1] = GetUnitAbilityLevel(u,'A062')*8 + 6//A062 -> Lunar Blessing, QP0E -> Lunar Blessing
	set group_temp_player = GetOwningPlayer(u)
	if group_temp_integer[0]!=group_temp_integer[1] then
		call SaveBoolean(MHT,99999,99998,true)
		call SaveInteger(MHT,info,0,group_temp_integer[1]) //updates the current amount of damage being added
	else
		call SaveBoolean(MHT,99999,99998,false)
	endif
	call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),925,Condition(function Luna_Aura_Targets))
	//removes the bonuses from any unit out of range
	loop
		set u = FirstOfGroup(group_temp_group)
		exitwhen u==null
		set info = GetHandleId(u)
		call SaveInteger(MHT,info,key,LoadInteger(MHT,info,key) - 1)
		if LoadInteger(MHT,info,key)==0then
			call Buff_Remove(u,'D032')
		endif
		call LoDStat_Sub(u,group_temp_integer[0],"damage")
		call GroupRemoveUnit(group_temp_group,u)
	endloop
	//updates the current group with the newly affected units
	loop
		set u = FirstOfGroup(temp_group2)
		exitwhen u==null
		call GroupRemoveUnit(temp_group2,u)
		call GroupAddUnit(group_temp_group,u)
	endloop
	set t = null
endfunction

function Luna_Aura_Learn takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local integer info = GetHandleId(t)
	call SaveBoolean(MHT,99999,99998,true) //has the amount of bonus damage changed, set to true initially (duh)
	set group_temp_group = CreateGroup()
	set group_temp_player = GetOwningPlayer(u)
	set group_temp_integer[0] = 0				//previous bonus damage, set to 0 since its the first time
	set group_temp_integer[1] = GetUnitAbilityLevel(u,'A062')*8 + 6//A062 -> Lunar Blessing, QP0E -> Lunar Blessing
	call SaveUnitHandle(MHT,info,0,u)
	call SaveGroupHandle(MHT,info,1,group_temp_group)  //previously affected units
	call SaveInteger(MHT,info,0,group_temp_integer[1]) //the current amount of damage being added
	call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),925,Condition(function Luna_Aura_Targets))
	//adds all the affected unit to the currrent group
	loop
		set u = FirstOfGroup(temp_group2)
		exitwhen u==null
		call GroupRemoveUnit(temp_group2,u)
		call GroupAddUnit(group_temp_group,u)
	endloop
	call SetPlayerTechResearched(group_temp_player,'R00I',1)
	call TimerStart(t,0.25,true,function Luna_Aura_Duration)
	set u=null
	set t = null
endfunction

function MoonGlaiveFilter takes nothing returns boolean
	local unit Picked=GetFilterUnit()
	local real Distance=DistanceBetweenUnits(Picked,LoDMoonGlaive_Origin)
	if Picked!=LoDMoonGlaive_Origin and IsUnitEnemy(Picked,GetOwningPlayer(LoDMoonGlaive_Source)) and IsDead(Picked)==false and C58(Picked)==false and Distance < LoDMoonGlaive_MaxDistance and (GetUnitAbilityLevel(Picked,'A04R')==0) and GetUnitAbilityLevel(Picked,'Avul')==0 and IsUnitVisibleLoD(Picked,GetOwningPlayer(LoDMoonGlaive_Source)) and IsUnitInRangeXY(Picked,GetUnitX(LoDMoonGlaive_Origin),GetUnitY(LoDMoonGlaive_Origin),460)  then//, Avul -> Invulnerable
		set LoDMoonGlaive_MaxDistance=Distance
		set LoDMoonGlaive_Target=Picked
	endif
	set Picked=null
	return false
endfunction

function MoonGlaiveHit takes nothing returns nothing
	local group g
	local integer hu
	local trigger t
	local integer ht
	local unit d=LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),45)
	local integer count=LoadInteger(HY,GetHandleId(d),0)-1
	local unit attacker=LoadUnitHandle(HY,GetHandleId(d),0)
	local unit target=tt_unit2
	local real dmg=LoadReal(HY,GetHandleId(d),0)
	call FlushChildHashtable(HY,GetHandleId(d))
	call DamageTarget(attacker,target,2,dmg)
	if count>0 then
		set LoDMoonGlaive_Origin=target
		set LoDMoonGlaive_Source=attacker
		set LoDMoonGlaive_MaxDistance=9999
		set LoDMoonGlaive_Target=null
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),450,Condition(function MoonGlaiveFilter))
		call KillGroup(g)
		set g=null
		if LoDMoonGlaive_Target!=null then
			set t=AddProjectile(target,LoDMoonGlaive_Target,'h999',"MoonGlaiveHit",880,true)//h999 -> LoD Moon Glaive
			set ht=GetHandleId(t)
			set hu=GetHandleId(LoadUnitHandle(HY,ht,45))
			call SaveInteger(HY,hu,0,count)//store lvl in dummy
			call SaveReal(HY,hu,0,dmg*0.6)
			call SaveUnitHandle(HY,hu,0,attacker)
			set t=null
		endif
	endif
	set g=null
	set attacker=null
	set target=null
	set d=null
endfunction

function MoonGlaive takes unit attacker, unit target returns nothing
	local group g=GetAvailableGroup()
	local integer lvl=GetUnitAbilityLevel(attacker,'P098')
	local integer hu
	local trigger t
	local integer ht
	local integer count
	//call echo(I2S(lvl))
	set LoDMoonGlaive_Origin=target
	set LoDMoonGlaive_Source=attacker
	set LoDMoonGlaive_MaxDistance=9999
	set LoDMoonGlaive_Target=null
	call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),450,Condition(function MoonGlaiveFilter))
	call KillGroup(g)
	set g=null
	call UnitRemoveAbility(target,'B999')//B999 -> Moon Glaive
	if LoDMoonGlaive_Target!=null then
		set count=lvl
		set t=AddProjectile(target,LoDMoonGlaive_Target,'h999',"MoonGlaiveHit",880,true)//h999 -> LoD Moon Glaive
		set ht=GetHandleId(t)
		set hu=GetHandleId(LoadUnitHandle(HY,ht,45))
		call SaveInteger(HY,hu,0,count)//store lvl in dummy
		if IsUnitIllusion(attacker)then
			set GetUnitPhysicalResistance_Result=1
		else
			call GetUnitPhysicalResistance(target)
		endif
		call SaveReal(HY,hu,0,GetEventDamage()/GetUnitPhysicalResistance_Result*0.65)
		call SaveUnitHandle(HY,hu,0,attacker)
		set t=null
	endif
endfunction

function DarknessStop takes nothing returns nothing
	call SaveBoolean(MHT,'DARK',0,false)
	call SuspendTimeOfDay(false) 
	call SetFloatGameState(GAME_STATE_TIME_OF_DAY,LoadReal(MHT,'DARK',1))
endfunction

function ImitateNightEffect takes real dur, boolean b returns nothing
	local real curTime=TimerGetElapsed(GlobalTimer)
	local real darknessEnd=LoadReal(MHT,'DARK',0)
	local real endTime
	local real mindur
	local real finaltime
	set mindur=dur / 20.0//ingame time is different
	if curTime+dur>darknessEnd then
		call TimerStart(DarknessTimer,dur+0.1,false,function DarknessStop)
		call SaveReal(MHT,'DARK',0,curTime+dur)
		call SuspendTimeOfDay(true)
		if LoadBoolean(MHT,'DARK',0)==false then//if false there are no other darkness so time is real, not 00:00. when true it always 00:00
			set curTime=GetFloatGameState(GAME_STATE_TIME_OF_DAY)
			set finaltime=curTime+mindur
			if finaltime >= 24 then
				set finaltime=finaltime-24.
			endif
			call SaveReal(MHT,'DARK',1,finaltime)
		endif
		call echo(R2S(finaltime)+" "+R2S(mindur))
		if b then
			call SetFloatGameState(GAME_STATE_TIME_OF_DAY,0)
		endif
		call SaveBoolean(MHT,'DARK',0,true)
	endif
endfunction

function ZOE takes nothing returns boolean
	if NonImmuneEnemyFilterWithAncients() and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))then
		if(LoadInteger(HY,(FH8),(GetHandleId(GetFilterUnit()))))<tt_int1 then
			return true
		endif
	endif
	return false
endfunction

function ZPE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,14))
	local integer ZQE=(LoadInteger(HY,h,217))
	local integer XCE=(LoadInteger(HY,h,216))
	local integer ZRE=(LoadInteger(HY,h,218))
	local group g=GetAvailableGroup()
	local real x=GetUnitX(caster)
	local real y=GetUnitY(caster)
	local unit Target
	local boolean b
	local unit damager=LoadUnitHandle(HY,h,0)
	if LoadBoolean(HY,h,0) then
		set b=true
		set x=LoadReal(HY,h,0)
		set y=LoadReal(HY,h,1)
	else
		set b=IsDead(caster)==false
		set x=GetUnitX(caster)
		set y=GetUnitY(caster)
	endif
	set tt_unit1=caster
	set tt_int1=ZRE
	set FH8=GetHandleId(t)
	call GroupEnumUnitsInRange(g,x,y,700,Condition(function ZOE))
	set Target=GroupPickRandomUnit(g)
	call KillGroup(g)
	if b and Target!=null and (GetUnitTypeId((Target))!='u009') then//u009 -> Revenant
		call SaveInteger(HY,(FH8),(GetHandleId(Target)),((LoadInteger(HY,(FH8),(GetHandleId(Target))))+1))
		call Z48("effects\\Eclipse.mdx",Target,"origin",3)
		call DamageTarget(caster,Target,1,300)
	elseif b then
		set x=x+GetRandomInt(-350,350)
		set y=y+GetRandomInt(-350,350)
		call ZD8("effects\\Eclipse.mdx",x,y,1.5)
	endif
	if(GetTriggerEvalCount(t)+1)==XCE or b==false then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set caster=null
	set g=null
	set Target=null
	return false
endfunction

function Luna_Eclipse takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer total
	local integer beamlvl=4
	local integer lim
	if GetSpellAbilityId()=='A054' then//A054 -> Eclipse
		set total=2+3*GetUnitAbilityLevel(caster,'A054')//A054 -> Eclipse
		call SaveUnitHandle(HY,h,0,caster)
		set lim=5+GetUnitAbilityLevel(caster,'A054')//A054 -> Eclipse
		call AddEffectPointTimed("Abilities\\Spells\\NightElf\\Tranquility\\Tranquility.mdx",GetUnitX(caster),GetUnitY(caster),2)
	else
		set total=6*GetUnitAbilityLevel(caster,'A00U')//A00U -> Eclipse
		set lim=60
		call SaveUnitHandle(HY,h,0,caster)
		if GetSpellTargetUnit()==null or IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(caster)) then
			call SaveBoolean(HY,h,0,true)
			call SaveReal(HY,h,0,GetSpellTargetX())
			call SaveReal(HY,h,1,GetSpellTargetY())
			call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(caster),'o01P',GetSpellTargetX(),GetSpellTargetY(),0),'BTLF',7)//o01P -> Vision Dummy (1800/800)
			call AddEffectPointTimed("Abilities\\Spells\\NightElf\\Tranquility\\Tranquility.mdx",GetSpellTargetX(),GetSpellTargetY(),2)
		else
			set caster=GetSpellTargetUnit()
			call AddEffectTargetTimed("Units\\NightElf\\Owl\\Owl.mdl",caster,"origin",4)
			call AddEffectPointTimed("Abilities\\Spells\\NightElf\\Tranquility\\Tranquility.mdx",GetUnitX(caster),GetUnitY(caster),2)
		endif
	endif
	call SaveInteger(HY,(h),217,(beamlvl))
	call SaveInteger(HY,(h),216,(total))
	call SaveInteger(HY,(h),218,(lim))
	call SaveUnitHandle(HY,(h),14,(caster))
	call TriggerRegisterTimerEvent(t,0.6,true)
	call TriggerAddCondition(t,Condition(function ZPE))
	call TriggerEvaluate(t)
	call ImitateNightEffect(10.,true)
	
	set t=null
	set caster=null
endfunction

function LucentBeamWrapper takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetUnitFacing(GetTriggerUnit()))
	call UnitAddAbility(d,'A3IE')
	call SetUnitAbilityLevel(d,'A3IE',GetUnitAbilityLevel(GetTriggerUnit(),'A042'))
	call IssueTargetOrder(d,"firebolt",GetSpellTargetUnit())
	set d=null
endfunction

function ZUE takes nothing returns nothing
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl",GetEnumUnit(),"origin"))
endfunction

function ZVE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local unit Target=LoadUnitHandle(HY,h,30)
	call DamageTarget(Hero,Target,1,LoadInteger(HY,h,0)*56.25)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	set Target=null
	return false
endfunction

function ZWE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local group g=GetAvailableGroup()
	local unit Target=LoadUnitHandle(HY,h,30)
	local integer lvl=LoadInteger(HY,h,0)
	if IsDead(Target) then
		set FJ8=Hero
		set g=GetAvailableGroup()
		set tt_unit1=Hero
		call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),450,Condition(function LT8))
		set Target=GetClosestOfGroup(g,GetUnitX(Hero),GetUnitY(Hero))
		call KillGroup(g)
		set g=null
	endif
	call DestroyEffect(LoadEffectHandle(HY,h,32))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl",Target,"origin"))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveUnitHandle(HY,h,30,Target)
	call SaveInteger(HY,h,0,lvl)
	call TriggerRegisterTimerEvent(t,.5,false)
	call TriggerAddCondition(t,Condition(function ZVE))
	set t=null
	set Hero=null
	set Target=null
	return false
endfunction

function ZXE takes nothing returns nothing
	call DamageTarget(FJ8,GetEnumUnit(),1,FI8)
endfunction

function ZYE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local group g=LoadGroupHandle(HY,h,22)
	set FI8=LoadInteger(HY,h,0)*75
	set FJ8=Hero
	call ForGroup(g,function ZXE)
	call KillGroup(g)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	set g=null
	return false
endfunction

function ZZE takes nothing returns nothing
	if DistanceBetweenUnits(GetTriggerUnit(),GetEnumUnit())<=650 then
		call GroupAddUnit(DK,GetEnumUnit())
	endif
endfunction

function Potm_Starfall takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit caster=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local unit Target
	set tt_unit1=caster
	set FJ8=caster
	set DK=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),900,Condition(function LT8))
	call ForGroup(g,function ZZE)
	call KillGroup(g)
	set g=DK
	call ForGroup(g,function ZUE)
	call SaveGroupHandle(HY,h,22,g)
	call SaveUnitHandle(HY,h,14,caster)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
	call TriggerRegisterTimerEvent(t,.5,false)
	call TriggerAddCondition(t,Condition(function ZYE))
	set FJ8=caster
	set g=GetAvailableGroup()
	set tt_unit1=caster
	call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),450,Condition(function LT8))
	set Target=GetClosestOfGroup(g,GetUnitX(caster),GetUnitY(caster))
	call KillGroup(g)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call SaveUnitHandle(HY,h,14,caster)
	call SaveUnitHandle(HY,h,30,(Target))
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Starfall\\StarfallCaster.mdl",caster,"origin"))
	call TriggerRegisterTimerEvent(t,1,false)
	call TriggerAddCondition(t,Condition(function ZWE))
	set t=null
	set g=null
	set caster=null
	set Target=null
endfunction

function Z3E takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())))!=null
endfunction

function Func2150 takes nothing returns nothing
	call UnitRemoveAbility(GetEnumUnit(),'A37P')
	call UnitRemoveAbility(GetEnumUnit(),'A37Q')
	call UnitRemoveAbility(GetEnumUnit(),'A37R')
	call UnitRemoveAbility(GetEnumUnit(),'A3AF')
	call UnitRemoveAbility(GetEnumUnit(),'B3AF')
endfunction

function Func2151 takes nothing returns nothing
	local timer loc_timer01=GetExpiredTimer()
	local integer loc_integer01=GetHandleId(loc_timer01)
	local group g=(LoadGroupHandle(HY,(loc_integer01),220))
	call ForGroup(g,function Func2150)
	call KillGroup(g)
	call CleanTimer(loc_timer01)
	set loc_timer01=null
endfunction

function Potm_MoonlightShadows takes nothing returns nothing
	local unit loc_unit01=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local timer loc_timer01=CreateTimer()
	local integer loc_integer01=GetHandleId(loc_timer01)
	local integer lvl=GetUnitAbilityLevel(loc_unit01,('A0KU'))//A0KU -> Moonlight Shadow
	local real loc_real01=15
	local string s
	local unit u
	call GroupEnumUnitsInRange(g,0,0,9999,Condition(function Z3E))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		set s=""
		call RemoveEndlessFadetime(u)
		call UnitAddAbilityTimedExF(u,'A37P'-1+lvl,1,15.,0)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Invisibility\\InvisibilityTarget.mdl",u,"chest"))
		if IsPlayerAlly(GetOwningPlayer(u),GetLocalPlayer()) or IsObserver(GetLocalPlayer()) then
			set s="Moonlight_Shadow.mdx"
		endif
		call AddEffectTargetTimed(s,u,"overhead",15.)
		call GroupRemoveUnit(g,u)
	endloop
	
	call SaveGroupHandle(HY,(loc_integer01),220,(g))
	call TimerStart(loc_timer01,loc_real01,false,function Func2151)
	set loc_timer01=null
endfunction

function Z2E takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(TmpUnit376)))!=null
endfunction

function A4E takes nothing returns nothing
	local unit Hero=GetEnumUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e01R',0,0,0)//e01R -> Buff Placer
	call UnitAddAbility2(Caster,'A0LO')//A0LO -> Leap (effect)
	call SetUnitAbilityLevel(Caster,'A0LO',Potm_Leap_lvl)//A0LO -> Leap (effect)
	call UnitApplyTimedLife(Caster,'BTLF',10)
	set Hero=null
	set Caster=null
endfunction

function A7E takes unit Hero, integer lvl returns nothing
	local group g=GetAvailableGroup()
	set TmpUnit376=Hero
	set Potm_Leap_lvl=lvl
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),800,Condition(function Z2E))
	call ForGroup(g,function A4E)
	call KillGroup(g)
	set g=null
endfunction

function A8E takes unit Hero returns nothing
	local integer h=GetHandleId(Hero)
	local string A9E=LoadStr(HY,h,206)
	local string ADE=OrderId2String(LoadInteger(HY,h,211))
	local real TargetX
	local real TargetY
	local unit Target
	local trigger t=LoadTriggerHandle(HY,h,204)
	local boolean AEE=not(LoadBoolean(HY,h,207))
	local boolean AFE=LoadBoolean(HY,h,208)
	call DisableTrigger(t)
	call IssueImmediateOrderById(Hero,851972)
	if A9E=="Target"and(AEE or AFE)then
		set Target=LoadUnitHandle(HY,h,215)
		call IssueTargetOrder(Hero,ADE,Target)
	elseif A9E=="Point"and(AEE or AFE)then
		set TargetX=LoadReal(HY,h,209)
		set TargetY=LoadReal(HY,h,210)
		call IssuePointOrder(Hero,ADE,TargetX,TargetY)
	elseif(AEE or AFE)then
		call IssueImmediateOrder(Hero,"OrderString")
	endif
	call SaveBoolean(HY,h,208,false)
	call EnableTrigger(t)
	set Target=null
	set t=null
endfunction

function AGE takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real AHE=LoadReal(HY,h,212)
	local real AIE=LoadReal(HY,h,213)
	local real a=LoadReal(HY,h,13)
	local real AO8=GetUnitX(Hero)+30*Cos(a*bj_DEGTORAD)
	local real AP8=GetUnitY(Hero)+30*Sin(a*bj_DEGTORAD)
	local real AJE=200
	local real AKE=(1-AHE/ AIE)*AJE*2
	if AKE>AJE then
		set AKE=AJE*2-AKE
	endif
	if IsBuggyFlying(Hero)==false then
		call SetUnitFlyHeight(Hero,GetUnitDefaultFlyHeight(Hero)+RMaxIF(AKE,0),0)
	endif
	if IsUnitType(Hero,UNIT_TYPE_HERO)then
		call SaveBoolean(HeroStats,GetHandleId(Hero),99,true)
	endif
	call SetUnitX(Hero,SafeX50(AO8))
	call SetUnitY(Hero,SafeY50(AP8))
	call SetUnitFacing(Hero,a)
	call SaveReal(HY,h,212,(AHE-20)*1.)
	if AKE<1 and AHE-AIE!=0 then
		call SaveBoolean(HY,GetHandleId(Hero),214,false)
		call SetUnitFacing(Hero,a)
		call SetUnitAnimation(Hero,"stand")
		call SetUnitPathing(Hero,true)
		call A8E(Hero)
		if IsBuggyFlying(Hero)==false then
			call SetUnitFlyHeight(Hero,GetUnitDefaultFlyHeight(Hero),0)
		endif
		call PauseTimer(t)
		call FlushChildHashtable(HY,h)
		call DestroyTimer(t)
	endif
	set t=null
	set Hero=null
endfunction

function Potm_Leap takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Hero,('A0LN'))//A0LN -> Leap
	local real YR8=350+50*Level
	local real a=GetUnitFacing(Hero)
	local real SourceX=GetUnitX(Hero)
	local real SourceY=GetUnitY(Hero)
	local real TargetX=SafeX50(SourceX+YR8*Cos(a*bj_DEGTORAD))
	local real TargetY=SafeY50(SourceY+YR8*Sin(a*bj_DEGTORAD))
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local trigger ANE=LoadTriggerHandle(HY,GetHandleId(Hero),204)
	set YR8=SquareRoot((SourceX-TargetX)*(SourceX-TargetX)+(SourceY-TargetY)*(SourceY-TargetY))
	call ShowUnit(Hero,false)
	call ShowUnit(Hero,true)
	if GetLocalPlayer()==GetOwningPlayer(Hero) then
		call ClearSelection()
		call SelectUnit(Hero,true)
	endif
	if YR8>100 then
		call UnitAddAbility2(Hero,'Amrf')//Amrf -> Crow Form
		call UnitRemoveAbility(Hero,'Amrf')//Amrf -> Crow Form
		call SetUnitPathing(Hero,false)
		call DisableTrigger(ANE)
		call IssueImmediateOrderById(Hero,851972)
		call EnableTrigger(ANE)
		call SaveReal(HY,h,212,YR8*1.)
		call SaveReal(HY,h,213,YR8*1.)
		call SaveReal(HY,h,13,a*1.)
		call SaveUnitHandle(HY,h,14,Hero)
		call TimerStart(t,.025,true,function AGE)
		call SaveBoolean(HY,GetHandleId(Hero),214,true)
		call SaveBoolean(HY,GetHandleId(Hero),208,false)
		call A7E(Hero,Level)
	endif
	set Hero=null
	set t=null
	set ANE=null
endfunction

function AVE takes nothing returns boolean
	return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TmpUnit376))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0)!=null//, Aloc -> Locust
endfunction

function Potm_GetStunDur takes integer stunlvl returns real
	if stunlvl<=1 then
		return 0.01
	elseif stunlvl==2 then
		return 0.6
	elseif stunlvl==3 then
		return 1.1
	elseif stunlvl==4 then
		return 1.7
	elseif stunlvl==5 then
		return 2.2
	elseif stunlvl==6 then
		return 2.8
	elseif stunlvl==7 then
		return 3.3
	elseif stunlvl==8 then
		return 3.9
	elseif stunlvl==9 then
		return 4.4
	else
		return 5.0
	endif
	return 0.
endfunction

function DisplayArrowStunTime takes unit u,unit target, integer stun returns nothing
	local texttag tt=CreateTextTag()
	local string s=""
	if GetHandleId(tt)<1 then
		call DestroyTextTag(tt)
	else
		set s=R2SW(Potm_GetStunDur(stun),1,1)
		call SetTextTagText(tt,s,.03)
		call SetTextTagPosUnit(tt,target,0)
		call SetTextTagColorBJ(tt,150,75,255,15)
		call SetTextTagVelocity(tt,0,.035)
		call SetTextTagFadepoint(tt,3)
		call SetTextTagLifespan(tt,RMinIF(1.0,stun/2))
		call SetTextTagPermanent(tt,false)
		call SetTextTagVisibility(tt,IsUnitAlly(u,GetLocalPlayer()) or IsObserver(GetLocalPlayer()))
	endif
	set tt=null
endfunction

function AXE takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,14)
	local unit arrow=LoadUnitHandle(HY,h,45)
	local real endX=LoadReal(HY,h,47)
	local real endY=LoadReal(HY,h,48)
	local real angle=LoadReal(HY,h,13)
	local real arrowX=GetUnitX(arrow)
	local real arrowY=GetUnitY(arrow)
	local real nx=SafeX50(GetUnitX(arrow)+30*Cos(angle))
	local real ny=SafeY50(GetUnitY(arrow)+30*Sin(angle))
	local group g=GetAvailableGroup()
	local unit dummy
	local unit Target
	local integer stunlvl=0
	local integer stunid=0
	local integer stlvl=0
	local player p=GetOwningPlayer(caster)
	call SetUnitX(arrow,nx)
	call SetUnitY(arrow,ny)
	set TmpUnit376=caster
	call GroupEnumUnitsInRange(g,nx,ny,140,Condition(function AVE))
	set Target=FirstOfGroup(g)
	call KillGroup(g)
	if Target!=null then
		if IsUnitType(Target,UNIT_TYPE_HERO) then
			call SaveInteger(HeroStats,GetHandleId(p),'ARRH',LoadInteger(HeroStats,GetHandleId(p),'ARRH')+1)
			call Traffic_RegisterData("AA_Hits"+I2S(GetPlayerId(GetOwningPlayer(caster))),LoadInteger(HeroStats,GetHandleId(p),'ARRH'))
		endif
		set dummy=CreateUnit(GetOwningPlayer(Target),'e00E',arrowX,arrowY,0)//e00E -> Spellcaster
		set stunlvl=IMinIF(R2I(DistanceBetweenXY(LoadReal(HY,h,191),LoadReal(HY,h,192),arrowX,arrowY)/150),10)
		if stunlvl<=1 then//0.01
			set stunid='A40Y'
			set stlvl=1
		elseif stunlvl<4 then
			set stunid='A407'
			set stlvl=stunlvl-1
		elseif stunlvl<7 then
			set stunid='A408'
			set stlvl=stunlvl-3
		else
			set stunid='A409'
			set stlvl=stunlvl-6
		endif
		call StunTargetLoD(Target,Potm_GetStunDur(stunlvl))
		call DamageTarget(caster,Target,1,90*LoadInteger(HY,h,0)-40+stunlvl*14)
		call DisplayArrowStunTime(caster,Target,stunlvl)
		call KillUnit(arrow)
		call CleanTimer(t)
	elseif(nx-endX)*(nx-endX)+(ny-endY)*(ny-endY)<1600 then
		call KillUnit(arrow)
		call CleanTimer(t)
	endif
	set t=null
	set caster=null
	set arrow=null
	set g=null
	set dummy=null
	set Target=null
endfunction

function PotM_EluneArrow_Start takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local real SourceX=SafeX50(GetUnitX(caster))
	local real SourceY=SafeY50(GetUnitY(caster))
	local real endX=GetSpellTargetX()
	local real endY=GetSpellTargetY()
	local real angle=Atan2(endY-SourceY,endX-SourceX)
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local player p=GetOwningPlayer(caster)
	local unit arrow=CreateUnit(p,'h005',SourceX,SourceY,angle*bj_RADTODEG)//h005 -> Elune's Arrow
	call SaveInteger(HeroStats,GetHandleId(p),'ARRS',LoadInteger(HeroStats,GetHandleId(p),'ARRS')+1)
	call Traffic_RegisterData("AA_Total"+I2S(GetPlayerId(p)),LoadInteger(HeroStats,GetHandleId(p),'ARRS'))
	call SetUnitFacing(arrow,angle*bj_RADTODEG)
	set endX=SafeX50(SourceX+3000*Cos(angle))
	set endY=SafeY50(SourceY+3000*Sin(angle))
	call SaveReal(HY,h,191,SourceX*1.)
	call SaveReal(HY,h,192,SourceY*1.)
	call SaveReal(HY,h,47,endX*1.)
	call SaveReal(HY,h,48,endY*1.)
	call SaveReal(HY,h,13,angle*1.)
	call SaveUnitHandle(HY,h,14,caster)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(caster,'A0L8'))//A0L8 -> Elune's Arrow
	call SaveUnitHandle(HY,h,45,arrow)
	call TimerStart(t,.035,true,function AXE)
	set caster=null
	set t=null
	set arrow=null
endfunction

function ACE takes nothing returns boolean
	local unit A3E=GetFilterUnit()
	if IsUnitInGroup(A3E,TempGroup2)then
		set A3E=null
		return false
	endif
	if IsUnitEnemy(A3E,GetOwningPlayer(TmpUnit376))and GetUnitAbilityLevel(A3E,'A04R')!=1 and GetWidgetLife(A3E)>0 and IsUnitType(A3E,UNIT_TYPE_STRUCTURE)==false then//
		set A3E=null
		return true
	endif
	set A3E=null
	return false
endfunction

function A6E takes nothing returns nothing
	call DamageTarget(TmpUnit376,GetEnumUnit(),1,TmpReal378)
endfunction

function ALE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local unit u=(LoadUnitHandle(HY,h,221))
	local real a=(LoadReal(HY,h,13))
	local integer Y59=(LoadInteger(HY,h,194))
	local group HND=(LoadGroupHandle(HY,h,133))
	local real NHE=GetUnitX(u)
	local real NIE=GetUnitY(u)
	local real LastX=(LoadReal(HY,h,23))
	local real LastY=(LoadReal(HY,h,24))
	local real AO8=LastX+1000*.05*Cos(a)
	local real AP8=LastY+1000*.05*Sin(a)
	local group g=GetAvailableGroup()
	call SaveReal(HY,h,23,((AO8)*1.))
	call SaveReal(HY,h,24,((AP8)*1.))
	set TmpUnit376=u
	set TmpReal378=LoadInteger(HY,h,0)*75+25
	set TempGroup2=HND
	call GroupEnumUnitsInRange(g,NHE,NIE,225,Condition(function ACE))
	call ForGroup(g,function A6E)
	call GroupAddGroup(g,HND)
	call KillGroup(g)
	set Y59=Y59-1
	call SaveInteger(HY,h,194,(Y59))
	if IsUnitType(u,UNIT_TYPE_HERO)then
		call SaveBoolean(HeroStats,GetHandleId(u),99,true)
	endif
	call SetUnitX(u,SafeX50(AO8))
	call SetUnitY(u,SafeY50(AP8))
	call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",NHE,NIE))
	if Y59==0 then
		call SetTint(u,-1,-1,-1,255)
		call SaveBoolean(HY,(GetHandleId(u)),225,(false))
		call SetUnitInvulnerable(u,false)
		call SetUnitPathing(u,true)
		call KillGroup(HND)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set u=null
	set Caster=null
	set HND=null
	set g=null
	set t=null
	return false
endfunction

function Morphling_Waveform takes nothing returns nothing
	local unit XX8=GetTriggerUnit()
	local player p = GetOwningPlayer(XX8)
	local real SourceX=GetUnitX(XX8)
	local real SourceY=GetUnitY(XX8)
	local real TargetX=GetSpellTargetX()
	local real TargetY=GetSpellTargetY()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local group HND=GetAvailableGroup()
	local unit Caster=CreateUnit(p,'e00E',0,0,0)//e00E -> Spellcaster
	local integer PlayerId=GetPlayerId(p)
	call UnitAddAbility(Caster,'A2N4')//A2N4 -> Waveform Stun
	if GetSpellTargetUnit()!=null then
		set TargetX=GetUnitX(GetSpellTargetUnit())
		set TargetY=GetUnitY(GetSpellTargetUnit())
	endif
	call SetTint(XX8,-1,-1,-1,0)
	call SaveBoolean(HY,(GetHandleId(XX8)),225,(true))
	call SetUnitInvulnerable(XX8,true)
	call SetUnitPathing(XX8,false)
	call SetUnitPathing(Caster,false)
	call SaveUnitHandle(HY,h,221,(XX8))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveReal(HY,h,23,((SourceX)*1.))
	call SaveReal(HY,h,24,((SourceY)*1.))
	call SaveGroupHandle(HY,h,133,(HND))
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(XX8,GetSpellAbilityId()))
	call SaveInteger(HY,h,1,GetSpellAbilityId())
	call SaveReal(HY,h,13,((Atan2(TargetY-SourceY,TargetX-SourceX))*1.))
	call SaveInteger(HY,h,194,(IMaxIF(R2I(SquareRoot((TargetX-SourceX)*(TargetX-SourceX)+(TargetY-SourceY)*(TargetY-SourceY))/ 50),1)))
	call TriggerRegisterTimerEvent(t,.04,true)
	call TriggerAddCondition(t,Condition(function ALE))
	call ShowUnit(XX8,false)
	call ShowUnit(XX8,true)
	call SelectUnitAddForPlayer(XX8,GetOwningPlayer(XX8))
	set Caster = null
	set XX8 = null
	set HND = null
	set t=null
endfunction

function A0E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Count=(LoadInteger(HY,h,34))-1
	local texttag tt
	call SaveInteger(HY,h,34,(Count))
	if GetTriggerEvalCount(t)==1 then
		call RemoveSavedHandle(HY,h,'0ILU')
	endif
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set tt=CreateTextTag()
		call SetTextTagText(tt,I2S(Count),.03)
		call SetTextTagPosUnit(tt,Source,0)
		call SetTextTagColorBJ(tt,0,29,255,15)
		call SetTextTagVelocity(tt,0,.035)
		call SetTextTagFadepoint(tt,3)
		call SetTextTagLifespan(tt,.9)
		call SetTextTagPermanent(tt,false)
		call SetTextTagVisibility(tt,GetOwningPlayer(Source)==GetLocalPlayer())
		set tt=CreateTextTag()
		call SetTextTagText(tt,I2S(Count),.03)
		call SetTextTagPosUnit(tt,Target,0)
		call SetTextTagColorBJ(tt,0,29,255,15)
		call SetTextTagVelocity(tt,0,.035)
		call SetTextTagFadepoint(tt,3)
		call SetTextTagLifespan(tt,.9)
		call SetTextTagPermanent(tt,false)
		call SetTextTagVisibility(tt,GetOwningPlayer(Source)==GetLocalPlayer())
	endif
	set t=null
	set tt=null
	set Source=null
	set Target=null
	return false
endfunction

function A5E takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local unit Hero=(LoadUnitHandle(HY,(GetHandleId(t)),14))
	local unit A2E=(LoadUnitHandle(HY,(GetHandleId(Hero)),229))
	call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",GetUnitX(A2E),GetUnitY(A2E)))
	call RemoveUnit(A2E)
	call UnitRemoveAbility(Hero,('A0GC'))//A0GC -> Morph Replicate
	if(LoadInteger(HY,(GetHandleId(Hero)),704))==0 or(LoadInteger(HY,(GetHandleId(Hero)),704))==('A0G8')then//A0G8 -> Replicate
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),('A0G8'),true)//A0G8 -> Replicate
	endif
	call FlushChildHashtable(HY,(GetHandleId(t)))
	call CleanTrigger((t))
	set Hero=null
	set A2E=null
	set t=null
endfunction

function DelayedReplicateReplaceB takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit hero=LoadUnitHandle(HY,h,0)
	local unit copy=LoadUnitHandle(HY,h,1)
	local real x=GetUnitX(copy)
	local real y=GetUnitY(copy)
	if IsDead(hero)==false and IsDead(copy)==false then
		call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",x,y))
		call SetUnitPosition(copy,GetUnitX(hero),GetUnitY(hero))
		call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",GetUnitX(hero),GetUnitY(hero)))
		call SetUnitPosition(hero,x,y)
		call PanCameraToTimedForPlayer(GetOwningPlayer(hero),x,y,0)
	endif
	call PauseTimer(t)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set hero=null
	set copy=null
	set t=null
endfunction

function DelayedReplicateReplace takes unit hero, unit copy returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0,false,function DelayedReplicateReplaceB)
	call SaveUnitHandle(HY,h,0,hero)
	call SaveUnitHandle(HY,h,1,copy)
	set t=null
endfunction

function Morphling_ReplicateReplace takes nothing returns nothing
	call DelayedReplicateReplace(GetTriggerUnit(),LoadUnitHandle(HY,GetHandleId(GetTriggerUnit()),229))
endfunction

function B8E takes nothing returns boolean
	return GetUnitAbilityLevel(GetSummonedUnit(),('B030'))>0 and GetWidgetLife(GetSummonedUnit())>0//B030 -> Replicate
endfunction

function B9E takes nothing returns nothing
	local unit Hero
	local integer h
	local unit Target
	local unit A2E=GetSummonedUnit()
	local trigger t
	set Hero=GetSummoningUnit()
	if GetUnitAbilityLevel(Hero,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(Hero),0) then//Aloc -> Locust
		set Hero=LoadUnitHandle(HY,GetHandleId(Hero),0)
	endif
	set h=GetHandleId(Hero)
	set Target=LoadUnitHandle(HY,h,228)
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A0G8',false)//A0G8 -> Replicate
	if GetUnitAbilityLevel(Hero,'A0G8')>0 then//A0G8 -> Replicate
		call UnitAddAbility2(Hero,'A0GC')//A0GC -> Morph Replicate
	endif
	call SetUnitColor(A2E,GetPlayerColor(GetOwningPlayer(Target)))
	call SaveUnitHandle(HY,h,229,A2E)
	set t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,A2E,EVENT_UNIT_DEATH)
	call TriggerAddAction(t,function A5E)
	call SaveUnitHandle(HY,GetHandleId(t),14,Hero)
	set t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,A2E,EVENT_UNIT_DEATH)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function A0E))
	call SaveUnitHandle(HY,GetHandleId(t),2,Hero)
	call SaveUnitHandle(HY,GetHandleId(t),17,A2E)
	call SaveInteger(HY,GetHandleId(t),34,GetUnitAbilityLevel(Hero,'A0G8')*15+15-1)//A0G8 -> Replicate
	set Hero=null
	set Target=null
	set A2E=null
	set t=null
endfunction

function Morphling_Replicate takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	if GetUnitAbilityLevel(Hero,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(Hero),0) then//Aloc -> Locust
		set Hero=LoadUnitHandle(HY,GetHandleId(Hero),0)
	endif
	call SaveUnitHandle(HY,(GetHandleId(Hero)),228,(Target))
	if IsUnitIllusion(Target) then
		call SaveUnitHandle(HY,GetHandleId(Hero),'0ILU',LoadUnitHandle(HY,GetHandleId(Target),'0ILU')) //Replicate source info (illu)
	else
		call SaveUnitHandle(HY,GetHandleId(Hero),'0ILU',Target) //Replicate source info (real)
	endif
	set Hero=null
	set Target=null
endfunction

function MH9 takes nothing returns nothing
	local trigger t
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function B8E))
	call TriggerAddAction(t,function B9E)
	set t=null
endfunction

function BGE takes unit Hero,integer BHE,real rate returns nothing
	local integer agi=GetHeroAgi(Hero,false)
	local integer str=GetHeroStr(Hero,false)
	local real mp=GetUnitState(Hero,UNIT_STATE_MANA)
	if BHE==0 then
		if mp>=rate and agi-LoadInteger(HeroStats,GetHandleId(Hero),31)>2 and IsDead(Hero)==false and agi>MORPH_MIN_STATS then
			call SetUnitState(Hero,UNIT_STATE_MANA,mp-rate)
			call SetHeroAgi(Hero,agi-2,true)
			call SetHeroStr(Hero,str+2,true)
		endif
	elseif BHE==1 then
		if mp>=rate and str-LoadInteger(HeroStats,GetHandleId(Hero),30)-LoadInteger(HeroStats,GetHandleId(Hero),'ARML')>4 and IsDead(Hero)==false and str>MORPH_MIN_STATS then
			call SetUnitState(Hero,UNIT_STATE_MANA,mp-rate)
//			call echo(I2S(LoadInteger(HeroStats,GetHandleId(Hero),'ARML')))
			call SetHeroAgi(Hero,agi+2,true)
			call SetHeroStr(Hero,str-2,true)
		endif
	endif
endfunction

function BME takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer Level=GetUnitAbilityLevel(Hero,'A0KX')//A0KX -> Morph
	call BGE(Hero,1,30./ Level)
	set t=null
	set Hero=null
	return false
endfunction

function BNE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer Level=GetUnitAbilityLevel(Hero,'A0KX')//A0KX -> Morph
	call BGE(Hero,0,30./ Level)
	set t=null
	set Hero=null
	return false
endfunction

function BOE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=GetTriggerUnit()
	local trigger morphto=(LoadTriggerHandle(HY,h,226))
	local integer lvl=GetUnitAbilityLevel(u,'A0KX')//A0KX -> Morph
	local integer lastorder=(LoadInteger(HY,h,227))
	local real rate=1./lvl
	if rate==.25 then
		set rate=.2
	endif
	if GetIssuedOrderId()==852549 then
		if morphto!=null then
			call FlushChildHashtable(HY,(GetHandleId(morphto)))
			call CleanTrigger(morphto)
		endif
		set morphto=CreateTrigger()
		call TriggerRegisterTimerEvent(morphto,rate,true)
		call TriggerAddCondition(morphto,Condition(function BME))
		call SaveUnitHandle(HY,(GetHandleId(morphto)),14,(u))
		call SaveTriggerHandle(HY,h,226,(morphto))
		call SaveInteger(HY,h,227,(GetIssuedOrderId()))
		call UnitAddAbility(u,'A22L')//A22L -> Morph Agi FX
		call UnitRemoveAbility(u,'A22T')//A22T -> Morph Str FX
	elseif GetIssuedOrderId()==852546 then
		if morphto!=null then
			call FlushChildHashtable(HY,(GetHandleId(morphto)))
			call CleanTrigger(morphto)
		endif
		set morphto=CreateTrigger()
		call TriggerRegisterTimerEvent(morphto,rate,true)
		call TriggerAddCondition(morphto,Condition(function BNE))
		call SaveUnitHandle(HY,(GetHandleId(morphto)),14,(u))
		call SaveTriggerHandle(HY,h,226,(morphto))
		call SaveInteger(HY,h,227,(GetIssuedOrderId()))
		call UnitAddAbility(u,'A22T')//A22T -> Morph Str FX
		call UnitRemoveAbility(u,'A22L')//A22L -> Morph Agi FX
	elseif GetIssuedOrderId()==852550 then
		if morphto!=null then
			call FlushChildHashtable(HY,(GetHandleId(morphto)))
			call CleanTrigger(morphto)
		endif
		call SaveTriggerHandle(HY,h,226,(null))
		call SaveInteger(HY,h,227,(GetIssuedOrderId()))
		call UnitRemoveAbility(u,'A22L')//A22L -> Morph Agi FX
		call UnitRemoveAbility(u,'A22T')//A22T -> Morph Str FX
	elseif GetIssuedOrderId()==852547 then
		if morphto!=null then
			call FlushChildHashtable(HY,(GetHandleId(morphto)))
			call CleanTrigger(morphto)
		endif
		call SaveTriggerHandle(HY,h,226,(null))
		call SaveInteger(HY,h,227,(GetIssuedOrderId()))
		call UnitRemoveAbility(u,'A22L')//A22L -> Morph Agi FX
		call UnitRemoveAbility(u,'A22T')//A22T -> Morph Str FX
	elseif GetIssuedOrderId()==852548 then
//		if lastorder!=852549 then
//			call Func2190(u,1,30*rate)
//		endif
		//call InterruptUnit(u)
		if IssueImmediateOrderById(u,852549)==false then
			call IssueImmediateOrderById(u,852550)
		endif
	elseif GetIssuedOrderId()==852545 then
//		if lastorder!=852546 then
//			call Func2190(u,0,30*rate)
//		endif
		//call InterruptUnit(u)
		if IssueImmediateOrderById(u,852546)==false then
			call IssueImmediateOrderById(u,852547)
		endif
	endif
	set t=null
	set u=null
	set morphto=null
	return false
endfunction

function Morphling_Morph_Learn takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t
	local integer h
	local integer Level=GetUnitAbilityLevel(Hero,'A0KX')//A0KX -> Morph
	if Level==1 then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call UnitAddAbility2(Hero,'A0KW')//A0KW -> Morph
		call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_ORDER)
		call TriggerAddCondition(t,Condition(function BOE))
		call SaveTriggerHandle(HY,h,226,(null))
		set t=null
	else
		call SetUnitAbilityLevel(Hero,'A0KW',Level)//A0KW -> Morph
	endif
	set Hero=null
	set t=null
endfunction

function BTE takes nothing returns nothing
	local unit XX8=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),326))
	local real r
	local real g
	local real b
	local integer BUE
	local integer BVE
	local real BWE
	local real BXE
	if GetUnitTypeId(XX8)!='O00P' then//O00P -> Morphling
		call DisableTrigger(GetTriggeringTrigger())
	elseif IsDead(XX8)==false and(LoadBoolean(HY,(GetHandleId(XX8)),225))==false then
		set BUE=GetHeroAgi(XX8,true)
		set BVE=GetHeroStr(XX8,true)
		set BWE=RMaxBJ(75+2*(BUE-BVE),35)
		set r=BWE
		set g=BWE
		set b=BWE
		call SetUnitVertexColorBJ(XX8,r,g,b,GetRandomReal(.0,10.))
	endif
	set XX8=null
endfunction

function BYE takes nothing returns boolean
	return b_isPickTime==false and GetUnitTypeId(GetTriggerUnit())=='O00P' and IsUnitIllusion(GetTriggerUnit())==false//O00P -> Morphling
endfunction

function BZE takes nothing returns nothing
	local trigger t
	if((LoadBoolean(HY,(GetHandleId(GetTriggerUnit())),327))==false)then
		set t=CreateTrigger()
		call SaveUnitHandle(HY,(GetHandleId(t)),326,(GetTriggerUnit()))
		call SaveTriggerHandle(HY,(GetHandleId(GetTriggerUnit())),328,(t))
		call TriggerAddAction(t,function BTE)
		call TriggerRegisterTimerEvent(t,1.,true)
		call SaveBoolean(HY,(GetHandleId(GetTriggerUnit())),327,(true))
		set t=null
	endif
endfunction

function MD9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddCondition(t,Condition(function BYE))
	call TriggerAddAction(t,function BZE)
	set t=null
endfunction

function AdaptiveStrike_Stun takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
			call StunTargetLoD(GetTriggerUnit(), LoadReal(HY,h,0))
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		endif
	else
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	endif
	set t=null
endfunction

function BBE takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(u,'A0G6')//A0G6 -> Adaptive Strike
	local integer mainstat
	local integer statvalue
	local real dmg
	local unit d
	local integer stunlvl
	local real angle
	local trigger t
	local integer h
	if GetUnitAbilityLevel(u,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(u),0) then//lotus//Aloc -> Locust
		set u=LoadUnitHandle(HY,GetHandleId(u),0)
	endif
	if GetUnitAbilityLevel(u,'A04R')>0 then//multicast//
		set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
	endif
	set mainstat=GetUnitPrimaryAttribute(u)
	if mainstat==1 then
		set statvalue=GetHeroInt(u,true)
	elseif mainstat==2 then
		set statvalue=GetHeroAgi(u,true)
	elseif mainstat==3 then
		set statvalue=GetHeroStr(u,true)
	endif
	set dmg=statvalue*(1+0.25*Level)+40+20*Level
	set d=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A33K')
	call SetUnitAbilityLevel(d,'A33K',Level)
	if IssueTargetOrder(d,"thunderbolt",Target) then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,3.5,false)
		call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(t,Condition(function AdaptiveStrike_Stun))
		call SaveUnitHandle(HY,h,0,d)
		call SaveReal(HY,h,0,0.8+0.2*Level)
		set t=null
	endif
	call TextTagOnUnit("|c001ce6b9+"+I2S(R2I(dmg))+"|r",1,Target,.023,255,255,255,216)
	call DamageTarget(u,Target,1,dmg)
	set u=null
	set d=null
	set Target=null
endfunction

function Morphling_AdaptiveStrike takes nothing returns nothing
	if GetUnitTypeId(GetSpellTargetUnit())!='n00L' and IsBlocked(GetSpellTargetUnit())==false then//n00L -> Roshan
		call BBE()
	endif
endfunction

function B5E takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),FQ8)==false then
		call GroupAddUnit(FR8,GetEnumUnit())
		call UnitRemoveAbility(GetEnumUnit(),'B02J')//B02J -> Song of the Siren
		call UnitRemoveAbility(GetEnumUnit(),'BUsp')
		call UnitRemoveAbility(GetEnumUnit(),'Bust')
	endif
endfunction

function B2E takes nothing returns nothing
	call UnitRemoveAbility(GetEnumUnit(),'B02J')//B02J -> Song of the Siren
	call UnitRemoveAbility(GetEnumUnit(),'BUsp')
	call UnitRemoveAbility(GetEnumUnit(),'Bust')
endfunction

function C4E takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),FP8)==false then
		call SetUnitOwner(FO8,GetOwningPlayer(GetEnumUnit()),false)
		if IssueTargetOrderById(FO8,852227,GetEnumUnit()) then	
			call GroupAddUnit(FP8,GetEnumUnit())
		endif
	endif
endfunction

function SongOfSirenHeal takes nothing returns nothing
	call SetWidgetLife(GetEnumUnit(),GetWidgetLife(GetEnumUnit())+0.08*GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)*0.05)
endfunction

function SongOfSirenFilter takes nothing returns boolean
	return IsUnitAlly(tt_unit1,GetOwningPlayer(GetFilterUnit())) and AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function C7E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local group g
	local group AlreadyHit=(LoadGroupHandle(HY,h,187))
	if GetTriggerEvalCount(t)==10 then
		call UnitAddAbility2(Source,'A24E')//A24E -> Song of the Siren
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A07U',false)//A07U -> Song of the Siren
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A38E',false)//A38E -> Song of the Siren
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A24E',true)//A24E -> Song of the Siren
	endif
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)>140 or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A24E')then//A24E -> Song of the Siren
		if(LoadInteger(HY,(GetHandleId(Source)),704))==0 or(LoadInteger(HY,(GetHandleId(Source)),704))=='A07U' or (LoadInteger(HY,(GetHandleId(Source)),704))=='A38E' then//A07U -> Song of the Siren, A38E -> Song of the Siren
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A07U',true)//A07U -> Song of the Siren
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A38E',true)//A38E -> Song of the Siren
		endif
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A24E',false)//A24E -> Song of the Siren
		call ForGroup(AlreadyHit,function B2E)
		call KillGroup(AlreadyHit)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set g=GetAvailableGroup()
		set tt_unit1=Source
		set FO8=Caster
		set FP8=AlreadyHit
		call GroupEnumUnitsInRange(g,x,y,1250+25,Condition(function LP8))
		call ForGroup(g,function C4E)
		set FQ8=g
		set FR8=GetAvailableGroup()
		call ForGroup(AlreadyHit,function B5E)
		call GroupRemoveGroup(FR8,AlreadyHit)
		set tt_unit1=Source
		if GetUnitAbilityLevel(Source,'A38E')>0 then//A38E -> Song of the Siren
			call GroupEnumUnitsInRange(g,x,y,1275,Condition(function SongOfSirenFilter))
			call ForGroup(g,function SongOfSirenHeal)
		endif
		call KillGroup(g)
		call KillGroup(FR8)
	endif
	set t=null
	set g=null
	set Source=null
	set AlreadyHit=null
	set Caster=null
	return false
endfunction

function Naga_SongOfSiren takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)//e00E -> Spellcaster
	call UnitAddAbility(Caster,'A07T')//A07T -> Song of the Siren 1
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function C7E))
	call SaveGroupHandle(HY,h,187,(GetAvailableGroup()))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\SongOfTheSiren_2.mdx",Source,"origin")))
	set t=null
	set Source=null
	set Caster=null
endfunction

function CDE takes unit Source, unit Target returns nothing
	local integer Level=GetUnitAbilityLevel(Source,'A2KU')//A2KU -> Rip Tide
	call UnitAddAbilityTimedExF(Target,'A240',Level,8,0)
	call DamageTarget(Source,Target,1,60+40*Level)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\CrushingWave\\CrushingWaveDamage.mdl",Target,"chest"))
endfunction

function QJ2 takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),RipTideAlreadyHit)==false then
		call GroupAddUnit(RipTideAlreadyHit,GetEnumUnit())
		call CDE(RipTideSource,GetEnumUnit())
	endif
endfunction

function CEE takes nothing returns nothing
	local unit Source=GetEnumUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local group g=GetAvailableGroup()
	call DestroyEffect(AddSpecialEffect("war3mapImported\\RipTide09.mdx",x,y))
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,350+25,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(g,function QJ2)
	call KillGroup(g)
	set g=null
	set Source=null
endfunction

function QL2 takes nothing returns boolean
	return IsUnitIllusion(GetFilterUnit())and IsDead(GetFilterUnit())==false
endfunction

function Naga_RipTide takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local group g=GetAvailableGroup()
	set RipTideAlreadyHit=GetAvailableGroup()
	set RipTideSource=Source
	call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(Source),Condition(function QL2))
	call GroupAddUnit(g,Source)
	call ForGroup(g,function CEE)
	call KillGroup(g)
	call KillGroup(RipTideAlreadyHit)
	set Source=null
	set g=null
endfunction

function Netherblast_Filter takes nothing returns boolean
	return IsUnitEnemy(Netherblast_Source,GetOwningPlayer(GetFilterUnit())) and IsDead(GetFilterUnit())==false and (GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0)//
endfunction

function Netherblast_Damage takes nothing returns nothing
	local unit u = GetEnumUnit()
	local real Damage = 25 + 75*Netherblast_Level
	if IsUnitType(u,UNIT_TYPE_STRUCTURE) then
		call DamageTarget(Netherblast_Source,u,1,Damage*.5)
	else
		call DamageTarget(Netherblast_Source,u,1,Damage)
	endif
	set u = null
endfunction

function Netherblast_Effect takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer h = GetHandleId(t)
	local unit Source = LoadUnitHandle(HY,h,2)
	local real x = LoadReal(HY,h,6)
	local real y = LoadReal(HY,h,7)
	local group g = GetAvailableGroup()
	set Netherblast_Source = Source
	set Netherblast_Level = LoadInteger(HY,h,0)
	call GroupEnumUnitsInRange(g,x,y,425,Condition(function Netherblast_Filter))
	call ForGroup(g,function Netherblast_Damage)
	call KillGroup(g)
	call PauseTimer(t)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set Source = null
	set t=null
endfunction

function Netherblast_Start takes nothing returns nothing
	local unit Source = GetTriggerUnit()
	local real x = GetSpellTargetX()
	local real y = GetSpellTargetY()
	local unit Caster 
	local timer t
	local integer h
	//if GetUnitTypeId(Source)!='e00E' then//e00E -> Spellcaster
		set t=CreateTimer()
		set h=GetHandleId(t)
		set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)//e00E -> Spellcaster
		call UnitAddAbility(Caster,'AHbz') //dummy ability to provide the visual//AHbz -> Nether Blast
		call IssuePointOrder(Caster,"blizzard",x,y)
		call SaveUnitHandle(HY,h,2,Source)
		call SaveReal(HY,h,6,x)
		call SaveReal(HY,h,7,y)
		call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
		if GetUnitTypeId(Source)!='e00E' then//e00E -> Spellcaster
			call TimerStart(t,0.9,false,function Netherblast_Effect)
		else
			call TimerStart(t,0.,false,function Netherblast_Effect)
		endif
	//endif
	set Caster = null
	set Source = null
	set t = null
endfunction

function CHE takes unit Source,unit Target,integer Level returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
	call UnitAddAbility(Caster,'A0BA')//A0BA -> Ensnare
	call SetUnitAbilityLevel(Caster,'A0BA',Level)//A0BA -> Ensnare
	call IssueTargetOrderById(Caster,852106,Target)
	set Caster=null
endfunction

function CIE takes nothing returns boolean
	if IsUnitIllusion(GetFilterUnit()) and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())then
		call CHE(GetFilterUnit(),FT8,GetUnitAbilityLevel(GetTriggerUnit(),'A24D'))//A24D -> Ensnare
	endif
	return false
endfunction

function CJE takes nothing returns boolean
	if IsUnitIllusion(GetFilterUnit()) and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())then
		call SetUnitFacing(GetFilterUnit(),tt_real1)
		call SetUnitAnimation(GetFilterUnit(),"spell")
	endif
	return false
endfunction

function Naga_Ensnare_OnCast takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local group g=GetAvailableGroup()
	set tt_real1=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetUnitX(FT8),GetUnitY(FT8))
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),700,Condition(function CJE))
	call KillGroup(g)
	set Hero=null
	set g=null
endfunction

function CME takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=FT8
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),700,Condition(function CIE))
	call KillGroup(g)
	set Hero=null
	set Target=null
	set g=null
endfunction

function Naga_Ensnare takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		set FT8=GetSpellTargetUnit()
		call CHE(GetTriggerUnit(),FT8,GetUnitAbilityLevel(GetTriggerUnit(),'A24D'))//A24D -> Ensnare
		call CME()
	endif
endfunction

function UnrefinedFireblast takes nothing returns nothing
	call SetUnitState(GetTriggerUnit(),UNIT_STATE_MANA,GetUnitState(GetTriggerUnit(),UNIT_STATE_MANA)*0.4)
endfunction

function AghaFireblast_OnDmg takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==LoadUnitHandle(HY,h,1) then
			call StunTargetLoD(GetTriggerUnit(), 1.5)
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		endif
	else
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	endif
	set t=null
endfunction

function AghaFireblast_Cast takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	local trigger t
	local integer h
	call UnitAddAbility2(Caster,'A2KR')//A2KR -> Fireblast agha
	if IssueTargetOrder(Caster,"thunderbolt",Target) then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,3,false)
		call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
		call SaveUnitHandle(HY,h,1,Caster)
		call TriggerAddCondition(t,Condition(function AghaFireblast_OnDmg))
		set t=null
	endif
	set Source=null
	set Target=null
	set Caster=null
endfunction

function AghaFireblast_Add takes nothing returns nothing
	local unit Source=tt_unit1
	call UnitAddAbility2(Source,'A2KQ')//A2KQ -> Fireblast
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2KQ',true)//A2KQ -> Fireblast
	set Source=null
endfunction

function AghaFireblast_Remove takes nothing returns nothing
	local unit Source=tt_unit1
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2KQ',false)//A2KQ -> Fireblast
	set Source=null
endfunction

function Ogre_FireblastHit takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
			call StunTargetLoD(GetTriggerUnit(), 1.5)
			call DamageTarget(LoadUnitHandle(HY,h,1),GetTriggerUnit(),1,15+65*LoadReal(HY,h,0))
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		endif
	else
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	endif
	set t=null
endfunction

function Ogre_Fireblast takes nothing returns nothing
	local trigger t
	local integer h
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A42E')
	if IssueTargetOrder(d,"thunderbolt",target) then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,5,false)
		call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(t,Condition(function Ogre_FireblastHit))
		call SaveUnitHandle(HY,h,0,d)
		call SaveUnitHandle(HY,h,1,caster)
		call SaveReal(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId())*1.0)
		set t=null
	endif
	set d=null
	set caster=null
	set target=null
endfunction

function Ogre_Fireblast_Wrap takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Ogre_Fireblast()
	endif
endfunction

function MC_Check takes unit u, integer key, real chanceBO, real chanceBOoff returns boolean
	return (Mode_BO and PRD_Get(u,key,chanceBO)) or (Mode_BO==false and PRD_Get(u,key,chanceBOoff))
endfunction

function IsAdvMulticastSpell takes nothing returns boolean
	local integer id=LoadInteger(TempHash,'MULT',0)
	return id=='A1HS'// or id=='A1T8'
endfunction

function CheckWhatIsMulticast takes nothing returns nothing
	local player p=GetTriggerPlayer()
	local integer pid=GetPlayerId(p)
	local integer i=1
	local integer aid
	loop
		set aid=SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+i]]
		if aid>0 and IsPassiveAbility[PlayerSkillNumber[pid*PlayerSkillOffset+i]]==false then
			call SaveInteger(TempHash,'MULT',0,aid)
			if (COE(pid,aid) and MulticastSpellRestriction(aid)) or IsAdvMulticastSpell() then
				call DisplayTimedTextToPlayer(p,0,0,15,"	|c00ff0303"+GetObjectName(aid)+"|r "+Id2String(aid)+" can be multicasted")
			endif
		endif
		set i=i+1
		exitwhen i > 4+NumberOfExtraAbilities
	endloop
endfunction

function MulticastGetChance takes unit u, integer Level returns integer
	local integer pid=GetPlayerId(GetOwningPlayer(u))
	
	call SaveInteger(HeroStats,pid,'MC_T',LoadInteger(HeroStats,pid,'MC_T')+1)
	if Level==1 then
		if MC_Check(u,'A088',25,18) then//A088 -> Multi Cast
			call SaveInteger(HeroStats,pid,'MC_2',LoadInteger(HeroStats,pid,'MC_2')+1)
			return 2
		endif
	elseif Level==2 then
		if MC_Check(u,'A088'+1,20,13) then//A088 -> Multi Cast
			call SaveInteger(HeroStats,pid,'MC_3',LoadInteger(HeroStats,pid,'MC_3')+1)
			return 3
		elseif MC_Check(u,'A088',40,29.5) then//A088 -> Multi Cast
			call SaveInteger(HeroStats,pid,'MC_2',LoadInteger(HeroStats,pid,'MC_2')+1)
			return 2
		endif
	elseif Level==3 then
		if MC_Check(u,'A088'+2,12.5,5.5) then//A088 -> Multi Cast
			call SaveInteger(HeroStats,pid,'MC_4',LoadInteger(HeroStats,pid,'MC_4')+1)
			return 4
		elseif MC_Check(u,'A088'+1,25,14.5) then//A088 -> Multi Cast
			call SaveInteger(HeroStats,pid,'MC_3',LoadInteger(HeroStats,pid,'MC_3')+1)
			return 3
		elseif MC_Check(u,'A088',50,39.5) then//A088 -> Multi Cast
			call SaveInteger(HeroStats,pid,'MC_2',LoadInteger(HeroStats,pid,'MC_2')+1)
			return 2
		endif
	endif
	if IsL1ch then
		return 4
	endif
	return 0
endfunction

function CPE takes unit u returns integer
	local real r
	local integer Level=GetUnitAbilityLevel(u,'A088')//A088 -> Multi Cast, QP24 -> Multi Cast
	local boolean agh=false
	local integer multiplier=0
	local integer id=GetPlayerId(GetOwningPlayer(u))
	local integer chance
	local integer ph=GetHandleId(GetOwningPlayer(u))
	if not(COE(id,GetSpellAbilityId()))then
		return 0
	endif
	return MulticastGetChance(u,Level)
endfunction

function GetMulticastChance takes nothing returns nothing
	set tt_int1=0
	if GetUnitAbilityLevel(tt_unit1,'A088')==0 or IsAdvMulticastSpell()==false then
		return
	endif
	set tt_int1=MulticastGetChance(tt_unit1,GetUnitAbilityLevel(tt_unit1,'A088'))
	if tt_int1>0 then
		if tt_int1==2 then
			call TextTagOnUnit(GetObjectName('n0K7'),5,tt_unit1,.03,255,0,0,255)//n0K7 -> 2x MULTICAST!
		elseif tt_int1==3 then
			call TextTagOnUnit(GetObjectName('n0JT'),5,tt_unit1,.03,255,0,0,255)//n0JT -> 3x MULTICAST!
		elseif tt_int1==4 then
			call TextTagOnUnit(GetObjectName('n0K8'),5,tt_unit1,.03,255,0,0,255)//n0K8 -> 4x MULTICAST!!
		endif
	endif
endfunction

function MulticastChannelingsStopper takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	call IssueImmediateOrder(u,"stop")
	call DisableTrigger(t)
	call CleanTrigger(t)
	call FlushChildHashtable(HY,h)	
	set u=null
	set t=null
	return false
endfunction

function Ignite_PossibleTarget takes nothing returns boolean
	return(IsUnitEnemy(TEMPUNIT,GetOwningPlayer(GetFilterUnit()))and AliveNonBuildOrMarker(GetFilterUnit()) and IsMagicImmune(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'B03J')==0 and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(TEMPUNIT)))!=null//B03J -> Ignite
endfunction

function DemonicConversionMulticastFilter takes nothing returns boolean
	return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and AliveNonBuildOrMarker(GetFilterUnit()) and IsMagicImmune(GetFilterUnit())==false and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and IsHeroUnitId(GetUnitTypeId(GetFilterUnit()))==false)!=null
endfunction

function WatchCasterStopB takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit d=LoadUnitHandle(HY,h,0)
	local unit u=LoadUnitHandle(HY,h,1)
	if IsUnitChannelsSomething(u)==false then
		call KillUnit(d)
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	endif
	set t=null
	set d=null
	set u=null
endfunction

function WatchCasterStop takes unit d, unit u returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.1,true,function WatchCasterStopB)
	call SaveUnitHandle(HY,GetHandleId(t),0,d)
	call SaveUnitHandle(HY,GetHandleId(t),1,u)
	set t=null
endfunction

function CRE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer Cache=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,(Cache),2))
	local player p = GetOwningPlayer(Source)
	local integer CSE=(LoadInteger(HY,(Cache),300))
	local integer Level=(LoadInteger(HY,(Cache),5))
	local integer CTE=(LoadInteger(HY,(Cache),299))
	local integer order=(LoadInteger(HY,(Cache),'0ORD'))
	local integer ordertype=(LoadInteger(HY,(Cache),'ORDT'))
	local unit Caster
	local unit CWE
	local real ux
	local real uy
	local real tx
	local real ty
	local real d
	local real a
	local boolean b
	local boolean disabled
	local trigger tt
	local integer h
	local real delay
	local group g
	
	if GetTriggerEvalCount(t)>CSE then
		call FlushChildHashtable(HY,(Cache))
		call CleanTrigger(t)
	else
		set Caster = CreateUnit(p,'e00E',GetWidgetX(Source),GetWidgetY(Source),0)//e00E -> Spellcaster
		call SaveBoolean(HY,GetHandleId(Caster),'REFL',true)
		call SaveUnitHandle(HY,GetHandleId(Caster),'REFL',Source)
		call SetUnitX(Caster,GetWidgetX(Source))
		call SetUnitY(Caster,GetWidgetY(Source))
		call SaveUnitHandle(MHT,GetHandleId(Caster),0,LoadUnitHandle(HY,Cache,2))
		call TriggerRegisterUnitEvent(GAME_TRIGGER,Caster,EVENT_UNIT_SPELL_EFFECT)
		call RemoveSavedHandle(MHT,GetHandleId(Caster),0)
		if HaveSavedInteger(MHT,CTE,0)then
			set CTE = LoadInteger(MHT,CTE,0)
		endif
		call UnitAddAbility2(Caster,CTE)
		//call echo(Id2String(CTE))
		call SetUnitAbilityLevel(Caster,CTE,Level)
		set disabled = LoadBoolean(MHT,GetHandleId(p),CTE)
		if disabled then
			call SetPlayerAbilityAvailable(p,CTE,true)
		endif

		if ordertype==1 then
			set CWE=LoadUnitHandle(HY,(Cache),17)
			if CTE!='A011' and CTE!='A180' then//A011 -> Ignite
				set ux=GetUnitX(CWE)
				set uy=GetUnitY(CWE)
				set tx=GetUnitX(Source)
				set ty=GetUnitY(Source)
				set d=LoadReal(HY,(Cache),'000D')
				set a=Atan2(ty-uy,tx-ux)
				call UnitShareVision(CWE,p,true)
				loop
					exitwhen IssueTargetOrderById(Caster,order,CWE) or d<0
					call SetUnitX(Caster,ux+(d*Cos(a)))
					call SetUnitY(Caster,uy+(d*Sin(a)))
					set d=d-10
				endloop
				if CTE=='A2QT' then//A2QT -> Fortune's End
					set delay=RMinIF(TimerGetElapsed(GlobalTimer)-LoadReal(HY,GetHandleId(Source),358)-(0.3*GetTriggerEvalCount(t)),3)
					set tt=CreateTrigger()
					call TriggerRegisterTimerEvent(tt,delay,false)
					call TriggerAddCondition(tt,Condition(function MulticastChannelingsStopper))
					call SaveUnitHandle(HY,GetHandleId(tt),0,Caster)
					set tt=null
				endif
				call UnitShareVision(CWE,p,false)
			elseif CTE=='A011' then// if Ignite
				set g=GetAvailableGroup()
				set TEMPUNIT=Source
				call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1400,Condition(function Ignite_PossibleTarget))
				call GroupRemoveUnit(g,CWE)
				if FirstOfGroup(g)!=null then
					set CWE=GroupPickRandomUnit(g)
				endif
				call IssueTargetOrderById(Caster,order,CWE)
				call KillGroup(g)
				set g=null
			elseif CTE=='A180' then// if Eidolons
				set g=GetAvailableGroup()
				set tt_unit1=Source
				call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),900,Condition(function DemonicConversionMulticastFilter))
				call GroupRemoveUnit(g,CWE)
				loop
					set CWE=FirstOfGroup(g)
					if CWE!=null then
						call SetUnitX(Caster,GetUnitX(CWE))
						call SetUnitY(Caster,GetUnitY(CWE))
					endif
					exitwhen CWE==null or (LoadInteger(UnitStats,GetUnitTypeId(CWE),EXP)<=88 and IssueTargetOrderById(Caster,order,CWE))
					call GroupRemoveUnit(g,CWE)
				endloop
				call KillGroup(g)
				set g=null
			endif
		elseif ordertype==2 then
			set CWE=LoadUnitHandle(HY,(Cache),17)
			set ux=LoadReal(HY,(Cache),'0LOX')
			set uy=LoadReal(HY,(Cache),'0LOY')
			set tx=GetUnitX(Source)
			set ty=GetUnitY(Source)
			set d=LoadReal(HY,(Cache),'000D')
			set a=Atan2(ty-uy,tx-ux)
			if CTE=='A0JC'then
				call SaveUnitHandle(TempHash,'A3E9',0,Caster)
				call SaveInteger(TempHash,'A3E9',0,Level)
				call SaveReal(TempHash,'A3E9',0,ux)
				call SaveReal(TempHash,'A3E9',1,uy)
				call ExecuteFunc("Zeus_LightningBoltMulticast")
				
			else
				loop
					set b=IssuePointOrderById(Caster,order,ux,uy)
					//call echo(GetUnitName(Caster)+" order "+OrderId2String(order))
					exitwhen b or d<0
					call SetUnitX(Caster,ux+(d*Cos(a)))
					call SetUnitY(Caster,uy+(d*Sin(a)))
					set d = d-10
				endloop
			endif
			if CTE=='A12K' then//A12K -> Powershot
				set delay=RMinIF((TimerGetElapsed(GlobalTimer))-(LoadReal(HY,(GetHandleId(Source)),358))-(0.3*GetTriggerEvalCount(t)),1.05)
				set tt=CreateTrigger()
				call TriggerRegisterTimerEvent(tt,delay,false)
				call TriggerAddCondition(tt,Condition(function MulticastChannelingsStopper))
				call SaveUnitHandle(HY,GetHandleId(tt),0,Caster)
				set tt=null
			endif
		elseif ordertype==3 then
			call TriggerRegisterUnitEvent(GAME_TRIGGER,Caster,EVENT_UNIT_SPELL_FINISH)
			call IssueImmediateOrderById(Caster,order)
			if CTE=='A03R' or CTE=='A0AV'then
				call WatchCasterStop(Caster,Source)
			endif
		endif
		if disabled then
			call SetPlayerAbilityAvailable(p,CTE,false)
		endif
	endif
	set t=null
	set Source=null
	set Caster=null
	set CWE=null
	set p=null
	return false
endfunction

function CXE takes integer r returns nothing
	local unit Source=GetTriggerUnit()
	local integer CTE=GetSpellAbilityId()
	local integer Level=GetUnitAbilityLevel(Source,CTE)
	local trigger t=CreateTrigger()
	local integer Cache=GetHandleId(t)
	local integer CVE=LoadInteger(HY,GetHandleId(Source),'ORDT')
	local integer i
	local timer tt
	local integer h
	if r==2 then
		call TextTagOnUnit(GetObjectName('n0K7'),5,GetTriggerUnit(),.03,255,0,0,255)//n0K7 -> 2x MULTICAST!
	elseif r==3 then
		call TextTagOnUnit(GetObjectName('n0JT'),5,GetTriggerUnit(),.03,255,0,0,255)//n0JT -> 3x MULTICAST!
	elseif r==4 then
		call TextTagOnUnit(GetObjectName('n0K8'),5,GetTriggerUnit(),.03,255,0,0,255)//n0K8 -> 4x MULTICAST!!
	elseif r==5 then
		call TextTagOnUnit(GetObjectName('n0JO'),5,GetTriggerUnit(),.03,255,0,0,255)//n0JO -> 5x MULTICAST!!!
	endif
	set r=r-1
	call SaveUnitHandle(HY,(Cache),2,(Source))
	call SaveInteger(HY,(Cache),300,(r))
	call SaveInteger(HY,(Cache),5,(Level))
	call SaveInteger(HY,(Cache),299,(CTE))
	if CVE==1 then
		call SaveInteger(HY,(Cache),'0ORD',LoadInteger(HY,GetHandleId(Source),'0ORD'))
		call SaveReal(HY,(Cache),'000D',LoadReal(HY,GetHandleId(Source),'000D'))
		call SaveUnitHandle(HY,(Cache),17,(GetSpellTargetUnit()))
	elseif CVE==2 then
		call SaveInteger(HY,(Cache),'0ORD',LoadInteger(HY,GetHandleId(Source),'0ORD'))
		call SaveReal(HY,(Cache),'000D',LoadReal(HY,GetHandleId(Source),'000D'))
		call SaveReal(HY,(Cache),'0LOX',GetSpellTargetX())
		call SaveReal(HY,(Cache),'0LOY',GetSpellTargetY())
	elseif CVE==3 then
		call SaveInteger(HY,(Cache),'0ORD',LoadInteger(HY,GetHandleId(Source),'0ORD'))
		//call SaveReal(HY,(Cache),'0FAC',GetUnitFacing(Source))
	endif
	//if CTE!='A0MT' then//A0MT -> Nether Blast
		call SaveInteger(HY,(Cache),'ORDT',CVE)
		call TriggerRegisterTimerEvent(t,0.3,true)
		call TriggerAddCondition(t,Condition(function CRE))
	//endif
	set t=null
	set Source=null
endfunction

function CYE takes nothing returns boolean//multicast
	local integer r
	local unit u
	local real ux
	local real uy
	local real tx
	local real ty
	if (GetUnitAbilityLevel(GetTriggerUnit(),'A088'))>0 then//A088 -> Multi Cast, QP24 -> Multi Cast
		set u=GetTriggerUnit()
		if GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER then
			call SaveInteger(HY,GetHandleId(u),'0ORD',GetIssuedOrderId())
			call SaveInteger(HY,GetHandleId(u),'ORDT',1)
			return false
		elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER then
			call SaveInteger(HY,GetHandleId(u),'0ORD',GetIssuedOrderId())
			call SaveInteger(HY,GetHandleId(u),'ORDT',2)
			return false
		elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_ORDER then
			call SaveInteger(HY,GetHandleId(u),'0ORD',GetIssuedOrderId())
			call SaveInteger(HY,GetHandleId(u),'ORDT',3)
			return false
		endif
		if MulticastSpellRestriction(GetSpellAbilityId()) and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0then//
			if GetSpellTargetUnit()!=null and LoadInteger(HY,GetHandleId(u),'ORDT')==1 then
				if IsBlocked(GetSpellTargetUnit())==false and IsPlayerEnemy(GetOwningPlayer(GetSpellTargetUnit()),GetOwningPlayer(u)) then
					set r=CPE(u)
					if r>1 then
						set ux=GetUnitX(u)
						set uy=GetUnitY(u)
						set tx=GetUnitX(GetSpellTargetUnit())
						set ty=GetUnitY(GetSpellTargetUnit())
						call SaveReal(HY,GetHandleId(u),'000D',SquareRoot(((tx-ux)*(tx-ux))+((ty-uy)*(ty-uy))))
						call CXE(r)
					endif
				endif
			elseif GetSpellTargetLoc()!=null and LoadInteger(HY,GetHandleId(u),'ORDT')==2 then
				set r=CPE(u)
				if r>1 then
					set ux=GetUnitX(u)
					set uy=GetUnitY(u)
					set tx=GetSpellTargetX()
					set ty=GetSpellTargetY()
					call SaveReal(HY,GetHandleId(u),'000D',SquareRoot(((tx-ux)*(tx-ux))+((ty-uy)*(ty-uy))))
					call CXE(r)
				endif
			elseif LoadInteger(HY,GetHandleId(u),'ORDT')==3 then
				set r=CPE(u)
				if r>1 then
					call CXE(r)
				endif
			endif
		endif
	endif
	if GetSpellAbilityId()=='A2KQ' and IsBlocked(GetSpellTargetUnit())==false then//A2KQ -> Fireblast
		call AghaFireblast_Cast()
	endif
	set u=null
	return false
endfunction

function MM9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function CYE))
	set t=null
endfunction

function InitMulticastRestrictions takes nothing returns nothing
	call SaveBoolean(UTable,MCRESTRICTED,'A33U',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A456',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A44X',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1MG',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A19O',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1MV',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0DL',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0WP',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A43D',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0MQ',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1B6',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1TA',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1T8',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A28Q',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1TB',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A3FQ',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QB0K',true)
	call SaveBoolean(UTable,MCRESTRICTED,'ANcr',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0Z4',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0Z5',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1NI',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QM00',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1YY',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1RK',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A43H',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1S7',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1YQ',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A3DE',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A2JR',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A2JL',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A2JO',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A2JQ',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A2JP',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A2E5',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A43S',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A43Q',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QB08',true)
	call SaveBoolean(UTable,MCRESTRICTED,'AEbl',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A04P',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0NT',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0NX',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1AU',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A05G',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0M1',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1AX',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0A5',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1EG',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0AG',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0KX',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0G8',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0KW',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A063',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A07U',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A38E',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QB0B',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0D7',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0LN',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0KU',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0BE',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1EJ',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A229',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QB03',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1EA',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0RV',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QB0P',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1N4',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0LC',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A443',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0IN',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1AW',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QB09',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A07A',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QB0L',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A2H0',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A2HS',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A01B',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QM01',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A01O',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0SB',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A28T',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A361',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A14O',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A3FJ',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A085',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A14I',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A12P',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1D6',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1SW',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A06B',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A471',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A065',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A00P',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A27F',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A27H',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A30J',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0I6',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0RW',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A03O',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A10R',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1OP',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QP1W',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A194',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0SW',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0NS',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1DA',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QM02',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0R0',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A06K',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0FL',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1CX',true)
	call SaveBoolean(UTable,MCRESTRICTED,'DRKN',true)
	call SaveBoolean(UTable,MCRESTRICTED,'DRKU',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A05C',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QM03',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1RD',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1P8',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0H0',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A030',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QB0A',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A025',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A04Q',true)
	call SaveBoolean(UTable,MCRESTRICTED,'Z234',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0WQ',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0PL',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A09U',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A2KO',true)
	call SaveBoolean(UTable,MCRESTRICTED,'QB01',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0CA',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0CT',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A3DM',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1RI',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A07Q',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0H9',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1IN',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0LK',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1C0',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A418',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0MP',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A04Y',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A04N',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A02N',true)
//	call SaveBoolean(UTable,MCRESTRICTED,'A180',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0CC',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A02Z',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0OJ',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A0ME',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1S8',true)
	call SaveBoolean(UTable,MCRESTRICTED,'Z605',true)
	call SaveBoolean(UTable,MCRESTRICTED,'A1HS',true)
endfunction

function CAE takes nothing returns boolean
	local unit f=GetFilterUnit()
	local unit u=GetTriggerUnit()
	if IsUnitAlly(f,GetOwningPlayer(u))and IsDead(f)==false and (IsUnitType(f,UNIT_TYPE_HERO) or ((GetOwningPlayer(f)==Sentinels[0]or GetOwningPlayer(f)==Scourges[0])) or(GetOwningPlayer(f)==GetOwningPlayer(u) and IsWardUnit(f)==false)) then//Bblo -> Bloodlust
		set f=null
		set u=null
		return true
	endif
	set f=null
	set u=null
	return false
endfunction

function MulicastGetBestTargetAlly takes group gg returns unit
	local unit u
	local group g=GetAvailableGroup()
	set tt_unit1=null
	set tt_unit2=null
	call GroupAddGroup(gg,g)
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if IsUnitType(u,UNIT_TYPE_HERO)then
			if tt_unit1==null then
				set tt_unit1=u
			else
				if GetRandomInt(0,1)==1then
					set tt_unit1=u
				endif
			endif
		else
			if tt_unit2==null then
				set tt_unit2=u
			else
				if GetRandomInt(0,1)==1then
					set tt_unit2=u
				endif
			endif
		endif
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
	set u=null
	if tt_unit1!=null then
		return tt_unit1
	endif
	return tt_unit2
endfunction

function CBE takes integer r returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=r
	local group g = GetAvailableGroup()
	local group gg=GetAvailableGroup()
	local unit dummy
	local unit target
	local integer id=GetSpellAbilityId()
	local integer k=1
	local boolean b = false
	if r==2 then
		call TextTagOnUnit(GetObjectName('n0K7'),5,u,.03,255,0,0,255)//n0K7 -> 2x MULTICAST!
	elseif r==3 then
		call TextTagOnUnit(GetObjectName('n0JT'),5,u,.03,255,0,0,255)//n0JT -> 3x MULTICAST!
	elseif r==4 then
		call TextTagOnUnit(GetObjectName('n0K8'),5,u,.03,255,0,0,255)//n0K8 -> 4x MULTICAST!!
	elseif r==5 then
		call TextTagOnUnit(GetObjectName('n0JO'),5,u,.03,255,0,0,255)//n0JO -> 5x MULTICAST!!!
	endif
	set r=r-1
	set tt_unit1=u
	call GroupEnumUnitsInRange(gg,GetUnitX(u),GetUnitY(u),600,Condition(function CAE))
	if u!=GetSpellTargetUnit()then
		call GroupAddUnit(gg,u)
	endif
	if HaveSavedInteger(MHT,id,0)then
		set id = LoadInteger(MHT,id,0)
	endif
	call GroupAddGroup(gg,g)
	loop
		exitwhen b
		loop
			exitwhen k>lvl or b
			if id=='A08N' or id=='A2QM' then//A08N -> Purification, A2QM -> Boulder Smash
				set target=GetSpellTargetUnit()
			else
				//set target=GroupPickRandomUnit(gg)
				set target=MulicastGetBestTargetAlly(gg)
			endif
			if id=='AEfn' then//AEfn -> Force of Nature
				set id='A333'//A333 -> Force of Nature
			endif
			set b = target==null
			if b==false then
				set dummy=CreateUnit(GetOwningPlayer(u),'e00C',GetUnitX(u),GetUnitY(u),270)//e00C -> Self dummy
				call TriggerRegisterUnitEvent(GAME_TRIGGER,dummy,EVENT_UNIT_SPELL_EFFECT)
				call UnitAddAbility2(dummy,id)
				call SetUnitAbilityLevel(dummy,id,GetUnitAbilityLevel(u,id))
				call UnitApplyTimedLife(dummy,'BTLF',1.)
				call IssueTargetOrderById(dummy,LoadInteger(HY,GetHandleId(u),'0ORD'),target)
				call SetUnitPathing(dummy,false)
				call UnitAddAbility2(dummy,'Aloc')//Aloc -> Locust
				call GroupRemoveUnit(gg,target)
				set k=k+1
			endif
		endloop
		if b and lvl > k then
			set b = false
			call GroupAddGroup(g,gg)
		endif
	endloop

	call KillGroup(gg)
	call KillGroup(g)

	set dummy = null
	set gg = null
	set target = null
	set u = null
	set g = null
endfunction

function CCE takes nothing returns boolean
	local integer r
	if (GetUnitAbilityLevel(GetTriggerUnit(),'A088'))>0 then//A088 -> Multi Cast, QP24 -> Multi Cast
		if GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER then
			call SaveInteger(HY,GetHandleId(GetTriggerUnit()),'0ORD'+1,GetIssuedOrderId())
		elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER then
			call SaveInteger(HY,GetHandleId(GetTriggerUnit()),'0ORD'+1,0)
		elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_ORDER then
			call SaveInteger(HY,GetHandleId(GetTriggerUnit()),'0ORD'+1,0)
		endif
		if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT and(LoadInteger(HY,GetHandleId(GetTriggerUnit()),'0ORD'+1)!=0)then
			if MulticastSpellRestriction(GetSpellAbilityId())and(GetSpellTargetUnit()!=null)and(GetSpellAbilityId()!=null) and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0then//
				if IsPlayerAlly(GetOwningPlayer(GetSpellTargetUnit()),GetOwningPlayer(GetTriggerUnit()))then
					set r=CPE(GetTriggerUnit())
					//set r = 4
					if r>1 then
						call CBE(r)
					endif
				endif
			endif
		endif
	endif
	return false
endfunction

function MN9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function CCE))
	set t=null
endfunction

function Ogre_Bloodlust_Learn takes nothing returns nothing
	call UnitAddAbility2(GetTriggerUnit(),'A083')//A083 -> Bloodlust
	call SetUnitAbilityLevel(GetTriggerUnit(),'A083',GetUnitAbilityLevel(GetTriggerUnit(),'A40B'))//A083 -> Bloodlust, A40B -> Bloodlust
endfunction

function C6E takes nothing returns boolean
	return(AliveNonBuildOrMarker(GetFilterUnit()) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)))!=null//
endfunction

function CLE takes nothing returns nothing
	call DamageTarget(GetTriggerUnit(),GetEnumUnit(),3,TmpReal378)
endfunction

function Omni_Purification takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u=GetSpellTargetUnit()
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local unit u2
	
	set TmpReal378=90*GetUnitAbilityLevel(GetTriggerUnit(),('A08N'))//A08N -> Purification
	if GetWidgetLife(u)>1 and IsUnitHPFreezed(u)==false then
		call SetWidgetLife(u,GetWidgetLife(u)+TmpReal378)
	endif
	set u=GetTriggerUnit()
	set tt_unit1=u
	call GroupEnumUnitsInRange(g,x,y,260+25,Condition(function C6E))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call DamageTarget(u,u2,3,TmpReal378)
		call GroupRemoveUnit(g,u2)
	endloop
	//call ForGroup(g,function CLE)
	call KillGroup(g)
	set u=null
endfunction

function Omni_Repel takes nothing returns nothing
	call PurgingTriggeredSpellImmune(GetSpellTargetUnit())
	call PurgingTriggered(GetSpellTargetUnit(),false)
endfunction

function Omni_GAPastFilter takes nothing returns boolean
	return IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and GetUnitAbilityLevel(GetFilterUnit(),'B00G')>0 and DistanceBetweenUnits(GetFilterUnit(),tt_unit1)>2000//B00G -> Guardian Angel
endfunction

function Omni_GAPast takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit caster=LoadUnitHandle(HY,GetHandleId(t),0)
	local group g
	local unit u
	set g=GetAvailableGroup()
	set tt_unit1=caster
	call GroupEnumUnitsInRange(g,0,0,12000,Condition(function Omni_GAPastFilter))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call UnitRemoveAbility(u,'B00G')//B00G -> Guardian Angel
		call GroupRemoveUnit(g,u)
	endloop
	
	call KillGroup(g)
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTimer(t)
	set u=null
	set caster=null
endfunction

function Omni_GuardianAngelUpg takes nothing returns nothing
//	local unit u=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)//e00E -> Spellcaster
//	if IsRearmPicked(GetTriggerUnit()) then
//		call UnitAddAbility(u,'A45T')
//		call SetUnitAbilityLevel(u,'A45T',GetUnitAbilityLevel(GetTriggerUnit(),'A2S8'))//A2S8 -> Guardian Angel
//	else
//		call UnitAddAbility(u,'A45S')
//		call SetUnitAbilityLevel(u,'A45S',GetUnitAbilityLevel(GetTriggerUnit(),'A2S8'))//A2S8 -> Guardian Angel
//	endif
//	if IssueImmediateOrderById(u,852599) then
//		call echo("casted")
//	endif
//	set u=null
	local timer t
	if IsRearmPicked(GetTriggerUnit()) then
		set t=CreateTimer()
		call TimerStart(t,0,false,function Omni_GAPast)
		call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
		set t=null
	endif
	
endfunction

function C0E takes nothing returns boolean
	local unit W39=GetSummonedUnit()
	local unit Caster
	local unit Target
	if IsUnitIllusion(W39) then
		set Caster=GetSummoningUnit()
		set Target=(LoadUnitHandle(HY,(GetHandleId(Caster)),303))
		if Target==null or GetUnitX(Target)==.0 or GetUnitY(Target)==.0 then
			set W39=null
			set Caster=null
			set Target=null
			return false
		endif
		call SetUnitX(W39,GetUnitX(Target))
		call SetUnitY(W39,GetUnitY(Target))
		call IssueTargetOrderById(W39,ORDER_attack,Target)
	endif
	set W39=null
	set Caster=null
	set Target=null
	return false
endfunction

function C5E takes player p,unit Target,integer Level returns nothing
	local unit Caster=CreateUnit(p,'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	local integer AF8
	call SaveUnitHandle(HY,(GetHandleId(Caster)),303,(Target))
	if Level==1 then
		set AF8='A10H'//A10H -> Spirit Lance Image lvl 1
	elseif Level==2 then
		set AF8='A10G'//A10G -> Spirit Lance Image lvl 2
	elseif Level==3 then
		set AF8='A10I'//A10I -> Spirit Lance Image lvl 3
	else
		set AF8='A10F'//A10F -> Spirit Lance Image lvl 4
	endif
	call UnitAddAbility(Caster,AF8)
	call IssueTargetOrderById(Caster,852274,udg_Hero[GetPlayerId(p)])
	set Caster=null
endfunction

function C2E takes unit Source, player p,unit Target,integer Level,boolean L7E returns nothing
	local unit Caster
	if L7E then
		set Caster=CreateUnit(p,'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
		call UnitAddAbility(Caster,'A10C')//A10C -> Spirit Lance Slow
		call SetUnitAbilityLevel(Caster,'A10C',Level)//A10C -> Spirit Lance Slow
		call IssueTargetOrderById(Caster,852189,Target)
		call DamageTarget(Caster,Target,1,50+50*Level)
		call C5E(p,Target,Level)
		set Caster=null
		if GetUnitAbilityLevel(Target,'A3E9')==1 and IsMagicImmune(Source)==false and HaveSavedHandle(HY,GetHandleId(Source),0)==false then
			call SaveUnitHandle(TempHash,'A3E9',0,Target)
			call SaveUnitHandle(TempHash,'A3E9',1,Source)
			call SaveInteger(TempHash,'A3E9',0,Level)
			call ExecuteFunc("PL_SpiritLanceLotusOrb")
		endif
		
	endif
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\IllidanMissile\\IllidanMissile.mdl",Target,"origin"))
endfunction

function L8E takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local player p
	local unit Target
	local integer Level
	local boolean DV9
	local unit Projectile
	local real x
	local real y
	local real TargetX
	local real TargetY
	local real AM8
	local real AN8
	local real AO8
	local real AP8
	local boolean disjointed
	local real lastX
	local real lastY
	if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if IsDisjointSpell(GetSpellAbilityId()) then
			call SaveBoolean(HY,h,0,true)
			call SaveReal(HY,h,0,GetUnitX(GetTriggerUnit()))
			call SaveReal(HY,h,1,GetUnitY(GetTriggerUnit()))
		endif
	else
		set p=LoadPlayerHandle(HY,h,54)
		set Target=LoadUnitHandle(HY,h,30)
		set Level=LoadInteger(HY,h,5)
		set DV9=LoadBoolean(HY,h,302)
		set Projectile=LoadUnitHandle(HY,h,45)
		set x=GetUnitX(Projectile)
		set y=GetUnitY(Projectile)
		set TargetX=GetUnitX(Target)
		set TargetY=GetUnitY(Target)
		set AM8=1000*.035
		set disjointed=LoadBoolean(HY,h,0)
		if disjointed then
			set TargetX=LoadReal(HY,h,0)
			set TargetY=LoadReal(HY,h,1)
		endif
		set AN8=AngleBetweenXY(x,y,TargetX,TargetY)
		set AO8=x+AM8*Cos(AN8*bj_DEGTORAD)
		set AP8=y+AM8*Sin(AN8*bj_DEGTORAD)
		
		call SetUnitX(Projectile,AO8)
		call SetUnitY(Projectile,AP8)
		call SetUnitFacing(Projectile,AN8)
		if DistanceBetweenXY(TargetX,TargetY,AO8,AP8)<=AM8 then
			if disjointed==false then
				call C2E(LoadUnitHandle(HY,h,31),p,Target,Level,DV9)
			endif
			call KillUnit(Projectile)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set Target=null
	set Projectile=null
	return false
endfunction

function L9E takes unit Source,integer Level,unit Target,boolean DV9 returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h06L',GetUnitX(Source),GetUnitY(Source),AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target)))//h06L -> Spirit Lance
	call SavePlayerHandle(HY,h,54,GetOwningPlayer(Source))
	call SaveUnitHandle(HY,h,30,(Target))
	call SaveUnitHandle(HY,h,31,(Source))
	call SaveBoolean(HY,h,302,DV9)
	call SaveUnitHandle(HY,h,45,Projectile)
	call SaveInteger(HY,h,5,Level)
	call TriggerRegisterTimerEvent(t,.035,true)
	call SaveBoolean(HY,h,0,false)//has been disjointed
	call SaveReal(HY,h,0,0)//X
	call SaveReal(HY,h,1,0)//Y
	call TriggerAddCondition(t,Condition(function L8E))
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
	set t=null
	set Projectile=null
endfunction

function LDE takes nothing returns boolean
	if IsUnitIllusion(GetFilterUnit()) and isPlayerPickedAbility(GetOwningPlayer(GetFilterUnit()),83)and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())then
		call L9E(GetFilterUnit(),3,GetSpellTargetUnit(),false)
	endif
	return false
endfunction

function PL_SpiritLance takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(Hero,'A10D')//A10D -> Spirit Lance
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),700,Condition(function LDE))
	call KillGroup(g)
	call L9E(Hero,Level,Target,IsBlocked(GetSpellTargetUnit())==false)
	set Hero=null
	set Target=null
endfunction

function PL_SpiritLanceLotusOrb takes nothing returns nothing
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	call L9E(LoadUnitHandle(TempHash,'A3E9',0),LoadInteger(TempHash,'A3E9',0),LoadUnitHandle(TempHash,'A3E9',1),IsBlocked(LoadUnitHandle(TempHash,'A3E9',1))==false)
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function LGE takes nothing returns boolean
	if IsUnitIllusion(GetFilterUnit()) and isPlayerPickedAbility(GetOwningPlayer(GetFilterUnit()),83)and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())then
		call SetUnitFacing(GetFilterUnit(),tt_real1)
		call SetUnitAnimation(GetFilterUnit(),"spell")
	endif
	return false
endfunction

function PL_SpiritLance_OnCast takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local group g=GetAvailableGroup()
	set tt_real1=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()))
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),700,Condition(function LGE))
	call KillGroup(g)
	set Hero=null
	set g=null
endfunction

function MR9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call PreloadQueryAdd('A10C')//A10C -> Spirit Lance Slow
	call PreloadQueryAdd('A10H')//A10H -> Spirit Lance Image lvl 1
	call PreloadQueryAdd('A10G')//A10G -> Spirit Lance Image lvl 2
	call PreloadQueryAdd('A10I')//A10I -> Spirit Lance Image lvl 3
	call PreloadQueryAdd('A10F')//A10F -> Spirit Lance Image lvl 4
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function C0E))
	set t=null
endfunction

function LJE takes nothing returns boolean
	if (GetUnitAbilityLevel(GetFilterUnit(),'B03B')>0 or GetUnitAbilityLevel(GetFilterUnit(),'P084')>0) and IsDead(GetFilterUnit())==false then//B03B -> Juxtapose
		set tt_int1=tt_int1+1
	endif
	return false
endfunction

function PL_Illusions_OnAttack takes unit u returns nothing
	local group g=GetAvailableGroup()
	local integer chance=GetRandomInt(1,100)
	local integer lvl=GetUnitAbilityLevel(u,'P083')
	local unit d
	local integer limit=3+2*lvl
	local integer juxchance=35+5*lvl
	set tt_int1=0
	call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(u),Condition(function LJE))
	call KillGroup(g)
	if tt_int1<limit then
		if IsUnitIllusion(u)==false and chance<=juxchance then
			set d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
			call UnitAddAbility2(d,'A0DD')//A0DD -> JuxtaposeIllusions
			call IssueTargetOrderById(d,852274,u)
		endif
		if IsUnitIllusion(u) and chance<=8 then
			set d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
			call UnitAddAbility2(d,'A0DD')//A0DD -> JuxtaposeIllusions
			call SetUnitAbilityLevel(d,'A0DD',2)//A0DD -> JuxtaposeIllusions
			call IssueTargetOrderById(d,852274,u)
		endif
	endif
	set d=null
endfunction

function PL_Illusions_OnAttackWrap takes unit u, unit target returns nothing
	if (GetUnitAbilityLevel(u,'P083')>0 or GetUnitAbilityLevel(u,'B03B')>0 or GetUnitAbilityLevel(u,'B03A')>0) and GetUnitAbilityLevel(u,'A36D')==0 and IsUnitType(target,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(target,GetOwningPlayer(u)) then//B03B -> Juxtapose, B03A -> Doppelwalk Illusion
		call PL_Illusions_OnAttack(u)
	endif
endfunction

function PL_Doppelwalk takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A0DC')//A0DC -> DoppelWalk Illusion
	call IssueTargetOrderById(Caster,852274,u)
	set u=null
	set Caster=null
endfunction



function PLPhantomRushEnd takes unit u, integer hu, trigger t returns nothing
	local integer h=GetHandleId(t)
	if GetUnitAbilityLevel(u,'A46D')>0 and LoadBoolean(HY,h,5) then//A46D -> Phantom Rush Inactive
		call CustomSpeed(u,0,0)
		call SetUnitPathing(u,true)
	endif
//	call echo("end")
	call UnitRemoveAbility(u,'A46F')
	call UnitRemoveAbility(u,'B46F')//B46F -> Rush
	//call SaveReal(HY,GetHandleId(u),'A46E',TimerGetElapsed(GlobalTimer))//A46E -> Phantom Rush
	if GetHandleId(u)>0 then
		call RemoveSavedHandle(HY,GetHandleId(u),'A46E')//A46E -> Phantom Rush
	else
		call RemoveSavedHandle(HY,LoadInteger(HY,h,0),'A46E')//A46E -> Phantom Rush
	endif
	call CleanTrigger(t)
	call FlushChildHashtable(HY,h)
endfunction

function PLPhantomRushDur takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer hu=LoadInteger(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local real dist
	local real maxdist=LoadReal(HY,h,0)
	local boolean disabled=false
	local real x
	local real y
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		if GetTriggerUnit()==u then
			call PLPhantomRushEnd(u,hu,t)
		else
			if GetUnitCurrentOrder(u)!=ORDER_move then
				call DisableTrigger(t)
				call IssuePointOrderById(u,ORDER_move,LoadReal(HY,h,10),LoadReal(HY,h,11))
				call EnableTrigger(t)
			endif
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_ATTACKED then
		if GetAttacker()==u then
			call PLPhantomRushEnd(u,hu,t)
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER then
		if GetIssuedOrderId()!=ORDER_attack and not (GetIssuedOrderId()==851971 and GetOrderTargetUnit()!=null and IsUnitEnemy(GetOrderTargetUnit(),GetOwningPlayer(u))) then
			call PLPhantomRushEnd(u,hu,t)
		endif
	else
		if IsUnitDisabledAny(u) or ( LoadBoolean(HY,h,5) and GetUnitAbilityLevel(u,'A46F')==0) then
			call PLPhantomRushEnd(u,hu,t)
		else
			set dist=DistanceBetweenUnits(u,target)
			if LoadBoolean(HY,h,5) and (dist>maxdist+150 or IsUnitVisibleLoD(target,GetOwningPlayer(u))==false or IsUnitInvulnerable(target)) then//Avul -> Invulnerable
				if GetUnitCurrentOrder(u)!=ORDER_move then
					if LoadBoolean(HY,h,0) then
						call PLPhantomRushEnd(u,hu,t)
					else
						call DisableTrigger(t)
						call SaveBoolean(HY,h,0,true)
						call IssuePointOrderById(u,ORDER_move,LoadReal(HY,h,10),LoadReal(HY,h,11))
						call EnableTrigger(t)
					endif
				elseif DistanceBetweenXY(GetUnitX(u),GetUnitY(u),LoadReal(HY,h,10),LoadReal(HY,h,11))<=120 then
					call PLPhantomRushEnd(u,hu,t)
				endif
			elseif LoadBoolean(HY,h,5)==false then
				if LoadBoolean(HY,h,0)==false and GetUnitAbilityLevel(u,'A46F')==0 and dist <= maxdist and GetUnitAbilityLevel(u,'A46D')>0 then//A46D -> Phantom Rush Inactive
					call UnitAddAbility2(u,'A46F')
					call CustomSpeed(u,999,800)
//					call echo("start")
					if GetUnitAbilityLevel(u,'A46D')>0 then//A310 -> Phantom Rush Inactive
						call SaveReal(HY,GetHandleId(u),'A46E',TimerGetElapsed(GlobalTimer))//A46E -> Phantom Rush
					endif
					call SetUnitPathing(u,false)
					call SaveBoolean(HY,h,5,true)
				endif
			elseif DistanceBetweenXY(GetUnitX(u),GetUnitY(u),LoadReal(HY,h,10),LoadReal(HY,h,11))<=100 then
				call PLPhantomRushEnd(u,hu,t)
			else
				call SaveReal(HY,h,10,GetUnitX(target))
				call SaveReal(HY,h,11,GetUnitY(target))
				call SaveBoolean(HY,h,0,false)
			endif
		endif
	endif
	set t=null
	return false
endfunction

function PLPhantomRushInit takes nothing returns nothing
	local trigger t
	local integer h
	local unit u=GetTriggerUnit()
	local integer hu=GetHandleId(u)
	local integer lvl=GetUnitAbilityLevel(u,'A46D')//A46D -> Phantom Rush Inactive
	local unit target=GetOrderTargetUnit()
	local real dist=DistanceBetweenUnits(u,target)
	local real maxdist=500+100*lvl
	local unit prevtarget
	if dist>300 and LoadReal(HY,hu,'A46E')+20-4*lvl < TimerGetElapsed(GlobalTimer) then//A46E -> Phantom Rush
		if HaveSavedHandle(HY,hu,'A46E') then//A46E -> Phantom Rush
			set t=LoadTriggerHandle(HY,hu,'A46E')//A46E -> Phantom Rush
			set h=GetHandleId(t)
			set prevtarget=LoadUnitHandle(HY,h,1)
			if prevtarget!=target then
				call PLPhantomRushEnd(u,hu,t)
			endif
		else
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call SaveTriggerHandle(HY,hu,'A46E',t)//A46E -> Phantom Rush
			call SaveUnitHandle(HY,h,0,u)
			call SaveInteger(HY,h,0,hu)
			call SaveUnitHandle(HY,h,1,target)
			call TriggerRegisterTimerEvent(t,0.02,true)
			call TriggerRegisterTimerEvent(t,0,false)
			call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_ATTACKED)
			call TriggerRegisterDeathEvent(t,target)
			call TriggerRegisterDeathEvent(t,u)
			call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_ORDER)
			call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_POINT_ORDER)
			call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
			call TriggerAddCondition(t,Condition(function PLPhantomRushDur))
		endif
		call SaveReal(HY,h,0,maxdist)
		call SaveReal(HY,h,10,GetUnitX(target))
		call SaveReal(HY,h,11,GetUnitY(target))
	endif
	set u=null
	set target=null
	set t=null
endfunction

function PLPhantomRushCheck takes nothing returns boolean
	if GetOrderTargetUnit()!=null and IsUnitEnemy(GetOrderTargetUnit(),GetOwningPlayer(GetTriggerUnit())) and	(GetIssuedOrderId()==ORDER_attack or GetIssuedOrderId()==851971) then
		if GetUnitAbilityLevel(GetTriggerUnit(),'A46D')>0 and GetUnitAbilityLevel(GetTriggerUnit(),'A36D')==0 then//A46D -> Phantom Rush Inactive
			call PLPhantomRushInit()
		endif
	endif
	return false
endfunction

function PLPhantomRushNewUnit takes nothing returns boolean
	local unit u
	if IsUnitIllusion(GetTriggerUnit()) then
		set u=udg_Hero[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]
		if GetUnitAbilityLevel(u,'A46E')>0 and GetUnitTypeId(GetTriggerUnit())==GetUnitTypeId(u) then//A46E -> Phantom Rush
			call UnitAddAbility2(GetTriggerUnit(),'A46D')//A46D -> Phantom Rush Inactive
			call SetUnitAbilityLevel(GetTriggerUnit(),'A46D',GetUnitAbilityLevel(u,'A46E'))//A46D -> Phantom Rush Inactive, A46E -> Phantom Rush
		endif
	endif
	set u=null
	return false
endfunction

function PLPhantomRushLearn takes nothing returns boolean
	call UnitAddAbility2(GetTriggerUnit(),'A46D')//A46D -> Phantom Rush Inactive
	call SetUnitAbilityLevel(GetTriggerUnit(),'A46D',GetUnitAbilityLevel(GetTriggerUnit(),'A46E'))//A46D -> Phantom Rush Inactive, A46E -> Phantom Rush
	return false
endfunction



function IsPLIllusion takes nothing returns boolean
	return GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(tt_unit1) and IsUnitIllusion(GetFilterUnit()) and IsDead(GetFilterUnit())==false
endfunction

function PLDoppelgangerEnd takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u
	local unit u2
	local integer i=1
	local real face
	local real radius=325
	local real x=LoadReal(HY,h,10)
	local real y=LoadReal(HY,h,11)
	local real nx
	local real ny
	local real angle
	local real dist
	local integer c=LoadInteger(HY,h,0)+1
	local real speed
	local unit illus2
	local unit illus3
	local string s
	local group g
	if c==50 then
		call ClearSelectionForPlayer(GetOwningPlayer(LoadUnitHandle(HY,h,0)))
		set illus2=null
		set illus3=null
		set g=GetAvailableGroup()
		loop
			exitwhen HaveSavedHandle(HY,h,i)==false
			set u=LoadUnitHandle(HY,h,i)
			call ShowUnit(u,true)
			call PauseUnit(u,false)
			call IssueImmediateOrder(u,"stop")
			call UnitRemoveAbility(u,'Avul')//Avul -> Invulnerable
			set nx=LoadReal(HY,h,100*i)
			set ny=LoadReal(HY,h,100*i+1)
			call KillTrees(nx,ny,200)
			call SetUnitPosition(u,nx,ny)
			if IsUnitIllusion(u) then
				call UnitPauseTimedLife(u,false)
			endif
			if IsUnitIllusion(u)==false or GetUnitAbilityLevel(u,'B46G')>0 or GetUnitAbilityLevel(u,'B46H')>0 then//B46G -> Illusion, B46H -> Illusion
				call SetUnitFacing(u,LoadReal(HY,h,0))
				if IsUnitIllusion(u)==false then
					call SelectUnitAddForPlayer(u,GetOwningPlayer(u))
				elseif illus2==null then
					set illus2=u
				elseif illus3==null then
					set illus3=u
				endif
				if GetUnitAbilityLevel(u,'B46H')>0 then//B46H -> Illusion
					set s=""
					if IsUnitAlly(u,GetLocalPlayer()) or (IsObserver(GetLocalPlayer())) then
						set s="Abilities\\Spells\\Items\\AIda\\AIdaTarget.mdl"
					endif
					call Z48(s,u,"head",8)
				endif
				if GetUnitAbilityLevel(u,'B46G')>0 then//B46G -> Illusion
					set s=""
					if IsUnitAlly(u,GetLocalPlayer()) or (IsObserver(GetLocalPlayer())) then
						set s="war3mapImported\\PLPower.mdx"
					endif
					call Z48(s,u,"overhead",8)
				endif
			else
				call GroupAddUnit(g,u)
			endif
			call KillUnit(LoadUnitHandle(HY,h,300+i))
			
			//call DestroyEffect(LoadEffectHandle(HY,h,200+i))
			//call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Polymorph\\PolyMorphTarget.mdl",GetUnitX(u),GetUnitY(u)))
			set i=i+1
		endloop
		
		call SelectUnitAddForPlayer(illus2,GetOwningPlayer(u))
		call SelectUnitAddForPlayer(illus3,GetOwningPlayer(u))
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			call SelectUnitAddForPlayer(u,GetOwningPlayer(u))
			call GroupRemoveUnit(g,u)
		endloop
		call KillGroup(g)
		set illus2=null
		set illus3=null
		call RemoveUnit(LoadUnitHandle(HY,h,-100))
		call FlushChildHashtable(HY,h)
		call DestroyTimer(t)
	else
		if c==1 then
			loop
				exitwhen HaveSavedHandle(HY,h,i)==false
				set u=LoadUnitHandle(HY,h,300+i)
				call PauseUnit(u,true)
				set i=i+1
			endloop
		elseif c>=30 then
			loop
				exitwhen HaveSavedHandle(HY,h,i)==false
				set u=LoadUnitHandle(HY,h,300+i)
				
				set speed=LoadReal(HY,h,100*i+2)
				set angle=LoadReal(HY,h,100*i+3)
				
				set nx=SafeX50(GetUnitX(u)+speed*Cos(angle))
				set ny=SafeY50(GetUnitY(u)+speed*Sin(angle))
				call SetUnitAnimation(u,"walk")
				call SetUnitX(u,nx)
				call SetUnitY(u,ny)
				//call SetUnitPosition(u,nx,ny)
				set i=i+1
			endloop
			
		endif
		call SaveInteger(HY,h,0,c)
	endif
	set u=null
	set u2=null
	set t=null
endfunction

function PLDoppelganger takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local unit u=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local integer i=0
	local unit u2
	local real face=GetUnitFacing(u)
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
	local real angle
	local real dist
	local real nx
	local real ny
	call PurgingTriggered(u,false)
	call UnitAddAbility(d,'A46G')
	call IssueTargetOrderById(d,852274,u)
	call SetUnitAbilityLevel(d,'A46G',2)
	call IssueTargetOrderById(d,852274,u)
	set d=null
	set tt_unit1=u
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),925,Condition(function IsPLIllusion))
	call GroupAddUnit(g,u)
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		set i=i+1
		call SaveUnitHandle(HY,h,i,u2)
		call UnitAddAbility(u2,'Avul')//Avul -> Invulnerable
		call ShowUnit(u2,false)
		if IsUnitIllusion(u2) then
			call UnitPauseTimedLife(u2,true)
		endif
		set d=CreateUnit(GetOwningPlayer(u2),'h07W',GetUnitX(u2),GetUnitY(u2),GetUnitFacing(u2))//h07W -> Quelling Blade
		//call SaveEffectHandle(HY,h,200+i,AddSpecialEffectTarget("war3mapImported\\PLDoppelganger.mdx",d,"origin"))
		call SaveUnitHandle(HY,h,300+i,d)
		set angle=GetRandomReal(0,360)*bj_DEGTORAD
		set dist=GetRandomReal(10,325)
		set nx=SafeX50(x+dist*Cos(angle))
		set ny=SafeY50(y+dist*Sin(angle))
		call SaveReal(HY,h,100*i+0,nx)
		call SaveReal(HY,h,100*i+1,ny)
		call SaveReal(HY,h,100*i+2,DistanceBetweenXY(GetUnitX(d),GetUnitY(d),nx,ny)/0.4*0.02)
		call SaveReal(HY,h,100*i+3,AngleBetweenXY(GetUnitX(d),GetUnitY(d),nx,ny)*bj_DEGTORAD)
		call GroupRemoveUnit(g,u2)
	endloop
	set d=null
	call SaveUnitHandle(HY,h,-100,CreateUnit(GetOwningPlayer(u),'o01P',GetUnitX(u),GetUnitY(u),0))//o01P -> Vision Dummy (1800/800)
	call SaveReal(HY,h,0,face)
	call SaveUnitHandle(HY,h,0,u)
	call TimerStart(t,.02,true,function PLDoppelgangerEnd)
	call SaveReal(HY,h,10,x)
	call SaveReal(HY,h,11,y)
	call KillGroup(g)
	set t=null
	set u=null
endfunction

function PLPhantomRushReg takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
	call TriggerAddCondition(t,Condition(function PLPhantomRushCheck))
	set t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddCondition(t,Condition(function PLPhantomRushNewUnit))
	set t=null
endfunction

function LUE takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())==HeroID[21]and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())and IsUnitIllusion(GetFilterUnit())==false then
		set tt_unit1=GetFilterUnit()
	endif
	return false
endfunction

function LVE takes nothing returns nothing
	local unit W39=GetTriggerUnit()
	local unit Source
	local group g=GetAvailableGroup()
	local real x
	local real y
	set tt_unit1=null
	call GroupEnumUnitsInRange(g,GetUnitX(W39),GetUnitY(W39),1000,Condition(function LUE))
	call KillGroup(g)
	set Source=tt_unit1
	if Source!=null then
		set x=GetUnitX(Source)
		set y=GetUnitY(Source)
		call SetUnitPosition(W39,x,y)
	endif
	set x=GetUnitX(W39)+600*Cos(GetUnitFacing(W39)*bj_DEGTORAD)
	set y=GetUnitY(W39)+600*Sin(GetUnitFacing(W39)*bj_DEGTORAD)
	call IssuePointOrderById(W39,ORDER_move,x,y)
	set W39=null
	set Source=null
	set g=null
endfunction

function LWE takes nothing returns boolean
	if GetUnitAbilityLevel(GetTriggerUnit(),'B03A')>0 then//B03A -> Doppelwalk Illusion
		call LVE()
	endif
	return false
endfunction

function MP9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	local region r=CreateRegion()
	call RegionAddRect(r,bj_mapInitialPlayableArea)
	call TriggerRegisterEnterRegion(t,r,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function LWE))
	set t=null
	set r=null
endfunction

function OvergrowthEnemyFilter takes nothing returns boolean
	return IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)>0
endfunction

function Func2270 takes nothing returns nothing
	local unit loc_unit01=GetTriggerUnit()
	local unit loc_unit02=CreateUnit(GetOwningPlayer(loc_unit01),'e022',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),270)//e022 -> Spellcaster (vision)
	call UnitAddAbility2(loc_unit02,'A06T')//A06T -> Overgrowth 1
	call SetUnitAbilityLevel(loc_unit02,'A06T',GetUnitAbilityLevel(loc_unit01,'A07Z')+GetUnitAbilityLevel(loc_unit01,'A44S'))//A06T -> Overgrowth 1, A07Z -> Overgrowth, A44S -> Overgrowth Upgrade
	call UnitRemoveAbility(GetEnumUnit(),'B0ER')//B0ER -> Overgrowth
	call IssueTargetOrder(loc_unit02,"entanglingroots",GetEnumUnit())
endfunction

function OvergrowthAghanimTicks takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u
	local integer h=GetHandleId(t)
	local integer i=1
	local integer ticks=LoadInteger(HY,h,0)
	local integer targets=LoadInteger(HY,h,-1)
	local unit caster=LoadUnitHandle(HY,h,0)
	loop
		if HaveSavedHandle(HY,h,i)then
			set u=LoadUnitHandle(HY,h,i)
			if IsDead(u)==false and GetUnitAbilityLevel(u,'B0ER')>0 then//B0ER -> Overgrowth
				call DamageTarget(caster,u,1,175)
			else
				call RemoveSavedBoolean(HY,LoadInteger(HY,h,i),'B0ER')//B0ER -> Overgrowth
				call RemoveSavedHandle(HY,h,i)
			endif
		endif
		set i=i+1
		exitwhen i>targets
	endloop
	if ticks > 10 then
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	elseif ticks==0 then
		call TimerStart(t,1,true,function OvergrowthAghanimTicks)
	endif
	set t=null
endfunction

function OvergrowthAghanim takes unit caster, group g returns nothing
	local timer t=CreateTimer()
	local unit u
	local integer h=GetHandleId(t)
	local integer hu
	local integer i=1
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		set hu=GetHandleId(u)
		if GetUnitAbilityLevel(u,'B0ER')==0 and LoadBoolean(HY,hu,'B0ER')==false then//B0ER -> Overgrowth, B0ER -> Overgrowth
			call SaveUnitHandle(HY,h,i,u)
			call SaveInteger(HY,h,i,hu)
			call SaveBoolean(HY,hu,'B0ER',true)//B0ER -> Overgrowth
			set i=i+1
		endif
		call GroupRemoveUnit(g,u)
	endloop
	call TimerStart(t,0,false,function OvergrowthAghanimTicks)
	call SaveUnitHandle(HY,h,0,caster)
	call SaveInteger(HY,h,-1,i)
	set t=null
	set u=null
endfunction

function Tree_Overgrowth_Start takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local boolean agh=GetSpellAbilityId()!='A07Z'//A07Z -> Overgrowth
	local integer hu=GetHandleId(GetOwningPlayer(u))
	local group gg
	local group g3
	local integer i
	local integer k
	local destructable d
	local boolean RearmExists=IsRearmPicked(u)
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),700,Condition(function OvergrowthEnemyFilter))
	if agh then
		set gg=GetAvailableGroup()
		set g3=GetAvailableGroup()
		set i=0
		set k=LoadInteger(HY,hu,'EinF')
		loop
			set i=i+1
			exitwhen i>k
			set d=LoadDestructableHandle(HY,hu,'EinF'+i)
			if RearmExists==false or DistanceBetweenXY(GetUnitX(u),GetUnitY(u),GetDestructableX(d),GetDestructableY(d)) < 3000 then
				call GroupEnumUnitsInRange(gg,GetDestructableX(d),GetDestructableY(d),800,Condition(function OvergrowthEnemyFilter))
				call GroupAddGroup(gg,g)
				call GroupAddGroup(gg,g3)
			endif
		endloop
		call OvergrowthAghanim(u,g3)
		call KillGroup(g3)
		call KillGroup(gg)
	endif
	call ForGroup(g,function Func2270)
	call KillGroup(g)
endfunction

function EyeInTheForestDeath takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer hu=LoadInteger(HY,h,0)
	local integer count=LoadInteger(HY,hu,'EinF')
	local integer offset=LoadInteger(HY,h,1)
	local integer i=offset-1
	local unit dummy=LoadUnitHandle(HY,h,2)
	if GetTriggerEventId()!=EVENT_GAME_TIMER_EXPIRED then
		call DestroyUbersplat(LoadUbersplatHandle(HY,h,3))
		call DestroyTrigger(t)
		call FlushChildHashtable(HY,h)
		call KillUnit(dummy)
		loop
			set i=i+1
			exitwhen HaveSavedHandle(HY,hu,'EinF'+i+1)==false
			call SaveDestructableHandle(HY,hu,'EinF'+i,LoadDestructableHandle(HY,hu,'EinF'+i+1))
		endloop
		call SaveInteger(HY,hu,'EinF',count-1)
	else
		call SetUbersplatRenderAlways(LoadUbersplatHandle(HY,h,3),IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(dummy)) or IsObserver(GetLocalPlayer()) or (IsUnitVisibleLoD(dummy,GetLocalPlayer())))
	endif
	set t=null
	return false
endfunction

function EyeInTheForest takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer hu=GetHandleId(GetOwningPlayer(u))
	local destructable d=GetSpellTargetDestructable()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer c=LoadInteger(HY,hu,'EinF')
	local unit dummy=CreateUnit(GetOwningPlayer(u),'ewsp',GetDestructableX(d),GetDestructableY(d),0)//ewsp -> Wisp
	local ubersplat ub=CreateUbersplat(GetUnitX(dummy),GetUnitY(dummy),"EINF",255,255,255,40,false,false)
	local unit Caster=CreateUnit(GetOwningPlayer(dummy),'e00E',GetUnitX(dummy),GetUnitY(dummy),0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A44T')
	call IssueTargetOrderById(Caster,852069,dummy)
	set Caster=null
	call SetUnitPathing(dummy,false)
	call SetUnitX(dummy,GetDestructableX(d))
	call SetUnitY(dummy,GetDestructableY(d))
	call UnitRemoveType(dummy,UNIT_TYPE_PEON)
	call PauseUnit(dummy,true)
	call TriggerRegisterDeathEvent(t,d)
	call TriggerRegisterTimerEvent(t,0.5,true)
	call TriggerAddCondition(t,Condition(function EyeInTheForestDeath))
	call SaveDestructableHandle(HY,GetHandleId(GetOwningPlayer(u)),'EinF'+c+1,d)
	call SaveInteger(HY,hu,'EinF',c+1)
	call SaveInteger(HY,h,0,hu)
	call SaveInteger(HY,h,1,c+1)
	call SaveUnitHandle(HY,h,2,dummy)
	call SaveUbersplatHandle(HY,h,3,ub)
	set ub=null
	set dummy=null
	set t=null
	set d=null
	set u=null
endfunction

function EyesInTheForest_Remove takes nothing returns nothing
	call SetPlayerAbilityAvailable(GetOwningPlayer(tt_unit1),'A01V',false)//A01V -> Eyes in the Forest
endfunction

function EyesInTheForest_Add takes nothing returns nothing
	call UnitAddAbility2(tt_unit1,'A01V')//A01V -> Eyes in the Forest
	call SetPlayerAbilityAvailable(GetOwningPlayer(tt_unit1),'A01V',true)//A01V -> Eyes in the Forest
endfunction

function Find_Trees_Targets takes nothing returns boolean
	local destructable d = GetFilterDestructable()
	local real x
	local real y

	if(IsValidTree(d)or GetDestructableTypeId(d)=='B005')and GetWidgetLife(d)>0 then//B005 -> Haste
		set x = GetWidgetX(d) - group_temp_real[201]
		set y = GetWidgetY(d) - group_temp_real[202]

		if group_temp_real[200] > SquareRoot(x*x + y*y)then
			call SaveBoolean(MHT,99999,99995,true)
		endif
	endif
	set d=null
	return false
endfunction

function Find_Trees takes real x, real y, real range returns boolean
	local rect r = null

	set group_temp_real[200] = range
	set group_temp_real[201] = x
	set group_temp_real[202] = y
	set range = range + 150

	set r = Rect(x-range,y-range,x+range,y+range)

	call SaveBoolean(MHT,99999,99995,false)
	call EnumDestructablesInRect(r,Condition(function Find_Trees_Targets),null)

	call RemoveRect(r)
	set r = null

	return LoadBoolean(MHT,99999,99995)
endfunction

function Tree_Invis_Cancel takes unit u returns nothing
	if GetUnitAbilityLevel(u,'A23N')>0 then//B021 -> Nature's Guise
		call SaveBoolean(MHT,GetHandleId(u),StringHash("TreeInvisibility"),false)
		call UnitRemoveAbility(u,'B021') //removes buffs, so that the timer will detect the lack of invis and end the spell//B021 -> Nature's Guise
		call UnitRemoveAbility(u,'B0E9')//B0E9 -> Nature's Guise
		call UnitRemoveAbility(u,'A1GA')//A1GA -> Permanent Invisibility
		call UnitRemoveAbility(u,'A23N')//A23N -> Nature's Guise - MS
	endif
endfunction

function Tree_Invis_Duration takes nothing returns nothing
	local unit d = null
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local unit u = LoadUnitHandle(MHT,info,0)
	local boolean b1 = GetUnitAbilityLevel(u,'B021')==0//B021 -> Nature's Guise
	local boolean b2 = Find_Trees(GetWidgetX(u),GetWidgetY(u),375)
	if LoadBoolean(MHT,GetHandleId(u),StringHash("TreeInvisibility")) and LoadBoolean(MHT,info,0) and b1 and b2 and count>1 then
		set d = CreateUnit(GetOwningPlayer(u),'e00E',GetWidgetX(u),GetWidgetY(u),0)//e00E -> Spellcaster
		call UnitAddAbility(d,'A01Z')//A01Z -> Nature's Guise
		call SetUnitAbilityLevel(d,'A01Z',LoadInteger(MHT,info,2))//A01Z -> Nature's Guise
		call RemoveEndlessFadetime(u)
		call IssueTargetOrder(d,"invisibility",u)
		call SaveInteger(MHT,info,0,count - 1)
		set d = null
		set u = null
		set t = null
		return
	endif
	if count==0 or IsDead(u) or b1 or LoadBoolean(MHT,GetHandleId(u),StringHash("TreeInvisibility"))==false then
		call echo("del2")
		call SaveBoolean(MHT,info,0,false)
		call UnitRemoveAbility(u,'B0E9')//speed buff//B0E9 -> Nature's Guise
		call UnitRemoveAbility(u,'B021')//invis buff//B021 -> Nature's Guise
		call UnitRemoveAbility(u,'A1GA')//perma invis//A1GA -> Permanent Invisibility
		call UnitRemoveAbility(u,'A23N')//speed aura//A23N -> Nature's Guise - MS
		call Timer_End(t)
		set t = null
		set u = null
		return
	endif
	call SaveInteger(MHT,info,0,count - 1)
	if b2 then
		call SaveInteger(MHT,info,1,0)
	else
		set count = LoadInteger(MHT,info,1)
		if count==9 then
			call UnitRemoveAbility(u,'B0E9')//B0E9 -> Nature's Guise
			call UnitRemoveAbility(u,'B021')//B021 -> Nature's Guise
			call UnitRemoveAbility(u,'A23N')//A23N -> Nature's Guise - MS
			call UnitRemoveAbility(u,'A1GA')//A1GA -> Permanent Invisibility
			call Timer_End(t)
		else
			call SaveInteger(MHT,info,1,count + 1)
		endif
	endif
	set t = null
	set u = null
endfunction

function Tree_Invis_Self takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local unit u = LoadUnitHandle(MHT,info,0)
	if IsDead(u)==false and GetUnitAbilityLevel(u,'B021')>0 then//B021 -> Nature's Guise
		call RemoveEndlessFadetime(u)
		call UnitAddAbility2(u,'A1GA')//A1GA -> Permanent Invisibility
		call TimerStart(t,0.1,true,function Tree_Invis_Duration)
		call SaveInteger(MHT,info,0,LoadInteger(MHT,info,0) - 20)
		call SaveBoolean(MHT,info,0,true)
		call SaveBoolean(MHT,GetHandleId(u),StringHash("TreeInvisibility"),true)
		set t = null
		set u = null
		return
	endif
	call Timer_End(t)
	set t = null
	set u = null
endfunction

function Tree_Invis_Remove takes nothing returns nothing
	local timer t = GetExpiredTimer()
	call UnitRemoveAbility(LoadUnitHandle(MHT,GetHandleId(t),0),'B021')//B021 -> Nature's Guise
	call Timer_End(t)
	set t = null
endfunction

function Tree_Invis_Start takes nothing returns nothing
	local unit u = null
	local unit d = GetSpellTargetUnit()
	local timer t = CreateTimer()
	local integer info
	local integer level
	if Find_Trees(GetWidgetX(d),GetWidgetY(d),375)==false then //prevents the spell from starting if the target is not near any trees
		call TimerStart(t,0,false,function Tree_Invis_Remove)
		call SaveUnitHandle(MHT,GetHandleId(t),0,d)
		call UnitRemoveAbility(d,'B021')//B021 -> Nature's Guise
		set d = null
		return
	endif
	set u = GetTriggerUnit()
	set info = GetHandleId(t)
	set level = GetUnitAbilityLevel(u,'A01Z')//A01Z -> Nature's Guise
	call SaveUnitHandle(MHT,info,0,d)
	call SaveInteger(MHT,info,0,level*150)
	call SaveInteger(MHT,info,1,0)
	call SaveInteger(MHT,info,2,level)
	call SaveBoolean(MHT,info,0,false)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Invisibility\\InvisibilityTarget.mdl",d,"chest"))
	call UnitAddAbility2(d,'A23N')//A23N -> Nature's Guise - MS
	if u==d then
		call TimerStart(t,2,false,function Tree_Invis_Self)
		set d = null
		set u = null
		set t = null
		return
	endif
	call TimerStart(t,0.1,true,function Tree_Invis_Duration)
	set d = null
	set u = null
	set t = null
endfunction

function Tree_Armour_Closest takes unit u returns nothing
	local real x = GetWidgetX(u) - group_temp_real[0]
	local real y = GetWidgetY(u) - group_temp_real[1]
	local real d = SquareRoot(x*x + y*y)
	if group_temp_real[2] > d then
		set group_temp_real[2] = d
		set group_temp_unit[1] = u
	endif
endfunction

function Tree_Armour_Structures takes integer id returns boolean
	return id=='u00M' or id=='u00N' or id=='u00D' or id=='u00T' or id=='usep' or id=='utod' or id=='unpl' or id=='e00R' or id=='e011' or id=='e00S' or id=='e019' or id=='eaom' or id=='eaoe' or id=='etol'//u00M -> Spirit Tower - level 1, u00N -> Spirit Tower - level 3, u00D -> Spirit Tower - level 2, u00T -> Spirit Tower - level 4, usep -> Crypt, utod -> Temple of the Damned, unpl -> The Frozen Throne, e00R -> Ancient Protector - level 1, e011 -> Ancient Protector - level 2, e00S -> Ancient Protector - level 3, e019 -> Ancient Protector - level 4, eaom -> Ancient of War, eaoe -> Ancient of Lore, etol -> The World Tree
endfunction

function Tree_Armour_Find_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	if IsUnitAlly(group_temp_unit[0],GetOwningPlayer(t)) and (IsUnitType(t,UNIT_TYPE_HERO) or (IsUnitType(t,UNIT_TYPE_STRUCTURE)and Tree_Armour_Structures(GetUnitTypeId(t)))) and IsDead(t)==false then
		call Tree_Armour_Closest(t)
	endif
	set t = null
	return false
endfunction

function Tree_Armour_Find takes unit u returns unit
	set group_temp_unit[0] = u
	set group_temp_unit[1] = null
	set group_temp_real[0] = GetSpellTargetX()
	set group_temp_real[1] = GetSpellTargetY()
	set group_temp_real[2] = 99999
	call GroupEnumUnitsInRange(temp_group,0,0,99999,Condition(function Tree_Armour_Find_Targets))
	return group_temp_unit[1]
endfunction

function Treant_LivingArmorHeal takes nothing returns real
	local trigger t=LoadTriggerHandle(HY,GetHandleId(GetTriggerUnit()),'A2ML')
	local integer h=GetHandleId(t)
	local real dmg=LoadReal(HY,h,0)
	local integer charges=LoadInteger(HY,h,0)
	local real d=GetEventDamage()
	local real block=0.
	if d>5 and charges>0 then
		call SaveInteger(HY,h,0,charges-1)
		set block=RMinIF(d,dmg)
		call echo(R2S(block))
	endif
	set t=null
	return block
endfunction

function Treant_LivingArmorDur takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer c=LoadInteger(HY,h,1)+1
	if GetUnitAbilityLevel(u,'A3KF')==0 or LoadInteger(HY,h,0)==0 or c >= 15*5 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call RemoveSavedHandle(HY,GetHandleId(u),'A2ML')
		call UnitRemoveAbility(u,'A3KF')
		call UnitRemoveAbility(u,'B3KF')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SaveInteger(HY,h,1,c)
		call SetWidgetLife(u,GetWidgetLife(u)+LoadReal(HY,h,1))
	endif
	set t=null
	set u=null
endfunction

function Treant_LivingArmor takes nothing returns nothing
	local trigger t
	local unit u = GetTriggerUnit()
	local unit u2 = GetSpellTargetUnit()
	local integer lvl = GetUnitAbilityLevel(u,'A2ML')//A2ML -> Living Armor
	local integer h
	if u2==null then
		set u2 = Tree_Armour_Find(u)
	endif
	if HaveSavedHandle(HY,GetHandleId(u2),'A2ML') then
		set t=LoadTriggerHandle(HY,GetHandleId(u2),'A2ML')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,GetHandleId(u2),'A2ML',t)
		call TriggerRegisterDeathEvent(t,u2)
		call TriggerRegisterTimerEvent(t,0.2,true)
		call TriggerAddCondition(t,Condition(function Treant_LivingArmorDur))
		call SaveUnitHandle(HY,h,0,u2)
	endif
	call UnitAddAbility2(u2,'A3KF')
	call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+3+lvl)
	call SaveInteger(HY,h,1,0)
	call SaveReal(HY,h,0,20.*lvl)
	call SaveReal(HY,h,1,(0.1+0.3*lvl))
	set t=null
	set u=null
	set u2=null
endfunction

function DIF takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit Source=tt_unit1
	local unit Target=tt_unit2
	local real DJF=LoadReal(HY,h,21)
	call SetWidgetLife(Target,GetWidgetLife(Target)+DJF)
	set Source=null
	set Target=null
endfunction

function DKF takes nothing returns nothing
	local trigger t=AddProjectile(F68,GetEnumUnit(),'h0D8',"DIF",400,false)//h0D8 -> Leech Seed Projectile
	call SaveReal(HY,GetHandleId(t),21,FL8*1.)
	set t=null
endfunction

function DMF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Level=(LoadInteger(HY,h,5))
	local group g
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveAbility(Target,'A272')//A272 -> Leech Seed - MS
		call UnitRemoveAbility(Target,'B0EL')//B0EL -> Leech Seed
	else
		if GetTriggerEvalCount(t)>6 then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call UnitRemoveAbility(Target,'A272')//A272 -> Leech Seed - MS
			call UnitRemoveAbility(Target,'B0EL')//B0EL -> Leech Seed
		endif
		call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\NightElf\\EntBirthTarget\\EntBirthTarget.mdl",Target,"origin"))
		set tt_unit1=Source
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),525,Condition(function L08))
		set F68=Target
		set FL8=12+12*Level
		call ForGroup(g,function DKF)
		call KillGroup(g)
		call DamageTarget(Source,Target,1,FL8)
	endif
	set t=null
	set Source=null
	set Target=null
	set g=null
	return false
endfunction

function DNF takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call UnitAddAbility2(Target,'A272')//A272 -> Leech Seed - MS
	call TriggerRegisterTimerEvent(t,0.75,true)
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function DMF))
	call SaveUnitHandle(HY,h,17,Target)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,442,TimerGetElapsed(GlobalTimer)*1.)
	call SaveInteger(HY,h,5,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	set t=null
	set Source=null
	set Target=null
endfunction

function Treant_LeechSeed takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call DNF()
	endif
endfunction

function MyLastWord_End takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local unit dummy=LoadUnitHandle(HY,h,2)
	local unit disabler
	local eventid tid=GetTriggerEventId()
	local integer lvl=LoadInteger(HY,h,3)
	local integer temp
	if tid==EVENT_UNIT_SPELL_EFFECT then
		set temp=GetSpellAbilityId()
		if isAintItemAbility(temp) and isDummyAbility(temp)==false and IsPoisonArrowSkill(temp)==false and isItemSpellOrNoCd(temp)==false then
			call DamageTarget(caster,target,1,lvl*50+100)
			call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\LastWordDamageSpell.mdx",target,"overhead"))
			set disabler=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
			call UnitAddAbility(disabler,'A0LS')//A0LS -> Last Word Effect
			call SetUnitAbilityLevel(disabler,'A0LS',lvl)//A0LS -> Last Word Effect
			call IssueTargetOrder(disabler,"drunkenhaze",target)
			call DestroyEffect(LoadEffectHandle(HY,h,4))
			call RemoveUnit(dummy)
			call CleanTrigger(t)
			call FlushChildHashtable(HY,h)
		endif
	elseif tid==EVENT_WIDGET_DEATH then
		call DestroyEffect(LoadEffectHandle(HY,h,4))
		call RemoveUnit(dummy)
		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)
	elseif LoadReal(HY,h,5)+5<=TimerGetElapsed(GlobalTimer) then
		call DamageTarget(caster,target,1,lvl*50+100)
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\LastWordDamageSpell.mdx",target,"overhead"))
		set disabler=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
		call UnitAddAbility(disabler,'Z051')
		call SetUnitAbilityLevel(disabler,'Z051',lvl)
		call IssueTargetOrder(disabler,"drunkenhaze",target)
		call DestroyEffect(LoadEffectHandle(HY,h,4))
		call RemoveUnit(dummy)
		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)
	else
		call SetUnitX(dummy,GetUnitX(target))
		call SetUnitY(dummy,GetUnitY(target))
	endif
	set t=null
	set dummy=null
	set target=null
	set caster=null
	set disabler=null
	set tid=null
endfunction

function Silencer_LastWord takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
	local unit dummy=CreateUnit(GetOwningPlayer(caster),'o019',GetUnitX(target),GetUnitY(target),0)//o019 -> Vision Ground 1800/800
	local real time=TimerGetElapsed(GlobalTimer)
	call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterTimerEvent(t,0.1,true)//50 triggers
	call TriggerRegisterDeathEvent(t,target)
	call TriggerAddCondition(t,Condition(function MyLastWord_End))
	call SaveUnitHandle(HY,h,0,caster)
	call SaveUnitHandle(HY,h,1,target)
	call SaveUnitHandle(HY,h,2,dummy)
	call SaveInteger(HY,h,3,lvl)
	
	call SaveEffectHandle(HY,h,4,AddSpecialEffectTarget("war3mapImported\\LastWordDebuff_6.mdx",target,"overhead"))
	call SaveReal(HY,h,5,time)
	set t=null
	set caster=null
	set target=null
	set dummy=null
endfunction

function Silencer_Glaive_Hit takes unit attacker, unit target returns nothing
	local real d=(.15+.1*I2R(GetUnitAbilityLevel(attacker,'A0LZ')))*GetHeroMainStatValue(attacker)//A0LZ -> Glaives of Wisdom
	call UnitRemoveAbility(target,'B05X')//B05X -> Glaives of Wisdom
	call TextTagOnUnit("+"+I2S(R2I(d)),1,target,.023,3,216,216,216)
	call DamageTarget(attacker,target,3,d)
endfunction

function DUF takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit Source=tt_unit2
	local real Damage=(LoadReal(HY,h,20))
	call SetHeroInt(Source,GetHeroInt(Source,false)+2,true)
	call TextTagOnUnit("+2 "+GetObjectName('n0JP'),3,Source,.023,0,255,0,230)//n0JP -> Int
	set Source=null
endfunction

function Silencer_IntSteal_Distrib takes nothing returns nothing
	local unit Source=GetEnumUnit()
	local unit victim=GetTriggerUnit()
	set StolenInt[GetPlayerId(GetOwningPlayer(Source))]=StolenInt[GetPlayerId(GetOwningPlayer(Source))]+2
	call TextTagOnUnit("-2 "+GetObjectName('n0JP'),3,victim,.023,255,0,0,230)//n0JP -> Int
	call SetHeroInt(victim,GetHeroInt(victim,false)-2,true)
	call AddProjectile(victim,Source,'h0CP',"DUF",2400,false)//h0CP -> Int Steal Projectile
	set Source=null
	set victim=null
endfunction

function Silencer_IntSteal_Filter takes nothing returns boolean
	return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and GetUnitAbilityLevel(GetFilterUnit(),'A0LZ')>0 and IsDead(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1))//A0LZ -> Glaives of Wisdom
endfunction

function Silencer_IntSteal takes unit killer, unit victim returns nothing
	local group g
	if IsUnitType(victim,UNIT_TYPE_HERO)==false or LoadBoolean(HY,GetHandleId(victim),TEMPEST) then
		return
	endif
	set g=GetAvailableGroup()
	set tt_unit1=victim
	call GroupEnumUnitsInRange(g,GetUnitX(victim),GetUnitY(victim),925,Condition(function Silencer_IntSteal_Filter))
	if IsUnitType(killer,UNIT_TYPE_HERO)==false then
		set killer=udg_Hero[GetPlayerId(GetOwningPlayer(killer))]
	endif
	if GetUnitAbilityLevel(killer,'A0LZ')>0 and IsDead(killer)==false and IsUnitEnemy(killer,GetOwningPlayer(victim)) then//A0LZ -> Glaives of Wisdom
		call GroupAddUnit(g,killer)
	endif
	if FirstOfGroup(g)!=null then
		call ForGroup(g,function Silencer_IntSteal_Distrib)
	endif
	call KillGroup(g)
	set g=null
endfunction

function CurseOfTheSilence_SpellFilter takes integer id returns boolean
	return isDummyAbility(id)==false and isAintItemAbility(id)
endfunction

function D0F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,5)
	local integer Count=LoadInteger(HY,h,34)
	if GetTriggerEventId()!=EVENT_WIDGET_DEATH and GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT and Count<6 then
		set Count=Count+1
		call SaveInteger(HY,h,34,Count)
		call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-8*Level)
		call DamageTarget(Source,Target,1,5+15*Level)
	endif
	if Count>=6 or GetUnitAbilityLevel(Target,'A1PS')==0 or GetTriggerEventId()==EVENT_WIDGET_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and CurseOfTheSilence_SpellFilter(GetSpellAbilityId()))then//A1PS -> Curse of the Silent
		//call DestroyEffect(LoadEffectHandle(HY,h,32))
		call UnitRemoveAbility(Target,'A1PS')//A1PS -> Curse of the Silent
		call UnitRemoveAbility(Target,'B0CQ')//B0CQ -> Curse of the Silent
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function D5F takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetEnumUnit()
	local integer Level=Silencer_CurseOfSilence_Level//GetUnitAbilityLevel(Source,'A14L')//A14L -> Curse of the Silent
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call UnitAddAbility2(Target,'A1PS')//A1PS -> Curse of the Silent
	
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function D0F))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	
	call SaveInteger(HY,h,5,(Level))
	call SaveInteger(HY,h,34,0)
	set Source=null
	set Target=null
	set t=null
endfunction

function D99 takes nothing returns boolean
	return(IsMagicImmune(GetFilterUnit())==false and(IsUnitIdType(GetUnitTypeId(GetFilterUnit()),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and IsUnitInvulnerable(GetFilterUnit())==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())))!=null
endfunction

function Silencer_CurseOfSilence takes nothing returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=GetTriggerUnit()
	call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),375,Condition(function D99))
	set Silencer_CurseOfSilence_Level=GetUnitAbilityLevel(tt_unit1,'A14L')//A14L -> Curse of the Silent
	call ForGroup(g,function D5F)
	call ZD8("war3mapImported\\CotS.mdx",GetSpellTargetX(),GetSpellTargetY(),5)
	call KillGroup(g)
	set g=null
endfunction

function Silencer_GlobalSilence_Volume takes nothing returns boolean
	local player p=LoadPlayerHandle(HY,GetHandleId(GetTriggeringTrigger()),0)
	call RemoveSavedHandle(HY,GetHandleId(GetTriggeringTrigger()),0)
	call CleanTrigger(GetTriggeringTrigger())
	if IsPlayerEnemy(p,GetLocalPlayer()) then
		call VolumeGroupReset()
	endif
	return false
endfunction

function Silencer_GlobalSilence_Filter takes nothing returns boolean
	return IsMagicImmune(GetFilterUnit())==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))
endfunction

function Silencer_GlobalSilence_AghBonus takes nothing returns nothing
	local group g
	local integer l=4
	if l>0 then
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,0,0,9999,Condition(function Silencer_GlobalSilence_Filter))
		set Silencer_CurseOfSilence_Level=4
		call ForGroup(g,function D5F)
		call KillGroup(g)
	endif
	set g=null
endfunction

function Silencer_GlobalSilence_Start takes nothing returns nothing
	local location YT9=GetUnitLoc(GetTriggerUnit())
	local trigger t=CreateTrigger()
	local integer lvl=GetUnitAbilityLevel(GetTriggerUnit(),'A0L3')//A0L3 -> Global Silence
	if lvl==0 then
		set lvl=1+GetUnitAbilityLevel(GetTriggerUnit(),'A2QC')//A2QC -> Global Silence
		call Silencer_GlobalSilence_AghBonus()
	endif
	call TriggerRegisterTimerEvent(t,lvl+3,false)
	call SavePlayerHandle(HY,GetHandleId(t),0,GetTriggerPlayer())
	call TriggerAddCondition(t,Condition(function Silencer_GlobalSilence_Volume))
	set bj_lastCreatedUnit=CreateUnit(GetTriggerPlayer(),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
	call ShowUnit(bj_lastCreatedUnit,false)
	call UnitApplyTimedLife(bj_lastCreatedUnit,'BTLF',5)
	call UnitAddAbility(bj_lastCreatedUnit,'A0L2')//A0L2 -> Silence
	call SetUnitAbilityLevel(bj_lastCreatedUnit,'A0L2',GetUnitAbilityLevel(GetTriggerUnit(),'A0L3'))//A0L2 -> Silence, A0L3 -> Global Silence
	call IssuePointOrderByIdLoc(bj_lastCreatedUnit,852592,YT9)
	if IsPlayerEnemy(GetLocalPlayer(),GetTriggerPlayer()) then
		call VolumeGroupSetVolume(SOUND_VOLUMEGROUP_UNITSOUNDS,.0)
		call VolumeGroupSetVolume(SOUND_VOLUMEGROUP_COMBAT,.0)
		call VolumeGroupSetVolume(SOUND_VOLUMEGROUP_SPELLS,.0)
		call VolumeGroupSetVolume(SOUND_VOLUMEGROUP_MUSIC,.0)
	endif
	call RemoveLocation(YT9)
	set t=null
	set YT9=null
endfunction

function Sniper_TakeAim_Learn takes nothing returns nothing
	local unit u = GetTriggerUnit()
	call SetUnitAcquireRange(u,GetUnitAcquireRange(u) + 100)
	call SetPlayerTechResearched(GetOwningPlayer(u),'R005',GetUnitAbilityLevel(u,'A03U'))//A03U -> Take Aim, QP1Q -> Take Aim
	set u = null
endfunction

function SniperHeadshotWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'P102')!=0 and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 and PRD_Get(UDSG_Attacker,'P102',40) then
		call UnitAddAbilityTimedExF(UDSG_Target,'A469',1,0.5,'B469')//B469 -> Headshot
		call DamageTarget(UDSG_Attacker,UDSG_Target,2,25*GetUnitAbilityLevel(UDSG_Attacker,'P102')-10)
	endif
endfunction

function SniperShrapnelFilter takes nothing returns boolean
	return DefaultEnemyFilterWithAncients() and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false
endfunction

function EDF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Caster=LoadUnitHandle(HY,h,19)
	local integer Level=LoadInteger(HY,h,5)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local group g=GetAvailableGroup()
	local real d
	local real a
	local real x2
	local real y2
	local unit u
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,475,Condition(function SniperShrapnelFilter))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call DamageTarget(Source,u,1,Level*12)
		set tt_player1=GetOwningPlayer(Caster)
		call SetUnitOwner(Caster,GetOwningPlayer(u),false)
		call IssueTargetOrder(Caster,"slow",u)
		call SetUnitOwner(Caster,tt_player1,false)
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
	call DestroyEffect(LoadEffectHandle(HY,h,309))
	call DestroyEffect(LoadEffectHandle(HY,h,175))
	call DestroyEffect(LoadEffectHandle(HY,h,176))
	call DestroyEffect(LoadEffectHandle(HY,h,177))
	call DestroyEffect(LoadEffectHandle(HY,h,178))
	call DestroyEffect(LoadEffectHandle(HY,h,179))
	call DestroyEffect(LoadEffectHandle(HY,h,180))
	call DestroyEffect(LoadEffectHandle(HY,h,330))
	call DestroyEffect(LoadEffectHandle(HY,h,331))
	if GetTriggerEvalCount(t)==11 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set d=0
		set a=0
		set x2=x+d*Cos(a*bj_DEGTORAD)
		set y2=y+d*Sin(a*bj_DEGTORAD)
		call SaveEffectHandle(HY,h,309,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
		set d=150
		set a=45
		set x2=x+d*Cos(a*bj_DEGTORAD)
		set y2=y+d*Sin(a*bj_DEGTORAD)
		call SaveEffectHandle(HY,h,175,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
		set d=275
		set a=90
		set x2=x+d*Cos(a*bj_DEGTORAD)
		set y2=y+d*Sin(a*bj_DEGTORAD)
		call SaveEffectHandle(HY,h,176,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
		set d=150
		set a=135
		set x2=x+d*Cos(a*bj_DEGTORAD)
		set y2=y+d*Sin(a*bj_DEGTORAD)
		call SaveEffectHandle(HY,h,177,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
		set d=275
		set a=180
		set x2=x+d*Cos(a*bj_DEGTORAD)
		set y2=y+d*Sin(a*bj_DEGTORAD)
		call SaveEffectHandle(HY,h,178,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
		set d=150
		set a=225
		set x2=x+d*Cos(a*bj_DEGTORAD)
		set y2=y+d*Sin(a*bj_DEGTORAD)
		call SaveEffectHandle(HY,h,179,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
		set d=275
		set a=270
		set x2=x+d*Cos(a*bj_DEGTORAD)
		set y2=y+d*Sin(a*bj_DEGTORAD)
		call SaveEffectHandle(HY,h,180,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
		set d=150
		set a=305
		set x2=x+d*Cos(a*bj_DEGTORAD)
		set y2=y+d*Sin(a*bj_DEGTORAD)
		call SaveEffectHandle(HY,h,330,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
		set d=275
		set a=360
		set x2=x+d*Cos(a*bj_DEGTORAD)
		set y2=y+d*Sin(a*bj_DEGTORAD)
		call SaveEffectHandle(HY,h,331,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
	endif
	set t=null
	set Source=null
	set Caster=null
	set g=null
	return false
endfunction

function EEF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer Level=LoadInteger(HY,h,0)
	local real x1=LoadReal(HY,h,6)
	local real y1=LoadReal(HY,h,7)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x1,y1,0)//e00E -> Spellcaster
	local real x2
	local real y2
	local real d
	local real a
	local integer i
	call UnitAddAbility2(Caster,'A19F')//A19F -> Shrapnel Slow
	call SetUnitAbilityLevel(Caster,'A19F',Level)//A19F -> Shrapnel Slow
	if GetTriggerEvalCount(t)==1 then
		set i=1
		loop
			exitwhen i>10
			set d=GetRandomReal(0,450)
			set a=GetRandomReal(0,360)
			set x2=x1+d*Cos(a*bj_DEGTORAD)
			set y2=y1+d*Sin(a*bj_DEGTORAD)
			set Caster=CreateUnit(GetOwningPlayer(Source),'e00J',GetUnitX(Source),GetUnitY(Source),90)//e00J -> ScatterDebrei
			call IssuePointOrderById(Caster,851984,x2,y2)
			call UnitApplyTimedLife(Caster,'BTLF',.5)
			set i=i+1
		endloop
	else
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,Source)
		call SaveUnitHandle(HY,h,19,Caster)
		call SaveReal(HY,h,6,x1*1.)
		call SaveReal(HY,h,7,y1*1.)
		call SaveInteger(HY,h,5,Level)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddCondition(t,Condition(function EDF))
		call TriggerEvaluate(t)
	endif
	set Source=null
	set Caster=null
	set t=null
	return false
endfunction

function Sniper_Shrapnel takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	call SaveInteger(HY,GetHandleId(Source),'A064',LoadInteger(HY,GetHandleId(Source),'A064')-1)//A064 -> Shrapnel, A064 -> Shrapnel
	call TimedReveal(GetOwningPlayer(Source),9.4,x,y,400)
	call TriggerRegisterTimerEvent(t,.4,true)
	call TriggerAddCondition(t,Condition(function EEF))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,6,x*1.)
	call SaveReal(HY,h,7,y*1.)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,'A064'))//A064 -> Shrapnel
	set t=null
	set Source=null
endfunction

function ShrapnelRecharge takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,(h),0))
	local real time=(LoadReal(HY,(h),0))
	local integer charges=LoadInteger(HY,GetHandleId(u),'A064')//A064 -> Shrapnel
//	call echo(I2S(charges))
	if charges < 3 then
		set time=time-0.2
		if time<=0.then
			call SaveInteger(HY,GetHandleId(u),'A064',charges+1)//A064 -> Shrapnel
			call SaveReal(HY,h,0,40.0)
		else
			call SaveReal(HY,h,0,time*1.0)
		endif
	endif
	if charges==0 or GetUnitAbilityLevel(u,'A064')==0 then//A064 -> Shrapnel
		call UnitRemoveAbility(u,'A46B')
		call UnitRemoveAbility(u,'B46B')//B46B -> Shrapnel
	elseif GetUnitAbilityLevel(u,'A064')>0 then//A064 -> Shrapnel
		call UnitAddAbility2(u,'A46B')
	endif
	set u=null
	set t=null
	return false
endfunction

function ShrapnelInitRechargingForRubick takes unit rubick returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,0.2,true)
	call TriggerAddCondition(t,Condition(function ShrapnelRecharge))
	call SaveUnitHandle(HY,GetHandleId(t),0,rubick)
	call SaveReal(HY,GetHandleId(t),0,40.)
	call SaveInteger(HY,GetHandleId(rubick),'A064',3)//A064 -> Shrapnel
	call SaveTriggerHandle(HY,GetHandleId(rubick),'A064',t)//A064 -> Shrapnel
	call SaveBoolean(HY,GetHandleId(rubick),'A064',true)//A064 -> Shrapnel
	call DisplayTimedTextToPlayer(GetOwningPlayer(rubick),0,0,10,"|c00FF0000Hint|r: You can toggle charges counter using chat command |c00bd2222-charges|r")
	set t=null
endfunction

function Sniper_Shrapnel_OnCast takes nothing returns nothing
	if HaveSavedHandle(HY,GetHandleId(GetTriggerUnit()),'A064')==false then//A064 -> Shrapnel
		call ShrapnelInitRechargingForRubick(GetTriggerUnit())
	endif
	if LoadInteger(HY,GetHandleId(GetTriggerUnit()),'A064')==0 then//A064 -> Shrapnel
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),"No charges left")
	endif
endfunction

function Sniper_Shrapnel_Learn takes nothing returns nothing
	if HaveSavedHandle(HY,GetHandleId(GetTriggerUnit()),'A064')==false then//A064 -> Shrapnel
		call ShrapnelInitRechargingForRubick(GetTriggerUnit())
	endif
endfunction

function MB9 takes nothing returns nothing
	call PreloadQueryAdd('A19F')//A19F -> Shrapnel Slow
endfunction

function SniperAghHit takes nothing returns nothing
	local unit source=tt_unit1
	local unit target=tt_unit2
	local integer h=GetHandleId(GetTriggeringTrigger())
	local integer lvl=LoadInteger(HY,h,10)
	local real dmg
	local group g=GetAvailableGroup()
	local unit u
	call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),350,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	set dmg=205+150*lvl
	call GroupRemoveUnit(g,target)
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\Mortar\\MortarMissile.mdl",GetUnitX(target),GetUnitY(target)))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call DamageTarget(source,u,1,dmg)
		call GroupRemoveUnit(g,u)
	endloop
	call DestroyEffect(LoadEffectHandle(HY,GetHandleId(LoadUnitHandle(HY,h,45)),-1))
	call KillGroup(g)
	set source=null
	set target=null
endfunction

function Sniper_Agh takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local trigger t=AddProjectile(caster,target,EMPTYDUMMY,"SniperAghHit",2500,false)
	local integer h=GetHandleId(t)
	local unit d=LoadUnitHandle(HY,h,45)
	local effect fx=AddSpecialEffectTarget("Abilities\\Weapons\\CannonTowerMissile\\CannonTowerMissile.mdl",d,"origin")
	call SaveInteger(HY,h,10,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
	call SaveEffectHandle(HY,GetHandleId(d),-1,fx)
	set fx=null
	set d=null
	set t=null
	set caster=null
	set target=null
endfunction

function EHF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local effect FX=(LoadEffectHandle(HY,h,32))
	local player p=GetOwningPlayer(Hero)
	call DestroyEffect(FX)
	call RemoveUnit(Caster)
	call UnitRemoveAbility(Target,'B06H')//B06H -> Assassinate
	call UnitRemoveAbility(Target,'A313')
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	set Caster=null
	set Target=null
	set FX=null
	set p=null
	return false
endfunction

function Sniper_Assassinate takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local player p=GetOwningPlayer(Hero)
	local unit Caster
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local string s="effects\\Snipe Target.mdx"
	if IsPlayerAlly(GetLocalPlayer(),p) or IsObserver(GetLocalPlayer()) then
		set s=""
	endif
	call UnitAddAbility2(Target,'A313')
	call ShareVision(Target,Hero,'A313')
	set Caster=CreateUnit(GetOwningPlayer(Target),'e01R',0,0,0)//e01R -> Buff Placer
	call UnitAddAbility2(Caster,'A0NI')//A0NI -> Assassinate buff
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget(s,Target,"overhead")))
	call TriggerRegisterTimerEvent(t,4,false)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function EHF))
	set t=null
	set Hero=null
	set Target=null
	set Caster=null
	set p=null
endfunction

function SmokeScreenTurning takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local group affected=LoadGroupHandle(HY,h,0)
	local group gg
	local integer c=LoadInteger(HY,h,0)
	local unit u2
	if c<60 then
		set gg=GetAvailableGroup()
		set tt_unit1=LoadUnitHandle(HY,h,1)
		call GroupEnumUnitsInRange(gg,LoadReal(HY,h,0),LoadReal(HY,h,1),250+25*LoadInteger(HY,h,5),Condition(function NonImmuneEnemyFilterWithAncients))
		loop
			set u2=FirstOfGroup(affected)
			exitwhen u2==null
			call SetUnitTurnSpeed(u2,GetUnitDefaultTurnSpeed(u2))
			call GroupRemoveUnit(affected,u2)
		endloop
		loop
			set u2=FirstOfGroup(gg)
			exitwhen u2==null
			if GetUnitAbilityLevel(u2,'B0BS')==0 then//B0BS -> Sticky Napalm
				call GroupAddUnit(affected,u2)
				call SetUnitTurnSpeed(u2,GetUnitDefaultTurnSpeed(u2)*.7)
			endif
			call GroupRemoveUnit(gg,u2)
		endloop
		call SaveInteger(HY,h,0,c+1)
		call KillGroup(gg)
	else
		loop
			set u2=FirstOfGroup(affected)
			exitwhen u2==null
			if GetUnitAbilityLevel(u2,'B0BS')==0 then//B0BS -> Sticky Napalm
				call SetUnitTurnSpeed(u2,GetUnitDefaultTurnSpeed(u2))
			endif
			call GroupRemoveUnit(affected,u2)
		endloop
		call KillGroup(affected)
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	endif
	set t=null
endfunction

function Riki_SmokeScreen takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e003',x,y,0)//e003 -> Smoke Screen
	local integer Level=GetUnitAbilityLevel(Hero,'A0RG')//A0RG -> Smoke Screen
	local real EMF=(83+17*Level)*.01
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0.1,true,function SmokeScreenTurning)
	call SaveGroupHandle(HY,h,0,GetAvailableGroup())
	call SaveReal(HY,h,0,x)
	call SaveReal(HY,h,1,y)
	call SaveInteger(HY,h,5,Level)
	call SaveUnitHandle(HY,h,1,Hero)
	set t=null
	call SetUnitVertexColor(Caster,255,255,255,150)
	call UnitApplyTimedLife(Caster,'BTLF',6)
	call SetUnitScale(Caster,EMF,EMF,EMF)
	if IsScourge(GetOwningPlayer(Hero))then
		call UnitAddAbility2(Caster,'A019')//A019 -> Smoke screen scourge
		call SetUnitAbilityLevel(Caster,'A019',Level)//A019 -> Smoke screen scourge
	else
		call UnitAddAbility2(Caster,'A0E7')//A0E7 -> Smoke screen effect
		call SetUnitAbilityLevel(Caster,'A0E7',Level)//A0E7 -> Smoke screen effect
	endif
	call EvasionSourceActivate(EVASION_DEBUFF_SMOKE,8.)
	set SmokeScreenLevel=Level
	call IssuePointOrderById(Caster,852473,x,y)
	set Hero=null
	set Caster=null
endfunction

function Backstab_Fixed takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local integer dmg=LoadInteger(MHT,GetHandleId(caster),'BACK')
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
		call RemoveSavedHandle(MHT,GetHandleId(caster),'BACK')
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==caster and IsFakeDamage<1 and GetEventDamage()>0 then
			call SaveInteger(MHT,GetHandleId(caster),'BACK',0)
			call RemoveSavedHandle(MHT,GetHandleId(caster),'BACK')
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",target,"chest"))
			call DamageTarget(caster,target,2,dmg)
		endif
	else
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
		call RemoveSavedHandle(MHT,GetHandleId(caster),'BACK')
	endif
	set t=null
	set caster=null
	set target=null
endfunction

function Rikki_BackStab_Condition takes unit u, unit t returns nothing
	local integer level = GetUnitAbilityLevel(u,'A0DZ')//A0DZ -> Backstab, QP07 -> Backstab
	local real d
	local unit dummy
	local real multiplier
	local integer prevdmg
	local integer curdmg
	local trigger tt
	local integer h
	local integer i
	local integer ms
	if level==0 or GetUnitAbilityLevel(u,'A36D')==1 then
		return
	endif
	set d=RAbsBJ(GetUnitFacing(u)-GetUnitFacing(t))
	if d>180 then
		set d=360-d
	endif
	if LoadInteger(MHT,GetHandleId(u),'BACK')>0 then
		call SaveInteger(MHT,GetHandleId(u),'BACK',0)
	endif
	if LoadTriggerHandle(MHT,GetHandleId(u),'BACK')!=null then
		call FlushChildHashtable(HY,GetHandleId(LoadTriggerHandle(MHT,GetHandleId(u),'BACK')))
		call DestroyTrigger(LoadTriggerHandle(MHT,GetHandleId(u),'BACK'))
	endif
	if IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and IsUnitIllusion(u)==false and d<=105 then
		set multiplier=0.25*level
		set ms=GetUnitPrimaryAttribute(u)
		if ms==1 then
			set i=GetHeroInt(u,true)
		elseif ms==2 then
			set i=GetHeroAgi(u,true)
		elseif ms==3 then
			set i=GetHeroStr(u,true)
		endif
		set curdmg=R2I(i*(multiplier))
		call SaveInteger(MHT,GetHandleId(u),'BACK',curdmg)
		set tt=CreateTrigger()
		set h=GetHandleId(tt)
		call SaveUnitHandle(HY,h,0,u)
		call SaveUnitHandle(HY,h,1,t)
		call TriggerRegisterTimerEvent(tt,5,false)
		call TriggerRegisterDeathEvent(tt,u)
		call TriggerRegisterUnitEvent(tt,t,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(tt,Condition(function Backstab_Fixed))
		call SaveTriggerHandle(MHT,GetHandleId(u),'BACK',tt)
		set tt=null
	endif
	set dummy=null
endfunction

function BlinkStrikeRecharge takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,(h),0))
	local real time=(LoadReal(HY,(h),0))
	local integer charges=(LoadInteger(HY,(GetHandleId(u)),('A0K9')))//A0K9 -> Blink Strike
	if charges < GetUnitAbilityLevel(u,'A0K9')+3 then//A0K9 -> Blink Strike
		set time=time-0.2
		if time<=0.then
			call SaveInteger(HY,GetHandleId(u),'A0K9',charges+1)//A0K9 -> Blink Strike
			call SaveReal(HY,h,0,35.0)
		else
			call SaveReal(HY,h,0,time*1.0)
		endif
	endif
	set u=null
	set t=null
	return false
endfunction

function BlinkStrikeInitRechargingForRubick takes unit rubick, unit riki returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,0.2,true)
	call TriggerAddCondition(t,Condition(function BlinkStrikeRecharge))
	call SaveUnitHandle(HY,GetHandleId(t),0,rubick)
	call SaveReal(HY,GetHandleId(t),0,35.)
	call SaveInteger(HY,GetHandleId(rubick),'A0K9',GetUnitAbilityLevel(riki,'A0K9')+3)//A0K9 -> Blink Strike, A0K9 -> Blink Strike
	call SaveTriggerHandle(HY,GetHandleId(rubick),'A0K9',t)//A0K9 -> Blink Strike
	call DisplayTimedTextToPlayer(GetOwningPlayer(rubick),0,0,10,"|c00FF0000Hint|r: You can toggle charges counter using chat command |c00bd2222-charges|r")
	set t=null
endfunction

function Riki_BlinkStrike takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local real Damage=10+30*GetUnitAbilityLevel(Source,'A0K9')//A0K9 -> Blink Strike
	local real x=GetUnitX(Target)-75*Cos(GetUnitFacing(Target)*bj_DEGTORAD)
	local real y=GetUnitY(Target)-75*Sin(GetUnitFacing(Target)*bj_DEGTORAD)
	call SetUnitX(Source,x)
	call SetUnitY(Source,y)
	call SetUnitFacing(Source,GetUnitFacing(Target))
	call DestroyEffect(AddSpecialEffect("war3mapImported\\BlinkStrike.mdx",x,y))
	if IsUnitEnemy(Target,GetOwningPlayer(Source))then
		call DamageTarget(Source,Target,1,Damage)
		call SaveBoolean(HY,(GetHandleId(Source)),332,(true))
		call AttackOrderDelayed(Source,Target)
	endif
	set Source=null
	set Target=null
endfunction

function Riki_BlinkStrikePre takes nothing returns nothing
	local integer charges =LoadInteger(HY,GetHandleId(GetTriggerUnit()),'A0K9')//A0K9 -> Blink Strike
	call SaveInteger(HY,GetHandleId(GetTriggerUnit()),'A0K9',charges-1)//A0K9 -> Blink Strike
	if IsPlayerAlly(GetTriggerPlayer(),GetOwningPlayer(GetSpellTargetUnit())) or IsBlocked(GetSpellTargetUnit())==false then
		call Riki_BlinkStrike()
	endif
endfunction

function Rikimaru_BlinkStrike_OnCast takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer charges=LoadInteger(HY,GetHandleId(u),'A0K9')//A0K9 -> Blink Strike
	if charges == 0 then
		if HaveSavedHandle(HY,GetHandleId(u),'A0K9')==false then//first time use ever//A0K9 -> Blink Strike
			call BlinkStrikeInitRechargingForRubick(u,u)
			set charges=LoadInteger(HY,GetHandleId(u),'A0K9')//A0K9 -> Blink Strike
		else
//			call echo(I2S(GetHandleId(LoadTriggerHandle(HY,GetHandleId(u),'A0K9'))))//A0K9 -> Blink Strike
		endif
	endif
	if charges<=0 then
		call InterruptUnit(u)
		call Error(GetOwningPlayer(u),"No charges left")
	else
		call DestroyEffect(AddSpecialEffect("war3mapImported\\BlinkStrike.mdx",GetUnitX(u),GetUnitY(u)))
	endif
endfunction

function Rikimaru_BlinkStrike_Learn takes nothing returns nothing
	if HaveSavedHandle(HY,GetHandleId(GetTriggerUnit()),'A0K9') then//A0K9 -> Blink Strike
		call SaveInteger(HY,GetHandleId(GetTriggerUnit()),'A0K9',LoadInteger(HY,GetHandleId(GetTriggerUnit()),'A0K9')+1)//A0K9 -> Blink Strike, A0K9 -> Blink Strike
	else
		call BlinkStrikeInitRechargingForRubick(GetTriggerUnit(),GetTriggerUnit())
	endif
endfunction

function RikiResetInvis takes unit u returns nothing
	local integer i
	
	if GetUnitAbilityLevel(u,'A30F')>0 then
		call UnitRemoveAbility(u,'A30F')
		call UnitRemoveAbility(u,'A46I')
		set i=GetUnitAbilityLevel(u,'A00J')//A00J -> Permanent Invisibility
		call UnitRemoveAbility(u,'A00J')//A00J -> Permanent Invisibility
		call UnitAddAbility2(u,'A00J')//A00J -> Permanent Invisibility
		call SetUnitAbilityLevel(u,'A00J',i)//A00J -> Permanent Invisibility
	endif
	
endfunction

function RikiResetInvisOnMorph takes nothing returns nothing
	local integer i=GetUnitAbilityLevel(tt_unit1,'A00J')//A00J -> Permanent Invisibility
	if i!=0 then
		call UnitRemoveAbility(tt_unit1,'A00J')//A00J -> Permanent Invisibility
		if i>1 then
			call UnitAddAbility(tt_unit1,'A3Q4'-2+i)
		endif
		call UnitAddAbility2(tt_unit1,'A00J')//A00J -> Permanent Invisibility
		call SetUnitAbilityLevel(tt_unit1,'A00J',i)//A00J -> Permanent Invisibility
		if i>1 then
			call UnitRemoveAbility(tt_unit1,'A3Q4'-2+i)
		endif
	endif
endfunction

function Riki_PermanentInvis_Periodic takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u
	local integer i
	if GetTriggerEventId()==EVENT_UNIT_SPELL_CAST  then
		if GetSpellAbilityId()=='A0K9' or IsPoisonArrowSkill(GetSpellAbilityId()) then//A0K9 -> Blink Strike
			set u=GetTriggerUnit()
			//call SaveReal(HeroStats,GetHandleId(u),23,TimerGetElapsed(GlobalTimer)+10-2*GetUnitAbilityLevel(u,'A00J'))//A00J -> Permanent Invisibility
			call SaveBoolean(HeroStats,GetHandleId(u),23,false)
			call RikiResetInvis(u)
			set u=null
		endif
	elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
		if GetAttacker()==LoadUnitHandle(MHT,h,0) then
			set u=GetAttacker()
			//call SaveReal(HeroStats,GetHandleId(u),23,TimerGetElapsed(GlobalTimer)+10-2*GetUnitAbilityLevel(u,'A00J'))//A00J -> Permanent Invisibility
			call SaveBoolean(HeroStats,GetHandleId(u),23,false)
			call RikiResetInvis(u)
			set u=null
		endif
	else
		set u=LoadUnitHandle(MHT,h,0)
		if GetUnitTypeId(u)==0 then//unit doesnt exist
			call FlushChildHashtable(HeroStats,GetHandleId(u))
			call FlushChildHashtable(MHT,h)
			call CleanTrigger(t)
		else
			if LoadBoolean(HeroStats,GetHandleId(u),23) and IsUnitInvisibleNeutrals(u) then
				if GetUnitAbilityLevel(u,'A30F')==0	then
					call UnitAddAbility2(u,'A30F')
				endif
//				if GetUnitAbilityLevel(u,'A46I')!=GetUnitAbilityLevel(u,'A00J') then//A00J -> Permanent Invisibility
//					call UnitAddAbility3(u,'A46I',GetUnitAbilityLevel(u,'A00J'))//A00J -> Permanent Invisibility
//				endif
			endif
		endif
	endif
	set t=null
	set u=null
endfunction

function Riki_PermanentInvis_Learnd takes nothing returns nothing
	local unit u
	local trigger t
	local integer h
	call RemoveEndlessFadetime(GetTriggerUnit())
	if not Mode_BO then
		return
	endif
	set u=GetTriggerUnit()
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.2,true)
	call SaveUnitHandle(MHT,h,0,u)
	call SaveBoolean(HeroStats,GetHandleId(u),23,true)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_CAST)
	call TriggerAddCondition(t,Condition(function Riki_PermanentInvis_Periodic))
	set u=null
	set t=null
endfunction

function mySven_Warcry_Targets takes nothing returns boolean
	return IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitAlly(LoadUnitHandle(TempHash,'A2IS','cast'),GetOwningPlayer(GetFilterUnit())) and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitIllusion(GetFilterUnit())==false//, A2IS -> Warcry
endfunction

function mySven_Warcry_Dur takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer c=LoadInteger(HY,h,0)
	local unit u=LoadUnitHandle(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or c<=0 or GetUnitAbilityLevel(u,'C025')==0 then
		call LoDStat_Sub(u,LoadInteger(HY,h,1),"armour")
		call UnitRemoveAbility(u,'C025')
		call UnitRemoveAbility(u,'D025')//D025 -> |cff32cd32Warcry|r
		call FlushChildHashtable(HY,h)
		call RemoveSavedHandle(HY,GetHandleId(u),'A2IS')//A2IS -> Warcry
		call CleanTrigger(t)
	else
		call SaveInteger(HY,h,0,c-1)
	endif
	set t=null
	set u=null
endfunction

function mySven_Warcry_ForGroup takes nothing returns nothing
	local unit u=GetEnumUnit()
	local trigger t
	local integer h
	local integer hu=GetHandleId(u)
	local integer lvl=LoadInteger(TempHash,'A2IS','levl')//A2IS -> Warcry
	if HaveSavedHandle(HY,hu,'A2IS') then//A2IS -> Warcry
		set t=LoadTriggerHandle(HY,hu,'A2IS')//A2IS -> Warcry
		set h=GetHandleId(t)
		call SaveInteger(HY,h,0,70)
		call LoDStat_Add(u,5*lvl,"armour")
		call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+5*lvl)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.1,true)
		call TriggerRegisterDeathEvent(t,u)
		call SaveUnitHandle(HY,h,0,u)
		call SaveInteger(HY,h,0,70)
		call SaveTriggerHandle(HY,hu,'A2IS',t)//A2IS -> Warcry
		call TriggerAddCondition(t,Condition(function mySven_Warcry_Dur))
		call LoDStat_Add(u,5*lvl,"armour")
		call SaveInteger(HY,h,1,5*lvl)
		call UnitAddAbility2(u,'C025')
	endif
	set u=null
	set t=null
endfunction

function mySven_Warcry takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local group g = GetAvailableGroup()
	call SaveUnitHandle(TempHash,'A2IS','cast',u)//A2IS -> Warcry
	call SaveInteger(TempHash,'A2IS','levl',GetUnitAbilityLevel(u,GetSpellAbilityId()))//A2IS -> Warcry
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl",u,"overhead"))
	call GroupEnumUnitsInRange(g,GetWidgetX(u),GetWidgetY(u),925,Condition(function mySven_Warcry_Targets))
	call ForGroup(g,function mySven_Warcry_ForGroup)
	call FlushChildHashtable(TempHash,'A2IS')//A2IS -> Warcry
	call KillGroup(g)
	set g=null
	set u=null
endfunction

function myGodStrengthDur takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	call UnitRemoveAbility(u,'A0WO')//A0WO -> God's Strength Container
	call UnitRemoveAbility(u,'A43G')
	call UnitRemoveAbility(u,'B009')//B009 -> God's Strength
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set u=null
	set t=null
endfunction

function myGodStrength takes nothing returns nothing//A0WP
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(Hero,GetSpellAbilityId())
	call TimerStart(t,25,false,function myGodStrengthDur)
	call SaveUnitHandle(HY,h,0,Hero)
	call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\BattleCryCaster.mdx",Hero,"overhead"))
	call UnitAddAbility2(Hero,'A0WO')//A0WO -> God's Strength Container
	call UnitMakeAbilityPermanent(Hero,true,'A0WM')//A0WM -> God's Strength aura 1
	call SetUnitAbilityLevel(Hero,'A0WM',lvl)//A0WM -> God's Strength aura 1
	call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A0WO',false)//A0WO -> God's Strength Container
	if GetSpellAbilityId()=='A43D' then//A43D -> God's Strength Agh
		call UnitAddAbility2(Hero,'A43G')
		call UnitMakeAbilityPermanent(Hero,true,'A43F')
		call SetUnitAbilityLevel(Hero,'A43F',lvl)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A43G',false)
	endif
	set Hero=null
	set t=null
endfunction

function ECF takes nothing returns nothing
	call DamageTarget(G88,GetEnumUnit(),1,group_temp_integer[4])
	call StunTargetLoD(GetEnumUnit(),2.00)
endfunction

function E3F takes unit Source, player p,unit Target,integer Level returns nothing
	local unit Caster=CreateUnit(p,'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	local integer AF8
	local group g=GetAvailableGroup()
	if GetUnitAbilityLevel(Target,'A3E9')==1 and IsMagicImmune(Source)==false then
		call SaveUnitHandle(TempHash,'A3E9',0,Target)
		call SaveUnitHandle(TempHash,'A3E9',1,Source)
		call SaveInteger(TempHash,'A3E9',0,Level)
		call ExecuteFunc("Sven_StormBoltLotus")
	endif
	set tt_unit1=udg_Hero[GetPlayerId(p)]
	call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),280,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	call GroupAddUnit(g,Target)
	set G88=Caster
	set group_temp_unit[0] = Target
	set group_temp_player = p
	set group_temp_integer[4]=25+Level*50
	call ForGroup(g,function ECF)
	call KillGroup(g)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\StormBolt\\StormBoltMissile.mdl",Target,"origin"))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\StormBolt\\StormBoltMissile.mdl",Target,"origin"))
	set Caster=null
	set g=null
endfunction

function E6F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local player p
	local unit Target
	local integer Level
	local unit Projectile
	local real x
	local real y
	local real TargetX
	local real TargetY
	local boolean blinked
	local real lastX
	local real lastY
	local real AM8
	local real AN8
	local real AO8
	local real AP8
	local boolean DCD
	
	if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if IsDisjointSpell(GetSpellAbilityId()) then
			call SaveBoolean(HY,h,0,true)
			call SaveReal(HY,h,0,GetUnitX(GetTriggerUnit()))
			call SaveReal(HY,h,1,GetUnitY(GetTriggerUnit()))
		endif
	else
		set p=(LoadPlayerHandle(HY,h,54))
		set Target=LoadUnitHandle(HY,h,30)
		set Level=(LoadInteger(HY,h,5))
		set Projectile=(LoadUnitHandle(HY,h,45))
		set x=GetUnitX(Projectile)
		set y=GetUnitY(Projectile)
		set TargetX=GetUnitX(Target)
		set TargetY=GetUnitY(Target)
		set blinked=LoadBoolean(HY,h,0)
		set lastX=LoadReal(HY,h,0)
		set lastY=LoadReal(HY,h,1)
		set AM8=1000*.035
		if blinked then
			set TargetX=lastX
			set TargetY=lastY
		endif
		set AN8=AngleBetweenXY(x,y,TargetX,TargetY)
		set AO8=x+AM8*Cos(AN8*bj_DEGTORAD)
		set AP8=y+AM8*Sin(AN8*bj_DEGTORAD)
		set DCD=(LoadBoolean(HY,h,249))
		call SetUnitX(Projectile,AO8)
		call SetUnitY(Projectile,AP8)
		call SetUnitFacing(Projectile,AN8)
		if DistanceBetweenXY(TargetX,TargetY,AO8,AP8)<=AM8 then
			if blinked==false and DCD then
				call E3F(LoadUnitHandle(HY,h,31),p,Target,Level)
			endif
			call KillUnit(Projectile)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set Target=null
	set Projectile=null
	set p=null
	return false
endfunction

function Sven_StormBolt takes unit Source, unit Target, integer Level returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h07Q',GetUnitX(Source),GetUnitY(Source),AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target)))//h07Q -> Storm bolt
	local boolean DCD=IsBlocked(Target)==false
	call SaveBoolean(HY,h,249,(DCD))
	call SavePlayerHandle(HY,h,54,(GetOwningPlayer(Source)))
	call SaveUnitHandle(HY,h,30,Target)
	call SaveUnitHandle(HY,h,31,Source)
	call SaveUnitHandle(HY,h,45,(Projectile))
	call SaveInteger(HY,h,5,(Level))
	call SaveBoolean(HY,h,0,false)//is blinked?
	call SaveReal(HY,h,0,0)//last time visible X
	call SaveReal(HY,h,1,0)//last time visible Y
	call TriggerRegisterTimerEvent(t,.035,true)
	call TriggerAddCondition(t,Condition(function E6F))
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
	set t=null
	set Projectile=null
endfunction

function Sven_StormBoltWrapper takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A190')//A190 -> Storm Bolt
	call Sven_StormBolt(caster,target,lvl)
	
	set caster=null
	set target=null
endfunction

function Sven_StormBoltLotus takes nothing returns nothing
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	call Sven_StormBolt(LoadUnitHandle(TempHash,'A3E9',0),LoadUnitHandle(TempHash,'A3E9',1),LoadInteger(TempHash,'A3E9',0))
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function Sven_StormBolt_OnCast takes nothing returns nothing
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",GetTriggerUnit(),GetProperAttachPoint_Weapon(GetTriggerUnit())))
endfunction

function E0F takes nothing returns boolean
	return(GetUnitTypeId(GetFilterUnit())=='n01G')or(GetUnitTypeId(GetFilterUnit())=='n01C')or(GetUnitTypeId(GetFilterUnit())=='n018')or(GetUnitTypeId(GetFilterUnit())=='n004')//n01G -> Spirit Bear, n01C -> Spirit Bear, n018 -> Spirit Bear, n004 -> Spirit Bear
endfunction

function LoneDruid_Rabid takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit u
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
	local integer Level=GetUnitAbilityLevel(Source,GetSpellAbilityId())
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(Source),Condition(function E0F))
	set u=FirstOfGroup(g)
	call KillGroup(g)
	call UnitAddAbility2(Caster,'A0AE')//A0AE -> Rabid bloodlust
	call SetUnitAbilityLevel(Caster,'A0AE',Level)//A0AE -> Rabid bloodlust
	call IssueTargetOrderById(Caster,852101,Source)
	if u!=null and IsDead(u)==false then
		call IssueTargetOrderById(Caster,852101,u)
	endif
	set g=null
	set Source=null
	set u=null
	set Caster=null
endfunction

function FOF takes nothing returns boolean
	return IsSpiritBear(GetFilterUnit()) and IsUnitIllusion(GetFilterUnit())==false and IsDead(GetFilterUnit())==false
endfunction

function LoneDruid_Synergy takes nothing returns nothing
	local integer lvl=GetUnitAbilityLevel(GetTriggerUnit(),'A0A8')
	local group g=GetAvailableGroup()
	local unit bear
	local unit u
	call GroupEnumUnitsOfPlayer(g,GetTriggerPlayer(),Condition(function FOF))
	if FirstOfGroup(g)!=null then
		set bear=FirstOfGroup(g)
		if GetUnitAbilityLevel(bear,'ACrk')==0 then
			call UnitAddAbility2(bear,'ACrk')
		endif
		if GetUnitAbilityLevel(bear,'A03A')==0 then
			call UnitAddAbility2(bear,'A03A')
		endif
		if GetUnitAbilityLevel(bear,'A0AH')==0 then
			call UnitAddAbility2(bear,'A0AH')
		endif
		if GetUnitAbilityLevel(bear,'A33C')==0 then
			call UnitAddAbility2(bear,'A33C')
		endif
		if GetUnitAbilityLevel(bear,'Aien')==0 then
			call UnitAddAbility2(bear,'Aien')
		endif
		if GetUnitAbilityLevel(bear,'A0A7')==0 then
			call UnitAddAbility2(bear,'A0A7')
		endif
		call SetUnitMoveSpeed(bear,GetUnitDefaultMoveSpeed(bear)+10+20*lvl)
		if GetUnitAbilityLevel(bear,'A3IL')==0 then
			call UnitAddAbility2(bear,'A3IL')
		endif
		call SetUnitAbilityLevel(bear,'A3IL',lvl)
	endif
	call GroupEnumUnitsOfPlayer(g,GetTriggerPlayer(),Condition(function ReturnTrue))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if GetUnitAbilityLevel(u,'A0KO')>0 then
			call SetUnitMoveSpeed(u,GetUnitDefaultMoveSpeed(u)+20+10*lvl)
		endif
		if IsFamiliarId(GetUnitTypeId(u)) then
			call FamiliarIncLevel(u,lvl)
		endif
		call GroupRemoveUnit(g,u)
	endloop
	call SetPlayerTechResearched(GetTriggerPlayer(),'Recb',lvl)
	call KillGroup(g)
endfunction

function F4F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,2)
	local real time
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamage()>2 and GetEventDamageSource()!=GetTriggerUnit()and IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource()))then
			call SaveReal(HY,h,714,TimerGetElapsed(GlobalTimer)*1.)
		endif
	endif
	set time=LoadReal(HY,h,714)
	if time+3 < TimerGetElapsed(GlobalTimer)then
		if(LoadInteger(HY,h,34))==2 then
			call SaveInteger(HY,h,34,1)
			call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A0A7',true)//A0A7 -> Return
		endif
	else
		if(LoadInteger(HY,h,34))==1 then
			call SaveInteger(HY,h,34,2)
			call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A0A7',false)//A0A7 -> Return
		endif
	endif
	set t=null
	set u=null
	return false
endfunction

function SB_Return_Tracking takes unit bear returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.2,true)
	call TriggerRegisterUnitEvent(t,bear,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,bear,EVENT_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function F4F))
	call SaveUnitHandle(HY,h,2,bear)
	call SaveReal(HY,h,714,0.)
	call SaveInteger(HY,h,34,1)
	call SetPlayerAbilityAvailable2(GetOwningPlayer(bear),'A0A7',true)//A0A7 -> Return
	set t=null
endfunction

function SpiritBearEnsnareDmg takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit target=LoadUnitHandle(HY,h,0)
	local unit bear=LoadUnitHandle(HY,h,1)
	local integer c=LoadInteger(HY,h,0)+1
	call SaveInteger(HY,h,0,c)
	if GetHandleId(bear)!=0 and (GetUnitAbilityLevel(target,'B0C1')>0 or c==1) then//B0C1 -> Entangling Roots
		call DamageTarget(GetInvulDamager(bear),target,2,30)
	endif
	if IsDead(target) or (GetUnitAbilityLevel(target,'B0C1')==0 and c>1) then//B0C1 -> Entangling Roots
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	elseif c==1 then
		call TimerStart(t,0.5,true,function SpiritBearEnsnareDmg)
	endif
	set target=null
	set bear=null
	set t=null
endfunction

function SpiritBear_Ensnare takes unit owner, unit target returns nothing
	local unit d=CreateUnit(GetOwningPlayer(owner),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0,false,function SpiritBearEnsnareDmg)
	call SaveUnitHandle(HY,h,0,target)
	call SaveUnitHandle(HY,h,1,owner)
	call UnitAddAbility(d,'A1GZ')
	call IssueTargetOrder(d,"ensnare",target)
	set d=null
	set t=null
endfunction

function SpiritBearAttack takes unit attacker, unit target returns nothing
	if GetUnitAbilityLevel(attacker,'A33C')>0 and GetUnitAbilityLevel(attacker,'A36D')==0 and TimerGetElapsed(GlobalTimer)>LoadReal(MHT,GetHandleId(attacker),'A33C') and PRD_Get(attacker,'A33C',20) then//A33C -> Entangle, A33C -> Entangle, A33C -> Entangle
		call SaveReal(MHT,GetHandleId(attacker),'A33C',TimerGetElapsed(GlobalTimer)+5)//A33C -> Entangle
		call SpiritBear_Ensnare(attacker,target)
	endif
endfunction

function SB_FindPrevBear takes nothing returns boolean
	return IsSpiritBear(GetFilterUnit()) and GetUnitTypeId(GetFilterUnit())!='n01G' and IsDead(GetFilterUnit())==false//n01G -> Spirit Bear
endfunction

function SB_GiveItems takes nothing returns nothing
	local integer h=GetHandleId(GetOwningPlayer(GetTriggerUnit()))
	local unit u=LoadUnitHandle(HY,h,334)
	local unit new=LoadUnitHandle(HY,h,333)
	if u!=null and Mode_DM==false then
		call UnitAddItem(new,UnitRemoveItemFromSlot(u,0))
		call UnitAddItem(new,UnitRemoveItemFromSlot(u,1))
		call UnitAddItem(new,UnitRemoveItemFromSlot(u,2))
		call UnitAddItem(new,UnitRemoveItemFromSlot(u,3))
		call UnitAddItem(new,UnitRemoveItemFromSlot(u,4))
		call UnitAddItem(new,UnitRemoveItemFromSlot(u,5))
		if GetUnitAbilityLevel(u,'A398')>0 then
			call UnitAddAbility2(new,'A398')
		endif
	endif
	set u=null
	set new=null
endfunction

function SpiritBear_AddCry takes unit u, integer lvl, player p, boolean b returns nothing
	if lvl==0 then
		return
	endif
	call UnitAddAbility2(u,'A34C')//A34C -> Battle Cry
	call SetUnitAbilityLevel(u,'A34C',lvl)//A34C -> Battle Cry
	call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A34C',true)//A34C -> Battle Cry
	if b then
		call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_EFFECT)
	endif
endfunction

function LoneDruid_SpiritBear_Leveling takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local player p=GetOwningPlayer(u)
	local group g
	local integer Level=GetUnitAbilityLevel(u,'A0A5')//A0A5 -> Summon Spirit Bear
	local integer i
	local unit bear
	call SetPlayerTechResearched(GetOwningPlayer(GetTriggerUnit()),'R000',Level)
	if Level>1 then
		set g=GetAvailableGroup()
		call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(u),Condition(function SB_FindPrevBear))
		set i=CountUnitsInGroup(g)
		if(i==1)then
			set bear=FirstOfGroup(g)
			call AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",bear,"chest")
			if(Level==2)then
				call ManageBonusHP(bear,400)
				call UnitAddAbility2(bear,'A0A7')//A0A7 -> Return
				call SB_Return_Tracking(bear)
			elseif(Level==3)then
				call ManageBonusHP(bear,500)
				call UnitAddAbility2(bear,'A33C')//A33C -> Entangle
			elseif(Level==4)then
				call ManageBonusHP(bear,400)
				call UnitAddAbility2(bear,'A03A')//A03A -> Gargoyle Spell Damage Reduction
				call UnitAddAbility2(bear,'A0AH')//A0AH -> Demolish
			endif
			call SpiritBear_AddCry(bear,Level-1,p,true)
		endif
		call KillGroup(g)
	endif
	set g=null
	set u=null
	set bear=null
endfunction

function SpiritBearGPS takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit bear=LoadUnitHandle(HY,h,0)
	local unit hero=LoadUnitHandle(HY,h,1)
	if IsDead(bear) then
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	else
		if DistanceBetweenUnits(bear,hero)>1425 and IsUnitHasAghanim(hero)==false then
			call UnitAddAbility2(bear,'A44D')
			call UnitAddAbility2(bear,'A44E')
		elseif GetUnitAbilityLevel(bear,'A44D')>0 then
			call UnitRemoveAbility(bear,'A44D')
			call UnitRemoveAbility(bear,'A44E')
		endif
	endif
	set hero=null
	set bear=null
	set t=null
endfunction

function SpiritBearTracking takes unit bear returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0.2,true,function SpiritBearGPS)
	call SaveUnitHandle(HY,h,0,bear)
	call SaveUnitHandle(HY,h,1,udg_Hero[GetPlayerId(GetOwningPlayer(bear))])
	set t=null
endfunction

function LoneDruid_SpiritBear takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local player p=GetOwningPlayer(u)
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local group g=GetAvailableGroup()
	local integer Level=GetUnitAbilityLevel(u,'A0A5')//A0A5 -> Summon Spirit Bear
	local integer h=GetHandleId(p)
	local unit bear
	local integer id=0
	call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(u),Condition(function FOF))
	if FirstOfGroup(g)==null then
		if(Level==1)then
			set id='n004'//n004 -> Spirit Bear
		elseif(Level==2)then
			set id='n018'//n018 -> Spirit Bear
		elseif(Level==3)then
			set id='n01C'//n01C -> Spirit Bear
		else
			set id='n01G'//n01G -> Spirit Bear
		endif
		set bear=CreateUnit(GetOwningPlayer(u),id,x,y,GetUnitFacing(u))
		call SpiritBear_AddCry(bear,Level-1,p,true)
		call SaveUnitHandle(HY,h,333,bear)
		call SB_GiveItems()
		call AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",bear,"chest")
		call SB_Return_Tracking(bear)
		call SetUnitAbilityLevel(bear,'A09Y',Level)
		call SpiritBearTracking(bear)
	else
		set bear=FirstOfGroup(g)
		call AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",bear,"chest")
		call SetWidgetLife(bear,GetUnitState(bear,UNIT_STATE_MAX_LIFE))
		call SetUnitPosition(bear,GetUnitX(u),GetUnitY(u))
	endif
	if GetUnitAbilityLevel(u,'A0A8')>0 then//synergy
		if GetUnitAbilityLevel(bear,'ACrk')==0 then
			call UnitAddAbility2(bear,'ACrk')
		endif
		if GetUnitAbilityLevel(bear,'A03A')==0 then
			call UnitAddAbility2(bear,'A03A')
		endif
		if GetUnitAbilityLevel(bear,'A0AH')==0 then
			call UnitAddAbility2(bear,'A0AH')
		endif
		if GetUnitAbilityLevel(bear,'A33C')==0 then
			call UnitAddAbility2(bear,'A33C')
		endif
		if GetUnitAbilityLevel(bear,'Aien')==0 then
			call UnitAddAbility2(bear,'Aien')
		endif
		if GetUnitAbilityLevel(bear,'A0A7')==0 then
			call UnitAddAbility2(bear,'A0A7')
		endif
		call SetUnitMoveSpeed(bear,GetUnitDefaultMoveSpeed(bear)+10+20*GetUnitAbilityLevel(u,'A0A8'))
		if GetUnitAbilityLevel(bear,'A3IL')==0 then
			call UnitAddAbility2(bear,'A3IL')
		endif
		call SetUnitAbilityLevel(bear,'A3IL',GetUnitAbilityLevel(u,'A0A8'))
	endif
	set bear=null
	call KillGroup(g)
	set u=null
	set g=null
endfunction

function LoneDruid_TrueForm takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer i=GetUnitTypeId(u)
	call SetPlayerTechResearched(GetOwningPlayer(u),'R001',(GetUnitAbilityLevel(u,GetSpellAbilityId())+1))
	if i!='N015' and i!='N014' and i!='N013' then//N015 -> Lone Druid, N014 -> Lone Druid, N013 -> Lone Druid
		call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A344',true)//A344 -> Battle Cry
	else
		call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A344',false)//A344 -> Battle Cry
	endif
	call SetUnitAbilityLevel(u,'A344',GetUnitAbilityLevel(u,GetSpellAbilityId()))//A344 -> Battle Cry
	set u=null
endfunction

function TrueForm_BattleRoar takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A1ED')//A1ED -> Battle Cry
	call SetUnitAbilityLevel(d,'A1ED',GetUnitAbilityLevel(GetTriggerUnit(),'A344')+GetUnitAbilityLevel(GetTriggerUnit(),'A34C'))//A1ED -> Battle Cry, A344 -> Battle Cry, A34C -> Battle Cry
	call IssueImmediateOrder(d,"battleroar")
	set d=null
endfunction

function LoneDruid_Return takes nothing returns nothing
	local unit bear
	local unit u
	if GetSpellAbilityId()=='A0A7' then//A0A7 -> Return
		set bear=GetTriggerUnit()
		set u=udg_Hero[GetPlayerId(GetOwningPlayer(bear))]
		call SetUnitX(bear,GetUnitX(u)+GetRandomReal(25,50)*Cos(GetRandomReal(0,360)))
		call SetUnitY(bear,GetUnitY(u)+GetRandomReal(25,50)*Sin(GetRandomReal(0,360)))
		call DelayedInstantOrder(bear,851972,0)
		set bear=null
		set u=null
	endif
endfunction

function SpiritBear_Return_Init takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function LoneDruid_Return))
	set t=null
endfunction

function Lone_HeroDeath_KillBear takes unit victim returns nothing
	local integer pid=GetPlayerId(GetOwningPlayer(victim))
	if victim==udg_Hero[pid] and HaveSavedHandle(HY,GetHandleId(GetOwningPlayer(victim)),333) and IsDead(LoadUnitHandle(HY,GetHandleId(GetOwningPlayer(victim)),333))==false and IsUnitHasAghanim(victim)==false then
		call KillUnit(LoadUnitHandle(HY,GetHandleId(GetOwningPlayer(victim)),333))
	endif
endfunction

function FZF takes nothing returns nothing
	local location l
	if IsSentinel(GetOwningPlayer(GetTriggerUnit()))then
		set l=GetRectCenter(gg_rct_Hero_Creation_NE)
	else
		set l=GetRectCenter(gg_rct_Hero_Creation_UD)
	endif
	if IsRapierOrGem(GetEnumItem())==false then
		call SetItemPositionLoc(GetEnumItem(),l)
	endif
	call RemoveLocation(l)
	set l=null
endfunction

function FAF takes nothing returns nothing
	local integer h=GetHandleId(GetOwningPlayer(GetTriggerUnit()))
	local unit stash=LoadUnitHandle(HY,h,334)
	local unit bear=LoadUnitHandle(HY,h,333)
	local integer x
	local integer y
	if stash==null then
		if IsSentinel(GetOwningPlayer(bear))then
			set x=-6390
			set y=-5615
		else
			set x=5875
			set y=5000
		endif
		set stash=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e01F',x,y,0)//e01F -> ItemHolder
		call SaveUnitHandle(HY,h,334,stash)
	endif
	if IsRapierOrGem(GetEnumItem())==false then
		call UnitAddItem(stash,GetEnumItem())
	endif
	if GetUnitAbilityLevel(bear,'A398')>0 then
		call UnitAddAbility2(stash,'A398')
	endif
	call ShowUnit(stash,true)
	set stash=null
	set bear=null
endfunction

function FBF takes nothing returns nothing
	local integer indexId=GetIndex(GetEnumItem())
	if GetWidgetLife(GetEnumItem())>0 and indexId!=Aegis then
		if Mode_DM then
			call FZF()
		else
			call FAF()
		endif
	endif
endfunction

function FCF takes unit attacker, unit victim returns nothing
	local location l=GetUnitLoc(victim)
	local rect r=RectFromCenterSizeBJ(l,400.,400.)
	local unit u=udg_Hero[GetPlayerId(GetOwningPlayer(victim))]
	local integer lvl=GetUnitAbilityLevel(u,'A0A5')//A0A5 -> Summon Spirit Bear
	call SetHeroXP(u,GetHeroXP(u) - (GetHeroXP(u)/(125-(25*lvl))),false)
	call DamageTarget(attacker,u,5,100.*I2R(lvl))
	call EnumItemsInRect(r,Condition(function ReturnTrue),function FBF)
	call RemoveLocation(l)
	call RemoveRect(r)
	set l=null
	set r=null
	set u=null
endfunction

function SpiritBear_Death takes unit attacker, unit victim returns nothing
	if IsSpiritBear(victim) then
		call FCF(attacker,victim)
	endif
endfunction

function StunFor05 takes unit u returns nothing
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u), GetUnitY(u),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A325')
	call IssueTargetOrder(d,"thunderbolt",u)
	set d=null
endfunction

function F6F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer count=LoadInteger(HY,h,100)
	local integer lvl=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource()))and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetEventDamageSource())) and GU8==false then
			if GV8==false then
				call UnitRemoveAbility(GetTriggerUnit(),'B0BM')//B0BM -> Echo Stomp
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
			endif
		endif
		if GV8 then
			set GV8=false
		endif
		if GU8 then
			set GU8=false
		endif
	else
		set count=count+1
		call SaveInteger(HY,h,100,count)
		if count>lvl*2 then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(GetTriggeringTrigger())
		else
			call StunFor05(LoadUnitHandle(HY,h,0))
		endif
	endif
	set t=null
	return false
endfunction

function Tauren_Stomp_Stun_Targets takes nothing returns boolean
	local trigger trig = null
	local unit u = GetFilterUnit()
	if IsUnitEnemy(u,group_temp_player) and GetUnitAbilityLevel(u,'A04R')==0 and GetUnitAbilityLevel(u,'B0BM')>0then//, B0BM -> Echo Stomp
		set trig = CreateTrigger()
		call TriggerRegisterUnitEvent(trig,u,EVENT_UNIT_DAMAGED)
		call TriggerRegisterDeathEvent(trig,u)
		call TriggerRegisterTimerEvent(trig,0.5,true)
		call TriggerRegisterTimerEvent(trig,0,false)
		call TriggerAddCondition(trig,Condition(function F6F))
		call SaveInteger(HY,GetHandleId(trig),0,TempInteger)
		call SaveUnitHandle(HY,GetHandleId(trig),0,u)
		set trig = null
	endif
	set u = null
	return false
endfunction

function Tauren_Stomp_Stun takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)

	set group_temp_player = LoadPlayerHandle(MHT,info,0)
	set TempInteger=LoadInteger(MHT,info,0)
	call GroupEnumUnitsInRange(temp_group,LoadReal(MHT,info,0),LoadReal(MHT,info,1),1000,Condition(function Tauren_Stomp_Stun_Targets))

	call Timer_End(t)
	set t = null
endfunction

function Tauren_Stomp_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()

	if IsUnitEnemy(t,group_temp_player) and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and IsDead(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false then//
		call DamageTarget(GetInvulDamager(group_temp_unit[0]),t,group_temp_integer[0],70+10*GetUnitAbilityLevel(group_temp_unit[1],'A1A9'))//A1A9 -> Great Stomp Effect
		call UnitShareVision(t,group_temp_player,true)
		call IssueTargetOrder(group_temp_unit[1],"thunderbolt",t)
		call UnitShareVision(t,group_temp_player,false)
	endif
	set t = null
	return false
endfunction

function Tauren_Stomp_Spirit_Start takes nothing returns boolean
	local integer info
	local unit d = null
	local unit t = GetFilterUnit()
	local real x
	local real y

	if GetUnitTypeId(t)=='h07U'then//h07U -> Tauren Chieftain
		set info = GetHandleId(t)

		if LoadBoolean(MHT,'A1AA',info)then//A1AA -> Echo Stomp
			set x = GetWidgetX(t)
			set y = GetWidgetY(t)
			set d = CreateUnit(GetOwningPlayer(t),'h07Z',x,y,0)//h07Z -> Great Stomp FX

			call SetUnitTimeScale(d,2.5)
			call UnitApplyTimedLife(d,'BTLF',2)
			
			call GroupEnumUnitsInRange(temp_group2,x,y,525,Condition(function Tauren_Stomp_Targets))

			call SaveBoolean(MHT,'A1AA',info,false)//A1AA -> Echo Stomp
			call SaveBoolean(MHT,info,'A1AA',false)//A1AA -> Echo Stomp
			call SetUnitAnimationByIndex(t,3)

			set d = null
		endif
	endif
	set t = null
	return false
endfunction

function Tauren_Stomp_Effect takes nothing returns nothing
	local timer t= CreateTimer()
	local unit u = GetTriggerUnit()
	local real x = GetWidgetX(u)
	local real y = GetWidgetY(u)
	local unit d = CreateUnit(GetOwningPlayer(u),'h07Z',x,y,0)//h07Z -> Great Stomp FX
	local integer info = GetHandleId(t)

	if GetUnitTypeId(u)=='e00E' then//or GetUnitTypeId(u)=='h07U'then //multicast//e00E -> Spellcaster, h07U -> Tauren Chieftain
		set u = udg_Hero[GetPlayerId(group_temp_player)]
	endif

	call SetUnitTimeScale(d,2.5)
	call UnitApplyTimedLife(d,'BTLF',2)
	set group_temp_player = GetOwningPlayer(u)
	set group_temp_unit[0] = u
	set group_temp_unit[1] = CreateUnit(group_temp_player,'e00E',x,y,0)//e00E -> Spellcaster
	set group_temp_integer[0] = 1
	call UnitAddAbility(group_temp_unit[1],'A1A9')//A1A9 -> Great Stomp Effect
	call GroupEnumUnitsInRange(temp_group,x,y,525,Condition(function Tauren_Stomp_Targets))
	set group_temp_integer[0] = 2
	call GroupEnumUnitsOfPlayer(temp_group,GetOwningPlayer(u),Condition(function Tauren_Stomp_Spirit_Start))
	call SavePlayerHandle(MHT,info,0,group_temp_player)
	call SaveReal(MHT,info,0,x)
	call SaveInteger(MHT,info,0,GetUnitAbilityLevel(u,'A1AA'))//A1AA -> Echo Stomp
	call SaveReal(MHT,info,1,y)
	call SaveUnitHandle(MHT,info,2,u)

	call TimerStart(t,0.65,false,function Tauren_Stomp_Stun)

	set d = null
	set u = null
	set t = null
endfunction

function G4F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit W39=(LoadUnitHandle(HY,h,335))
	local boolean G7F=(LoadBoolean(HY,h,336))

	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
		call SaveInteger(HY,(GetHandleId((Source))),(4269),2)
		call SaveBoolean(HY,(GetHandleId(W39)),337,(true))

		call SaveBoolean(MHT,GetHandleId(W39),'A1AA',false)//A1AA -> Echo Stomp
		call IssueImmediateOrder(W39,"stop")

		if GetUnitAbilityLevel(W39,'Aloc')==0then//Aloc -> Locust
			call SetUnitAnimation(W39,"stand")
		else
			call SetUnitAnimationByIndex(W39,3)
		endif

		if G7F then
			call ShowUnit(W39,false)
			call KillUnit(W39)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if G7F then
			call SetUnitFacing(W39,GetUnitFacing(Source))
		endif
	endif
	set t=null
	set W39=null
	set Source=null
	return false
endfunction

function Tauren_Stomp_Spirit_Effect takes unit u, unit s, boolean b returns nothing
	local trigger t = CreateTrigger()
	local integer info = GetHandleId(t)

	call UnitRemoveAbility(u,'A2LK')//A2LK -> Echo Stomp
	call SetUnitAnimation(u,"spell slam")
	call QueueUnitAnimation(u,"spell slam")

	call SaveUnitHandle(HY,info,335,u)
	call SaveUnitHandle(HY,info,2,s)

	if b then
		call SaveBoolean(HY,info,336,true)
		call TriggerRegisterTimerEvent(t,.1,true)
	endif

	call TriggerRegisterUnitEvent(t,s,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function G4F))

	set info = GetHandleId(u)
	call SaveBoolean(MHT,'A1AA',info,true) //prevents the spirit from stomping more than once//A1AA -> Echo Stomp
	call SaveBoolean(MHT,info,'A1AA',true) //stops movement while returning//A1AA -> Echo Stomp

	set t = null
endfunction

function Tauren_Stomp_Spirit takes nothing returns boolean
	local unit t = GetFilterUnit()

	if GetUnitTypeId(t)=='h07U'then//h07U -> Tauren Chieftain
		if IssueImmediateOrderById(t,851972)then
			call Tauren_Stomp_Spirit_Effect(t,group_temp_unit[0],false)
		endif
		call SaveBoolean(MHT,99999,99997,false)
	endif
	set t = null
	return false
endfunction

function Tauren_Stomp_Check takes nothing returns nothing
	local unit Source = GetTriggerUnit()
	local unit W39 = null

	if GetUnitTypeId(Source)=='e00E'then //multicast//e00E -> Spellcaster
		set group_temp_unit[0] = udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
	elseif  GetUnitTypeId(Source)=='h07U' then //spirit cast//h07U -> Tauren Chieftain
		set group_temp_unit[0] = LoadUnitHandle(MHT,GetHandleId(Source),'A1A8')//A1A8 -> Ancestral Spirit
		if IssueImmediateOrderById(group_temp_unit[0],852092)==false then
			call UnitAddAbility(Source,'A2LK')//A2LK -> Echo Stomp
			call SetUnitAnimation(Source,"stand")
			call IssueImmediateOrder(Source,"stop")
			call SaveBoolean(MHT,GetHandleId(Source),'A1AA',false)//A1AA -> Echo Stomp
			call SaveBoolean(MHT,'A1AA',GetHandleId(Source),false)//A1AA -> Echo Stomp

			set Source = null
			return
		endif
	else
		set group_temp_unit[0] = Source
	endif

	call SaveBoolean(MHT,99999,99997,true)
	call GroupEnumUnitsOfPlayer(temp_group,GetOwningPlayer(Source),Condition(function Tauren_Stomp_Spirit))

	if LoadBoolean(MHT,99999,99997)then
		set W39=CreateUnit(GetOwningPlayer(Source),'h07U',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))//h07U -> Tauren Chieftain
		call UnitAddAbility2(W39,'Aloc')//Aloc -> Locust
		call UnitAddAbility2(W39,'Aetl')//Aetl -> Ethereal
		call SetUnitPosition(W39,GetUnitX(Source),GetUnitY(Source))
		call SetUnitScale(W39,1.4,1.4,1.4)
		call IssueImmediateOrderById(W39,851972)
		call Tauren_Stomp_Spirit_Effect(W39,group_temp_unit[0],true)
		set W39=null
	endif

	set Source=null
endfunction






function GDF takes nothing returns nothing
	if IsUnitBADWithSpellbooks(GetEnumUnit())then
		return
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A1CA')>0 then//A1CA -> Natural Order 1
		call UnitRemoveAbility(GetEnumUnit(),'A1CA')//A1CA -> Natural Order 1
		call UnitRemoveAbility(GetEnumUnit(),'B0BP')//B0BP -> Natural Order
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A1C9')>0 then//A1C9 -> Natural Order 2
		call UnitRemoveAbility(GetEnumUnit(),'A1C9')//A1C9 -> Natural Order 2
		call UnitRemoveAbility(GetEnumUnit(),'B0BP')//B0BP -> Natural Order
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A1CB')>0 then//A1CB -> Natural Order 3
		call UnitRemoveAbility(GetEnumUnit(),'A1CB')//A1CB -> Natural Order 3
		call UnitRemoveAbility(GetEnumUnit(),'B0BP')//B0BP -> Natural Order
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A1CC')>0 then//A1CC -> Natural Order 4
		call UnitRemoveAbility(GetEnumUnit(),'A1CC')//A1CC -> Natural Order 4
		call UnitRemoveAbility(GetEnumUnit(),'B0BP')//B0BP -> Natural Order
	endif
	call SetNegativeArmorSystem(GetEnumUnit(),0)
endfunction

function GEF takes nothing returns nothing
	if IsUnitBADWithSpellbooks(GetEnumUnit())then
		return
	endif
	if GF8==1 then
		if GetUnitAbilityLevel(GetEnumUnit(),'A1CA')==0 then//A1CA -> Natural Order 1
			call UnitAddAbility2(GetEnumUnit(),'A1CA')//A1CA -> Natural Order 1
		endif
	elseif GF8==2 then
		if GetUnitAbilityLevel(GetEnumUnit(),'A1C9')==0 then//A1C9 -> Natural Order 2
			call UnitAddAbility2(GetEnumUnit(),'A1C9')//A1C9 -> Natural Order 2
		endif
	elseif GF8==3 then
		if GetUnitAbilityLevel(GetEnumUnit(),'A1CB')==0 then//A1CB -> Natural Order 3
			call UnitAddAbility2(GetEnumUnit(),'A1CB')//A1CB -> Natural Order 3
		endif
	elseif GF8==4 then
		if GetUnitAbilityLevel(GetEnumUnit(),'A1CC')==0 then//A1CC -> Natural Order 4
			call UnitAddAbility2(GetEnumUnit(),'A1CC')//A1CC -> Natural Order 4
		endif
	endif
	if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
		call SetNegativeArmorSystem(GetEnumUnit(),R2I((I2R(GetHeroAgi(GetEnumUnit(),true))/ 7)*I2R((GF8*20+20)/100)))
	endif
endfunction

function GFF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local group GGF=LoadGroupHandle(HY,h,340)
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local group g=GetAvailableGroup()
	local group g2
	local unit u = LoadUnitHandle(MHT,GetHandleId(Source),'A1A8')//A1A8 -> Ancestral Spirit
	if Source==null then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillGroup(GGF)
		call KillGroup(g)
		set g=null
		return false
	endif
	set tt_unit1=Source
	set GF8=GetUnitAbilityLevel(Source,'A1CD')//A1CD -> Natural Order, QP1I -> Natural Order
	call GroupEnumUnitsInRange(g,x,y,300,Condition(function DefaultEnemyFilterWithAncients))
	if u!=null then
		set g2=GetAvailableGroup()
		call GroupEnumUnitsInRange(g2,GetWidgetX(u),GetWidgetY(u),350,Condition(function DefaultEnemyFilterWithAncients))
		call GroupAddGroup(g2,g)
		call KillGroup(g2)
		set g2=null
	endif
	call GroupRemoveGroup(g,GGF)
	call ForGroup(GGF,function GDF)
	if IsDead(Source)==false and GetUnitAbilityLevel(Source,'A36D')==0 then
		call ForGroup(g,function GEF)
	endif
	call SaveGroupHandle(HY,h,340,g)
	call KillGroup(GGF)
	set t=null
	set Source=null
	set GGF=null
	set u = null
	set g=null
	return false
endfunction

function Chieftain_NaturalOrder_Learning takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call UnitAddAbility2(Source,'A1CQ')//A1CQ -> Natural Order Aura Art
	call TriggerRegisterTimerEvent(t,.3,true)
	call TriggerAddCondition(t,Condition(function GFF))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveGroupHandle(HY,h,340,GetAvailableGroup())
	call SaveTriggerHandle(HY,GetHandleId(Source),338,t)
	call SaveBoolean(HY,GetHandleId(Source),339,true)
	set t=null
	set Source=null
endfunction

function GJF takes nothing returns nothing
	local real x1=GI8
	local real y1=GJ8
	local real x2=GK8
	local real y2=GM8
	local real x3=GetUnitX(GetEnumUnit())
	local real y3=GetUnitY(GetEnumUnit())
	local real u=((x3-x1)*(x2-x1)+(y3-y1)*(y2-y1))/((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))
	local real x4=x1+u*(x2-x1)
	local real y4=y1+u*(y2-y1)
	local real XYE=GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)*.35/ 2
	if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
		call SetUnitPosition(GetEnumUnit(),x4,y4)
	else
		call SetUnitX(GetEnumUnit(),x4)
		call SetUnitY(GetEnumUnit(),y4)
	endif
	call IssueTargetOrderNoLinken(GG8,852095,GetEnumUnit())
	call DamageTarget(GH8,GetEnumUnit(),1,XYE)
	call DamageTarget(GH8,GetEnumUnit(),2,XYE)
	if TC_es_lvl>0 and IsDead(GetEnumUnit())==false then
		call UnitAddAbilityTimedExF(GetEnumUnit(),'A43L',1,TC_es_lvl+3.,0)
		call UnitAddAbilityTimedExF(GetEnumUnit(),'A44E',1,TC_es_lvl+3.,0)
	endif
endfunction

function GKF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real x0=LoadReal(HY,h,282)
	local real y0=LoadReal(HY,h,283)
	local real a0=LoadReal(HY,h,341)
	local integer i=0
	local real x
	local real y
	local group g=GetAvailableGroup()
	local group AlreadyHit=GetAvailableGroup()
	local integer Level=LoadInteger(HY,h,0)
	local boolean agh=LoadBoolean(HY,h,2)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set tt_unit1=Source
	set GH8=Source
	set GG8=CreateUnit(GetOwningPlayer(Source),'e00E',x0,y0,0)//e00E -> Spellcaster
	call UnitAddAbility2(GG8,'A43M')
	call SetUnitAbilityLevel(GG8,'A43M',Level)
	
	if agh then
		set TC_es_lvl=Level
	else
		set TC_es_lvl=0
	endif
	loop
		exitwhen i>11
		set x=x0+i*200*Cos(a0)
		set y=y0+i*200*Sin(a0)
		call ZD8("Abilities\\Spells\\Orc\\EarthQuake\\EarthQuakeTarget.mdl",x,y,1.6)
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",x,y-250))
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",x,y))
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",x+250,y))
		call KillTrees(x,y,300)
		call GroupEnumUnitsInRange(g,x,y,325,Condition(function DefaultEnemyFilterWithAncients))
		call GroupAddGroup(g,AlreadyHit)
		call GroupClear(g)
		set i=i+1
	endloop
	set GI8=x0
	set GJ8=y0
	set GK8=x
	set GM8=y
	call ForGroup(AlreadyHit,function GJF)
	call KillGroup(AlreadyHit)
	call KillGroup(g)
	set t=null
	set Source=null
	set g=null
	set AlreadyHit=null
	return false
endfunction

function GMF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real a=LoadReal(HY,h,137)
	local real x0=LoadReal(HY,h,282)
	local real y0=LoadReal(HY,h,283)
	local real a0
	local real GNF
	local real GOF
	local real GPF
	local real GQF
	local real GRF
	local real GSF
	local real GTF
	local real GUF
	local real GVF
	local real GWF
	local real GXF
	local real GYF
	local real x
	local real y
	local integer lvl
	local ubersplat Splat
	local integer Count=GetTriggerEvalCount(t)
	local boolean agh=LoadBoolean(HY,h,2)
	set x=x0+200*Count*Cos(a)
	set y=y0+200*Count*Sin(a)
	set Splat=CreateUbersplat(x,y,"THNE",255,255,255,255,false,false)
	call SetUbersplatRenderAlways(Splat,true)
	set GNF=x+250*Cos(bj_DEGTORAD*(a*bj_RADTODEG-45))
	set GOF=y+250*Sin(bj_DEGTORAD*(a*bj_RADTODEG-45))
	set GPF=x+250*Cos(bj_DEGTORAD*(a*bj_RADTODEG+45))
	set GQF=y+250*Sin(bj_DEGTORAD*(a*bj_RADTODEG+45))
	set GRF=x-125*Cos(bj_DEGTORAD*(a*bj_RADTODEG-45))
	set GSF=y-125*Sin(bj_DEGTORAD*(a*bj_RADTODEG-45))
	set GTF=x-125*Cos(bj_DEGTORAD*(a*bj_RADTODEG+45))
	set GUF=y-125*Sin(bj_DEGTORAD*(a*bj_RADTODEG+45))
	set GVF=x
	set GWF=y
	set GXF=x
	set GYF=y
	call TimedReveal(GetOwningPlayer(Source),4,x,y,500)
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GNF,GOF))
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GPF,GQF))
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GRF,GSF))
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GTF,GUF))
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GVF,GWF))
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GXF,GYF))
	if GetTriggerEvalCount(t)>11 then
		set x0=LoadReal(HY,h,282)
		set y0=LoadReal(HY,h,283)
		set a0=LoadReal(HY,h,341)
		set lvl=LoadInteger(HY,h,0)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,.5,false)
		call TriggerAddCondition(t,Condition(function GKF))
		call SaveUnitHandle(HY,h,2,Source)
		call SaveBoolean(HY,h,2,agh)
		call SaveInteger(HY,h,0,lvl)
		call SaveReal(HY,h,282,x0*1.)
		call SaveReal(HY,h,283,y0*1.)
		call SaveReal(HY,h,341,a0*1.)
	endif
	set t=null
	set Source=null
	set Splat=null
	return false
endfunction

function Chieftain_SplitEarth takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
	local boolean b=GetSpellAbilityId()=='A43J'//A43J -> Earth Splitter
	if b then
		call TriggerRegisterTimerEvent(t,.08,true)
	else
		call TriggerRegisterTimerEvent(t,.22,true)
	endif
	call TriggerAddCondition(t,Condition(function GMF))
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call SaveBoolean(HY,h,2,b)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,6,GetUnitX(Source)*1.)
	call SaveReal(HY,h,7,GetUnitY(Source)*1.)
	call SaveReal(HY,h,137,a*1.)
	call SaveReal(HY,h,282,GetUnitX(Source)*1.)
	call SaveReal(HY,h,283,GetUnitY(Source)*1.)
	call SaveReal(HY,h,341,a*1.)
	set t=null
	set Source=null
endfunction

function Tauren_Spirit_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local unit u = LoadUnitHandle(MHT,info,0)

	call LoDStat_Sub(u,LoadInteger(MHT,info,3),"damage")
	call SubBonusMSPercent(u,R2I(LoadReal(MHT,info,0)))
	
	call Timer_End(t)
	set t = null
	set u = null
endfunction

function Tauren_Spirit_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local group g = LoadGroupHandle(MHT,group_temp_integer[0],2)

	if IsDead(t)==false and IsUnitEnemy(group_temp_unit[0],GetOwningPlayer(t)) and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitInGroup(t,g)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false then//
		if IsUnitType(t,UNIT_TYPE_HERO)then
			call SaveInteger(MHT,group_temp_integer[0],4,LoadInteger(MHT,group_temp_integer[0],4) + 1)
		else
			call SaveInteger(MHT,group_temp_integer[0],3,LoadInteger(MHT,group_temp_integer[0],3) + 1)
		endif

		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",t,"chest"))
		call DamageTarget(group_temp_unit[0],t,1,group_temp_integer[1])
		call GroupAddUnit(g,t)
	endif
	set g = null
	set t = null
	return false
endfunction

function Tauren_Spirit_Return takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer i3
	local integer i2
	local integer i1
	local unit u = LoadUnitHandle(MHT,info,0)
	local unit d = LoadUnitHandle(MHT,info,1)
	local real x2 = GetWidgetX(u)
	local real y2 = GetWidgetY(u)
	local real x1 = GetWidgetX(d)
	local real y1 = GetWidgetY(d)
	local real angle = Atan2(y2-y1,x2-x1)
	if LoadBoolean(MHT,GetHandleId(d),'A1AA') then//A1AA -> Echo Stomp
		set d = null
		set u = null
		set t = null
		return
	endif

	set x1 = x1 + 15*Cos(angle)
	set y1 = y1 + 15*Sin(angle)

	call SetUnitX(d,x1)
	call SetUnitY(d,y1)
	call SetUnitFacing(d,angle*bj_RADTODEG)

	set group_temp_unit[0] = u
	set group_temp_integer[0] = info
	set group_temp_integer[1] = LoadInteger(MHT,info,2)

	call GroupEnumUnitsInRange(temp_group,x1,y1,300,Condition(function Tauren_Spirit_Targets))

	if 100 > SquareRoot((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2)) then
		set i3 = LoadInteger(MHT,info,1)
		set i2 = LoadInteger(MHT,info,3)
		set i1 = LoadInteger(MHT,info,4)

		if i1 + i2 > 0 then
			set x1 = (i2 + i1*5)//100.
			set i3 = i2*(3*i3+3) + i1*10*i3

			call Buff_Add(u,'C015','C015',9)

			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",u,"chest"))
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",u,"origin"))
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",u,"hand,left"))
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",u,"hand,right"))

			call SaveInteger(MHT,info,3,i3)
			call SaveReal(MHT,info,0,x1)

			call AddBonusMSPercent(u,R2I(x1))
			call LoDStat_Add(u,i3,"damage")

			call TimerStart(t,9,false,function Tauren_Spirit_End)
		else
			call Timer_End(t)
		endif

		set info = GetHandleId(u)
		set i1 = LoadInteger(MHT,info,'A1A8')//A1A8 -> Ancestral Spirit

		call SaveInteger(MHT,info,'A1A8',i1 - 1)//A1A8 -> Ancestral Spirit

		if i1==1then
			call UnitRemoveAbility(u,'A21J')//A21J -> Ancestral Spirit
			call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A1A8',true)//A1A8 -> Ancestral Spirit
		endif

		call FlushChildHashtable(MHT,GetHandleId(d))
		call RemoveUnit(d)
	endif

	set d = null
	set u = null
	set t = null
endfunction

function Tauren_Spirit_Duration takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local unit u = LoadUnitHandle(MHT,info,0)
	local unit d = LoadUnitHandle(MHT,info,1)
	local real x = GetWidgetX(d)
	local real y = GetWidgetY(d)

	set group_temp_unit[0] = u
	set group_temp_integer[0] = info
	set group_temp_integer[1] = LoadInteger(MHT,info,2)

	call GroupEnumUnitsInRange(temp_group,x,y,300,Condition(function Tauren_Spirit_Targets))

	if count==80 or LoadBoolean(MHT,GetHandleId(u),'A1A8') or LoadBoolean(MHT,GetHandleId(d),'A1A8')then//A1A8 -> Ancestral Spirit, A1A8 -> Ancestral Spirit
		call UnitAddAbility(d,'Aloc')//Aloc -> Locust
		call SetUnitAnimationByIndex(d,1)
		call IssueImmediateOrder(d,"stop")
		call SaveBoolean(MHT,info,0,true)

		call TimerStart(t,0.025,true,function Tauren_Spirit_Return)

		set d = null
		set u = null
		set t = null
		return
	endif

	call SetUnitMoveSpeed(d,GetUnitMoveSpeedLOD(u))
	call SaveInteger(MHT,info,0,count+1)

	set d = null
	set u = null
	set t = null
endfunction

function Tauren_Spirit_Reset takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)

	call UnitRemoveAbility(u,'A21J')//A21J -> Ancestral Spirit
	call UnitAddAbility2(u,'A21J')//A21J -> Ancestral Spirit

	call Timer_End(t)
	set t = null
	set u = null
endfunction

function Tauren_Spirit_Stop takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()

	call SaveUnitHandle(MHT,GetHandleId(t),0,u)
	call SaveBoolean(MHT,GetHandleId(u),'A1A8',true)//A1A8 -> Ancestral Spirit

	call TimerStart(t,0,false,function Tauren_Spirit_Reset)

	set t = null
	set u = null
endfunction

function Tauren_Spirit_Start takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local player p = GetOwningPlayer(u)
	local unit d = CreateUnit(p,'h07U',GetSpellTargetX(),GetSpellTargetY(),GetUnitFacing(u)-180)//h07U -> Tauren Chieftain
	local integer info = GetHandleId(t)
	local integer level = GetUnitAbilityLevel(u,'A1A8')//A1A8 -> Ancestral Spirit
	local integer id
	call UnitAddAbility(d,'Aloc')
	call UnitRemoveAbility(d,'Aloc')
	call ShowUnit(d,false)
	call ShowUnit(d,true)
	call SaveBoolean(MHT,info,0,false)
	call SaveUnitHandle(MHT,info,0,u)
	call SaveUnitHandle(MHT,info,1,d)
	call SaveGroupHandle(MHT,info,2,GetAvailableGroup())
	call SaveInteger(MHT,info,0,0)
	call SaveInteger(MHT,info,1,level)
	call SaveInteger(MHT,info,2,20 + 40*level)
	call SaveInteger(MHT,info,3,0)
	call SaveInteger(MHT,info,4,0)
	set info = GetHandleId(u)
	call SaveBoolean(MHT,info,'A1A8',false)//A1A8 -> Ancestral Spirit
	call SaveInteger(MHT,info,'A1A8',LoadInteger(MHT,info,'A1A8') + 1)//A1A8 -> Ancestral Spirit, A1A8 -> Ancestral Spirit
	call SaveUnitHandle(MHT,info,'A1A8',d)//A1A8 -> Ancestral Spirit
	call SetPlayerAbilityAvailable2(p,'A1A8',false)//A1A8 -> Ancestral Spirit
	call UnitAddAbility(u,'A21J')//A21J -> Ancestral Spirit
	call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_SPELL_CAST)
	call UnitAddAbility(d,'A21J')//A21J -> Ancestral Spirit
	call UnitAddAbility(d,'Aetl')//Aetl -> Ethereal
	if GetUnitAbilityLevel(u,'A1AA')>0then//A1AA -> Echo Stomp
		call UnitAddAbility(d,'A2LK')//A2LK -> Echo Stomp
	endif
	if GetUnitAbilityLevel(u,'A1CD')>0 then//A1CD -> Natural Order, QP1I -> Natural Order
		call UnitAddAbility2(d,'A1CQ')//A1CQ -> Natural Order Aura Art
	endif
	call SaveUnitHandle(MHT,GetHandleId(d),'A1A8',u)//A1A8 -> Ancestral Spirit
	call TimerStart(t,0.1,true,function Tauren_Spirit_Duration)
	set d = null
	set u = null
	set t = null
	set p=null
endfunction


function HXF takes nothing returns nothing
	local unit Target=GetOrderTargetUnit()
	local real x
	local real y
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER then
		set x=GetUnitX(GetOrderTargetUnit())
		set y=GetUnitY(GetOrderTargetUnit())
	else
		set x=GetOrderPointX()
		set y=GetOrderPointY()
	endif
	if DistanceBetweenXY(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),x,y)<700 then
		call PlaySoundAtPos(FE,x,y)
	endif
	set Target=null
endfunction

function HYF takes nothing returns boolean
	if GetIssuedOrderId()==852040 then
		call HXF()
	endif
	return false
endfunction

function Techies_SuicideSquad_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterPlayerUnitEvent(t,GetOwningPlayer(GetTriggerUnit()),EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,GetOwningPlayer(GetTriggerUnit()),EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function HYF))
	set t=null
endfunction

function TechiesSuicideFilter takes nothing returns boolean
	return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and (GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0) and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false//
endfunction

function TechiesSuicide takes unit tech returns nothing
	local integer lvl=GetUnitAbilityLevel(tech,'A06B')+GetUnitAbilityLevel(tech,'A471')//A06B -> Suicide Squad, Attack!
	local real primDmg
	local real secDmg
	local group g=GetAvailableGroup()
	local unit u
	local unit d=GetInvulDamager(tech)
	if lvl==1 then
		set primDmg=500
		set secDmg=260
	elseif lvl==2 then
		set primDmg=650
		set secDmg=300
	elseif lvl==3 then
		set primDmg=850
		set secDmg=340
	elseif lvl==4 then
		set primDmg=1150
		set secDmg=380
	endif
	set tt_unit1=tech
	call GroupEnumUnitsInRange(g,GetUnitX(tech),GetUnitY(tech),525,Condition(function TechiesSuicideFilter))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if DistanceBetweenUnits(tech,u)>200 then
			call DamageTargetDelayed(d,u,2,secDmg,0)
		else
			call DamageTargetDelayed(d,u,2,primDmg,0)
		endif
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
	call SaveBoolean(HY,GetHandleId(tech),'suic',true)
	call AddTimedKeyToUnit(tech,'A06B',0.1)
	set d=null
endfunction

function TechiesSuicideWrapper takes nothing returns nothing
	call TechiesSuicide(GetTriggerUnit())
endfunction

function TechiesSuicideAghOnDeath takes nothing returns nothing
	call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",GetUnitX(tt_unit1),GetUnitY(tt_unit1)))
	call TechiesSuicide(tt_unit1)
	
endfunction

function HCF takes nothing returns nothing
	call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"Type -show to toggle the Focused Detonate sub-spell for Remote Mines")
	if(GetUnitAbilityLevel(GetTriggerUnit(),'A0AK')==1 or GetUnitAbilityLevel(GetTriggerUnit(),'A1FY')==1)then//A0AK -> Remote Mines, A1FY -> Remote Mines
		call UnitAddAbility2(GetTriggerUnit(),'A1WF')//A1WF -> Focused Detonate
	endif
endfunction

function RemoteMineFilter takes nothing returns boolean
	return IsUnitEnemy(GetFilterUnit(),LoadPlayerHandle(TempHash,'A0AM',1)) and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0//A0AM -> Detonate, 
endfunction

function RemoteMineDamage takes nothing returns nothing
	call DamageTarget(LoadUnitHandle(TempHash,'A0AM',0),GetEnumUnit(),1,LoadReal(TempHash,'A0AM',0))//A0AM -> Detonate, A0AM -> Detonate
endfunction

function RemoteMineBlast takes unit u, boolean selfdetonation returns nothing
	local real dmg=0.
	local integer uid=GetUnitTypeId(u)
	local group g
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	if uid=='o018' then//o018 -> Remote Mine 1
		set dmg=300.
	elseif uid=='o002'then//o002 -> Remote Mine 2
		set dmg=450.
	elseif uid=='o00B'then//o00B -> Remote Mine 3
		set dmg=600.
	elseif uid=='o01B' then//o01B -> Remote Mine 4
		set dmg=750.
	endif
	set g=GetAvailableGroup()
	call SaveUnitHandle(TempHash,'A0AM',0,u)//A0AM -> Detonate
	call SavePlayerHandle(TempHash,'A0AM',1,GetOwningPlayer(u))//A0AM -> Detonate
	call GroupEnumUnitsInRange(g,x,y,450,Condition(function RemoteMineFilter))
	call ZD8("Abilities\\Spells\\Human\\FlameStrike\\FlameStrike1.mdl",x,y,5)
	call TimedReveal(GetOwningPlayer(u),3,x,y,500)
	call SaveReal(TempHash,'A0AM',0,dmg)//A0AM -> Detonate
	set IsRemoteMinesBlast=selfdetonation==false
	call ForGroup(g,function RemoteMineDamage)
	set IsRemoteMinesBlast=false
	call FlushChildHashtable(TempHash,'A0AM')//A0AM -> Detonate
	call RemoveUnit(u)
	call KillGroup(g)
	set g=null
endfunction

function RemoteMineDeath takes unit mine returns nothing
	if IsRemoteMine(mine) then
		//call RemoteMineBlast(mine,true)
	endif
endfunction

function RemoteMineActivation takes nothing returns nothing
	call RemoteMineBlast(GetTriggerUnit(),false)
endfunction

function RemoteMineFocusedFilter takes nothing returns boolean
	return GetOwningPlayer(GetFilterUnit())==LoadPlayerHandle(TempHash,'A0AN',0) and IsDead(GetFilterUnit())==false and IsRemoteMine(GetFilterUnit())
endfunction

function RemoteMineFocusedForGroup takes nothing returns nothing
	call IssueImmediateOrderById(GetEnumUnit(),852556)
endfunction

function RemoteMineFocused takes nothing returns nothing
	local group g=GetAvailableGroup()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	call SavePlayerHandle(TempHash,'A0AN',0,GetOwningPlayer(GetTriggerUnit()))
	call GroupEnumUnitsInRange(g,x,y,716,Condition(function RemoteMineFocusedFilter))
	call ForGroup(g,function RemoteMineFocusedForGroup)
	call FlushChildHashtable(TempHash,'A0AN')
	call KillGroup(g)
	set g=null
endfunction

function RemoteMineIncoming takes nothing returns nothing
	if IsRemoteMine(GetSummonedUnit()) then
		call TriggerRegisterUnitEvent(GAME_TRIGGER,GetSummonedUnit(),EVENT_UNIT_SPELL_CAST)
	endif
endfunction

function NF9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function RemoteMineIncoming))
	call CS8("Units\\Creeps\\GoblinSapper\\GoblinSapperYesAttack1.wav")
	set t=null
endfunction

function Func2472 takes nothing returns boolean
	return IsTechiesLandMine(GetTriggerUnit())
endfunction

function LandMineFilter takes nothing returns boolean
	return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and (GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 or IsBasicCourier(GetFilterUnit())) and IsFlyingUnit(GetFilterUnit())==false and IsUnitInvulnerable(GetFilterUnit())==false
endfunction

function LandMineFilterPeriodic takes nothing returns boolean
	return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and (GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 or IsBasicCourier(GetFilterUnit())) and IsFlyingUnit(GetFilterUnit())==false and IsUnitInvulnerable(GetFilterUnit())==false
endfunction

function LandMineBlast takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit mine=LoadUnitHandle(HY,h,0)
	local group g=GetAvailableGroup()
	local unit u
	local real dmg
	local integer id=GetUnitTypeId(mine)
	local unit d=CreateUnit(GetOwningPlayer(mine),'e00E',GetUnitX(mine),GetUnitY(mine),0)//e00E -> Spellcaster
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	call DestroyEffect(AddSpecialEffect("war3mapImported\\NewGroundEX.mdx",GetUnitX(mine),GetUnitY(mine)))
	call KillUnit(mine)
	if id=='n00O'then//n00O -> Goblin Land Mine
		set dmg=300
	elseif id=='n00P'then//n00P -> Goblin Land Mine
		set dmg=400
	elseif id=='n00Q'then//n00Q -> Goblin Land Mine
		set dmg=500
	elseif id=='n00N'then//n00N -> Goblin Land Mine
		set dmg=600
	endif
	set tt_unit1=mine
	call GroupEnumUnitsInRange(g,GetUnitX(mine),GetUnitY(mine),525,Condition(function LandMineFilter))
//	//call echo(GetUnitName(mine)+" "+R2S(dmg))
	set isMineDamage=isMineDamage+1
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if DistanceBetweenUnits(d,u)<225 then
			call DamageTarget(d,u,2,dmg)
		else
			call DamageTarget(d,u,2,dmg/2)
		endif
		call GroupRemoveUnit(g,u)
	endloop
	set isMineDamage=isMineDamage-1
	call KillGroup(g)
	set d=null
endfunction

function LandMineBlastPre takes unit u, real delay returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,u)
	call TimerStart(t,delay,false,function LandMineBlast)
	set t=null
endfunction

function Func2475 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,h,347))
	local group g
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		if GetHandleId(GetKillingUnit())==0 then
			call LandMineBlastPre(u,0.3)
		else
			call SetUnitAnimationByIndex(GetTriggerUnit(),4)
		endif
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		if LoadBoolean(HY,h,0)==false then
			if LoadInteger(HY,h,0)==0 then
				call SaveInteger(HY,h,0,1)
				call TriggerRegisterUnitInRange(t,u,225,Condition(function ReturnTrue))
			else
				set g=GetAvailableGroup()
				set tt_unit1=u
				call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),225,Condition(function LandMineFilterPeriodic))
				if FirstOfGroup(g)!=null then
					call TriggerRegisterTimerEvent(t,0.3,false)
					call SaveBoolean(HY,h,0,true)
				endif
				call KillGroup(g)
			endif
		else
//			if LoadInteger(HY,h,1)==0 then
//				call SaveInteger(HY,h,1,1)
//			else
				call LandMineBlastPre(u,0.3)
				call FlushChildHashtable(HY,(h))
				call CleanTrigger(t)
//			endif
		endif
	else
		if IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(u)) and (GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 or IsBasicCourier(GetTriggerUnit())) and IsFlyingUnit(GetTriggerUnit())==false and IsUnitInvulnerable(GetTriggerUnit())==false then
			call TriggerRegisterTimerEvent(t,0.3,false)
			call SaveBoolean(HY,h,0,true)
		endif
	endif
	set t=null
	set u=null
	set g=null
	return false
endfunction

function Func2476 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,0.5,true)
	call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function Func2475))
	call SaveUnitHandle(HY,GetHandleId(t),347,GetTriggerUnit())
	set t=null
endfunction

function StasisTrapWrapper takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u
	local unit trap=LoadUnitHandle(HY,h,0)
	local group g
	local unit d
	//call echo(I2S(GetTriggerEvalCount(t))+" : "+I2S(GetHandleId(GetTriggerEventId())))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		if GetKillingUnit()!=null then
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		else
			call TriggerRegisterTimerEvent(t,0,false)
		endif
	elseif GetTriggerEvalCount(t)==1 then
		call TriggerRegisterUnitInRange(t,trap,450,Condition(function ReturnTrue))
	elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		call DisableTrigger(t)
		call KillUnit(trap)
		call SetUnitAnimationByIndex(trap,3)
		set g=GetAvailableGroup()
		set tt_unit1=trap
		call GroupEnumUnitsInRange(g,GetUnitX(trap),GetUnitY(trap),450+25,Condition(function DefaultEnemyFilterWithAncients))
		
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			set d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
			call UnitAddAbility(d,'A38L')
			call SetUnitAbilityLevel(d,'A38L',LoadInteger(HY,h,0))
			
			call IssueTargetOrder(d,"thunderbolt",u)
			call GroupRemoveUnit(g,u)
		endloop
		set d=null
		call UnitRemoveAbility(d,'A38L')
		call KillGroup(g)
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	else
		set u=GetTriggerUnit()
		if IsUnitEnemy(u,GetOwningPlayer(trap)) and IsMagicImmune(u)==false and GetUnitAbilityLevel(u,'A04R')==0 then//
			if IsUnitAlly(trap,GetLocalPlayer()) or IsObserver(GetLocalPlayer()) then
				call SetUnitAnimationByIndex(trap,5)
			endif
			call TriggerRegisterTimerEvent(t,1.5,false)
		endif
	endif
	set t=null
	return false
endfunction

function StasisTrapEnters takes nothing returns boolean
	local unit u
	local trigger t
	local integer h
	if GetUnitTypeId(GetTriggerUnit())=='otot' then//otot -> Stasis Trap
		set t=CreateTrigger()
		set h=GetHandleId(t)
		set u=GetTriggerUnit()
		call SaveUnitHandle(HY,h,0,u)
		call SaveInteger(HY,h,0,GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A06H'))//A06H -> Stasis Trap
		call TriggerRegisterTimerEvent(t,1.5,false)
		call TriggerRegisterDeathEvent(t,u)
		call TriggerAddCondition(t,Condition(function StasisTrapWrapper))
		set t=null
		set u=null
	endif
	return false
endfunction

function NG9 takes nothing returns nothing
	local trigger t=CreateTrigger()
//	call TriggerRegisterPlayersChat(t,"-stats",true)
//	call TriggerRegisterPlayersChat(t,"-st",true)
//	call TriggerAddCondition(t,Condition(function IFF))
//	set t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddCondition(t,Condition(function Func2472))
	call TriggerAddAction(t,function Func2476)
	set t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddCondition(t,Condition(function StasisTrapEnters))
	set t=null
endfunction


function Rearm_Effect takes nothing returns nothing
	local unit u = GetTriggerUnit()
	call RefreshWithBalance(u,true)
	call Passive_Cooldown(u,'A065',GetUnitAbilityLevel(u,'A065'))//A065 -> Rearm, A065 -> Rearm
	call RemoveAbilsForUnit(u)
	set u = null
endfunction

function Tinker_Rearm_DummySpell_Mana takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+50+100*GetUnitAbilityLevel(u,'A528'))//A528 -> |cffffcc00R|rearm - [|cffffcc00Level 1|r]","|cffffcc00R|rearm - [|cffffcc00Level 2|r]","|cffffcc00R|rearm - [|cffffcc00Level 3|r]
	set u=null
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTimer(t)
	set t=null
endfunction

function Tinker_Rearm_DummySpell takes nothing returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0,false,function Tinker_Rearm_DummySpell_Mana)
	call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
	set t=null
endfunction

function Tinker_MarchOfMachines_OnCast takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit u=CreateUnit(GetOwningPlayer(caster),'n03C',GetUnitX(caster),GetUnitY(caster),0)//n03C -> Too many lives
	call UnitAddAbility(u,'A416')
	if IssuePointOrderById(u,852593,GetSpellTargetX(),GetSpellTargetY())==false then
		call InterruptUnit(caster)
		call Error(GetOwningPlayer(caster),"Cannot cast March of Machines here")
	endif
	call KillUnit(u)
	set caster=null
	set u=null
endfunction

function MarchOfMachines takes unit attacker, unit target returns nothing
	if GetUnitAbilityLevel(attacker,'A05F')>0 then
		if (IsMagicImmune(target)==false) then
			call DamageTarget(udg_Hero[GetPlayerId(GetOwningPlayer(attacker))],target,1,GetUnitAbilityLevel(attacker,'A05F')*8+8)
		else
			call DamageTarget(udg_Hero[GetPlayerId(GetOwningPlayer(attacker))],target,7,0)
		endif
	endif
endfunction

function Tinker_MarchOfMachinesOld takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local integer i=0
	local real a=0
	local real r=0
	local integer Level=GetUnitAbilityLevel(Hero,'A0BQ')//A0BQ -> March of the Machines
	call DummyDamageTracking(10)
	call UnitAddAbility(Caster,'A05F')//A05F -> March of the Machines effect
	call SetUnitAbilityLevel(Caster,'A05F',Level)//A05F -> March of the Machines effect
	if IssuePointOrderById(Caster,852593,x,y) then
	endif
	set Hero=null
	set Caster=null
endfunction

function Tinker_MarchOfMachines takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real angle=AngleBetweenXY(GetUnitX(caster),GetUnitY(caster),x,y)
	local unit dummy=CreateUnit(GetOwningPlayer(caster),'e00E',x,y,0)//e00E -> Spellcaster
	local integer i=0
	local real a=0
	local real k=0
	local boolean b=false
	local boolean exit=false
	call DummyDamageTracking(10)
	call UnitAddAbility(dummy,'A05F')
	call SetUnitAbilityLevel(dummy,'A05F',GetUnitAbilityLevel(caster,'A0BQ'))
	set x=x+10*Cos(bj_DEGTORAD*angle)
	set y=y+10*Sin(bj_DEGTORAD*angle)
	
	loop
		set b=IsTerrainPathable(x+k*Cos(a),y+k*Sin(a),PATHING_TYPE_WALKABILITY)==false
		if b==false then
			call SetTerrainPathable(x+k*Cos(a),y+k*Sin(a),PATHING_TYPE_WALKABILITY,true)
		endif
		set exit=IssuePointOrder(dummy,"stampede",x+k*Cos(a),y+k*Sin(a))
		if b==false then
			call SetTerrainPathable(x+k*Cos(a),y+k*Sin(a),PATHING_TYPE_WALKABILITY,false)
		endif
		exitwhen exit or i>40
		set i=i+1
		//set a=a+0.4
		set k=k+10
	endloop
	set caster=null
	set dummy=null
endfunction

function LaserRefractionFilter takes nothing returns boolean
	return NonImmuneEnemyFilterWithAncients() and IsHeroUnitId(GetUnitTypeId(GetFilterUnit())) and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and LoadInteger(HY,GetHandleId(GetFilterUnit()),'A33G')!=1//, A33G -> Laser
endfunction

function LaserRefraction takes unit caster, unit first returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local unit lastBounce=first
	local unit d
	local integer lvl=GetUnitAbilityLevel(caster,'A33G')//A33G -> Laser
	loop
		set tt_unit1=caster
		call GroupEnumUnitsInRange(g,GetUnitX(lastBounce),GetUnitY(lastBounce),550+25,Condition(function LaserRefractionFilter))
		set u=GetClosestOfGroup(g,GetUnitX(lastBounce),GetUnitY(lastBounce))
		exitwhen u==null
		set d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(lastBounce),GetUnitY(lastBounce),0)//e00E -> Spellcaster
		call UnitAddAbility(d,'A049')//A049 -> Laser
		call SetUnitAbilityLevel(d,'A049',lvl)//A049 -> Laser
		call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_SPELL_EFFECT) 
		call IssueTargetOrder(d,"drunkenhaze",u)
		set d=null
		call AddTimedKeyToUnit(u,'A33G',0.5)//A33G -> Laser
		set lastBounce=u
		call GroupRemoveUnit(g,u)
	endloop
	
	
	call KillGroup(g)
	set u=null
	set lastBounce=null
endfunction

function Tinker_Laser takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
	local real dur=2.5+lvl*0.5
	if IsHeroUnitId(GetUnitTypeId(target))==false then
		set dur=6.
	endif
	if IsBlocked(target)==false then
		call EvasionSourceActivate(EVASION_DEBUFF_LASER,dur+1.)
		call UnitAddAbilityTimedExF(target,'A3Q0',1,2.5+lvl*0.5,'B02P')
		call DamageTarget(caster,target,3,lvl *80)//A049 -> Laser, A33G -> Laser
		if GetSpellAbilityId()=='A33G' then//A33G -> Laser
			call AddTimedKeyToUnit(target,'A33G',0.5)//A33G -> Laser
			call LaserRefraction(caster,target)
		endif
		call CreateLightningOnUnits("LASR",caster,target,85,1,1,1,1,0.2,0.2)
	endif
	set caster=null
	set target=null
endfunction

function Tinker_Rockets_Filter takes nothing returns boolean
	if((IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) or IsUnitIllusion(GetFilterUnit())) and IsMagicImmune(GetFilterUnit())==false and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))!=null then
		return true
	endif
	return false
endfunction

function Tinker_Rockets_Hit takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit source=tt_unit1
	local unit target=tt_unit2
	local integer lvl=LoadInteger(HY,h,0)
	call DamageTarget(source,target,1,50+75*lvl)
	set source=null
	set target=null
endfunction

function Tinker_Rockets_GetClosest takes unit u, group g returns nothing
	local integer i=0
	local real dist=99999
	local real curdist=0
	local unit bu=null
	local unit d=null
	local group gg=GetAvailableGroup()
	call GroupAddGroup(g,gg)
	loop
		set d=FirstOfGroup(gg)
		exitwhen d==null
		set curdist=DistanceBetweenUnits(u,d)
		if curdist<dist then
			set dist=curdist
			set bu=d
		endif
	endloop
	call KillGroup(gg)
	set tt_unit1=bu
	set gg=null
	set d=null
	set bu=null
	set g=null
endfunction

function Tinker_Rockets takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetTriggerUnit()
	local trigger t
	local group g=GetAvailableGroup()
	local real x=GetUnitX(caster)
	local real y=GetUnitX(caster)
	local integer i=4
	local integer k=0
	local group gg=GetAvailableGroup()
	if GetSpellAbilityId()=='A05E' then//A05E -> Heat Seeking Missile
		set i=2
	endif
	set tt_unit1=caster
	
	call GroupEnumUnitsInRange(g,x,y,2500+25,Condition(function Tinker_Rockets_Filter))
	if CountUnitsInGroup(g)>0 then
		loop
			call Tinker_Rockets_GetClosest(caster,g)
			set target=tt_unit1
			if target!=null then
				set t=AddProjectile(caster,target,'hTKR',"Tinker_Rockets_Hit",900,true)
				call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
				set k=k+1
			endif
			exitwhen k>=i or target==null
		endloop
	endif
	set t=null
	
	
	call KillGroup(g)
	call KillGroup(gg)
	set gg=null
	
	set g=null
	set caster=null
	set target=null
	set t=null
endfunction

function I3F takes nothing returns nothing
	if IsUnitType(GetEnumUnit(),UNIT_TYPE_STRUCTURE) then
		call DamageTarget(GA8,GetEnumUnit(),1,GB8/ 3)
	else
		call DamageTarget(GA8,GetEnumUnit(),1,GB8)
	endif
endfunction

function I6F takes unit Source,real x,real y,real r,real d returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,r,Condition(function LB8))
	set GA8=Source
	set GB8=d
	call ForGroup(g,function I3F)
	call KillGroup(g)
	set g=null
endfunction

function ILF takes nothing returns boolean
	return (AliveNonBuildOrMarker(GetFilterUnit()) and GetFilterUnit()!=Roshan and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and (IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)) or IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false or (LoadBoolean(HY,GetPlayerId(GetOwningPlayer(GetFilterUnit())),139)==false))) !=null
endfunction

function I1F takes unit Hero, real d returns unit
	local unit Source=null
	local group g=GetAvailableGroup()
	set tt_unit1=Hero
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),d,Condition(function ILF))
	if GetUnitAbilityLevel(Hero,'A04R')>0 then//
		call GroupRemoveUnit(g,udg_Hero[GetPlayerId(GetOwningPlayer(Hero))])
	else
		call GroupRemoveUnit(g,Hero)
	endif
	set Source=GetClosestOfGroup(g,GetUnitX(Hero),GetUnitY(Hero))
	call KillGroup(g)
	set tt_unit1=Source
	set Source=null
	set g=null
	return tt_unit1
endfunction

function I0F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=GetTriggerEvalCount(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,30)
	local real x0=LoadReal(HY,h,282)
	local real y0=LoadReal(HY,h,283)
	local real x1=GetUnitX(Source)
	local real y1=GetUnitY(Source)
	local real x2
	local real y2
	local real a
	local real I5F
	local real QQE
	local real JJE
	local real AO8
	local real AP8
	local location l
	local integer lvl=GetUnitAbilityLevel(Hero,'A0CY')//A0CY -> Grow, QP1K -> Grow
	local integer tlvl=LoadInteger(HY,h,0)
	if Target!=null then
		set x2=GetUnitX(Target)
		set y2=GetUnitY(Target)
	endif
	if Target==null or DistanceBetweenXY(x0,y0,x2,y2)>1000 then
		set x2=x0
		set y2=y0
	endif
	set a=AngleBetweenXY(x1,y1,x2,y2)
	set I5F=DistanceBetweenXY(x1,y1,x2,y2)
	set QQE=I5F/ IMaxBJ((58-Count),1)
	set JJE=(Count-29)*(Count-29)
	set AO8=x1+QQE*Cos(a*bj_DEGTORAD)
	set AP8=y1+QQE*Sin(a*bj_DEGTORAD)
	if Count<58 then
		if IsBuggyFlying(Source)==false then
			call SetUnitFlyHeight(Source,775-JJE,0)
		endif
		if IsUnitType(Source,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
		endif
		call SetUnitPosition(Source,AO8,AP8)
	else
		if IsBuggyFlying(Source)==false then
			call SetUnitFlyHeight(Source,GetUnitDefaultFlyHeight(Source),0)
		endif
		call PauseUnit(Source,false)
		call SetUnitPathing(Source,true)
		call SetUnitPosition(Source,x2,y2)
		call SaveInteger(HY,GetHandleId(Source),4268,2)
		set l=Location(x2,y2)
		call TerrainDeformationRippleBJ(.2,true,l,1.,300.,96.,1,64.)
		call RemoveLocation(l)
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",GetUnitX(Source),GetUnitY(Source)))
		if IsUnitEnemy(Source,GetOwningPlayer(Hero))then
			if IsUnitHasAghanim(Hero) then
				call DamageTarget(Hero,Source,1,(.2+.15*(lvl+1))*75*tlvl)
			else
				call DamageTarget(Hero,Source,1,(.2+.15*lvl)*75*tlvl)
			endif
		endif
		if LoadBoolean(HY,h,0)==false and Target!=null and IsUnitEnemy(Target,GetOwningPlayer(Hero)) and GetUnitAbilityLevel(Target,'A3E9')==1 and IsMagicImmune(Hero)==false then
			call SaveInteger(TempHash,'A3E9',0,tlvl)
			call SaveUnitHandle(TempHash,'A3E9',0,Target)
			call SaveUnitHandle(TempHash,'A3E9',1,Hero)
			call ExecuteFunc("Tiny_Toss_LotusOrb")
		endif
		call KillTrees(x2,y2,300)
		call I6F(Hero,x2,y2,300,75*tlvl)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Hero=null
	set Source=null
	set Target=null
	set l=null
	return false
endfunction

function Tiny_Toss takes unit Hero, unit Target, integer lvl, boolean lotus returns nothing
	local unit Source=GC8
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real x
	local real y
	if Target!=null then
		set x=GetUnitX(Target)
		set y=GetUnitY(Target)
	else
		set x=GetItemX(GetSpellTargetItem())
		set y=GetItemY(GetSpellTargetItem())
	endif
	if GetUnitTypeId(Hero)=='e00C' or GetUnitTypeId(Hero)=='e00E'then //multicast//e00C -> Self Caster, e00E -> Spellcaster
		if Target==null then
			set Hero=udg_Hero[GetPlayerId(GetOwningPlayer(Hero))]
			if GetOwningPlayer(Target)==GetOwningPlayer(Hero)then
				set Target=I1F(Hero,500+200*lvl+25)
			endif
			if Source==null or Target==null then
				return
			endif
		endif
	else
		if IsUnitEnemy(Hero,GetOwningPlayer(Source)) and not lotus then
			call IssueTargetOrder(Hero,"attack",Source)
		endif
	endif
	//call SetUnitAnimationByIndex(Hero,4)
	call PauseUnit(Source,true)
	call SetUnitPathing(Source,false)
	if IsBuggyFlying(Source)==false then
		call UnitAddAbility2(Source,'Amrf')//Amrf -> Crow Form
		call UnitRemoveAbility(Source,'Amrf')//Amrf -> Crow Form
	endif
	call SaveInteger(HY,GetHandleId(Source),4268,1)
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveInteger(HY,h,0,lvl)
	call SaveBoolean(HY,h,0,lotus)
	call SaveUnitHandle(HY,h,30,(Target))
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",Source,"origin"))
	call SaveReal(HY,h,282,x)
	call SaveReal(HY,h,283,y)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function I0F))
	set Source=null
	set t=null
endfunction

function Tiny_TossWrapper takes nothing returns nothing
	call Tiny_Toss(GetTriggerUnit(),GetSpellTargetUnit(),GetUnitAbilityLevel(GetTriggerUnit(),'A0BZ'),false)//A0BZ -> Toss
endfunction

function Tiny_Toss_LotusOrb takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local unit tossing=I1F(caster,300)
	call LotusOrbFX(caster)
	if tossing!=null then
		set GC8=tossing
		call Tiny_Toss(caster,LoadUnitHandle(TempHash,'A3E9',1),LoadInteger(TempHash,'A3E9',0),true)
	endif
	set caster=null
	set tossing=null
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function Tiny_Toss_OnCast takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit tossing=I1F(caster,300)
	local unit target=GetSpellTargetUnit()
	set GC8=tossing
	if GetUnitTypeId(caster)!='e00C' and GetUnitTypeId(caster)!='e00E' then //normal cast//e00C -> Self Caster, e00E -> Spellcaster
		if tossing==null then
			call InterruptUnit(caster)
			call Error(GetOwningPlayer(caster),GetObjectName('n0DA'))//n0DA -> No valid unit to Toss
		elseif GetSpellTargetItem()!=null and IsFakeRune(GetItemTypeId(GetSpellTargetItem()))==false then
			call InterruptUnit(caster)
			call Error(GetOwningPlayer(caster),"Must target Rune")
		endif
	else //multicast
	endif
	set caster=null
	set tossing=null
	set target=null
endfunction

function YPD takes nothing returns nothing
	local unit Source=IM
	local unit Target=AM
	local unit Caster=(LoadUnitHandle(HY,(GetHandleId(Source)),297))
	call SaveUnitHandle(HY,(GetHandleId(Target)),297,(Caster))
	call SetUnitOwner(Caster,GetOwningPlayer(Target),true)
	set Source=null
	set Target=null
	set Caster=null
endfunction

function YE9 takes nothing returns nothing
	local unit Hero=VK
	local unit Caster=(LoadUnitHandle(HY,(GetHandleId(Hero)),297))
	if Caster!=null and GetUnitTypeId(Caster)=='e01V' then//e01V -> Spellcaster #3
		call RemoveUnit(Caster)
	endif
	set Hero=null
	set Caster=null
endfunction

function JHF takes nothing returns nothing
	local unit JIF=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),298))
	local integer Level=GetUnitAbilityLevel(JIF,'A0CY')//A0CY -> Grow
	local real BaseScale=U18(JIF)
	if GetWidgetLife(JIF)>1 then
		call SetUnitScale(JIF,BaseScale+.25*Level,BaseScale+.25*Level,BaseScale+.25*Level)
	endif
	set JIF=null
endfunction

function GrowIllusion_Delayed takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Original=LoadUnitHandle(HY,h,19)
	local integer Level
	local real BaseScale
	set BaseScale=U18(Source)
	set Level=GetUnitAbilityLevel(Original,'A0CY')//A0CY -> Grow, QP1K -> Grow
	call SetUnitScale(Source,BaseScale+.25*Level,BaseScale+.25*Level,BaseScale+.25*Level)
	call CleanTrigger(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set Source=null
	set Original=null
	return false
endfunction

function JJF takes nothing returns boolean
	local trigger t
	local integer h
	local unit Source=GetTriggerUnit()
	local unit Original=LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),298)
	if IsUnitIllusion(Source) and GetOwningPlayer(Source)==GetOwningPlayer(Original) and GetUnitTypeId(Source)==GetUnitTypeId(Original) then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0,false)
		call TriggerAddCondition(t,Condition(function GrowIllusion_Delayed))
		call SaveUnitHandle(HY,h,2,Source)
		call SaveUnitHandle(HY,h,19,Original)
		set t=null
	endif
	set Source=null
	set Original=null
	return false
endfunction

function Tiny_Grow_Learning takes nothing returns nothing
	local trigger t
	local unit Hero=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Hero,'A0CY')//A0CY -> Grow, QP1K -> Grow
	local unit dummy
	local region r
	local real BaseScale=U18(Hero)
	local player p=GetOwningPlayer(Hero)
	local integer pid=GetPlayerId(p)
	if Level==1 then
		set dummy=CreateUnit(p,'e01V',0,0,0)//e01V -> Spellcaster #3
		call UnitAddAbility2(dummy,'A10B')//A10B -> Grow
		call SaveUnitHandle(HY,(GetHandleId(Hero)),297,(dummy))
	else
		set dummy=(LoadUnitHandle(HY,(GetHandleId(Hero)),297))
	endif
	if Level==2 then
		call UnitRemoveAbility(dummy,'A10B')//A10B -> Grow
		call UnitRemoveAbility(Hero,'B04E')//B04E -> Grow|n|cff4F4F4FLevel:|r 1
		call UnitAddAbility2(dummy,'A10A')//A10A -> Grow
	elseif Level==3 then
		call UnitRemoveAbility(dummy,'A10B')//A10B -> Grow
		call UnitRemoveAbility(dummy,'A10A')//A10A -> Grow
		call UnitRemoveAbility(Hero,'B09C')//B09C -> Grow|n|cff4F4F4FLevel:|r 2
		call UnitRemoveAbility(Hero,'B04E')//B04E -> Grow|n|cff4F4F4FLevel:|r 1
		call UnitAddAbility2(dummy,'A0ZS')//A0ZS -> Grow
	endif
	call SetPlayerTechResearched(p,'R0L1',Level)
	if Mode_BO then
		call SetPlayerTechResearched(p,'R00E',Level)
	else
		call SetPlayerTechResearched(p,'R00L',Level)
		call SetPlayerTechResearched(p,'R00M',Level)
	endif
	if Level==1 then
		set t=CreateTrigger()
		call TriggerRegisterTimerEvent(t,2.,true)
		call TriggerAddAction(t,function JHF)
		call SaveUnitHandle(HY,GetHandleId(t),298,Hero)
		set t=CreateTrigger()
		set r=CreateRegion()
		call RegionAddRect(r,GetWorldBounds())
		call TriggerRegisterEnterRegion(t,r,Condition(function ReturnTrue))
		call TriggerAddCondition(t,Condition(function JJF))
		call SaveUnitHandle(HY,GetHandleId(t),298,Hero)
		set t=null
		set r=null
	endif
	call SetUnitScale(Hero,BaseScale+.25*Level,BaseScale+.25*Level,BaseScale+.25*Level)
	set Hero=null
	set dummy=null
endfunction

function JMF takes nothing returns boolean
	local unit Source
	local unit Target
	local integer Level
	local unit Caster
	if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if IsPoisonArrowSkill(GetSpellAbilityId()) and GetSpellTargetUnit()==LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),0) then
			set Target=GetSpellTargetUnit()
			set Source=GetTriggerUnit()
		else
			return false
		endif
	else
		set Source=GetTriggerUnit()
		set Target=GetAttacker()
	endif
	set Level=(GetUnitAbilityLevel(Source,'A19Q'))//A19Q -> Craggy Exterior, QP1J -> Craggy Exterior
	if Level>0 and GetUnitAbilityLevel(Source,'A36D')==0 and AliveNonBuildOrMarker(Target) and DistanceBetweenUnits(Source,Target)<500 and PRD_Get(Source,'A19Q',15) then//A19Q -> Craggy Exterior
		call DamageTarget(Source,Target,1,25+25*Level)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\RockBoltMissile\\RockBoltMissile.mdl",Target,"origin"))
		call StunTargetLoD(Target,1.1+0.1*Level)
	endif
	set Source=null
	set Target=null
	return false
endfunction

function Tiny_CraggeExterior_Leveling takes nothing returns nothing
	call LoDStat_Add(GetTriggerUnit(),1,"armour")
endfunction


function Tiny_CraggyExterior_Learning takes nothing returns nothing
	local trigger t
	local unit Source=GetTriggerUnit()
	if GetUnitAbilityLevel(Source,'A19Q')==1 then//A19Q -> Craggy Exterior, QP1J -> Craggy Exterior
		set t=CreateTrigger()
		call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ATTACKED)
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
		call SaveUnitHandle(HY,GetHandleId(t),0,Source)
		call TriggerAddCondition(t,Condition(function JMF))
		call LoDStat_Add(GetTriggerUnit(),1,"armour")
	endif
	call LoDStat_Add(GetTriggerUnit(),1,"armour")
	set t=null
	set Source=null
endfunction

function JPF takes nothing returns boolean
	if((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),(4268)))==1)and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(G38)) then
		call DamageTarget(G38,GetFilterUnit(),1,G68)
	endif
	return false
endfunction

function JQF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',x,y,0)//e00E -> Spellcaster
	local integer Level=GetUnitAbilityLevel(Hero,'A0LL')//A0LL -> Avalanche
	local group g=GetAvailableGroup()
	call UnitAddAbility2(Caster,'A10J')//A10J -> Avalanche Stomp
	call SetUnitAbilityLevel(Caster,'A10J',Level)//A10J -> Avalanche Stomp
	set G38=Hero
	if Level==1 then
		set G68=25
	elseif Level==2 then
		set G68=45
	elseif Level==3 then
		set G68=65
	elseif Level==4 then
		set G68=75
	endif
	call GroupEnumUnitsInRange(g,x,y,275+24,Condition(function JPF))
	call KillGroup(g)
	if GetTriggerEvalCount(t)>6 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Hero=null
	set Caster=null
	set g=null
	return false
endfunction

function Tiny_Avalanche takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
	local integer Level=GetUnitAbilityLevel(Hero,'A0LL')//A0LL -> Avalanche
	call UnitAddAbility2(Caster,'A10M')//A10M -> Avalanche (effect-correct)
	call SetUnitAbilityLevel(Caster,'A10M',Level)//A10M -> Avalanche (effect-correct)
	call IssuePointOrderById(Caster,852652,x,y)
	call TriggerRegisterTimerEvent(t,.25,true)
	call TriggerAddCondition(t,Condition(function JQF))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	call TriggerEvaluate(t)
	set Hero=null
	set t=null
	set Caster=null
endfunction

function JTF takes nothing returns nothing
	local unit u = GetEnumUnit()
	call UnitAddAbilityTimedEx(u,'A0XE',G18,7,'B00B')//A0XE -> Rampage Container, B00B -> Battle Trance
	call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A0XE',false)//A0XE -> Rampage Container
	set u = null
endfunction

function D49 takes nothing returns boolean
	return(IsUnitIdType(GetUnitTypeId(GetFilterUnit()),UNIT_TYPE_HERO) and IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function Troll_BattleTrance takes nothing returns nothing
	local group g=GetAvailableGroup()
	set G18=GetUnitAbilityLevel(GetTriggerUnit(),'A1EJ')//A1EJ -> Battle Trance
	call GroupEnumUnitsInRange(g,0,0,12000,Condition(function D49))
	call ForGroup(g,function JTF)
	call KillGroup(g)
	set g=null
endfunction

function IsMeleeTrollWarlord takes unit u returns boolean
	return GetUnitTypeId(u)=='QTW3' or GetUnitTypeId(u)=='N017' or GetUnitTypeId(u)=='N02B' or GetUnitTypeId(u)=='QTW2'//QTW3 -> Troll Warlord, N017 -> Troll Warlord, N02B -> Troll Warlord, QTW2 -> Troll Warlord
endfunction

function JXF takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	call SetUnitAbilityLevel(Source,'A09E',GetUnitAbilityLevel(Source,'A0BE'))//A09E -> Bash, A0BE -> Berserker Rage
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
	set Source=null
endfunction

function TrollRageMorph takes nothing returns nothing
	local timer t
	if IsMeleeTrollWarlord(GetTriggerUnit())==false then
		set t=CreateTimer()
		call SaveUnitHandle(HY,GetHandleId(t),2,GetTriggerUnit())
		call TimerStart(t,0,false,function JXF)
		set t=null
	endif
endfunction

function JCF takes unit u, unit Target returns nothing
	local integer h=GetHandleId(u)
	local unit prevTarget=LoadUnitHandle(HY,h,237)
	local integer c=IMaxIF(LoadInteger(HY,h,236),0)
	local integer lvl=GetUnitAbilityLevel(u,'P107')
	local integer asbonus
	local integer prevasbonus=LoadInteger(MHT,GetHandleId(u),'P107')
	if prevTarget!=Target then
		set c=0
	else
		if c==4 then
			call UnitAddAbilityTimedExF(Target,'A468',lvl,4,0)
		else
			set c=c+1
		endif
	endif
	set asbonus=(15+5*lvl)*c
	if(prevasbonus!=asbonus) then
		if prevasbonus<asbonus then
			call LoDStat_Add(u,asbonus-prevasbonus,"attack")
		else
			call LoDStat_Sub(u,prevasbonus-asbonus,"attack")
		endif
		call SaveInteger(MHT,GetHandleId(u),'P107',asbonus)
	endif
	call SaveInteger(HY,h,236,c)
	if prevTarget!=Target then
		call SaveUnitHandle(HY,h,237,Target)
	endif
	call AddTimedKeyToUnit(u,4271,.4)
	set prevTarget=null
endfunction

function Troll_Fervor takes unit attacker, unit target returns nothing
	if GetUnitAbilityLevel(attacker,'P107')>0 and GetUnitAbilityLevel(attacker,'A36D')==0 and LoadInteger(HY,GetHandleId(attacker),4271)!=1 then
		call JCF(attacker,target)
	endif
endfunction

function JLF takes unit Source,unit Target,unit Caster,integer Level returns nothing
	call SetUnitOwner(Caster,GetOwningPlayer(Target),false)
	call SetUnitAbilityLevel(Caster,'A21O',Level)//A21O -> Blind
	call IssueTargetOrderById(Caster,852190,Target)
	call DamageTarget(Source,Target,1,50+50*Level)
	call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Target,"overhead"))
endfunction

function J1F takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),H48)==false then
		call GroupAddUnit(H48,GetEnumUnit())
		call JLF(G08,GetEnumUnit(),G58,H78)
	endif
endfunction

function J0F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local unit J5F=(LoadUnitHandle(HY,h,675))
	local unit J2F=(LoadUnitHandle(HY,h,676))
	local real a=(LoadReal(HY,h,13))
	local real d=(LoadReal(HY,h,433))
	local integer Level=(LoadInteger(HY,h,5))
	local group AlreadyHit=(LoadGroupHandle(HY,h,187))
	local group g=GetAvailableGroup()
	if GetTriggerEvalCount(t)<=50 then
		set a=a+20
		set d=d+7
		call SaveReal(HY,h,13,((a)*1.))
		call SaveReal(HY,h,433,((d)*1.))
	elseif GetTriggerEvalCount(t)<=100 then
		set a=a+20
		set d=d-7
		call SaveReal(HY,h,13,((a)*1.))
		call SaveReal(HY,h,433,((d)*1.))
	endif
	call SetUnitX(J5F,SafeX50(x+d*Cos(a*bj_DEGTORAD)))
	call SetUnitY(J5F,SafeY50(y+d*Sin(a*bj_DEGTORAD)))
	set a=a+180
	call SetUnitX(J2F,SafeX50(x+d*Cos(a*bj_DEGTORAD)))
	call SetUnitY(J2F,SafeY50(y+d*Sin(a*bj_DEGTORAD)))
	set tt_unit1=Source
	set G08=Source
	set G58=Caster
	set H48=AlreadyHit
	set H78=Level
	call GroupEnumUnitsInRange(g,GetUnitX(J5F),GetUnitY(J5F),125,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(g,function J1F)
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,GetUnitX(J2F),GetUnitY(J2F),125,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(g,function J1F)
	call KillGroup(g)
	if GetTriggerEvalCount(t)>100 then
		call KillUnit(J5F)
		call KillUnit(J2F)
		call KillUnit(Caster)
		call KillGroup(AlreadyHit)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set J5F=null
	set J2F=null
	set Caster=null
	set AlreadyHit=null
	set g=null
	return false
endfunction

function Troll_AxesMelee takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local unit J5F=CreateUnit(GetOwningPlayer(Source),'e02Y',x,y,0)//e02Y -> Whirling Axes Melee
	local unit J2F=CreateUnit(GetOwningPlayer(Source),'e02Y',x,y,0)//e02Y -> Whirling Axes Melee
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)//e00E -> Spellcaster
	call UnitAddAbility(Caster,'A21O')//A21O -> Blind
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveUnitHandle(HY,h,675,(J5F))
	call SaveUnitHandle(HY,h,676,(J2F))
	call SaveReal(HY,h,13,(0*1.))
	call SaveReal(HY,h,433,(0*1.))
	call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Source,'A21N')))//A21N -> Whirling Axes
	call SaveGroupHandle(HY,h,187,(GetAvailableGroup()))
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function J0F))
	call EvasionSourceActivate(EVASION_DEBUFF_WHIRLINGAXE,12.)
	set Source=null
	set J5F=null
	set J2F=null
	set t=null
	set Caster=null
endfunction

function K7F takes unit Source,unit Target,unit Caster,integer Level returns nothing
	call SetUnitOwner(Caster,GetOwningPlayer(Target),false)
	call SetUnitAbilityLevel(Caster,'A21P',Level)//A21P -> Whirling Axes Slow
	call IssueTargetOrderById(Caster,852075,Target)
	call DamageTarget(Source,Target,1,75)
	call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Target,"overhead"))
endfunction

function K8F takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),H48)==false then
		call GroupAddUnit(H48,GetEnumUnit())
		call K7F(G08,GetEnumUnit(),G58,H78)
	endif
endfunction

function K9F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,2)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local unit axe1=LoadUnitHandle(HY,h,393)
	local unit axe2=LoadUnitHandle(HY,h,394)
	local unit axe3=LoadUnitHandle(HY,h,395)
	local unit axe4=LoadUnitHandle(HY,h,396)
	local unit axe5=LoadUnitHandle(HY,h,397)
	local real a=LoadReal(HY,h,13)-12.5
	local real d=LoadReal(HY,h,433)
	local integer Level=LoadInteger(HY,h,5)
	local unit u
	local group g
	local group AlreadyHit=LoadGroupHandle(HY,h,187)
	local unit dummy=LoadUnitHandle(HY,h,19)
	local integer i=0
	set d=d+900/ 20.
	call SaveReal(HY,h,433,d*1.)
	set G08=caster
	set G58=dummy
	set H48=AlreadyHit
	set H78=Level
	set g=GetAvailableGroup()
	loop
		exitwhen HaveSavedHandle(HY,h,393+i)==false
		set u=LoadUnitHandle(HY,h,393+i)
		if u!=null and IsDead(u)==false then
			call SetUnitX(u,SafeX50(LoadReal(HY,h,6)+d*Cos(a*bj_DEGTORAD)))
			call SetUnitY(u,SafeY50(LoadReal(HY,h,7)+d*Sin(a*bj_DEGTORAD)))
			set x=GetUnitX(u)
			set y=GetUnitY(u)
			set tt_unit1=caster
			call GroupEnumUnitsInRange(g,x,y,125,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
			call ForGroup(g,function K8F)
			call GroupClear(g)
		endif
		set a=a+6.25
		set i=i+1
	endloop
	call KillGroup(g)
	if GetTriggerEvalCount(t)>20 then
		call KillUnit(axe1)
		call KillUnit(axe2)
		call KillUnit(axe3)
		call KillUnit(axe4)
		call KillUnit(axe5)
		call KillUnit(dummy)
		call KillGroup(AlreadyHit)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set caster=null
	set axe1=null
	set axe2=null
	set axe3=null
	set axe4=null
	set axe5=null
	set dummy=null
	set u=null
	set AlreadyHit=null
	set g=null
	return false
endfunction

function Troll_AxesRanged takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local real x0=GetUnitX(caster)
	local real y0=GetUnitY(caster)
	local real x1=GetSpellTargetX()
	local real y1=GetSpellTargetY()
	local real a=AngleBetweenXY(x0,y0,x1,y1)
	local unit axe1=CreateUnit(GetOwningPlayer(caster),'e02Z',x0,y0,a-12.5)//e02Z -> Whirling Axes Ranged
	local unit axe2=CreateUnit(GetOwningPlayer(caster),'e02Z',x0,y0,a-6.25)//e02Z -> Whirling Axes Ranged
	local unit axe3=CreateUnit(GetOwningPlayer(caster),'e02Z',x0,y0,a)//e02Z -> Whirling Axes Ranged
	local unit axe4=CreateUnit(GetOwningPlayer(caster),'e02Z',x0,y0,a+6.25)//e02Z -> Whirling Axes Ranged
	local unit axe5=CreateUnit(GetOwningPlayer(caster),'e02Z',x0,y0,a+12.5)//e02Z -> Whirling Axes Ranged
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',x0,y0,0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A21P')//A21P -> Whirling Axes Slow
	call SaveUnitHandle(HY,h,2,caster)
	call SaveUnitHandle(HY,h,19,d)
	call SaveUnitHandle(HY,h,393,axe1)
	call SaveUnitHandle(HY,h,394,axe2)
	call SaveUnitHandle(HY,h,395,axe3)
	call SaveUnitHandle(HY,h,396,axe4)
	call SaveUnitHandle(HY,h,397,axe5)
	call SaveReal(HY,h,6,x0*1.)
	call SaveReal(HY,h,7,y0*1.)
	call SaveReal(HY,h,433,0*1.)
	call SaveReal(HY,h,13,a*1.)
	call SaveGroupHandle(HY,h,187,GetAvailableGroup())
	call SaveInteger(HY,h,5,GetUnitAbilityLevel(caster,'A21M'))//A21M -> Whirling Axes
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function K9F))
	set caster=null
	set axe1=null
	set axe2=null
	set axe3=null
	set axe4=null
	set axe5=null
	set t=null
	set d=null
endfunction

function KIF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=GetUnitAbilityLevel(Source,'A21L')//A21L -> Whirling Axes
	if Level==0 then
		set Level=GetUnitAbilityLevel(Source,'A21M')//A21M -> Whirling Axes
	endif
	call SetUnitAbilityLevel(Source,'A21N',Level)//A21N -> Whirling Axes
	call SetUnitAbilityLevel(Source,'A21M',Level)//A21M -> Whirling Axes
	set t=null
	set Source=null
	return false
endfunction

function Warlord_WhirlingAxes_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call UnitAddAbility2(Source,'A21N')//A21N -> Whirling Axes
	call UnitAddAbility2(Source,'A21M')//A21M -> Whirling Axes
	call SaveInteger(HY,(GetHandleId((Source))),(4416),2)
	call SaveInteger(HY,(GetHandleId((Source))),(4417),2)
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function KIF))
	call SaveUnitHandle(HY,h,2,(Source))
	call SavePlayerHandle(HY,h,54,(GetOwningPlayer(Source)))
	set t=null
	set Source=null
endfunction

function KMF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=LoadInteger(HY,h,5)
	local integer Count=LoadInteger(HY,h,34)
	local integer lim=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call UnitRemoveAbility(Source,'A1N3')//A1N3 -> Overpower
		call UnitRemoveAbility(Source,'A1N7')//A1N7 -> Overpower
		call UnitRemoveAbility(Source,'B0CH')//B0CH -> Overpower
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
		if GetAttacker()==Source then
			set Count=Count+1
			call SaveInteger(HY,h,34,(Count))
			if Count>=lim then
				call UnitRemoveAbility(Source,'A1N3')//A1N3 -> Overpower
				call UnitRemoveAbility(Source,'A1N7')//A1N7 -> Overpower
				call UnitRemoveAbility(Source,'B0CH')//B0CH -> Overpower
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
			endif
		endif
	else
		call UnitRemoveAbility(Source,'A1N3')//A1N3 -> Overpower
		call UnitRemoveAbility(Source,'A1N7')//A1N7 -> Overpower
		call UnitRemoveAbility(Source,'B0CH')//B0CH -> Overpower
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	return false
endfunction

function UrsaOverpowerLanding takes nothing returns nothing
	local integer c
	if GetUnitAbilityLevel(UDSG_Attacker,'A1N7')>0 then
		set c=LoadInteger(HY,GetHandleId(UDSG_Attacker),'A1N7'+1)
		if c>1 then
			call SaveInteger(HY,GetHandleId(UDSG_Attacker),'A1N7'+1,c-1)
		else
			call RemoveSavedInteger(HY,GetHandleId(UDSG_Attacker),'A1N7'+1)
			call UnitRemoveAbility(UDSG_Attacker,'A1N7')
			call UnitRemoveAbility(UDSG_Attacker,'B0CH')
			call UnitRemoveAbility(UDSG_Attacker,'A1N3')
		endif
	endif
endfunction

function Ursa_Overpower takes nothing returns nothing
	local trigger t
	local integer h
	local unit u=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(u,GetSpellAbilityId())
	call UnitAddAbilityTimedExF(u,'A1N7',1,15,'B0CH')
	if GetUnitAbilityLevel(u,'A0CY')==0 then//A0CY -> Grow
		call UnitAddAbilityTimedExF(u,'A1N3',1,15,0)
	endif
	call SaveInteger(HY,GetHandleId(u),'A1N7'+1,2+Level)
	set t=null
	set u=null
endfunction

function Ursa_EarthShockWrapper takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
	call UnitAddAbility(d,'A3IC')
	call SetUnitAbilityLevel(d,'A3IC',GetUnitAbilityLevel(GetTriggerUnit(),'A03Y'))
	call IssueImmediateOrder(d,"thunderclap")
	set d=null
endfunction

function FurySwipesLifesteal takes unit ursa, real dmg returns nothing
	local real heal=0
	set heal=GetUnitLifesteal(ursa)*dmg
	if GetUnitAbilityLevel(ursa,'B075')>0 then//B075 -> Vladmir's Offering
		set heal=heal+dmg*0.16
	endif
	if GetUnitAbilityLevel(ursa,'BVA1')>0 then//BVA1 -> Vampiric Aura
		set heal=heal+dmg*0.15
	elseif GetUnitAbilityLevel(ursa,'BVA2')>0 then//BVA2 -> Vampiric Aura
		set heal=heal+dmg*0.2
	elseif GetUnitAbilityLevel(ursa,'BVA3')>0 then//BVA3 -> Vampiric Aura
		set heal=heal+dmg*0.25
	elseif GetUnitAbilityLevel(ursa,'BVA4')>0 then//BVA4 -> Vampiric Aura
		set heal=heal+dmg*0.3
	endif
	if IsDead(ursa)==false then
		call SetWidgetLife(ursa,GetWidgetLife(ursa)+heal)
	endif
endfunction

function FurySwipesTriggered_Tick takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit victim
	local unit ursa
	local integer lvl
	local real dmg
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		set ursa=LoadUnitHandle(HY,h,0)
		set victim=LoadUnitHandle(HY,h,1)
		call DestroyEffect(LoadEffectHandle(HY,h,10))
		call UnitRemoveAbility(victim,'A349')
		call UnitRemoveAbility(victim,'B02N')//B02N -> Fury Swipes
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call RemoveSavedHandle(HY,GetHandleId(victim),'FRSW'+GetPlayerId(GetOwningPlayer(ursa)))
		call RemoveSavedBoolean(HY,GetHandleId(victim),'FRSW'+GetPlayerId(GetOwningPlayer(ursa)))
	else
		set ursa=LoadUnitHandle(HY,h,0)
		set victim=LoadUnitHandle(HY,h,1)
		if LoadBoolean(HY,h,2)then//FORCE DAMAGE
			call DamageTarget(ursa,victim,2,LoadReal(HY,h,100))
			if IsUnitIllusion(victim)==false then
				call FurySwipesLifesteal(ursa,LoadReal(HY,h,100))
			endif
			call SaveBoolean(HY,h,2,false)
		elseif TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0) then
			call UnitRemoveAbility(victim,'A349')
			call UnitRemoveAbility(victim,'B02N')//B02N -> Fury Swipes
			call DestroyEffect(LoadEffectHandle(HY,h,10))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call RemoveSavedHandle(HY,GetHandleId(victim),'FRSW'+GetPlayerId(GetOwningPlayer(ursa)))
			call RemoveSavedBoolean(HY,GetHandleId(victim),'FRSW'+GetPlayerId(GetOwningPlayer(ursa)))
		endif
	endif
	set t=null
	set ursa=null
	set victim=null
endfunction

function FurySwipesTriggered_Apply takes unit ursa, unit target returns nothing
	local trigger t
	local integer h
	local integer ht=GetHandleId(target)
	local integer pid=GetPlayerId(GetOwningPlayer(ursa))
	local integer lvl=GetUnitAbilityLevel(ursa,'P067')//P067 -> Fury Swipes, QP0A -> Fury Swipes
	if LoadBoolean(HY,ht,'FRSW'+pid)==false then//no swipes applied yet
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterDeathEvent(t,target)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddCondition(t,Condition(function FurySwipesTriggered_Tick))
		call SaveBoolean(HY,ht,'FRSW'+pid,true)//trigger is there
		call SaveTriggerHandle(HY,ht,'FRSW'+pid,t)
		call SaveBoolean(HY,h,2,true)//bool for FORCE_DAMAGE
		call TriggerRegisterTimerEvent(t,0,false)
		call SaveUnitHandle(HY,h,1,target)//victim
		call SaveEffectHandle(HY,h,10,AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\BattleRoar\\RoarTarget.mdl",target,"overhead"))
		call UnitAddAbility2(target,'A349')
	else//there are swipes already
		set t=LoadTriggerHandle(HY,ht,'FRSW'+pid)
		set h=GetHandleId(t)
		call SaveBoolean(HY,h,2,true)
		call TriggerRegisterTimerEvent(t,0,false)//bool for FORCE_DAMAGE
	endif
	call SaveInteger(HY,h,0,lvl)//store level
	call SaveUnitHandle(HY,h,0,ursa)//store passive's owner
	if IsUnitType(ursa,UNIT_TYPE_MELEE_ATTACKER)==false then
		call SaveReal(HY,h,100,LoadReal(HY,h,100)+8+2*lvl)
		call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+6)//save timestamp where buff should be removed
	else
		call SaveReal(HY,h,100,LoadReal(HY,h,100)+5+5*lvl)
		call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+12)//save timestamp where buff should be removed
	endif
	set t=null
endfunction

function KPF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer dmg
	local integer odmg
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or (GetUnitAbilityLevel(Source,'B02H')==0 and GetTriggerEvalCount(t)>4) or(GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT and GetSpellTargetUnit()==Source and IsPurge(GetSpellAbilityId()))then//B02H -> Enraged
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveAbility(Source,'B02H')//B02H -> Enraged
		call SaveInteger(HY,GetHandleId(Source),'a068',0)
		call BonusDamageSystem(Source)
	else
		if LoadBoolean(HY,h,0) then
			set dmg=R2I(GetUnitState(Source,UNIT_STATE_MAX_LIFE)*(.04+.01*LoadInteger(HY,h,0)))
		else
			set dmg=R2I(GetWidgetLife(Source)*(.04+.01*LoadInteger(HY,h,0)))
		endif
		set odmg=LoadInteger(HY,h,238)
		if dmg!=odmg then
			call SaveInteger(HY,h,238,dmg)
			call SaveInteger(HY,GetHandleId(Source),'a068',dmg)
			call BonusDamageSystem(Source)
		endif
	endif
	set t=null
	set Source=null
	return false
endfunction

function Ursa_Enrage takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.25,true)
	call TriggerRegisterDeathEvent(t,GetTriggerUnit())
	call TriggerAddCondition(t,Condition(function KPF))
	call SaveUnitHandle(HY,h,2,GetTriggerUnit())
	call SaveInteger(HY,h,238,0)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
	call SaveBoolean(HY,h,0,GetSpellAbilityId()=='A443')//A443 -> Enrage
	call RemoveDispellableBuffs(GetTriggerUnit())
	set t=null
endfunction

function KUF takes unit Caster,real x,real y,integer Level returns nothing
	call SetUnitPosition(Caster,x,y)
	call IssueImmediateOrderById(Caster,852588)
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\HowlOfTerror\\HowlCaster.mdl",x,y))
	set Caster=null
endfunction

function KVF takes nothing returns boolean
	if(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))and IsUnitInGroup(GetFilterUnit(),H88)==false then
		call GroupAddUnit(H88,GetFilterUnit())
		call DamageTarget(H98,GetFilterUnit(),7,HD8)
	endif
	return false
endfunction

function KWF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local real a=(LoadReal(HY,h,13))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local integer Level=(LoadInteger(HY,h,5))
	local group HND=(LoadGroupHandle(HY,h,133))
	local group g
	if GetTriggerEvalCount(t)>10 then
		call KillGroup(HND)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set H88=HND
		set H98=Source
		set HD8=60+20*Level
		set tt_unit1=Source
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,x,y,325,Condition(function KVF))
		call KillGroup(g)
		set g=null
		call KUF(Caster,x,y,Level)
		if ModuloInteger(GetTriggerEvalCount(t),2)==0 then
			call KillUnit(CreateUnit(GetOwningPlayer(Source),'e02A',x,y,0))//e02A -> Spellcaster #4
		endif
		set x=SafeX50(x+200*Cos(a*bj_DEGTORAD))
		set y=SafeY50(y+200*Sin(a*bj_DEGTORAD))
		call SaveReal(HY,h,6,((x)*1.))
		call SaveReal(HY,h,7,((y)*1.))
	endif
	set t=null
	set Source=null
	set Caster=null
	set HND=null
	return false
endfunction

function VS_WaveOfTerror takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x1=GetUnitX(Source)
	local real y1=GetUnitY(Source)
	local real x2=GetSpellTargetX()
	local real y2=GetSpellTargetY()
	local real a=AngleBetweenXY(x1,y1,x2,y2)
	local integer Level=GetUnitAbilityLevel(Source,'A17O')//A17O -> Wave of Terror
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x1,y1,0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A0AP')//A0AP -> Terror Dummy
	call SetUnitAbilityLevel(Caster,'A0AP',Level)//A0AP -> Terror Dummy
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,6,((x1)*1.))
	call SaveReal(HY,h,7,((y1)*1.))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveGroupHandle(HY,h,133,(GetAvailableGroup()))
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddCondition(t,Condition(function KWF))
	set t=null
	set Source=null
	set Caster=null
endfunction

function VS_VengeanceAuraRemove takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEventId()==EVENT_UNIT_HERO_REVIVE_FINISH or GetUnitTypeId(LoadUnitHandle(HY,h,1))!=LoadInteger(HY,h,0) then
		call UnitRemoveAbility(u,LoadInteger(HY,h,1))
		call UnitRemoveAbility(u,'B0HB')//B0HB -> Vengeance Aura
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set u=null
	set t=null
endfunction

function VS_VengeanceAuraApply takes integer lvl, unit killer, unit u returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call UnitAddAbility2(killer,'A3LC'-1+lvl)
	call TriggerRegisterUnitEvent(t,killer,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_HERO_REVIVE_FINISH)
	call TriggerRegisterTimerEvent(t,1,false)
	call SaveInteger(HY,GetHandleId(t),0,GetUnitTypeId(u))
	call TriggerAddCondition(t,Condition(function VS_VengeanceAuraRemove))
	call SaveUnitHandle(HY,GetHandleId(t),0,killer)
	call SaveUnitHandle(HY,GetHandleId(t),1,u)
	call SaveInteger(HY,GetHandleId(t),1,'A3LC'-1+lvl)
	set t=null
endfunction

function VS_Swap_Helper takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if IsDead(u)==false then
		call SetUnitPathing(u,true)
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set u=null
	set t=null
endfunction

function KZF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real x1=(LoadReal(HY,h,64))
	local real x2=(LoadReal(HY,h,66))
	local real y1=(LoadReal(HY,h,65))
	local real y2=(LoadReal(HY,h,67))
	local trigger tt
	//call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl",Source,"origin"))
	//call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl",Target,"origin"))
	call SetUnitPosition(Source,x2,y2)
	if (IsTerrainPathableFixed(x1,y1)==false or IsPointInRegion(RestrictedRegion,x1,y1)) and IsUnitType(Target,UNIT_TYPE_HERO) then
		set tt=CreateTrigger()
		call SaveUnitHandle(HY,GetHandleId(tt),0,Target)
		call TriggerRegisterTimerEvent(tt,5,false)
		call SetUnitPathing(Target,false)
		call TriggerAddCondition(tt,Condition(function VS_Swap_Helper))
		set tt=null
	endif
	call SetUnitPosition(Target,x1,y1)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function VS_NetherSwap takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local real x1=GetUnitX(Source)
	local real y1=GetUnitY(Source)
	local real x2=GetUnitX(Target)
	local real y2=GetUnitY(Target)
	local trigger t
	local integer h
	local boolean ally=IsUnitAlly(Source,GetOwningPlayer(Target))
	local boolean lotused=GetUnitAbilityLevel(Target,'A3E9')==1
//	if GetUnitAbilityLevel(Source,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(Source),0) then//Aloc -> Locust
//		
//		set Source=LoadUnitHandle(HY,GetHandleId(Source),0)
//		set x1=GetUnitX(Source)
//		set y1=GetUnitY(Source)
//	endif
	if GetUnitAbilityLevel(Source,'Aloc')==1 or (ally==false and lotused) then
		if GetUnitAbilityLevel(Source,'Aloc')==0 then
			call LotusOrbFX(Target)
			call SetUnitPosition(Target,x2,y2)//to stop channels
			call SetUnitPosition(Source,x1,y1)//to stop channels
		endif
		set Target=null
		set Source=null
		return
	endif
	if ally or IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveUnitHandle(HY,h,17,(Target))
		call SaveReal(HY,h,64,((x1)*1.))
		call SaveReal(HY,h,66,((x2)*1.))
		call SaveReal(HY,h,65,((y1)*1.))
		call SaveReal(HY,h,67,((y2)*1.))
		call TriggerRegisterTimerEvent(t,0,false)
		call TriggerAddCondition(t,Condition(function KZF))
		call ZO8("SPLK",x1,y1,x2,y2,.5,0,1,1,.3)
		call KillTrees(x1,y1,300)
		call KillTrees(x2,y2,300)
	endif
	set Source=null
	set Target=null
	set t=null
endfunction

function VS_NetherSwap_OnCast takes nothing returns nothing
	if(IsTerrainPathable(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),PATHING_TYPE_WALKABILITY)) and GetUnitAbilityLevel(GetTriggerUnit(),'Aloc')==0 then//Aloc -> Locust
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n03B'))//n03B -> Cannot use nether swap here
	endif
endfunction

function VS_MagicMissile_OnCast takes nothing returns nothing
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareMissile.mdl",GetTriggerUnit(),GetProperAttachPoint_Weapon(GetTriggerUnit())))
endfunction

function VS_MagicMissileHit takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
			call StunTargetLoD(GetTriggerUnit(), 1.35 + LoadReal(HY,h,0)*0.1)
			call DamageTarget(LoadUnitHandle(HY,h,1),GetTriggerUnit(),1,25+75*LoadReal(HY,h,0))
			if GetUnitAbilityLevel(GetTriggerUnit(),'A3E9')==1 and LoadBoolean(HY,h,0)==false and IsMagicImmune(LoadUnitHandle(HY,h,1))==false then
				call SaveUnitHandle(TempHash,'A3E9',0,GetTriggerUnit())
				call SaveUnitHandle(TempHash,'A3E9',1,LoadUnitHandle(HY,h,1))
				call SaveInteger(TempHash,'A3E9',0,R2I(LoadReal(HY,h,0)))
				call ExecuteFunc("VS_MagicMissile_LotusOrb")
			endif
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		endif
	else
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	endif
	set t=null
endfunction

function VS_MagicMissile takes unit caster, unit target, integer lvl, boolean lotus returns nothing
	local trigger t
	local integer h
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A42D')
	if lotus then
		call LotusOrbCasting(d,target,852095)
	endif
	if lotus or IssueTargetOrder(d,"thunderbolt",target) then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,5,false)
		call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(t,Condition(function VS_MagicMissileHit))
		call SaveUnitHandle(HY,h,0,d)
		call SaveUnitHandle(HY,h,1,caster)
		call SaveBoolean(HY,h,0,lotus)
		call SaveReal(HY,h,0,lvl*1.0)
		set t=null
	endif
	set d=null
endfunction

function VS_MagicMissile_Wrap takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call VS_MagicMissile(GetTriggerUnit(),GetSpellTargetUnit(),GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()),false)
	endif
endfunction

function VS_MagicMissile_LotusOrb takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	local integer lvl=LoadInteger(TempHash,'A3E9',0)
	call LotusOrbFX(caster)
	if IsBlocked(target)==false then
		call VS_MagicMissile(caster,target,lvl,true)
	endif
	set caster=null
	set target=null
	call FlushChildHashtable(TempHash,'A3E9')
endfunction


function Templar_Trap_Charge takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	if count==4 or IsDead(LoadUnitHandle(MHT,info,0))then
		call Timer_End(t)
		set t = null
		return
	endif
	set count = count + 1
	call SaveInteger(MHT,info,0,count)
	call SaveInteger(MHT,LoadInteger(MHT,info,1),1,count)
	set t = null
endfunction

function Templar_Trap_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	if IsDead(t)==false and IsUnitEnemy(group_temp_unit[0],GetOwningPlayer(t)) and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then//
		call Buff_Add(t,group_temp_integer[0],'B08M',5)//B08M -> Psionic Trap
		call DamageTarget(tt_unit1,t,3,75)
	endif
	set t = null
	return false
endfunction

function Templar_Trap_Find takes nothing returns boolean
	local unit t = GetFilterUnit()
	local real d
	local real x
	local real y
	if GetUnitTypeId(t)=='e020' and GetWidgetLife(t)>0.405 then//e020 -> Psionic Trap
		set x = GetWidgetX(t) - group_temp_real[1]
		set y = GetWidgetY(t) - group_temp_real[2]
		set d = SquareRoot(x*x + y*y)
		if group_temp_real[0] > d then
			set group_temp_unit[0] = t
			set group_temp_real[0] = d
		endif
	endif
	set t = null
	return false
endfunction

function Templar_Trap_End_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local integer i
	if GetUnitTypeId(t)=='e020' and GetWidgetLife(t)>0.405 then//e020 -> Psionic Trap
		set i = LoadInteger(MHT,GetHandleId(t),2)
		if group_temp_integer[0]==0 or group_temp_integer[1] > i then
			set group_temp_integer[1] = i
			set group_temp_unit[0] = t
		endif
		set group_temp_integer[0] = group_temp_integer[0] + 1
	endif
	set t = null
	return false
endfunction

function Templar_Trap_End takes player p, integer limit returns nothing
	set group_temp_integer[0] = 0
	call GroupEnumUnitsOfPlayer(temp_group,p,Condition(function Templar_Trap_End_Targets))
	if group_temp_integer[0] > limit then
		call RemoveUnit(group_temp_unit[0])
	endif
endfunction

function Templar_Trap_Start takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local player p = GetOwningPlayer(u)
	local integer hu = GetHandleId(u)
	local integer count = LoadInteger(MHT,hu,'A0RP')//A0RP -> Psionic Trap
	local real x
	local real y
	if GetUnitTypeId(u)=='e020'then//e020 -> Psionic Trap
		set group_temp_unit[0] = u
		set group_temp_integer[0] = LoadInteger(MHT,hu,1) + 'A510'
		set u  = LoadUnitHandle(MHT,hu,0)
		set hu = GetHandleId(u)
		set count = LoadInteger(MHT,hu,'A0RP')//A0RP -> Psionic Trap
	else
		set group_temp_unit[0] = null
		set group_temp_real[0] = 99999
		set group_temp_real[1] = GetWidgetX(u)
		set group_temp_real[2] = GetWidgetY(u)
		call GroupEnumUnitsOfPlayer(temp_group,p,Condition(function Templar_Trap_Find))
		if group_temp_unit[0]==null then
			set u = null
			return
		endif
		set group_temp_integer[0] = LoadInteger(MHT,GetHandleId(group_temp_unit[0]),1) + 'A510'
	endif
	set x = GetWidgetX(group_temp_unit[0])
	set y = GetWidgetY(group_temp_unit[0])
	set tt_unit1=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
	call GroupEnumUnitsInRange(temp_group,x,y,400,Condition(function Templar_Trap_Targets))
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",x,y))
	call RemoveUnit(LoadUnitHandle(MHT,GetHandleId(group_temp_unit[0]),1))
	call RemoveUnit(group_temp_unit[0])
	set p=null
	set u = null
endfunction

function Templar_Trap_Start_Wrap takes unit u returns nothing
	if GetUnitTypeId(u)=='e020'then//e020 -> Psionic Trap
		call Templar_Trap_Start()
	endif
endfunction

function Templar_Trap_Place takes nothing returns nothing
	local timer t
	local unit u = GetTriggerUnit()
	local player p = GetOwningPlayer(u)
	local unit d = CreateUnit(p,'e020',GetSpellTargetX(),GetSpellTargetY(),0)//e020 -> Psionic Trap
	local integer hu = GetHandleId(u)
	local integer h = LoadInteger(MHT,hu,'A0RP')//A0RP -> Psionic Trap
	local integer limit = 2 + 3*(GetUnitAbilityLevel(u,'A0RP')+GetUnitAbilityLevel(u,'A449'))//A0RP -> Psionic Trap, A449 -> Psionic Trap
	local boolean b=GetUnitAbilityLevel(u,'A449')>0//A449 -> Psionic Trap
	local unit du
	call SaveInteger(MHT,hu,'A0RP',h + 1)//A0RP -> Psionic Trap
	set hu = GetHandleId(d)
	call SaveUnitHandle(MHT,hu,0,u)
	call SaveInteger(MHT,hu,0,0)
	call SaveInteger(MHT,hu,1,0)
	call SaveInteger(MHT,hu,2,h)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_SPELL_EFFECT)
	call Templar_Trap_End(p,limit)
	call SelectSummons(d)
	if b then
		call SaveInteger(MHT,hu,1,4)
		set du=CreateUnit(p,'e01V',GetSpellTargetX(),GetSpellTargetY(),0)//e01V -> Spellcaster #3
		call UnitAddAbility(du,'A44B')
		call SaveUnitHandle(MHT,hu,1,du)
		set du=null
	else
		set t=CreateTimer()
		set h = GetHandleId(t)
		call SaveInteger(MHT,h,0,0)
		call SaveInteger(MHT,h,1,hu)
		call SaveUnitHandle(MHT,h,0,d)
		call TimerStart(t,1,true,function Templar_Trap_Charge)
	endif
	set d = null
	set p = null
	set u = null
	set t = null
endfunction

function Templar_Trap_Learn takes nothing returns nothing
	call UnitAddAbility(GetTriggerUnit(),'A0RT')//A0RT -> Psionic Trap
endfunction


function check_line takes real xc, real xt, real x, real yc, real yt, real y returns boolean
	if (y - yc)*(xt - xc) - (x - xc)*(yt - yc) > 0 then
		return true //to the left
	endif

	return false //to the right
endfunction

function check_box takes unit u, real x1a, real x1b, real x2a, real x2b, real y1a, real y1b, real y2a, real y2b returns boolean
	local real a1 = GetWidgetX(u)
	local real a2 = GetWidgetY(u)
	//checks to see if the unit is in a box \:D/
	//imba box face >:3
	return check_line(x1a,x1b,a1,y1a,y1b,a2)==false and check_line(x2a,x2b,a1,y2a,y2b,a2) and check_line(x1a,x2a,a1,y1a,y2a,a2) and check_line(x1b,x2b,a1,y1b,y2b,a2)==false
endfunction

function Psi_Blades_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()

	if IsDead(t)==false and IsUnitEnemy(group_temp_unit[0],GetOwningPlayer(t)) and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) and t!=GetTriggerUnit() then//
		if check_box(t,group_temp_real[0],group_temp_real[1],group_temp_real[2],group_temp_real[3],group_temp_real[4],group_temp_real[5],group_temp_real[6],group_temp_real[7]) then
			call DamageTarget(group_temp_unit[0],t,3,group_temp_real[8])
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\PriestMissile\\PriestMissile.mdl",t,"chest"))
		endif
	endif
	set t = null
	return false
endfunction

function Psi_Blades_Display_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local integer loopA
	local integer a = 0

	if GetLocalPlayer()==LoadPlayerHandle(MHT,info,4) then
		set a = 1
	endif

	if count==10 then
		call DestroyLightning(LoadLightningHandle(MHT,info,3))
		call DestroyLightning(LoadLightningHandle(MHT,info,2))
		call DestroyLightning(LoadLightningHandle(MHT,info,1))
		call DestroyLightning(LoadLightningHandle(MHT,info,0))

		call Timer_End(t)
		set t = null
		return
	endif

	set loopA = 0
	call SaveInteger(MHT,info,0,count + 1)

	set count = 65 + 15*count

	loop
		exitwhen loopA==4
		call SetLightningColor(LoadLightningHandle(MHT,info,loopA),count,count,count,a)
		set loopA = loopA + 1
	endloop

	set t = null
endfunction

function Psi_Blades_Display takes player p returns nothing
	local lightning l = null
	local timer t = CreateTimer()
	local integer info = GetHandleId(t)
	local integer a = 0

	if GetLocalPlayer()==p then
		set a = 1
	endif

	call SaveInteger(MHT,info,0,0)

	set l = AddLightning("DRAB",false,group_temp_real[0],group_temp_real[4],group_temp_real[1],group_temp_real[5])
	call SetLightningColor(l,50,50,50,a)
	call SaveLightningHandle(MHT,info,0,l)

	set l = AddLightning("DRAB",false,group_temp_real[0],group_temp_real[4],group_temp_real[2],group_temp_real[6])
	call SetLightningColor(l,50,50,50,a)
	call SaveLightningHandle(MHT,info,1,l)

	set l = AddLightning("DRAB",false,group_temp_real[2],group_temp_real[6],group_temp_real[3],group_temp_real[7])
	call SetLightningColor(l,50,50,50,a)
	call SaveLightningHandle(MHT,info,2,l)

	set l = AddLightning("DRAB",false,group_temp_real[3],group_temp_real[7],group_temp_real[1],group_temp_real[5])
	call SetLightningColor(l,50,50,50,a)
	call SaveLightningHandle(MHT,info,3,l)

	call SavePlayerHandle(MHT,info,4,p)

	call TimerStart(t,.05,true,function Psi_Blades_Display_End)
	set l = null
	set t = null
endfunction

function Psi_Blades_Effect takes unit u, real range, real angle, real damage, real x, real y returns nothing

	//fucking math

	local player p = GetOwningPlayer(u)
	local real a1 = angle + bj_PI/2
	local real a2 = angle - bj_PI/2
	local real x1a = x + 55*Cos(a1)
	local real y1a = y + 55*Sin(a1)
	local real x2a = x + 55*Cos(a2)
	local real y2a = y + 55*Sin(a2)
	local real x1b
	local real y1b
	local real x2b
	local real y2b

	set a1 = range*Cos(angle)
	set a2 = range*Sin(angle)

	set x1b = x1a + a1
	set y1b = y1a + a2
	set x2b = x2a + a1
	set y2b = y2a + a2

	set group_temp_unit[0] = u
	set group_temp_real[0] = x1a
	set group_temp_real[1] = x1b
	set group_temp_real[2] = x2a
	set group_temp_real[3] = x2b
	set group_temp_real[4] = y1a
	set group_temp_real[5] = y1b
	set group_temp_real[6] = y2a
	set group_temp_real[7] = y2b
	set group_temp_real[8] = damage

	if LoadBoolean(MHT,GetHandleId(p),'A0RO')then//A0RO -> Psi Blades
		call Psi_Blades_Display(p)
	endif

	call GroupEnumUnitsInRange(temp_group,x,y,range,Condition(function Psi_Blades_Targets))
	set p=null
endfunction

function Psi_Blades_Detect takes nothing returns boolean
	local unit u = null
	local unit t = null
	local trigger trig = GetTriggeringTrigger()
	local integer info = GetHandleId(trig)
	local real damage
	local real x
	local real y

	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		set t = GetTriggerUnit()
		set u = GetEventDamageSource()
		set damage = GetEventDamage()

		if LoadUnitHandle(MHT,info,0)==u and damage>1 and IsFakeDamage<1 and IsRealDamage and IsDead(t)==false then

			set x = GetWidgetX(t)
			set y = GetWidgetY(t)

			call DisableTrigger(trig)
			call Psi_Blades_Effect(u,575 + (GetUnitAbilityLevel(u,'A0RO'))*40,Atan2(y-LoadReal(MHT,info,1),x-LoadReal(MHT,info,0)),damage,x,y)//A0RO -> Psi Blades, QP1S -> Psi Blades

			call FlushChildHashtable(MHT,info)
			call CleanTrigger(trig)

		endif

		set t = null
		set u = null
	endif

	call FlushChildHashtable(MHT,info)
	call CleanTrigger(trig)
	set trig = null
	return false
endfunction

function Psi_Blades_Cooldown takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)

	call SaveBoolean(MHT,LoadInteger(MHT,info,0),'A0RO',true)//A0RO -> Psi Blades

	call Timer_End(t)
	set t = null
endfunction

function Psi_Blades_Start takes unit u, unit t, integer level returns nothing
	local timer time = CreateTimer()
	local trigger trig = CreateTrigger()
	local integer info = GetHandleId(trig)

	call TriggerRegisterUnitEvent(trig,t,EVENT_UNIT_DAMAGED)
	call TriggerRegisterTimerEvent(trig,2.5,false)

	call TriggerAddCondition(trig,Condition(function Psi_Blades_Detect))

	call SaveUnitHandle(MHT,info,0,u)
	call SaveReal(MHT,info,0,GetWidgetX(u))
	call SaveReal(MHT,info,1,GetWidgetY(u))

	set info = GetHandleId(u)
	call SaveBoolean(MHT,info,'A0RO',false)//A0RO -> Psi Blades
	call SaveInteger(MHT,GetHandleId(time),0,info)

	call TimerStart(time,0.4,false,function Psi_Blades_Cooldown)

	set time=null
	set trig = null
endfunction

function Psi_Blades_Condition takes unit u, unit t returns nothing
	local integer level = GetUnitAbilityLevel(u,'A0RO')//A0RO -> Psi Blades, QP1S -> Psi Blades
	if level>0 and GetUnitAbilityLevel(u,'A36D')==0 and LoadBoolean(MHT,GetHandleId(u),'A0RO') and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and IsUnitIllusion(t)==false then//A0RO -> Psi Blades
		call Psi_Blades_Start(u,t,level)
	endif
endfunction

function Psi_Blades_Display_Toggle takes nothing returns nothing
	local player p = GetTriggerPlayer()
	local integer info = GetHandleId(p)
	local boolean b = LoadBoolean(MHT,info,'A0RO')//A0RO -> Psi Blades
	call SaveBoolean(MHT,info,'A0RO',b==false)//A0RO -> Psi Blades
	if b then
		call DisplayTextToPlayer(p,0,0,"Turning Psi Blades Display |c00FF0000OFF|r")
	else
		call DisplayTextToPlayer(p,0,0,"Turning Psi Blades Display |c0000FF00ON|r")
	endif
endfunction

function Psi_Blades_Init takes unit u returns nothing
	local player p = GetOwningPlayer(u)
	call TriggerRegisterPlayerChatEvent(CHAT_TRIGGER,p,"-display",true)
	call DisplayTextToPlayer(p,0,0,"Type -display to display the Area of Effect for Psi Blades")
endfunction

function TemplarAssassin_PsiBlades_Leveling takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local integer level = (GetUnitAbilityLevel(u,'A0RO'))//A0RO -> Psi Blades, QP1S -> Psi Blades
	call SetUnitAcquireRange(u,GetUnitAcquireRange(u) + 60)
	call SetPlayerTechResearched(GetOwningPlayer(u),'Repb',level)
	if level==1 then
		call Psi_Blades_Init(u)
		call SaveBoolean(MHT,GetHandleId(u),'A0RO',true)//A0RO -> Psi Blades
	endif
	set u = null
endfunction



function N7F takes nothing returns boolean
	local unit Hero=GetTriggerUnit()
	local integer h=GetHandleId(Hero)
	local integer Y59=(LoadInteger(HY,h,352))
	if Y59>0 and GetTriggerEventId()!=EVENT_WIDGET_DEATH then
		if GetEventDamage()>5 and IsRealDamage then
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\PriestMissile\\PriestMissile.mdl",Hero,"right hand"))
//			call HealUnitFor(Hero,GetEventDamage())
			call SaveInteger(HY,h,352,(Y59-1))
		endif
	else
		call UnitRemoveAbility(Hero,'A0RN')//A0RN -> Refraction Prevention
		call UnitRemoveAbility(Hero,'B08J')//B08J -> |cff00ff00Refraction|r
		call SaveInteger(HY,h,352,0)
	endif
	set Hero=null
	return false
endfunction

function N8F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local unit Hero=(LoadUnitHandle(HY,(GetHandleId(t)),14))
	local integer h=GetHandleId(Hero)
	local integer Y59=(LoadInteger(HY,h,351))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or(GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED and GetAttacker()==Hero and IsUnitAlly(GetAttacker(),GetOwningPlayer(GetTriggerUnit()))==false)then
		if GetTriggerEventId()!=EVENT_WIDGET_DEATH and Y59>0 and GetEventDamage()>0 then
			call SaveInteger(HY,h,351,(Y59-1))
		else
			call UnitRemoveAbility(Hero,'A0RF')//A0RF -> Refraction Damage Bonus
			call UnitRemoveAbility(Hero,'A0RM')//A0RM -> Refraction Damage
			call UnitRemoveAbility(Hero,'B08I')//B08I -> |cff00ff00Refraction|r
			call SaveInteger(HY,h,351,0)
		endif
	endif
	set t=null
	set Hero=null
	return false
endfunction

function N9F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,h,14))
	local integer hu=GetHandleId(u)
	if LoadInteger(HY,h,0)<=1 then
		call RemoveSavedHandle(HY,hu,'A0RN')
		call SaveInteger(HY,hu,352,0)
		call SaveInteger(HY,hu,351,0)
		call UnitRemoveAbility(u,'A0RF')//A0RF -> Refraction Damage Bonus
		call UnitRemoveAbility(u,'A0RM')//A0RM -> Refraction Damage
		call UnitRemoveAbility(u,'A0RN')//A0RN -> Refraction Prevention
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SaveInteger(HY,h,0,LoadInteger(HY,h,0)-1)
	endif
	set t=null
	set u=null
	return false
endfunction

function TA_Refraction takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer hu=GetHandleId(u)
	local trigger t
	local integer h
	local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())+2
	if HaveSavedHandle(HY,hu,'A0RN') then
		set t=LoadTriggerHandle(HY,hu,'A0RN')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerAddCondition(t,Condition(function N9F))
		call SaveUnitHandle(HY,(GetHandleId(t)),14,(u))
		call SaveTriggerHandle(HY,hu,'A0RN',t)
	endif
	call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
	call TriggerRegisterTimerEvent(t,17,false)
	
	call PlaySoundAtPos(CE,GetUnitX(u),GetUnitY(u))
	call UnitAddAbility2(u,'A0RN')//A0RN -> Refraction Prevention
	call SaveInteger(HY,hu,352,lvl)
	call UnitAddAbility2(u,'A0RF')//A0RF -> Refraction Damage Bonus
	call SetUnitAbilityLevel(u,'A0RF',GetUnitAbilityLevel(u,GetSpellAbilityId()))//A0RF -> Refraction Damage Bonus
	call UnitAddAbility2(u,'A0RM')//A0RM -> Refraction Damage
	call SaveInteger(HY,hu,351,lvl)
	set u=null
	set t=null
endfunction

function TemplarAssassin_Refraction_Learn takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t
	set t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DAMAGED)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerAddCondition(t,Condition(function N7F))
	call SaveInteger(HY,(GetHandleId(Hero)),352,0)
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerAddCondition(t,Condition(function N8F))
	call SaveUnitHandle(HY,(GetHandleId(t)),14,(Hero))
	call SaveInteger(HY,(GetHandleId(Hero)),351,0)
	set t=null
	set Hero=null
endfunction

function NHF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),14),'A0RC')//A0RC -> Insta
	call FlushChildHashtable(HY,GetHandleId(t))
	call CleanTrigger(t)
	set t=null
	return false
endfunction

function NIF takes unit Source,unit Target, integer lvl returns nothing
	local trigger t=CreateTrigger()
	call SaveUnitHandle(HY,GetHandleId(t),14,Target)
	call TriggerRegisterTimerEvent(t,10,false)
	call TriggerAddCondition(t,Condition(function NHF))
	call UnitAddAbility2(Target,'A0RC')//A0RC -> Insta
	call SetUnitAbilityLevel(Target,'A0RC',lvl)//A0RC -> Insta
	call DamageTarget(Source,Target,2,50*lvl)
	call TextTagOnUnit(I2S(50*lvl),1,Target,.03,255,0,0,255)
	call UnitRemoveAbility(Source,'B08K')//B08K -> Meld
	set t=null
endfunction

function NJF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,30)
	local unit Source=LoadUnitHandle(HY,h,2)
	local trigger NKF=LoadTriggerHandle(HY,h,353)
	local integer lvl=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==Source and IsFakeDamage<1 and IsRealDamage then
			call DisableTrigger(t)
			call FlushChildHashtable(HY,GetHandleId(NKF))
			call CleanTrigger(NKF)
			call NIF(Source,Target,lvl)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_ATTACKED then
		if GetAttacker()==Source then
			if LoadBoolean(HY,h,0)==false then
				call SaveBoolean(HY,h,0,true)
			endif
		endif
	else
		if LoadInteger(HY,h,1)==0 then
			if LoadBoolean(HY,h,0)==false then
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
			else
				call SaveInteger(HY,h,1,1)
			endif
		else
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set Target=null
	set Source=null
	set NKF=null
	return false
endfunction

function NMF takes unit Source,unit Target,trigger NKF, integer lvl returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_ATTACKED)
	call TriggerRegisterTimerEvent(t,4.,false)
	call TriggerRegisterTimerEvent(t,0.8,false)
	call TriggerAddCondition(t,Condition(function NJF))
	call SaveUnitHandle(HY,h,30,(Target))
	call SaveInteger(HY,h,0,lvl)
	call SaveInteger(HY,h,1,0)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveTriggerHandle(HY,h,353,NKF)
	set t=null
endfunction

function NNF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local integer lvl=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEventId()==EVENT_UNIT_SPELL_CAST or(GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED and GetAttacker()==Hero and IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(Hero))==false)then
		if GetTriggerEventId()!=EVENT_WIDGET_DEATH and GetTriggerEventId()!=EVENT_UNIT_SPELL_CAST and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false then
			call NMF(Hero,GetTriggerUnit(),t,lvl)
			call UnitRemoveAbility(Hero,'B08K')//B08K -> Meld
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
		if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEventId()==EVENT_UNIT_SPELL_CAST then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER then
		if (GetIssuedOrderId()==ORDER_attack or GetIssuedOrderId()==851971) and IsUnitEnemy(GetOrderTargetUnit(),GetOwningPlayer(GetTriggerUnit())) and IsUnitType(GetOrderTargetUnit(),UNIT_TYPE_STRUCTURE)==false then
			call NMF(GetTriggerUnit(),GetOrderTargetUnit(),t,lvl)
			call UnitRemoveAbility(Hero,'B08K')//B08K -> Meld
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	elseif GetTriggerEventId()!=EVENT_PLAYER_UNIT_ATTACKED then
		if (x!=GetUnitX(Hero)or y!=GetUnitY(Hero)) then
			call UnitRemoveAbility(Hero,'B08K')//B08K -> Meld
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set Hero=null
	return false
endfunction

function TA_Meld takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call DestroyEffect(AddSpecialEffectTarget("effects\\PurpleAura.mdx",Hero,"origin"))
	call PlaySoundAtPos(SoundMeld,GetUnitX(Hero),GetUnitY(Hero))
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_CAST)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterTimerEvent(t,.2,true)
	call TriggerAddCondition(t,Condition(function NNF))
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,'A0RV'))//A0RV -> Meld
	call SaveReal(HY,h,6,GetUnitX(Hero))
	call SaveReal(HY,h,7,GetUnitY(Hero))
	call IssueImmediateOrderById(Hero,851993)
	set t=null
	set Hero=null
endfunction

function NQF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=(LoadInteger(HY,h,5))
	local integer NRF=(LoadInteger(HY,h,247))
	call DestroyEffect(AddSpecialEffect("effects\\Tornado.mdx",GetUnitX(Source),GetUnitY(Source)))
	if GetTriggerEvalCount(t)>10*(2+.75*Level)or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call DestroyEffect((LoadEffectHandle(HY,h,175)))
		call DestroyEffect((LoadEffectHandle(HY,h,176)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	return false
endfunction

function WR_Windrun takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A14I')//A14I -> Windrunner
	local integer NRF
	if Level==1 then
		set NRF='A135'//A135 -> Windrunner Container - 1
	elseif Level==2 then
		set NRF='A12O'//A12O -> Windrunner Container - 2
	elseif Level==3 then
		set NRF='A134'//A134 -> Windrunner Container - 3
	elseif Level==4 then
		set NRF='A139'//A139 -> Windrunner Container - 4
	endif
	call EvasionSourceActivate(EVASION_SOURCE_ARCWARDEN,7)
	call UnitAddAbilityTimedExF(Source,NRF,1,2+Level,'B09W')
	call UnitMakeAbilityPermanent(Source,true,'ACes')
	call UnitMakeAbilityPermanent(Source,true,'A12M')
	call UnitMakeAbilityPermanent(Source,true,'A133')
	call UnitMakeAbilityPermanent(Source,true,'A132')
	call UnitMakeAbilityPermanent(Source,true,'A131')
	call UnitMakeAbilityPermanent(Source,true,'A13A')
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),NRF,false)
	
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function NQF))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,5,(Level))
	call SaveInteger(HY,h,247,(NRF))
	call SaveEffectHandle(HY,h,175,(AddSpecialEffectTarget("effects\\Tornado.mdx",Source,"hand,left")))
	call SaveEffectHandle(HY,h,176,(AddSpecialEffectTarget("effects\\Tornado.mdx",Source,"hand,right")))
	call ShowHideUnit(Source)
	set Source=null
	set t=null
endfunction

function NUF takes nothing returns nothing
	local destructable Target=GetEnumDestructable()
	local real a=Atan2(GetDestructableY(Target)-GetUnitY(tt_unit1),GetDestructableX(Target)-GetUnitX(tt_unit1))
	local real KXD=RAbsBJ((tt_real1-a)*bj_RADTODEG)
	if(IsValidTree(Target)or GetDestructableTypeId(Target)=='B005')and GetDestructableLife(Target)>1 and KXD<HG8 and KXD<(HH8)then//B005 -> Haste
		set HG8=KXD
		set HE8=Target
	endif
	set Target=null
endfunction

function NVF takes unit Projectile,unit Source,real J2E returns destructable
	local real x=GetUnitX(Projectile)
	local real y=GetUnitY(Projectile)
	local rect r=Rect(x-HJ8,y-HJ8,x+HJ8,y+HJ8)
	set HG8=9999
	set tt_unit1=Projectile
	set HE8=null
	call EnumDestructablesInRect(r,Condition(function ReturnTrue),function NUF)
	call RemoveRect(r)
	set r=null
	return HE8
endfunction

function NWF takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local real a=Atan2(GetUnitY(Target)-GetUnitY(tt_unit1),GetUnitX(Target)-GetUnitX(tt_unit1))
	local real KXD=RAbsBJ((tt_real1-a)*bj_RADTODEG)
	if KXD<HG8 and KXD<HH8 and Target!=tt_unit2 then
		set HG8=KXD
		set HF8=Target
	endif
	set Target=null
endfunction

function NXF takes unit Projectile,unit Source,real J2E returns unit
	local group g=GetAvailableGroup()
	set HF8=null
	set HG8=9999
	set tt_unit1=Projectile
	set tt_real1=Atan2(GetUnitY(Source)-HM8,GetUnitX(Source)-HK8)
	set tt_unit2=Source
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),600,Condition(function NonImmuneEnemyFilter))
	call ForGroup(g,function NWF)
	call KillGroup(g)
	set g=null
	return HF8
endfunction

function NYF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	if(LoadLightningHandle(HY,h,196))!=null then
		call DestroyLightning((LoadLightningHandle(HY,h,196)))
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	return false
endfunction

function NZF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=(LoadUnitHandle(HY,h,45))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real NAF=(LoadReal(HY,h,248))
	local real a=Atan2(GetUnitY(Target)-GetUnitY(Projectile),GetUnitX(Target)-GetUnitX(Projectile))
	local integer Level=(LoadInteger(HY,h,5))
	local real x=GetUnitX(Projectile)+50*Cos(a)
	local real y=GetUnitY(Projectile)+50*Sin(a)
	local unit NBF
	local destructable d
	local lightning ZQ8
	local unit Caster
	local boolean DCD=(LoadBoolean(HY,h,249))
	local real realdur
	local real realdur2
	local boolean lotus
	local unit Source
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(Projectile)
	else
		call SetUnitX(Projectile,x)
		call SetUnitY(Projectile,y)
		call SetUnitFacing(Projectile,a*bj_RADTODEG)
		if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<45 then
			set HK8=(LoadReal(HY,h,6))
			set HM8=(LoadReal(HY,h,7))
			set lotus=LoadBoolean(HY,h,0)
			set Source=LoadUnitHandle(HY,h,44)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			if GetUnitTypeId(Target)!='n00L' and DCD then//n00L -> Roshan
				if GetUnitAbilityLevel(Target,'A3E9')==1 and IsMagicImmune(Source)==false and lotus==false then
					call SaveUnitHandle(TempHash,'A3E9',0,Target)
					call SaveUnitHandle(TempHash,'A3E9',1,Source)
					call SaveInteger(TempHash,'A3E9',0,Level)
					call ExecuteFunc("WR_ShacleshotLotusOrb")
				endif
				set NBF=NXF(Projectile,Target,NAF)
				set d=NVF(Projectile,Target,NAF)
				
				if NBF!=null then
					set t=CreateTrigger()
					set h=GetHandleId(t)
					set realdur=StunTargetLoD(Target,0.75*(Level+1))
					set realdur2=StunTargetLoD(NBF,0.75*(Level+1))
					call TriggerRegisterTimerEvent(t,RMaxIF(realdur,realdur2),false)
					call TriggerAddCondition(t,Condition(function NYF))
					set ZQ8=AddLightning("MFPB",true,GetUnitX(Target),GetUnitY(Target),GetUnitX(NBF),GetUnitY(NBF))
					call SetLightningColor(ZQ8,.5,.5,1,1)
					call SaveLightningHandle(HY,h,196,(ZQ8))
				elseif d!=null then
					set t=CreateTrigger()
					set h=GetHandleId(t)
					set Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
					set realdur=StunTargetLoD(Target,0.75*(Level+1))
					call TriggerRegisterTimerEvent(t,realdur,false)
					call TriggerAddCondition(t,Condition(function NYF))
					set ZQ8=AddLightning("MFPB",true,GetUnitX(Target),GetUnitY(Target),GetDestructableX(d),GetDestructableY(d))
					call SetLightningColor(ZQ8,.5,.5,1,1)
					call SaveLightningHandle(HY,h,196,(ZQ8))
					call SetDestructableAnimation(d,"stand hit")
				else
					call StunTargetLoD(Target,0.75)
				endif
			endif
			call KillUnit(Projectile)
		endif
	endif
	set t=null
	set Projectile=null
	set Target=null
	set ZQ8=null
	set NBF=null
	set d=null
	set Caster=null
	return false
endfunction

function WR_Shacleshot takes unit Source, unit Target, integer Level, boolean lotus returns nothing
	local real a=Atan2(GetUnitY(Target)-GetUnitY(Source),GetUnitX(Target)-GetUnitX(Source))
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h077',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)//h077 -> Shackleshot Arrow
	local boolean DCD=IsBlocked(Target)==false
	call SaveUnitHandle(HY,h,45,(Projectile))
	call SaveUnitHandle(HY,h,44,Source)
	call SaveBoolean(HY,h,0,lotus)
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,248,((a)*1.))
	call SaveBoolean(HY,h,249,(DCD))
	call SaveReal(HY,h,6,((GetUnitX(Source))*1.))
	call SaveReal(HY,h,7,((GetUnitY(Source))*1.))
	call TriggerRegisterTimerEvent(t,.033,true)
	call TriggerAddCondition(t,Condition(function NZF))
	call TriggerRegisterDeathEvent(t,Target)
	set Projectile=null
	set t=null
endfunction

function WR_ShacleshotWrapper takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A12J')//A12J -> Shackleshot
	call WR_Shacleshot(caster,target,lvl,false)
	set caster=null
	set target=null
endfunction

function WR_ShacleshotLotusOrb takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	local integer lvl=LoadInteger(TempHash,'A3E9',0)
	call LotusOrbFX(caster)
	call WR_Shacleshot(caster,target,lvl,true)
	set caster=null
	set target=null
endfunction

function N6F takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),HN8)==false and GetUnitAbilityLevel(GetEnumUnit(),'Bcyc')==0 then//Bcyc -> Cyclone
		call DamageTarget((HO8),(GetEnumUnit()),1,(((HP8)*1.))*Pow(.9,(HR8))*Pow(.99,(HQ8)))
		call GroupAddUnit(HN8,GetEnumUnit())
		set HR8=HR8+1
	endif
endfunction

function NLF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=(LoadUnitHandle(HY,h,45))
	local real TargetX=(LoadReal(HY,h,47))
	local real TargetY=(LoadReal(HY,h,48))
	local real a=(LoadReal(HY,h,13))
	local real Damage=(LoadReal(HY,h,20))
	local integer N1F=(LoadInteger(HY,h,354))
	local integer N0F=(LoadInteger(HY,h,355))
	local group AlreadyHit=(LoadGroupHandle(HY,h,187))
	local real x=SafeX50(GetUnitX(Projectile)+(60*Pow(.9,N0F)*Pow(.99,N1F))*Cos(a))
	local real y=SafeY50(GetUnitY(Projectile)+(60*Pow(.9,N0F)*Pow(.99,N1F))*Sin(a))
	local group g=GetAvailableGroup()
	local real d
	if GetTriggerEvalCount(t)>2 then
		set d=150
	else
		set d=75
	endif
	call DestroyEffect(AddSpecialEffect("effects\\Tornado.mdx",x,y))
	set N1F=N1F+KillTrees(x,y,75)
	call SaveInteger(HY,h,354,(N1F))
	set HN8=AlreadyHit
	set HO8=Projectile
	set HP8=Damage
	set HQ8=N1F
	set HR8=N0F
	set tt_unit1=Projectile
	call GroupEnumUnitsInRange(g,x,y,d,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	call ForGroup(g,function N6F)
	call KillGroup(g)
	call SaveInteger(HY,h,355,(HR8))
	call SetUnitX(Projectile,x)
	call SetUnitY(Projectile,y)
	if GetTriggerEvalCount(t)>43 then
		call KillUnit(Projectile)
		call KillGroup(AlreadyHit)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Projectile=null
	set AlreadyHit=null
	set g=null
	return false
endfunction

function N5F takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x2=(LoadReal(HY,(GetHandleId(Source)),356))
	local real y2=(LoadReal(HY,(GetHandleId(Source)),357))
	local real N2F=RMinIF(TimerGetElapsed(GlobalTimer)-LoadReal(HY,GetHandleId(Source),358),1.)
	local real a=Atan2(y2-GetUnitY(Source),x2-GetUnitX(Source))
	local trigger t
	local integer h
	local unit Projectile
	local integer Level=GetUnitAbilityLevel(Source,'A12K')//A12K -> Powershot
	local real Damage=(40+80*Level)*(N2F)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	set Projectile=CreateUnit(GetOwningPlayer(Source),'h078',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)//h078 -> Power Shot Arrow
	set x2=GetUnitX(Source)+2475*Cos(a)
	set y2=GetUnitY(Source)+2475*Sin(a)
	call SaveUnitHandle(HY,h,45,(Projectile))
	call SaveReal(HY,h,47,((x2)*1.))
	call SaveReal(HY,h,48,((y2)*1.))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveReal(HY,h,20,((Damage)*1.))
	call SaveInteger(HY,h,354,0)
	call SaveInteger(HY,h,355,0)
	call SaveGroupHandle(HY,h,187,(GetAvailableGroup()))
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function NLF))
	set Source=null
	set t=null
	set Projectile=null
endfunction

function O4F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	call SetUnitTimeScale(Hero,1)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	return false
endfunction

function O7F takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local location l=GetSpellTargetLoc()
	local real x=GetLocationX(l)
	local real y=GetLocationY(l)
	call RemoveLocation(l)
	call SaveReal(HY,(GetHandleId(Hero)),356,((x)*1.))
	call SaveReal(HY,(GetHandleId(Hero)),357,((y)*1.))
	call SaveReal(HY,(GetHandleId(Hero)),358,TimerGetElapsed(GlobalTimer)-0.3)
	call SetUnitTimeScale(Hero,.75)
	call SaveUnitHandle(HY,h,14,(Hero))
	call TriggerRegisterTimerEvent(t,.75,false)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerAddCondition(t,Condition(function O4F))
	set t=null
	set Hero=null
	set l=null
endfunction

function WR_Powershot_OnCast takes nothing returns nothing
	call SaveBoolean(HY,GetHandleId(GetTriggerUnit()),360,false)
	call O7F()
endfunction

function O8F takes nothing returns boolean
	if GetSpellAbilityId()=='A12K' then//A12K -> Powershot
		if(LoadBoolean(HY,(GetHandleId(GetTriggerUnit())),360)) then
			call N5F()
		endif
	endif
	return false
endfunction

function WR_Powershot takes nothing returns nothing
	call SaveBoolean(HY,GetHandleId(GetTriggerUnit()),360,true)
endfunction

function WR_Powershot_Endcast takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function O8F))
	set t=null
endfunction

function O9F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=LoadUnitHandle(HY,h,30)
	local real QQE=(LoadReal(HY,h,193))
	local boolean RIE=(LoadBoolean(HY,h,15))
	if GetTriggerEvalCount(t)==1 then
		call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	endif
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
		if GetAttacker()==Source and GetTriggerUnit()==Target then
			call DestroyEffect(AddSpecialEffectTarget("effects\\Tornado.mdx",Source,"hand,left"))
			call DestroyEffect(AddSpecialEffectTarget("effects\\Tornado.mdx",Source,"hand,right"))
			if GetUnitAbilityLevel(Source,'A12R')==0 then//A12R -> Focus Fire Container
				call UnitAddAbility2(Source,'A12R')//A12R -> Focus Fire Container
				call UnitMakeAbilityPermanent(Source,true,'A12S')//A12S -> Focus Fire FX
				call UnitMakeAbilityPermanent(Source,true,'A12Q')//A12Q -> Focus Fire AS
			endif
		elseif GetAttacker()==Source and GetTriggerUnit()!=Target then
			call UnitRemoveAbility(Source,'A12R')//A12R -> Focus Fire Container
			call UnitRemoveAbility(Source,'B09X')//B09X -> Focus Fire
			call UnitRemoveAbility(Source,'A1FK')//A1FK -> Focus Fire Reductio Level 1
			call UnitRemoveAbility(Source,'A1FL')//A1FL -> Focus Fire Reductio Level 2
			call UnitRemoveAbility(Source,'A1FJ')//A1FJ -> Focus Fire Reductio Level 3
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==Source and RIE==false and IsRealDamage then
			call SetWidgetLife(Target,GetWidgetLife(Target)+(QQE)*GetEventDamage())
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if GetSpellAbilityId()=='A12P' or GetSpellAbilityId()=='A1D6' then//A12P -> Focus Fire, A1D6 -> Focus Fire Upgraded
			if GetUnitAbilityLevel(Source,'A12R')>0 then//A12R -> Focus Fire Container
				call UnitRemoveAbility(Source,'A12R')//A12R -> Focus Fire Container
			endif
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	else
		call UnitRemoveAbility(Source,'A12R')//A12R -> Focus Fire Container
		call UnitRemoveAbility(Source,'B09X')//B09X -> Focus Fire
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveAbility(Source,'A1FK')//A1FK -> Focus Fire Reductio Level 1
		call UnitRemoveAbility(Source,'A1FL')//A1FL -> Focus Fire Reductio Level 2
		call UnitRemoveAbility(Source,'A1FJ')//A1FJ -> Focus Fire Reductio Level 3
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function ODF takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A12P')//A12P -> Focus Fire
	local real QQE=.6-Level*.1
	local boolean RIE=false
	if GetUnitAbilityLevel(Source,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(Source),0) then//Aloc -> Locust
		set Source=LoadUnitHandle(HY,GetHandleId(Source),0)
	endif
	
	call UnitRemoveAbility(Source,'A12R')//A12R -> Focus Fire Container
	call UnitRemoveAbility(Source,'B09X')//B09X -> Focus Fire
	
	if Level==0 then
		call UnitRemoveAbility(Source,'A1FK')//A1FK -> Focus Fire Reductio Level 1
		call UnitRemoveAbility(Source,'A1FL')//A1FL -> Focus Fire Reductio Level 2
		call UnitRemoveAbility(Source,'A1FJ')//A1FJ -> Focus Fire Reductio Level 3
		set RIE=true
		set Level=GetUnitAbilityLevel(Source,'A1D6')//A1D6 -> Focus Fire Upgraded
		set QQE=.6-Level*.15
		if Level==1 then
			call UnitAddAbility2(Source,'A1FK')//A1FK -> Focus Fire Reductio Level 1
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1FK',false)//A1FK -> Focus Fire Reductio Level 1
		elseif Level==2 then
			call UnitAddAbility2(Source,'A1FL')//A1FL -> Focus Fire Reductio Level 2
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1FL',false)//A1FL -> Focus Fire Reductio Level 2
		endif
	endif
	call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A12R',false)//A12R -> Focus Fire Container
	call UnitAddAbility2(Source,'A12R')//A12R -> Focus Fire Container
	call UnitMakeAbilityPermanent(Source,true,'A12S')//A12S -> Focus Fire FX
	call UnitMakeAbilityPermanent(Source,true,'A12Q')//A12Q -> Focus Fire AS
	call IssueTargetOrderById(Source,ORDER_attack,Target)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveBoolean(HY,h,15,(RIE))
	call SaveUnitHandle(HY,h,30,((Target)))
	call SaveReal(HY,h,193,((QQE)*1.))
	call SaveInteger(HY,h,361,0)
	call TriggerRegisterTimerEvent(t,20,false)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function O9F))
	set Source=null
	set Target=null
	set t=null
endfunction

function WR_FocusFire takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call ODF()
	endif
endfunction

function FocusFire_CloseToAttack takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(MHT,h,0)
	local unit target=LoadUnitHandle(MHT,h,1)
	if GetTriggerEventId()==EVENT_UNIT_ATTACKED and GetTriggerUnit()==target and GetAttacker()==caster then
		call DisableTrigger(t)
		call DisableTrigger(LoadTriggerHandle(MHT,h,2))
		call IssueTargetOrder(caster,"incineratearrowon",target)
		call EnableTrigger(t)
		call EnableTrigger(LoadTriggerHandle(MHT,h,2))
	endif
	if (GetIssuedOrderId()!=ORDER_attack and GetIssuedOrderId()!=851973) then
		call DestroyTrigger(t)
		call FlushChildHashtable(MHT,h)
	endif
	set t=null
	set caster=null
	set target=null
endfunction

function FocusFire_OnCast takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	call IssueTargetOrderById(caster,ORDER_attack,target)//attack
	call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_ATTACKED)
	call TriggerRegisterDeathEvent(t,caster)
	call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_ISSUED_ORDER)
	call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call TriggerAddCondition(t,Condition(function FocusFire_CloseToAttack))
	call SaveUnitHandle(MHT,h,0,caster)
	call SaveUnitHandle(MHT,h,1,target)
	call SaveTriggerHandle(MHT,h,2,GetTriggeringTrigger())
	set t=null
	set caster=null
	set target=null
endfunction

function OFF takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and GetUnitTypeId(GetFilterUnit())!='H00J' and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(HS8)))!=null//H00J -> Geomancer
endfunction

function OGF takes nothing returns nothing
	local real x=GetUnitX(GetEnumUnit())
	local real y=GetUnitY(GetEnumUnit())
	local unit d=CreateUnit(GetOwningPlayer(HS8),'e000',x,y,0)//e000 -> Lightning Bolter
	local integer id='A06L'//A06L -> Thundergod's Wrath
	call UnitAddAbility(d,'Aloc')//Aloc -> Locust
	call UnitApplyTimedLife(d,'BTLF',3)
	if GetSpellAbilityId()!='A29G' then//A29G -> Thundergod's Wrath
		set id='A07C'//A07C -> Thundergod's Wrath
	endif
	call UnitAddAbility(d,id)
	call SetUnitAbilityLevel(d,id,Zeus_TempInt)
	if GetUnitAbilityLevel(GetEnumUnit(),'A1HX')==0 then//A1HX -> Shadow Dance 2
		call IssueTargetOrderById(d,852119,GetEnumUnit())
	endif
	set d=null
endfunction

function Zeus_WrathOfGod takes nothing returns nothing
	local group g=GetAvailableGroup()
	set HS8=GetTriggerUnit()
	set Zeus_TempInt=GetUnitAbilityLevel(HS8,'A29G')+GetUnitAbilityLevel(HS8,'A29H')//A29G -> Thundergod's Wrath, A29H -> Thundergod's Wrath
	call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function OFF))
	call ForGroup(g,function OGF)
	call KillGroup(g)
	set g=null
endfunction


function Zeus_Static_Field_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local unit u = group_temp_unit[0]
	if IsUnitEnemy(u,GetOwningPlayer(t)) and IsDead(t)==false and IsMagicImmune(t)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(t)!='n00L' then//, n00L -> Roshan
		call DamageTarget(u,t,1,GetWidgetLife(t)*(0.03 + 0.02*group_temp_integer[0])+0.01*GetUnitState(t,UNIT_STATE_MAX_LIFE))
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\ForkedLightning\\ForkedLightningTarget.mdl",t,"overhead"))
	endif
	set u = null
	set t = null
	return false
endfunction

function StaticFieldEnemyCast takes unit u returns nothing
	local group g=GetAvailableGroup()
	local unit u2
	local unit source=null
	local integer lvl
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1300,Condition(function D89))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		if GetUnitAbilityLevel(u2,'A0N5')>0 then//A0N5 -> Static Field, QP1T -> Static Field
			set source=u2
			exitwhen true
		endif
		call GroupRemoveUnit(g,u2)
	endloop
	if source!=null then
		set group_temp_integer[0]=GetUnitAbilityLevel(source,'A0N5')//A0N5 -> Static Field, QP1T -> Static Field
		set group_temp_unit[0] = source
		call GroupEnumUnitsInRange(temp_group,GetWidgetX(source),GetWidgetY(source),1225,Condition(function Zeus_Static_Field_Targets))
//		call DamageTarget(source,u,1,GetWidgetLife(u)*(0.03 + 0.02*lvl))
//		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\ForkedLightning\\ForkedLightningTarget.mdl",u,"overhead"))
	endif
	set source=null
	set u2=null
	call KillGroup(g)
endfunction

function Zeus_Static_Field_Condition takes unit u, integer spell returns nothing
	set group_temp_integer[0] = GetUnitAbilityLevel(u,'A0N5')//A0N5 -> Static Field, QP1T -> Static Field
	if GetUnitAbilityLevel(u,'A36D')==0 and ((IsPoisonArrowSkill(spell)==false and isItemSpellOrNoCd(spell)==false and isDummyAbility(spell)==false and isAintItemAbility(spell) and GetUnitAbilityLevel(u,'A04R')==0 and isFormlessAbility(spell)==false)or(Mode_BO and BalanceOffSpellChecker(spell))) then//
		if group_temp_integer[0]>0 then
			set group_temp_unit[0] = u
			call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),625,Condition(function Zeus_Static_Field_Targets))
		else
			call StaticFieldEnemyCast(u)
		endif
	endif
endfunction

function Zeus_LightningBolt_Filter takes nothing returns boolean
	return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and AliveNonBuildOrMarker(GetFilterUnit()) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and IsMagicImmune(GetFilterUnit())==false
endfunction

function Zeus_LightningBolt takes unit caster, unit target, integer lvl, boolean lotus, real x, real y returns nothing
	local unit d
	local real dmg=25+lvl*75
	local group g
	//call echo(GetUnitName(caster))
	if target==null then
		set g=GetAvailableGroup()
		//set x=GetSpellTargetX()
		//set y=GetSpellTargetY()
		set tt_unit1=caster
		call GroupEnumUnitsInRange(g,x,y,350,Condition(function Zeus_LightningBolt_Filter))
		set target=GetClosestOfGroup(g,x,y)
		call KillGroup(g)
		set g=null
	endif
	if target!=null and IsBlocked(target)==false then
		if GetUnitAbilityLevel(target,'A3E9')==1 and IsMagicImmune(caster)==false and lotus==false then
			call SaveUnitHandle(TempHash,'A3E9',0,target)
			call SaveUnitHandle(TempHash,'A3E9',1,caster)
			call SaveInteger(TempHash,'A3E9',0,lvl)
			call ExecuteFunc("Zeus_LightningBoltLotusOrb")
		endif
		set x=GetUnitX(target)
		set y=GetUnitY(target)
		call StunFor001(target)
		call DamageTargetDelayed(caster,target,1,dmg,0.25)
	endif
	set d=CreateUnit(GetOwningPlayer(caster),'e000',x,y,0)//e000 -> Lightning Bolter
	call UnitAddAbility(d,'Aloc')//Aloc -> Locust
	call UnitAddAbility(d,'A3FR')
	call UnitApplyTimedLife(d,'BTLF',4.5)
	call SetUnitPathing(d,false)
	if target==null or IssueTargetOrder(d,"chainlightning",target)==false then
		set target=CreateUnit(GetOwningPlayer(caster),'e00C',x,y,0)//e00C -> Self Caster
		call UnitApplyTimedLife(target,'BTLF',0.2)
		call UnitAddAbility(target,'Aetl')//Aetl -> Ethereal
		call IssueTargetOrder(d,"chainlightning",target)
		call DestroyEffect(AddSpellEffectById('A3FR',EFFECT_TYPE_TARGET,x,y))
	endif
	
	set caster=null
	set target=null
	set d=null
endfunction

function Zeus_LightningBoltWrapper takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A0JC')//A0JC -> Lightning Bolt
	call Zeus_LightningBolt(caster,target,lvl,false,GetSpellTargetX(),GetSpellTargetY())
	set caster=null
	set target=null
endfunction

function Zeus_LightningBoltLotusOrb takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	local integer lvl=LoadInteger(TempHash,'A3E9',0)
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	call Zeus_LightningBolt(caster,target,lvl,true,GetUnitX(target),GetUnitY(target))
	set caster=null
	set target=null
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function Zeus_LightningBoltMulticast takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local integer lvl=LoadInteger(TempHash,'A3E9',0)
	local real x=LoadReal(TempHash,'A3E9',0)
	local real y=LoadReal(TempHash,'A3E9',1)
	call Zeus_LightningBolt(caster,null,lvl,true,x,y)
	set caster=null
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function OSF takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Caster=LoadUnitHandle(HY,h,19)
	local integer count=LoadInteger(HY,h,0)+1
	call SaveInteger(HY,h,0,count)
	call SetUnitX(Caster,GetUnitX(Source))
	call SetUnitY(Caster,GetUnitY(Source))
	if count>80 then
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	endif
	set t=null
	set Source=null
	set Caster=null

endfunction

function OTF takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e02C',GetUnitX(Source),GetUnitY(Source),0)//e02C -> Spellcaster Arc Lightning
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call UnitAddAbility2(Caster,'A1FM')//A1FM -> Dummy Arc Lightning
	call SetUnitAbilityLevel(Caster,'A1FM',GetUnitAbilityLevel(Source,'A020'))//A1FM -> Dummy Arc Lightning, A020 -> Arc Lightning
	call IssueTargetOrderById(Caster,852119,Target)
	call UnitApplyTimedLife(Caster,'BTLF',10)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,19,Caster)
	call TimerStart(t,0.05,true,function OSF)
	set Source=null
	set Target=null
	set Caster=null
	set t=null
endfunction

function Zeus_ChainLightning takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call OTF()
	endif
endfunction

function OWF takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call DamageTarget(LoadUnitHandle(HY,h,14),LoadUnitHandle(HY,h,14),3,LoadReal(HY,h,20))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function OXF takes unit caster, unit target returns nothing
	local real dmg=25+25*GetUnitAbilityLevel(caster,('A0I3'))//A0I3 -> Death Coil
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	if IsUnitType(caster,UNIT_TYPE_HERO)==false and HaveSavedHandle(HY,GetHandleId(caster),0) then
		set caster=LoadUnitHandle(HY,GetHandleId(caster),0)
	endif
//	call echo(GetUnitName(caster)+" -> "+GetUnitName(target))
	if IsUnitAlly(target,GetOwningPlayer(caster)) then
		if IsDead(target)==false then
			call SetWidgetLife(target,GetWidgetLife(target)+2*dmg)
		endif
	else
		call DamageTarget(caster,target,1,2*dmg)
	endif
	call SaveUnitHandle(HY,h,14,caster)
	call SaveReal(HY,h,20,(dmg+25)*1.)
	call TimerStart(t,0,false,function OWF)
	set t=null
endfunction

function Abaddon_DeathCoil takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call OXF(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1))
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
endfunction

function Abaddon_DeathCoilWrapper takes nothing returns nothing
	local timer t
	local integer h
	if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))or IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,0,false,function Abaddon_DeathCoil)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		set t=null
	endif
endfunction

function OYF takes nothing returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(HU8),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A0MJ')//A0MJ -> Aphotic Shield Damage
	call SetUnitAbilityLevel(Caster,'A0MJ',HV8)//A0MJ -> Aphotic Shield Damage
	call IssueTargetOrderById(Caster,852587,GetEnumUnit())
	set Caster=null
endfunction

function OZF takes unit Source,unit Target,integer Level returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	set HV8=Level
	set HU8=Source
	call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),700,Condition(function LT8))
	call ForGroup(g,function OYF)
	call KillGroup(g)
	set g=null
endfunction

function OAF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real OBF=(LoadReal(HY,h,362))
	local unit Source
	local unit Target=LoadUnitHandle(HY,h,30)
	local integer Level
	local integer c=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if IsRealDamage and LoadBoolean(MHT,GetHandleId(GetTriggerUnit()),'A0NS')==false then//A0NS -> Borrowed Time
			if OBF<GetEventDamage()then
				set Source=(LoadUnitHandle(HY,h,2))
				set Level=(LoadInteger(HY,h,5))
				call SaveBoolean(HY,(GetHandleId(Target)),363,(false))
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
				call UnitRemoveAbility(Target,'C000')
				call UnitRemoveAbility(Target,'D000')
				call HealUnitFor(GetTriggerUnit(),OBF)
				call OZF(Source,GetTriggerUnit(),Level)
			elseif GetEventDamage()>0 then
				call HealUnitFor(GetTriggerUnit(),GetEventDamage())
				call SaveReal(HY,h,362,((OBF-GetEventDamage())*1.))
			endif
		endif
	else
		if GetUnitAbilityLevel(Target,'C000')==0 or c>15*5 then
			set Source=(LoadUnitHandle(HY,h,2))
			set Level=(LoadInteger(HY,h,5))
			call SaveBoolean(HY,(GetHandleId(Target)),363,(false))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call OZF(Source,Target,Level)
			call UnitRemoveAbility(Target,'C000')
			call UnitRemoveAbility(Target,'D000')
		else
			call SaveInteger(HY,h,0,c+1)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function Abaddon_AphoticShield takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Target=GetSpellTargetUnit()
	local unit Source=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A0MF')//A0MF -> Aphotic Shield
	local integer hu=GetHandleId(Target)
	local real OBF
	if(LoadBoolean(HY,(hu),363)) then
		call UnitRemoveAbility(Target,'C000')
		call TriggerEvaluate((LoadTriggerHandle(HY,(hu),364)))
	endif
	//call UnitRemoveBuffs(Target,false,true)
	call RemoveDispellableBuffs(Target)
	if Level==1 then
		set OBF=110
	elseif Level==2 then
		set OBF=140
	elseif Level==3 then
		set OBF=170
	else
		set OBF=200
	endif
	call UnitAddAbility2(Target,'C000')
	call SaveReal(HY,h,362,((OBF)*1.))
	//call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\Defensive Barrier big.mdx",Target,"chest")))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,5,(Level))
	call SaveUnitHandle(HY,h,30,((Target)))
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerRegisterTimerEvent(t,0.2,true)
	call TriggerAddCondition(t,Condition(function OAF))
	call SaveTriggerHandle(HY,(hu),364,(t))
	call SaveBoolean(HY,(hu),363,(true))
	set t=null
	set Target=null
	set Source=null
endfunction

function Abbadon_Time_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local boolean forced=LoadBoolean(MHT,info,'forc')
	if LoadBoolean(MHT,info,0) then
		call SaveBoolean(MHT,'A0NS',LoadInteger(MHT,info,0),true) //allow the spell to be activated//A0NS -> Borrowed Time
		call Timer_End(t)
	else
		call TimerStart(t,LoadInteger(MHT,info,1),false,function Abbadon_Time_End)
		call SaveBoolean(MHT,LoadInteger(MHT,info,0),'A0NS',false) //disable damage block//A0NS -> Borrowed Time
		call SaveBoolean(MHT,info,0,true)
	endif

	set t = null
endfunction

function Abaddon_time_AghDmgEvt takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit aba=LoadUnitHandle(HY,h,0)
	local boolean b=LoadBoolean(MHT,GetHandleId(aba),'A0NS')//A0NS -> Borrowed Time
	local real dmg
	local unit u
	local integer j=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or b==false then
		if j>0 then
			loop
				set u=LoadUnitHandle(HY,h,j)
				call UnitRemoveAbility(u,'A3KG')
				call UnitRemoveAbility(u,'B3KG')
				call RemoveSavedHandle(HY,GetHandleId(u),'A3KG')
				set j=j-1
				exitwhen j<=0
			endloop
		endif
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	else
		if j>0 then
			loop
				set u=LoadUnitHandle(HY,h,j)
				if DistanceBetweenUnits(aba,u)<900 then
					if GetUnitAbilityLevel(u,'A3KG')==0 then
						call UnitAddAbility2(u,'A3KG')
						call SaveUnitHandle(HY,GetHandleId(u),'A3KG',aba)
					endif
				else
					call UnitRemoveAbility(u,'A3KG')
					call UnitRemoveAbility(u,'B3KG')
					call RemoveSavedHandle(HY,GetHandleId(u),'A3KG')
				endif
				set j=j-1
				exitwhen j<=0
			endloop
		endif
	endif
	set t=null
	set aba=null
endfunction

function Abbadon_Time_Agh takes unit u returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local player p=GetOwningPlayer(u)
	local integer i=1
	local integer k=5
	local boolean b=false
	local integer j=0
	if IsScourge(p) then
		set b=true
	endif
	loop
		if b then
			if udg_Hero[GetPlayerId(Scourges[i])]!=null and udg_Hero[GetPlayerId(Scourges[i])]!=u then
				set j=j+1
				call SaveUnitHandle(HY,h,j,udg_Hero[GetPlayerId(Scourges[i])])
			endif
		else
			if udg_Hero[GetPlayerId(Sentinels[i])]!=null and udg_Hero[GetPlayerId(Sentinels[i])]!=u then
				set j=j+1
				call SaveUnitHandle(HY,h,j,udg_Hero[GetPlayerId(Sentinels[i])])
			endif
		endif
		set i=i+1
		exitwhen i>k
	endloop
	call TriggerRegisterDeathEvent(t,u)
	call TriggerRegisterTimerEvent(t,0.1,true)
	call SaveInteger(HY,h,0,j)
	call TriggerAddCondition(t,Condition(function Abaddon_time_AghDmgEvt))
	call SaveUnitHandle(HY,h,0,u)
	set t=null
endfunction

function Abbadon_Time_Effect takes unit u, integer load returns nothing
	local timer t = CreateTimer()
	local player p = GetOwningPlayer(u)
	local integer info = GetHandleId(t)
	local integer level = GetUnitAbilityLevel(u,'A0NS')//A0NS -> Borrowed Time
	local boolean b = IsUnitSelected(u,p)
	local real dur
	local integer id='A0NS'
	//call UnitRemoveBuffs(u,false,true)
	call RemoveDispellableBuffs(u)
	call DisableTrigger(GAME_TRIGGER)
	call DisableTrigger(GetTriggeringTrigger())
	call IssueImmediateOrder(u,"windwalk")
	call EnableTrigger(GetTriggeringTrigger())
	call EnableTrigger(GAME_TRIGGER)
	if p==GetLocalPlayer() and b then
		call SelectUnit(u,true)
	endif
	
	if level==0 then
		set level = GetUnitAbilityLevel(u,'A1DA')//A1DA -> Borrowed Time Upgrade
		set dur=2.5+level*1.
		set id='A0NS'
		call Abbadon_Time_Agh(u)
	else
		set dur=2.7+0.3*level
	endif
	call SaveInteger(MHT,info,1,R2I(GetCooldown(id,level)) - R2I(dur))
	
	
	call SaveBoolean(MHT,load,'A0NS',true)  //active//A0NS -> Borrowed Time
	call SaveBoolean(MHT,'A0NS',load,false) //is avaliable//A0NS -> Borrowed Time
	call Buff_Add(u,'C022','D022',dur)
	call SaveInteger(MHT,info,0,load)
	call SaveBoolean(MHT,info,0,false)
	call TimerStart(t,dur,false,function Abbadon_Time_End)
	call SaveTimerHandle(HY,load,'A0NS',t)
	set t = null
endfunction

function Abbadon_Time_Start takes nothing returns nothing
	local unit u = GetTriggerUnit()
	if LoadBoolean(MHT,'A0NS',GetHandleId(u)) then//A0NS -> Borrowed Time
		call Abbadon_Time_Effect(u,GetHandleId(u))
	else
		call Error(GetOwningPlayer(u),"Spell is not ready yet.")
	endif
	set u = null
endfunction

function Abbadon_Time_Condition takes unit u, real d returns nothing
	local integer hu = GetHandleId(u)
	if LoadBoolean(MHT,hu,'A0NS')==false and LoadBoolean(MHT,'A0NS',hu) and 400>GetWidgetLife(u) and GetUnitAbilityLevel(u,'A36D')==0 then//A0NS -> Borrowed Time
		call Abbadon_Time_Effect(u,hu)
	endif
endfunction

function Abbadon_Time_Learn takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local integer info = GetHandleId(u)
	if (GetUnitAbilityLevel(u,'A0NS')==1 or GetUnitAbilityLevel(u,'A1DA')==1) and IsUnitIllusion(u)==false then//A0NS -> Borrowed Time, A1DA -> Borrowed Time Upgrade
		call SaveBoolean(MHT,info,1,true)
		call SaveBoolean(MHT,'A0NS',info,true)//A0NS -> Borrowed Time
		call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_DAMAGED)
	endif
	set u = null
endfunction

function P9F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Level=(LoadInteger(HY,h,5))
	local integer Count=(LoadInteger(HY,h,34))
	local real Damage=(Level+1)*8
	local integer DP9=10
	local unit W19
	if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if GetTriggerEvalCount(t)>1 and GetSpellAbilityId()=='A0S1' and IsBlocked(GetSpellTargetUnit())==false and Target==GetSpellTargetUnit()then//A0S1 -> Battle Hunger
			//call DestroyEffect((LoadEffectHandle(HY,h,32)))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
		if IsPurge(GetSpellAbilityId()) and GetSpellTargetUnit()==Target then
			//call DestroyEffect((LoadEffectHandle(HY,h,32)))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_DEATH then
		if IsUnitIllusion(GetTriggerUnit())==false and GetUnitTypeId(GetTriggerUnit())!='u00S' then
			set W19=GetKillingUnit()
			if WC8(W19)then
				set W19=(udg_Hero[GetPlayerId(GetOwningPlayer((W19)))])
			endif
			if GetTriggerUnit()==Target or W19==Target then
				//call DestroyEffect((LoadEffectHandle(HY,h,32)))
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
				call UnitRemoveAbility(Target,'A1W2')//A1W2 -> Battle HungerMS 1
				call UnitRemoveAbility(Target,'B0DO')//B0DO -> Battle Hunger
			endif
		endif
	else
		set Count=Count+1
		call SaveInteger(HY,h,34,(Count))
		if GetUnitAbilityLevel(Target,'A1W2')==0 or Count==DP9 then//A1W2 -> Battle HungerMS 1
			//call DestroyEffect((LoadEffectHandle(HY,h,32)))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call UnitRemoveAbility(Target,'A1W2')//A1W2 -> Battle HungerMS 1
			call UnitRemoveAbility(Target,'B0DO')//B0DO -> Battle Hunger
		endif
		call DamageTarget(Source,Target,1,Damage)
	endif
	set t=null
	set Source=null
	set Target=null
	set W19=null
	return false
endfunction

function PDF takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A0S1')//A0S1 -> Battle Hunger
	local real Damage
	local real DP9
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Demon\\ReviveDemon\\ReviveDemon.mdl",Target,"overhead"))
	call UnitAddAbility2(Target,'A1W2')//A1W2 -> Battle HungerMS 1
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function P9F))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,5,(Level))
	call SaveInteger(HY,h,34,0)
	//call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("Abilities\\Spells\\Other\\SoulBurn\\SoulBurnbuff.mdl",Target,"overhead")))
	set Source=null
	set Target=null
	set t=null
endfunction

function PEF takes nothing returns nothing
	if GetUnitAbilityLevel(GetEnumUnit(),'B0DO')>0 then//B0DO -> Battle Hunger
		set tt_int1=tt_int1+1
	endif
endfunction

function PFF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	set tt_int1=0
	call GroupEnumUnitsInRange(g,0,0,9999,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(g,function PEF)
	call KillGroup(g)
	if tt_int1==0 then
		if GetUnitAbilityLevel(Source,'B0EZ')>0 then//B0EZ -> Battle Hunger
			call UnitRemoveAbility(Source,'A2AO')
			call UnitRemoveAbility(Source,'B0EZ')//B0EZ -> Battle Hunger
		endif
	elseif GetUnitAbilityLevel(Source,'A2AO')!=tt_int1 then
		call UnitAddAbility2(Source,'A2AO')
		call SetUnitAbilityLevel(Source,'A2AO',tt_int1)
	endif
	set t=null
	set Source=null
	set g=null
	return false
endfunction

function PHF takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddCondition(t,Condition(function PFF))
	call SaveUnitHandle(HY,h,2,(Source))
	set t=null
	set Source=null
endfunction

function Axe_BattleHunger takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call PDF()
	endif
endfunction

function PJF takes nothing returns boolean
	return DefaultEnemyFilterWithAncients() and IsUnitInvulnerable(GetFilterUnit())==false
endfunction

function PKF takes integer h,integer PMF returns nothing
	local integer i=1
	loop
		exitwhen i>PMF
		call DestroyEffect((LoadEffectHandle(HY,h,(2700+i))))
		set i=i+1
	endloop
endfunction

function PNF takes nothing returns nothing
	call UnitWakeUp(GetEnumUnit())
	call IssueTargetOrderById(GetEnumUnit(),ORDER_attack,HY8)
endfunction

function RemoveAggrobuff takes nothing returns nothing
	call UnitRemoveAbility(GetEnumUnit(),'C003')
endfunction

function POF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local group g=(LoadGroupHandle(HY,h,220))
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer PMF=(LoadInteger(HY,h,365))
	local integer Level=(LoadInteger(HY,h,5))
	local integer Count=(LoadInteger(HY,h,34))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		set Count=Count+1
		if GetTriggerEventId()==EVENT_WIDGET_DEATH then
			set Count=9999
		endif
		call SaveInteger(HY,h,34,(Count))
		if Count>=(5+2.5*Level) then
			call LoDStat_Sub(Hero,40,"armour")
			call UnitRemoveAbility(Hero,'A0I5')//A0I5 -> Berserker's Call Armor Bonus
			call ForGroup(g,function RemoveAggrobuff)
			call KillGroup(g)
			call PKF(h,PMF)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		else
			call DisableTrigger(t)
			set HY8=Hero
			call ForGroup(g,function PNF)
			call EnableTrigger(t)
		endif
	else
		
		
		if IsUnitInGroup(GetTriggerUnit(),g) and UnitIsSleeping(GetTriggerUnit())==false and GetIssuedOrderId()!=851973 and HW8==false then//B008 -> Shackles
//			call SetUnitAbilityLevel(GetTriggerUnit(),'C003',2)
//			if (GetLocalPlayer() == GetOwningPlayer(GetTriggerUnit())) then
//				call SelectUnit(GetTriggerUnit(),false)
//			endif
			call DisableTrigger(t)
			call IssueTargetOrderById(GetTriggerUnit(),ORDER_attack,Hero)
			call EnableTrigger(t)
		endif
	endif
	set t=null
	set g=null
	set Hero=null
	return false
endfunction

function RemoveFromSelection takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if GetUnitAbilityLevel(u,'C003')==2 then
//		if GetLocalPlayer()==GetOwningPlayer(u) then
//			call SelectUnit(u,false)
//		endif
//		call SaveBoolean(HY,h,0,true)
	elseif GetUnitAbilityLevel(u,'C003')==0 then
//		if LoadBoolean(HY,h,0)then
//			if GetLocalPlayer()==GetOwningPlayer(u) then
//				call SelectUnit(u,true)
//			endif
//		endif
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	endif
	set u=null
	set t=null
endfunction

function InitRemoveFromSelection takes unit u returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.01,true,function RemoveFromSelection)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	set t=null
endfunction

function PPF takes nothing returns nothing
	local unit u = GetEnumUnit()
	set tt_int1=tt_int1+1
	call UnitAddAbilityTimedExF(u,'C003',1,GetUnitAbilityLevel(GetTriggerUnit(),'A0I6')*0.5+1,'D003')
	//call Buff_Add(u,'C003','D003',GetUnitAbilityLevel(GetTriggerUnit(),'A0I6')*0.5+1)//A0I6 -> Berserker's Call
	call SaveEffectHandle(HY,(WK),(2700+tt_int1),(AddSpecialEffectTarget("Abilities\\Weapons\\LavaSpawnMissile\\LavaSpawnBirthMissile.mdl",u,"chest")))
	//call InitRemoveFromSelection(u)
	set u = null
endfunction

function Axe_BerserkerCall takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Hero,'A0I6')//A0I6 -> Berserker's Call
	local group g=GetAvailableGroup()
	
	set tt_unit1=Hero
	set HY8=Hero
	set tt_int1=0
	set WK=h
	call LoDStat_Add(Hero,30,"armour")
	call Buff_Add(Hero,'C004','D004',Level*0.5+1)
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),325,Condition(function PJF))
	call ForGroup(g,function PPF)
	call ForGroup(g,function PNF)
	call SaveInteger(HY,h,365,(tt_int1))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveGroupHandle(HY,h,220,(g))
	call SaveInteger(HY,h,5,(Level))
	call SaveInteger(HY,h,34,0)
	call TriggerRegisterTimerEvent(t,.2,true)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
	call TriggerAddCondition(t,Condition(function POF))
	
	set t=null
	set g=null
	set Hero=null
endfunction

function CounterHelixFilter takes nothing returns boolean
	return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and((GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0) and (IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false) and IsDead(GetFilterUnit())==false))!=null//
endfunction

function PTF takes unit Hero returns nothing
	local group g=GetAvailableGroup()
	local unit u
	local unit d=GetInvulDamager(Hero)
	local integer lvl=GetUnitAbilityLevel(Hero,'P327')
	local real dmg=lvl*35+65
	set tt_unit1=Hero
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),300,Condition(function CounterHelixFilter))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",u,"origin"))
		call DamageTarget(d,u,2,dmg)
		call GroupRemoveUnit(g,u)
	endloop
	if (GetUnitTypeId(Hero)!='Nbbc' and GetUnitTypeId(Hero)!='Opgh')then//Nbbc -> Juggernaut, Opgh -> Axe
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\SpinFX3.mdx",Hero,"origin"))
	else
		call SetUnitAnimation(Hero,"spin")
	endif
	set d=null
	call BF8(Hero,.6)
	call AddTimedKeyToUnit(Hero,4267,.5-.05*lvl) //A0C6
	call KillGroup(g)
endfunction

function AxeAttacked takes unit attacker, unit target returns nothing
	if GetUnitAbilityLevel(target,'B03P')>0 and IsUnitType(attacker,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(attacker,UNIT_TYPE_MECHANICAL)==false and GetUnitAbilityLevel(attacker,'A04R')==0 or IsSiegeUnit(attacker)) and IsUnitEnemy(attacker,GetOwningPlayer(target)) and LoadInteger(HY,GetHandleId(target),4267)!=1 and GetUnitAbilityLevel(target,'A1HX')==0 and GetUnitAbilityLevel(target,'A36D')==0 and PRD_Get(target,'B03P',20) then
	//B03P -> Counter Helix, , A1HX -> Shadow Dance 2, B03P -> Counter Helix
		call PTF(target)
	endif
endfunction

function PVF takes nothing returns nothing
	call UnitAddAbilityTimedExF(GetEnumUnit(),'A2IB',1,group_temp_integer[0],'B0FV')//A2IB -> Culling Blade MS Bonus, B0FV -> Culling Blade
endfunction

function Axe_CullingBlade takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,0)
	local unit Target=LoadUnitHandle(HY,h,1)
	local real OBF=GetWidgetLife(Target)
	local integer spellid=LoadInteger(HY,h,1)
	local integer Level=LoadInteger(HY,h,0)
	local unit Caster
	local boolean PYF=LoadBoolean(HY,h,0)
	local group g
	local real limit=999
	if PYF then
		if Level==1 then
			set limit=300
		elseif Level==2 then
			set limit=450
		else
			set limit=625
		endif
		set group_temp_integer[0]=10
	else
		set limit=150+100*Level
		set group_temp_integer[0]=6
	endif
//	call echo(GetUnitName(Hero)+" -> "+GetUnitName(Target))
	if(OBF<=limit)then
		call PlaySoundOnUnitBJ(Sound_AxeKillFX,100,Target)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile.mdl",Target,"overhead"))
		set Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',0,0,0)//e00E -> Spellcaster
		if IsUnitType(Target,UNIT_TYPE_SUMMONED)==false then
			call UnitRemoveBuffs(Target,true,true)
		endif
		call UnitRemoveAbility(Target,'Aetl')//Aetl -> Ethereal
		call DamageTarget(Caster,Target,4,100000000)
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\AxeUltiMSFX_01.mdx",Hero,"origin"))
		set g=GetAvailableGroup()
		set tt_unit1=Hero
		call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),925,Condition(function DefaultAllyFilter))
		call ForGroup(g,function PVF)
		call KillGroup(g)
		if IsUnitType(Target,UNIT_TYPE_HERO) and IsUnitType(Hero,UNIT_TYPE_HERO) then
			call ResetCooldownForAbility(Hero,spellid)
		endif
	endif
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set Hero=null
	set Target=null
	set Caster=null
	set t=null
endfunction

function Axe_CullingBladeWrapper takes nothing returns nothing
	local timer t
	local integer h
	if IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
		call SaveInteger(HY,h,1,GetSpellAbilityId())
		if GetSpellAbilityId()=='A1MR' then//A1MR -> Culling Blade
			call SaveBoolean(HY,h,0,true)
		endif
		call TimerStart(t,0,false,function Axe_CullingBlade)
		set t=null
	endif
endfunction

function Bane_BrainSap takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local integer i
	set i=GetUnitAbilityLevel(u,'A0GK')//A0GK -> Brain Sap
	if IsUnitType(u,UNIT_TYPE_HERO)==false then
		if HaveSavedHandle(HY,GetHandleId(u),0) then
			set u=LoadUnitHandle(HY,GetHandleId(u),0)
		endif
	endif
	call DamageTarget(u,target,3,20+70*i)
	if GetWidgetLife(u)>1 then
		call SetWidgetLife(u,GetWidgetLife(u)+20+70*i)
	endif
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set target=null
	set u=null
	set t=null
endfunction

function Bane_BrainSapWrapper takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	if IsBlocked(GetSpellTargetUnit())==false then
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		call TimerStart(t,0,false,function Bane_BrainSap)
	else
		call DestroyTimer(t)
	endif
	//call RemoveUnit(GetSpellTargetUnit())
	set t=null
endfunction

function Func2724 takes nothing returns boolean
	local trigger loc_trigger01=GetTriggeringTrigger()
	local integer h=GetHandleId(loc_trigger01)
	local integer lvl=(LoadInteger(HY,(h),30))
	local unit loc_unit01=LoadUnitHandle(HY,h,30)
	local unit loc_unit02=(LoadUnitHandle(HY,(h),2))
	local player loc_player01=(LoadPlayerHandle(HY,(h),54))
	local integer loc_integer03=(LoadInteger(HY,(h),5))
	local unit loc_unit03
	local boolean b=GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED
	if GetUnitAbilityLevel(loc_unit01,'B02F')==0 then//B02F -> Nightmare
		call SetPlayerAbilityAvailable(GetOwningPlayer(loc_unit01),'A04Y',true)//A04Y -> Nightmare
		call SetPlayerAbilityAvailable(GetOwningPlayer(loc_unit01),'A2O9',false)//A2O9 -> Nightmare End
		call UnitRemoveAbility(loc_unit01,'A37S')
		call UnitRemoveAbility(loc_unit01,'A3C9')
		call UnitAddAbilityTimedExF(loc_unit01,'A3CA',1,1,'A3CA')
		if HaveSavedHandle(HY,GetHandleId(loc_unit01),'VisD') then
			call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(loc_unit01),'VisD'),'A37S')
			call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(loc_unit01),'VisD'),'A3C9')
			call UnitAddAbilityTimedExF(LoadUnitHandle(HY,GetHandleId(loc_unit01),'VisD'),'A3CA',1,1,'A3CA')
		endif
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(loc_trigger01)
	elseif b==false and GetTriggerUnit()==loc_unit01 then
		call SetPlayerAbilityAvailable(GetOwningPlayer(loc_unit01),'A04Y',true)//A04Y -> Nightmare
		call SetPlayerAbilityAvailable(GetOwningPlayer(loc_unit01),'A2O9',false)//A2O9 -> Nightmare End
		call UnitRemoveAbility(loc_unit01,'B02F')//B02F -> Nightmare
		set loc_unit03=CreateUnit(loc_player01,'e00E',GetUnitX(loc_unit01),GetUnitY(loc_unit01),0)//e00E -> Spellcaster
		call UnitAddAbility2(loc_unit03,'A04Y')//A04Y -> Nightmare
		call UnitRemoveAbility(loc_unit01,'A37S')
		call UnitRemoveAbility(loc_unit01,'A3C9')
		call UnitAddAbilityTimedExF(loc_unit01,'A3CA',1,1,'A3CA')
		if HaveSavedHandle(HY,GetHandleId(loc_unit01),'VisD') then
			call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(loc_unit01),'VisD'),'A37S')
			call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(loc_unit01),'VisD'),'A3C9')
			call UnitAddAbilityTimedExF(LoadUnitHandle(HY,GetHandleId(loc_unit01),'VisD'),'A3CA',1,1,'A3CA')
		endif
		call SetUnitAbilityLevel(loc_unit03,'A04Y',loc_integer03)//A04Y -> Nightmare
		call IssueTargetOrder(loc_unit03,"sleep",GetAttacker())
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(loc_trigger01)
	elseif b then
		call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
		if LoadInteger(HY,h,0)==9 then
			call UnitRemoveAbility(loc_unit01,'A3C9')
			if HaveSavedHandle(HY,GetHandleId(loc_unit01),'VisD') then
				call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(loc_unit01),'VisD'),'A3C9')
			endif
		endif
		if ModuloInteger(LoadInteger(HY,h,0),10)==0 then
			if GetUnitState(loc_unit01,UNIT_STATE_LIFE)>21 then
				call SetUnitState(loc_unit01,UNIT_STATE_LIFE,GetUnitState(loc_unit01,UNIT_STATE_LIFE)-20)
			else
				call SetPlayerAbilityAvailable(GetOwningPlayer(loc_unit01),'A04Y',true)//A04Y -> Nightmare
				call SetPlayerAbilityAvailable(GetOwningPlayer(loc_unit01),'A2O9',false)//A2O9 -> Nightmare End
				call UnitRemoveAbility(loc_unit01,'B02F')//B02F -> Nightmare
				call UnitRemoveAbility(loc_unit01,'A37S')
				call UnitRemoveAbility(loc_unit01,'A3C9')
				if HaveSavedHandle(HY,GetHandleId(loc_unit01),'VisD') then
					call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(loc_unit01),'VisD'),'A37S')
					call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(loc_unit01),'VisD'),'A3C9')
					call UnitAddAbilityTimedExF(loc_unit01,'A3CA',1,1,'A3CA')
				endif
				call UnitAddAbilityTimedExF(loc_unit01,'A3CA',1,1,'A3CA')
				call DamageTarget(loc_unit02,loc_unit01,1,50)
				call FlushChildHashtable(HY,(h))
				call CleanTrigger(loc_trigger01)
			endif
		endif
	endif
	set loc_trigger01=null
	set loc_player01=null
	set loc_unit03=null
	set loc_unit01=null
	set loc_unit02=null
	return false
endfunction

function Func2725 takes unit loc_unit01, unit loc_unit02 returns nothing
	local trigger loc_trigger01=CreateTrigger()
	local integer loc_integer01=GetHandleId(loc_trigger01)
	set loc_integer01=GetHandleId(loc_trigger01)
	call SaveUnitHandle(HY,(loc_integer01),30,((loc_unit02)))
	call SaveUnitHandle(HY,(loc_integer01),2,(loc_unit01))
	call SavePlayerHandle(HY,(loc_integer01),54,(GetOwningPlayer(loc_unit01)))
	call SaveInteger(HY,(loc_integer01),5,(GetUnitAbilityLevel(loc_unit01,'A04Y')))//A04Y -> Nightmare
	call TriggerRegisterAnyUnitEvent(loc_trigger01,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterTimerEvent(loc_trigger01,0.1,true)
	call TriggerAddCondition(loc_trigger01,Condition(function Func2724))
	if GetUnitAbilityLevel(loc_unit02,'A04Y')>0 then//A04Y -> Nightmare
		call SetPlayerAbilityAvailable(GetOwningPlayer(loc_unit02),'A04Y',false)//A04Y -> Nightmare
		call UnitAddAbility2(loc_unit02,'A2O9')//A2O9 -> Nightmare End
		call SetPlayerAbilityAvailable(GetOwningPlayer(loc_unit02),'A2O9',true)//A2O9 -> Nightmare End
	endif
	call UnitAddAbility(loc_unit02,'A37S')
	call UnitAddAbility(loc_unit02,'A3C9')
	if HaveSavedHandle(HY,GetHandleId(loc_unit02),'VisD') then
		call UnitAddAbility(LoadUnitHandle(HY,GetHandleId(loc_unit02),'VisD'),'A37S')
		call UnitAddAbility(LoadUnitHandle(HY,GetHandleId(loc_unit02),'VisD'),'A3C9')
	endif
	set W67=true
	call DamageTarget(loc_unit01,loc_unit02,2,0)
	set W67=false
	set loc_trigger01=null
endfunction

function Bane_Nightmare takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call Func2725(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1))
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
endfunction

function Bane_NightmareWrapper takes nothing returns nothing
	local timer t
	local integer h
	if IsCourier(GetSpellTargetUnit())==false and IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,0,false,function Bane_Nightmare)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		set t=null
	endif
endfunction

function Bane_Nightmare_OnCast takes nothing returns boolean
	if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
		if GetOwningPlayer(GetTriggerUnit())!=GetOwningPlayer(GetSpellTargetUnit())and IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))and(LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetSpellTargetUnit())),139))then
			call InterruptUnit(GetTriggerUnit())
			call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))//n038 -> This target has disablehelp on
		endif
	endif
	return false
endfunction

function Nightmare_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)
	call UnitRemoveAbility(u,'B02F')//B02F -> Nightmare
	call UnitRemoveAbility(u,'A2O9')//A2O9 -> Nightmare End
	call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A04Y',true)//A04Y -> Nightmare
	call Timer_End(t)
	set t = null
	set u = null
endfunction

function Nightmare_End_Check takes nothing returns boolean
	local timer t = null
	local unit u = GetTriggerUnit()
	if GetIssuedOrderId()==String2OrderIdBJ("manashieldon")and GetUnitAbilityLevel(u,'A2O9')>0 then//A2O9 -> Nightmare End
		set t = CreateTimer()
		call TimerStart(t,0,false,function Nightmare_End)
		call SaveUnitHandle(MHT,GetHandleId(t),0,u)
		set t = null
	endif
	set u = null
	return false
endfunction

function N59 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
	call TriggerAddCondition(t,Condition(function Nightmare_End_Check))
	set t=null
endfunction

function Bane_FiendGripUpg_Nightmare takes unit attacker, unit target returns nothing
	local unit u
	if LoadBoolean(MHT,GetHandleId(target),'Grip') then
		if IsUnitEnemy(attacker,GetOwningPlayer(target)) then
			set u=CreateUnit(GetOwningPlayer(attacker),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
			call UnitAddAbility2(u,'A04Y')//A04Y -> Nightmare
			call SetUnitAbilityLevel(u,'A04Y',2)//A04Y -> Nightmare
			call IssueTargetOrderById(u,852227,attacker)
			set u=null
		endif
	endif
endfunction

function PLF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real RLD
	local integer Count=6
	local fogmodifier fm=(LoadFogModifierHandle(HY,h,42))
	if GetUnitAbilityLevel(Source,'A1D9')>0 then//A1D9 -> Fiend's Grip Upgrade
		set Count=8
	endif
	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
		call FogModifierStop(fm)
		call DestroyFogModifier(fm)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SaveBoolean(MHT,GetHandleId(Source),'Grip',false)
		call RemoveFakeDust(Target)
	elseif GetTriggerEvalCount(t)>Count or (GetTriggerEvalCount(t)==1 and GetUnitAbilityLevel(Target,'A3E9')==1) then
		call FogModifierStop(fm)
		call DestroyFogModifier(fm)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call InterruptUnit(Source)
		call SaveBoolean(MHT,GetHandleId(Source),'Grip',false)
		call RemoveFakeDust(Target)
	else
		if GetUnitAbilityLevel(Source,'A1D9')>0 then//A1D9 -> Fiend's Grip Upgrade
			set RLD=RMinBJ(.1*GetUnitState(Target,UNIT_STATE_MAX_MANA),GetUnitState(Target,UNIT_STATE_MANA))
		else
			set RLD=RMinBJ(.05*GetUnitState(Target,UNIT_STATE_MAX_MANA),GetUnitState(Target,UNIT_STATE_MANA))
		endif
		if RLD>0 then
			call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+RLD)
			call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-RLD)
		endif
		if IsDead(Target)==false and GetUnitAbilityLevel(Target,'Bdet')==0 then
			call AddFakeDust(Source,Target)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set fm=null
	return false
endfunction

function Bane_Grip takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local fogmodifier ff=CreateFogModifierRadius(GetOwningPlayer(Source),FOG_OF_WAR_VISIBLE,GetUnitX(Target),GetUnitY(Target),350,true,true)
	call FogModifierStart(ff)
	call UnitRemoveAbility(Target,'B02F')//B02F -> Nightmare
	call UnitRemoveAbility(Target,'BUsp')
	call UnitRemoveAbility(Target,'Bust')
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterTimerEvent(t,0.1,false)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function PLF))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveFogModifierHandle(HY,h,42,ff)
	call SaveBoolean(MHT,GetHandleId(Source),'Grip',GetUnitAbilityLevel(Source,'A1D9')>0)//A1D9 -> Fiend's Grip Upgrade
	call AddFakeDust(Source,Target)
	set Source=null
	set Target=null
	set t=null
	set ff=null
endfunction

function Bane_GripWrapper takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Bane_Grip()
	endif
endfunction

function Bane_Enfeeble_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local unit u = LoadUnitHandle(MHT,info,0)
	call LoDStat_Sub(u,LoadInteger(MHT,info,0),"damageneg")
	call RemoveSavedHandle(MHT,GetHandleId(u),'A04V')//A04V -> Enfeeble
	call Timer_End(t)
	set t = null
	set u = null
endfunction

function Bane_Enfeeble_Start takes unit u returns nothing
	local unit d = GetTriggerUnit()
	local timer t = LoadTimerHandle(MHT,GetHandleId(u),'A04V')//A04V -> Enfeeble
	local integer info = GetHandleId(t)
	local integer amount = 30*GetUnitAbilityLevel(d,'A04V')//A04V -> Enfeeble
	if t==null or GetUnitAbilityLevel(u,'D018')==0 or GetUnitTypeId(d)=='e00E' then//e00E -> Spellcaster
		set t = CreateTimer()
		set info = GetHandleId(t)
		call SaveTimerHandle(MHT,GetHandleId(u),'A04V',t)//A04V -> Enfeeble
		call SaveUnitHandle(MHT,info,0,u)
	else
		call LoDStat_Sub(u,LoadInteger(MHT,info,0),"damageneg")
	endif
	call SaveInteger(MHT,info,0,amount)
	call TimerStart(t,20,false,function Bane_Enfeeble_End)
	call LoDStat_Add(u,amount,"damageneg")
	call Buff_Add(u,'C018','D018',20)
	set d = null
	set t = null
endfunction

function Bane_Enfeeble_Condition takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Bane_Enfeeble_Start(GetSpellTargetUnit())
	endif
endfunction

function Q7F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Count=(LoadInteger(HY,(GetHandleId(Target)),281))
	local boolean Q8F=(LoadBoolean(HY,h,280))
	local real dmg
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SetUnitTurnSpeed(Target,GetUnitDefaultTurnSpeed(Target))
		call SaveInteger(HY,(GetHandleId(Target)),281,0)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SetNapalmFactory(Target,0,0)
	elseif Count==0 then
		call SetUnitTurnSpeed(Target,GetUnitDefaultTurnSpeed(Target))
		call SaveInteger(HY,(GetHandleId(Target)),281,0)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED and Q8F==false then
		if Count>0 and GetUnitAbilityLevel(GetEventDamageSource(),'A1EL')>0 and Source==GetEventDamageSource() and IsRealDamage then//A1EL -> Sticky Napalm
			call SaveBoolean(HY,h,280,(true))
			set dmg=(5+5*GetUnitAbilityLevel(Source,'A1EL'))*Count//A1EL -> Sticky Napalm
			if I48 then
				set dmg=dmg*0.5
			endif
			if IsHeroUnitId(GetUnitTypeId(Target)) then
				set dmg=dmg*0.5
			endif
			if GetEventDamage()>10 or I48 then
				call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\LordofFlameMissile\\LordofFlameMissile.mdl",Target,"chest"))
				call DamageTarget(Source,Target,1,dmg)
			endif
			call SaveBoolean(HY,h,280,(false))
		endif
	else
		call SetUnitTurnSpeed(Target,GetUnitDefaultTurnSpeed(Target)*.3)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function Q9F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real DRD=(LoadReal(HY,(GetHandleId(Target)),675))
	local integer StickyCount=(LoadInteger(HY,(GetHandleId(Target)),281))
	if(TimerGetElapsed(GlobalTimer))-DRD>=8 then
		call SetUnitTurnSpeed(Target,GetUnitDefaultTurnSpeed(Target))
		call SaveInteger(HY,(GetHandleId(Target)),281,0)
		call SetNapalmFactory(Target,0,0)
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function QDF takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetEnumUnit()
	local trigger t
	local integer h
	local integer Level=GetUnitAbilityLevel(Source,'A1EL')//A1EL -> Sticky Napalm
	local integer Count=IMinBJ((LoadInteger(HY,(GetHandleId(Target)),281))+1,10)
	if IsMagicImmune(Target)then
		set Source=null
		set Target=null
		return
	endif
	call SetNapalmFactory(Target,Level,Count)
	call SaveInteger(HY,(GetHandleId(Target)),281,(Count))
	call SaveReal(HY,(GetHandleId(Target)),675,(((TimerGetElapsed(GlobalTimer)))*1.))
	call SetUnitTurnSpeed(Target,GetUnitDefaultTurnSpeed(Target)*.3)
	if IsUnitType(Target,UNIT_TYPE_HERO) then
		call ZW8(GetOwningPlayer(Source),I2S(Count)+"!",2,Target,.026,50,0,255,216)
	endif
	if Count==1 then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveUnitHandle(HY,h,17,(Target))
		call SaveBoolean(HY,h,280,(false))
		call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddCondition(t,Condition(function Q7F))
	endif
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,8,false)
	call TriggerAddCondition(t,Condition(function Q9F))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	set t=null
	set Source=null
	set Target=null
endfunction

function Batrider_StickyNapalm takes nothing returns nothing
	local group g=GetAvailableGroup()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local unit Source=GetTriggerUnit()
	local string s="Objects\\Spawnmodels\\Undead\\UndeadBlood\\UndeadBloodGargoyle.mdl"
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,400,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(g,function QDF)
	call TimedReveal(GetOwningPlayer(Source),2,x,y,500)
	call DestroyEffect(AddSpecialEffect(s,x,y))
	call DestroyEffect(AddSpecialEffect(s,x,y+130))
	call DestroyEffect(AddSpecialEffect(s,x,y-130))
	call DestroyEffect(AddSpecialEffect(s,x+130,y))
	call DestroyEffect(AddSpecialEffect(s,x+130,y+130))
	call DestroyEffect(AddSpecialEffect(s,x+130,y-130))
	call DestroyEffect(AddSpecialEffect(s,x-130,y))
	call DestroyEffect(AddSpecialEffect(s,x-130,y+130))
	call DestroyEffect(AddSpecialEffect(s,x-130,y-130))
	call KillGroup(g)
	set Source=null
endfunction

function Bat_Napalm_Preload takes nothing returns nothing
	local integer i
	set HZ8[1]='A1XC'//A1XC -> Sticky Napalm Slow - Level 1 - Stack 1
	set HZ8[2]='A1XB'//A1XB -> Sticky Napalm Slow - Level 1 - Stack 2
	set HZ8[3]='A1X4'//A1X4 -> Sticky Napalm Slow - Level 1 - Stack 3
	set HZ8[4]='A1X5'//A1X5 -> Sticky Napalm Slow - Level 1 - Stack 4
	set HZ8[5]='A1X6'//A1X6 -> Sticky Napalm Slow - Level 1 - Stack 5
	set HZ8[6]='A1X7'//A1X7 -> Sticky Napalm Slow - Level 1 - Stack 6
	set HZ8[7]='A1XA'//A1XA -> Sticky Napalm Slow - Level 1 - Stack 7
	set HZ8[8]='A1X8'//A1X8 -> Sticky Napalm Slow - Level 1 - Stack 8
	set HZ8[9]='A1X9'//A1X9 -> Sticky Napalm Slow - Level 1 - Stack 9
	set HZ8[10]='A1XD'//A1XD -> Sticky Napalm Slow - Level 1 - Stack 10
	set HA8[1]='A1XM'//A1XM -> Sticky Napalm Slow - Level 2 - Stack 1
	set HA8[2]='A1XE'//A1XE -> Sticky Napalm Slow - Level 2 - Stack 2
	set HA8[3]='A1XF'//A1XF -> Sticky Napalm Slow - Level 2 - Stack 3
	set HA8[4]='A1XG'//A1XG -> Sticky Napalm Slow - Level 2 - Stack 4
	set HA8[5]='A1XH'//A1XH -> Sticky Napalm Slow - Level 2 - Stack 5
	set HA8[6]='A1XI'//A1XI -> Sticky Napalm Slow - Level 2 - Stack 6
	set HA8[7]='A1XJ'//A1XJ -> Sticky Napalm Slow - Level 2 - Stack 7
	set HA8[8]='A1XK'//A1XK -> Sticky Napalm Slow - Level 2 - Stack 8
	set HA8[9]='A1XN'//A1XN -> Sticky Napalm Slow - Level 2 - Stack 9
	set HA8[10]='A1XL'//A1XL -> Sticky Napalm Slow - Level 2 - Stack 10
	set HB8[1]='A1XO'//A1XO -> Sticky Napalm Slow - Level 3 - Stack 1
	set HB8[2]='A1XV'//A1XV -> Sticky Napalm Slow - Level 3 - Stack 2
	set HB8[3]='A1XW'//A1XW -> Sticky Napalm Slow - Level 3 - Stack 3
	set HB8[4]='A1XQ'//A1XQ -> Sticky Napalm Slow - Level 3 - Stack 4
	set HB8[5]='A1XR'//A1XR -> Sticky Napalm Slow - Level 3 - Stack 5
	set HB8[6]='A1XS'//A1XS -> Sticky Napalm Slow - Level 3 - Stack 6
	set HB8[7]='A1XX'//A1XX -> Sticky Napalm Slow - Level 3 - Stack 7
	set HB8[8]='A1XT'//A1XT -> Sticky Napalm Slow - Level 3 - Stack 8
	set HB8[9]='A1XU'//A1XU -> Sticky Napalm Slow - Level 3 - Stack 9
	set HB8[10]='A1XP'//A1XP -> Sticky Napalm Slow - Level 3 - Stack 10
	set HC8[1]='A1XY'//A1XY -> Sticky Napalm Slow - Level 4 - Stack 1
	set HC8[2]='A1XZ'//A1XZ -> Sticky Napalm Slow - Level 4 - Stack 2
	set HC8[3]='A1Y5'//A1Y5 -> Sticky Napalm Slow - Level 4 - Stack 3
	set HC8[4]='A1Y6'//A1Y6 -> Sticky Napalm Slow - Level 4 - Stack 4
	set HC8[5]='A1Y7'//A1Y7 -> Sticky Napalm Slow - Level 4 - Stack 5
	set HC8[6]='A1Y1'//A1Y1 -> Sticky Napalm Slow - Level 4 - Stack 6
	set HC8[7]='A1Y2'//A1Y2 -> Sticky Napalm Slow - Level 4 - Stack 7
	set HC8[8]='A1Y3'//A1Y3 -> Sticky Napalm Slow - Level 4 - Stack 8
	set HC8[9]='A1Y4'//A1Y4 -> Sticky Napalm Slow - Level 4 - Stack 9
	set HC8[10]='A1Y0'//A1Y0 -> Sticky Napalm Slow - Level 4 - Stack 10
	set i=1
	loop
		exitwhen i>10
		call PreloadQueryAdd(HZ8[i])
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>10
		call PreloadQueryAdd(HA8[i])
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>10
		call PreloadQueryAdd(HB8[i])
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>10
		call PreloadQueryAdd(HC8[i])
		set i=i+1
	endloop
endfunction

function QGF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real a=(LoadReal(HY,h,137))
	local real d=(LoadReal(HY,h,138))
	local real x1=(LoadReal(HY,h,6))
	local real y1=(LoadReal(HY,h,7))
	local real x2
	local real y2
	local real x
	local real y
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)>10 then
		call KillTrees(GetUnitX(Target),GetUnitY(Target),200)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set x2=x1+d*Cos(a)
		set y2=y1+d*Sin(a)
		if(IsPointInRegion(RestrictedRegion,((x2)*1.),((y2)*1.)))==false then
			call SaveReal(HY,h,6,((x2)*1.))
			call SaveReal(HY,h,7,((y2)*1.))
			set x=x2
			set y=y2
		else
			set x=x1
			set y=y1
		endif
		if IsUnitType(Target,UNIT_TYPE_HERO) then
			call SetUnitPosition(Target,x,y)
		else
			call SetUnitX(Target,x)
			call SetUnitY(Target,y)
		endif
	endif
	set t=null
	set Target=null
	return false
endfunction

function FlameBreakDamagePeriodicAct takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local integer c=LoadInteger(HY,h,0)
	local unit u=LoadUnitHandle(HY,h,1)
	if c==1 or IsDead(u) or GetUnitAbilityLevel(u,'A37T')==0 then
		if GetUnitAbilityLevel(u,'A37T')!=0 then
			call DamageTarget(LoadUnitHandle(HY,h,0),u,1,LoadReal(HY,h,0))
		endif
		call UnitRemoveAbility(u,'A37T')
		call UnitRemoveAbility(u,'B37T')//B37T -> Flamebreak
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	else
		call DamageTarget(LoadUnitHandle(HY,h,0),u,1,LoadReal(HY,h,0))
		call SaveInteger(HY,h,0,c-1)
	endif
	set t=null
	set u=null
endfunction

function FlameBreakDamagePeriodic takes unit caster, unit target returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,caster)
	call SaveUnitHandle(HY,h,1,target)
	call SaveInteger(HY,h,0,HL8+2)//lvl
	call UnitAddAbility2(target,'A37T')
	call SaveReal(HY,h,0,HL8*5 + 20)
//	call echo(GetUnitName(caster)+" infected "+GetUnitName(target)+" lvl="+I2S(HL8))
	call TimerStart(t,1,true,function FlameBreakDamagePeriodicAct)
	set t=null
endfunction

function QHF takes nothing returns nothing
	local unit Source=H38
	local unit Target=GetEnumUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function QGF))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveReal(HY,h,137,((Atan2(GetUnitY(Target)-H08,GetUnitX(Target)-H18))*1.))
	call SaveReal(HY,h,138,((RMaxIF((400-DistanceBetweenXY(H18,H08,GetUnitX(Target),GetUnitY(Target))),10)/ 10)*1.))
	call SaveReal(HY,h,6,((GetUnitX(Target))*1.))
	call SaveReal(HY,h,7,((GetUnitY(Target))*1.))
	call FlameBreakDamagePeriodic(Source,Target)
	set Source=null
	set Target=null
	set t=null
	call DamageTarget(H38,GetEnumUnit(),1,20+HL8*40)
endfunction

function QIF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real a=(LoadReal(HY,h,137))
	local group g
	local unit Target
	local real x=GetUnitX(Caster)
	local real y=GetUnitY(Caster)
	local real WM3=(LoadReal(HY,h,6))
	local real WN3=(LoadReal(HY,h,7))
	set x=SafeX50(x+36*Cos(a))
	set y=SafeY50(y+36*Sin(a))
	call SetUnitX(Caster,x)
	call SetUnitY(Caster,y)
	set tt_unit1=Caster
	if DistanceBetweenXY(x,y,WM3,WN3)<40 or GetTriggerEvalCount(t)>100 then
		set Target=null
		set x=WM3
		set y=WN3
		set H38=Source
		set HL8=(LoadInteger(HY,h,5))
		set H18=x
		set H08=y
		set g=GetAvailableGroup()
		set tt_unit1=Source
		call GroupEnumUnitsInRange(g,x,y,400,Condition(function NonImmuneEnemyFilterWithAncients))
		call ForGroup(g,function QHF)
		call KillUnit(Caster)
		call KillGroup(g)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	set Caster=null
	set Source=null
	set g=null
	return false
endfunction

function Batrider_FlameBreak takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A19V')//A19V -> Flamebreak
	local unit Caster
	set Caster=CreateUnit(GetOwningPlayer(Source),'h0ED',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)//h0ED -> Flamebreak new projectile
	call SaveReal(HY,h,137,((a)*1.))
	call SaveInteger(HY,h,5,(Level))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveReal(HY,h,6,((x)*1.0))
	call SaveReal(HY,h,7,((y)*1.0))
	call TriggerRegisterTimerEvent(t,.04,true)
	call TriggerAddCondition(t,Condition(function QIF))
	set Source=null
	set Caster=null
	set t=null
endfunction

function QMF takes nothing returns nothing
	local unit Source=H58
	local unit H3D=GetEnumUnit()
	local unit Target
	local group g
	if GetUnitCurrentOrder(H3D)==0 then
		set g=GetAvailableGroup()
		set tt_unit1=H3D
		call GroupEnumUnitsInRange(g,GetUnitX(H3D),GetUnitY(H3D),825,Condition(function DefaultEnemyFilter))
		set Target=FirstOfGroup(g)
		if Target!=null then
			call GroupRemoveUnit(g,Target)
		endif
		if FirstOfGroup(g)==null and Target==Source then
			call IssueTargetOrderById(H3D,ORDER_attack,Target)
		endif
		call KillGroup(g)
		set Target=null
		set g=null
	endif
	set Source=null
	set H3D=null
endfunction

function QNF takes unit Source returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	set H58=Source
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1000,Condition(function DN9))
	call ForGroup(g,function QMF)
	call KillGroup(g)
	set g=null
endfunction

function QOF takes nothing returns nothing
	call DamageTarget(H58,GetEnumUnit(),1,I78)
endfunction

function QPF takes unit Source,integer h,integer Count, integer lvl returns nothing
	local group g1=GetAvailableGroup()
	local group g2=GetAvailableGroup()
	local integer i=0
	set tt_unit1=Source
	loop
		exitwhen i>Count
		call GroupEnumUnitsInRange(g2,LoadReal(HY,h,2300+i),LoadReal(HY,h,2500+i),225,Condition(function DefaultEnemyFilter))
		call GroupAddGroup(g2,g1)
		call GroupClear(g2)
		set i=i+1
	endloop
	call KillGroup(g2)
	if FirstOfGroup(g1)!=null then
		set H58=Source
		set I78=lvl*10-5
		call ForGroup(g1,function QOF)
	endif
	call KillGroup(g1)
	set g1=null
	set g2=null
endfunction

function QQF takes nothing returns boolean
	local unit Source=null
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=LoadInteger(HY,h,34)
	local integer i
	local real x
	local real y
	local integer lvl=LoadInteger(HY,h,0)
	if GetTriggerEvalCount(t)>360 then
		set i=0
		loop
			exitwhen i>Count
			call DestroyEffect(LoadEffectHandle(HY,h,2700 + i))
			set i=i+1
		endloop
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		set t = null
		return false
	endif
	set Source = LoadUnitHandle(HY,h,2)
	set x = GetWidgetX(Source)
	set y = GetWidgetY(Source)
	if udg_ObserverMode then
		call QNF(Source)
	endif
	if DistanceBetweenXY(x,y,LoadReal(HY,h,23),LoadReal(HY,h,24)) >125 then
		set Count=Count+1
		call SaveInteger(HY,h,34,Count)
		call SaveReal(HY,h,23,x*1.)
		call SaveReal(HY,h,24,y*1.)
		call SaveEffectHandle(HY,h,2700+Count,AddSpecialEffect("Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl",x,y))
		call SaveReal(HY,h,2300+Count,x*1.)
		call SaveReal(HY,h,2500+Count,y*1.)
	endif

	if ModuloInteger(GetTriggerEvalCount(t),10)==0 then
		set I48=true
		call QPF(Source,h,Count,lvl)
		set I48=false
	endif

	if IsDead(Source)==false then
		call KillTrees(x,y,100)
	endif

	set Source = null
	set t = null
	return false
endfunction

function QRF takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real x=GetWidgetX(Source)
	local real y=GetWidgetY(Source)
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function QQF))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveEffectHandle(HY,h,2700,AddSpecialEffect("Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl",x,y))
	call SaveReal(HY,h,23,x*1.)
	call SaveReal(HY,h,24,y*1.)
	call SaveReal(HY,h,2300,x*1.)
	call SaveReal(HY,h,2500,y*1.)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	set Source=null
	set t=null
endfunction

function QTF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,false)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	return false
endfunction

function QUF takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,true)
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function QTF))
	call SaveReal(HY,h,6,x*1.)
	call SaveReal(HY,h,7,y*1.)
	set Source=null
	set t=null
endfunction

function Batrider_Firefly takes nothing returns nothing
	if GetUnitTypeId(GetTriggerUnit())!='O017' then//O017 -> Batrider
		call QRF()
		if(GetRandomInt(1,10)==1)then
			call PlaySoundOnUnitBJ(ResQFun,100,GetTriggerUnit())
		endif
	elseif IsTerrainPathable(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),PATHING_TYPE_WALKABILITY)then
		call QUF()
	endif
endfunction

function QWF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local unit Caster=LoadUnitHandle(HY,h,19)
	local real d=DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
	local real a
	local real DP9=LoadReal(HY,h,57)
	local real x0=LoadReal(HY,h,282)
	local real y0=LoadReal(HY,h,283)
	local real x1
	local real y1
	local boolean agh=LoadBoolean(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)>R2I(20*DP9)then
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(Caster)
		call SetUnitPathing(Target,true)
		call KillTrees(GetUnitX(Target),GetUnitY(Target),175)
		if agh==false then
			call UnitRemoveAbility(Source,'Abun')//Abun -> Cargo Hold (Orc Burrow)
		endif
	else
		call SetUnitX(Caster,GetUnitX(Source))
		call SetUnitY(Caster,GetUnitY(Source))
		if agh and ModuloInteger(GetTriggerEvalCount(t),20)==0 then
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl",Target,"chest"))
			call DamageTarget(Source,Target,1,50+25*LoadInteger(HY,h,0))
		endif
		if DistanceBetweenXY(x0,y0,GetUnitX(Source),GetUnitY(Source))>400 then
			call DestroyEffect(LoadEffectHandle(HY,h,32))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call KillUnit(Caster)
			call SetUnitPathing(Target,true)
			call KillTrees(GetUnitX(Target),GetUnitY(Target),175)
			if agh==false then
				call UnitRemoveAbility(Source,'Abun')//Abun -> Cargo Hold (Orc Burrow)
			endif
		else
			call SaveReal(HY,h,282,GetUnitX(Source)*1.)
			call SaveReal(HY,h,283,GetUnitY(Source)*1.)
			if d>300 then
				set a=Atan2(GetUnitY(Target)-GetUnitY(Source),GetUnitX(Target)-GetUnitX(Source))
				set x1=GetUnitX(Source)+300*Cos(a)
				set y1=GetUnitY(Source)+300*Sin(a)
				if(IsPointInRegion(RestrictedRegion,x1*1.,y1*1.))==false then
					call SetUnitX(Target,x1)
					call SetUnitY(Target,y1)
				endif
			endif
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set Caster=null
	return false
endfunction

function QXF takes unit Source,unit Target returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'u00Y',GetUnitX(Source),GetUnitY(Source),0)//u00Y -> Lasso
	local integer Level=GetUnitAbilityLevel(Source,'A19O')+GetUnitAbilityLevel(Source,'A1MV')//A19O -> Flaming Lasso
	local boolean agh=GetUnitAbilityLevel(Source,'A1MV')>0
	if IsUnitType(Source,UNIT_TYPE_HERO)==false then
		if HaveSavedHandle(HY,GetHandleId(Source),0) then
			set Source=LoadUnitHandle(HY,GetHandleId(Source),0)
		endif
	endif
	if agh==false then
		call UnitAddAbility2(Source,'Abun')//Abun -> Cargo Hold (Orc Burrow)
	endif
	call SaveBoolean(HY,h,0,agh)
	call SaveInteger(HY,h,0,Level)
	call UnitAddAbility2(Caster,'A19N')//A19N -> Fire Lasso leash
	call SetUnitAbilityLevel(Caster,'A19N',Level)//A19N -> Fire Lasso leash
	call IssueTargetOrderById(Caster,852480,Target)
	call SetUnitPathing(Caster,false)
	call SetUnitPathing(Target,false)
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function QWF))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveUnitHandle(HY,h,19,Caster)
	call SaveReal(HY,h,57,(2.5+Level*.5)*1.)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Human\\AerialShackles\\AerialShacklesTarget.mdl",Target,"chest"))
	call SaveReal(HY,h,282,GetUnitX(Source)*1.)
	call SaveReal(HY,h,283,GetUnitY(Source)*1.)
	set t=null
	set Caster=null
endfunction

function Batrider_FlamingLasso takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call QXF(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function Batrider_FlamingLassoWrapper takes nothing returns nothing
	local timer t
	local integer h
	if IsBlocked(GetSpellTargetUnit())==false and GetUnitTypeId(GetSpellTargetUnit())!='n00L' then//n00L -> Roshan
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		call TimerStart(t,0,false,function Batrider_FlamingLasso)
		set t=null
	endif
endfunction

function QZF takes unit Source,unit Target,real QQE returns nothing
	call SetWidgetLife(Source,GetWidgetLife(Source)+GetUnitState(Target,UNIT_STATE_MAX_LIFE)*QQE)
	call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\HeroBloodElfBlood.mdl",Source,"overhead"))
endfunction

function QAF takes nothing returns boolean
	if IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'A0LE')>0 and IsUnitEnemy(I88,GetOwningPlayer(GetFilterUnit()))then//A0LE -> Blood Bath, QP1Y -> Blood Bath
		call QZF(GetFilterUnit(),I88,GetUnitAbilityLevel(GetFilterUnit(),'A0LE')*.1*.5)//A0LE -> Blood Bath, QP1Y -> Blood Bath
	endif
	return false
endfunction

function QBF takes unit Source,unit Target,integer Level returns nothing
	local group g=GetAvailableGroup()
	set I88=Target
	call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),350,Condition(function QAF))
	call KillGroup(g)
	set I88=null
	set g=null
endfunction

function BS_BloodBath_Clear takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer lvl=LoadInteger(HY,h,0)
	local boolean ishero=LoadBoolean(HY,h,0)
	local integer bonus1=lvl*10
	local integer bonus2=lvl*5
	if ishero then
		set bonus1=bonus1*2
		set bonus2=bonus2*2
	endif
	call LoDStat_Sub(u,bonus1,"attack")
	call LoDStat_Sub(u,bonus2,"damage")
	call UnitRemoveAbility(u,'A33M')
	call UnitRemoveAbility(u,'B0GY')//B0GY -> Blood bath
	call SaveBoolean(MHT,GetHandleId(u),'A0LE',false)//A0LE -> Blood Bath
	call RemoveSavedHandle(MHT,GetHandleId(u),'A0LE')//A0LE -> Blood Bath
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set u=null
	set t=null
endfunction

function BS_BloodBath_Start takes unit u, integer lvl, boolean ishero returns nothing
	local integer oldlvl
	local timer t
	local real r
	local integer h=GetHandleId(u)
	local boolean b=LoadBoolean(MHT,h,'A0LE')//timer exists?//A0LE -> Blood Bath
	local integer oldbonus1
	local integer oldbonus2
	local real duration=5
	local integer heromult=1
	if ishero then
		set duration=20
		set heromult=2
	endif
	if b then
		set t=LoadTimerHandle(MHT,h,'A0LE')//A0LE -> Blood Bath
		set oldlvl=LoadInteger(HY,GetHandleId(t),0)
		
		set oldbonus1=oldlvl*10
		set oldbonus2=oldlvl*5
		if LoadBoolean(HY,GetHandleId(t),0) then
			set oldbonus1=oldbonus1*2
			set oldbonus2=oldbonus2*2
		endif
		if TimerGetRemaining(t)<duration or oldbonus1<lvl*10*heromult then
			call TimerStart(t,duration,false,function BS_BloodBath_Clear)
			if oldbonus1<lvl*10*heromult then
				call LoDStat_Add(u,lvl*10*heromult-oldbonus1,"attack")
				call LoDStat_Add(u,lvl*5*heromult-oldbonus2,"damage")
				call SaveInteger(HY,GetHandleId(t),0,lvl)
				call SaveBoolean(HY,GetHandleId(t),0,ishero)
			endif
		endif
	else
		call SaveBoolean(MHT,h,'A0LE',true)//A0LE -> Blood Bath
		set t=CreateTimer()
		call TimerStart(t,duration,false,function BS_BloodBath_Clear)
		call SaveBoolean(HY,GetHandleId(t),0,ishero)
		call SaveInteger(HY,GetHandleId(t),0,lvl)
		call SaveUnitHandle(HY,GetHandleId(t),0,u)
		call SaveTimerHandle(MHT,h,'A0LE',t)//A0LE -> Blood Bath
		call LoDStat_Add(u,lvl*10*heromult,"attack")
		call LoDStat_Add(u,lvl*5*heromult,"damage")
		call UnitAddAbility2(u,'A33M')
	endif
	set t=null
endfunction

function BS_BloodBath takes unit Source, unit Target returns nothing
	local integer lvl
	local real mult=1.
	if GetUnitTypeId(Source)=='e00E' or IsUnitType(Source,UNIT_TYPE_HERO)==false then//e00E -> Spellcaster
		set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
	endif
	set lvl=GetUnitAbilityLevel(Source,'A0LE')//A0LE -> Blood Bath, QP1Y -> Blood Bath
	if IsUnitIllusion(Target)==false and IsUnitType(Target,UNIT_TYPE_STRUCTURE)==false and Target!=Roshan then
		if IsUnitType(Source,UNIT_TYPE_MELEE_ATTACKER)==false then
			set mult=0.5
		endif
		if IsUnitType(Target,UNIT_TYPE_HERO)==false then
			if lvl>0 then
				call BS_BloodBath_Start(Source,lvl,false)
				call QZF(Source,Target,(lvl*.05+.05)*mult)
			endif
		else
			if lvl>0 then
				call BS_BloodBath_Start(Source,lvl,true)
				call QZF(Source,Target,lvl*.1*mult)
				
			else
				call QBF(Source,Target,lvl)
			endif
		endif
	endif
endfunction

function Q3F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Level=(LoadInteger(HY,h,5))
	local real LastX=(LoadReal(HY,h,23))
	local real LastY=(LoadReal(HY,h,24))
	local real x=GetUnitX(Target)
	local real y=GetUnitY(Target)
	local real d=SquareRoot((LastX-x)*(LastX-x)+(LastY-y)*(LastY-y))
	local real dmg=.2*Level*d
	local integer tic=(LoadInteger(HY,h,25))
	if d>1300 then
		set dmg=0
	endif
	if dmg>5 then
		call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Target,"origin"))
	endif
	if dmg>0 and IsDead(Target)==false then
		call DamageTarget(Source,Target,7,dmg)
	endif
	call SaveReal(HY,h,23,((x)*1.))
	call SaveReal(HY,h,24,((y)*1.))
	call SaveInteger(HY,h,25,(tic+1))
	if IsDead(Target)then
		call UnitRemoveAbility(Target,'A0IH')//A0IH -> Rupture
		call UnitRemoveAbility(Target,'B08L')//B08L -> |cffff0000Rupture|r
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif tic>4*(6+Level)then
		call UnitRemoveAbility(Target,'A0IH')//A0IH -> Rupture
		call UnitRemoveAbility(Target,'B08L')//B08L -> |cffff0000Rupture|r
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function Q6F takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A0LH')//A0LH -> Rupture
	call UnitAddAbility2(Target,'A0IH')//A0IH -> Rupture
	call SetUnitAbilityLevel(Target,'A0IH',Level)//A0IH -> Rupture
	call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Target,"chest"))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,23,((GetUnitX(Target))*1.))
	call SaveReal(HY,h,24,((GetUnitY(Target))*1.))
	call SaveInteger(HY,h,25,0)
	call TriggerRegisterTimerEvent(t,.25,true)
	call TriggerAddCondition(t,Condition(function Q3F))
	call DamageTarget(Source,Target,6,50+100*Level)
	set Source=null
	set Target=null
	set t=null
endfunction

function BS_Rupture takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false and IsCourier(GetSpellTargetUnit())==false then
		call Q6F()
	endif
endfunction

function Thirst_IsUnitLowHP takes unit u returns boolean
	local real life
	local real limit=.3
	if IsDead(u) then
		return false
	endif
	if IsDead(IF8)==false then
		set life = GetWidgetLife(u)/GetUnitState(u,UNIT_STATE_MAX_LIFE)
		return 0.25 > life or (life<limit and GenericCondition_IsDotAInvis(u)==false)
	endif
	return false
endfunction

function Thirst_StickDummiesTo takes unit u returns nothing
	local unit dummy
	local integer h=GetHandleId(u)
	if(LoadBoolean(HeroStats,h,24)==false)then//dummy not created yet
		call SaveBoolean(HeroStats,h,24,true)
		set dummy=CreateUnit(GetOwningPlayer(IF8),'hBST',GetUnitX(u),GetUnitY(u),0)
		call SaveUnitHandle(HeroStats,h,24,dummy)
		call SetUnitMoveSpeed(dummy,522)
		call IssueTargetOrderById(dummy,ORDER_move,u)
	else
		set dummy=LoadUnitHandle(HeroStats,h,24)
		call SetUnitX(dummy,GetUnitX(u))
		call SetUnitY(dummy,GetUnitY(u))
		
		if GenericCondition_IsDotAInvis(u) then
			if GetUnitAbilityLevel(u,'A1HX')>0 then//A1HX -> Shadow Dance 2
				call UnitRemoveAbility(dummy,'A30X')
			elseif GetUnitAbilityLevel(dummy,'A30X')==0 then
				call UnitAddAbility(dummy,'A30X')
			endif
		else
			if GetUnitAbilityLevel(dummy,'A30X')>0 then
				call UnitRemoveAbility(dummy,'A30X')
			endif
		endif
	endif
	set dummy=null
endfunction

function Thirst_DeleteDummiesFrom takes unit u returns nothing
	local integer h=GetHandleId(u)
	if(LoadBoolean(HeroStats,h,24))then//dummy was created
		call SaveBoolean(HeroStats,h,24,false)
		call SetUnitPosition(LoadUnitHandle(HeroStats,h,24),7536,-7632)
		call KillUnit(LoadUnitHandle(HeroStats,h,24))
		call UnitRemoveAbility(u,'B0EY')
	endif
endfunction

function Q2F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer Level=GetUnitAbilityLevel(Source,'A0I8')//A0I8 -> Strygwyr's Thirst, QP1Z -> Strygwyr's Thirst
	local integer damage=Level*10-5
	local boolean BonusHere=LoadBoolean(HY,h,0)
	local integer BonusVal=LoadInteger(HY,h,0)
	local integer msbonus=LoadInteger(HY,h,2)
	local integer count=0
	local integer msboost=0
	local integer fpi=1//first player index
	local integer lpi=5//last player index
	local integer i
	local unit u
	local boolean b=IsSentinel(GetOwningPlayer(Source))
	local boolean br=GetUnitAbilityLevel(Source,'A36D')==1
	set i=fpi
	loop
		if b then
			set u=udg_Hero[GetPlayerId(Scourges[i])]
		else
			set u=udg_Hero[GetPlayerId(Sentinels[i])]
		endif
		if u!=null then
			set IF8=Source
			if(Thirst_IsUnitLowHP(u)) and br==false then
				call Thirst_StickDummiesTo(u)
				set count=count+1
			elseif(LoadBoolean(HeroStats,GetHandleId(u),24))then
				call Thirst_DeleteDummiesFrom(u)
			endif
		endif
		set i=i+1
		exitwhen i>lpi
	endloop
	if count==0 then
		call SaveInteger(HY,h,2,0)
		call UnitRemoveAbility(Source,'A214')
		if BonusHere then
			call LoDStat_Sub(Source,BonusVal,"damage")
			call SaveBoolean(HY,h,0,false)
		endif
		call SaveInteger(HeroStats,GetHandleId(Source),'A214',0)
	else
		set damage=damage*count
		if BonusHere==false then
			call LoDStat_Add(Source,damage,"damage")
			call SaveBoolean(HY,h,0,true)
			call SaveInteger(HY,h,0,damage)
		elseif BonusVal!=damage then
			call LoDStat_Sub(Source,BonusVal,"damage")
			call LoDStat_Add(Source,damage,"damage")
			call SaveInteger(HY,h,0,damage)
		endif
		set msboost=Level*7*count
		if msboost!=msbonus then
			call SaveInteger(HY,h,2,msboost)
		endif
		call SaveInteger(HeroStats,GetHandleId(Source),'A214',count)
		call SaveInteger(HeroStats,GetHandleId(Source),'A215',Level)//A215 -> Blur - Evasion 3
		call UnitAddAbility2(Source,'A214')
	endif
	set t=null
	set Source=null
	set u=null
	return false
endfunction

function BS_RemoveSpeedCap_Moveunit takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer bonus=LoadInteger(HY,h,0)
	local real x
	local real y
	local real dx
	local real dy
	local real angle
	local real ms
	local real d
	local real angle2
	local real i=1
	local real currentspeed=GetUnitDefaultMoveSpeed(u)+GetUnitOffsetSpeed(u)
	if currentspeed>1000 then
		set currentspeed=1000-522
	endif
	if LoadBoolean(HY,h,0) then
		set bonus=100
	endif
	call SaveReal(HeroStats,GetHandleId(u),99,R2I(currentspeed*bonus/100))
	if bonus>0 and IsDead(u)==false then
		set x=GetUnitX(u)
		set y=GetUnitY(u)
		set dx=LoadReal(HY,h,10)
		set dy=LoadReal(HY,h,11)
		set d=DistanceBetweenXY(dx,dy,x,y)
		if LoadBoolean(HeroStats,GetHandleId(u),99)==false then//not triggered
			if (d<100 and d>1) and GetUnitCurrentOrder(u)!=851993 and GetUnitCurrentOrder(u)!=851972 and GetUnitCurrentOrder(u)!=851973 then//not holded, stopped or stunned
				set angle=Atan2(y-dy,x-dx)
				set ms=currentspeed*bonus*ThirstInterval/100
				call SaveReal(HeroStats,GetHandleId(u),99,R2I(ms*(1/ThirstInterval)))
				call SetUnitX(u,SafeX50(x+ms*Cos(angle)))
				call SetUnitY(u,SafeY50(y+ms*Sin(angle)))
			endif
		else
			call SaveBoolean(HeroStats,GetHandleId(u),99,false)
		endif
		call SaveReal(HY,h,10,GetUnitX(u))
		call SaveReal(HY,h,11,GetUnitY(u))
	endif
	set t=null
	set u=null
endfunction

function BS_RemoveSpeedCap takes unit u, integer bonus,boolean isVoid returns nothing
	local timer t
	if LoadBoolean(HeroStats,GetHandleId(u),'A214')==false then
		call SaveBoolean(HeroStats,GetHandleId(u),'A214',true)//timer created
		set t=CreateTimer()
		call TimerStart(t,ThirstInterval,true,function BS_RemoveSpeedCap_Moveunit)
		call SaveUnitHandle(HY,GetHandleId(t),0,u)
		call SaveReal(HY,GetHandleId(t),10,GetUnitX(u))
		call SaveReal(HY,GetHandleId(t),11,GetUnitY(u))
		call SaveBoolean(HY,GetHandleId(t),100,true)
		call SaveTimerHandle(HeroStats,GetHandleId(u),'A214',t)
	else
		set t=LoadTimerHandle(HeroStats,GetHandleId(u),'A214')
	endif
	call SaveInteger(HY,GetHandleId(t),0,bonus)
	call SaveBoolean(HY,GetHandleId(t),0,isVoid)
	if isVoid then
		set bonus=100
	endif
	if bonus==0 then
		call PauseTimer(t)
		call SaveReal(HeroStats,GetHandleId(u),99,0)
		call SaveBoolean(HY,GetHandleId(t),100,false)
	elseif LoadBoolean(HY,GetHandleId(t),100)==false then
		call TimerStart(t,ThirstInterval,true,function BS_RemoveSpeedCap_Moveunit)
		call SaveBoolean(HY,GetHandleId(t),100,true)
	endif
	set t=null
endfunction

function BS_update_dummies takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer i=1
	local integer count=LoadInteger(HeroStats,GetHandleId(u),'A214')
	local integer Level=LoadInteger(HeroStats,GetHandleId(u),'A215')//A215 -> Blur - Evasion 3
	local integer bonus=(10*Level-5)*count
	loop
		if(LoadBoolean(HeroStats,GetHandleId(udg_Hero[i]),24))then
			call SetUnitX(LoadUnitHandle(HeroStats,GetHandleId(udg_Hero[i]),24),GetUnitX(udg_Hero[i]))
			call SetUnitY(LoadUnitHandle(HeroStats,GetHandleId(udg_Hero[i]),24),GetUnitY(udg_Hero[i]))
			call IssueTargetOrderById(LoadUnitHandle(HeroStats,GetHandleId(udg_Hero[i]),24),ORDER_move,udg_Hero[i])
		endif
		set i=i+1
		if i==6 then
			set i=7
		endif
		exitwhen i>11
	endloop
	call CustomSpeed(u,bonus,0)
	set t=null
	set u=null
endfunction

function Bloodseeker_Thrist_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call TriggerRegisterTimerEvent(t,.25,true)
	call TriggerAddCondition(t,Condition(function Q2F))
	call SaveUnitHandle(HY,h,2,(Source))
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddCondition(t,Condition(function BS_update_dummies))
	call SaveUnitHandle(HY,GetHandleId(t),0,Source)
	set t=null
	set Source=null
endfunction

function BS_Bloodrage_Action takes nothing returns nothing
	local unit Target
	local unit Dummy
	if IsBlocked(GetSpellTargetUnit())==false or IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) then
		set Target=GetSpellTargetUnit()
		set Dummy=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
		call UnitAddAbility(Dummy,'A2TN')
		call SaveUnitHandle(HY,GetHandleId(Dummy),0,GetTriggerUnit())
		call IssueTargetOrderById(Dummy,852111,Target)
		call RemoveSavedHandle(HY,GetHandleId(Dummy),0)
	endif
	set Target=null
	set Dummy=null
endfunction

function BS_Bloodrage_StopCastInit takes nothing returns nothing
	if GetSpellTargetUnit()!=GetTriggerUnit()and IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))and(LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetSpellTargetUnit())),139))then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))//n038 -> This target has disablehelp on
	endif
endfunction

function RDF takes nothing returns boolean
	return GetUnitTypeId(GetSummonedUnit())=='o003'//o003 -> Spin Web
endfunction

function REF takes nothing returns nothing
	local unit RFF=GetSummonedUnit()
	local unit RGF=udg_Hero[GetPlayerId(GetOwningPlayer(GetSummoningUnit()))]
	local integer h=GetHandleId(RGF)
	local integer Level=GetUnitAbilityLevel(RGF,'Z234') //A0BG//Z234 -> Spin Web
	local integer RHF=(LoadInteger(HY,h,279))
	local unit RIF=(LoadUnitHandle(HY,h,(1400+1)))
	local integer x=1
	set RHF=RHF+1
	call SetUnitVertexColorBJ(RFF,100,100,100,85)
	call UnitAddAbility2(RFF,'Aloc')//Aloc -> Locust
	call SaveUnitHandle(HY,h,(1400+RHF),(RFF))
	if(RHF>Level*2)then
		call KillUnit(RIF)
		loop
			exitwhen x==RHF
			call SaveUnitHandle(HY,h,(1400+x),((LoadUnitHandle(HY,h,(1400+x+1)))))
			set x=x+1
		endloop
		set RHF=RHF-1
	endif
	call SaveInteger(HY,h,279,(RHF))
	call SetUnitAbilityLevel(RFF,'A0BF',Level)//A0BF -> Web Bonus
	set RFF=null
	set RGF=null
	set RIF=null
endfunction

function LoDSpinWeb_Cast takes nothing returns nothing
	local unit RFF=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'o003',GetSpellTargetX(),GetSpellTargetY(),0)//o003 -> Spin Web
	local unit RGF=udg_Hero[GetPlayerId(GetOwningPlayer(RFF))]
	local integer h=GetHandleId(RGF)
	local integer Level=GetUnitAbilityLevel(RGF,'Z234') //A0BG//Z234 -> Spin Web
	local integer RHF=(LoadInteger(HY,h,279))
	local unit RIF=(LoadUnitHandle(HY,h,(1400+1)))
	local integer x=1
	call SetUnitAnimation(RFF,"birth")
	call QueueUnitAnimation(RFF,"stand")
	set RHF=RHF+1
	call SetUnitVertexColorBJ(RFF,100,100,100,85)
	call UnitAddAbility2(RFF,'Aloc')//Aloc -> Locust
	call SaveUnitHandle(HY,h,(1400+RHF),(RFF))
	if(RHF>Level*2)then
		call KillUnit(RIF)
		loop
			exitwhen x==RHF
			call SaveUnitHandle(HY,h,(1400+x),((LoadUnitHandle(HY,h,(1400+x+1)))))
			set x=x+1
		endloop
		set RHF=RHF-1
	endif
	call SaveInteger(HY,h,279,(RHF))
	call SetUnitAbilityLevel(RFF,'A0BF',Level)//A0BF -> Web Bonus
	set RFF=null
	set RGF=null
	set RIF=null
endfunction


function OE9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function RDF))
	call TriggerAddAction(t,function REF)
	set t=null
endfunction

function Brood_WebAllies takes nothing returns boolean
	return GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(BroodWebTemp) and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0//
endfunction

function Brood_Web_OutOfRange takes nothing returns nothing
	local real x
	local real y
	local unit web
	local integer i=1
	local unit u
	local boolean b=false
	set u=udg_Hero[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]
	if u!=null then
		loop
			set web=LoadUnitHandle(HY,GetHandleId(u),1400+i)
			if web!=null then
				set x=GetUnitX(web)
				set y=GetUnitY(web)
				if(DistanceBetweenXY(x,y,GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()))<875)then
					set b=true
				endif
			else 
				set i=9
			endif
			set i=i+1
			exitwhen i>9 or b
		endloop
	endif
	if b==false then
		if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)then
			call UnitRemoveAbility(GetEnumUnit(),'A021')//A021 -> Permanent Invisibility
		else
			call UnitRemoveAbility(GetEnumUnit(),'A29C')//A29C -> Permanent Invisibility
		endif
		call UnitRemoveAbility(GetEnumUnit(),'B01C')//B01C -> Hidden In a Web
		call SetUnitPathing(GetEnumUnit(),true)
	endif
	set web=null
	set u=null
endfunction

function Brood_Web_InRange takes nothing returns nothing
	local unit u=GetEnumUnit()
	if IsUnitType(u,UNIT_TYPE_HERO)then
		if GetUnitAbilityLevel(u,'A021')==0 then//A021 -> Permanent Invisibility
			call RemoveEndlessFadetime(u)
			call UnitAddAbility(u,'A021')//A021 -> Permanent Invisibility
		endif
	else
		if GetUnitAbilityLevel(u,'A29C')==0 then//A29C -> Permanent Invisibility
			
			call UnitAddAbility(u,'A29C')//A29C -> Permanent Invisibility
		endif
	endif
	call SetUnitPathing(u,LastTimeDamaged_ForDagger[GetPlayerId(GetOwningPlayer(u))]+3 > TimerGetElapsed(GlobalTimer) )
	set u=null
endfunction

function Brood_WebDuration takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local group g
	local group gg
	local unit u
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call DestroyGroup(LoadGroupHandle(HY,h,1))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if LoadBoolean(HY,h,0)==false then
			set g=CreateGroup()
			call SaveBoolean(HY,h,0,true)
			call SaveGroupHandle(HY,h,1,g)
		endif
		set u=LoadUnitHandle(HY,h,0)
		set g=LoadGroupHandle(HY,h,1)
		
		set gg=GetAvailableGroup()
		set BroodWebTemp=u
		call GroupEnumUnitsInRange(gg,GetUnitX(u),GetUnitY(u),900,Condition(function Brood_WebAllies))
		call GroupRemoveGroup(gg,g)//
		set BroodWebTemp=u
		call ForGroup(g,function Brood_Web_OutOfRange)
		call ForGroup(gg,function Brood_Web_InRange)
		call GroupClear(g)
		call GroupAddGroup(gg,g)
		call KillGroup(gg)
		set gg=null
	endif
	set t=null
	set g=null
	set u=null
endfunction

function Brood_WebDecected takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.3,true)
	call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function Brood_WebDuration))
	call SaveUnitHandle(HY,h,0,GetTriggerUnit())
	call SaveBoolean(HY,h,0,false)
	set t=null
endfunction

function Brood_RegisterSpinWeb takes nothing returns nothing
	if GetUnitTypeId(GetTriggerUnit())=='o003' then//o003 -> Spin Web
		call Brood_WebDecected()
	endif
endfunction

function Brood_RegisterSpinWebAppears takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddCondition(t,Condition(function Brood_RegisterSpinWeb))
	set t=null
endfunction

function RQF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetUnitAbilityLevel(Hero,'A0WR')==0 or GetTriggerEvalCount(t)>=5*14 then
		if IsDead(Hero)==false then
			call UnitRemoveAbility(Hero,'A0WR')//A0WR -> Insatiable Hunger Container
			call UnitRemoveAbility(Hero,'B01E')//B01E -> Insatiable Hunger
		endif
		//call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Hero=null
	return false
endfunction

function Brood_Hungerold takes nothing returns nothing
//	call UnitAddAbilityTimedExF(GetTriggerUnit(),'A0WR',1,14.,'B01E')
//	call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0WW')
//	call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0WW')
//	call LoDStat_Add(GetTriggerUnit(),,"damage")
endfunction

function Func2801 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,(h),14))
	local integer c=LoadInteger(HY,h,1)+1
	if GetUnitAbilityLevel(u,'A0WW')==0 or c>5*14 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		//call echo(B2S(GetUnitAbilityLevel(u,'A0WR')==0)+" "+B2S(c>5*14)+" "+B2S(GetTriggerEventId()==EVENT_WIDGET_DEATH))
		call LoDStat_Sub(u,LoadInteger(HY,h,0),"damage")
		call UnitRemoveAbility(u,'A0WW')//A0WR -> Insatiable Hunger Container
		call UnitRemoveAbility(u,'B01E')//B01E -> Insatiable Hunger
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	else
		call SaveInteger(HY,h,1,c)
	endif
//	call echo(I2S(c))
	set t=null
	set u=null
	return false
endfunction

function Brood_Hunger takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A0WQ')//A0WQ -> Insatiable Hunger
	local integer dmg
	if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) then
		set dmg=60+20*lvl
	else
		set dmg=50+10*lvl
	endif
	call FlushChildHashtable(HY,h)
	call TriggerRegisterTimerEvent(t,0.2,true)
	call TriggerRegisterDeathEvent(t,u)
	call TriggerAddCondition(t,Condition(function Func2801))
	call SaveUnitHandle(HY,(h),14,(u))
	call UnitAddAbility2(u,'A0WW')//A0WR -> Insatiable Hunger Container
	call LoDStat_Add(u,dmg,"damage")
	call SaveInteger(HY,h,0,dmg)
//	call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A0WR',false)//A0WR -> Insatiable Hunger Container
	call UnitMakeAbilityPermanent(u,true,'A0WW')
	set t=null
	set u=null
endfunction

function BroodPassive takes unit attacker, unit target returns nothing
	call UnitAddAbilityTimedExF(target,'A3PV'-1+GetUnitAbilityLevel(attacker,'Q0BK'),1,2,'B01D')
	call EvasionSourceActivate(EVASION_DEBUFF_BITE,2.5)
endfunction

function BroodPassiveWrapper takes nothing returns nothing
	if (GetUnitAbilityLevel(UDSG_Attacker,'Q0BK')>0) and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0  and GetUnitAbilityLevel(UDSG_Target,'A04R')==0 then//Q0BK -> Incapacitating Bite, QP29 -> Incapacitating Bite hidden, 
		call BroodPassive(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function BroodHungerWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'A0WW')>0 and IsUnitIllusion(UDSG_Target)==false and GetUnitAbilityLevel(UDSG_Target,'A04R')==0 then
		if IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER) then
			call SetWidgetLife(UDSG_Attacker,GetWidgetLife(UDSG_Attacker)+GetEventDamage()*(GetUnitAbilityLevel(UDSG_Attacker,'A0WR')*0.2+0.4))
		else
			call SetWidgetLife(UDSG_Attacker,GetWidgetLife(UDSG_Attacker)+GetEventDamage()*(GetUnitAbilityLevel(UDSG_Attacker,'A0WR')*0.1+0.4))
		endif
	endif
endfunction

function Brood_SpawnSpiderlingsLand takes nothing returns boolean
	local unit Source=tt_unit1
	local unit Target=tt_unit2
	local integer lvl=GetUnitAbilityLevel(Source,'A0BH')//A0BH -> Spawn Spiderlings
	local boolean reflected=false
	if lvl==0 then
		set lvl=GetUnitAbilityLevel(Target,'A0BH')//A0BH -> Spawn Spiderlings
		set reflected=true
	endif
	if lvl!=0 then
		call UnitAddAbilityTimedExF(Target,'A3B8',lvl,2,'B3B8')//B3B8 -> Parasite
		//call echo("added")
		call AddTimedValueToUnit(Target,'A3B8',GetPlayerId(GetOwningPlayer(Source)),2)
		call DamageTarget(Source,Target,1,lvl*75)
		
		if GetUnitAbilityLevel(Target,'A3E9')==1 and IsUnitType(Source,UNIT_TYPE_HERO) and reflected==false and IsMagicImmune(Source)==false then
			if IsBlocked(Source)==false then
				call LotusOrbFX(Target)
				call AddProjectile(Target,Source,'h07V',"Brood_SpawnSpiderlingsLand",1200,true)//h07V -> Ghost Potion
			else
				call RemoveLinkenBuff(Source)
			endif
		endif
	endif
	set Source=null
	set Target=null
	return false
endfunction

function Brood_SpawnSpiderlings takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call AddProjectile(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1),'h07V',"Brood_SpawnSpiderlingsLand",1200,true)//h07V -> Ghost Potion
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
endfunction

function Brood_SpawnSpiderlingsWrapper takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,GetTriggerUnit())
	call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
	call TimerStart(t,0,false,function Brood_SpawnSpiderlings)
	set t=null
endfunction

function LittleSpidersEntering takes unit u returns nothing
	local integer i=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A0A8')
	if i>0 then
		if GetUnitTypeId(u)=='n019'then//spiderling
			call UnitAddAbility3(u,'A3IT',i)
			call UnitAddAbility3(u,'A3IR',i)
		elseif i>1 then
			call UnitAddAbility3(u,'A3IS',i-1)
		endif
	endif
endfunction

function Chaos_Bolt_Damage takes nothing returns boolean
	local texttag text
	local unit u
	local trigger trig = GetTriggeringTrigger()
	local integer info = GetHandleId(trig)
	local real i
	local real d
	
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		call FlushChildHashtable(MHT,info)
		call CleanTrigger(trig)
	elseif GetEventDamageSource()==LoadUnitHandle(MHT,info,0) then
		call DisableTrigger(trig)
		set text = CreateTextTag()
		set d = LoadReal(MHT,info,1)
		set i = LoadReal(MHT,info,0)
		set u = LoadUnitHandle(MHT,info,2)
		if GetUnitAbilityLevel(u,'A3E9')==1 and IsMagicImmune(LoadUnitHandle(MHT,info,1))==false and GetUnitAbilityLevel(LoadUnitHandle(MHT,info,1),'Aloc')==0 then//Aloc -> Locust
			if LoadBoolean(MHT,info,0)==false then
				call SaveUnitHandle(TempHash,'A3E9',0,u)
				call SaveUnitHandle(TempHash,'A3E9',1,LoadUnitHandle(MHT,info,1))
				call SaveInteger(TempHash,'A3E9',0,LoadInteger(MHT,info,1))
				call ExecuteFunc("Chaos_Bolt_WrapWrapperLotus")
			endif
		endif
		
		call StunTargetLoD(u,i)
		call SetTextTagText(text,"+"+I2S(R2I(d)),.025) //damage
		call SetTextTagPosUnit(text,u,10)
		call SetTextTagColor(text,255,0,0,255)
		call SetTextTagVelocity(text,0,.0355)
		call SetTextTagFadepoint(text,2)
		call SetTextTagPermanent(text,false)
		call SetTextTagLifespan(text,2)
		
		call TextTagOnUnit(R2SW(i,1,1),i,u,.03,127,127,255,255) //stun
		
		call DamageTarget(LoadUnitHandle(MHT,info,1),u,1,d)
		call FlushChildHashtable(MHT,info)
		call CleanTrigger(trig)
		set text = null
		set u = null
	endif

	set trig = null
	return false
endfunction

function Chaos_Bolt_Start takes unit u, unit t, integer level, boolean reflect returns nothing
	local unit d = CreateUnit(GetOwningPlayer(t),'e00E',GetWidgetX(u),GetWidgetY(u),0)//e00E -> Spellcaster
	local trigger trig = CreateTrigger()
	local integer info = GetHandleId(trig)
	local real stun
	set stun=GetRandomInt(25+50*level,100+50*level)*1./100.
	call SaveReal(MHT,info,1,(175+25*level)*1.-15.625*R2I(RAbsBJ((25+50*level)*1./100.-stun)*10))
//	call echo("stun: "+R2S(stun)+", dmg: "+R2S(LoadReal(MHT,info,1)))
	call SaveUnitHandle(MHT,info,0,d)
	call SaveUnitHandle(MHT,info,1,u)
	call SaveUnitHandle(MHT,info,2,t)
	call SaveReal(MHT,info,0,stun)
	call SaveInteger(MHT,info,1,level)
	call SaveBoolean(MHT,info,0,reflect)
	call TriggerRegisterTimerEvent(trig,10,false)
	call TriggerRegisterUnitEvent(trig,t,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(trig,Condition(function Chaos_Bolt_Damage))
	call UnitAddAbility(d,'A04U')//A04U -> Chaos bolt dummy
	call IssueTargetOrder(d,"thunderbolt",t)
	set trig = null
	set d = null
endfunction

function Chaos_Bolt_Wrap takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Chaos_Bolt_Start(GetTriggerUnit(),GetSpellTargetUnit(),GetUnitAbilityLevel(GetTriggerUnit(),'A055')+GetUnitAbilityLevel(GetTriggerUnit(),'QB00'),false)//A055 -> Chaos Bolt, QB00 -> Chaos Bolt
	endif
endfunction

function Chaos_Bolt_WrapWrapperLotus takes nothing returns nothing
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	if IsBlocked(target)==false then
		call Chaos_Bolt_Start(LoadUnitHandle(TempHash,'A3E9',0),target,LoadInteger(TempHash,'A3E9',0),true)
	else
		call RemoveLinkenBuff(target)
	endif
	set target=null
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function ChaosStrikeDebuff takes nothing returns nothing
	call UnitAddAbilityTimedExF(UDSG_Target,'A3JG',1,8,'B3JG')
	call UnitAddAbilityTimedExF(UDSG_Target,'A3JH',1,8,0)
endfunction

function RAF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function RBF takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())==GetUnitTypeId(IK8)and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(IK8)and IsUnitIllusion(GetFilterUnit()) then
		call SetUnitX(GetFilterUnit(),II8)
		call SetUnitY(GetFilterUnit(),IJ8)
		call IssueTargetOrderById(GetFilterUnit(),ORDER_attack,IM8)
	endif
	return false
endfunction

function CK_RealityRift takes unit Source, unit Target, integer Level returns nothing
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real TargetX=GetUnitX(Target)
	local real TargetY=GetUnitY(Target)
	local real a=AngleBetweenXY(SourceX,SourceY,TargetX,TargetY)
	local real YR8=DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)
	local real d=GetRandomReal(YR8*.3,YR8*.8)
	local real AO8=SourceX+d*Cos(a*bj_DEGTORAD)
	local real AP8=SourceY+d*Sin(a*bj_DEGTORAD)
	local unit u=CreateUnit(GetOwningPlayer(Source),IH8,AO8,AP8,0)
	local unit u2
	local group g
	local trigger t
	local integer h
	call SetUnitX(Source,AO8)
	call SetUnitY(Source,AP8)
	call SetUnitFacing(Source,-a)
	call PlaySoundOnUnitBJ(OC,100,Target)
	if Target!=Roshan then//n00L -> Roshan
		call UnitAddAbilityTimedExF(Source,'A3K9',Level,1.2,0)
		set AO8=SourceX+(d-25)*Cos(a*bj_DEGTORAD)
		set AP8=SourceY+(d-25)*Sin(a*bj_DEGTORAD)
		call AddTimedKeyToUnit(Target,4405,1)
		call SetUnitX(Target,AO8)
		call SetUnitY(Target,AP8)
		call SetUnitFacing(Target,a)
		call IssueTargetOrderById(Source,ORDER_attack,Target)
		set g=GetAvailableGroup()
		set II8=AO8
		set IJ8=AP8
		set IK8=Source
		set IM8=Target
		call GroupEnumUnitsInRange(g,SourceX,SourceY,1400,Condition(function RBF))
		call KillGroup(g)
		call KillUnit(CreateUnit(GetOwningPlayer(Source),IH8,AO8,AP8,0))
	endif
	call KillUnit(u)
	set Source=null
	set Target=null
	set u=null
	set u2=null
	set g=null
endfunction

function CK_RealityRiftWrapper takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local integer lvl=GetUnitAbilityLevel(u,'A0RW')//A0RW -> Reality Rift
	if GetUnitAbilityLevel(u,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(u),0) then//Aloc -> Locust
		set u=LoadUnitHandle(HY,GetHandleId(u),0)
	endif
	if IsBlocked(target)==false then
		call CK_RealityRift(u,target,lvl)
//		call echo(GetUnitName(u)+" -> "+GetUnitName(target))
	endif
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set target=null
	set u=null
endfunction

function CK_RealityRiftPreWrapper takes nothing returns nothing
	local timer t
	local integer h
	if IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		call TimerStart(t,0,false,function CK_RealityRiftWrapper)
		set t=null
	endif
endfunction

function CK_Phantasm_Back takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	call UnitRemoveAbility(u,'A40D')
	if GetUnitAbilityLevel(u,'A40D')==0 then
		call CleanTimer(t)
	elseif LoadBoolean(HY,GetHandleId(t),0)==false then
		call SaveBoolean(HY,GetHandleId(t),0,true)
		call TimerStart(t,1,true,function CK_Phantasm_Back)
	endif
	set u=null
	set t=null
endfunction

function CK_Phantasm takes nothing returns nothing
	local timer t
	if GetRandomInt(0,1)==1 then
		set t=CreateTimer()
		call TimerStart(t,0.51,false,function CK_Phantasm_Back)
		call UnitAddAbility2(GetTriggerUnit(),'A40D')
		call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
		set t=null
	endif
endfunction

function R6F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local unit u=CreateUnit(GetOwningPlayer(Hero),IH8,GetUnitX(Hero),GetUnitY(Hero),0)
	call PlaySoundOnUnitBJ(OC,100,Hero)
	call KillUnit(u)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set u=null
	set t=null
	set Hero=null
	return false
endfunction

function CK_RealityRift_OnCast takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerAddCondition(t,Condition(function R6F))
	call TriggerRegisterTimerEvent(t,.3,false)
	call SaveUnitHandle(HY,h,14,(GetTriggerUnit()))
	set t=null
endfunction

function Bone_SearingArrows_Learn takes nothing returns nothing
	local integer lvl=GetUnitAbilityLevel(GetTriggerUnit(),'A303')//A303 -> Searing Arrows
	if lvl==1 then
		call UnitAddAbility2(GetTriggerUnit(),'AHfa')//AHfa -> Searing Arrows
	endif
	call SetUnitAbilityLevel(GetTriggerUnit(),'AHfa',lvl)//AHfa -> Searing Arrows
endfunction

function R2F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real hp=GetWidgetLife(Source)
	local integer dmgbon=LoadInteger(HY,h,10)
	local integer hpbon=LoadInteger(HY,h,11)
	call SaveInteger(HY,GetHandleId(Source),'a272',LoadInteger(HY,GetHandleId(Source),'a272')-dmgbon)
	call BonusDamageSystem(Source)
	call ManageBonusHP(Source,-1 * hpbon)
	call SaveInteger(HY,GetHandleId(Source),'h272',LoadInteger(HY,GetHandleId(Source),'a272')-hpbon)
	if LoadInteger(HY,GetHandleId(Source),'a272')==0 then
		call UnitRemoveAbility(Source,'A1R0')//A1R0 -> Death Pact
		call UnitRemoveAbility(Source,'B0D5')//B0D5 -> Death Pact
	endif
	call SetWidgetLife(Source,hp)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function S7F takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A04Q')//A04Q -> Death Pact
	local real targetLife=GetWidgetLife(Target)
	local real sourceLife=GetWidgetLife(Source)
	local integer dmgbon=R2I((.035+.015*Level)*targetLife)
	local integer hpbon=R2I((.35+.15*Level)*targetLife)
	call SaveInteger(HY,h,10,dmgbon)
	call SaveInteger(HY,h,11,hpbon)
	call SaveInteger(HY,GetHandleId(Source),'a272',LoadInteger(HY,GetHandleId(Source),'a272')+dmgbon)
	call BonusDamageSystem(Source)
	call SaveInteger(HY,GetHandleId(Source),'h272',LoadInteger(HY,GetHandleId(Source),'h272')+hpbon)
	call ManageBonusHP(Source,hpbon)
	call UnitAddAbility2(Source,'A1R0')//A1R0 -> Death Pact
	call SetWidgetLife(Target,1)
	call DamageTarget(Source,Target,2,20)
	call DamageTarget(Source,Target,1,20)
	call DamageTarget(Source,Target,3,20)
	call SetWidgetLife(Source,sourceLife+hpbon)
	call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Target,"chest"))
	call SaveUnitHandle(HY,h,2,(Source))
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterTimerEvent(t,35,false)
	call TriggerAddCondition(t,Condition(function R2F))
	set Source=null
	set Target=null
	set t=null
endfunction

function BoneFletcher_DeathPact takes nothing returns nothing
	if GetWidgetLife(GetTriggerUnit())>.5 and IsCourier(GetSpellTargetUnit())==false then
		call S7F()
	endif
endfunction

function SkeletonWalkAct takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call RemoveEndlessFadetime(LoadUnitHandle(HY,h,0))
	call Func0404(LoadUnitHandle(HY,h,0),'I0TH')
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
endfunction

function SkeletonWalk takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,GetTriggerUnit())
	call TimerStart(t,0,false,function SkeletonWalkAct)
	set t=null
endfunction

function SFF takes integer x returns boolean
	return x=='A3FJ' or x=='A06X' or x=='A0AQ' or x=='A14O' or x=='A0NE' or x=='A1C0' or x=='A0SB' or x=='A418'//A14O -> Ball Lightning, A0NE -> Voodoo Restoration, A14O -> Ball Lightning, A1C0 -> Splitshot, A0SB -> Phase Shift, A418 -> Splitshot
endfunction

function SHF takes nothing returns boolean
	return GetUnitAbilityLevel(GetTriggerUnit(),'B06X')>0 and SFF(GetSpellAbilityId())==false and isDummyAbility(GetSpellAbilityId())==false and isItemSpellOrNoCd(GetSpellAbilityId())==false and isAintItemAbility(GetSpellAbilityId())//B06X -> Essence Aura
endfunction

function OD_EssenceAura_Delayed takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local integer lvl=LoadInteger(HY,h,0)
	local unit u=LoadUnitHandle(HY,h,0)
	call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+(.05+.05*lvl)*GetUnitState(u,UNIT_STATE_MAX_MANA))
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	set t=null
	set u=null
endfunction

function SIF takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit u=GetTriggerUnit()
	local unit SJF=(LoadUnitHandle(HY,h,254))
	local integer lvl=GetUnitAbilityLevel(SJF,'P347')
	local timer t
	if GetUnitAbilityLevel(SJF,'A36D')==0 and DistanceBetweenUnits(u,SJF) < 1400 and PRD_Get(u,'P347',40) then
		set t=CreateTimer()
		call TimerStart(t,0,false,function OD_EssenceAura_Delayed)
		call SaveUnitHandle(HY,GetHandleId(t),0,u)
		call SaveInteger(HY,GetHandleId(t),0,lvl)
		set t=null
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\ReplenishManaCasterOverhead.mdl",u,"overhead"))
	endif
	set u=null
	set SJF=null
endfunction

function Destroyer_EssenceAura_Leveling takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A0IF')//A0IF -> Essence Aura, QP1A -> Essence Aura
	local trigger t
	if(lvl==1)then
		set t=CreateTrigger()
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
		call TriggerAddCondition(t,Condition(function SHF))
		call TriggerAddAction(t,function SIF)
		call SaveUnitHandle(HY,GetHandleId(t),254,u)
	endif
	if(lvl==1)then
		call UnitAddAbility2(u,'A0OL')//A0OL -> Essence Aura trash
	elseif(lvl==2)then
		call UnitAddAbility2(u,'A0OM')//A0OM -> Essence Aura trash
	elseif(lvl==3)then
		call UnitAddAbility2(u,'A0ON')//A0ON -> Essence Aura trash
	elseif(lvl==4)then
		call UnitAddAbility2(u,'A0OH')//A0OH -> Essence Aura trash
	endif
	set u=null
	set t=null
endfunction

function OD_Orb_Hit takes unit attacker, unit target, boolean isOrb returns nothing
	local real d=.01*(5+GetUnitAbilityLevel(attacker,'A0OI'))*(GetUnitState(attacker,UNIT_STATE_MANA)+100)//A0OI -> Arcane Orb
	call UnitRemoveAbility(target,'B06Y')//B06Y -> Arcane Orb
	if(IsUnitType(target,UNIT_TYPE_SUMMONED) or IsUnitIllusion(target))and IsSpiritBear(target)==false and IsInfernalGolem(target)==false then
		set d=d+100*GetUnitAbilityLevel(attacker,'A0OI')//A0OI -> Arcane Orb
	endif
	call TextTagOnUnit("+"+I2S(R2I(d)),1,target,.023,191,64,255,216)
	call DamageTarget(attacker,target,3,d)
	if isOrb==false and PRD_Get(attacker,'P347',GetUnitAbilityLevel(attacker,'P347')*10)then
		call SetUnitState(attacker,UNIT_STATE_MANA,GetUnitState(attacker,UNIT_STATE_MANA)+.25*GetUnitState(attacker,UNIT_STATE_MAX_MANA))
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\ReplenishManaCasterOverhead.mdl",attacker,"overhead"))
	endif
endfunction

function SRF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer SSF=(LoadInteger(HY,h,262))
	call SetHeroInt(Target,GetHeroInt(Target,false)+SSF,true)
	call SetHeroInt(Source,GetHeroInt(Source,false)-SSF,true)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function STF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	call SaveInteger(HY,(GetHandleId((Target))),(4303),2)
	call DestroyEffect((LoadEffectHandle(HY,h,32)))
	call SetUnitInvulnerable(Target,false)
	call PauseUnit(Target,false)
	call ShowUnit(Target,true)
	call ClearSelectionForPlayer(GetOwningPlayer(Target))
	call SelectUnitAddForPlayer(Target,GetOwningPlayer(Target))
	call RemoveSavedHandle(HY,(GetHandleId(Source)),748)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function OD_AstralImprisonment takes unit Source, unit Target, integer Level, boolean forced returns nothing
	local integer SSF=IMinIF(GetHeroInt(Target,false),1+Level*3) + 2
	local trigger t
	local integer h
	local unit Caster=CreateUnit(GetOwningPlayer(Target),'o019',GetUnitX(Target),GetUnitY(Target),0)//o019 -> Vision Ground 1800/800
	local boolean b=IsBlocked(Target)
	if GetUnitTypeId(Source)=='e00E' then//e00E -> Spellcaster
		if HaveSavedHandle(HY,GetHandleId(Source),0) then
			set Source=LoadUnitHandle(HY,GetHandleId(Source),0)
			if b then
				call RemoveLinkenBuff(Target)
			endif
		else
			set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
		endif
	endif
	if(IsUnitEnemy(Target,GetOwningPlayer(Source)))==false or b==false then
		call UnitApplyTimedLife(Caster,'BTLF',Level+1)
		call SaveInteger(HY,GetHandleId(Target),4303,1)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SelectUnitRemoveForPlayer(Target,GetOwningPlayer(Target))
		call SetUnitInvulnerable(Target,true)
		call PauseUnit(Target,true)
		call ShowUnit(Target,false)
		call SaveEffectHandle(HY,h,32,(AddSpecialEffect("Abilities\\Spells\\Demon\\DarkConversion\\ZombifyTarget.mdl",GetUnitX(Target),GetUnitY(Target))))
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveUnitHandle(HY,h,17,(Target))
		call TriggerRegisterTimerEvent(t,Level,false)
		call TriggerAddCondition(t,Condition(function STF))
		if IsUnitEnemy(Target,GetOwningPlayer(Source)) then
			call SaveUnitHandle(HY,GetHandleId(Source),748,Target)
			call SetHeroInt(Target,GetHeroInt(Target,false)-SSF,true)
			call SetHeroInt(Source,GetHeroInt(Source,false)+SSF,true)
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call SaveUnitHandle(HY,h,2,(Source))
			call SaveUnitHandle(HY,h,17,(Target))
			call SaveInteger(HY,h,262,(SSF))
			call TriggerRegisterTimerEvent(t,50,false)
			call TriggerRegisterDeathEvent(t,Source)
			call TriggerRegisterDeathEvent(t,Target)
			call TriggerAddCondition(t,Condition(function SRF))
		endif
	endif
	if IsUnitAlly(Target,GetOwningPlayer(Source))==false and b and forced then
		call RemoveLinkenBuff(Target)
	endif
	set Caster=null
	set t=null
endfunction

function OD_AstralImprisonmentWrapper takes nothing returns nothing
	call OD_AstralImprisonment(GetTriggerUnit(),GetSpellTargetUnit(),GetUnitAbilityLevel(GetTriggerUnit(),'A0OJ'),false)
endfunction

function OD_AstralImprisonment_OnCast takes nothing returns nothing
	if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))and(LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetSpellTargetUnit())),139))and GetSpellTargetUnit()!=GetTriggerUnit()then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))//n038 -> This target has disablehelp on
	endif
endfunction

function SZF takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local unit caster=GetTriggerUnit()
	local integer diff
	local integer min
	local integer array SBF
	local integer Level=GetUnitAbilityLevel(caster,'A0OK')//A0OK -> Sanity's Eclipse
	local integer mult=7+1*Level
	local integer i
	local boolean isagh=GetUnitAbilityLevel(caster,'A1VW')>0//A1VW -> Sanity's Eclipse
	local unit d
	local unit targetOrig=Target
	if IsUnitIllusion(Target)then
		set targetOrig=udg_Hero[GetPlayerId(GetOwningPlayer(Target))]
	endif
	if GetHeroInt(caster,true)==0 then
		set caster=udg_Hero[GetPlayerId(GetOwningPlayer(caster))]
	endif
	set i=GetUnitPrimaryAttribute(caster)
	if i==1 then
		set diff=GetHeroInt(caster,true)-GetHeroInt(targetOrig,true)
	elseif i==2 then
		set diff=GetHeroAgi(caster,true)-GetHeroAgi(targetOrig,true)
	else
		set diff=GetHeroStr(caster,true)-GetHeroStr(targetOrig,true)
	endif
	if isagh then
		set Level=GetUnitAbilityLevel(caster,'A1VW')//A1VW -> Sanity's Eclipse
		set mult=7+1*Level+1
	endif
	set min=-10+20*Level
	if(diff>0)then
		call DamageTarget(caster,Target,1,diff*mult)
		call TextTagOnUnit(I2S(R2I(diff*mult)),3,Target,.023,216,30,30,216)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Feedback\\SpellBreakerAttack.mdl",Target,"overhead"))
		call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)*.6)
		if isagh and IsDead(Target)==false then
			call OD_AstralImprisonment(caster,Target,4,true)
		endif
	endif
	set Target=null
	set caster=null
endfunction

function S3F takes nothing returns boolean
	return IsUnitIdType(GetUnitTypeId(GetFilterUnit()),UNIT_TYPE_HERO) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))
endfunction

function OD_SanityEclipse takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A0OK')//A0OK -> Sanity's Eclipse
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local group g=GetAvailableGroup()
	local integer offset=0
	local unit SLF=(LoadUnitHandle(HY,(GetHandleId(u)),748))
	if lvl==0 then
		set lvl=GetUnitAbilityLevel(u,'A1VW')//A1VW -> Sanity's Eclipse
	endif
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosTarget.mdl",x,y))
	loop
		exitwhen offset>=360
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosTarget.mdl",x+(200+lvl*50)*Cos(offset*bj_DEGTORAD),y+(200+lvl*50)*Sin(offset*bj_DEGTORAD)))
		set offset=offset+45
	endloop
	call GroupEnumUnitsInRange(g,x,y,300+lvl*100,Condition(function S3F))
	if SLF!=null and DistanceBetweenXY(x,y,GetUnitX(SLF),GetUnitY(SLF))<(300+lvl*100)then
		call SetUnitInvulnerable(SLF,false)
		call GroupAddUnit(g,SLF)
	endif
	call ForGroup(g,function SZF)
	if SLF!=null and IsDead(SLF)==false then
		call SetUnitInvulnerable(SLF,true)
	endif
	call KillGroup(g)
	set g=null
	set SLF=null
	set u=null
endfunction

function S1F takes nothing returns nothing
	call DamageTarget(IN8,GetEnumUnit(),1,IO8)
endfunction

function S0F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,17)
	local unit Source=LoadUnitHandle(HY,h,2)
	local group g
	local integer Count=LoadInteger(HY,h,34)
	if Count>250 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call Buff_Remove(Target,'D001')
		call DestroyEffect((LoadEffectHandle(HY,h,31)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A0QG' and GetSpellTargetUnit()==Target then//A0QG -> Ion Shell
		call DestroyEffect((LoadEffectHandle(HY,h,31)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if Count==1 then
			call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
		endif
		set Count=Count+1
		call SaveInteger(HY,h,34,Count)
		set g=GetAvailableGroup()
		set tt_unit1=Source
		set IN8=Source
		set IO8=1.+2.*LoadInteger(HY,h,0)
		call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),275,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
		call GroupRemoveUnit(g,Target)
		call ForGroup(g,function S1F)
		call KillGroup(g)
		set Target=null
	endif
	set t=null
	set Source=null
	set g=null
	return false
endfunction

function DS_IonShell takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local unit target = GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call Buff_Add(target,'C001','D001',0)
	call PlaySoundAtPos(LC,GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()))
	call SaveUnitHandle(HY,h,2,u)
	call SaveUnitHandle(HY,h,17,target)
	call SaveEffectHandle(HY,h,31,AddSpecialEffectTarget("war3mapImported\\NewSoulArmor.mdx",GetSpellTargetUnit(),"chest"))
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(u,GetSpellAbilityId()))
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerRegisterDeathEvent(t,target)
	call TriggerAddCondition(t,Condition(function S0F))
	set u=null
	set t=null
	set target=null
endfunction

function T4F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local integer Level
	local unit Source
	local unit Target
	local real x1
	local real y1
	local real d
	local real a
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SetUnitPathing(LoadUnitHandle(HY,h,17),true)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set Target=(LoadUnitHandle(HY,h,17))
		set d=(LoadReal(HY,h,138))
		set x=(LoadReal(HY,h,6))
		set y=(LoadReal(HY,h,7))
		set a=(LoadReal(HY,h,137))
		set x1=GetUnitX(Target)+d/ 15*Cos(a)
		set y1=GetUnitY(Target)+d/ 15*Sin(a)
		if IsUnitType(Target,UNIT_TYPE_HERO) then
			call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
			call SetUnitPosition(Target,x1,y1)
		else
			call SetUnitX(Target,x1)
			call SetUnitY(Target,y1)
		endif
		if GetTriggerEvalCount(t)>15 then
			set Source=(LoadUnitHandle(HY,h,2))
			set Level=(LoadInteger(HY,h,5))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call SetUnitPathing(Target,true)
			call DamageTarget(Source,Target,1,Level*40)
			set Source=null
		endif
		set Target=null
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function T7F takes nothing returns nothing
	local trigger t=null
	local unit Source=null
	local unit Target=GetEnumUnit()
	local integer h
	if IsUnitInvulnerable(Target) then
		set Target = null
		return
	endif
	set t = CreateTrigger()
	set Source = GetTriggerUnit()
	set h = GetHandleId(t)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterTimerEvent(t,.025,true)
	call TriggerAddCondition(t,Condition(function T4F))
	call SaveReal(HY,h,6,((IP8)*1.))
	call SaveReal(HY,h,7,((IQ8)*1.))
	call SaveReal(HY,h,138,((DistanceBetweenXY(IP8,IQ8,GetUnitX(Target),GetUnitY(Target)))*1.))
	call SaveReal(HY,h,137,((Atan2(IQ8-GetUnitY(Target),IP8-GetUnitX(Target)))*1.))
	call SaveInteger(HY,h,5,(IR8))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SetUnitPathing(Target,false)
	set t=null
	set Source=null
	set Target=null
endfunction

function DS_Vacuum takes nothing returns nothing
	local group g=GetAvailableGroup()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A0QE')//A0QE -> Vacuum
	local real r=175+100*Level
	set tt_unit1=GetTriggerUnit()
	call PlaySoundAtPos(CE,x,y)
	call DestroyEffect(AddSpecialEffect("war3mapImported\\Star Aura.mdx",x,y))
	call GroupEnumUnitsInRange(g,x,y,r,Condition(function NonImmuneEnemyFilter))
	set IP8=x
	set IQ8=y
	set IR8=Level
	call ForGroup(g,function T7F)
	call KillTrees(x,y,200)
	call KillGroup(g)
	set g=null
endfunction

function DS_Vacuum_OnCast takes nothing returns nothing
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	if IsTerrainPathableFixed(x,y)==false or(IsPointInRegion(RestrictedRegion,((x)*1.),((y)*1.)))then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n03K'))//n03K -> Cannot use Vacuum here
	endif
endfunction

function TFF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	call UnitRemoveAbility(Target,'B07W')//B07W -> Surge
	call UnitRemoveAbility(Target,'Bblo')//Bblo -> Bloodlust
	call UnitRemoveAbility(Target,'B062')//B062 -> Track
	call UnitRemoveAbility(Target,'B065')//B065 -> Mark of the Abyss
	call UnitRemoveAbility(Target,'Bcrs')//Bcrs -> Grave Chill
	call UnitRemoveAbility(Target,'B016')//B016 -> Rabid
	set t=null
	set Target=null
	return false
endfunction

function DS_Surge takes nothing returns nothing
	call UnitAddAbilityTimedExF(GetSpellTargetUnit(),'A3KB',1,1.5+1.5*GetUnitAbilityLevel(GetTriggerUnit(),'A0R7'),'B07W')
	call PlaySoundAtPos(TD,GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()))
endfunction

function TIF takes boolean RIE returns boolean
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit wall=LoadUnitHandle(HY,h,259)
	local unit Target=GetTriggerUnit()
	local unit Hero=udg_Hero[GetPlayerId(GetOwningPlayer(wall))]
	local integer Level=LoadInteger(HY,h,0)
	local integer illusid='A3H3'
	local integer illuslvl=Level
	if RIE then
		set illusid='A3H4'
	endif
	call UnitAddAbility(wall,illusid)
	call SetUnitAbilityLevel(wall,illusid,illuslvl)
	set IS8=GetUnitX(Target)
	set IT8=GetUnitY(Target)
	set IU8=Target
	call SaveUnitHandle(HY,GetHandleId(wall),'0ILU',Target) //Wall of Replica source info
	call IssueTargetOrderNoLinken(wall,852274,Target)
	call DamageTarget(wall,Target,1,150)
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImageCaster.mdl",GetUnitX(Target),GetUnitY(Target)))
	set wall=null
	set Target=null
	set Hero=null
	return false
endfunction

function TMF takes nothing returns boolean
	local group g
	if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),259)))and(GetUnitTypeId(GetFilterUnit())!='H00J') then//H00J -> Geomancer
		set g=LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),257)
		if IsUnitInGroup(GetFilterUnit(),g)==false then
			call GroupAddUnit(g,GetFilterUnit())
			call TIF(false)
		endif
	endif
	set g=null
	return false
endfunction

function TNF takes nothing returns boolean
	local group g
	if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),259)))and(GetUnitTypeId(GetFilterUnit())!='H00J') then//H00J -> Geomancer
		set g=LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),257)
		if IsUnitInGroup(GetFilterUnit(),g)==false then
			call GroupAddUnit(g,GetFilterUnit())
			call TIF(true)
		endif
	endif
	set g=null
	return false
endfunction

function TOF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	call GroupRemoveUnit(LoadGroupHandle(HY,h,257),LoadUnitHandle(HY,h,261))
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImageCaster.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
	call FlushChildHashtable(HY,h)
	call DisableTrigger(t)
	set t=null
	return false
endfunction

function TPF takes nothing returns boolean
	local unit TJF=GetSummoningUnit()
	local unit W39=GetSummonedUnit()
	local integer h=GetHandleId(TJF)
	local integer TQF=(LoadInteger(HY,h,260))
	local trigger t=CreateTrigger()
	call SetUnitVertexColor(W39,255,255,255,100)
	call TriggerRegisterUnitEvent(t,W39,EVENT_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function TOF))
	call SaveGroupHandle(HY,GetHandleId(t),257,LoadGroupHandle(HY,h,257))
	call SaveUnitHandle(HY,GetHandleId(t),261,IU8)
	set TQF=TQF+1
	call SaveInteger(HY,h,260,TQF)
	call SaveUnitHandle(HY,h,2800+TQF,(W39))
	call SaveTriggerHandle(HY,h,2900+TQF,t)
	call SetUnitX(W39,IS8)
	call SetUnitY(W39,IT8)
	set TJF=null
	set W39=null
	set t=null
	return false
endfunction

function TRF takes nothing returns nothing
	call RemoveUnit(GetEnumUnit())
endfunction

function TSF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local trigger t2=LoadTriggerHandle(HY,h,255)
	local integer h2=GetHandleId(t2)
	local trigger t3=LoadTriggerHandle(HY,h2,256)
	local group g1=LoadGroupHandle(HY,h2,257)
	local group g2=LoadGroupHandle(HY,h2,258)
	local unit u2=LoadUnitHandle(HY,h2,259)
	local integer uh=GetHandleId(u2)
	local integer TQF=LoadInteger(HY,uh,260)
	local integer i
	local unit u
	call ForGroup(g2,function TRF)
	set i=1
	loop
		exitwhen i>TQF
		set u=LoadUnitHandle(HY,uh,2800+i)
		call FlushChildHashtable(HY,GetHandleId(LoadTriggerHandle(HY,uh,2900+i)))
		call CleanTrigger(LoadTriggerHandle(HY,uh,2900+i))
		if IsUnitIllusion(u)then
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImageCaster.mdl",GetUnitX(u),GetUnitY(u)))
			call RemoveUnit(u)
		endif
		set i=i+1
	endloop
	call FlushChildHashtable(HY,h)
	call FlushChildHashtable(HY,h2)
	call FlushChildHashtable(HY,uh)
	call RemoveUnit(u2)
	call KillGroup(g1)
	call KillGroup(g2)
	call CleanTrigger(t2)
	call CleanTrigger(t3)
	call CleanTrigger(t)
	set t=null
	set t2=null
	set t3=null
	set g1=null
	set g2=null
	set u2=null
	set u=null
	return false
endfunction

function DS_WallOfReplica takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real TAF=GetUnitFacing(Hero)-45
	local unit TJF=CreateUnit(GetOwningPlayer(Hero),'h00O',x,y,TAF)//h00O -> Wall of Replica
	local unit u
	local real M6E
	local real MLE
	local integer i
	local real offset
	local trigger t=CreateTrigger()
	local group g1=GetAvailableGroup()
	local integer h=GetHandleId(t)
	local group g2=GetAvailableGroup()
	local trigger TTF=t
	local integer Level=GetUnitAbilityLevel(Hero,'A0QK')//A0QK -> Wall of Replica
	local boolean RIE=false
	if Level==0 then
		set RIE=true
		set Level=GetUnitAbilityLevel(Hero,'A21Q')//A21Q -> Wall of Replica
	endif
	call SetUnitAbilityLevel(TJF,'A0QL',Level)
	call PlaySoundAtPos(DE,x,y)
	call SaveGroupHandle(HY,h,257,g1)
	call SaveGroupHandle(HY,GetHandleId(TJF),257,g1)
	call SaveGroupHandle(HY,h,258,g2)
	call SaveUnitHandle(HY,h,259,TJF)
	call SaveInteger(HY,GetHandleId(TJF),260,0)
	set i=0
	loop
		exitwhen i>39
		set M6E=x+(500-25*i)*Cos((TAF-45)*bj_DEGTORAD)
		set MLE=y+(500-25*i)*Sin((TAF-45)*bj_DEGTORAD)
		set u=CreateUnit(GetOwningPlayer(Hero),'h00P',M6E,MLE,TAF)//h00P -> Wall of Replica Detection
		call GroupAddUnit(g2,u)
		call TriggerRegisterUnitInRange(t,u,17,Condition(function ReturnTrue))
		set i=i+1
	endloop
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
	call SaveBoolean(HY,h,0,RIE)
	if RIE then
		call TriggerAddCondition(t,Condition(function TNF))
	else
		call TriggerAddCondition(t,Condition(function TMF))
	endif
	set t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,TJF,EVENT_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function TPF))
	call SaveTriggerHandle(HY,h,256,t)
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,45,false)
	call TriggerAddCondition(t,Condition(function TSF))
	call SaveTriggerHandle(HY,GetHandleId(t),255,TTF)
	set Hero=null
	set u=null
	set t=null
	set TTF=null
	set g1=null
	set g2=null
	set TJF=null
endfunction

function Brewmaster_Brawler_Attacked_Clean takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	call UnitRemoveAbility(u,'A34E')
	call CleanTimer(t)
	set t=null
	set u=null
endfunction

function Brewmaster_Brawler_Attacked_remove takes unit u returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.3,false,function Brewmaster_Brawler_Attacked_Clean)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	set t=null
endfunction

function Brewmaster_Brawler_Attacking_Clean takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	call UnitRemoveAbility(u,'A34F')
	call UnitRemoveAbility(u,'A40A')
	call CleanTimer(t)
	set t=null
	set u=null
endfunction

function Brewmaster_Brawler_Attacking_remove takes unit u returns nothing
	local timer t=CreateTimer()
	if IsRangedUnitHasOverAS(u) then
		call TimerStart(t,0.2,false,function Brewmaster_Brawler_Attacking_Clean)
	else
		call TimerStart(t,0.3,false,function Brewmaster_Brawler_Attacking_Clean)
	endif
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	
	set t=null
endfunction

function Brewmaster_Brawler_Attacked takes nothing returns nothing
	if GetTriggerEventId()==EVENT_UNIT_ATTACKED then
		call SaveReal(MHT,GetHandleId(GetTriggerUnit()),'LSTE',TimerGetElapsed(GlobalTimer))
		call Brewmaster_Brawler_Attacked_remove(GetTriggerUnit())
	else
		if IsPoisonArrowSkill(GetSpellAbilityId()) and GetSpellTargetUnit()==LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),0) then
			call SaveReal(MHT,GetHandleId(GetSpellTargetUnit()),'LSTE',TimerGetElapsed(GlobalTimer))
			call Brewmaster_Brawler_Attacked_remove(GetSpellTargetUnit())
		endif
	endif
endfunction

function Brewmaster_Brawler_Attacking takes nothing returns nothing
	if GetAttacker()==LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),0) and IsUnitEnemy(GetAttacker(),GetOwningPlayer(GetTriggerUnit())) then
		call SaveReal(MHT,GetHandleId(GetAttacker()),'LSTC',TimerGetElapsed(GlobalTimer))
		call Brewmaster_Brawler_Attacking_remove(GetAttacker())
	endif
endfunction

function Brewmaster_Brawler_Check takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	local integer hu=GetHandleId(u)
	local real curtime=TimerGetElapsed(GlobalTimer)
	if curtime-LoadReal(MHT,hu,'LSTC')>=10 and GetUnitAbilityLevel(u,'A34F')==0 then
		call UnitAddAbility2(u,'A34F')//crit
		call UnitAddAbility2(u,'A40A')//crit
	endif
	if curtime-LoadReal(MHT,hu,'LSTE')>=10 and GetUnitAbilityLevel(u,'A34E')==0 then
		call UnitAddAbility2(u,'A34E')//evasion
	endif
	set t=null
	set u=null
endfunction

function Brewmaster_Brawler takes nothing returns nothing
	local trigger t=CreateTrigger()
	local unit u=GetTriggerUnit()
	local timer tt=CreateTimer()
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ATTACKED)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function Brewmaster_Brawler_Attacked))
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerAddCondition(t,Condition(function Brewmaster_Brawler_Attacking))
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call TimerStart(tt,1,true,function Brewmaster_Brawler_Check)
	call SaveUnitHandle(HY,GetHandleId(tt),0,u)
	call SaveReal(MHT,GetHandleId(u),'LSTC',TimerGetElapsed(GlobalTimer))
	call SaveReal(MHT,GetHandleId(u),'LSTE',TimerGetElapsed(GlobalTimer))
	set tt=null
	set u=null
	set t=null
endfunction

function DrunkenHaze_SpellEffect takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local group g
	local unit u2
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())-1+'A3PR'
	if IsBlocked(target) then
		set caster=null
		set target=null
		return
	endif
	set tt_unit1=caster
	set g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),225,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call GroupRemoveUnit(g,u2)
		if IsHeroUnitId(GetUnitTypeId(u2)) then
			call UnitAddAbilityTimedExF(u2,lvl,1,8.,'BNdh')
		else
			call UnitAddAbilityTimedExF(u2,lvl,1,12.,'BNdh')
		endif
	endloop
	call KillGroup(g)
	call EvasionSourceActivate(EVASION_DEBUFF_DRUNKENHAZE,13)
	set caster=null
	set target=null
endfunction

function TCF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer str=LoadInteger(HY,h,29)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		if(LoadBoolean(HY,h,276))==false and GetTriggerUnit()==(Source)then
			call SaveBoolean(HY,h,276,true)
			call SetHeroStr(Source ,GetHeroStr(Source ,false)-str,true)
			call SaveInteger(HeroStats,GetHandleId(Source),30,LoadInteger(HeroStats,GetHandleId(Source),30)-str)
		elseif(LoadBoolean(HY,h,277))==false and GetTriggerUnit()==Target then
			call SaveBoolean(HY,h,277,true)
			call SetHeroStr(Target ,GetHeroStr(Target ,false)+str,true)
		endif
	else
		if(LoadBoolean(HY,h,276))==false then
			call SaveBoolean(HY,h,276,true)
			call SetHeroStr(Source ,GetHeroStr(Source ,false)-str,true)
			call SaveInteger(HeroStats,GetHandleId(Source),30,LoadInteger(HeroStats,GetHandleId(Source),30)-str)
		endif
		if(LoadBoolean(HY,h,277))==false then
			call SaveBoolean(HY,h,277,true)
			call SetHeroStr(Target ,GetHeroStr(Target ,false)+str,true)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function T6F takes nothing returns nothing
	local unit Source=IV8
	local unit Target=GetEnumUnit()
	local integer T3F
	local integer Level=IW8
	local trigger t
	local integer h
	local integer steal=4
	if GetUnitAbilityLevel(Source,'A3JX')>0 then
		set steal=8
	endif
	if IsUnitType(Target,UNIT_TYPE_HERO) then
		set T3F=IMinBJ(GetHeroStr(Target,false)-1,steal)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SetHeroStr(Source,GetHeroStr(Source,false)+T3F,true)
		call SaveInteger(HeroStats,GetHandleId(Source),30,LoadInteger(HeroStats,GetHandleId(Source),30)+T3F)
		call SetHeroStr(Target,GetHeroStr(Target,false)-T3F,true)
		call TriggerRegisterTimerEvent(t,30,false)
		call TriggerRegisterDeathEvent(t,Source)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerAddCondition(t,Condition(function TCF))
		call SaveBoolean(HY,h,276,(false))
		call SaveBoolean(HY,h,277,(false))
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveUnitHandle(HY,h,17,(Target))
		call SaveInteger(HY,h,29,(T3F))
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",Source,"origin"))
	endif
	call DamageTarget(Source,Target,1,40*Level - 20)
	set Source=null
	set Target=null
	set t=null
endfunction

function Undying_Decay takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local group g=GetAvailableGroup()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A15S')+GetUnitAbilityLevel(Source,'A3JX')//A15S -> Decay
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'h07J',x,y,0)//h07J -> Decay Visual
	call DestroyEffect(AddSpecialEffect("effects\\DecayGreen_Groundonly_1.mdx",x,y))
	if IsUnitType(Source,UNIT_TYPE_HERO)==false then
		set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
	endif
	set tt_unit1=Source
	set IV8=Source
	set IW8=Level
	call GroupEnumUnitsInRange(g,x,y,350,Condition(function NonImmuneEnemyFilter))
	call ForGroup(g,function T6F)
	call AddTimedKeyToUnit(Source,'AFRZ',0.03)
	call KillGroup(g)
	call KillUnit(Caster)
	set Source=null
	set g=null
	set t=null
	set Caster=null
endfunction

function SoulRip_LightningEffect takes unit Source,unit Target returns nothing
	call ZO8("SPLK",GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target),.1,.6,.44,.9,.6)
endfunction

function SoulRip_HealingEffect takes nothing returns nothing
	if SoulRipTempForceAll then//if tombstone
		if SoulRipTempTombstoneHealCounter>0 then
			set SoulRipTempTombstoneHealCounter=SoulRipTempTombstoneHealCounter-1
			call SetUnitState(SoulRipTempTarget,UNIT_STATE_LIFE,GetUnitState(SoulRipTempTarget,UNIT_STATE_LIFE)+1.)
		endif
		call SoulRip_LightningEffect(GetEnumUnit(),SoulRipTempTarget)
		if GetUnitTypeId(GetEnumUnit())!='n0F5' then//n0F5 -> Living Dead
			call B18(GetEnumUnit(),14+4*SoulRipTempLvl)
		endif
	else
		if GetUnitTypeId(GetEnumUnit())!='n0F5' then//n0F5 -> Living Dead
			call B18(GetEnumUnit(),14+4*SoulRipTempLvl)
		endif
		call SetWidgetLife(SoulRipTempTarget,GetWidgetLife(SoulRipTempTarget)+14+4*SoulRipTempLvl)
		call SoulRip_LightningEffect(GetEnumUnit(),SoulRipTempTarget)
	endif
endfunction

function SoulRip_DamagingEffect takes nothing returns nothing
	if GetUnitTypeId(GetEnumUnit())!='n0F5' then//n0F5 -> Living Dead
		call B18(GetEnumUnit(),14+4*SoulRipTempLvl)
	endif
	call SoulRip_LightningEffect(GetEnumUnit(),SoulRipTempTarget)
endfunction

function SoulRip_Filter takes nothing returns boolean
	return(IsMagicImmune(GetFilterUnit())==false and((AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1)))!=null
endfunction

function SoulRip_CleanGroupAffected takes nothing returns nothing
	if SoulRipTempCounter<=8+SoulRipTempLvl*2 then
		if SoulRipTempForceAll or GetRandomInt(1,2)==1 then
			set SoulRipTempCounter=SoulRipTempCounter+1
			call GroupAddUnit(SoulRipTempGroup,GetEnumUnit())
		endif
	endif
endfunction

function U7F takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local integer lvl=GetUnitAbilityLevel(u,'A0R5')//A0R5 -> Soul Rip
	local integer c
	local unit target=GetSpellTargetUnit()
	local integer cg
	local integer i=1
	if GetUnitAbilityLevel(u,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(u),0) then//Aloc -> Locust
		set u=LoadUnitHandle(HY,GetHandleId(u),0)
	endif
	set SoulRipTempGroup=GetAvailableGroup()
	set SoulRipTempCounter=0
	set SoulRipTempLvl=lvl
	set tt_unit1=u
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1300+25,Condition(function SoulRip_Filter))
	call GroupRemoveUnit(g,u)
	call GroupRemoveUnit(g,target)
	if CountUnitsInGroup(g) <= 8+SoulRipTempLvl*2 then
		call GroupAddGroup(g,SoulRipTempGroup)
	else
		set SoulRipTempForceAll=false
		loop
			call ForGroup(g,function SoulRip_CleanGroupAffected)
			call GroupRemoveGroup(SoulRipTempGroup,g)//1st get removed from 2nd
			exitwhen CountUnitsInGroup(g)==0 or CountUnitsInGroup(SoulRipTempGroup)>=8+SoulRipTempLvl*2
			set i=i+1
			if i>4 then
				set SoulRipTempForceAll=true
			endif
		endloop
		
	endif
	
	call KillGroup(g)
	set g=SoulRipTempGroup
	set SoulRipTempTarget=target
	set SoulRipTempLvl=lvl
	set SoulRipTempTombstoneHealCounter=lvl
	set SoulRipTempForceAll=IsTombstone(SoulRipTempTarget)
	set c=CountUnitsInGroup(g)
	if IsUnitAlly(SoulRipTempTarget,GetOwningPlayer(u))then
		call ForGroup(g,function SoulRip_HealingEffect)
	else
		set c=CountUnitsInGroup(g)
		call ForGroup(g,function SoulRip_DamagingEffect)
		call DamageTarget(u,target,1,(14+4*lvl)*c)
	endif
	call KillGroup(g)
	set u=null
	set target=null
endfunction

function Undying_SoulRip takes nothing returns nothing
	if (IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_STRUCTURE)==false or GetOwningPlayer(GetSpellTargetUnit())==GetOwningPlayer(GetTriggerUnit()))then
		call U7F()
	endif
endfunction

function UDF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,30)
	local unit UEF=(LoadUnitHandle(HY,h,269))
	if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if GetTriggerUnit()==Target then
			call KillUnit(UEF)
		endif
	elseif GameEnded then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call PauseUnit(UEF,true)
	elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER then
		call DisableTrigger(t)
		call IssueTargetOrderById(UEF,ORDER_attack,Target)
		call EnableTrigger(t)
	elseif (GetWidgetLife(Target)<(100*I38)or GetWidgetLife(Target)/GetUnitState(Target,UNIT_STATE_MAX_LIFE) < I38*0.05+0.15)and GetUnitAbilityLevel(UEF,'B0AN')==0 then//B0AN -> Deathlust
		call IssueTargetOrderById(I68[GetPlayerId(GetOwningPlayer(UEF))],852101,UEF)
	elseif IsUnitVisibleLoD(Target,GetOwningPlayer(UEF))==false then
		if(LoadBoolean(HY,h,270)) then
			if(LoadBoolean(HY,h,271)) then
				if(LoadBoolean(HY,h,272)) then
					call FlushChildHashtable(HY,h)
					call CleanTrigger(t)
					call KillUnit(UEF)
				else
					call SaveBoolean(HY,h,272,(true))
				endif
			else
				call SaveBoolean(HY,h,271,(true))
			endif
		else
			call SaveBoolean(HY,h,270,(true))
		endif
	else
		call SaveBoolean(HY,h,270,(false))
		call SaveBoolean(HY,h,271,(false))
		call SaveBoolean(HY,h,272,(false))
	endif
	set t=null
	set Target=null
	set UEF=null
	return false
endfunction

function UFF takes nothing returns boolean
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Target=GetEnumUnit()
	local unit UEF=CreateUnit(IC8,'n0F5',GetUnitX(Target),GetUnitY(Target),0)//n0F5 -> Living Dead
	call IssueTargetOrderById(UEF,ORDER_attack,Target)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterUnitEvent(t,UEF,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,UEF,EVENT_UNIT_ISSUED_ORDER)
	call TriggerRegisterUnitEvent(t,UEF,EVENT_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterUnitEvent(t,UEF,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddCondition(t,Condition(function UDF))
	call SaveUnitHandle(HY,h,30,((Target)))
	call SaveUnitHandle(HY,h,269,(UEF))
	call SaveInteger(HY,h,5,(I38))
	set t=null
	set Target=null
	set UEF=null
	return false
endfunction

function UGF takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())=='n0F5' and GetWidgetLife(GetFilterUnit())>1 then//n0F5 -> Living Dead
		call KillUnit(GetFilterUnit())
	endif
	return false
endfunction

function UHF takes player p returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,p,Condition(function UGF))
	call KillGroup(g)
	set g=null
endfunction

function UIF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit UJF=(LoadUnitHandle(HY,h,266))
	local unit UKF=(LoadUnitHandle(HY,h,267))
	local unit UMF=(LoadUnitHandle(HY,h,268))
	local integer Level=(LoadInteger(HY,h,5))
	local group g
	local player AXD
	if IsSentinel(GetOwningPlayer(Source))then
		set AXD=Scourges[0]
	else
		set AXD=Sentinels[0]
	endif
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		if(LoadBoolean(HY,h,265))then
			call TimedReveal(AXD,.4,GetUnitX(Source),GetUnitY(Source),600)
		endif
		call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UDeathMedium\\UDeath.mdl",GetUnitX(Source),GetUnitY(Source)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call RemoveUnitDelayed(Source,2)
		//call ShowUnit(Source,false)
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\Darksummoning\\DarkSummonTarget.mdl",GetUnitX(UJF),GetUnitY(UJF)))
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\Darksummoning\\DarkSummonTarget.mdl",GetUnitX(UKF),GetUnitY(UKF)))
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\Darksummoning\\DarkSummonTarget.mdl",GetUnitX(UMF),GetUnitY(UMF)))
		call RemoveUnit(UJF)
		call RemoveUnit(UKF)
		call RemoveUnit(UMF)
		call UHF(GetOwningPlayer(Source))
	else
		if IsUnitVisibleLoD(Source,AXD)then
			call SaveBoolean(HY,h,265,(true))
		endif
		set g=GetAvailableGroup()
		set tt_unit1=Source
		set IC8=GetOwningPlayer(Source)
		set I38=Level
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),25+400+200*Level,Condition(function LT8))
		if GameEnded==false then
			call ForGroup(g,function UFF)
		endif
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Source=null
	set UJF=null
	set UKF=null
	set UMF=null
	set AXD=null
	return false
endfunction

function TombstoneDamaged takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call RemoveSavedBoolean(HY,h,0)
		call CleanTrigger(GetTriggeringTrigger())
	elseif IsUnitIdType(GetUnitTypeId(GetEventDamageSource()),UNIT_TYPE_HERO)==false or GetUnitAbilityLevel(GetEventDamageSource(),'A1W4')>0 then
		if (GetUnitTypeId(GetEventDamageSource())=='n01G' or GetUnitAbilityLevel(GetEventDamageSource(),'A1W4')>0) then
			if LoadBoolean(HY,h,0)==false then
				call SaveBoolean(HY,h,0,true)
				call DamageTarget(GetEventDamageSource(),GetTriggerUnit(),10,1)
				call SaveBoolean(HY,h,0,false)
			endif
		else
			call HealUnitFor(GetTriggerUnit(),0.5)
		endif
	endif
endfunction

function Undying_TombStone takes nothing returns nothing
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local unit obelisk
	local real dx
	local real dy
	local real UOF
	local unit aco1
	local unit aco2
	local unit aco3
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A15V')//A15V -> Tombstone
	local integer id
	local real a
	local string s
	local string ss
	local integer i=1
	local integer synergylvl=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))],'A0A8')
	if Level==1 then
		set obelisk=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'n0FJ',x,y,0)//n0FJ -> Tombstone - Level 1
	elseif Level==2 then
		set obelisk=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'n0FI',x,y,0)//n0FI -> Tombstone - Level 2
	elseif Level==3 then
		set obelisk=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'n0F6',x,y,0)//n0F6 -> Tombstone - Level 3
	else
		set obelisk=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'n0FH',x,y,0)//n0FH -> Tombstone - Level 4
	endif
	call SetUnitAnimation(obelisk,"birth")
	if synergylvl>0 then
		call UnitAddAbility2(obelisk,'A1AC')
	endif
	call PlaySoundAtPos(MF,x,y)
	set id=GetPlayerId(GetOwningPlayer(obelisk))
	if I68[id]==null then
		set I68[id]=CreateUnit(GetOwningPlayer(obelisk),'e01V',x,y,0)//e01V -> Spellcaster #3
		call UnitAddAbility2(I68[id],'A176')//A176 -> Tombstone Bonus
	endif
	call SetUnitPosition(obelisk,SafeX50(x),SafeY50(y))
	call UnitApplyTimedLife(obelisk,'BTLF',10+5*Level)
	call KillTrees(x,y,300)
	set dx=x+200*Cos(0*bj_DEGTORAD)
	set dy=y+200*Sin(0*bj_DEGTORAD)
	set UOF=AngleBetweenXY(dx,dy,x,y)
	set aco1=CreateUnit(GetOwningPlayer(obelisk),'h07H',dx,dy,UOF)//h07H -> Tombstone Acolyte
	set ss="Stand Work Gold"
	call SetUnitAnimation(aco1,ss)
	set dx=x+200*Cos(120*bj_DEGTORAD)
	set dy=y+200*Sin(120*bj_DEGTORAD)
	set UOF=AngleBetweenXY(dx,dy,x,y)
	set aco2=CreateUnit(GetOwningPlayer(obelisk),'h07H',dx,dy,UOF)//h07H -> Tombstone Acolyte
	call SetUnitAnimation(aco2,ss)
	set dx=x+200*Cos(240*bj_DEGTORAD)
	set dy=y+200*Sin(240*bj_DEGTORAD)
	set UOF=AngleBetweenXY(dx,dy,x,y)
	set aco3=CreateUnit(GetOwningPlayer(obelisk),'h07H',dx,dy,UOF)//h07H -> Tombstone Acolyte
	call SetUnitAnimation(aco3,ss)
	set s="Stand Work"
	call SetUnitAnimation(obelisk,s)
	set i=1
	loop
		call QueueUnitAnimation(aco1,ss)
		call QueueUnitAnimation(aco2,ss)
		call QueueUnitAnimation(aco3,ss)
		call QueueUnitAnimation(obelisk,s)
		set i=i+1
		exitwhen i>17
	endloop
	call TriggerRegisterUnitEvent(t,obelisk,EVENT_UNIT_DEATH)
	if synergylvl>0 then
		call TriggerRegisterTimerEvent(t,3.1-0.4*synergylvl,true)
	else
		call TriggerRegisterTimerEvent(t,3,true)
	endif
	call TriggerAddCondition(t,Condition(function UIF))
	call SaveUnitHandle(HY,h,2,(obelisk))
	call SaveUnitHandle(HY,h,266,(aco1))
	call SaveUnitHandle(HY,h,267,(aco2))
	call SaveUnitHandle(HY,h,268,(aco3))
	call SaveInteger(HY,h,5,(Level))
	call SaveBoolean(HY,h,265,(false))
	call TriggerEvaluate(t)
	set t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,obelisk,EVENT_UNIT_DAMAGED)
	call TriggerRegisterDeathEvent(t,obelisk)
	call TriggerAddCondition(t,Condition(function TombstoneDamaged))
	set obelisk=null
	set aco1=null
	set aco2=null
	set aco3=null
	set t=null
endfunction

function UQF takes unit whichUnit returns boolean
	return LoadInteger(HeroStats,GetHandleId(whichUnit),'AGH1')=='QM03' or LoadInteger(HeroStats,GetHandleId(whichUnit),'AGH2')=='QM03'//QM03 -> Flesh Golem, QM03 -> Flesh Golem
endfunction

function USF takes nothing returns nothing
	if IsUnitType(tt_unit1,UNIT_TYPE_HERO) then
		if UQF(tt_unit2)then
			call SetWidgetLife(tt_unit2,GetWidgetLife(tt_unit2)+GetUnitState(tt_unit2,UNIT_STATE_MAX_LIFE)*.1)
		else
			call SetWidgetLife(tt_unit2,GetWidgetLife(tt_unit2)+GetUnitState(tt_unit2,UNIT_STATE_MAX_LIFE)*.06)
		endif
	else
		if UQF(tt_unit2)then
			call SetWidgetLife(tt_unit2,GetWidgetLife(tt_unit2)+GetUnitState(tt_unit2,UNIT_STATE_MAX_LIFE)*.03)
		else
			call SetWidgetLife(tt_unit2,GetWidgetLife(tt_unit2)+GetUnitState(tt_unit2,UNIT_STATE_MAX_LIFE)*.02)
		endif
	endif
endfunction


function Dirge_Golem_Fix_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	call SaveBoolean(MHT,LoadInteger(MHT,GetHandleId(t),0),'QM03',false)//QM03 -> Flesh Golem
	call Timer_End(t)
	set t = null
endfunction

function Dirge_Golem_Fix_Start takes unit u returns nothing
	local timer t = CreateTimer()
	local integer info = GetHandleId(u)
	call SaveBoolean(MHT,info,'QM03',true)//QM03 -> Flesh Golem
	call SaveInteger(MHT,GetHandleId(t),0,info)
	call TimerStart(t,.25,false,function Dirge_Golem_Fix_End)
	set t = null
endfunction

function FleshGolemRecountAmpl takes unit source, group g returns nothing
	local group gg=GetAvailableGroup()
	local unit u
	local real oldampl
	local real d
	local real a
	call GroupAddGroup(g,gg)
	loop
		set u=FirstOfGroup(gg)
		exitwhen u==null
		set oldampl=LoadReal(HY,GetHandleId(u),'ZMBI')
		set d=DistanceBetweenUnits(source,u)
		if d<775 then
			set a=20+5*GetUnitAbilityLevel(source,'QM03')//QM03 -> Flesh Golem
			if UQF(source)then
				set a=a+5
			endif
			if d>200 then
				set a=a-15*((d-150)/(775-150))
			endif
			set a=a/100
			if a!=oldampl then
				call SaveReal(HY,GetHandleId(u),'AMPL',LoadReal(HY,GetHandleId(u),'AMPL') - oldampl + a)
				call SaveReal(HY,GetHandleId(u),'ZMBI',a)
				
			endif
		else
			call SaveReal(HY,GetHandleId(u),'AMPL',LoadReal(HY,GetHandleId(u),'AMPL') - oldampl)
			call RemoveSavedReal(HY,GetHandleId(u),'ZMBI')
			//call GroupRemoveUnit(g,u)
		endif
		call GroupRemoveUnit(gg,u)
	endloop
	call KillGroup(gg)
endfunction

function ZombieBonusDamageRemoveDelayedB takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local group g=LoadGroupHandle(HY,h,0)
	call FleshGolemRecountAmpl(null,g)
	call KillGroup(g)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set g=null
endfunction

function ZombieBonusDamageRemoveDelayed takes group g returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.,false,function ZombieBonusDamageRemoveDelayedB)
	call SaveGroupHandle(HY,GetHandleId(t),0,g)
	set t=null
endfunction

function UTF takes nothing returns boolean
	local trigger t2=GetTriggeringTrigger()
	local integer h2=GetHandleId(t2)
	local trigger t1=LoadTriggerHandle(HY,h2,274)
	local integer h=GetHandleId(t1)
	local unit Source=LoadUnitHandle(HY,h2,2)
	local unit Target
	local real d
	local real a
	local boolean b=LoadBoolean(HY,h2,273)
	local real timelim=LoadReal(HY,h2,30)
	if (GetTriggerEventId()==EVENT_UNIT_DEATH and GetTriggerUnit()==Source) or (GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED and TimerGetElapsed(GlobalTimer)>timelim) then
		call Dirge_Golem_Fix_Start(Source)
		call ZombieBonusDamageRemoveDelayed(LoadGroupHandle(HY,h2,30))
		//call FleshGolemRecountAmpl(null,LoadGroupHandle(HY,h2,30))
		call FlushChildHashtable(HY,h)
		//call KillGroup(LoadGroupHandle(HY,h2,30))
		call FlushChildHashtable(HY,h2)
		call CleanTrigger(t1)
		call CleanTrigger(t2)
	elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		call FleshGolemRecountAmpl(Source,LoadGroupHandle(HY,h2,30))
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
//		if LoadBoolean(HY,h2,0)==false then
//			call SaveBoolean(HY,h2,0,true)
//			set Target=GetTriggerUnit()
//			set d=DistanceBetweenUnits(Target,Source)
//			if d<775 and GetEventDamage()>4 then
//				set a=20+5*GetUnitAbilityLevel(Source,'QM03')//QM03 -> Flesh Golem
//				if IsUnitHasAghanim(Source)then
//					set a=a+5
//				endif
//				if d>200 then
//					set a=a-15*((d-150)/625)
//				endif
//				set a=a/100
//				call DamageTarget(GetEventDamageSource(),GetTriggerUnit(),3,GetEventDamage()*a)
////				call echo(R2S(GetEventDamage()*a))
//			endif
//			call SaveBoolean(HY,h2,0,false)
//			set Target=null
//		endif
	elseif GetTriggerEventId()==EVENT_UNIT_DEATH then
		if IsUnitIllusion(GetDyingUnit())==false then
			call AddProjectile(GetDyingUnit(),Source,'h07Y',"USF",9999,false)//h07Y -> Raise Dead Projectile
		endif
	endif
	set t2=null
	set t1=null
	set Source=null
	set Target=null
	return false
endfunction

function UVF takes nothing returns boolean
	local trigger t1=GetTriggeringTrigger()
	local integer R2E=GetHandleId(t1)
	local trigger t2=(LoadTriggerHandle(HY,(R2E),275))
	local integer Cache2=GetHandleId(t2)
	local unit Target=GetTriggerUnit()
	local unit Source=(LoadUnitHandle(HY,(R2E),2))
	if IsUnitEnemy(Source,GetOwningPlayer(Target)) and IsUnitType(Target,UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(Target,'A04R')==0 then//
		if(LoadBoolean(HY,(Cache2),(GetHandleId(Target))))==false then
			call GroupAddUnit(LoadGroupHandle(HY,Cache2,30),Target)
			//call TriggerRegisterUnitEvent(t2,Target,EVENT_UNIT_DAMAGED)
			call TriggerRegisterUnitEvent(t2,Target,EVENT_UNIT_DEATH)
			call TriggerRegisterTimerEvent(t2,0.1,true)
			call SaveBoolean(HY,(Cache2),(GetHandleId(Target)),(true))
		endif
	endif
	set t1=null
	set t2=null
	set Target=null
	set Source=null
	return false
endfunction

function UWF takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t1=CreateTrigger()
	local integer R2E=GetHandleId(t1)
	local trigger t2=CreateTrigger()
	local integer Cache2=GetHandleId(t2)
	local integer Level=GetUnitAbilityLevel(Source,'QM03')//QM03 -> Flesh Golem
	call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A17A',false)//A17A -> Plague Aura Container
	call TriggerRegisterUnitInRange(t1,Source,750,Condition(function ReturnTrue))
	call TriggerAddCondition(t1,Condition(function UVF))
	call SaveTriggerHandle(HY,(R2E),275,(t2))
	call SaveUnitHandle(HY,(R2E),2,(Source))
	call TriggerRegisterTimerEvent(t2,30,false)
	call SaveReal(HY,Cache2,30,TimerGetElapsed(GlobalTimer)+30.)
	call TriggerRegisterUnitEvent(t2,Source,EVENT_UNIT_DEATH)
	call TriggerAddCondition(t2,Condition(function UTF))
	call SaveTriggerHandle(HY,(Cache2),274,(t1))
	call SaveUnitHandle(HY,(Cache2),2,(Source))
	call SaveBoolean(HY,(Cache2),273,(false))
	call SaveGroupHandle(HY,Cache2,30,GetAvailableGroup())
	set Source=null
	set t1=null
	set t2=null
endfunction

function Undying_FleshGolem takes nothing returns nothing
	if GetUnitTypeId(GetTriggerUnit())!='H07I' then//H07I -> Flesh Golem
		call UWF()
		call GroupAddUnit(FleshGolems,GetTriggerUnit())
	else
		call GroupRemoveUnit(FleshGolems,GetTriggerUnit())
	endif
	if GetUnitAbilityLevel(GetTriggerUnit(),'QINV')==1 then
		call UnitRemoveAbility(GetTriggerUnit(),'QINV')
//		call echo("del")
//		call echo(Id2String(GetItemTypeId(UnitItemInSlot(GetTriggerUnit(),0))))
	else
//		call echo("none")
	endif
endfunction

function UYF takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),I58)==false then
		call GroupAddUnit(I58,GetEnumUnit())
		call UnitAddAbilityTimedExF(GetEnumUnit(),I28,1,3,'B05Q')//B05Q -> Time Walk
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\SpellShieldAmulet\\SpellShieldCaster.mdl",GetEnumUnit(),"overhead"))
	endif
endfunction

function UZF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real x2=LoadReal(HY,h,66)
	local real y2=LoadReal(HY,h,67)
	local real a=LoadReal(HY,h,137)
	local integer Count=GetTriggerEvalCount(t)
	local real x=GetUnitX(Hero)
	local real y=GetUnitY(Hero)
	local real LastX=LoadReal(HY,h,23)
	local real LastY=LoadReal(HY,h,24)
	local unit Caster=LoadUnitHandle(HY,h,19)
	local group g=GetAvailableGroup()
	local group AlreadyHit=LoadGroupHandle(HY,h,187)
	local integer Level=LoadInteger(HY,h,0)
	if DistanceBetweenXY(x,y,x2,y2)<=53 then
		set x=x2
		set y=y2
	else
		set x=LastX+60*Cos(a*bj_DEGTORAD)
		set y=LastY+60*Sin(a*bj_DEGTORAD)
	endif
	if Level==1 then
		set I28='A294'//A29A -> Timewalk Container - 1
	elseif Level==2 then
		set I28='A295'//A299 -> Timewalk Container - 2
	elseif Level==3 then
		set I28='A296'//A29B -> Timewalk Container - 3
	elseif Level==4 then
		set I28='A297'//A298 -> Timewalk Container - 4
	endif
	set tt_unit1=Hero
	set I58=AlreadyHit
	call GroupEnumUnitsInRange(g,x,y,325,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	call ForGroup(g,function UYF)
	call KillGroup(g)
	call SaveReal(HY,h,23,x*1.)
	call SaveReal(HY,h,24,y*1.)
	call SetUnitPosition(Hero,x,y)
	if(x==x2 and y==y2)or Count>LoadInteger(HY,h,0) then
		if IsUnitType(Caster,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(Caster),99,true)
		endif
		call SetUnitX(Caster,SafeX50(x))
		call SetUnitY(Caster,SafeY50(y))
		call IssueImmediateOrderById(Caster,852096)
		call KillGroup(AlreadyHit)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SetUnitAnimation(Hero,"stand")
		call SetUnitPathing(Hero,true)
		call SetUnitInvulnerable(Hero,false)
		call RestoreTint(Hero)
		call SaveInteger(HY,GetHandleId(Hero),4261,2)
	endif
	set t=null
	set Hero=null
	set Caster=null
	set AlreadyHit=null
	set g=null
	return false
endfunction

function Void_Timewalk takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real x1=GetUnitX(Hero)
	local real y1=GetUnitY(Hero)
	local real x2
	local real y2
	local real a
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',x1,y1,0)//e00E -> Spellcaster
	if GetSpellTargetUnit()==null then
		set x2=GetSpellTargetX()
		set y2=GetSpellTargetY()
	else
		set x2=GetUnitX(GetSpellTargetUnit())
		set y2=GetUnitY(GetSpellTargetUnit())
	endif
	set a=AngleBetweenXY(x1,y1,x2,y2)
	call SetUnitAnimationByIndex(Hero,0)
	call SetUnitPathing(Hero,false)
	call SetUnitInvulnerable(Hero,true)
	call SetTint(Hero,0,0,0,-1)
	call SaveInteger(HY,GetHandleId(Hero),4261,1)
	call SaveReal(HY,h,66,x2*1.)
	call SaveReal(HY,h,67,y2*1.)
	call SaveReal(HY,h,23,x1*1.)
	call SaveReal(HY,h,24,y1*1.)
	call SaveReal(HY,h,137,a*1.)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveUnitHandle(HY,h,19,Caster)
	call SaveGroupHandle(HY,h,187,GetAvailableGroup())
	call SaveInteger(HY,h,0,R2I((500+200*GetUnitAbilityLevel(Hero,'A0LK'))/60.))
	call UnitAddAbility2(Caster,'A0LA')//A0LA -> Time Walk slow
	call SetUnitAbilityLevel(Caster,'A0LA',GetUnitAbilityLevel(Hero,'A0LK'))//A0LA -> Time Walk slow, A0LK -> Time Walk
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function UZF))
	set Hero=null
	set t=null
	set Caster=null
endfunction

function Void_Backtrack_Act takes nothing returns nothing
	local unit void=GetTriggerUnit()
	local real Damage=GetEventDamage()
	if(Damage>0)and GetWidgetLife(void)>1 and IsRealDamage and GetUnitAbilityLevel(void,'A36D')==0 then
		if (Damage<=20) then
			if GetRandomInt(0,100)< 5+5*(GetUnitAbilityLevel(void,'A0CZ')) then//A0CZ -> Backtrack, QP22 -> Backtrack
				call SetWidgetLife(void,GetWidgetLife(void)+Damage)
				call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\WingedSerpentMissile\\WingedSerpentMissile.mdl",void,"hand,left"))
			endif
		elseif PRD_Get(void,'A0CZ',5+5*(GetUnitAbilityLevel(void,'A0CZ'))) then//A0CZ -> Backtrack, A0CZ -> Backtrack, QP22 -> Backtrack
			call SetWidgetLife(void,GetWidgetLife(void)+Damage)
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\WingedSerpentMissile\\WingedSerpentMissile.mdl",void,"hand,left"))
		endif
	endif
	set void=null
endfunction

function Void_Backtrack_Init takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function Void_Backtrack_Act))
	set t=null
endfunction

function U1F takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit U0F=(LoadUnitHandle(HY,h,19))
	call PauseTimer(t)
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
	set U0F=null
endfunction

function U2F takes nothing returns boolean
	return IsDead(GetFilterUnit())==false and GetOwningPlayer(GetFilterUnit())!=GetOwningPlayer(tt_unit1) and GetOwningPlayer(GetFilterUnit())!=Player15
endfunction

function U2F2 takes nothing returns boolean
	return IsDead(GetTriggerUnit())==false and GetOwningPlayer(GetTriggerUnit())!=GetOwningPlayer(tt_unit1) and GetOwningPlayer(GetTriggerUnit())!=Player15
endfunction

function ChronoPersonal takes unit u returns nothing
	call SetUnitTimeScale(u,0)
	call SaveBoolean(HY,GetHandleId(u),4306,true)
	if IsHeroUnitId(GetUnitTypeId(u)) or IsUnitIllusion(u)then
		if IsUnitPaused(u)==false then
			if IssueTargetOrder(LoadUnitHandle(TempHash,'CHRN',0),"thunderbolt",u)==false then
				call UnitShareVision(u,GetOwningPlayer(LoadUnitHandle(TempHash,'CHRN',0)),true)
				if IssueTargetOrder(LoadUnitHandle(TempHash,'CHRN',0),"thunderbolt",u)==false then
					if IsUnitCycloned(u)==false and IsUnitSleeping(u)==false then//unknown error
						call PauseUnit(u,true)
					endif
				endif
				call UnitShareVision(u,GetOwningPlayer(LoadUnitHandle(TempHash,'CHRN',0)),false)
			endif
		endif
	else
		call PauseUnit(u,true)
	endif
endfunction

function V4F takes nothing returns nothing
	call ChronoPersonal(GetEnumUnit())
endfunction

function V7F takes nothing returns nothing
	local unit u = GetEnumUnit()
	call SaveBoolean(HY,GetHandleId(u),4306,false)
	call PauseUnit(u,false)
	call SetUnitTimeScale(u,1)
	set u = null
endfunction

function V8F takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit d=LoadUnitHandle(HY,h,19)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local integer lvl=LoadInteger(HY,h,5)
	local group g=LoadGroupHandle(HY,h,220)
	local integer c=LoadInteger(HY,h,28)
	local real TargetX=GetUnitX(d)
	local real TargetY=GetUnitY(d)
	local group gg
	local integer dur=LoadInteger(HY,h,6)
	call SaveUnitHandle(TempHash,'CHRN',0,d)
	if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		
		set c=c+1
		call SaveInteger(HY,h,28,c)
		if DistanceBetweenUnits(Hero,d)<435 then
			call CustomSpeed(Hero,999,700)
		else
			call CustomSpeed(Hero,0,0)
		endif
		set gg=GetAvailableGroup()
		call ForGroup(g,function V7F)
		set tt_unit1=Hero
		call GroupEnumUnitsInRange(gg,TargetX,TargetY,475,Condition(function U2F))
		call GroupClear(g)
		call GroupAddGroup(gg,g)
		call ForGroup(gg,function V4F)
		call KillGroup(gg)
	else
		set tt_unit1=Hero
		if U2F2() and GetUnitAbilityLevel(GetTriggerUnit(),'Aloc')==0 and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 and IsUnitInGroup(GetTriggerUnit(),g)==false then
			call GroupAddUnit(g,GetTriggerUnit())
			call ChronoPersonal(GetTriggerUnit())
		endif
	endif
	call RemoveSavedHandle(TempHash,'CHRN',0)
	if c>dur then
		if GameEnded==false then
			call ForGroup(g,function V7F)
		endif
		call CustomSpeed(Hero,0,0)
		call KillUnit(d)
		call RemoveUnit(d)
		call KillUnit(LoadUnitHandle(HY,h,18))
		call KillGroup(g)
		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)
	endif
	set t=null
	set d=null
	set Hero=null
	set g=null
	set gg=null
endfunction

function Void_Chronosphere takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Hero,'A0J1')+GetUnitAbilityLevel(Hero,'A1D7')//A0J1 -> Chronosphere, A1D7 -> Chronosphere Upgraded
	local real TargetX=GetSpellTargetX()
	local real TargetY=GetSpellTargetY()
	local unit d=CreateUnit(GetOwningPlayer(Hero),'u00L',TargetX,TargetY,0)//u00L -> ChronoSphere
	local integer h
	local trigger tt
	local unit visionDummy=CreateUnit(GetOwningPlayer(Hero),'e00E',TargetX,TargetY,0)
	call UnitAddAbility(visionDummy,'A21K')
	set tt=CreateTrigger()
	set h=GetHandleId(tt)
	call SaveUnitHandle(HY,h,19,d)
	call SaveUnitHandle(HY,h,18,visionDummy)
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveGroupHandle(HY,h,220,GetAvailableGroup())
	call SaveInteger(HY,h,28,0)
	call SaveInteger(HY,h,5,Level)
	if GetUnitAbilityLevel(Hero,'A1D7')>0 then//A1D7 -> Chronosphere Upgraded
		call SaveInteger(HY,h,6,33+Level*2)
	else
		call SaveInteger(HY,h,6,28+Level*2)
	endif
	call SavePlayerHandle(HY,h,0,GetOwningPlayer(Hero))
	call TriggerRegisterTimerEvent(tt,.1,true)
	call TriggerRegisterTimerEvent(tt,0,false)
	call TriggerRegisterUnitInRange(tt,d,425,Condition(function U2F))
	call TriggerAddCondition(tt,Condition(function V8F))
	call UnitAddAbility(d,'A45D')
	set Hero=null
	set d=null
	set tt=null
	set visionDummy=null
endfunction

function Void_Bash_Effect takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)
	if GetUnitAbilityLevel(u,'B0C2')==0 then//B0C2 -> Stunned
		call RemoveSavedHandle(MHT,GetHandleId(u),'A081')//A081 -> Time Lock
		call Timer_End(t)
		set t = null
		set u = null
		return
	endif
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",u,"chest"))
	set t = null
	set u = null
endfunction

function Void_Bash_Start takes unit u, integer info returns nothing
	local timer t = CreateTimer()
	call SaveTimerHandle(MHT,info,'A081',t)//A081 -> Time Lock
	call SaveUnitHandle(MHT,GetHandleId(t),0,u)
	call TimerStart(t,0.1,true,function Void_Bash_Effect)
	set t = null
endfunction

function Void_Bash_Condition takes unit u, unit t returns nothing
	local integer info = GetHandleId(t)
	local integer level = GetUnitAbilityLevel(u,'A081')//A081
	if level>0 and GetUnitAbilityLevel(t,'B0C2')==1 and HaveSavedHandle(MHT,info,'A081')==false then//B0C2 -> Stunned, A081 -> Time Lock
		call Void_Bash_Start(t,GetHandleId(t))
		if LoadBoolean(HY,info,4306)then
			call DamageTarget(u,t,1,level*10 + 30)
		endif
	endif
endfunction

function MeltingStrikeOff takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,30)
	local integer hu=GetHandleId(u)
	local integer c=LoadInteger(HY,h,1)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or c==1 then
		call LoDStat_Sub(u,LoadInteger(HY,h,2),"armourneg")
		call RemoveSavedHandle(HY,hu,'A0VW')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SaveInteger(HY,h,1,c-1)
	endif
	set t=null
	set u=null
endfunction

function X8F takes unit u returns nothing
	local trigger t
	local integer h
	local integer lvl
	local integer c
	//=GetUnitAbilityLevel(u,'A0VW')
	if HaveSavedHandle(HY,GetHandleId(u),'A0VW') then
		set t=LoadTriggerHandle(HY,GetHandleId(u),'A0VW')
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,5,false)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,GetHandleId(u),'A0VW',t)
		call TriggerRegisterTimerEvent(t,5,false)
		call TriggerRegisterDeathEvent(t,u)
		call SaveUnitHandle(HY,h,30,u)
		call TriggerAddCondition(t,Condition(function MeltingStrikeOff))
	endif
	set c=LoadInteger(HY,h,2)
	if c<10 then
		call SaveInteger(HY,h,2,c+1)
		call LoDStat_Add(u,1,"armourneg")
	endif
	call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+1)
	set t=null
endfunction

function X9F takes nothing returns boolean
	local real d
	if GetUnitAbilityLevel(GetTriggerUnit(),'B091')>0 and GetUnitAbilityLevel(GetEventDamageSource(),'A0VV')>0 and(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2))==GetEventDamageSource()then//B091 -> Melting Strike, A0VV -> Melting Strike
		call UnitRemoveAbility(GetTriggerUnit(),'B091')//B091 -> Melting Strike
		call DisableTrigger(GetTriggeringTrigger())
		call X8F(GetTriggerUnit())
		call FlushChildHashtable(HY,(GetHandleId(GetTriggeringTrigger())))
		call CleanTrigger(GetTriggeringTrigger())
	endif
	return false
endfunction

function XDF takes nothing returns nothing
	local trigger t
	local unit Target
	local unit Source
	if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		set Target=GetSpellTargetUnit()
		set Source=GetTriggerUnit()
	else
		set Target=GetTriggerUnit()
		set Source=GetAttacker()
	endif
	if IsUnitIllusion(Source)==false then
		set t=CreateTrigger()
		call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
		call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(t,Condition(function X9F))
	endif
	set t=null
	set Target=null
	set Source=null
endfunction

function XEF takes nothing returns boolean
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
		if GetUnitAbilityLevel(GetAttacker(),'A0VV')>0 and(LoadBoolean(HY,(GetHandleId(GetTriggeringTrigger())),3008))and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetAttacker()==(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2))then//A0VV -> Melting Strike
			call XDF()
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then
		if(GetIssuedOrderId()==852255)then
			call SaveBoolean(HY,(GetHandleId(GetTriggeringTrigger())),3008,(true))
		elseif(GetIssuedOrderId()==852256)then
			call SaveBoolean(HY,(GetHandleId(GetTriggeringTrigger())),3008,(false))
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A0VV' then//A0VV -> Melting Strike
		call XDF()
	endif
	return false
endfunction

function XFF takes unit Source returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_ORDER)
	call TriggerAddCondition(t,Condition(function XEF))
	call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
	call SaveBoolean(HY,(GetHandleId(t)),3008,(true))
	set t=null
endfunction

function YYF takes nothing returns boolean
	if b_isPickTime==false then
	if(isPlayerPickedAbility(GetOwningPlayer(GetTriggerUnit()),316)or isPlayerPickedAbility(GetOwningPlayer(GetTriggerUnit()),212))and IsUnitIllusion(GetTriggerUnit())==false then
		set tt_unit1=GetTriggerUnit()
	elseif isPlayerPickedAbility(GetOwningPlayer(GetTriggerUnit()),356) and IsUnitIllusion(GetTriggerUnit())==false and GetUnitTypeId(GetTriggerUnit())!='H00J' then//H00J -> Geomancer
		set tt_unit1=GetTriggerUnit()
		call ExecuteFunc("Register_DividedWeStand")
	endif
	endif
	return false
endfunction

function Lod_DeafeningBlast_DisableAffected takes unit Source,unit Target,integer Level returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A0VT')//A0VT -> Invoke5 - NoAtck
	call SetUnitAbilityLevel(Caster,'A0VT',Level)//A0VT -> Invoke5 - NoAtck
	call IssueTargetOrderById(Caster,852585,Target)
	set Caster=null
endfunction

function Lod_DeafeningBlast_MoveAffected takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real a=(LoadReal(HY,h,13))
	local real QQE=(LoadReal(HY,h,193))
	local integer Level=(LoadInteger(HY,h,5))
	local integer RHE=Level*40/ 3
	local real x
	local real y
	local integer Count=GetTriggerEvalCount(t)
	if Count>RHE/ 3 then
		call SaveReal(HY,h,193,((QQE*.98)*1.))
	endif
	if Count>RHE or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if GetTriggerEventId()!=EVENT_WIDGET_DEATH then
			call Lod_DeafeningBlast_DisableAffected(Source,Target,Level)
		endif
	else
		set x=SafeX50(GetUnitX(Target)+QQE*Cos(a))
		set y=SafeY50(GetUnitY(Target)+QQE*Sin(a))
		call KillTrees(x,y,150)
		call SetUnitPosition(Target,x,y)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function Lod_DeafeningBlast_Affect takes unit Source,unit Target,integer Level returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real a=Atan2(GetUnitY(Target)-GetUnitY(Source),GetUnitX(Target)-GetUnitX(Source))
	call DamageTarget(Source,Target,1,20+60*Level)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveReal(HY,h,193,(6*1.))
	call SaveInteger(HY,h,5,(Level))
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function Lod_DeafeningBlast_MoveAffected))
	set t=null
endfunction

function Lod_DeafeningBlast_HitCheck takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),DK)==false and IsMagicImmune(GetEnumUnit())==false then
		call GroupAddUnit(DK,GetEnumUnit())
		call Lod_DeafeningBlast_Affect(tt_unit1,GetEnumUnit(),tt_int1)
	endif
endfunction

function Lod_DeafeningBlast_Move takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local real a=(LoadReal(HY,h,137))
	local real x2=(LoadReal(HY,h,66))
	local real y2=(LoadReal(HY,h,67))
	local group g=(LoadGroupHandle(HY,h,22))
	local integer Level=(LoadInteger(HY,h,5))
	local real x=GetUnitX(Caster)
	local real y=GetUnitY(Caster)
	local group g2
	if DistanceBetweenXY(x,y,x2,y2)<100 then
		set x=x2
		set y=y2
	else
		set x=x+33*Cos(a)
		set y=y+33*Sin(a)
	endif
	call SetUnitX(Caster,SafeX50(x))
	call SetUnitY(Caster,SafeY50(y))
	set g2=GetAvailableGroup()
	set tt_unit1=Caster
	set DK=g
	set tt_int1=Level
	call GroupEnumUnitsInRange(g2,x,y,200,Condition(function NonImmuneEnemyFilterWithAncients))
	call ForGroup(g2,function Lod_DeafeningBlast_HitCheck)
	call KillGroup(g2)
	if(x==x2 and y==y2)or GetTriggerEvalCount(t)>35 then
		set g2=GetAvailableGroup()
		set tt_unit1=Caster
		set DK=g
		set tt_int1=Level
		call GroupEnumUnitsInRange(g2,x,y,250,Condition(function NonImmuneEnemyFilterWithAncients))
		call ForGroup(g2,function Lod_DeafeningBlast_HitCheck)
		call KillGroup(g2)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(Caster)
		call KillGroup(g)
	endif
	set t=null
	set Caster=null
	set g=null
	set g2=null
	return false
endfunction

function MaxedBlastPeriodic takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local group g=(LoadGroupHandle(HY,(h),22))
	local integer i=0
	local unit d
	local real a
	local real tx
	local real ty
	local real x
	local real y
	local group gg
	set gg=GetAvailableGroup()
	loop
		
		set d=LoadUnitHandle(HY,h,100+i)
		set tx=LoadReal(HY,h,200+i)
		set ty=LoadReal(HY,h,300+i)
		set a=LoadReal(HY,h,100+i)
		set x=GetUnitX(d)
		set y=GetUnitY(d)
		
		if DistanceBetweenXY(x,y,tx,ty)<100 then
			set x=tx
			set y=ty
		else
			set x=x+33*Cos(a)
			set y=y+33*Sin(a)
		endif
		call SetUnitX(d,SafeX50(x))
		call SetUnitY(d,SafeY50(y))
		
		set tt_unit1=d
		set DK=g
		set tt_int1=4
		call GroupEnumUnitsInRange(gg,x,y,200,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(gg,function Lod_DeafeningBlast_HitCheck)
		
		if GetTriggerEvalCount(t)>30 then
			call GroupClear(gg)
			set tt_unit1=d
			set DK=g
			set tt_int1=4
			call GroupEnumUnitsInRange(gg,x,y,250,Condition(function DefaultEnemyFilterWithAncients))
			call ForGroup(gg,function Lod_DeafeningBlast_HitCheck)
			call GroupClear(gg)
			
			call KillUnit(d)
		endif
		call GroupClear(gg)
		set i=i+1
		exitwhen i==12
	endloop
	call KillGroup(gg)
	if GetTriggerEvalCount(t)>33 then
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
		call KillGroup(g)
	endif
	set t=null
	set d=null
	set g=null
	set gg=null
	return false
endfunction

function MaxedBlast takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit caster=GetTriggerUnit()
	local real a=0
	local unit d
	local integer i=0
	local integer lim=12
	loop
		set a=30*i
		set d=CreateUnit(GetOwningPlayer(caster),'n01X',GetUnitX(caster),GetUnitY(caster),a)//n01X -> Defeaning Blast projectile
		call SaveUnitHandle(HY,h,100+i,d)
		call SaveReal(HY,h,100+i,a*bj_DEGTORAD)
		call SetUnitX(d,GetUnitX(caster))
		call SetUnitY(d,GetUnitY(caster))
		call SaveReal(HY,h,200+i,SafeX50(GetUnitX(d)+1000*Cos(a*bj_DEGTORAD)))
		call SaveReal(HY,h,300+i,SafeY50(GetUnitY(d)+1000*Sin(a*bj_DEGTORAD)))
		set i=i+1
		exitwhen i==lim
	endloop
	call TriggerRegisterTimerEvent(t,0.03,true)
	call TriggerAddCondition(t,Condition(function MaxedBlastPeriodic))
	call SaveGroupHandle(HY,(h),22,(GetAvailableGroup()))
	call SaveInteger(HY,h,0,10)
	set t=null
	set caster=null
endfunction

function Lod_DeafeningBlast_Effect takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
	local integer Level=GetUnitAbilityLevel(Source,'Z610')//Z610 -> Deafening Blast
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'n01X',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)//n01X -> Defeaning Blast projectile
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function Lod_DeafeningBlast_Move))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveReal(HY,h,137,((a)*1.))
	call SaveReal(HY,h,66,((GetUnitX(Source)+1000*Cos(a))*1.))
	call SaveReal(HY,h,67,((GetUnitY(Source)+1000*Sin(a))*1.))
	call SaveGroupHandle(HY,h,22,(GetAvailableGroup()))
	call SaveInteger(HY,h,5,(Level))
	set t=null
	set Source=null
	set Caster=null
endfunction

function Lod_DeafeningBlast_EffectWrap takes nothing returns nothing
	if GetSpellAbilityId()=='A3K5' then
		call MaxedBlast()
	else
		call Lod_DeafeningBlast_Effect()
	endif
endfunction

function EMP_ForGroup takes unit caster, unit target, integer manastealk returns nothing
	local real VWF=RMaxIF(RMinIF(GetUnitState(target,UNIT_STATE_MANA),manastealk),0)
	local real VXF=VWF*.5
	local real manasteal=0
	if IsMagicImmune(target)==false and VWF>0 and IsUnitCycloned(target)==false then
		if IsUnitIllusion(target)==false then
			if GetUnitState(target,UNIT_STATE_MANA)>VWF then
				set manasteal=manasteal+VWF
			else
				set manasteal=manasteal+GetUnitState(target,UNIT_STATE_MANA)
			endif
		endif
		if GetWidgetLife(target)>(VXF+.5) then
			call SetWidgetLife(target,GetWidgetLife(target)-VXF)
		else
			call SetWidgetLife(target,1)
			call DamageTarget(JG8,target,1,VXF)
		endif
		call SetUnitState(target,UNIT_STATE_MANA,GetUnitState(target,UNIT_STATE_MANA)-VWF)
	endif
	set manasteal=manasteal/2
	if IsUnitType(caster,UNIT_TYPE_HERO) then
		call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA)+manasteal)
	endif
endfunction

function Lod_EMP_Explode takes unit Source,integer Level, unit Hero returns nothing
	local group g=GetAvailableGroup()
	local unit u2
	set JG8=Source
	set tt_unit1=Source
	set JF8=Level*100
	set tt_unit1=Hero
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),700,Condition(function DefaultEnemyFilterWithAncients))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call GroupRemoveUnit(g,u2)
		call EMP_ForGroup(Hero,u2,Level*100)
	endloop
	call KillGroup(g)
	set g=null
endfunction

function Lod_EMP_Delay takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=GetTriggerEvalCount(t)
	local integer Level=(LoadInteger(HY,h,5))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit VCF
	local real V3F=2.6
	local real V6F=1+(3.9-1)*Count/(V3F/ .05)
	call SetUnitScale(Caster,V6F,V6F,V6F)
	if Count>(V3F/ .05)then
		call Lod_EMP_Explode(Caster,Level,Source)
		set VCF=CreateUnit(GetOwningPlayer(Caster),'e01O',GetUnitX(Caster),GetUnitY(Caster),0)//e01O -> EMP FX
		call SetUnitTimeScale(VCF,.3)
		call RemoveUnit(Caster)
		call KillUnit(VCF)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Caster=null
	set VCF=null
	set Source=null
	return false
endfunction

function Lod_EMP_Effect takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
	local integer Level=GetUnitAbilityLevel(Source,'Z609')//Z609 -> EMP
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e01M',x,y,a*bj_RADTODEG)//e01M -> EMP Main
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function Lod_EMP_Delay))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,5,(Level))
	set t=null
	set Source=null
	set Caster=null
endfunction

function Lod_Tornado_Affect takes unit Source,unit Target,integer Level returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	local unit W4F=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call UnitAddAbility(Caster,'A0XK')//A0XK -> Invoke Tornado Cyclone
	call SetUnitAbilityLevel(Caster,'A0XK',Level)//A0XK -> Invoke Tornado Cyclone
	call UnitAddAbility(Caster,'A3G2')
	call SetUnitAbilityLevel(Caster,'A3G2',Level)
	call SaveUnitHandle(HY,GetHandleId(Caster),0,Source)
	call SimulateCycloneEffect(Target,Caster)
	call DamageTargetDelayed(W4F,Target,1,60.+Level*60.,.8+.3*Level)
	set Caster=null
	set W4F=null
endfunction

function Lod_Tornado_HitCheck takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),DK)==false then
		call GroupAddUnit(DK,GetEnumUnit())
		call Lod_Tornado_Affect(tt_unit1,GetEnumUnit(),tt_int1)
	endif
endfunction

function Lod_Tornado_Move takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local real x2=(LoadReal(HY,h,66))
	local real y2=(LoadReal(HY,h,67))
	local real a=(LoadReal(HY,h,137))
	local integer Level=(LoadInteger(HY,h,5))
	local group g=(LoadGroupHandle(HY,h,22))
	local real x=GetUnitX(Caster)+25*Cos(a)
	local real y=GetUnitY(Caster)+25*Sin(a)
	local group WDF=GetAvailableGroup()
	local real YR8=DistanceBetweenXY(x,y,x2,y2)
	if YR8<=30 then
		set x=x2
		set y=y2
	endif
	call SetUnitX(Caster,SafeX50(x))
	call SetUnitY(Caster,SafeX50(y))
	set tt_unit1=Caster
	set DK=g
	set tt_int1=Level
	call GroupEnumUnitsInRange(WDF,x,y,200,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(WDF,function Lod_Tornado_HitCheck)
	call KillGroup(WDF)
	if YR8<=30 or GetTriggerEvalCount(t)>125 then
		call KillGroup(g)
		call KillUnit(Caster)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Caster=null
	set g=null
	set WDF=null
	return false
endfunction

function Lod_Tornado_Effect takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Source,'Z608')//Z608 -> Tornado
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
	local unit Caster
	if GetUnitTypeId(Source)=='e00E' then //Multicast//e00E -> Spellcaster
		if GetRandomInt(0,1)==1 then
			set a=a+GetRandomReal(0,bj_PI/4)
		else
			set a=a-GetRandomReal(0,bj_PI/4)
		endif
	endif
	set x=GetUnitX(Source)
	set y=GetUnitY(Source)
	set Caster=CreateUnit(GetOwningPlayer(Source),'n01U',x,y,a*bj_RADTODEG)//n01U -> Invoke Tornado projectile
	call TriggerRegisterTimerEvent(t,.025,true)
	call TriggerAddCondition(t,Condition(function Lod_Tornado_Move))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveReal(HY,h,66,(x+(750+500.*Level)*Cos(a)))
	call SaveReal(HY,h,67,(y+(750+500.*Level)*Sin(a)))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,137,((a)*1.))
	call SaveGroupHandle(HY,h,22,(GetAvailableGroup()))
	set t=null
	set Source=null
	set Caster=null
endfunction

function Lod_Alacrity_Effect takes nothing returns nothing
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'Z607')//Z607 -> Alacrity
	call UnitAddAbilityTimedExF(Target,'A0VJ',Level,9,0)
	call UnitAddAbilityTimedExF(Target,'A109',Level,9,0)
	set Target=null
endfunction

function Lod_IceWall_GetSlow takes unit Source returns integer
	local integer Level=GetUnitAbilityLevel(Source,'Z606')+1//Z606 -> Ice Wall
	if Level==1 then
		return 'A230'//A230 -> Ice Wall MS - 1
	elseif Level==2 then
		return 'A22Z'//A22Z -> Ice Wall MS - 2
	elseif Level==3 then
		return 'A22Y'//A22Y -> Ice Wall MS - 3
	elseif Level==4 then
		return 'A22U'//A22U -> Ice Wall MS - 4
	elseif Level==5 then
		return 'A22V'//A22V -> Ice Wall MS - 5
	elseif Level==6 then
		return 'A22W'//A22W -> Ice Wall MS - 6
	elseif Level==7 then
		return 'A22X'//A22X -> Ice Wall MS - 7
	endif
	return 'A230'//A230 -> Ice Wall MS - 1
endfunction

function Lod_IceWall_RemoveSlow takes unit Target returns nothing
	call UnitRemoveAbility(Target,'A230')//A230 -> Ice Wall MS - 1
	call UnitRemoveAbility(Target,'A22Z')//A22Z -> Ice Wall MS - 2
	call UnitRemoveAbility(Target,'A22Y')//A22Y -> Ice Wall MS - 3
	call UnitRemoveAbility(Target,'A22U')//A22U -> Ice Wall MS - 4
	call UnitRemoveAbility(Target,'A22V')//A22V -> Ice Wall MS - 5
	call UnitRemoveAbility(Target,'A22W')//A22W -> Ice Wall MS - 6
	call UnitRemoveAbility(Target,'A22X')//A22X -> Ice Wall MS - 7
	call UnitRemoveAbility(Target,'B08Z')//B08Z -> Ice Wall
endfunction

function Lod_IceWall_Remove takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real JSD=(LoadReal(HY,(GetHandleId(Target)),681))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or JSD<(TimerGetElapsed(GlobalTimer))then
		call Lod_IceWall_RemoveSlow(Target)
	endif
	set t=null
	set Target=null
	return false
endfunction

function Lod_IceWall_Slow takes nothing returns nothing
	local unit Source=tt_unit1
	local unit Target=GetEnumUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real JSD=(LoadReal(HY,(GetHandleId(Target)),681))
	if JSD<(TimerGetElapsed(GlobalTimer))then
		call UnitAddAbility2(Target,Lod_IceWall_GetSlow(Source))
	endif
	call SaveReal(HY,(GetHandleId(Target)),681,(((TimerGetElapsed(GlobalTimer))+2)*1.))
	call SaveUnitHandle(HY,h,17,(Target))
	call TriggerRegisterTimerEvent(t,2.01,false)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function Lod_IceWall_Remove))
	set t=null
	set Source=null
	set Target=null
endfunction

function Lod_IceWall_Periodic takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real SourceX=(LoadReal(HY,h,6))
	local real SourceY=(LoadReal(HY,h,7))
	local real a=(LoadReal(HY,h,137))
	local real Duration=(LoadReal(HY,h,57))
	local real x
	local real y
	local integer i=1
	local integer Count=GetTriggerEvalCount(t)
	local group g
	if Count*.1>Duration then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set g=GetAvailableGroup()
		set tt_unit1=Source
		loop
			exitwhen i>7
			set x=SourceX+80*i*Cos((a+90)*bj_DEGTORAD)
			set y=SourceY+80*i*Sin((a+90)*bj_DEGTORAD)
			call GroupEnumUnitsInRange(g,x,y,105,Condition(function NonImmuneEnemyFilterWithAncients))
			call ForGroup(g,function Lod_IceWall_Slow)
			set x=SourceX+80*i*Cos((a-90)*bj_DEGTORAD)
			set y=SourceY+80*i*Sin((a-90)*bj_DEGTORAD)
			call GroupEnumUnitsInRange(g,x,y,105,Condition(function NonImmuneEnemyFilterWithAncients))
			call ForGroup(g,function Lod_IceWall_Slow)
			set i=i+1
		endloop
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Source=null
	return false
endfunction

function Lod_IceWall_Effect takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real a=GetUnitFacing(Source)
	local integer i=1
	local unit Caster
	local real x
	local real y
	local real SourceX=GetUnitX(Source)+225*Cos(a*bj_DEGTORAD)
	local real SourceY=GetUnitY(Source)+225*Sin(a*bj_DEGTORAD)
	local integer Level=GetUnitAbilityLevel(Source,'Z606')//Z606 -> Ice Wall
	local real Duration=1.5+2*Level
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	if GetUnitTypeId(Source)=='e00E' then //Multicast//e00E -> Spellcaster
		set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
		set a=GetRandomReal(0,360)
		set SourceX=GetUnitX(Source)+225*Cos(a*bj_DEGTORAD)
		set SourceY=GetUnitY(Source)+225*Sin(a*bj_DEGTORAD)
	endif
	loop
		exitwhen i>7
		set x=SourceX+80*i*Cos((a+90)*bj_DEGTORAD)
		set y=SourceY+80*i*Sin((a+90)*bj_DEGTORAD)
		set Caster=CreateUnit(GetOwningPlayer(Source),'u00O',x,y,GetRandomReal(0,360))//u00O -> Icy Path
		call SetUnitAbilityLevel(Caster,'A0XN',Level)//A0XN -> Invoke Icy Path
		call SetUnitAnimation(Caster,"birth")
		call QueueUnitAnimation(Caster,"stand")
		call UnitApplyTimedLife(Caster,'BTLF',Duration)
		set x=SourceX+80*i*Cos((a-90)*bj_DEGTORAD)
		set y=SourceY+80*i*Sin((a-90)*bj_DEGTORAD)
		set Caster=CreateUnit(GetOwningPlayer(Source),'u00O',x,y,GetRandomReal(0,360))//u00O -> Icy Path
		call SetUnitAbilityLevel(Caster,'A0XN',Level)//A0XN -> Invoke Icy Path
		call SetUnitAnimation(Caster,"birth")
		call QueueUnitAnimation(Caster,"stand")
		call UnitApplyTimedLife(Caster,'BTLF',Duration)
		set i=i+1
	endloop
	call TriggerAddCondition(t,Condition(function Lod_IceWall_Periodic))
	call TriggerRegisterTimerEvent(t,.1,true)
	call SaveReal(HY,h,6,((SourceX)*1.))
	call SaveReal(HY,h,7,((SourceY)*1.))
	call SaveReal(HY,h,137,((a)*1.))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveReal(HY,h,57,((Duration)*1.))
	set Caster=null
	set Source=null
	set t=null
endfunction

function RemoveGhostWalkDeact takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	if IsDead(u)==false then
		call UnitRemoveAbility(u,'QFZZ')//QFZZ -> Ghost walk Deactivate
		if GetUnitAbilityLevel(u,'QFZZ')==0 then//QFZZ -> Ghost walk Deactivate
			call FlushChildHashtable(HY,GetHandleId(t))
			call DestroyTrigger(t)
		endif
	endif
	set t=null
	set u=null
	return false
endfunction

function Lod_GhostWalk_Move takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local trigger tt
	if GetUnitAbilityLevel(Hero,'B08X')==0 then//B08X -> Ghost Walk
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'Z605',true)//Z605 -> Ghost Walk
		call UnitRemoveAbility(Hero,'QFZZ')//QFZZ -> Ghost walk Deactivate
		if GetUnitAbilityLevel(Hero,'QFZZ')>0 then//QFZZ -> Ghost walk Deactivate
			set tt=CreateTrigger()
			call TriggerRegisterTimerEvent(tt,1,true)
			call TriggerAddCondition(tt,Condition(function RemoveGhostWalkDeact))
			call SaveUnitHandle(HY,GetHandleId(tt),0,Hero)
			set tt=null
		endif
		call KillUnit(Caster)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SetUnitX(Caster,GetUnitX(Hero))
		call SetUnitY(Caster,GetUnitY(Hero))
	endif
	set t=null
	set Caster=null
	set Hero=null
	return false
endfunction

function Lod_GhostWalk_Effect takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e01V',GetUnitX(Hero),GetUnitY(Hero),0)//e01V -> Spellcaster #3
	local integer lvl=GetUnitAbilityLevel(Hero,'Z605')//Z605 -> Ghost Walk
	call UnitAddAbility2(Caster,'QH50')
	call SetUnitAbilityLevel(Caster,'QH50',lvl)
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function Lod_GhostWalk_Move))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'Z605',false)//Z605 -> Ghost Walk
	call UnitAddAbility(Hero,'QFZZ')//QFZZ -> Ghost walk Deactivate
	call SetUnitAbilityLevel(Hero,'QFZZ',1)//QFZZ -> Ghost walk Deactivate
	set t=null
	set Hero=null
	set Caster=null
endfunction

function Lod_ColdSnap_Stun takes unit Source,unit Target, integer lvl returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A0VI')//A0VI -> Cold Snap ministun
	call IssueTargetOrderById(Caster,852095,Target)
	if IsMagicImmune(Target)==false then
		call DamageTarget(Source,Target,1,25+5*lvl)
	endif
	set Caster=null
endfunction

function Lod_ColdSnap_OnHit takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,30)
	local integer Level=(LoadInteger(HY,h,5))
	local unit Source=(LoadUnitHandle(HY,h,2))
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamage()>10 and((LoadInteger(HY,(GetHandleId((t))),(4263)))==1)==false and GetOwningPlayer(GetEventDamageSource())!=GetOwningPlayer(GetTriggerUnit()) and IsRealDamage then
			call DisableTrigger(t)
			call Lod_ColdSnap_Stun(Source,Target,Level)
			call EnableTrigger(t)
			call AddTimedKeyForTrigger(t,4263,.6)
		endif
	else
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	set Source=null
	return false
endfunction

function Lod_ColdSnap_Effect takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(Hero,'Z604')//Z604 -> Cold Snap
	call TriggerRegisterTimerEvent(t,2.5+Level*.5,false)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function Lod_ColdSnap_OnHit))
	call SaveUnitHandle(HY,h,30,((Target)))
	call SaveInteger(HY,h,5,(Level))
	call SaveUnitHandle(HY,h,2,(Hero))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("Abilities\\Weapons\\SpiritOfVengeanceMissile\\SpiritOfVengeanceMissile.mdl",Target,"overhead")))
	call Lod_ColdSnap_Stun(Hero,Target,Level)
	set t=null
	set Hero=null
	set Target=null
endfunction

function XHF takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())=='fRG1' or GetUnitTypeId(GetFilterUnit())=='fRG2' or GetUnitTypeId(GetFilterUnit())=='fRG3' or GetUnitTypeId(GetFilterUnit())=='fRG4' then//fRG1 -> Forged Spirit, fRG2 -> Forged Spirit, fRG3 -> Forged Spirit, fRG4 -> Forged Spirit
		call KillUnit(GetFilterUnit())
	endif
	return false
endfunction

function Lod_ForgeSpirit_Filter takes player p returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsOfPlayer(g,p,Condition(function XHF))
	call KillGroup(g)
	set g=null
endfunction

function Lod_ForgeSpirit_Effect takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit d
	local integer Level=GetUnitAbilityLevel(Source,'Z603')//Z603 -> Forge Spirit
	local integer synergylvl=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(Source))],'A0A8')
	if GetUnitTypeId(Source)!='e00E' then//e00E -> Spellcaster
		call Lod_ForgeSpirit_Filter(GetOwningPlayer(Source))
	endif
	set d=CreateUnit(GetOwningPlayer(Source),'fRG0'+Level,GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
	call SetUnitColor(d,GetPlayerColor(Sentinels[0]))
	call AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",d,"chest")
	call UnitApplyTimedLife(d,'BTLF',35)
	call SetUnitAbilityLevel(d,'A0VV',Level)//A0VV -> Melting Strike
	call XFF(d)
	if Level>2 and synergylvl>0 then
		call UnitAddAbility3(d,'A3J3',Level-2)
		call UnitAddAbility3(d,'A3J4',Level-2)
		call UnitAddAbility3(d,'A3J5',Level-2)
	endif
	call SelectSummons(d)
	if Level>2 then
		set d=CreateUnit(GetOwningPlayer(Source),'fRG0'+Level,GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
		call SetUnitColor(d,GetPlayerColor(Sentinels[0]))
		call AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",d,"chest")
		call UnitApplyTimedLife(d,'BTLF',35)
		call SetUnitAbilityLevel(d,'A0VV',Level)//A0VV -> Melting Strike
		call XFF(d)
		call SelectSummons(d)
		if synergylvl>0 then
			call UnitAddAbility3(d,'A3J3',Level-2)
			call UnitAddAbility3(d,'A3J4',Level-2)
			call UnitAddAbility3(d,'A3J5',Level-2)
		endif
	endif
	set Source=null
	set d=null
endfunction

function Lod_ChaosMeteor_ResidualPeriodic takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=LoadUnitHandle(HY,h,30)
	local real Damage=(LoadReal(HY,h,20))
	local effect FX=(LoadEffectHandle(HY,h,32))
	local integer Count=GetTriggerEvalCount(t)
	call DamageTarget(Source,Target,1,Damage)
	if GetUnitAbilityLevel(Target,'A42R')==0 or Count==3 then
		call SaveInteger(MHT,GetHandleId(Target),'A42R',LoadInteger(MHT,GetHandleId(Target),'A42R')-1)
		if LoadInteger(MHT,GetHandleId(Target),'A42R')<=0 then
			call UnitRemoveAbility(Target,'A42R')
			call UnitRemoveAbility(Target,'B0HI')//B0HI -> Meteor
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call DestroyEffect(FX)
	endif
	set t=null
	set Source=null
	set Target=null
	set FX=null
	return false
endfunction

function Lod_ChaosMeteor_Residual takes unit Source,unit Target,real Damage, boolean last returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,30,((Target)))
	call SaveReal(HY,h,20,((Damage)*1.))
	call SaveBoolean(HY,h,0,last)
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("Environment\\SmallBuildingFire\\SmallBuildingFire2.mdl",Target,"chest")))
	call TriggerRegisterTimerEvent(t,1,true)
	call UnitAddAbility2(Target,'A42R')
	call SaveInteger(MHT,GetHandleId(Target),'A42R',LoadInteger(MHT,GetHandleId(Target),'A42R')+1)
	call TriggerAddCondition(t,Condition(function Lod_ChaosMeteor_ResidualPeriodic))
	set t=null
endfunction

function Lod_ChaosMeteor_Affect takes nothing returns nothing
	call Lod_ChaosMeteor_Residual(tt_unit1,GetEnumUnit(),tt_real1/ 5,tt_bool1)
	call DamageTarget(tt_unit1,GetEnumUnit(),1,tt_real1)
endfunction

function Lod_ChaosMeteor_Rolling takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local real a=(LoadReal(HY,h,137))
	local integer Level=(LoadInteger(HY,h,5))
	local integer Count=GetTriggerEvalCount(t)-26
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real AO8
	local real AP8
	local unit Caster
	local group g
	if Count==1 then
		set Caster=CreateUnit(GetOwningPlayer(Source),'e01L',x,y,a*bj_RADTODEG)//e01L -> Meteor (Moving)
		call SaveUnitHandle(HY,h,19,(Caster))
	elseif Count>1 then
		set Caster=(LoadUnitHandle(HY,h,19))
	endif
	if Count>0 then
		set AO8=SafeX50(GetUnitX(Caster)+15*Cos(a))
		set AP8=SafeY50(GetUnitY(Caster)+15*Sin(a))
		call SetUnitX(Caster,AO8)
		call SetUnitY(Caster,AP8)
		if(Count>1 and ModuloInteger(Count,10)==0)or Count==1 then
			set g=GetAvailableGroup()
			set tt_unit1=Source
			set tt_real1=40+20*Level
			call GroupEnumUnitsInRange(g,AO8,AP8,300,Condition(function DefaultEnemyFilterWithAncients))
			set tt_bool1=Count > LoadInteger(HY,h,7)
			call ForGroup(g,function Lod_ChaosMeteor_Affect)
			call KillGroup(g)
			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",AO8,AP8))
		endif
		if Count>LoadInteger(HY,h,7) then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call KillUnit(Caster)
		endif
	endif
	set t=null
	set g=null
	set Caster=null
	set Source=null
	return false
endfunction

function Lod_ChaosMeteor_Effect takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
	local unit W5F=CreateUnit(GetOwningPlayer(Source),'e01K',x,y,a*bj_RADTODEG)//e01K -> Meteor (Falling Down)
	local integer Level=GetUnitAbilityLevel(Source,'Z602')//Z602 -> Chaos Meteor
	call SetUnitTimeScale(W5F,.58)
	call UnitApplyTimedLife(W5F,'BTLF',1.75)
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function Lod_ChaosMeteor_Rolling))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	call SaveReal(HY,h,137,((a)*1.))
	call SaveInteger(HY,h,5,Level)
	call SaveInteger(HY,h,7,R2I((350+200*Level)/ 16.6))
	set t=null
	set Source=null
	set W5F=null
endfunction

function Lod_SunStrike_Damage takes nothing returns nothing
	call DamageTarget(tt_unit1,GetEnumUnit(),3,tt_real1)
endfunction

function Lod_SunStrike_Land takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local real Damage=(LoadReal(HY,h,20))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local group g=GetAvailableGroup()
	local integer Count
	set tt_unit1=Hero
	call TimedReveal(GetOwningPlayer(Hero),4,x,y,400)
	call GroupEnumUnitsInRange(g,x,y,200,Condition(function DefaultEnemyFilterWithAncients))
	set Count=CountUnitsInGroup(g)
	if Count>0 then
		set tt_real1=Damage/ Count
		call ForGroup(g,function Lod_SunStrike_Damage)
	endif
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",x,y))
	call KillGroup(g)
	call DestroyEffect((LoadEffectHandle(HY,h,32)))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	set g=null
	return false
endfunction

function Lod_SunStrike_Effect takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real Damage=100+75*GetUnitAbilityLevel(Hero,'Z601')//Z601 -> Sun Strike
	local string s=""
	if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Hero)) or(IsObserver(GetLocalPlayer()))then
		set s="war3mapImported\\SunStrike.mdx"
	endif
	call TimedReveal(GetOwningPlayer(Hero),5.7,x,y,400)
	call TriggerRegisterTimerEvent(t,1.7,false)
	call TriggerAddCondition(t,Condition(function Lod_SunStrike_Land))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	call SaveReal(HY,h,20,((Damage)*1.))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffect(s,x,y)))
	set t=null
	set Hero=null
endfunction

function MyTrueshotTargets takes nothing returns boolean
	local unit t=GetFilterUnit()
	local integer dmg=0
	local integer h=GetHandleId(t)
	local integer key=344691
	local boolean b=false//is unit had effect of trueshot?
	if IsUnitAlly(t,TrueshotPlayer) and GetUnitAbilityLevel(t,'A04R')==0 and not IsDead(t) then
		if LoadBoolean(HY,h,key) then//was affected?
			set dmg=LoadInteger(HY,h,key)
			set b=true
		endif
		if IsUnitIdType(GetUnitTypeId(t),UNIT_TYPE_HERO) then
			if IsUnitType(t,UNIT_TYPE_RANGED_ATTACKER)==IsUnitType(TrueshotBearer,UNIT_TYPE_RANGED_ATTACKER) and IsUnitType(t,UNIT_TYPE_MELEE_ATTACKER)==IsUnitType(TrueshotBearer,UNIT_TYPE_MELEE_ATTACKER) then
				if b or GetUnitAbilityLevel(t,'D006')>0 then//already had bonus
					if TrueshotAlive then//trax is alive - add bonus and store it
						if dmg!=TrueshotDmg then
							call LoDStat_Sub(t,dmg,"damage")
							call SaveInteger(HY,h,key,TrueshotDmg)
							call LoDStat_Add(t,TrueshotDmg,"damage")
						endif
					else//trax is dead, remove buff and bonus
						call Buff_Remove(t,'D006')
						call LoDStat_Sub(t,dmg,"damage")
						call SaveInteger(HY,h,key,0)
						call SaveBoolean(HY,h,key,false)
					endif
				else//first time or new unit
					if TrueshotAlive then
						call SaveInteger(HY,h,key,TrueshotDmg)
						call SaveBoolean(HY,h,key,true)
						call LoDStat_Add(t,TrueshotDmg,"damage")
						call Buff_Add(t,'C006','D006',-1)
					endif
				endif
			else//if types are different, but maybe it morph ability, so lets check was it affected
				if b then//it was, remove bonus
					call LoDStat_Sub(t,dmg,"damage")//remove old
					call SaveInteger(HY,h,key,0)
					call SaveBoolean(HY,h,key,false)
					call Buff_Remove(t,'D006')
				endif
			endif
		else
			if IsUnitType(t,UNIT_TYPE_RANGED_ATTACKER) and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false then
				if b then//was affected
					if TrueshotAlive and LoadInteger(HY,GetHandleId(TrueshotBearer),344692)==1 then
						if dmg!=TrueshotDmg then
							call SaveInteger(HY,h,key,TrueshotDmg)
							call LoDStat_Sub(t,dmg,"damage")
							call LoDStat_Add(t,TrueshotDmg,"damage")
						endif
					else
						call Buff_Remove(t,'D006')
						call LoDStat_Sub(t,dmg,"damage")
						call SaveInteger(HY,h,key,0)
						call SaveBoolean(HY,h,key,false)
					endif
				else//wasnt affected
					if TrueshotAlive and LoadInteger(HY,GetHandleId(TrueshotBearer),344692)==1 then
						call SaveInteger(HY,h,key,TrueshotDmg)
						call SaveBoolean(HY,h,key,true)
						call LoDStat_Add(t,TrueshotDmg,"damage")
						call Buff_Add(t,'C006','D006',-1)
					endif
				endif
			endif
		endif
	endif
	set t=null
	return false
endfunction

function MyTrueshotDuration takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer lvl=GetUnitAbilityLevel(u,'A2O2')//A2O2 -> Trueshot Aura
	local real stat=GetHeroHighestStatValue(u)*1.
	local integer dmg=R2I((12+6*lvl)*stat/100.)
	local boolean clear=LoadBoolean(HY,h,10) and LoadInteger(HY,(GetHandleId(u)),704)!='A2O2'//A2O2 -> Trueshot Aura
	local player p=LoadPlayerHandle(HY,h,10)
	local boolean playerchanged
	set TrueshotBearer=u
	set TrueshotPlayer=GetOwningPlayer(u)
	set TrueshotDmg=dmg
	set TrueshotAlive=true
	set playerchanged=p!=TrueshotPlayer
	if IsDead(u) or u==null or GetUnitTypeId(u)<1 or clear or playerchanged or GetUnitAbilityLevel(u,'A36D')==1 then
		set TrueshotDmg=0
		set TrueshotAlive=false
	endif
	if playerchanged then
		set TrueshotPlayer=p
	endif
	call GroupEnumUnitsInRange(g_TrueshotGroup,0,0,12000,Condition(function MyTrueshotTargets))
	if playerchanged then
		call SavePlayerHandle(HY,h,10,GetOwningPlayer(u))
	endif
	if clear or u==null then
		if u!=null then
			call RemoveSavedHandle(HY,GetHandleId(u),'TSHT')
		endif
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	endif
	set t=null
	set u=null
endfunction

function MyTrueshot takes unit u returns nothing
	local timer t
	local integer h
	if HaveSavedHandle(HY,GetHandleId(u),'TSHT')==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,0.5,true,function MyTrueshotDuration)
		call SaveUnitHandle(HY,h,0,u)
		call SaveTimerHandle(HY,GetHandleId(u),'TSHT',t)
		call SaveBoolean(HY,h,10,LoadInteger(HY,(GetHandleId(u)),704)=='A2O2')//is rubick?//A2O2 -> Trueshot Aura
		call SavePlayerHandle(HY,h,10,GetOwningPlayer(u))
		set t=null
	endif
endfunction

function MyTrueshotLearning takes nothing returns nothing
	call MyTrueshot(GetTriggerUnit())
endfunction

function MyTrueshotRubick takes nothing returns nothing
	call MyTrueshot(tt_unit1)
endfunction

function Drow_Trueshot_Toggling takes nothing returns nothing
	call AddTimedKeyToUnit(GetTriggerUnit(),344692,30)
endfunction


function Traxex_Gust_PushDur takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,2)
	local unit target=LoadUnitHandle(HY,h,17)
	local real angle=LoadReal(HY,h,13)
	local real dist=LoadReal(HY,h,138)
	local real amount=LoadInteger(HY,h,0)
	local real pushdist=dist/amount
	local real newX
	local real newY
	local integer c=GetTriggerEvalCount(t)
	if c>amount or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call KillTrees(GetUnitX(target),GetUnitY(target),100)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set newX=SafeX50(GetUnitX(target)+pushdist*Cos(angle))
		set newY=SafeY50(GetUnitY(target)+pushdist*Sin(angle))
		call SetUnitX(target,newX)
		call SetUnitY(target,newY)
	endif
	set t=null
	set caster=null
	set target=null
	return false
endfunction

function Traxex_Gust_PushUnits takes unit dummy,unit target,unit caster,real x,real y returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real angle=Atan2(GetUnitY(target)-GetUnitY(dummy),GetUnitX(target)-GetUnitX(dummy))
	local real dist=DistanceBetweenXY(x,y,GetUnitX(target),GetUnitY(target))
	local real pustdist=RMaxBJ(1,350*(1-dist/900))
	call SaveUnitHandle(HY,h,2,caster)
	call SaveUnitHandle(HY,h,17,target)
	call SaveReal(HY,h,13,(angle*1.0))
	call SaveReal(HY,h,138,(pustdist*1.0))
	call SaveInteger(HY,h,0,25+5*GetUnitUserData(dummy))
	call TriggerRegisterTimerEvent(t,0.02,true)
	call TriggerRegisterDeathEvent(t,target)
	call TriggerAddCondition(t,Condition(function Traxex_Gust_PushDur))
	set t=null
endfunction

function Traxex_Gust_ForGroup takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),Traxex_Gust_TempGroup)==false and GetEnumUnit()!=Roshan then
		call GroupAddUnit(Traxex_Gust_TempGroup,GetEnumUnit())
		call Traxex_Gust_PushUnits(tt_unit1,GetEnumUnit(),Traxex_Gust_Tempunit,Traxex_Gust_TempX,Traxex_Gust_TempY)
	endif
endfunction

function Traxex_Gust_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,2)
	local unit dummy=LoadUnitHandle(HY,h,19)
	local real angle=LoadReal(HY,h,137)
	local real casterX=LoadReal(HY,h,64)
	local real casterY=LoadReal(HY,h,65)
	local real targetX=LoadReal(HY,h,66)
	local real targetY=LoadReal(HY,h,67)
	local group g=LoadGroupHandle(HY,h,22)
	local real dummyX=GetUnitX(dummy)
	local real dummyY=GetUnitY(dummy)
	local group gg
	local unit dummysilencer=LoadUnitHandle(HY,h,0)
	if DistanceBetweenXY(dummyX,dummyY,targetX,targetY)<100 then
		set dummyX=targetX
		set dummyY=targetY
	else
		set dummyX=dummyX+40*Cos(angle)
		set dummyY=dummyY+40*Sin(angle)
	endif
	set dummyX=SafeX50(dummyX)
	set dummyY=SafeY50(dummyY)
	call SetUnitX(dummy,dummyX)
	call SetUnitY(dummy,dummyY)
	call SetUnitX(dummysilencer,dummyX)
	call SetUnitY(dummysilencer,dummyY)
	if ModuloInteger(GetTriggerEvalCount(t),2)==1 and GetTriggerEvalCount(t)<20 then
		call IssuePointOrder(dummysilencer,"silence",dummyX,dummyY)
	endif
	
	set gg=GetAvailableGroup()
	set tt_unit1=dummy
	set Traxex_Gust_Tempunit=caster
	set Traxex_Gust_TempX=casterX
	set Traxex_Gust_TempY=casterY
	set Traxex_Gust_TempGroup=g
	call GroupEnumUnitsInRange(gg,dummyX,dummyY,275,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	call ForGroup(gg,function Traxex_Gust_ForGroup)
	call KillGroup(gg)
	if(dummyX==targetX and dummyY==targetY)or GetTriggerEvalCount(t)>35 then
		set gg=GetAvailableGroup()
		set tt_unit1=dummy
		set Traxex_Gust_Tempunit=caster
		set Traxex_Gust_TempX=casterX
		set Traxex_Gust_TempY=casterY
		set Traxex_Gust_TempGroup=g
		call GroupEnumUnitsInRange(gg,dummyX,dummyY,275,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
		call ForGroup(gg,function Traxex_Gust_ForGroup)
		call KillGroup(gg)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(dummy)
		call KillGroup(g)
	endif
	set dummysilencer=null
	set t=null
	set dummy=null
	set g=null
	set gg=null
	set caster=null
	return false
endfunction

function Traxex_Gust_Start takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local location l=GetSpellTargetLoc()
	local unit u=GetTriggerUnit()
	local real x=GetLocationX(l)
	local real y=GetLocationY(l)
	local real angle=Atan2(y-GetUnitY(u),x-GetUnitX(u))
	local unit d=CreateUnit(GetOwningPlayer(u),'h02J',GetUnitX(u),GetUnitY(u),angle*bj_RADTODEG)//use Basilius dummy//h02J -> Ring of Basilius
	local unit dummysilencer=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
	call UnitAddAbility(dummysilencer,'A0QB')//A0QB -> Silence
	call SetUnitAbilityLevel(dummysilencer,'A0QB',GetUnitAbilityLevel(u,GetSpellAbilityId()))//A0QB -> Silence
	call TriggerRegisterTimerEvent(t,0.02,true)
	call TriggerAddCondition(t,Condition(function Traxex_Gust_Duration))
	call SaveUnitHandle(HY,h,2,u)
	call SaveUnitHandle(HY,h,19,d)
	call SetUnitUserData(d,GetUnitAbilityLevel(u,GetSpellAbilityId()))
	call SaveUnitHandle(HY,h,0,dummysilencer)
	call SaveReal(HY,h,137,(angle*1.0))
	call SaveReal(HY,h,64,GetUnitX(u))
	call SaveReal(HY,h,65,GetUnitY(u))
	call SaveReal(HY,h,66,GetUnitX(u)+900*Cos(angle))
	call SaveReal(HY,h,67,GetUnitY(u)+900*Sin(angle))
	call SaveGroupHandle(HY,h,22,GetAvailableGroup())
	call RemoveLocation(l)
	set t=null
	set dummysilencer=null
	set l=null
	set d=null
	set u=null
endfunction

function Trax_Marksmanship_Targets takes nothing returns nothing
	local unit t = GetFilterUnit()
	local unit u = group_temp_unit[0]
	if group_temp_boolean and IsUnitType(t,UNIT_TYPE_HERO) and IsUnitEnemy(u,GetOwningPlayer(t)) and AliveNonBuildOrMarker(GetFilterUnit()) then//
		set group_temp_boolean = false
	endif
	set t = null
	set u = null
endfunction

function Trax_Marksmanship_Duration takes nothing returns nothing
	local integer lvl
	local timer t = GetExpiredTimer()
	local integer h=GetHandleId(t)
	local integer id='A0VC'//A0VC -> Marksmanship
	local unit u=LoadUnitHandle(HY,h,0)
	if GetHandleId(u)>0 then
		set group_temp_unit[0] = u
		set group_temp_boolean = true
		if LoadBoolean(HY,h,0)==false then
			if GetUnitAbilityLevel(u,id)< GetUnitAbilityLevel(u,'QF88') then//QF88 -> Marksmanship
				call SetUnitAbilityLevel(u,id,GetUnitAbilityLevel(u,'QF88'))//QF88 -> Marksmanship
			endif
		endif
//		call echo("here")
		call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),400+25,Condition(function Trax_Marksmanship_Targets))
		if group_temp_boolean and GetUnitAbilityLevel(u,'A36D')==0 then
//			call echo("there")
			call SaveInteger(HY,h,1,0)
			if LoadBoolean(HY,h,0) then
				set lvl=LoadInteger(HY,h,0)
			else
				set lvl = GetUnitAbilityLevel(u,'QF88')//QF88 -> Marksmanship
			endif
			if GetUnitAbilityLevel(u,'A2NX')!=lvl then//A2NX -> Marksmanship Double
				call UnitAddAbility2(u,'A2NX')//A2NX -> Marksmanship Double
				call UnitAddAbility2(u,'A3B6')
				call SetUnitAbilityLevel(u,'A2NX',lvl)//A2NX -> Marksmanship Double
				if GetUnitPrimaryAttribute(u)!=2 then
					call UnitAddAbility2(u,'A33L')
					call SetUnitAbilityLevel(u,'A33L',lvl)
				endif
			endif
			set u=null
			set t = null
			return
		elseif group_temp_boolean==false then
			call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+1)
			if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) and LoadInteger(HY,h,1) < 40 then
				set u = null
				set t = null
				return
			endif
		endif
		
		call UnitRemoveAbility(u,'A2NX')//A2NX -> Marksmanship Double
		call UnitRemoveAbility(u,'A33L')
		call UnitRemoveAbility(u,'A3B6')
	else
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	endif
	set u=null
	set t = null
endfunction

function Trax_Marksmanship_learn takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local timer t = CreateTimer()
	local integer id='A0VC'//A0VC -> Marksmanship
	//call UnitAddAbility2(u,id)
	//call SetUnitAbilityLevel(u,id,GetUnitAbilityLevel(u,'QF88'))//QF88 -> Marksmanship
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call SaveBoolean(HY,GetHandleId(u),4336821,false)
	call TimerStart(t,0.1,true,function Trax_Marksmanship_Duration)
	set t = null
	set u = null
endfunction

function Trax_Marksmanship_IllusionAdd takes unit u, integer lvl returns nothing
	local timer t = CreateTimer()
	local integer pid=GetPlayerId(GetOwningPlayer(u))
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call TimerStart(t,0.1,true,function Trax_Marksmanship_Duration)
	call SaveInteger(HY,GetHandleId(t),0,lvl)
	call SaveBoolean(HY,GetHandleId(t),0,true)
	set t = null
endfunction

function Trax_Marksmanship_Illusion takes nothing returns nothing
	local unit illus=LoadUnitHandle(TempHash,'ILLU',0)
	local unit origin=LoadUnitHandle(TempHash,'ILLU',1)
	call RemoveSavedHandle(TempHash,'ILLU',0)
	call RemoveSavedHandle(TempHash,'ILLU',1)
	if GetUnitAbilityLevel(origin,'A0VC')>0 then//A0VC -> Marksmanship
		call Trax_Marksmanship_IllusionAdd(illus,GetUnitAbilityLevel(origin,'A0VC'))//A0VC -> Marksmanship
	endif
	set illus=null
	set origin=null
endfunction

function YBF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,5)
	local real Damage
	if Level==1 then
		set Damage=15
	elseif Level==2 then
		set Damage=30
	elseif Level==3 then
		set Damage=40
	elseif Level==4 then
		set Damage=50
	endif
	if GetTriggerEvalCount(t)==3 or GetTriggerEvalCount(t)==4 then
		call DamageTarget(Source,Target,1,Damage)
	endif
	if GetTriggerEvalCount(t)==4 then
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call UnitRemoveAbility(Target,'A1VS')//A1VS -> Hellfire Blast Container 1
		call UnitRemoveAbility(Target,'B0DN')//B0DN -> Hellfire Blast
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function YCF takes unit source, unit target, integer lvl returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function YBF))
	call SaveUnitHandle(HY,h,2,source)
	call SaveUnitHandle(HY,h,17,target)
	call SaveInteger(HY,h,5,lvl)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl",target,"chest"))
	call SetPlayerAbilityAvailable2(GetOwningPlayer(target),'A1VS',false)//A1VS -> Hellfire Blast Container 1
	call UnitAddAbility2(target,'A1VS')//A1VS -> Hellfire Blast Container 1
	set t=null
endfunction

function SkeletonKing_HellfireBlastHit takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
			if GetUnitAbilityLevel(GetTriggerUnit(),'A3E9')==1 and IsMagicImmune(LoadUnitHandle(HY,h,1))==false and LoadBoolean(HY,h,0)==false then
				call SaveUnitHandle(TempHash,'A3E9',0,GetTriggerUnit())
				call SaveUnitHandle(TempHash,'A3E9',1,LoadUnitHandle(HY,h,1))
				call SaveInteger(TempHash,'A3E9',0,R2I(LoadReal(HY,h,0)))
				call ExecuteFunc("SkeletonKing_HellfireBlastLotusOrb")
			endif
			call StunTargetLoD(GetTriggerUnit(), 2.00)
			call DamageTarget(LoadUnitHandle(HY,h,1),GetTriggerUnit(),1,50*LoadReal(HY,h,0))
			call YCF(LoadUnitHandle(HY,h,1),GetTriggerUnit(),R2I(LoadReal(HY,h,0)))
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		endif
	else
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	endif
	set t=null
endfunction

function SkeletonKing_HellfireBlast_Real takes unit caster, unit target, integer lvl, boolean lotus returns nothing
	local trigger t
	local integer h
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A42G')
	call LotusOrbCasting(d,target,852095)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,5,false)
	call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function SkeletonKing_HellfireBlastHit))
	call SaveUnitHandle(HY,h,0,d)
	call SaveUnitHandle(HY,h,1,caster)
	call SaveReal(HY,h,0,lvl)
	call SaveBoolean(HY,h,0,lotus)
	set t=null
	set d=null
endfunction

function SkeletonKing_HellfireBlastWrapper takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call SkeletonKing_HellfireBlast_Real(GetTriggerUnit(),GetSpellTargetUnit(),GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()),false)
	endif
endfunction

function SkeletonKing_HellfireBlastLotusOrb takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	local integer lvl=LoadInteger(TempHash,'A3E9',0)
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	if IsBlocked(target)==false then
		call SkeletonKing_HellfireBlast_Real(caster,target,lvl,true)
	endif
	set caster=null
	set target=null
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function PrimalPandasSearch takes nothing returns boolean
	return IsPrimalSplitUnit(GetUnitTypeId(GetFilterUnit()))
endfunction

function KillPrimalsSplitted takes unit killer, unit u returns nothing
	local group g=GetAvailableGroup()
	local unit u2
	call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(u),Condition(function PrimalPandasSearch))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call UnitRemoveAbility(u2,'Avul')
		if IsUnitType(u2,UNIT_TYPE_SUMMONED)==false then
			call UnitRemoveBuffs(u2,true,true)
		endif
		call UnitRemoveAbility(u2,'Aetl')
		call SetUnitInvulnerable(u2,false)
		call DamageTarget(killer,u2,1,99999999)
		call DamageTarget(killer,u2,2,99999999)
		call DamageTarget(killer,u2,3,99999999)
		call DamageTarget(killer,u2,7,99999999)
		call DamageTarget(killer,u2,10,99999999)
		call GroupRemoveUnit(g,u2)
	endloop
	call KillGroup(g)
endfunction

function SkeletonKing_HellfireBlast_OnCast takes nothing returns nothing
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIfb\\AIfbSpecialArt.mdl",GetTriggerUnit(),GetProperAttachPoint_Weapon(GetTriggerUnit())))
endfunction

function ReincarnationAoE takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=GetTriggerUnit()
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		if GetUnitAbilityLevel(u,'A3DA')==1 then//if unit dies anyhow while Wraith
			call UnitRemoveAbility(u,'A3DA')
			call UnitRemoveAbility(u,'B3DA')//B3DA -> |cff00ff00Wraith|r
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
			call RestoreTint(u)
			call EnableSuicide(u)
		elseif GetUnitAbilityLevel(u,'A3D9')==1 then
			if LoadBoolean(HY,GetHandleId(u),'suic') or GetUnitAbilityLevel(u,'AIrc')==1 then//AIrc -> Item Reincarnation
				call UnitRemoveAbility(u,'A3DK')
				call UnitRemoveAbility(u,'B3I9')
				call FlushChildHashtable(HY,h)
				call DestroyTrigger(t)
			else
				
				call TriggerRegisterTimerEvent(t,0,false)
				call TriggerRegisterTimerEvent(t,0.1,false)
				call TriggerRegisterTimerEvent(t,4,false)
				call SaveUnitHandle(HY,h,0,u)
				call SaveReal(HY,h,10,GetUnitState(u,UNIT_STATE_MANA))
			endif
		else
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		endif
		call RemoveSavedHandle(HY,GetHandleId(u),'Leor')
	else
		set u=LoadUnitHandle(HY,h,0)
		if LoadInteger(HY,h,0)==0 then
			call UnitRemoveAbility(u,'A3DK')
			call UnitRemoveAbility(u,'B3I9')
			call UnitAddAbility2(u,'A3DA')
			call SaveInteger(HY,h,0,1)
			call SetUnitVertexColor(u,140,120,100,70)
			call DisableSuicide(u)
			if LoadInteger(HY,GetHandleId(u),4333)==1 then
				call AddTimedKeyToUnit(u,4334,7.01)
			endif
			if LoadInteger(HY,GetHandleId(u),4418)==1 then
				call AddTimedKeyToUnit(u,4419,7.01)
			endif
		elseif LoadInteger(HY,h,0)==1 then
			call SaveInteger(HY,h,0,2)
			call SelectUnitAddForPlayer(u,GetOwningPlayer(u))
			call SetUnitState(u,UNIT_STATE_MANA,LoadReal(HY,h,10))
		else
			call UnitRemoveAbility(u,'A3DA')
			call UnitRemoveAbility(u,'B3DA')//B3DA -> |cff00ff00Wraith|r
			call RestoreTint(u)
			call UnitRemoveAbility(u,'Avul')//Avul -> Invulnerable
			call SetUnitInvulnerable(u,false)
			if IsUnitType(u,UNIT_TYPE_SUMMONED)==false then
				call UnitRemoveBuffs(u,true,true)
			endif
			call UnitRemoveAbility(u,'Aetl')
			call SetWidgetLife(u,1)
			if LoadUnitHandle(HY,GetHandleId(u),'lstd')!=null then
				call DamageTarget(LoadUnitHandle(HY,GetHandleId(u),'lstd'),u,1,99999999)
				call DamageTarget(LoadUnitHandle(HY,GetHandleId(u),'lstd'),u,2,99999999)
				call DamageTarget(LoadUnitHandle(HY,GetHandleId(u),'lstd'),u,3,99999999)
				call DamageTarget(LoadUnitHandle(HY,GetHandleId(u),'lstd'),u,7,99999999)
				call DamageTarget(LoadUnitHandle(HY,GetHandleId(u),'lstd'),u,10,99999999)
				if IsDead(u)==false then
					if GetHandleId(LoadUnitHandle(HY,GetHandleId(u),'lstd'))==0 then
						call KillUnit(u)
					else
						if GetUnitAbilityLevel(u,'A0MQ')>0 or GetUnitAbilityLevel(u,'A1B6')>0 then
							call KillPrimalsSplitted(LoadUnitHandle(HY,GetHandleId(u),'lstd'),u)
						endif
					endif
				endif
			else
				call KillUnit(u)
			endif
			call EnableSuicide(u)
			if IsDead(u) then
				call FlushChildHashtable(HY,h)
				call DestroyTrigger(t)
			else
				call TriggerRegisterTimerEvent(t,0.02,true)
			endif
		endif
		
	endif
	
	return false
endfunction

function PersonalDeathWrapper takes unit u returns nothing
	local trigger t
	local integer h
	local integer hu=GetHandleId(u)
	if HaveSavedHandle(HY,hu,'Leor')==false and GetUnitAbilityLevel(u,'A3DA')==0 then
		
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,hu,'Leor',t)
		call TriggerRegisterDeathEvent(t,u)
		call TriggerAddCondition(t,Condition(function ReincarnationAoE))
	endif
	set t=null
endfunction

function LeoricAghanimTimer takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local group affected=LoadGroupHandle(HY,h,1)
	local group g
	local unit u2
	if (IsDead(u) and LoadInteger(HY,GetHandleId(u),'A1AZ')!=1) or GetUnitAbilityLevel(u,'A1AZ')==0 then//A1AZ -> Reincarnation upgrade
		loop
			set u2=FirstOfGroup(affected)
			exitwhen u2==null
			call UnitRemoveAbility(u2,'A3DK')
			call UnitRemoveAbility(u2,'B3I9')
			call GroupRemoveUnit(affected,u2)
		endloop
//		call echo("death clear")
	else
		set tt_unit1=u
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1225,Condition(function DefaultAllyFilterHeroOnly))
		loop
			set u2=FirstOfGroup(affected)
			exitwhen u2==null
			if IsUnitInGroup(u2,g)==false then
				call UnitRemoveAbility(u2,'A3DK')
				call UnitRemoveAbility(u2,'B3I9')
			endif
			call GroupRemoveUnit(affected,u2)
		endloop
		//call GroupRemoveUnit(g,u)
		loop
			set u2=FirstOfGroup(g)
			exitwhen u2==null
			if GetUnitAbilityLevel(u2,'A3DA')==0 then
				call GroupAddUnit(affected,u2)
				if GetUnitAbilityLevel(u2,'A3DK')==0 then
					call UnitAddAbility2(u2,'A3DK')
					call UnitMakeAbilityPermanent(u2,true,'A3D9')
					call UnitMakeAbilityPermanent(u2,true,'A3I9')
				endif
				call PersonalDeathWrapper(u2)
			endif
			call GroupRemoveUnit(g,u2)
		endloop
		
		call KillGroup(g)
	endif
	
	
	set t=null
	set u=null
	return false
endfunction

function LeoricAghanimStart takes unit u returns nothing
	local trigger t
	local integer h
	local integer hu=GetHandleId(u)
	if HaveSavedHandle(HY,hu,'LeoR')==false then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,hu,'LeoR',t)
		call TriggerRegisterTimerEvent(t,0.3,true)
//		call echo("trigger created")
		call SaveUnitHandle(HY,h,0,u)
		call SaveGroupHandle(HY,h,1,GetAvailableGroup())
		call TriggerAddCondition(t,Condition(function LeoricAghanimTimer))
	endif
	call HideAbility('A3DK')
	set t=null
endfunction

function LeoricPickupAgh takes nothing returns nothing
	call LeoricAghanimStart(tt_unit1)
endfunction

function SK_VampiricAura_Ranged takes unit attacker, unit target returns nothing
	local integer lvl
	local real percent
	if IsUnitIllusion(target)==false and IsUnitType(target,UNIT_TYPE_STRUCTURE)==false and IsUnitType(target,UNIT_TYPE_MECHANICAL)==false and IsUnitEnemy(attacker,GetOwningPlayer(target)) and (GetUnitAbilityLevel(attacker,'BVA1')>0 or GetUnitAbilityLevel(attacker,'BVA2')>0 or GetUnitAbilityLevel(attacker,'BVA3')>0 or GetUnitAbilityLevel(attacker,'BVA4')>0) and IsDead(attacker)==false then//BVA1 -> Vampiric Aura, BVA2 -> Vampiric Aura, BVA3 -> Vampiric Aura, BVA4 -> Vampiric Aura
		set lvl=GetUnitAbilityLevel(attacker,'BVA1')+GetUnitAbilityLevel(attacker,'BVA2')*2+GetUnitAbilityLevel(attacker,'BVA3')*3+GetUnitAbilityLevel(attacker,'BVA4')*4//BVA1 -> Vampiric Aura, BVA2 -> Vampiric Aura, BVA3 -> Vampiric Aura, BVA4 -> Vampiric Aura
		set percent=0.1+0.05*lvl
		call SetWidgetLife(attacker,GetWidgetLife(attacker)+GetEventDamage()*percent)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\VampiricAura\\VampiricAuraTarget.mdl",attacker,"origin"))
	endif
endfunction

function Y1F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call SelectUnitForPlayerSingle(Source,GetOwningPlayer(Source))
	call FixVisionGlitchOnBuyBack(Source)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set h = GetHandleId(Source)
	if LoadBoolean(MHT,h,StringHash("morphedburn")) then
		call UnMorphUnit(Source,LoadInteger(MHT,h,StringHash("second")))
		call UnMorphUnit(Source,LoadInteger(MHT,h,StringHash("first")))
		call SaveBoolean(MHT,h,StringHash("morphedburn"),false)
	endif
	set t=null
	set Source=null
	return false
endfunction

function Y0F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=GetUnitAbilityLevel(Source,'A01Y')//A01Y -> Reincarnation
	local unit Caster
	local integer pid=GetPlayerId(GetOwningPlayer(Source))
	local boolean b=false
	local boolean agh=false
	if Level==0 then
		set Level=GetUnitAbilityLevel(Source,'A1AZ')//A1AZ -> Reincarnation upgrade
		set agh=true
	endif
	if GetUnitState(Source,UNIT_STATE_MANA)>=120+40*Level then
		if SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]]=='A01Y' and TimerGetRemaining(PrimUltiTimer[pid])==0 then//A01Y -> Reincarnation
			set b=true
		elseif SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+6]]=='A01Y' and TimerGetRemaining(SecUltiTimer[pid])==0 then//A01Y -> Reincarnation
			set b=true
		endif
	endif
	if b then
		if GetUnitAbilityLevel(Source,'A3DK')!=0 then
			call UnitRemoveAbility(Source,'A3DK')
		endif
		call AddTimedKeyToUnit(Source,'A1AZ',3.)
		if IsTerrainPathable(GetUnitX(Source),GetUnitY(Source),PATHING_TYPE_WALKABILITY)then
			call YL9(Source)
		endif
		set t=CreateTrigger()
		set h=GetHandleId(t)
		set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
		call UnitAddAbility(Caster,'A274')//A274 -> Reincarnation Thunder Clap
		if agh then
			call SpecialAbilityCastedWrapper(Source,'A1AZ')
		else
			call SpecialAbilityCastedWrapper(Source,'A01Y')
		endif
		call IssueImmediateOrderById(Caster,852096)
		set Caster=null
		call TriggerRegisterTimerEvent(t,3+.01,false)
		call TriggerAddCondition(t,Condition(function Y1F))
		call SaveUnitHandle(HY,h,2,(Source))
	endif
	set t=null
	set Source=null
	return false
endfunction

function Leoric_Reincarnation_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function Y0F))
	call SaveUnitHandle(HY,h,2,(Source))
	set t=null
	set Source=null
endfunction

function SkeletonKing_MortalStrike_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,2)
	local unit target=LoadUnitHandle(HY,h,17)
	local integer lvl=GetUnitAbilityLevel(caster,'A2S0')//A2S0 -> Mortal Strike
	local real StolenHPCounter=LoadReal(HY,h,797)
	local real StolenHPCounterTarget=LoadReal(HY,h,798)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SaveInteger(HY,GetHandleId(caster),4338,2)
		call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'AOcr',true)//AOcr -> Critical Strike
		call DestroyEffect(LoadEffectHandle(HY,h,175))
		call DestroyEffect(LoadEffectHandle(HY,h,176))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif StolenHPCounter>0 then
		call SaveInteger(HY,GetHandleId(caster),4338,2)
		call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'AOcr',true)//AOcr -> Critical Strike
		call DestroyEffect(LoadEffectHandle(HY,h,175))
		call DestroyEffect(LoadEffectHandle(HY,h,176))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if IsDead(caster)==false then
			call SetWidgetLife(caster,RMaxIF(1,GetWidgetLife(caster)-StolenHPCounter))
		endif
		if IsDead(target)==false then
			call SetWidgetLife(target,GetWidgetLife(target)+StolenHPCounterTarget)
		endif
	else
		set StolenHPCounter=GetUnitState(target,UNIT_STATE_MAX_LIFE)*0.2
		call SaveReal(HY,h,798,StolenHPCounter*1.0)
		if IsUnitType(caster,UNIT_TYPE_HERO) then
			call SetWidgetLife(target,RMaxIF(1,GetWidgetLife(target)-StolenHPCounter))
		endif
		if StolenHPCounter+GetWidgetLife(caster)>GetUnitState(caster,UNIT_STATE_MAX_LIFE) then
			set StolenHPCounter=GetUnitState(caster,UNIT_STATE_MAX_LIFE)-GetWidgetLife(caster)
		endif
		if StolenHPCounter==0 then
			set StolenHPCounter=0.01
		endif
		call SetWidgetLife(caster,GetWidgetLife(caster)+StolenHPCounter)
		call SaveReal(HY,h,797,StolenHPCounter*1.0)
	endif
	set t=null
	set caster=null
	set target=null
	return false
endfunction

function SkeletonKing_MortalStrike_Effect takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	call TriggerRegisterTimerEvent(t,0.01,false)
	call TriggerRegisterTimerEvent(t,7,false)
	call TriggerRegisterDeathEvent(t,caster)
	call TriggerAddCondition(t,Condition(function SkeletonKing_MortalStrike_Duration))
	call SaveUnitHandle(HY,h,2,caster)
	call SaveUnitHandle(HY,h,17,target)
	call SaveReal(HY,h,797,0)
	call SaveReal(HY,h,798,0)
	call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("war3mapImported\\MortalStrikeCaster.mdx",caster,"overhead"))
	call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("war3mapImported\\MortalStrikeTarget.mdx",target,"overhead"))
	call SaveInteger(HY,GetHandleId(caster),4338,1)
	call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'AOcr',false)//AOcr -> Critical Strike
	set t=null
	set caster=null
	set target=null
endfunction

function SkeletonKing_MortalStrike_AddCrit takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A2S0')//A2S0 -> Mortal Strike, QP0W -> Mortal Strike
	if lvl==1 then
		call UnitAddAbility2(u,'Q251')
		call UnitMakeAbilityPermanent(u,true,'AOcr')//AOcr -> Critical Strike
	endif
	call SetUnitAbilityLevel(u,'AOcr',lvl)//AOcr -> Critical Strike
	set u=null
endfunction

function SkeletonKing_MortalStrike_RegSup takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call SkeletonKing_MortalStrike_Effect()
	endif
endfunction

function Z4F takes unit whichUnit returns boolean
	return (IsUnitIllusion(whichUnit)) and GetWidgetLife(whichUnit)>.5 and GetOwningPlayer(whichUnit)==GetOwningPlayer(GetTriggerUnit())
endfunction

function Z8F takes nothing returns boolean
	return Z4F(GetFilterUnit())
endfunction

function ZFF takes nothing returns nothing
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Feedback\\ArcaneTowerAttack.mdl",GetEnumUnit(),"origin"))
	call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,TmpReal378)
endfunction

function Meepo_Poof takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local real x
	local real y
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local group g
	local boolean ZHF=false
	if Target!=null and Z4F(Target)then
		set ZHF=true
	else
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,0,0,999999,Condition(function Z8F))
		call GroupAddUnit(g,Source)
		set Target=GetClosestOfGroup(g,GetSpellTargetX(),GetSpellTargetY())
		call KillGroup(g)
		set ZHF=Target!=null
	endif
	if ZHF then
		set x=GetUnitX(Target)
		set y=GetUnitY(Target)
		call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\ToonBoom\\ToonBoom.mdl",SourceX,SourceY))
		call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\ToonBoom\\ToonBoom.mdl",x,y))
		call SetUnitX(Source,x)
		call SetUnitY(Source,y)
		set TmpReal378=60+GetUnitAbilityLevel(GetTriggerUnit(),'A0N8')*40//A0N8 -> Poof
		set g=GetAvailableGroup()
		set tt_unit1=Source
		call GroupEnumUnitsInRange(g,SourceX,SourceY,400,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function ZFF)
		set tt_unit1=Source
		call GroupEnumUnitsInRange(g,x,y,400,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function ZFF)
		call KillGroup(g)
	endif
	set g=null
	set Source=null
	set Target=null
endfunction

function ZNF takes nothing returns boolean
	return (IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TmpUnit376))and IsMagicImmune(GetFilterUnit())==false and (GenericCondition_IsDotAInvis(GetFilterUnit())==false or IsUnitVisible(GetFilterUnit(),GetOwningPlayer(TmpUnit376))) and AliveNonBuildOrMarker(GetFilterUnit())and GetFilterUnit()!=Roshan)!=null
endfunction

function ZOF takes nothing returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(TmpUnit376),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A0NC')//A0NC -> Earthbind Helper
	call SetUnitAbilityLevel(Caster,'A0NC',tt_int1)//A0NC -> Earthbind Helper
	call LotusOrbCasting(Caster,GetEnumUnit(),852106)
	if IsBlocked(GetEnumUnit())==false then
		call DamageTarget(TmpUnit376,GetEnumUnit(),1,75+25*tt_int1)
	endif
	set Caster=null
endfunction

function ZPF takes unit Projectile,real x,real y, integer lvl returns nothing
	local group g=GetAvailableGroup()
	set TmpUnit376=Projectile
	set tt_unit1=Projectile
	call GroupEnumUnitsInRange(g,x,y,325,Condition(function ZNF))
	set TmpReal378=x
	set tt_int1=lvl
	call ForGroup(g,function ZOF)
	call KillGroup(g)
	set g=null
endfunction

function ZQF takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit Projectile=LoadUnitHandle(HY,h,45)
	local real TargetX=LoadReal(HY,h,47)
	local real TargetY=LoadReal(HY,h,48)
	local real a=LoadReal(HY,h,13)
	local real AO8=GetUnitX(Projectile)+30*Cos(a)
	local real AP8=GetUnitY(Projectile)+30*Sin(a)
	if(AO8-TargetX)*(AO8-TargetX)+(AP8-TargetY)*(AP8-TargetY)<1200 then
		call SetUnitX(Projectile,TargetX)
		call SetUnitY(Projectile,TargetY)
		call ZPF(Projectile,TargetX,TargetY,LoadInteger(HY,h,0))
		call PauseTimer(t)
		call FlushChildHashtable(HY,h)
		call KillUnit(Projectile)
		call DestroyTimer(t)
	else
		call SetUnitX(Projectile,AO8)
		call SetUnitY(Projectile,AP8)
	endif
	set t=null
	set Projectile=null
endfunction

function Meepo_Earthbind takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real TargetX=SafeX50(GetSpellTargetX())
	local real TargetY=SafeY50(GetSpellTargetY())
	local real SourceX=SafeX50(GetUnitX(Hero))
	local real SourceY=SafeY50(GetUnitY(Hero))
	local unit Projectile=CreateUnit(GetOwningPlayer(Hero),'h00C',SourceX,SourceY,0)//h00C -> Net Projectile
	local real a=Atan2(TargetY-SourceY,TargetX-SourceX)
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SetUnitScale(Projectile,2,2,2)
	call SaveUnitHandle(HY,h,45,Projectile)
	call SaveReal(HY,h,47,TargetX*1.)
	call SaveReal(HY,h,48,TargetY*1.)
	call SaveReal(HY,h,13,a*1.)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
	call TimerStart(t,.035,true,function ZQF)
	set Hero=null
	set Projectile=null
	set t=null
endfunction

function GeostrikeTriggered_Dur takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit geo=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or LoadReal(HY,h,0)<TimerGetElapsed(GlobalTimer) or GetUnitAbilityLevel(target,LoadInteger(HY,h,0))==0 then
		call UnitRemoveAbility(target,LoadInteger(HY,h,0))
		call UnitRemoveAbility(target,'B079')//B079 -> Geostrike
		call RemoveSavedHandle(MHT,GetHandleId(target),'A40F')
		call FlushChildHashtable(HY,h)
		call DisableTrigger(t)
		call DestroyTrigger(t)
	else
		if ModuloInteger(GetTriggerEvalCount(t),2)==1 then//1s tick
			call DamageTarget(geo,target,1,LoadInteger(HY,h,1)*5+10)
		endif
	endif
	set geo=null
	set target=null
	set t=null
endfunction

function IsGeostrikeApplied takes unit u returns boolean
	return GetUnitAbilityLevel(u,'A3A0')==1 or GetUnitAbilityLevel(u,'A3A1')==1 or GetUnitAbilityLevel(u,'A3A2')==1 or GetUnitAbilityLevel(u,'A3A3')==1 or GetUnitAbilityLevel(u,'A3A4')==1 or GetUnitAbilityLevel(u,'A3A5')==1 or GetUnitAbilityLevel(u,'A3A6')==1 or GetUnitAbilityLevel(u,'A3A7')==1
endfunction

function GeostrikeTriggered_Apply takes unit u, unit target returns nothing
	local trigger t
	local integer h
	local integer lvl=GetUnitAbilityLevel(u,'A0N7')//A0N7 -> Geostrike, QP1B -> Geostrike
	if IsGeostrikeApplied(target) then
		set t=LoadTriggerHandle(MHT,GetHandleId(target),'A40F')
		set h=GetHandleId(t)
		if IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER) and IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false then
			if GetUnitAbilityLevel(target,'A3A0'-1+lvl)==0 then
				call UnitRemoveAbility(target,LoadInteger(HY,h,0))
				call UnitRemoveAbility(target,'B079')//B079 -> Geostrike
				call UnitAddAbility2(target,'A3A0'-1+lvl)
				call SaveInteger(HY,h,0,'A3A0'-1+lvl)
			endif
		else
			if GetUnitAbilityLevel(target,'A3A4'-1+lvl)==0 then
				call UnitRemoveAbility(target,LoadInteger(HY,h,0))
				call UnitRemoveAbility(target,'B079')//B079 -> Geostrike
				call UnitAddAbility2(target,'A3A4'-1+lvl)
				call SaveInteger(HY,h,0,'A3A4'-1+lvl)
			endif
		endif
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(MHT,GetHandleId(target),'A40F',t)
		call TriggerRegisterTimerEvent(t,0.5,true)
		call TriggerRegisterDeathEvent(t,target)
		call TriggerAddCondition(t,Condition(function GeostrikeTriggered_Dur))
		call SaveUnitHandle(HY,h,0,u)
		call SaveUnitHandle(HY,h,1,target)
		if IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER) and IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false then
			call UnitAddAbility2(target,'A3A0'-1+lvl)
			call SaveInteger(HY,h,0,'A3A0'-1+lvl)
		else
			call UnitAddAbility2(target,'A3A4'-1+lvl)
			call SaveInteger(HY,h,0,'A3A4'-1+lvl)
		endif
		call SaveInteger(HY,h,1,lvl)
		
	endif
	if Mode_BO==false and IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER) and IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false then
		call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+2)
	else
		call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+4)
	endif
	set t=null
endfunction

function ZSF takes unit u returns boolean
	return GetUnitTypeId(u)=='H00I' or GetUnitTypeId(u)=='H00J'//H00I -> Geomancer, H00J -> Geomancer
endfunction

function IsMeepo takes unit whichUnit returns boolean
	return GetUnitTypeId(whichUnit)==('H00I')or GetUnitTypeId(whichUnit)==('H00J')//H00I -> Geomancer, H00J -> Geomancer
endfunction

function ZUF takes nothing returns nothing
	local integer ZVF=GetHandleId(GetTriggeringTrigger())
	local player p=(LoadPlayerHandle(HY,(ZVF),370))
	local integer ZWF=GetHandleId(p)
	local unit JJ9=(LoadUnitHandle(HY,(ZWF),699))
	local unit JK9=(LoadUnitHandle(HY,(ZWF),700))
	local unit JM9=(LoadUnitHandle(HY,(ZWF),701))
	local unit JN9=(LoadUnitHandle(HY,(ZWF),702))
	local unit JO9=(LoadUnitHandle(HY,(ZWF),703))
	local integer ZXF=GetUnitAbilityLevel(JJ9,'Aamk')*2//Aamk -> Attribute Bonus
	local integer BUE=GetHeroAgi(JJ9,false)
	local integer ZYF=GetHeroAgi(JJ9,true)-BUE-ZXF
	local integer BVE=GetHeroStr(JJ9,false)
	local integer ZZF=GetHeroStr(JJ9,true)-BVE-ZXF
	local integer ZAF=GetHeroInt(JJ9,false)
	local integer ZBF=GetHeroInt(JJ9,true)-ZAF-ZXF
	local real ZCF=.25
	local integer Z3F=R2I(BUE+ZYF*ZCF)
	local integer Z6F=R2I(BVE+ZZF*ZCF)
	local integer ZLF=R2I(ZAF+ZBF*ZCF)
	if GetWidgetLife(JJ9)>1 then
		if JK9!=null then
			call SetHeroAgi(JK9,Z3F,false)
			call SetHeroStr(JK9,Z6F,false)
			call SetHeroInt(JK9,ZLF,false)
		endif
		if JM9!=null then
			call SetHeroAgi(JM9,Z3F,false)
			call SetHeroStr(JM9,Z6F,false)
			call SetHeroInt(JM9,ZLF,false)
		endif
		if JN9!=null then
			call SetHeroAgi(JN9,Z3F,false)
			call SetHeroStr(JN9,Z6F,false)
			call SetHeroInt(JN9,ZLF,false)
		endif
		if JO9!=null then
			call SetHeroAgi(JO9,Z3F,false)
			call SetHeroStr(JO9,Z6F,false)
			call SetHeroInt(JO9,ZLF,false)
		endif
	endif
	set JJ9=null
	set JK9=null
	set JM9=null
	set JN9=null
	set JO9=null
endfunction

function Z1F takes nothing returns nothing
	local integer ZVF=GetHandleId(GetTriggeringTrigger())
	local player p=(LoadPlayerHandle(HY,(ZVF),370))
	local integer ZWF=GetHandleId(p)
	local unit JJ9=(LoadUnitHandle(HY,(ZWF),699))
	local unit JK9=(LoadUnitHandle(HY,(ZWF),700))
	local unit JM9=(LoadUnitHandle(HY,(ZWF),701))
	local unit JN9=(LoadUnitHandle(HY,(ZWF),702))
	local unit JO9=(LoadUnitHandle(HY,(ZWF),703))
	local integer Z0F=GetHandleId(JJ9)
	local integer Z5F=GetHandleId(JK9)
	local integer Z2F=GetHandleId(JM9)
	local integer A4F=GetHandleId(JN9)
	local integer A7F=GetHandleId(JO9)
	local integer A8F=(LoadInteger(HY,(Z0F),367))
	local integer A9F=(LoadInteger(HY,(Z0F),368))
	local integer ADF=(LoadInteger(HY,(Z5F),367))
	local integer AEF=(LoadInteger(HY,(Z5F),368))
	local integer AFF=(LoadInteger(HY,(Z2F),367))
	local integer AGF=(LoadInteger(HY,(Z2F),368))
	local integer AHF=(LoadInteger(HY,(A4F),367))
	local integer AIF=(LoadInteger(HY,(A4F),368))
	local integer AJF=(LoadInteger(HY,(A7F),367))
	local integer AKF=(LoadInteger(HY,(A7F),368))
	local integer AMF=GetHeroXP(JJ9)
	local integer ANF=GetHeroXP(JK9)
	local integer AOF=GetHeroXP(JM9)
	local integer APF=GetHeroXP(JN9)
	local integer AQF=GetHeroXP(JO9)
	local integer ARF=AMF-A8F-A9F
	local integer ASF=ANF-ADF-AEF
	local integer ATF=AOF-AFF-AGF
	local integer AUF=APF-AHF-AIF
	local integer AVF=AQF-AJF-AKF
	if GetWidgetLife(JJ9)>1 then
		set A8F=A8F+ARF
		set ADF=ADF+ASF
		set AFF=AFF+ATF
		set AHF=AHF+AUF
		set AJF=AJF+AVF
		if JJ9!=null then
			call AddHeroXP(JK9,ARF,false)
			if GetHeroXP(JK9)!=ANF then
				set AEF=AEF+ARF
			endif
			call AddHeroXP(JM9,ARF,false)
			if GetHeroXP(JM9)!=AOF then
				set AGF=AGF+ARF
			endif
			call AddHeroXP(JN9,ARF,false)
			if GetHeroXP(JN9)!=APF then
				set AIF=AIF+ARF
			endif
			call AddHeroXP(JO9,ARF,false)
			if GetHeroXP(JO9)!=AQF then
				set AKF=AKF+ARF
			endif
		endif
		if JK9!=null then
			call AddHeroXP(JJ9,ASF,false)
			if GetHeroXP(JJ9)!=AMF then
				set A9F=A9F+ASF
			endif
			call AddHeroXP(JM9,ASF,false)
			if GetHeroXP(JM9)!=AOF then
				set AGF=AGF+ASF
			endif
			call AddHeroXP(JN9,ASF,false)
			if GetHeroXP(JN9)!=APF then
				set AIF=AIF+ASF
			endif
			call AddHeroXP(JO9,ASF,false)
			if GetHeroXP(JO9)!=AQF then
				set AKF=AKF+ASF
			endif
		endif
		if JM9!=null then
			call AddHeroXP(JK9,ATF,false)
			if GetHeroXP(JK9)!=ANF then
				set AEF=AEF+ATF
			endif
			call AddHeroXP(JJ9,ATF,false)
			if GetHeroXP(JJ9)!=AMF then
				set A9F=A9F+ATF
			endif
			call AddHeroXP(JN9,ATF,false)
			if GetHeroXP(JN9)!=APF then
				set AIF=AIF+ATF
			endif
			call AddHeroXP(JO9,ATF,false)
			if GetHeroXP(JO9)!=AQF then
				set AKF=AKF+ATF
			endif
		endif
		if JN9!=null then
			call AddHeroXP(JK9,AUF,false)
			if GetHeroXP(JK9)!=ANF then
				set AEF=AEF+AUF
			endif
			call AddHeroXP(JM9,AUF,false)
			if GetHeroXP(JM9)!=AOF then
				set AGF=AGF+AUF
			endif
			call AddHeroXP(JJ9,AUF,false)
			if GetHeroXP(JJ9)!=AMF then
				set A9F=A9F+AUF
			endif
			call AddHeroXP(JO9,AUF,false)
			if GetHeroXP(JO9)!=AQF then
				set AKF=AKF+AUF
			endif
		endif
		if JO9!=null then
			call AddHeroXP(JK9,AVF,false)
			if GetHeroXP(JK9)!=ANF then
				set AEF=AEF+AVF
			endif
			call AddHeroXP(JM9,AVF,false)
			if GetHeroXP(JM9)!=AOF then
				set AGF=AGF+AVF
			endif
			call AddHeroXP(JJ9,AVF,false)
			if GetHeroXP(JJ9)!=AMF then
				set A9F=A9F+AVF
			endif
			call AddHeroXP(JN9,AVF,false)
			if GetHeroXP(JN9)!=APF then
				set AIF=AIF+AVF
			endif
		endif
		call SaveInteger(HY,(Z0F),367,(A8F))
		call SaveInteger(HY,(Z0F),368,(A9F))
		call SaveInteger(HY,(Z5F),367,(ADF))
		call SaveInteger(HY,(Z5F),368,(AEF))
		call SaveInteger(HY,(Z2F),367,(AFF))
		call SaveInteger(HY,(Z2F),368,(AGF))
		call SaveInteger(HY,(A4F),367,(AHF))
		call SaveInteger(HY,(A4F),368,(AIF))
		call SaveInteger(HY,(A7F),367,(AJF))
		call SaveInteger(HY,(A7F),368,(AKF))
	endif
	set JJ9=null
	set JK9=null
	set JM9=null
	set JN9=null
	set JO9=null
endfunction

function AYF takes nothing returns boolean
	return IsMeepo(GetTriggerUnit())and IsUnitIllusion(GetTriggerUnit())==false
endfunction

function AZF takes unit NewHero,unit Hero returns nothing
	local trigger t=(LoadTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Hero))),369))
	local integer i=0
	local boolean ABF=false
	local boolean ACF=false
	local boolean A3F=false
	local boolean A6F=false
	local boolean ALF=false
	local boolean A1F=false
	local boolean A0F=false
	local boolean A5F=false
	local boolean A2F=false
	call DisableTrigger(t)
	call DisableTrigger(t_manipulateitem)
	loop
		exitwhen i>5
		if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[BootsOfSpeed])then
			set ABF=true
		endif
		if (GetItemTypeId(UnitItemInSlot(Hero,i)))==(Item_Real[bootsOfTravel])then
			set ACF=true
		endif
		if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[PowerTreadsIntelligence])then
			set A3F=true
		endif
		if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[PowerTreadsStrength])then
			set A6F=true
		endif
		if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[PowerTreadsAgility])then
			set ALF=true
		endif
		if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[PhaseBoots])then
			set A1F=true
		endif
		if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[ArcaneBoots])then
			set A0F=true
		endif
		if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[TranquilBoots])then
			set A5F=true
		endif
		if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[TranquilBootsBroken])then
			set A2F=true
		endif
		set i=i+1
	endloop
	if A2F then
		call UnitAddItem(NewHero,CreateItem((Item_Real[TranquilBootsBroken]),0,0))
	elseif A5F then
		call UnitAddItem(NewHero,CreateItem((Item_Real[TranquilBoots]),0,0))
	elseif A0F then
		call UnitAddItem(NewHero,CreateItem((Item_Real[ArcaneBoots]),0,0))
	elseif A1F then
		call UnitAddItem(NewHero,CreateItem((Item_Real[PhaseBoots]),0,0))
	elseif ALF then
		call UnitAddItem(NewHero,CreateItem((Item_Real[PowerTreadsAgility]),0,0))
	elseif A6F then
		call UnitAddItem(NewHero,CreateItem((Item_Real[PowerTreadsStrength]),0,0))
	elseif A3F then
		call UnitAddItem(NewHero,CreateItem((Item_Real[PowerTreadsIntelligence]),0,0))
	elseif ACF then
		call UnitAddItem(NewHero,CreateItem((Item_Real[bootsOfTravel]),0,0))
	elseif ABF then
		call UnitAddItem(NewHero,CreateItem((Item_Real[BootsOfSpeed]),0,0))
	endif
	call EnableTrigger(t)
	call EnableTrigger(t_manipulateitem)
	set t=null
endfunction

function B4F takes nothing returns nothing
	local unit JP9=GetTriggerUnit()
	local integer i=0
	local boolean ABF=false
	local boolean ACF=false
	local boolean A3F=false
	local boolean A6F=false
	local boolean ALF=false
	local boolean A1F=false
	local boolean A0F=false
	local boolean A5F=false
	local boolean A2F=false
	local integer ZWF=GetHandleId(GetOwningPlayer(JP9))
	local unit JJ9=(LoadUnitHandle(HY,(ZWF),699))
	local unit JK9=(LoadUnitHandle(HY,(ZWF),700))
	local unit JM9=(LoadUnitHandle(HY,(ZWF),701))
	local unit JN9=(LoadUnitHandle(HY,(ZWF),702))
	local unit JO9=(LoadUnitHandle(HY,(ZWF),703))
	local integer FQ9
	local boolean B7F=false
	local integer B8F=0
	local integer B9F=0
	local integer BDF=0
	local integer BEF=0
	local integer BFF=0
	local integer BGF=0
	local integer BHF=0
	local integer BIF=0
	local integer BJF=0
	call DisableTrigger(GetTriggeringTrigger())
	if GetUnitTypeId(JP9)==('H00J')then//H00J -> Geomancer
		call UnitRemoveItemFromSlot(JP9,0)
		call EnableTrigger(GetTriggeringTrigger())
		return
	endif
	if not(GetItemTypeId(GetManipulatedItem())==(Item_Real[BootsOfSpeed])or (GetItemTypeId(GetManipulatedItem()))==(Item_Real[bootsOfTravel])or GetItemTypeId(GetManipulatedItem())==(Item_Real[PowerTreadsIntelligence])or GetItemTypeId(GetManipulatedItem())==(Item_Real[PowerTreadsStrength])or GetItemTypeId(GetManipulatedItem())==(Item_Real[PowerTreadsAgility])or (GetItemTypeId(GetManipulatedItem()))==(Item_Real[PhaseBoots])or GetItemTypeId(GetManipulatedItem())==(Item_Real[ArcaneBoots])or GetItemTypeId(GetManipulatedItem())==(Item_Real[TranquilBoots])or GetItemTypeId(GetManipulatedItem())==(Item_Real[TranquilBootsBroken]))then
		call EnableTrigger(GetTriggeringTrigger())
		return
	endif
	call DisableTrigger(t_manipulateitem)
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM then
		set B7F=true
	endif
	loop
		exitwhen i>5
		set FQ9=GetItemTypeId(UnitItemInSlot(JP9,i))
		if FQ9==(Item_Real[BootsOfSpeed])then
			set B8F=B8F+1
			if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(B8F>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
				set ABF=true
			endif
		endif
		if (FQ9)==(Item_Real[bootsOfTravel])then
			set B9F=B9F+1
			if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(B9F>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
				set ACF=true
			endif
		endif
		if FQ9==(Item_Real[PowerTreadsIntelligence])then
			set BDF=BDF+1
			if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BDF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
				set A3F=true
			endif
		endif
		if FQ9==(Item_Real[PowerTreadsStrength])then
			set BEF=BEF+1
			if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BEF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
				set A6F=true
			endif
		endif
		if FQ9==(Item_Real[PowerTreadsAgility])then
			set BFF=BFF+1
			if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BFF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
				set ALF=true
			endif
		endif
		if (FQ9)==(Item_Real[PhaseBoots])then
			set BGF=BGF+1
			if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BGF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
				set A1F=true
			endif
		endif
		if FQ9==(Item_Real[ArcaneBoots])then
			set BHF=BHF+1
			if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BHF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
				set A0F=true
			endif
		endif
		if FQ9==(Item_Real[TranquilBoots])then
			set BIF=BIF+1
			if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BIF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
				set A5F=true
			endif
		endif
		if FQ9==(Item_Real[TranquilBootsBroken])then
			set BJF=BJF+1
			if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BIF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
				set A2F=true
			endif
		endif
		set i=i+1
	endloop
	call RemoveItem(UnitRemoveItemFromSlot(JK9,0))
	if JM9!=null then
		call RemoveItem(UnitRemoveItemFromSlot(JM9,0))
	endif
	if JN9!=null then
		call RemoveItem(UnitRemoveItemFromSlot(JN9,0))
	endif
	if JO9!=null then
		call RemoveItem(UnitRemoveItemFromSlot(JO9,0))
	endif
	if A2F then
		call UnitAddItem(JK9,CreateItem((Item_Real[TranquilBootsBroken]),0,0))
		if JM9!=null then
			call UnitAddItem(JM9,CreateItem((Item_Real[TranquilBootsBroken]),0,0))
		endif
		if JN9!=null then
			call UnitAddItem(JN9,CreateItem((Item_Real[TranquilBootsBroken]),0,0))
		endif
		if JO9!=null then
			call UnitAddItem(JO9,CreateItem((Item_Real[TranquilBootsBroken]),0,0))
		endif
	elseif A5F then
		call UnitAddItem(JK9,CreateItem((Item_Real[TranquilBoots]),0,0))
		if JM9!=null then
			call UnitAddItem(JM9,CreateItem((Item_Real[TranquilBoots]),0,0))
		endif
		if JN9!=null then
			call UnitAddItem(JN9,CreateItem((Item_Real[TranquilBoots]),0,0))
		endif
		if JO9!=null then
			call UnitAddItem(JO9,CreateItem((Item_Real[TranquilBoots]),0,0))
		endif
	elseif A0F then
		call UnitAddItem(JK9,CreateItem((Item_Real[ArcaneBoots]),0,0))
		if JM9!=null then
			call UnitAddItem(JM9,CreateItem((Item_Real[ArcaneBoots]),0,0))
		endif
		if JN9!=null then
			call UnitAddItem(JN9,CreateItem((Item_Real[ArcaneBoots]),0,0))
		endif
		if JO9!=null then
			call UnitAddItem(JO9,CreateItem((Item_Real[ArcaneBoots]),0,0))
		endif
	elseif A1F then
		call UnitAddItem(JK9,CreateItem((Item_Real[PhaseBoots]),0,0))
		if JM9!=null then
			call UnitAddItem(JM9,CreateItem((Item_Real[PhaseBoots]),0,0))
		endif
		if JN9!=null then
			call UnitAddItem(JN9,CreateItem((Item_Real[PhaseBoots]),0,0))
		endif
		if JO9!=null then
			call UnitAddItem(JO9,CreateItem((Item_Real[PhaseBoots]),0,0))
		endif
	elseif ALF then
		call UnitAddItem(JK9,CreateItem((Item_Real[PowerTreadsAgility]),0,0))
		if JM9!=null then
			call UnitAddItem(JM9,CreateItem((Item_Real[PowerTreadsAgility]),0,0))
		endif
		if JN9!=null then
			call UnitAddItem(JN9,CreateItem((Item_Real[PowerTreadsAgility]),0,0))
		endif
		if JO9!=null then
			call UnitAddItem(JO9,CreateItem((Item_Real[PowerTreadsAgility]),0,0))
		endif
	elseif A6F then
		call UnitAddItem(JK9,CreateItem((Item_Real[PowerTreadsStrength]),0,0))
		if JM9!=null then
			call UnitAddItem(JM9,CreateItem((Item_Real[PowerTreadsStrength]),0,0))
		endif
		if JN9!=null then
			call UnitAddItem(JN9,CreateItem((Item_Real[PowerTreadsStrength]),0,0))
		endif
		if JO9!=null then
			call UnitAddItem(JO9,CreateItem((Item_Real[PowerTreadsStrength]),0,0))
		endif
	elseif A3F then
		call UnitAddItem(JK9,CreateItem((Item_Real[PowerTreadsIntelligence]),0,0))
		if JM9!=null then
			call UnitAddItem(JM9,CreateItem((Item_Real[PowerTreadsIntelligence]),0,0))
		endif
		if JN9!=null then
			call UnitAddItem(JN9,CreateItem((Item_Real[PowerTreadsIntelligence]),0,0))
		endif
		if JO9!=null then
			call UnitAddItem(JO9,CreateItem((Item_Real[PowerTreadsIntelligence]),0,0))
		endif
	elseif ACF then
		call UnitAddItem(JK9,CreateItem((Item_Real[bootsOfTravel]),0,0))
		if JM9!=null then
			call UnitAddItem(JM9,CreateItem((Item_Real[bootsOfTravel]),0,0))
		endif
		if JN9!=null then
			call UnitAddItem(JN9,CreateItem((Item_Real[bootsOfTravel]),0,0))
		endif
		if JO9!=null then
			call UnitAddItem(JO9,CreateItem((Item_Real[bootsOfTravel]),0,0))
		endif
	elseif ABF then
		call UnitAddItem(JK9,CreateItem((Item_Real[BootsOfSpeed]),0,0))
		if JM9!=null then
			call UnitAddItem(JM9,CreateItem((Item_Real[BootsOfSpeed]),0,0))
		endif
		if JN9!=null then
			call UnitAddItem(JN9,CreateItem((Item_Real[BootsOfSpeed]),0,0))
		endif
		if JO9!=null then
			call UnitAddItem(JO9,CreateItem((Item_Real[BootsOfSpeed]),0,0))
		endif
	endif
	call EnableTrigger(GetTriggeringTrigger())
	call EnableTrigger(t_manipulateitem)
	set JP9=null
	set JM9=null
	set JN9=null
	set JO9=null
	set JJ9=null
	set JK9=null
endfunction

function DoubleTrouble_LevelAbility takes unit BMF,integer BNF returns nothing
	local integer ZWF=GetHandleId(GetOwningPlayer(BMF))
	local unit JJ9=(LoadUnitHandle(HY,(ZWF),699))
	local unit JK9=(LoadUnitHandle(HY,(ZWF),700))
	local unit JM9=(LoadUnitHandle(HY,(ZWF),701))
	local unit JN9=(LoadUnitHandle(HY,(ZWF),702))
	local unit JO9=(LoadUnitHandle(HY,(ZWF),703))
	if JJ9!=null and JJ9!=BMF then
		call SelectHeroSkill(JJ9,BNF)
	endif
	if JK9!=null and JK9!=BMF then
		call SelectHeroSkill(JK9,BNF)
	endif
	if JM9!=null and JM9!=BMF then
		call SelectHeroSkill(JM9,BNF)
	endif
	if JN9!=null and JN9!=BMF then
		call SelectHeroSkill(JN9,BNF)
	endif
	if JO9!=null and JO9!=BMF then
		call SelectHeroSkill(JO9,BNF)
	endif
	set JM9=null
	set JN9=null
	set JO9=null
	set JJ9=null
	set JK9=null
endfunction

function BOF takes integer AF8,unit YCD,unit Y3D returns nothing
	local integer VT8=1
	local integer VU8=GetUnitAbilityLevel(YCD,AF8)
	loop
		exitwhen VT8>VU8
		call SelectHeroSkill(Y3D,AF8)
		set VT8=VT8+1
	endloop
endfunction

function BPF takes unit NewHero,unit BQF returns nothing
	local integer i=GetPlayerId(GetOwningPlayer(BQF))
	local integer aid1=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+1]]
	local integer aid2=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+2]]
	local integer aid3=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+3]]
	local integer aid4=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
	local integer aid5=AlternateSkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
	call UnitAddAbility2(NewHero,EngineeringUpgradeSkillID[PlayerSkillNumber[i*PlayerSkillOffset+1]])
	call UnitAddAbility2(NewHero,EngineeringUpgradeSkillID[PlayerSkillNumber[i*PlayerSkillOffset+2]])
	call UnitAddAbility2(NewHero,EngineeringUpgradeSkillID[PlayerSkillNumber[i*PlayerSkillOffset+3]])
	call UnitAddAbility2(NewHero,EngineeringUpgradeSkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]])
	call AddHeroXP(NewHero,GetHeroXP(BQF),false)
	call SaveInteger(HY,(GetHandleId(NewHero)),368,(GetHeroXP(BQF)))
	call SaveInteger(HY,(GetHandleId(NewHero)),367,0)
	call BOF(aid1,BQF,NewHero)
	call BOF(aid2,BQF,NewHero)
	call BOF(aid3,BQF,NewHero)
	call BOF('A0NR',BQF,NewHero)//A0NR -> Attribute Bonus
	call BOF(aid4,BQF,NewHero)
	call BOF(aid5,BQF,NewHero)
endfunction

function BRF takes unit JK9,unit JM9,integer BNF,integer B8F,integer B9F returns nothing
	if B8F>B9F then
		call SelectHeroSkill(JM9,BNF)
	elseif B9F>B8F then
		call SelectHeroSkill(JK9,BNF)
	endif
endfunction

function BSF takes unit JK9,unit JM9 returns nothing
	local integer ANF=GetHeroXP(JK9)
	local integer AOF=GetHeroXP(JM9)
	local integer Z5F=GetHandleId(JK9)
	local integer Z2F=GetHandleId(JM9)
	local integer AEF=(LoadInteger(HY,(Z5F),368))
	local integer AGF=(LoadInteger(HY,(Z2F),368))
	local integer YND
	if ANF>AOF then
		set YND=ANF-AOF
		call AddHeroXP(JM9,YND,true)
		if AOF!=GetHeroXP(JM9)then
			call SaveInteger(HY,(Z2F),368,(AGF+YND))
		endif
	elseif ANF<AOF then
		set YND=AOF-ANF
		call AddHeroXP(JK9,YND,true)
		if ANF!=GetHeroXP(JK9)then
			call SaveInteger(HY,(Z5F),368,(AEF+YND))
		endif
	endif
endfunction

function BTF takes unit JK9,unit JM9 returns nothing
	local integer i=GetPlayerId(GetOwningPlayer(JK9))
	local integer aid1=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+1]]
	local integer aid2=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+2]]
	local integer aid3=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+3]]
	local integer aid4=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
	local integer aid5=AlternateSkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
	local integer BUF=GetUnitAbilityLevel(JK9,aid1)
	local integer BVF=GetUnitAbilityLevel(JK9,aid2)
	local integer BWF=GetUnitAbilityLevel(JK9,aid3)
	local integer BXF=GetUnitAbilityLevel(JK9,aid4)
	local integer BYF=GetUnitAbilityLevel(JK9,'A0NR')//A0NR -> Attribute Bonus
	local integer BZF=GetUnitAbilityLevel(JK9,aid5)
	local integer BAF=GetUnitAbilityLevel(JM9,aid1)
	local integer BBF=GetUnitAbilityLevel(JM9,aid2)
	local integer BCF=GetUnitAbilityLevel(JM9,aid3)
	local integer B3F=GetUnitAbilityLevel(JM9,aid4)
	local integer B6F=GetUnitAbilityLevel(JM9,'A0NR')//A0NR -> Attribute Bonus
	local integer BLF=GetUnitAbilityLevel(JM9,aid5)
	call BSF(JK9,JM9)
	call BRF(JK9,JM9,aid1,BUF,BAF)
	call BRF(JK9,JM9,aid2,BVF,BBF)
	call BRF(JK9,JM9,aid3,BWF,BCF)
	call BRF(JK9,JM9,aid4,BXF,B3F)
	call BRF(JK9,JM9,aid5,BZF,BLF)
	call BRF(JK9,JM9,'A0NR',BYF,B6F)//A0NR -> Attribute Bonus
endfunction

function B1F takes unit JK9,unit JM9 returns nothing
	if JK9!=null and JM9!=null then
		call BTF(JK9,JM9)
	endif
endfunction

function B0F takes nothing returns nothing
	local integer ZWF=GetHandleId((LoadPlayerHandle(HY,(GetHandleId(GetTriggeringTrigger())),370)))
	local unit JJ9=(LoadUnitHandle(HY,(ZWF),699))
	local unit JK9=(LoadUnitHandle(HY,(ZWF),700))
	local unit JM9=(LoadUnitHandle(HY,(ZWF),701))
	local unit JN9=(LoadUnitHandle(HY,(ZWF),702))
	local unit JO9=(LoadUnitHandle(HY,(ZWF),703))
	call DisableTrigger(DoubleTroubleTrigger)
	call B1F(JJ9,JK9)
	call B1F(JJ9,JM9)
	call B1F(JJ9,JN9)
	call B1F(JJ9,JO9)
	call B1F(JK9,JM9)
	call B1F(JK9,JN9)
	call B1F(JK9,JO9)
	call B1F(JM9,JN9)
	call B1F(JM9,JO9)
	call B1F(JN9,JO9)
	call EnableTrigger(DoubleTroubleTrigger)
	set JM9=null
	set JN9=null
	set JO9=null
	set JJ9=null
	set JK9=null
endfunction

function B5F takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.2,true)
	call TriggerAddAction(t,function B0F)
	call SavePlayerHandle(HY,(GetHandleId(t)),370,(GetOwningPlayer(GetTriggerUnit())))
	set t=null
endfunction

function DividedWeStand_Initialize takes unit Source returns nothing
	local trigger t
	call SaveUnitHandle(HY,(GetHandleId(GetOwningPlayer(Source))),699,(Source))
	call SaveInteger(HY,(GetHandleId(Source)),367,(GetHeroXP(Source)))
	call SaveInteger(HY,(GetHandleId(Source)),368,0)
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddAction(t,function Z1F)
	call SavePlayerHandle(HY,(GetHandleId(t)),370,(GetOwningPlayer(Source)))
	call SaveTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Source))),371,(t))
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.3,true)
	call TriggerAddAction(t,function ZUF)
	call SavePlayerHandle(HY,(GetHandleId(t)),370,(GetOwningPlayer(Source)))
	call SaveTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Source))),372,(t))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DROP_ITEM)
	call TriggerAddAction(t,function B4F)
	call TriggerAddCondition(t,Condition(function AYF))
	call SaveTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Source))),369,(t))
	call ExecuteFunc("B5F")
	set t=null
endfunction

function DividedWeStand_CreateNewClone takes unit Source,boolean CZ9 returns nothing
	local player p=GetOwningPlayer(Source)
	local integer h=GetHandleId(p)
	local unit NewHero
	set dividedwestand_count=dividedwestand_count+1
	if dividedwestand_count==1 then
		call DividedWeStand_Initialize(Source)
//		call BJDebugMsg("dividedwestand start")
	endif
	call TriggerExecute((LoadTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Source))),371)))
	call TriggerExecute((LoadTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Source))),372)))
	if CZ9==false then
		call DoubleTrouble_LevelAbility(Source,'A0MW')//A0MW -> Divided We Stand
		call DoubleTrouble_LevelAbility(Source,'A27C')//A27C -> Divided We Stand
	endif
	set NewHero=CreateUnit(GetOwningPlayer(Source),'H00J',GetUnitX(Source),GetUnitY(Source),0)//H00J -> Geomancer
	call BPF(NewHero,Source)
	call AZF(NewHero,Source)
	call SaveUnitHandle(HY,h,(699+dividedwestand_count),(NewHero))
	set NewHero=null
endfunction

function DividedWeStand_Learned takes nothing returns boolean
	local integer i=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
	local integer aid1=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+1]]
	local integer aid2=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+2]]
	local integer aid3=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+3]]
	local integer aid4=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
	local integer aid5=AlternateSkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	if IsUnitIllusion(GetTriggerUnit())==false and GetOwningPlayer(GetTriggerUnit())==GetOwningPlayer(Source)then //and ZSF(GetTriggerUnit())then
		if GetLearnedSkill()=='A0MW' or GetLearnedSkill()=='A27C' then //Divided We Stand is leveled//A0MW -> Divided We Stand, A27C -> Divided We Stand
			call DisableTrigger(GetTriggeringTrigger())
			call DividedWeStand_CreateNewClone(GetTriggerUnit(),false)
			call EnableTrigger(GetTriggeringTrigger())
		elseif GetLearnedSkill()=='A0NR' or GetLearnedSkill()==aid1 or GetLearnedSkill()==aid2 or GetLearnedSkill()==aid3 or GetLearnedSkill()==aid4 or GetLearnedSkill()==aid5 then//A0NR -> Attribute Bonus
			call TriggerExecute((LoadTriggerHandle(HY,(GetHandleId(GetOwningPlayer(GetTriggerUnit()))),371)))
			call TriggerExecute((LoadTriggerHandle(HY,(GetHandleId(GetOwningPlayer(GetTriggerUnit()))),372)))
			call DisableTrigger(GetTriggeringTrigger())
			call DoubleTrouble_LevelAbility(GetTriggerUnit(),GetLearnedSkill())
			call EnableTrigger(GetTriggeringTrigger())
		endif
	endif
	set Source=null
	set t=null
	return false
endfunction

function Register_DividedWeStand takes nothing returns nothing
	local unit Source=tt_unit1
	local integer h
	set dividedwestand_t=CreateTrigger()
	set DoubleTroubleTrigger=dividedwestand_t
	set h=GetHandleId(dividedwestand_t)
	call TriggerRegisterAnyUnitEvent(dividedwestand_t,EVENT_PLAYER_HERO_SKILL)
	call TriggerAddCondition(dividedwestand_t,Condition(function DividedWeStand_Learned))
	call SaveUnitHandle(HY,h,2,(Source))
	set Source=null
endfunction

function Leshrak_SplitEarth takes nothing returns nothing
	local location l=GetSpellTargetLoc()
	local unit Caster=CreateUnitAtLoc(GetOwningPlayer(GetTriggerUnit()),'e00E',l,0)//e00E -> Spellcaster
	call UnitAddAbility(Caster,'A06W')//A06W -> Split Earth
	call SetUnitAbilityLevel(Caster,'A06W',GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))//A06W -> Split Earth
	if IssuePointOrderLoc(Caster,"dreadlordinferno",l)==false then
		call IssuePointOrderLoc(Caster,"inferno",l)
	endif
	call ZD8("Abilities\\Spells\\Orc\\EarthQuake\\EarthQuakeTarget.mdl",GetLocationX(l),GetLocationY(l),2)
	call TerrainDeformationRippleBJ(.3,false,l,0,300,100,.4,20)
	call RemoveLocation(l)
	set l=null
	set Caster=null
endfunction

function LightningStormChecker takes unit attacker, unit target returns nothing
	if GetUnitAbilityLevel(attacker,'A3A8')>0 then
		call UnitAddAbilityTimedEx(target,'A34I',1,0.6+0.1*GetUnitAbilityLevel(attacker,'A3A8'),'B0H8')//B0H8 -> Lightning Storm
	endif
endfunction

function Leshrak_LightningsAct takes unit caster, unit target returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetUnitFacing(GetTriggerUnit()))//e00E -> Spellcaster
	call UnitAddAbility(d,'A3A8')
	call DummyDamageTracking(10)
	call SetUnitAbilityLevel(d,'A3A8',GetUnitAbilityLevel(GetTriggerUnit(),'A06V'))//A06V -> Lightning Storm
	call IssueTargetOrder(d,"chainlightning",GetSpellTargetUnit())
	set d=null
endfunction

function Leshrak_Lightnings takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Leshrak_LightningsAct(GetTriggerUnit(),GetSpellTargetUnit())
	endif
endfunction

function CDF takes nothing returns boolean
	return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'Avul')==0//, Avul -> Invulnerable
endfunction

function CEF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer Level=(LoadInteger(HY,h,5))
	local group g
	local unit u
	local real d
	local real a
	local real x
	local real y
	local unit Caster=(LoadUnitHandle(HY,h,19))
	if GetTriggerEvalCount(t)>40 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set g=GetAvailableGroup()
		set tt_unit1=Hero
		call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),500+12,Condition(function CDF))
		set u=GroupPickRandomUnit(g)
		if u==null then
			set d=GetRandomReal(175,400)
			set a=GetRandomReal(0,6)
			set x=GetUnitX(Hero)+d*Cos(a)
			set y=GetUnitY(Hero)+d*Sin(a)
			call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\SteamTank\\SteamTankImpact.mdl",x,y))
		else
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\SteamTank\\SteamTankImpact.mdl",u,"origin"))
			call DamageTarget(Caster,u,5,12.5*Level)
		endif
		call KillGroup(g)
	endif
	set u=null
	set g=null
	set t=null
	set Hero=null
	set Caster=null
	return false
endfunction

function Leshrak_DiabolicEdict takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
	if GetUnitTypeId(Hero)=='e00E' then//e00E -> Spellcaster
		set Hero=udg_Hero[GetPlayerId(GetOwningPlayer(Hero))]
	endif
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\RocketMissile\\RocketMissile.mdl",Hero,"hand right"))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Hero,'A20T')))//A20T -> Diabolic Edict
	call TriggerRegisterTimerEvent(t,.25,true)
	call TriggerAddCondition(t,Condition(function CEF))
	set t=null
	set Hero=null
	set Caster=null
endfunction

function CHF takes nothing returns nothing
	local unit Source=JN8
	local unit Target=GetEnumUnit()
	call DamageTarget(Source,Target,1,JO8)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",Target,"origin"))
	set Source=null
	set Target=null
endfunction

function CIF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=GetUnitAbilityLevel(Source,'A21F')//A21F -> Pulse Nova
	local group g
	local boolean b=GetUnitAbilityLevel(Source,'A21G')>0//A21G -> Pulse Nova
	if not b then
		set JO8=70+30*Level
	else
		set Level=GetUnitAbilityLevel(Source,'A21G')//A21G -> Pulse Nova
		set JO8=140+20*Level
	endif
	if GetTriggerEvalCount(t)==1 and b then
		call UnitAddAbility2(Source,'A345')
	endif
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetUnitState(Source,UNIT_STATE_MANA)<20*Level or LoadInteger(HY,GetHandleId(Source),704)==-1 or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and(GetSpellAbilityId()=='A21H' or GetSpellAbilityId()=='A27H' or GetSpellAbilityId()=='A30J'))then//A21H -> Pulse Nova turn off, A27H -> Spell Steal, A30J -> Spell Steal
		if LoadInteger(HY,GetHandleId(Source),704)==0 or LoadInteger(HY,GetHandleId(Source),704)=='A21F' then//A21F -> Pulse Nova
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21F',true)//A21F -> Pulse Nova
		endif
		if LoadInteger(HY,GetHandleId(Source),704)==0 or LoadInteger(HY,GetHandleId(Source),704)=='A21G' then//A21G -> Pulse Nova
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21G',true)//A21G -> Pulse Nova
		endif
		call UnitRemoveAbility(Source,'A345')
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21H',false)//A21H -> Pulse Nova turn off
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT then
		
		
		call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)-20*Level)
		set tt_unit1=Source
		set JN8=Source
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),475,Condition(function NonImmuneEnemyFilterWithAncients))
		
		call ForGroup(g,function CHF)
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Source=null
	return false
endfunction

function Leshrak_PulseNova takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",Source,"origin"))
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21F',false)//A21F -> Pulse Nova
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21G',false)//A21G -> Pulse Nova
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21H',true)//A21H -> Pulse Nova turn off
	call UnitAddAbility2(Source,'A21H')//A21H -> Pulse Nova turn off
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function CIF))
	call SaveUnitHandle(HY,h,2,(Source))
	call TriggerEvaluate(t)
	set Source=null
	set t=null
endfunction

function LichChainFrostFilter takes nothing returns boolean
	return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and (AliveNonBuildOrMarker(GetFilterUnit())) and (GenericCondition_IsDotAInvis(GetFilterUnit())==false or IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))) and IsUnitInvulnerable(GetFilterUnit())==false
endfunction

function CMF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local unit YSE=(LoadUnitHandle(HY,h,374))
	local integer Level=(LoadInteger(HY,h,5))
	local integer CNF=(LoadInteger(HY,h,233))
	local integer RHE=(LoadInteger(HY,h,12))
	local unit Caster
	local group g
	local real a
	local real x
	local real y
	local integer D09=(LoadInteger(HY,h,720))
	if D09>0 then
		set D09=D09-1
		call SaveInteger(HY,h,720,(D09))
		set Source=null
		set t=null
		set Target=null
		set YSE=null
		return false
	endif
	if DistanceBetweenXY(GetUnitX(YSE),GetUnitY(YSE),GetUnitX(Target),GetUnitY(Target))>20 then
		set a=AngleBetweenXY(GetUnitX(YSE),GetUnitY(YSE),GetUnitX(Target),GetUnitY(Target))
		call SetUnitFacing(YSE,a)
		set x=GetUnitX(YSE)+17*Cos(a*bj_DEGTORAD)
		set y=GetUnitY(YSE)+17*Sin(a*bj_DEGTORAD)
		call SetUnitX(YSE,x)
		call SetUnitY(YSE,y)
	else
		if IsDead(Target)==false then
			if IsMagicImmune(Target)==false then
				set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
				call UnitAddAbility2(Caster,'A091')//A091 -> Frost Nova
				call SetUnitAbilityLevel(Caster,'A091',LoadInteger(HY,h,6))//A091 -> Frost Nova
				if LotusOrbCasting(Caster,Target,852226) then
					call UnitAddAbilityTimedExF(Target,'A3JM',1,4,0)
				endif
			endif
			if CNF==1 and not LoadBoolean(HY,h,0) then
				if GetUnitAbilityLevel(Target,'A3E9')==1 then
					if IsBlocked(Source)==false then
						call SaveUnitHandle(TempHash,'A3E9',0,Target)
						call SaveUnitHandle(TempHash,'A3E9',1,Source)
						call SaveInteger(TempHash,'A3E9',0,Level)
						if RHE>100 then
							call SaveInteger(TempHash,'A3E9',1,'A08H')//A08H -> Chain Frost
						else
							call SaveInteger(TempHash,'A3E9',1,'A05T')//A05T -> Chain Frost
						endif
						call ExecuteFunc("Lich_ChainFrost_LotusOrb")
					else
						call RemoveLinkenBuff(Source)
					endif
				endif
			endif
		endif
		if CNF>RHE then
			call RemoveUnit(YSE)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		else
			set g=GetAvailableGroup()
			set tt_unit1=Source
			call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),600,Condition(function LichChainFrostFilter))
			call GroupRemoveUnit(g,Target)
			set Target=GroupPickRandomUnit(g)
			call KillGroup(g)
			if Target==null then
				call RemoveUnit(YSE)
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
			else
				call SaveInteger(HY,h,720,10)
				call SaveInteger(HY,h,233,(CNF+1))
				call SaveUnitHandle(HY,h,17,(Target))
				if CNF>60 then
					call UnitAddAbility2(YSE,'A3C9')
				endif
			endif
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set YSE=null
	set Caster=null
	set g=null
	return false
endfunction

function Lich_ChainFrost takes nothing returns nothing
	local timer t2=GetExpiredTimer()
	local integer h2=GetHandleId(t2)
	local unit Source=LoadUnitHandle(HY,h2,0)
	local unit Target=LoadUnitHandle(HY,h2,1)
	local integer Level=LoadInteger(HY,h2,0)
	local integer RHE=10
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit YSE
	local unit d
	local integer novalvl=Level
	//call echo(GetUnitName(Source)+" -> "+GetUnitName(Target))
	if LoadInteger(HY,h2,1)=='A08H' then//A08H -> Chain Frost
		set RHE=99999
		set novalvl=novalvl+1
	endif
	set YSE=CreateUnit(GetOwningPlayer(Source),'e009',GetUnitX(Source),GetUnitY(Source),0)//e009 -> Frost Missile
	if GetUnitTypeId(Source)=='e00E' then//e00E -> Spellcaster
		call SaveUnitHandle(HY,h,2,udg_Hero[GetPlayerId(GetOwningPlayer(Source))])
	else
		call SaveUnitHandle(HY,h,2,(Source))
	endif
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveUnitHandle(HY,h,374,(YSE))
	call SaveInteger(HY,h,5,(Level))
	call SaveInteger(HY,(h),6,(novalvl))
	call SaveInteger(HY,h,233,1)
	call SaveInteger(HY,h,12,(RHE))
	call SaveInteger(HY,h,720,0)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function CMF))
	if LoadBoolean(HY,h2,0) then
		call SaveBoolean(HY,h,0,true)
		set d=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
		call UnitAddAbility(d,'A05T')//A05T -> Chain Frost
		call IssueTargetOrderVis(d,"thunderbolt",Target)
		set d=null
	endif
	call FlushChildHashtable(HY,h2)
	call DestroyTimer(t2)
	set Source=null
	set Target=null
	set YSE=null
	set t=null
	set t2=null
endfunction

function Lich_ChainFrost_LotusOrb takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	call TimerStart(t,0,false,function Lich_ChainFrost)
	call SaveUnitHandle(HY,h,0,LoadUnitHandle(TempHash,'A3E9',0))
	call SaveUnitHandle(HY,h,1,LoadUnitHandle(TempHash,'A3E9',1))
	call SaveInteger(HY,h,0,LoadInteger(TempHash,'A3E9',0))
	call SaveInteger(HY,h,1,LoadInteger(TempHash,'A3E9',1))
	call SaveBoolean(HY,h,0,true)
	set t=null
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function Lich_ChainFrostWrapper takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0,false,function Lich_ChainFrost)
	call SaveUnitHandle(HY,h,0,GetTriggerUnit())
	call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),'A05T'))//A05T -> Chain Frost
	call SaveInteger(HY,h,1,GetSpellAbilityId())
	set t=null
endfunction

function QID takes unit u,integer d returns nothing
	local texttag t=CreateTextTag()
	call SetTextTagText(t,"+"+I2S(d)+" "+GetObjectName('n0LQ'),.03)//n0LQ -> Mana
	call SetTextTagPosUnit(t,u,0)
	call SetTextTagColorBJ(t,50,75,255,15)
	call SetTextTagVelocity(t,0,.035)
	call SetTextTagFadepoint(t,3)
	call SetTextTagLifespan(t,2.5)
	call SetTextTagPermanent(t,false)
	call SetTextTagVisibility(t,IsUnitVisibleLoD(u,GetLocalPlayer())or IsObserver(GetLocalPlayer()))
	set t=null
endfunction

function Lich_DarkRitual_Delayed takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local real mp=LoadReal(HY,h,0)
	call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+mp)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set u=null
endfunction

function QJD takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t
	local integer h
	if GetUnitTypeId(Source)=='e00C' then//e00C -> Self Caster
		set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
	endif
	if GetWidgetLife(Source)>1 then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0,false)
		call TriggerAddCondition(t,Condition(function Lich_DarkRitual_Delayed))
		call SaveUnitHandle(HY,h,0,Source)
		call SaveReal(HY,h,0,GetWidgetLife(Target)*(GetUnitAbilityLevel(Source,'A053')*(.15)+0.1))//A053 -> Dark Ritual
		call QID(Target,R2I(GetWidgetLife(Target)*(GetUnitAbilityLevel(Source,'A053')*(.15)+0.1)))//A053 -> Dark Ritual
		set SacrificedByLich=true
		call DamageTarget(Source,Target,1,99999)
		call DamageTarget(Source,Target,2,99999)
		call DamageTarget(Source,Target,3,99999)
		set t=null
	endif
	set Source=null
	set Target=null
endfunction

function Lich_DarkRitual takes nothing returns nothing
	if IsCourier(GetSpellTargetUnit())==false then
		call QJD()
	endif
endfunction

function Lich_FrostNove_Remove takes nothing returns nothing	
	call RestoreTint(GetEnumUnit())
	call UnitRemoveAbility(GetEnumUnit(),'A30A')
	call UnitRemoveAbility(GetEnumUnit(),'B30A')//B30A -> Slowed
endfunction

function Lich_FrostNova_End takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local group g=LoadGroupHandle(HY,h,1)
	call ForGroup(g,function Lich_FrostNove_Remove)
	call GroupClear(g)
	call DestroyGroup(g)
	set g=null
	set t=null
endfunction

function Lich_FrostNova_Targets takes nothing returns boolean
	return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TEMPUNIT)) and AliveNonBuildOrMarker(GetFilterUnit()) and IsMagicImmune(GetFilterUnit())==false
endfunction

function Lich_FrostNova_Group takes nothing returns nothing
	local unit u=GetEnumUnit()
	call DamageTarget(LoadUnitHandle(TempHash,'A07F',0),u,1,50+25*tt_int1)
	if IsDead(u)==false then
		call UnitAddAbility2(u,'A30A')
		call ApplyFrostColor(u)
	endif
	set u=null
endfunction

function Lich_FrostNova_Act takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local group g=CreateGroup()
	call TriggerRegisterTimerEvent(t,4,false)
	call TriggerAddCondition(t,Condition(function Lich_FrostNova_End))
	call TriggerRegisterDeathEvent(t,target)
	call DamageTarget(u,target,1,50*GetUnitAbilityLevel(u,GetSpellAbilityId()))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\FrostNova\\FrostNovaTarget.mdl",target,"origin"))
	set TEMPUNIT=u
	call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),225,Condition(function Lich_FrostNova_Targets))
	call GroupAddUnit(g,target)
	call SaveUnitHandle(TempHash,'A07F',0,u)
	set tt_int1=GetUnitAbilityLevel(u,'A07F')//A07F -> Frost Nova
	call ForGroup(g,function Lich_FrostNova_Group)
	call SaveGroupHandle(HY,h,1,g)
	call RemoveSavedHandle(TempHash,'A07F',0)
	set g=null
	set target=null
	set u=null
	set t=null
endfunction

function Lich_FrostNova_Start takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Lich_FrostNova_Act()
	endif
endfunction

function Lich_FrostArmor_Remove takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	if IsDead(u)==false then
		call UnitRemoveAbility(u,'A308')
		call UnitRemoveAbility(u,'B308')//B308 -> Frost Armor
	endif
	if GetUnitAbilityLevel(u,'B308')==0 then//B308 -> Frost Armor
		//call DestroyEffect(LoadEffectHandle(HY,GetHandleId(t),1))
		call SaveBoolean(HY,GetHandleId(u),1991,false)
		call RemoveSavedHandle(HY,GetHandleId(u),1991)
		call FlushChildHashtable(HY,GetHandleId(t))
		call DestroyTimer(t)
	else
		call TimerStart(t,1,true,function Lich_FrostArmor_Remove)
	endif
	set t=null
	set u=null
endfunction

function Lich_FrostArmor_RangedAttack takes unit u, unit t returns nothing
	local timer tt
	if IsMagicImmune(u)==false then
		call UnitAddAbility2(u,'A308')
		if(LoadBoolean(HY,GetHandleId(u),1991))then
			set tt=LoadTimerHandle(HY,GetHandleId(u),1991)
			call TimerStart(tt,2,false,function Lich_FrostArmor_Remove)
		else
			set tt=CreateTimer()
			call TimerStart(tt,2,false,function Lich_FrostArmor_Remove)
			call SaveUnitHandle(HY,GetHandleId(tt),0,u)
			call SaveBoolean(HY,GetHandleId(u),1991,true)
			call SaveTimerHandle(HY,GetHandleId(u),1991,tt)
			//call SaveEffectHandle(HY,GetHandleId(tt),1,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\FrostArmor\\FrostArmorDamage.mdl",u,"origin"))
		endif
		set tt=null
	endif
endfunction

function Lion_Impale takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real x1=GetUnitX(Hero)
	local real y1=GetUnitY(Hero)
	local real a
	local real x2
	local real y2
	local integer Level=GetUnitAbilityLevel(Hero,'A0X5')//A0X5 -> Impale
	local real Damage
	local real DP9
	local unit D09=null
	if GetSpellTargetUnit()!=null then
		set x2=GetUnitX(GetSpellTargetUnit())
		set y2=GetUnitY(GetSpellTargetUnit())
	else
		set x2=GetSpellTargetX()
		set y2=GetSpellTargetY()
	endif
	set a=Atan2(y2-y1,x2-x1)
	set x2=x1+700*Cos(a)
	set y2=y1+700*Sin(a)
	if Level==1 then
		set Damage=60
		set DP9=.5
	elseif Level==2 then
		set Damage=130
		set DP9=1
	elseif Level==3 then
		set Damage=200
		set DP9=1.5
	elseif Level==4 then
		set Damage=260
		set DP9=2
	endif
	if GetSpellTargetUnit()!=null and IsBlocked(GetSpellTargetUnit())then
		set D09=GetSpellTargetUnit()
	endif
	call ImpaleFactory(Hero,D09,Damage,DP9,.52,x1,y1,x2,y2,150,null,true,1600)
	set Hero=null
	set D09=null
endfunction


function Lion_FingerOfDeath_SplashAct takes nothing returns nothing
	local real dmg=475+125*GetUnitAbilityLevel(Lion_Finger_TempUnit,'A09W')//A09W -> Finger of Death
	call DamageTarget(Lion_Finger_TempUnit,GetEnumUnit(),1,dmg)
endfunction

function Lion_FingerOfDeath_Splash_Delayed takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local integer lvl=LoadInteger(HY,h,0)
	local group g=GetAvailableGroup()
	set tt_unit1=caster
	call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),300+25,Condition(function NonImmuneEnemyFilter))
	call GroupRemoveUnit(g,target)
	if FirstOfGroup(g)!=null then
		set Lion_Finger_TempUnit=caster
		call ForGroup(g,function Lion_FingerOfDeath_SplashAct)
	endif
	call KillGroup(g)
	call CleanTimer(t)
	set t=null
	set g=null
	set target=null
	set caster=null
endfunction

function Lion_FingerOfDeath_Splash takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,.25,false,function Lion_FingerOfDeath_Splash_Delayed)
	call SaveUnitHandle(HY,h,0,GetTriggerUnit())
	call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
	set t=null
endfunction

function Lion_Finger_OnCast takes nothing returns nothing
	if IsMagicImmune(GetSpellTargetUnit())then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0LR'))//n0LR -> Target is magic immune
	endif
endfunction

function CTF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosDone.mdl",Hero,"origin"))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",Hero,"origin"))
	call UnitRemoveAbility(Hero,'A0ZC')//A0ZC -> Wolf Form
	call UnitRemoveAbility(Hero,'B00V')//B00V -> Wolf Spirit
	call UnitRemoveAbility(Hero,'A521')//A521 -> Nethertoxin
	call RestoreTint(Hero)
	call SetTint(Hero,-1,-1,-1,255)
	call RemoveUnit(LoadUnitHandle(HY,h,15))
	call CustomSpeed(Hero,0,0)
	call ManageBonusHP(Hero,-1 * LoadInteger(HY,h,16))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	return false
endfunction

function CUF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local unit d = LoadUnitHandle(HY,h,15)
	local integer bonus=LoadInteger(HY,h,16)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosDone.mdl",Hero,"origin"))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",Hero,"origin"))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,18-.1,false)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerAddCondition(t,Condition(function CTF))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveUnitHandle(HY,h,15,d)
	call SaveInteger(HY,h,16,bonus)
	call CustomSpeed(Hero,999,650)
	set d = null
	set t=null
	set Hero=null
	return false
endfunction

function CVF takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e01V',0,0,0)//e01V -> Spellcaster #3
	local real DP9=18
	local real hp=GetWidgetLife(Hero)
	local real bon=100*GetUnitAbilityLevel(Hero,GetSpellAbilityId())
	call ManageBonusHP(Hero,R2I(bon))
	call SaveInteger(HY,h,16,R2I(bon))
	call SetWidgetLife(Hero,hp+bon)
	call UnitAddAbility2(Caster,'A0ZC')//A0ZC -> Wolf Form
	call UnitApplyTimedLife(Caster,'BTLF',DP9)
	call SetTint(Hero,255,100,255,175)
	call TriggerRegisterTimerEvent(t,.1,false)
	call TriggerAddCondition(t,Condition(function CUF))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveUnitHandle(HY,h,15,Caster)
	set t=null
	set Hero=null
	set Caster=null
endfunction

function Lycan_Shapeshift takes nothing returns nothing
	if GetUnitTypeId(GetTriggerUnit())!='E015' then//E015 -> Lycanthrope
		call CVF()
	endif
endfunction

function Lycan_SpiritWolves takes nothing returns nothing
	local unit wolf
	local integer id=0
	local integer lvl=GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId())
	local real x=GetUnitX(GetTriggerUnit())
	local real y=GetUnitY(GetTriggerUnit())
	local real a=GetUnitFacing(GetTriggerUnit())
	if lvl==1 then
		set id='o005'
	elseif lvl==2then
		set id='o006'
	elseif lvl==3 then
		set id='o007'
	else
		set id='o00F'
	endif
	set wolf=CreateUnit(GetTriggerPlayer(),id,x+30*Cos(a*bj_DEGTORAD),y+30*Sin(a*bj_DEGTORAD),a)
	call UnitApplyTimedLife(wolf,'BTLF',55)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",wolf,"origin"))
	set wolf=CreateUnit(GetTriggerPlayer(),id,x+30*Cos(a*bj_DEGTORAD),y+30*Sin(a*bj_DEGTORAD),a)
	call UnitApplyTimedLife(wolf,'BTLF',55)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",wolf,"origin"))
	call SetPlayerAbilityAvailable2(GetOwningPlayer(GetTriggerUnit()),'A03B',true)//A03B -> Crit Strike
	set wolf=null
endfunction


function YOD takes nothing returns nothing
	local unit Source=IM
	local unit Target=AM
	local unit Caster=(LoadUnitHandle(HY,(GetHandleId(Source)),219))
	call SaveUnitHandle(HY,(GetHandleId(Source)),219,(Caster))
	call SetUnitOwner(Caster,GetOwningPlayer(Target),true)
	set Source=null
	set Target=null
	set Caster=null
endfunction

function YD9 takes nothing returns nothing
	local unit Hero=VK
	local unit Caster=(LoadUnitHandle(HY,(GetHandleId(Hero)),219))
	if Caster!=null and GetUnitTypeId(Caster)=='e01V' then//e01V -> Spellcaster #3
		call RemoveUnit(Caster)
	endif
	set Hero=null
	set Caster=null
endfunction

function CXF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local unit Source=(LoadUnitHandle(HY,h,2))
	if Caster!=null and GetUnitTypeId(Caster)=='e01V' then//e01V -> Spellcaster #3
		if IsDead(Source)==false then
			call SetUnitX(Caster,GetUnitX(Source))
			call SetUnitY(Caster,GetUnitY(Source))
		endif
	endif
	set t=null
	set Caster=null
	set Source=null
	return false
endfunction

function Lycan_FeralImpulse_Leveling takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Hero,'A03E')//A03E -> Feral Impulse, QP0Q -> Feral Impulse
	local unit Caster
	local trigger t
	local integer h
	if Level==1 then
		set Caster=CreateUnit(GetOwningPlayer(Hero),'e01V',0,0,0)//e01V -> Spellcaster #3
		call UnitAddAbility2(Caster,'A0ZJ')//A0ZJ -> Feral Heart Caster lvl 1
		call SaveUnitHandle(HY,(GetHandleId(Hero)),219,(Caster))
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerAddCondition(t,Condition(function CXF))
		call TriggerRegisterTimerEvent(t,.2,true)
		call SaveUnitHandle(HY,h,2,(Hero))
		call SaveUnitHandle(HY,h,19,(Caster))
		set t=null
	else
		set Caster=(LoadUnitHandle(HY,(GetHandleId(Hero)),219))
	endif
	if Level==2 then
		call UnitRemoveAbility(Caster,'A0ZJ')//A0ZJ -> Feral Heart Caster lvl 1
		call UnitAddAbility2(Caster,'A0ZI')//A0ZI -> Feral Heart Caster lvl 2
		call UnitRemoveAbility(Hero,'B09B')//B09B -> Feral Impulse|n|cff4F4F4FLevel:|r 1
	elseif Level==3 then
		call UnitRemoveAbility(Caster,'A0ZJ')//A0ZJ -> Feral Heart Caster lvl 1
		call UnitRemoveAbility(Caster,'A0ZI')//A0ZI -> Feral Heart Caster lvl 2
		call UnitRemoveAbility(Hero,'B09A')//B09A -> Feral Impulse|n|cff4F4F4FLevel:|r 2
		call UnitRemoveAbility(Hero,'B09B')//B09B -> Feral Impulse|n|cff4F4F4FLevel:|r 1
		call UnitAddAbility2(Caster,'A0ZH')//A0ZH -> Feral Heart Caster lvl 3
	elseif Level==4 then
		call UnitRemoveAbility(Caster,'A0ZJ')//A0ZJ -> Feral Heart Caster lvl 1
		call UnitRemoveAbility(Caster,'A0ZI')//A0ZI -> Feral Heart Caster lvl 2
		call UnitRemoveAbility(Caster,'A0ZH')//A0ZH -> Feral Heart Caster lvl 3
		call UnitRemoveAbility(Hero,'B097')//B097 -> Feral Impulse|n|cff4F4F4FLevel:|r 3
		call UnitRemoveAbility(Hero,'B09A')//B09A -> Feral Impulse|n|cff4F4F4FLevel:|r 2
		call UnitRemoveAbility(Hero,'B09B')//B09B -> Feral Impulse|n|cff4F4F4FLevel:|r 1
		call UnitAddAbility2(Caster,'A0ZG')//A0ZG -> Feral Heart Caster lvl 4
	endif
	set Hero=null
	set Caster=null
endfunction

function SummonWolvesEntering takes unit u returns nothing
	local integer i=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A0A8')
	if i>0 then
		call UnitAddAbility3(u,'A3IP',i)
		call UnitAddAbility3(u,'A3IQ',i)
	endif
endfunction

function Lycan_Howl takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Caster
	local integer i=1
	local player p
	local integer id1
	local integer id2
	local integer Level=GetUnitAbilityLevel(Hero,'A0ZF')//A0ZF -> Howl
	if Level==1 then
		set id1='A104'//A104 -> Howl Caster - Heroes - 1
		set id2='A107'//A107 -> Howl Caster - Creep - 1
	elseif Level==2 then
		set id1='A101'//A101 -> Howl Caster - Heroes - 2
		set id2='A106'//A106 -> Howl Caster - Creep - 2
	elseif Level==3 then
		set id1='A102'//A102 -> Howl Caster - Heroes - 3
		set id2='A105'//A105 -> Howl Caster - Creep - 3
	elseif Level==4 then
		set id1='A103'//A103 -> Howl Caster - Heroes - 4
		set id2='A108'//A108 -> Howl Caster - Creep - 4
	endif
	loop
		exitwhen i>5
		if IsSentinel(GetOwningPlayer(Hero)) then
			set p=Sentinels[i]
		else
			set p=Scourges[i]
		endif
		set Caster=CreateUnit(p,'e01V',0,0,0)//e01V -> Spellcaster #3
		call UnitAddAbility2(Caster,id1)
		call UnitAddAbility2(Caster,id2)
		call UnitApplyTimedLife(Caster,'BTLF',10)
		set i=i+1
	endloop
	set Hero=null
	set Caster=null
endfunction

function Doom_LvlDeath takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer tl=GetHeroLevel(Target)
	local integer lvl=GetUnitAbilityLevel(Source,'A094')
	local real dmg=75+50*lvl
	if (IsUnitType(Source,UNIT_TYPE_HERO) or HaveSavedHandle(HY,GetHandleId(Source),0)) and (ModuloInteger(tl,7-lvl)==0 or tl==25) then//A094 -> LVL? Death
		set dmg=dmg+GetUnitState(Target,UNIT_STATE_MAX_LIFE)*.2
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Demon\\DemonBoltImpact\\DemonBoltImpact.mdl",Target,"chest"))
	endif
	call DamageTarget(Source,Target,1,dmg)
	call StunFor001(Target)
	set Source=null
	set Target=null
endfunction

function BasicDoomDmgPer takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit doom=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	if GetUnitAbilityLevel(target,'A464')==0 or IsDead(target) then
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	else
		call DamageTarget(doom,target,7,LoadReal(HY,h,0))
	endif
	if LoadBoolean(HY,h,0)then
		call RemoveSavedBoolean(HY,h,0)
		call TimerStart(t,1,true,function BasicDoomDmgPer)
	endif
	set doom=null
	set target=null
	set t=null
endfunction

function BasicDoomDmg takes unit u, unit target returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0,false,function BasicDoomDmgPer)
	call SaveUnitHandle(HY,h,0,u)
	call SaveUnitHandle(HY,h,1,target)
	call SaveReal(HY,h,0,GetUnitAbilityLevel(u,'A0MU')*25.+5.)//A0MU -> Doom
	call SaveBoolean(HY,h,0,true)
	set t=null
endfunction

function BasicDoom takes nothing returns nothing
	local unit doom=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local unit d
	if IsUnitType(target,UNIT_TYPE_HERO)then
		call UnitAddAbilityTimedExF(target,'A464',1,15,'B464')//B464 -> Doom
		call STFU(target,'B464',15)//B464 -> Doom
		call BasicDoomDmg(doom,target)
		
	else
		set d=CreateUnit(GetOwningPlayer(doom),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
		call UnitAddAbility(d,'A465')
		call SetUnitAbilityLevel(d,'A465',GetUnitAbilityLevel(doom,'A0MU'))//A0MU -> Doom
		call IssueTargetOrder(d,"doom",target)
		set d=null
	endif
	if IsUnitChannelsSomething(target)then
		call IssueImmediateOrderById(target,851972)
	endif
	set doom=null
	set target=null
	set d=null
endfunction

function Doom_DoomCast takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call RemovePositiveBuffs(GetSpellTargetUnit())
	//	call UnitRemoveBuffsEx(GetSpellTargetUnit(),true,false,true,true,false,false,false)
		call BasicDoom()
	endif
endfunction

function DoomUltiTargetFilter takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetOrderTargetUnit()
	if IsUnitType(target,UNIT_TYPE_ANCIENT) and IsSpiritBear(target)==false then
		call InterruptUnit(caster)
		call Error(GetOwningPlayer(caster),GetObjectName('n0K9'))
	endif
	set caster=null
	set target=null
endfunction

function Devour_Refresh_Wrap takes nothing returns nothing
	local unit u=tt_unit1
	local integer hu=GetHandleId(u)
	local integer id1=LoadInteger(HeroStats,hu,'DEVR'+0)
	local integer id2=LoadInteger(HeroStats,hu,'DEVR'+1)
	local boolean isbook1=LoadBoolean(HeroStats,hu,'DEVR'+0)
	local boolean isbook2=LoadBoolean(HeroStats,hu,'DEVR'+1)
	if isbook1==false then
		call UnitRemoveAbility(u,id1)
		call UnitAddAbility2(u,id1)
	endif
	if isbook2==false then
		call UnitRemoveAbility(u,id2)
		call UnitAddAbility2(u,id2)
	endif
	set u=null
endfunction

function Devour_Clear takes unit u returns nothing
	call UnitRemoveAbility(u,LoadInteger(HeroStats,GetHandleId(u),'DEVR'+0))
	call UnitRemoveAbility(u,LoadInteger(HeroStats,GetHandleId(u),'DEVR'+1))
	call RemoveSavedInteger(HeroStats,GetHandleId(u),'DEVR'+0)
	call RemoveSavedInteger(HeroStats,GetHandleId(u),'DEVR'+1)
	call RemoveSavedBoolean(HeroStats,GetHandleId(u),'DEVR'+0)
	call RemoveSavedBoolean(HeroStats,GetHandleId(u),'DEVR'+1)
endfunction

function C5F takes unit u,integer uid returns nothing
	local integer id1=0
	local integer id2=0
	local boolean isbook1=false
	local boolean isbook2=false
	local integer subskill1=0
	local integer subskill2=0
	local integer hu=GetHandleId(u)
	if uid=='n0HX' then//n0HX -> Harpy Storm
		set id1='A1OQ'//A1OQ -> Chain Lightning
	elseif uid=='nomg' then//nomg -> Ogre Magi
		set id1='A1OR'//A1OR -> Frost Armor
	elseif uid=='nfpu' then//nfpu -> Polar Furbolg Ursa Warrior
		set id1='A1OS'//A1OS -> Thunder Clap
		set id2='QDP3'
		set isbook2=true
		set subskill2='S00N'//S00N -> Endurance Aura
	elseif uid=='nstl' then//nstl -> Satyr Soulstealer
		set id1='A1OT'//A1OT -> Mana Burn
	elseif uid=='nsat' then//nsat -> Satyr Trickster
		set id1='A1OU'//A1OU -> Purge
	elseif uid=='nsth' then//big satyr//nsth -> Satyr Hellcaller
		set id1='A1OV'//A1OV -> Shockwave
		set id2='QDP0'
		set isbook2=true
		set subskill2='A1OW'//A1OW -> Unholy Aura
	elseif uid=='n00S' then//n00S -> Alpha Wolf
		set id1='QDP6'
		set subskill1='A1OX'//A1OX -> Command Aura
		set isbook1=true
		set subskill2='A1OY'//A1OY -> Critical Strike
	elseif uid=='nkol' then//nkol -> Kobold Taskmaster
		set id1='QDP1'
		set subskill1='S00M'//S00M -> Speed Aura
		set isbook1=true
	elseif uid=='nfsh' then//nfsh -> Forest Troll High Priest
		set id1='A1OZ'//A1OZ -> Heal
		set id2='QDP2'
		set subskill2='A2AG'//A2AG -> Brilliance Aura
		set isbook2=true
	elseif uid=='ncnk' then//ncnk -> Centaur Khan
		set id1='A1P0'//A1P0 -> War Stomp
	elseif uid=='ngns' then//ngns -> Gnoll Assassin
		set id1='QDP4'
		set subskill1='A1P1'//A1P1 -> Envenomed Weapons
		set isbook1=true
	elseif uid=='ngh1' then//ngh1 -> Ghost
		set id1='QDP7'
		set subskill1='A1P7'//A1P7 -> Frost Attack (Lucy)
		set isbook1=true
		set subskill2='A1PA'//A1PA -> Frost Attack
	elseif uid=='nowe' then//nowe -> Enraged Wildkin
		set id1='QDP5'
		set subskill1='A1P3'//A1P3 -> Toughness Aura
		set isbook1=true
		set id2='A1P4'//A1P4 -> Tornado
	elseif uid=='ndtw' then//ndtw -> Dark Troll Warlord
		set id1='A1P5'//A1P5 -> Raise Dead
		set id2='A1P6'//A1P6 -> Ensnare
	elseif uid=='nwlg' then//nwlg -> Giant Wolf
		set id1='QDP8'
		set subskill1='A1OY'//A1OY -> Critical Strike
		set isbook1=true
	elseif uid=='n026' then
		set id1='A36K'
		set id2='A36J'
	elseif uid=='n127' then
		set id1='A36K'
	endif
	if id1!=0 and (LoadInteger(HeroStats,hu,'DEVR'+0)!=id1 or LoadInteger(HeroStats,hu,'DEVR'+1)!=id2) then
		call Devour_Clear(u)
		call UnitAddAbility2(u,id1)
		if isbook1 then
			call SetPlayerAbilityAvailable(GetOwningPlayer(u),id1,false)
			call UnitMakeAbilityPermanent(u,true,subskill1)
			call UnitMakeAbilityPermanent(u,true,subskill2)
		endif
		if id2!=0 then
			call UnitAddAbility2(u,id2)
			if isbook2 then
				call SetPlayerAbilityAvailable(GetOwningPlayer(u),id2,false)
				call UnitMakeAbilityPermanent(u,true,subskill1)
				call UnitMakeAbilityPermanent(u,true,subskill2)
			endif
		endif
		call SaveInteger(HeroStats,hu,'DEVR'+0,id1)
		call SaveBoolean(HeroStats,hu,'DEVR'+0,isbook1)
		call SaveInteger(HeroStats,hu,'DEVR'+1,id2)
		call SaveBoolean(HeroStats,hu,'DEVR'+1,isbook2)
	endif
endfunction

function L8F takes real r returns string
	local string c1="|c00ff0303"
	local string c="||"
	local string p=" "
	local string s=c1+c+"|r"
	local string result
	if r>85 then
		set result=s+p+s+p+s+p+s+p+s+p+s+p+s
	elseif r>70 then
		set result=s+p+s+p+s+p+s+p+s+p+s+p+c
	elseif r>55 then
		set result=s+p+s+p+s+p+s+p+s+p+c+p+c
	elseif r>40 then
		set result=s+p+s+p+s+p+s+p+c+p+c+p+c
	elseif r>25 then
		set result=s+p+s+p+s+p+c+p+c+p+c+p+c
	elseif r>10 then
		set result=s+p+s+p+c+p+c+p+c+p+c+p+c
	elseif r>0 then
		set result=s+p+c+p+c+p+c+p+c+p+c+p+c
	else
		set result=c+p+c+p+c+p+c+p+c+p+c+p+c
	endif
	return result
endfunction

function LDF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer Level=(LoadInteger(HY,h,5))
	local real HP=(LoadReal(HY,h,232))
	local texttag tt=(LoadTextTagHandle(HY,h,231))
	local integer Count=GetTriggerEvalCount(t)
	local real LFF=RMaxIF(HP-Count,0)
	call SetTextTagText(tt,L8F(100*LFF/ HP),.018)
	call SetTextTagPosUnit(tt,Hero,0)
	call SetTextTagVisibility(tt,IsUnitVisibleLoD(Hero,GetLocalPlayer()) or IsObserver(GetLocalPlayer()))
	if LFF==0 then
		call ImitateBountyGain(GetOwningPlayer(Hero),Hero,25*Level)
	endif
	if LFF==0 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A10R',true)//A10R -> Devour
		call UnitRemoveAbility(Hero,'A10S')//A10S -> Devour
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call DestroyTextTag(tt)
	endif
	set t=null
	set Hero=null
	set tt=null
	return false
endfunction

function Doom_Devour takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(Hero,'A10R')//A10R -> Devour
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real HP=GetWidgetLife(Target)
	local texttag tt=CreateTextTag()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',0,0,0)//e00E -> Spellcaster
	call ZO8("SPLK",GetUnitX(Hero),GetUnitY(Hero),GetUnitX(Target),GetUnitY(Target),.1,.1,.2,.9,.5)
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\Devour\\DevourEffectArt.mdl",GetUnitX(Target),GetUnitY(Target)))
	call SetTextTagText(tt,L8F(100),.018)
	call SetTextTagPosUnit(tt,Hero,0)
	call SetTextTagVisibility(tt,IsUnitVisibleLoD(Hero,GetLocalPlayer()))
	call SetTextTagPermanent(tt,true)
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A10R',false)//A10R -> Devour
	call UnitAddAbility2(Hero,'A10S')//A10S -> Devour
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveTextTagHandle(HY,h,231,(tt))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,232,((HP)*1.))
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerRegisterDeathEvent(t,Hero)
	call TriggerAddCondition(t,Condition(function LDF))
	call C5F(Hero,GetUnitTypeId(Target))
	if IsUnitType(Target,UNIT_TYPE_SUMMONED)==false then
		call UnitRemoveBuffs(Target,true,true)
	endif
	call UnitRemoveAbility(Target,'Aetl')//Aetl -> Ethereal
	call DamageTarget(Caster,Target,4,100000000)
	call ShowUnit(Target,false)
	set t=null
	set Hero=null
	set Target=null
	set tt=null
	set Caster=null
endfunction

function Doom_Devour_Leveling takes nothing returns nothing
	call UnitAddAbility2(GetTriggerUnit(),'A10R')//A10R -> Devour
	call SetUnitAbilityLevel(GetTriggerUnit(),'A10R',GetUnitAbilityLevel(GetTriggerUnit(),'A32Z'))//A10R -> Devour, A32Z -> Devour
endfunction

function LNF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=LoadInteger(HY,h,3)
	local integer bookabil
	local integer fireabil
	local integer regenabil
	if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if Level==1 then
			set fireabil='A1OE'//A1OE -> Scorched Earth Damage - 1
			set regenabil='A1OJ'//A1OJ -> Scorched Earth MS + Regen - Level 1
		elseif Level==2 then
			set fireabil='A1OF'//A1OF -> Scorched Earth Damage - 2
			set regenabil='A1OH'//A1OH -> Scorched Earth MS + Regen - Level 2
		elseif Level==3 then
			set fireabil='A1OG'//A1OG -> Scorched Earth Damage - 3
			set regenabil='A1OK'//A1OK -> Scorched Earth MS + Regen - Level 3
		elseif Level==4 then
			set fireabil='A1OD'//A1OD -> Scorched Earth Damage - 4
			set regenabil='A1OF'//A1OF -> Scorched Earth Damage - 2
		endif
		call SetUnitAbilityLevel(Source,fireabil,1)
		call UnitMakeAbilityPermanent(Source,true,fireabil)
		call SetUnitAbilityLevel(Source,regenabil,1)
		call UnitMakeAbilityPermanent(Source,true,regenabil)
	else
		if LoadInteger(HY,h,0)<1 then
			call UnitRemoveAbility(Source,'A1OL')//A1OL -> Scorched Earth Container - 1
			call UnitRemoveAbility(Source,'A1ON')//A1ON -> Scorched Earth Container - 2
			call UnitRemoveAbility(Source,'A1OO')//A1OO -> Scorched Earth Container - 3
			call UnitRemoveAbility(Source,'A1OM')//A1OM -> Scorched Earth Container - 4
			call UnitRemoveAbility(Source,'B04J')//B04J -> Scorched Earth
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call RemoveSavedHandle(HY,GetHandleId(Source),'SCRD')
		else
			call SaveInteger(HY,h,0,LoadInteger(HY,h,0)-1)
		endif
   endif
	set t=null
	set Source=null
	return false
endfunction

function Doom_ScorchedEarth takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t
	local integer h
	local integer Level=GetUnitAbilityLevel(Source,'A1OP')//A1OP -> Scorched Earth
	local integer aid=0
	local integer subaid1=0
	local integer subaid2=0
	if Level==1 then
		set aid='A1OL'//A1OL -> Scorched Earth Container - 1
		set subaid1='A1OE'//A1OE -> Scorched Earth Damage - 1
		set subaid2='A1OJ'//A1OJ -> Scorched Earth MS + Regen - Level 1
	elseif Level==2 then
		set aid='A1ON'//A1ON -> Scorched Earth Container - 2
		set subaid1='A1OF'//A1OF -> Scorched Earth Damage - 2
		set subaid2='A1OH'//A1OH -> Scorched Earth MS + Regen - Level 2
	elseif Level==3 then
		set aid='A1OO'//A1OO -> Scorched Earth Container - 3
		set subaid1='A1OG'//A1OG -> Scorched Earth Damage - 3
		set subaid2='A1OK'//A1OK -> Scorched Earth MS + Regen - Level 3
	elseif Level==4 then
		set aid='A1OM'//A1OM -> Scorched Earth Container - 4
		set subaid1='A1OD'//A1OD -> Scorched Earth Damage - 4
		set subaid2='A0FF'//A0FF -> Scorched Earth MS + Regen - Level 4
	endif
	if HaveSavedHandle(HY,GetHandleId(Source),'SCRD') then
		set t=LoadTriggerHandle(HY,GetHandleId(Source),'SCRD')
		set h=GetHandleId(t)
		call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
		if LoadInteger(HY,h,3)!=Level then
			call UnitRemoveAbility(Source,'A1OL')//A1OL -> Scorched Earth Container - 1
			call UnitRemoveAbility(Source,'A1ON')//A1ON -> Scorched Earth Container - 2
			call UnitRemoveAbility(Source,'A1OO')//A1OO -> Scorched Earth Container - 3
			call UnitRemoveAbility(Source,'A1OM')//A1OM -> Scorched Earth Container - 4
			call UnitRemoveAbility(Source,'B04J')//B04J -> Scorched Earth
			call SaveInteger(HY,h,3,Level)
		endif
		call TriggerRegisterTimerEvent(t,6+2*Level,false)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,6+2*Level,false)
		call TriggerRegisterDeathEvent(t,Source)
		call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
		call TriggerAddCondition(t,Condition(function LNF))
		call SaveUnitHandle(HY,h,2,Source)
		call SaveInteger(HY,h,3,Level)
		call SaveTriggerHandle(HY,GetHandleId(Source),'SCRD',t)
	endif
	call UnitAddAbility2(Source,aid)
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),aid,false)
	call UnitMakeAbilityPermanent(Source,true,subaid1)
	call UnitMakeAbilityPermanent(Source,true,subaid2)
	call UnitMakeAbilityPermanent(Source,true,'A33I')
	set Source=null
	set t=null
endfunction

function Doom_AghanimDoom_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,2)
	local unit target=LoadUnitHandle(HY,h,17)
	local integer time=LoadInteger(HY,h,34)
	if DistanceBetweenUnits(caster,target)>900 or IsDead(caster) then
		set time=time+1
		call SaveInteger(HY,h,34,time)
	endif
	if ModuloInteger(GetTriggerEvalCount(t),10)==1 then
		call DamageTarget(caster,target,7,LoadReal(HY,h,5))
	endif
	if time>160 or (GetUnitAbilityLevel(target,'BNdo')==0 and GetTriggerEvalCount(t)>2) then//BNdo -> Doom
		call UnitRemoveAbility(target,'BNdo')//BNdo -> Doom
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set caster=null
	set target=null
	return false
endfunction

function Doom_AghanimDoom_Act takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
	call UnitRemoveAbility(target,'A464')
	call UnitRemoveAbility(target,'B464')//B464 -> Doom
	call UnitRemoveAbility(target,'BNdo')//BNdo -> Doom
	//call UnitRemoveBuffs(target,true,false)
	call RemovePositiveBuffs(GetSpellTargetUnit())
//	call UnitRemoveBuffsEx(GetSpellTargetUnit(),true,false,true,true,false,false,false)
	call TriggerRegisterTimerEvent(t,0.1,true)
	call TriggerAddCondition(t,Condition(function Doom_AghanimDoom_Duration))
	call SaveUnitHandle(HY,(h),2,(u))
	call SaveUnitHandle(HY,(h),17,(target))
	call SaveInteger(HY,(h),34,0)
	call SaveReal(HY,h,5,20+30*GetUnitAbilityLevel(u,'A0A2'))//A0A2 -> Doom
	call UnitAddAbility(d,'A466')
	call SetUnitAbilityLevel(d,'A466',GetUnitAbilityLevel(u,'A0A2'))//A0A2 -> Doom
	call IssueTargetOrder(d,"doom",target)
	set d=null
	set u=null
	set target=null
	set t=null
endfunction

function DoomAghActStart takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Doom_AghanimDoom_Act()
	endif
endfunction

//function Doom_AghanimDoom_Act takes nothing returns nothing
//	local unit caster=GetTriggerUnit()
//	local unit target=GetSpellTargetUnit()
//	local trigger t=CreateTrigger()
//	local integer h=GetHandleId(t)
//	call TriggerRegisterTimerEvent(t,0.1,true)
//	call TriggerAddCondition(t,Condition(function Doom_AghanimDoom_Duration))
//	call SaveUnitHandle(HY,h,2,caster)
//	call SaveUnitHandle(HY,h,17,target)
//	call SaveInteger(HY,h,34,0)
//	call RemovePositiveBuffs(GetSpellTargetUnit())
//	call UnitRemoveBuffsEx(GetSpellTargetUnit(),true,false,true,true,false,false,false)
//	set caster=null
//	set target=null
//	set t=null
//endfunction

function LQF takes nothing returns boolean
	local real x
	local real y
	if(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))) and GetFilterUnit()!=Roshan then
		set x=JP8+GetRandomReal(20,70)*Cos(GetUnitFacing(GetTriggerUnit())*bj_DEGTORAD)
		set y=JQ8+GetRandomReal(20,70)*Sin(GetUnitFacing(GetTriggerUnit())*bj_DEGTORAD)
		call SetUnitPosition(GetFilterUnit(),x,y)
	endif
	return false
endfunction

function Magnus_ReversePolarity takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local group g=GetAvailableGroup()
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',x,y,0)//e00E -> Spellcaster
	local integer lvl=GetUnitAbilityLevel(u,'A29L')+GetUnitAbilityLevel(u,'A447')//A29L -> Reverse Polarity, A447 -> Reverse Polarity
	local real a=GetUnitFacing(u)
	set JP8=GetUnitX(u)+100*Cos(a*bj_DEGTORAD)
	set JQ8=GetUnitY(u)+100*Sin(a*bj_DEGTORAD)
	call GroupEnumUnitsInRange(g,x,y,410+24,Condition(function LQF))
	call KillGroup(g)
	call UnitAddAbility2(d,'A06F')//A06F -> Reverse Polarity
	call SetUnitAbilityLevel(d,'A06F',lvl)//A06F -> Reverse Polarity
	call IssueImmediateOrderById(d,852127)
	if GetUnitAbilityLevel(u,'A447')>0 then//A447 -> Reverse Polarity
		call UnitAddAbility2(d,'A446')
		call SetUnitAbilityLevel(d,'A446',lvl)
		call IssuePointOrderById(d,852218,x+100*Cos((a+15)*bj_DEGTORAD),y+100*Sin((a+15)*bj_DEGTORAD))
		call IssuePointOrderById(d,852218,x+100*Cos((a-15)*bj_DEGTORAD),y+100*Sin((a-15)*bj_DEGTORAD))
		call IssuePointOrderById(d,852218,x+100*Cos(a*bj_DEGTORAD),y+100*Sin(a*bj_DEGTORAD))
	endif
	set u=null
	set g=null
	set d=null
endfunction

function LTF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	if GetUnitAbilityLevel(Target,'B00U')==0 or GetTriggerEventId()==EVENT_WIDGET_DEATH then//B00U -> Empower
		call UnitRemoveAbility(Target,'A1Q0')//A1Q0 -> Empower Cleave Container 1
		call UnitRemoveAbility(Target,'A1Q1')//A1Q1 -> Empower Cleave Container 2
		call UnitRemoveAbility(Target,'A1Q2')//A1Q2 -> Empower Cleave Container 3
		call UnitRemoveAbility(Target,'A1Q3')//A1Q3 -> Empower Cleave Container 4
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	return false
endfunction

function Magnus_Empower takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A037')//A037 -> Empower
	local integer A38
	local integer realID
	if Level==1 then
		set A38='A1Q0'//A1Q0 -> Empower Cleave Container 1
		set realID='A1PZ'//A1PZ -> Empower Cleave 1
	elseif Level==2 then
		set A38='A1Q1'//A1Q1 -> Empower Cleave Container 2
		set realID='A1PI'//A1PI -> Empower Cleave 2
	elseif Level==3 then
		set A38='A1Q2'//A1Q2 -> Empower Cleave Container 3
		set realID='A1PY'//A1PY -> Empower Cleave 3
	elseif Level==4 then
		set A38='A1Q3'//A1Q3 -> Empower Cleave Container 4
		set realID='A1PX'//A1PX -> Empower Cleave 4
	endif
	call UnitRemoveAbility(Target,'A1Q0')//A1Q0 -> Empower Cleave Container 1
	call UnitRemoveAbility(Target,'A1Q1')//A1Q1 -> Empower Cleave Container 2
	call UnitRemoveAbility(Target,'A1Q2')//A1Q2 -> Empower Cleave Container 3
	call UnitRemoveAbility(Target,'A1Q3')//A1Q3 -> Empower Cleave Container 4
	call UnitAddAbilityTimedExF(Target,A38,1,40,0)
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),A38,false)
	call UnitMakeAbilityPermanent(Target,true,realID)
	set Source=null
	set Target=null
endfunction

function Magnus_Shockwave takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetUnitFacing(GetTriggerUnit()))
	call UnitAddAbility(d,'A3IH')
	call SetUnitAbilityLevel(d,'A3IH',GetUnitAbilityLevel(GetTriggerUnit(),'A02S'))
	if GetSpellTargetUnit()==GetTriggerUnit() then
		call DummyWave(d,"carrionswarm",GetUnitX(GetTriggerUnit())+1*Cos(bj_DEGTORAD*GetUnitFacing(GetTriggerUnit())),GetUnitY(GetTriggerUnit())+1*Sin(bj_DEGTORAD*GetUnitFacing(GetTriggerUnit())))
	else
		call DummyWave(d,"carrionswarm",GetSpellTargetX(),GetSpellTargetY())
	endif
	//call IssuePointOrder(d,"carrionswarm",GetSpellTargetX(),GetSpellTargetY())
	set d=null
endfunction

function LWF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	call UnitRemoveAbility(Target,'A1Q6')//A1Q6 -> Skewer Maim
	call UnitRemoveAbility(Target,'B0CX')//B0CX -> Skewer
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Target=null
	return false
endfunction

function LXF takes unit Source,unit Target,integer Level returns nothing
	call UnitAddAbilityTimedExF(Target,'A1Q5',1,2.5,'B0CX')
	call DamageTarget(Source,Target,1,70*Level)
endfunction

function Magnus_Skewer_Filter takes nothing returns boolean
	return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit())) and IsUnitIdType(GetUnitTypeId(GetFilterUnit()),UNIT_TYPE_HERO) and IsUnitInGroup(GetFilterUnit(),TempGroup)==false and Roshan!=GetFilterUnit())!=null
endfunction

function Magnus_Skewer_Moving takes nothing returns nothing
	call SetUnitPosition(GetEnumUnit(),Skewer_x,Skewer_y)
	call SaveBoolean(HeroStats,GetHandleId(GetEnumUnit()),99,true)
	call SetUnitPathing(GetEnumUnit(),false)
endfunction

function Magnus_Skewer_Finish takes nothing returns nothing
	local unit u=GetEnumUnit()
	local location l
	local real x
	local real y
	if IsPointInRegion(RestrictedRegion,GetUnitX(u),GetUnitY(u)) then
		set l=LI8(GetUnitX(u),GetUnitY(u))
		set x=SafeX75(GetLocationX(l))
		set y=SafeY75(GetLocationY(l))
		call SaveBoolean(HeroStats,GetHandleId(u),99,true)
		call SetUnitX(u,x)
		call SetUnitY(u,y)
		call RemoveLocation(l)
		set l=null
	endif
	call SetUnitPathing(u,true)
	call LXF(Skewer_Caster,u,Skewer_lvl)
	call KillTrees(GetUnitX(u),GetUnitY(u),300)
	set u=null
endfunction

function LYF takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=(LoadInteger(HY,h,5))
	local real TargetX=(LoadReal(HY,h,47))
	local real TargetY=(LoadReal(HY,h,48))
	local real a=(LoadReal(HY,h,13))
	local real NHE=(LoadReal(HY,h,6))
	local real NIE=(LoadReal(HY,h,7))
	local real AO8=SafeX75(NHE+19*Cos(a))
	local real AP8=SafeY75(NIE+19*Sin(a))
	local group g
	local group gg=LoadGroupHandle(HY,h,0)
	local integer L3F=(LoadInteger(HY,h,12))
	local location l
	if IsUnitType(Source,UNIT_TYPE_HERO)then
		call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
	endif
	call SetUnitPosition(Source,AO8,AP8)
	call SetUnitFacing(Source,a*bj_RADTODEG)
	call SaveReal(HY,h,6,((AO8)*1.))
	call SaveReal(HY,h,7,((AP8)*1.))
	if ModuloInteger(GetTriggerEvalCount(t),4)==0 then
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",AO8,AP8))
	endif
	if GetTriggerEvalCount(t)==2 then
		call SetUnitAnimationByIndex(Source,3)
	endif
	set g=GetAvailableGroup()
	set tt_unit1=Source
	set TempGroup=gg
	call GroupEnumUnitsInRange(g,AO8,AP8,150+25,Condition(function Magnus_Skewer_Filter))
	if FirstOfGroup(g)!=null then
		call GroupAddGroup(g,gg)
	endif
	call KillGroup(g)
	set Skewer_x=AO8
	set Skewer_y=AP8
	call ForGroup(gg,function Magnus_Skewer_Moving)
	if ModuloInteger(GetTriggerEvalCount(t),3)==0 then
		call KillTrees(AO8,AP8,200)
	endif
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)>L3F then
		call DestroyEffect((LoadEffectHandle(HY,h,175)))
		call SetUnitAnimationByIndex(Source,0)
		call SetUnitTimeScale(Source,1.)
		call SetUnitPathing(Source,true)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		set Skewer_lvl=Level
		set Skewer_Caster=Source
		call IssueTargetOrderById(Source,ORDER_attack,FirstOfGroup(gg))
		call ForGroup(gg,function Magnus_Skewer_Finish)
		call KillTrees(AO8,AP8,375)
		if IsPointInRegion(RestrictedRegion,GetUnitX(Source),GetUnitY(Source)) then
			set l=LI8(GetUnitX(Source),GetUnitY(Source))
			if IsUnitType(Source,UNIT_TYPE_HERO)then
				call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
			endif
			call SetUnitX(Source,SafeX75(GetLocationX(l)))
			call SetUnitY(Source,SafeY75(GetLocationY(l)))
			call RemoveLocation(l)
			set l=null
		endif
	endif
	set t=null
	set Source=null
	call KillGroup(gg)
	call KillGroup(g)
	set g=null
	set gg=null
	return false
endfunction

function Magnus_Skewer takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real TargetX=SafeX75(GetSpellTargetX())
	local real TargetY=SafeY75(GetSpellTargetY())
	local unit Source=GetTriggerUnit()
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local integer Level=GetUnitAbilityLevel(Source,'A1RD')//A1RD -> Skewer
	local real a=AngleBetweenXY(SourceX,SourceY,TargetX,TargetY)*bj_DEGTORAD
	local real range = Level*150 + 625
	if DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)>range then
		set TargetX=SafeX75(SourceX + range*Cos(a))
		set TargetY=SafeY75(SourceY + range*Sin(a))
	endif
	call SetUnitPathing(Source,false)
	call SetUnitAnimationByIndex(Source,3)
	call SetUnitTimeScale(Source,1.5)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function LYF))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,5,(Level))
	call SaveUnitHandle(HY,h,393,(null))
	call SaveUnitHandle(HY,h,394,(null))
	call SaveUnitHandle(HY,h,395,(null))
	call SaveUnitHandle(HY,h,396,(null))
	call SaveUnitHandle(HY,h,397,(null))
	call SaveReal(HY,h,47,((TargetX)*1.))
	call SaveReal(HY,h,48,((TargetY)*1.))
	call SaveReal(HY,h,6,((SourceX)*1.))
	call SaveReal(HY,h,7,((SourceY)*1.))
	call SaveGroupHandle(HY,h,0,GetAvailableGroup())
	call SaveReal(HY,h,13,((Atan2(TargetY-SourceY,TargetX-SourceX))*1.))
	call SaveInteger(HY,h,12,(R2I(DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)/ 19.)))
	call SaveEffectHandle(HY,h,175,(AddSpecialEffectTarget("war3mapImported\\SkewerTuskGlow_1.mdx",Source,"head")))
	set t=null
	set Source=null
endfunction

function L0F takes nothing returns boolean
	local real d
	if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(JS8)) and IsUnitInGroup(GetFilterUnit(),JU8)==false and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(JT8)) then//
		set d=DistanceBetweenXY(GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()),GetUnitX(JS8),GetUnitY(JS8))
		if d<JV8 then
			set JR8=GetFilterUnit()
			set JV8=d
		endif
	endif
	return false
endfunction

function L5F takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local integer Level=(LoadInteger(HY,h,5))
	local unit Target=LoadUnitHandle(HY,h,30)
	local group AlreadyHit=(LoadGroupHandle(HY,h,187))
	local real L2F=(LoadReal(HY,h,222))
	local real D4G=(LoadReal(HY,h,223))
	local real D7G=(LoadReal(HY,h,224))
	local real RLD
	local group g
	local real a
	local real x
	local real y
	local boolean b=false
	set a=Atan2(GetUnitY(Target)-GetUnitY(Caster),GetUnitX(Target)-GetUnitX(Caster))
	if Source==Target then
		set x=GetUnitX(Caster)+25*Cos(a)
		set y=GetUnitY(Caster)+25*Sin(a)
	else
		set x=GetUnitX(Caster)+24*Cos(a)
		set y=GetUnitY(Caster)+24*Sin(a)
	endif
	call SetUnitX(Caster,x)
	call SetUnitY(Caster,y)
	if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<60 then
		call SetUnitX(Caster,GetUnitX(Target))
		call SetUnitY(Caster,GetUnitY(Target))
		if Source==Target then
			call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+L2F)
			call KillUnit(Caster)
			call KillGroup(AlreadyHit)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		else
			if IsUnitVisibleLoD(Target,GetOwningPlayer(Caster)) then
				set b=IsBlocked(Target)
				if b==false then
					if GetUnitAbilityLevel(Target,'A2S5')>0 then //if stoned
						call DamageTarget(Source,Target,3,(.35*D7G+1.)*(40+40*Level))
					else
						call DamageTarget(Source,Target,1,(.35*D7G+1.)*(40+40*Level))
					endif
					set D7G=D7G+1
					if GetUnitState(Target,UNIT_STATE_MANA)>0 then
						set RLD=RMinBJ(GetUnitState(Target,UNIT_STATE_MANA),(.35*D4G+1.)*(5+15*Level))
						call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-RLD)
						call PlaySoundAtPos(NE,GetUnitX(Target),GetUnitY(Target))
						set L2F=L2F+RLD
						set D4G=D4G+1
					endif
				else
					call RemoveLinkenBuff(Target)
				endif
			endif
			call SaveReal(HY,h,222,((L2F)*1.))
			call SaveReal(HY,h,224,((D7G)*1.))
			call SaveReal(HY,h,223,((D4G)*1.))
			set g=GetAvailableGroup()
			set JR8=null
			set JS8=Target
			set JU8=AlreadyHit
			set JV8=99999
			set JT8=Source
			call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),500,Condition(function L0F))
			call KillGroup(g)
			if JR8==null or D7G==(2+Level) or b then
				call SaveUnitHandle(HY,h,30,((Source)))
			else
				call SaveUnitHandle(HY,h,30,((JR8)))
				call GroupAddUnit(AlreadyHit,JR8)
			endif
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set Caster=null
	set g=null
	set AlreadyHit=null
	return false
endfunction

function Medusa_MysticSnake takes unit Source, unit Target, integer Level returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local group g=GetAvailableGroup()
	local real D7G=0
	local real D4G=0
	local real RLD=0
	local real L2F=0
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'h090',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))//h090 -> Mystic Snake
	call PlaySoundAtPos(ME,GetUnitX(Source),GetUnitY(Source))
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function L5F))
	call SaveGroupHandle(HY,h,187,(g))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveInteger(HY,h,5,(Level))
	call SaveUnitHandle(HY,h,30,((Target)))
	call SaveInteger(HY,h,34,0)
	call SaveReal(HY,h,222,((L2F)*1.))
	call SaveReal(HY,h,224,((D7G)*1.))
	call SaveReal(HY,h,223,((D4G)*1.))
	call GroupAddUnit(g,Target)
	set Caster=null
	set t=null
endfunction

function Medusa_MysticSnakeStart takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A0G2')//A0G2 -> Mystic Snake
	if GetUnitAbilityLevel(caster,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(caster),0) then//Aloc -> Locust
		set caster=LoadUnitHandle(HY,GetHandleId(caster),0)
	endif
	if IsBlocked(target)==false then
		call Medusa_MysticSnake(caster,target,lvl)
	endif
	
	set caster=null
	set target=null
endfunction

function Medusa_SplitShot_Learn takes nothing returns nothing
	
endfunction

function Medusa_SplitShotOff takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer i=GetUnitAbilityLevel(u,'A418')//A418 -> Splitshot
	call UnitRemoveAbility(u,'A09J')//A09J -> Split Shot
	call UnitRemoveAbility(u,'A1ER')//A1ER -> Split Shot Reduction Level 4
	call UnitRemoveAbility(u,'A23F')//A23F -> Split Shot Spell Book
	call UnitRemoveAbility(u,'A417')
	call UnitRemoveAbility(u,'A419')
	call SetUnitAbilityLevel(u,'A1C0',i)//A1C0 -> Splitshot
	set u=null
	call PhaseBootsRemoveImmolation(GetTriggerUnit())
endfunction

function Medusa_SplitShot takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A1C0')//A1C0 -> Splitshot
	call UnitAddAbility2(u,'A417')
	call SetUnitAbilityLevel(u,'A417',lvl)
	call UnitAddAbility2(u,'A23F')//A23F -> Split Shot Spell Book
	call SetUnitAbilityLevel(u,'A09J',lvl)//A09J -> Split Shot
	call UnitMakeAbilityPermanent(u,true,'A09J')//A09J -> Split Shot
	call UnitAddAbility2(u,'A1ER')//A1ER -> Split Shot Reduction Level 4
	call SetUnitAbilityLevel(u,'A1ER',lvl)//A1ER -> Split Shot Reduction Level 4
	call UnitAddAbility2(u,'A419')
	set u=null
	call PhaseBootsRemoveImmolation(GetTriggerUnit())
endfunction

function Medusa_StoneGaze_NullTimers takes nothing returns nothing
	local unit u=GetEnumUnit()
	call SaveReal(HY,GetHandleId(u),799,0.0)
	set u=null
endfunction

function Medusa_StoneGaze_RemoveSlow takes nothing returns nothing
	local unit u=GetEnumUnit()
	call UnitRemoveAbility(u,'A2S3')
	call UnitRemoveAbility(u,'A2TM')
	call UnitRemoveAbility(u,'B0BQ')//B0BQ -> Stone Gaze
	call SetUnitTurnSpeed(u,GetUnitDefaultTurnSpeed(u))
	set u=null
endfunction

function Medusa_StoneGaze_DamageAmplify takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,2)
	local unit victim=LoadUnitHandle(HY,h,17)
	local integer lvl=LoadInteger(HY,h,0)
	local real ampl=LoadReal(HY,h,0)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if LoadBoolean(HY,h,0)==false then
			call SaveBoolean(HY,h,0,true)
			call DamageTarget(GetEventDamageSource(),GetTriggerUnit(),7,GetEventDamage()*ampl)
//			call echo(R2S(GetEventDamage()*ampl))
			call SaveBoolean(HY,h,0,false)
		endif
	else
		//call SaveReal(HY,GetHandleId(victim),'AMPL',RMaxIF(LoadReal(HY,GetHandleId(victim),'AMPL')-ampl,0))
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveAbility(victim,'A2S1')
		call UnitRemoveAbility(victim,'A2TL')
	endif
	set t=null
	set u=null
	set victim=null
	return false
endfunction

function Medusa_StoneGaze_Paralize takes unit u,unit victim, integer lvl returns nothing
	local trigger t
	local integer h
	local unit dummy
	local real ampl
	if IsUnitIllusion(victim) then
		call KillUnit(victim)
		return
	endif
	set t=CreateTrigger()
	set h=GetHandleId(t)
	set dummy=CreateUnit(GetOwningPlayer(victim),'e00E',GetUnitX(victim),GetUnitY(victim),0)//e00E -> Spellcaster
	call UnitAddAbility(dummy,'A2S4')
	call IssueTargetOrder(dummy,"thunderbolt",victim)
	call TriggerRegisterDeathEvent(t,victim)
	call TriggerRegisterUnitEvent(t,victim,EVENT_UNIT_DAMAGED)
	call TriggerRegisterTimerEvent(t,3,false)
	call TriggerAddCondition(t,Condition(function Medusa_StoneGaze_DamageAmplify))
	call SaveUnitHandle(HY,h,2,u)
	call SaveUnitHandle(HY,h,17,victim)
	call SaveInteger(HY,h,0,lvl)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\EtherealForm\\SpiritWalkerChange.mdl",victim,"chest"))
	set ampl=0.2+0.1*lvl
//	call SaveReal(HY,GetHandleId(victim),'AMPL',LoadReal(HY,GetHandleId(victim),'AMPL')+ampl)
	call SaveReal(HY,h,0,ampl)
	call UnitAddAbility2(victim,'A2S1')
	call UnitAddAbility2(victim,'A2TL')
	call SetPlayerAbilityAvailable(GetOwningPlayer(victim),'A2S1',false)
	set t=null
	set dummy=null
endfunction

function Medusa_StoneGaze_Targets takes nothing returns nothing
	local unit u=GetEnumUnit()
	call SaveReal(HY,GetHandleId(u),799,(LoadReal(HY,GetHandleId(u),799)+0.02)*1.0)
	if GetUnitAbilityLevel(u,'A2S3')==0 then
		call UnitAddAbility2(u,'A2S3')
		call UnitAddAbility2(u,'A2TM')
		call SetUnitTurnSpeed(u,GetUnitDefaultTurnSpeed(u)*0.5)
	endif
	if(LoadReal(HY,GetHandleId(u),799))==2.0 then
		call Medusa_StoneGaze_Paralize(Medusa_StoneGaze_TempUnit,u,tt_int1)
	endif
	set u=null
endfunction

function Medusa_StoneGaze_CheckAngle takes unit u,unit victim returns boolean
	local real angle=AngleBetweenUnits(victim,u)
	local real face=GetUnitFacing(victim)
	local real fixface
	local real doubleFace
	local real limit1st=-1.0
	local real limit1st2=-1.0
	local real copyface
	local real fixcopyface
	local real limit2nd=-1.0
	local real limit2nd2=-1.0
	set fixface=RMaxBJ(face-85,0)
	set doubleFace=face
	if face-85<=0 then
		set limit1st=360-(85-(doubleFace-fixface))
		set limit1st2=360
	endif
	set copyface=face
	set fixcopyface=RMinBJ(face+85,360)
	if face+85>=360 then
		set limit2nd=0
		set limit2nd2=0+(85-(fixcopyface-copyface))
	endif
	if angle<0 then
		set angle=angle+360
	elseif angle>360 then
		set angle=angle-360
	endif
	if(angle>fixface and angle<doubleFace)or(limit1st!=-1 and angle>limit1st and angle<limit1st2)or(angle>copyface and angle<fixcopyface)or(limit2nd!=-1 and angle>limit2nd and angle<limit2nd2)then
		return true
	endif
	return false
endfunction

function Medusa_StoneGaze_Filter takes nothing returns boolean
	return DefaultEnemyFilterWithAncients() and Medusa_StoneGaze_CheckAngle(tt_unit1,GetFilterUnit())
endfunction

function Medusa_StoneGaze_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,2)
	local integer lvl=LoadInteger(HY,h,0)
	local group g=GetAvailableGroup()
	local group gg=GetAvailableGroup()
	local group ag=LoadGroupHandle(HY,h,187)
	set Medusa_StoneGaze_TempUnit=caster
	set tt_unit1=caster
	set tt_int1=lvl
	call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),1025,Condition(function Medusa_StoneGaze_Filter))
	call ForGroup(g,function Medusa_StoneGaze_Targets)
	call GroupAddGroup(g,ag)
	call GroupAddGroup(ag,gg)
	call GroupRemoveGroup(g,gg)
	call KillGroup(g)
	call KillGroup(gg)
	call DestroyEffect(LoadEffectHandle(HY,h,32))
	if GetTriggerEvalCount(t)>R2I(6/0.02)then
		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)
		call ForGroup(ag,function Medusa_StoneGaze_RemoveSlow)
		call ForGroup(ag,function Medusa_StoneGaze_NullTimers)
		call KillGroup(ag)
	else
		call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\EtherealForm\\SpiritWalkerChange.mdl",caster,"chest"))
	endif
	set caster=null
	set g=null
	set gg=null
	set ag=null
	set t=null
	return false
endfunction

function Medusa_StoneGaze_Start takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.02,true)
	call TriggerRegisterTimerEvent(t,0.0,false)
	call TriggerAddCondition(t,Condition(function Medusa_StoneGaze_Duration))
	call SaveUnitHandle(HY,h,2,GetTriggerUnit())
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\EtherealForm\\SpiritWalkerChange.mdl",GetTriggerUnit(),"chest"))
	call SaveGroupHandle(HY,h,187,GetAvailableGroup())
	set t=null
endfunction

function DKG takes integer loc_integer01,unit loc_unit01,unit loc_unit02 returns nothing
	if loc_integer01==0 then
		call IssueTargetOrder(loc_unit01,"attack",loc_unit02)
	endif
	if GetUnitAbilityLevel(loc_unit02,'A3EC')==1 and IsMagicImmune(loc_unit02)==false then
		if loc_integer01<3 then
			call UnitAddAbilityTimedExF(loc_unit02,'A3ED',1,1.,'B3ED')//B3ED -> Open Wounds
		elseif loc_integer01==3 then
			call UnitAddAbilityTimedExF(loc_unit02,'A3EE',1,1.,'B3EE')//B3EE -> Open Wounds
		elseif loc_integer01==4 then
			call UnitAddAbilityTimedExF(loc_unit02,'A3EF',1,1.,'B3EF')//B3EF -> Open Wounds
		elseif loc_integer01==5 then
			call UnitAddAbilityTimedExF(loc_unit02,'A3EG',1,1.,'B3EG')//B3EG -> Open Wounds
		else
			call UnitAddAbilityTimedExF(loc_unit02,'A3EH',1,1.,'B3EH')//B3EH -> Open Wounds
		endif
	endif
endfunction

function DMG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Level=(LoadInteger(HY,h,5))
	local integer Count=(LoadInteger(HY,h,34))
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=LoadUnitHandle(HY,h,30)
	local real VUE=0.5
	local unit u=GetEventDamageSource()
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		set Count=Count+1
		call DKG(Count,Source,Target)
		if Count==9 then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		else
			call SaveInteger(HY,h,34,(Count))
		endif
	elseif IsDamageReal(GetEventDamage())and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(u))and IsUnitType(u,UNIT_TYPE_STRUCTURE)==false then
		if IsUnitType(u,UNIT_TYPE_HERO)or GetUnitAbilityLevel(u,'A04R')==0 then//
			call SetWidgetLife(u,GetWidgetLife(u)+GetEventDamage()*VUE)
		else
			set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
			call SetWidgetLife(u,GetWidgetLife(u)+GetEventDamage()*VUE)
		endif
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\VampiricAura\\VampiricAuraTarget.mdl",u,"origin"))
	endif
	set t=null
	set Source=null
	set Target=null
	set u=null
	return false
endfunction

function DNG takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call DKG(0,Source,Target)
	call UnitAddAbility2(Target,'A3EC')
	call SaveInteger(HY,h,375,0)
	call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Source,'A194')))//A194 -> Open Wounds
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,30,Target)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterTimerEvent(t,.01,false)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function DMG))
	set t=null
	set Source=null
	set Target=null
endfunction

function Lifestealer_OpenWounds takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call DNG()
	endif
endfunction

function Lifestealer_OpenWounds_Preload takes nothing returns nothing
	call AddToPurgeList('A3EC',PURGEDEBUFFID)//open wounds
	call AddToPurgeList('A3ED',PURGEDEBUFFID)
	call AddToPurgeList('A3EE',PURGEDEBUFFID)
	call AddToPurgeList('A3EF',PURGEDEBUFFID)
	call AddToPurgeList('A3EG',PURGEDEBUFFID)
	call AddToPurgeList('A3EH',PURGEDEBUFFID)
	call AddToPurgeList('B3ED',PURGEDEBUFFID)//B3ED -> Open Wounds
	call AddToPurgeList('B3EE',PURGEDEBUFFID)//B3EE -> Open Wounds
	call AddToPurgeList('B3EF',PURGEDEBUFFID)//B3EF -> Open Wounds
	call AddToPurgeList('B3EG',PURGEDEBUFFID)//B3EG -> Open Wounds
	call AddToPurgeList('B3EH',PURGEDEBUFFID)//B3EH -> Open Wounds
endfunction

function DPG takes nothing returns nothing
	local unit Source=JZ8
	local unit Target=GetEnumUnit()
	local integer Level=JA8
	local trigger t=AddProjectile(Source,Target,'h0DF',"DQG",600,false)//h0DF -> Infest Projectile
	local integer h=GetHandleId(t)
	call SaveReal(HY,h,20,((Level*125+25)*1.))
	set Source=null
	set Target=null
	set t=null
endfunction

function DRG takes unit Source,unit Target,integer Level returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	set JZ8=Source
	set JA8=Level
	call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),725,Condition(function DefaultEnemyFilter))
	call ForGroup(g,function DPG)
	call KillGroup(g)
	set g=null
endfunction

function DSG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local integer Level=(LoadInteger(HY,h,5))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call UnitShareVision(Target,GetOwningPlayer(Hero),false)
		call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HumanLargeDeathExplode\\HumanLargeDeathExplode.mdl",GetUnitX(Target),GetUnitY(Target)))
		call SetUnitPosition(Hero,GetUnitX(Target),GetUnitY(Target))
		//call PauseUnit(Hero,false)
		call ShowUnit(Hero,true)
		call SetUnitPathing(Hero,true)
		call ClearSelectionForPlayer(GetOwningPlayer(Hero))
		call SelectUnitForPlayerSingle(Hero,GetOwningPlayer(Hero))
		call SetUnitInvulnerable(Hero,false)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call DestroyEffect((LoadEffectHandle(HY,h,177)))
		call RemoveUnit(Caster)
		call UnitRemoveAbility(Hero,'A3L7')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call DRG(Hero,Target,Level)
		call SaveInteger(HY,(GetHandleId((Hero))),(4310),2)
	elseif IsUnitType(Target,UNIT_TYPE_HERO) and IsUnitEnemy(Target,GetOwningPlayer(Hero)) then
		call UnitShareVision(Target,GetOwningPlayer(Hero),false)
		call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HumanLargeDeathExplode\\HumanLargeDeathExplode.mdl",GetUnitX(Target),GetUnitY(Target)))
		call SetUnitPosition(Hero,GetUnitX(Target),GetUnitY(Target))
		//call PauseUnit(Hero,false)
		call ShowUnit(Hero,true)
		call UnitRemoveAbility(Hero,'A3L7')
		call SetUnitPathing(Hero,true)
		call ClearSelectionForPlayer(GetOwningPlayer(Hero))
		call SelectUnitForPlayerSingle(Hero,GetOwningPlayer(Hero))
		call SetUnitInvulnerable(Hero,false)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call DestroyEffect((LoadEffectHandle(HY,h,177)))
		call RemoveUnit(Caster)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call DRG(Hero,Target,Level)
		call SaveInteger(HY,(GetHandleId((Hero))),(4310),2)
	elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT or (GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER and GetIssuedOrderId()==852129) then
		if GetSpellAbilityId()=='A0SX' or GetSpellAbilityId()=='A459' or GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then//A0SX -> Consume, A459 -> Consume
			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HumanLargeDeathExplode\\HumanLargeDeathExplode.mdl",GetUnitX(Target),GetUnitY(Target)))
			if IsUnitEnemy(Target,GetOwningPlayer(Hero))then
				call SetWidgetLife(Hero,GetWidgetLife(Hero)+GetWidgetLife(Target))
			endif
			call UnitShareVision(Target,GetOwningPlayer(Hero),false)
			call SetUnitPosition(Hero,GetUnitX(Target),GetUnitY(Target))
			//call PauseUnit(Hero,false)
			call ShowUnit(Hero,true)
			call UnitRemoveAbility(Hero,'A3L7')
			call SetUnitPathing(Hero,true)
			call SetUnitAnimation(Hero,"Stand Victory")
			call BF8(Hero,1.5)
			call ClearSelectionForPlayer(GetOwningPlayer(Hero))
			call SelectUnitForPlayerSingle(Hero,GetOwningPlayer(Hero))
			call SetUnitInvulnerable(Hero,false)
			call DestroyEffect((LoadEffectHandle(HY,h,32)))
			call DestroyEffect((LoadEffectHandle(HY,h,177)))
			call RemoveUnit(Caster)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call DRG(Hero,Target,Level)
			if IsUnitType(Target,UNIT_TYPE_HERO)==false then
				if IsUnitType(Target,UNIT_TYPE_SUMMONED)==false then
					call UnitRemoveBuffs(Target,true,true)
				endif
				call DamageTarget(Hero,Target,1,100000)
				call DamageTarget(Hero,Target,2,100000)
				call DamageTarget(Hero,Target,3,100000)
			endif
			call SaveInteger(HY,(GetHandleId((Hero))),(4310),2)
		elseif GetSpellAbilityId()=='A44H' then//A44H -> Infest Take Control
			call SetUnitOwner(Target,GetOwningPlayer(Hero),false)
			call UnitRefillMana(Target)
			if LoadBoolean(HY,h,123)==false then
				call SaveBoolean(HY,h,123,true)
				call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
				if GetUnitTypeId(Target)=='ncnk' or GetUnitTypeId(Target)=='nowe' then//ncnk -> Centaur Khan, nowe -> Enraged Wildkin
					call UnitAddAbility2(Target,'A459')//A459 -> Consume
				else
					call UnitAddAbility2(Target,'A0SX')//A0SX -> Consume
				endif
			endif
			call SetUnitMoveSpeed(Target,GetUnitMoveSpeed(Hero))
			call ClearSelectionForPlayer(GetOwningPlayer(Hero))
			call SelectUnitAddForPlayer(Target,GetOwningPlayer(Hero)) 
		endif
	elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SELECTED and GetTriggerUnit()==Target and GetOwningPlayer(Target)!=GetOwningPlayer(Hero) then
		call ClearSelectionForPlayer(GetOwningPlayer(Hero))
		call SelectUnitAddForPlayer(Caster,GetOwningPlayer(Hero))
	else
		if GetOwningPlayer(Target)==GetOwningPlayer(Hero) then
			call SetUnitMoveSpeed(Target,GetUnitMoveSpeed(Hero))
		endif
		call SetUnitPosition(Hero,GetUnitX(Target),GetUnitY(Target))
	endif
	set t=null
	set Target=null
	set Hero=null
	set Caster=null
	return false
endfunction

function Lifestealer_Infest takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e010',7260,-7732,0)//e010 -> Consume
	local string DUG="Objects\\Spawnmodels\\Naga\\NagaBlood\\NagaBloodWindserpent.mdl"
	local string DVG="Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBase.mdl"
	local string DWG="Abilities\\Spells\\Other\\Aneu\\AneuTarget.mdl"
	if IsPlayerEnemy(GetLocalPlayer(),GetOwningPlayer(Hero))and IsObserver(GetLocalPlayer())==false then
		set DUG=""
		set DVG=""
		set DWG=""
	endif
	call PurgingTriggered(Hero,false)
	if IsUnitType(Hero,UNIT_TYPE_SUMMONED)==false then
		call UnitRemoveBuffs(Hero,true,true)
	endif
	call SetUnitInvulnerable(Caster,true)
	call UnitAddAbility2(Caster,'A0SX')//A0SX -> Consume
	if IsUnitType(Target,UNIT_TYPE_HERO)==false and GetOwningPlayer(Target)!=GetOwningPlayer(Hero) then
		call UnitAddAbility2(Caster,'A44H')//A44H -> Infest Take Control
	endif
	call ClearSelectionForPlayer(GetOwningPlayer(Hero))
	if GetOwningPlayer(Target)==GetOwningPlayer(Hero) then
		if GetUnitTypeId(Target)=='ncnk' or GetUnitTypeId(Target)=='nowe' then//ncnk -> Centaur Khan, nowe -> Enraged Wildkin
			call UnitAddAbility2(Target,'A459')//A459 -> Consume
		else
			call UnitAddAbility2(Target,'A0SX')//A0SX -> Consume
		endif
		call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
		call SelectUnitForPlayerSingle(Target,GetOwningPlayer(Hero))
	else
		call SelectUnitForPlayerSingle(Caster,GetOwningPlayer(Hero))
	endif
	
	
	call UnitShareVision(Target,GetOwningPlayer(Hero),true)
	call SetUnitInvulnerable(Hero,true)
	call ShowUnit(Hero,false)
	//call PauseUnit(Hero,true)
	call UnitAddAbility2(Hero,'A3L7')
	call SetUnitPathing(Hero,false)
	call DestroyEffect(AddSpecialEffectTarget(DUG,Target,"overhead"))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget(DVG,Target,"overhead")))
	call SaveEffectHandle(HY,h,177,(AddSpecialEffectTarget(DWG,Target,"overhead")))
	call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Hero,'A0SW')))//A0SW -> Infest
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterPlayerUnitEvent(t,GetOwningPlayer(Hero),EVENT_PLAYER_UNIT_SELECTED,Condition(function ReturnTrue))
	call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_ISSUED_ORDER)
	call TriggerRegisterTimerEvent(t,.2,true)
	call TriggerAddCondition(t,Condition(function DSG))
	call SaveInteger(HY,GetHandleId(Hero),4310,1)
	set t=null
	set Hero=null
	set Target=null
	set Caster=null
endfunction

function Lifestealer_Infest_OnCast takes nothing returns nothing
	if IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) and (IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) or IsUnitIllusion(GetSpellTargetUnit()) or IsCourier(GetSpellTargetUnit()) or GetSpellTargetUnit()==Roshan or IsSpiritBear(GetSpellTargetUnit())) then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0LV'))//n0LV -> Cannot target this unit
	endif
endfunction

function DZG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	call RestoreTint(Hero)
	//call DestroyEffect(LoadEffectHandle(HY,h,175))
	//call DestroyEffect(LoadEffectHandle(HY,h,176))
	call UnitRemoveAbility(Hero,'A0SR')//A0SR -> Rage Attack Speed
	call UnitRemoveAbility(Hero,'A0ST')//A0ST -> Magic Immunity Container
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	return false
endfunction

function Lifestealer_Rage takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Hero,'A0T2')//A0T2 -> Rage
	local integer i=0
	//call SetUnitVertexColor(Hero,0,0,0,255)
	call SetTint(Hero,0,0,0,-1)
	call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A0ST',false)//A0ST -> Magic Immunity Container
	call UnitAddAbility2(Hero,'A0ST')//A0ST -> Magic Immunity Container
	call UnitAddAbility2(Hero,'A0SR')//A0SR -> Rage Attack Speed
	call SetUnitAbilityLevel(Hero,'A0SR',Level)//A0SR -> Rage Attack Speed
	call PurgingTriggered(Hero,false)
	call PurgingTriggeredSpellImmune(Hero)
	call SaveUnitHandle(HY,h,14,Hero)
	//call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Bloodlust\\BloodlustTarget.mdl",Hero,"right hand"))
	//call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Bloodlust\\BloodlustTarget.mdl",Hero,"left hand"))
	call TriggerRegisterTimerEvent(t,2+Level,false)
	call TriggerAddCondition(t,Condition(function DZG))
	set Hero=null
	set t=null
endfunction

function FeastCondition takes nothing returns boolean
	return IsUnitEnemy(UDSG_Attacker,GetOwningPlayer(UDSG_Target)) and (GetUnitAbilityLevel(UDSG_Attacker,'A0SS')>0)and GetUnitTypeId(UDSG_Target)!='n00L' and GetUnitTypeId(UDSG_Target)!='n0F5' and IsFamiliarId(GetUnitTypeId(UDSG_Target))==false and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 and IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(UDSG_Target,'A04R')==0//A0SS -> Feast, QP1W -> Feast, n00L -> Roshan, n0F5 -> Living Dead, 
endfunction

function Lifestealer_Feast_Act takes unit Source,unit Target returns nothing
	local integer Level=GetUnitAbilityLevel(Source,'A0SS')//A0SS -> Feast, QP1W -> Feast
	local real Damage
//	local unit u=LoadUnitHandle(HeroStats,GetHandleId(Source),'DUMM')
//	if u==null or IsDead(u) then
//		set u=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
//	endif
	if(not(Mode_BO))and(IsUnitType(Source,UNIT_TYPE_RANGED_ATTACKER))then
		set Damage=(.0175+.01*Level)*GetWidgetLife(Target)
	else
		set Damage=(.03+.01*Level)*GetWidgetLife(Target)
	endif
	//call DamageTarget(Source,Target,2,Damage)
	call SetWidgetLife(Source,Damage+GetWidgetLife(Source))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\VampiricAura\\VampiricAuraTarget.mdl",Source,"origin"))
//	set u=null
endfunction

function Lifestealer_Feast_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer h = GetHandleId(t)
	call LoDStat_Sub(LoadUnitHandle(MHT,h,0),LoadInteger(MHT,h,0),"damage")
	call RemoveSavedHandle(MHT,GetHandleId(LoadUnitHandle(MHT,h,0)),'A0SS')//A0SS -> Feast
	call FlushChildHashtable(MHT,h)
	call DestroyTimer(t)
	set t = null
endfunction

function Lifestealer_Feast_Start takes unit u, unit target, integer lvl returns nothing
	local timer t
	local integer h
	local integer d
	local real r=GetWidgetLife(target)
	local boolean b=HaveSavedHandle(MHT,GetHandleId(u),'A0SS')//A0SS -> Feast
	if b then
		set t=LoadTimerHandle(MHT,GetHandleId(u),'A0SS')//A0SS -> Feast
		set h=GetHandleId(t)
	else
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveTimerHandle(MHT,GetHandleId(u),'A0SS',t)//A0SS -> Feast
		call SaveUnitHandle(MHT,h,0,u)
	endif
	call TimerStart(t,2,false,function Lifestealer_Feast_End)
	if(not(Mode_BO))and(IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER))then
		set d=R2I((.0175+.01*lvl)*r)
	else
		set d=R2I((.03+.01*lvl)*r)
	endif
	if b then
		if d!=LoadInteger(MHT,h,0) then
			call LoDStat_Modify(u,d-LoadInteger(MHT,h,0),"damage")
		endif
	else
		call LoDStat_Add(u,d,"damage")
	endif
	call SaveInteger(MHT,h,0,d)
	call SaveUnitHandle(MHT,h,0,u)
	set t = null
endfunction

function Necrolyte_Heartstopper_ForGroup takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local real hp=GetWidgetLife(Target)-1
	local real maxhp=GetUnitState(Target,UNIT_STATE_MAX_LIFE)
	local real dmg=0.003*Necrolyte_Heartstopper_Lvl*maxhp/2
	call DamageTarget(Necrolyte_Heartstopper_Caster,Target,11,dmg)
	set Target=null
endfunction

function Necrolyte_Heartstopper_Filter takes nothing returns boolean
	return DefaultEnemyFilter() and GetUnitAbilityLevel(GetFilterUnit(),'B084')>0//B084 -> Heartstopper Aura
endfunction

function Necrolyte_Heartstopper_Tick takes nothing returns nothing
	local integer h=GetHandleId(GetExpiredTimer())
	local unit Source=LoadUnitHandle(HY,h,2)
	local group g
	if IsDead(Source)==false and GetUnitAbilityLevel(Source,'A36D')==0 then
		set g=GetAvailableGroup()
		set Necrolyte_Heartstopper_Caster=Source
		set Necrolyte_Heartstopper_Lvl=GetUnitAbilityLevel(Source,'P302')+1 //A01N
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1225,Condition(function Necrolyte_Heartstopper_Filter))
		call ForGroup(g,function Necrolyte_Heartstopper_ForGroup)
		call KillGroup(g)
	endif
	set g=null
	set Source=null
endfunction

function Necrolyte_Heartstopper_Learn takes nothing returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,.5,true,function Necrolyte_Heartstopper_Tick)
	call SaveUnitHandle(HY,GetHandleId(t),2,GetTriggerUnit())
	set t=null
endfunction

function Sadist_Dur takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local unit u = LoadUnitHandle(MHT,info,0)
	local integer c=LoadInteger(MHT,info,2)+1
	if IsDead(u) or c>6*10 then
		call Timer_End(t)
	else
		call SetWidgetLife(u,GetWidgetLife(u)+LoadInteger(MHT,info,0)*0.1)
		call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+LoadInteger(MHT,info,1)*0.1)
		call SaveInteger(MHT,info,2,c)
	endif
	set t = null
	set u = null
endfunction

function Sadist_Start takes unit u, integer level, boolean b returns nothing
	local timer t = CreateTimer()
	local integer info = GetHandleId(t)
	local integer mp=2*level
	local integer hp=level
	if level==4 then
		set mp=12
		set hp=6
	endif
	if b then
		set mp=mp*10
		set hp=hp*10
	endif
	call Buff_Add(u,'C012','D012',6)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"origin"))
	call SaveUnitHandle(MHT,info,0,u)
	call SaveInteger(MHT,info,0,hp)
	call SaveInteger(MHT,info,1,mp)
	call TimerStart(t,0.1,true,function Sadist_Dur)
	set t = null
endfunction

function Sadist_Condition takes unit killer, unit victim returns nothing
	local unit u 
	local integer level
	if IsUnitIllusion(victim) or GetUnitTypeId(victim)=='u00S' then//u00S -> Power Cog
		set u=null
		return
	endif
	if LoadInteger(HY,GetHandleId(victim),4333)==1 then
		set u=udg_Hero[GetPlayerId(LoadPlayerHandle(HY,GetHandleId(victim),4333))]
	elseif GetUnitAbilityLevel(killer,'Aloc')==1 then//Aloc -> Locust
		set u=udg_Hero[GetPlayerId(GetOwningPlayer(killer))]
	else
		set u=killer
	endif
	set level=GetUnitAbilityLevel(u,'P303')
	if level > 0 and IsDead(u)==false and GetUnitAbilityLevel(u,'A36D')==0 then
		call Sadist_Start(u,level,IsUnitType(victim,UNIT_TYPE_HERO))
	endif
	set u = null
endfunction


function DQG takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit Source=tt_unit1
	local unit Target=tt_unit2
	local real Damage=(LoadReal(HY,h,20))
	local real DJF=(LoadReal(HY,h,21))
	if IsUnitAlly(Target,GetOwningPlayer(Source))then
		call SetWidgetLife(Target,GetWidgetLife(Target)+DJF)
	else
		call DamageTarget(Source,Target,1,Damage)
	endif
	set Source=null
	set Target=null
endfunction

function EGG takes nothing returns nothing
	local trigger t=AddProjectile(tt_unit1,GetEnumUnit(),'h00W',"DQG",400,false)//h00W -> Necrolyte Projectile
	local integer h=GetHandleId(t)
	call SaveReal(HY,h,20,((tt_real1)*1.))
	call SaveReal(HY,h,21,((TJ)*1.))
	set t=null
endfunction

function EHG takes nothing returns nothing
	if IsUnitVisibleLoD(GetEnumUnit(),GetOwningPlayer(tt_unit1))or (IsUnitFogged(GetEnumUnit(),GetOwningPlayer(tt_unit1)) and GenericCondition_IsDotAInvis(GetEnumUnit())==false)then
		call EGG()
	endif
endfunction

function Necrolyte_DeathPulse takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local integer Level=GetUnitAbilityLevel(Hero,'A05V')//A05V -> Death Pulse
	local real r = 500
	local real Damage
	if Level==1 then
		set Damage=125
	elseif Level==2 then
		set Damage=175
	elseif Level==3 then
		set Damage=225
	elseif Level==4 then
		set Damage=275
	endif
	set tt_unit1=Hero
	set tt_real1=Damage
	set TJ=50 + 20*Level
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),r,Condition(function DH9))
	call GroupRemoveUnit(g,Hero)
	call ForGroup(g,function EHG)
	call KillGroup(g)
	call SetWidgetLife(Hero,GetWidgetLife(Hero)+TJ)
	set Hero=null
	set g=null
endfunction

function EKG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real VUE=(LoadReal(HY,h,680))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AnimateDead\\AnimateDeadTarget.mdl",Target,"origin"))
	call DamageTarget(Source,Target,1,VUE*(GetUnitState(Target,UNIT_STATE_MAX_LIFE)-GetWidgetLife(Target)))
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function EMG takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer ENG=GetUnitAbilityLevel(Source,'A067')//A067 -> Reaper's Scythe
	local integer EOG=GetUnitAbilityLevel(Source,'A08P')//A08P -> Reaper's Scythe
	local real VUE
	if GetUnitAbilityLevel(Source,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(Source),0) then//Aloc -> Locust
		set Source=LoadUnitHandle(HY,GetHandleId(Source),0)
	endif
	if ENG==1 then
		set VUE=.4
	elseif ENG==2 or EOG==1 then
		set VUE=.6
	elseif ENG==3 or EOG==2 then
		set VUE=.9
	elseif EOG==3 then
		set VUE=1.2
	endif
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveReal(HY,h,680,((VUE)*1.))
	call TriggerRegisterTimerEvent(t,1.,false)
	call TriggerAddCondition(t,Condition(function EKG))
	call AddTimedKeyToUnit(Target,4333,1.5)
	call SavePlayerHandle(HY,GetHandleId(Target),4333,GetOwningPlayer(Source))
	if EOG>0 then
		call AddTimedKeyToUnit(Target,4418,1.51)
	endif
	set t=null
	set Source=null
	set Target=null
endfunction

function Necrolyte_ReapersScythe takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call EMG()
	endif
endfunction

function NA_Impale takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real x1=GetUnitX(Hero)
	local real y1=GetUnitY(Hero)
	local real a
	local real x2
	local real y2
	local integer Level=GetUnitAbilityLevel(Hero,'A0X7')//A0X7 -> Impale
	local real Damage
	local real DP9
	local unit D09=null
	if GetSpellTargetUnit()!=null then
		set x2=GetUnitX(GetSpellTargetUnit())
		set y2=GetUnitY(GetSpellTargetUnit())
	else
		set x2=GetSpellTargetX()
		set y2=GetSpellTargetY()
	endif
	set a=Atan2(y2-y1,x2-x1)
	set x2=x1+700*Cos(a)
	set y2=y1+700*Sin(a)
	if Level==1 then
		set Damage=80
		set DP9=.75
	elseif Level==2 then
		set Damage=140
		set DP9=1.25
	elseif Level==3 then
		set Damage=200
		set DP9=1.75
	elseif Level==4 then
		set Damage=260
		set DP9=2.25
	endif
	if GetSpellTargetUnit()!=null and IsBlocked(GetSpellTargetUnit())then
		set D09=GetSpellTargetUnit()
	endif
	call ImpaleFactory(Hero,D09,Damage,DP9,.52,x1,y1,x2,y2,150,null,true,1600)
	set Hero=null
	set D09=null
endfunction

function ESG takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local real r=GetHeroInt(Target,true)*(3+0.5*GetUnitAbilityLevel(Source,'A1H5'))//A1H5 -> Mana Burn
	local integer M7E=IMinBJ(R2I(r),R2I(GetUnitState(Target,UNIT_STATE_MANA)))
	call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-M7E)
	call DamageTarget(Source,Target,1,M7E)
	call CR8("MBUR",Source,Target,1,1,1,1,.5)
	call TextTagOnUnit("-"+I2S(M7E),3,Target,.023,82,82,255,255)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\ManaBurn\\ManaBurnTarget.mdl",Target,"chest"))
	set Source=null
	set Target=null
endfunction

function NA_Manaburn takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call ESG()
	endif
endfunction

function Spiked_Carapace_End takes trigger trig, unit u, integer info returns nothing
	//call Buff_Remove(u,'D008')
	call RemoveSavedHandle(HY,GetHandleId(u),'A2KO')
	call DestroyEffect(LoadEffectHandle(HY,info,3))
	call DestroyEffect(LoadEffectHandle(HY,info,4))
	call DestroyEffect(LoadEffectHandle(HY,info,5))
	call DestroyEffect(LoadEffectHandle(HY,info,6))
	call KillGroup(LoadGroupHandle(HY,info,7))
	call FlushChildHashtable(HY,info)
	call CleanTrigger(trig)
endfunction

function A94 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamage()>0 and IsPlayerEnemy(GetOwningPlayer(GetEventDamageSource()),GetOwningPlayer(Source)) and IsRealDamage and IsUnitInGroup(udg_Hero[GetPlayerId(GetOwningPlayer(GetEventDamageSource()))],LoadGroupHandle(HY,h,7))==false then
			if IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource()))and IsDamageReal(GetEventDamage())then
				call HealUnitFor(Source,GetEventDamage())
				if GetUnitAbilityLevel(GetEventDamageSource(),'A04R')>0 or GetUnitAbilityLevel(GetEventDamageSource(),'Aloc')>0 then//, Aloc -> Locust
					set Target=udg_Hero[GetPlayerId(GetOwningPlayer(GetEventDamageSource()))]
				else
					set Target=GetEventDamageSource()
				endif
				call GroupAddUnit(LoadGroupHandle(HY,h,7),Target)
				if IsDead(Target)==false then
					call StunTargetLoD(Target,0.6*LoadInteger(HY,h,0))
					call DamageTarget(Source,Target,3,GetEventDamage())
				endif
			endif
		endif
	elseif LoadInteger(HY,h,1)==0 then
		call Spiked_Carapace_End(t,Source,h)
	else
		call SaveInteger(HY,h,1,LoadInteger(HY,h,1))
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function NA_SpikedCarapace takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t
	local integer h
	if HaveSavedHandle(HY,GetHandleId(Source),'A2KO') then
		set t=LoadTriggerHandle(HY,GetHandleId(Source),'A2KO')
		set h=GetHandleId(t)
		call GroupClear(LoadGroupHandle(HY,h,7))
		call TriggerRegisterTimerEvent(t,2.25,false)
		call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+1)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,2.25,false)
		call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(t,Condition(function A94))
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
		//call Buff_Add(Source,'C008','D008',2.75)
		call SaveGroupHandle(HY,h,7,GetAvailableGroup())
		call SaveEffectHandle(HY,h,3,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ThornyShield\\ThornyShieldTargetChestLeft.mdl",Source,"chest,left"))
		call SaveEffectHandle(HY,h,4,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ThornyShield\\ThornyShieldTargetChestRight.mdl",Source,"chest,right"))
		call SaveEffectHandle(HY,h,5,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ThornyShield\\ThornyShieldTargetChestMountLeft.mdl",Source,"mount,left"))
		call SaveEffectHandle(HY,h,6,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ThornyShield\\ThornyShieldTargetChestMountRight.mdl",Source,"mount,right"))
		call SaveTriggerHandle(HY,GetHandleId(Source),'A2KO',t)
	endif
	set Source=null
	set t=null
endfunction

function EXG takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit Source=tt_unit2
	local unit Target=tt_unit1
	local integer EYG
	local integer EZG
	local integer Level
	if GetUnitAbilityLevel(Source,'A04R')!=0 then//
		set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
	endif
	set EYG=GetUnitAbilityLevel(Source,'A0CQ')//A0CQ -> Necromastery Effect
	set Level=GetUnitAbilityLevel(Source,'A0BR')//A0BR -> Necromastery
	if Level==1 then
		set EZG=12
	elseif Level==2 then
		set EZG=20
	elseif Level==3 then
		set EZG=28
	else
		set EZG=36
	endif
	set EZG=EZG+1
	if IsUnitType(Target,UNIT_TYPE_HERO)==false then
		set EYG=EYG+1
	else
		set EYG=EYG+12
	endif
	set EYG=IMinBJ(EZG,EYG)
	call SetUnitAbilityLevel(Source,'A0CQ',EYG)//A0CQ -> Necromastery Effect
	call SaveInteger(HY,(GetHandleId(Source)),710,(EYG))
	set Source=null
	set Target=null
endfunction

function EAG takes nothing returns nothing
	local integer EYG
	local integer Level
	local integer EZG
	local trigger t
	local integer h
	local unit Source=GetKillingUnit()
	if GetUnitTypeId(Source)=='e00E' then//e00E -> Spellcaster
		set Source=udg_Hero[GetPlayerId(GetOwningPlayer(GetKillingUnit()))]
	endif
	set EYG=GetUnitAbilityLevel(Source,'A0CQ')//A0CQ -> Necromastery Effect
	set Level=GetUnitAbilityLevel(Source,'A0BR')//A0BR -> Necromastery
	set EZG=8+7*Level
	if EYG<=EZG then
		set t=AddProjectile(GetTriggerUnit(),Source,'h0CR',"EXG",3000,false)//h0CR -> Necromastery Projectile
		set h=GetHandleId(t)
		set t=null
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\ZigguratMissile\\ZigguratMissile.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
	endif
	set Source=null
endfunction

function EBG takes nothing returns nothing
	call SaveInteger(HY,GetHandleId(GetTriggerUnit()),710,R2I(GetUnitAbilityLevel(GetTriggerUnit(),'A0CQ')*.5)+1)//A0CQ -> Necromastery Effect
	call SetUnitAbilityLevel(GetTriggerUnit(),'A0CQ',R2I(GetUnitAbilityLevel(GetTriggerUnit(),'A0CQ')*.5)+1)//A0CQ -> Necromastery Effect, A0CQ -> Necromastery Effect
endfunction

function NecromasteryReact takes unit killer, unit victim returns nothing
	if IsUnitIllusion(victim) then
		return
	endif
	if IsUnitType(killer,UNIT_TYPE_HERO)==false then
		set killer=udg_Hero[GetPlayerId(GetOwningPlayer(killer))]
	endif
	if GetUnitAbilityLevel(killer,'A0BR')>0 then//A0BR -> Necromastery
		call EAG()
	endif
	if GetUnitAbilityLevel(victim,'A0BR')>0 then//A0BR -> Necromastery
		call EBG()
	endif
endfunction

function Shadowraze_Filter takes nothing returns boolean
	return IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0//
endfunction

function Shadowraze_Damage takes nothing returns nothing
	call DamageTarget(Shadowraze_Source,GetEnumUnit(),1,25+75*Shadowraze_Level)
endfunction

function Shadowraze_Cast takes nothing returns boolean
	local unit Hero=GetTriggerUnit()
	local real range
	local real a
	local real x
	local real y
	local group g=GetAvailableGroup()
	if GetUnitAbilityLevel(Hero,'A04R')>0 then // multicast//
		set Hero=udg_Hero[GetPlayerId(GetOwningPlayer(Hero))]
	endif
	if GetSpellAbilityId()=='A0EY'then//A0EY -> Shadowraze
		set range = 200
	elseif GetSpellAbilityId()=='A0FH'then//A0FH -> Shadowraze
		set range = 450
	elseif GetSpellAbilityId()=='A0F0'then//A0F0 -> Shadowraze
		set range = 700
	endif
	set a = GetUnitFacing(Hero)
	set x = GetWidgetX(Hero) + range*Cos(a*bj_DEGTORAD)
	set y = GetWidgetY(Hero) + range*Sin(a*bj_DEGTORAD)
	set Shadowraze_Source=Hero
	set Shadowraze_Level=GetUnitAbilityLevel(Hero,GetSpellAbilityId())
	call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(Hero),'e006',x,y,0),'BTLF',2)//e006 -> Dark Pillar
	call GroupEnumUnitsInRange(g,x,y,275,Condition(function Shadowraze_Filter))
	call ForGroup(g,function Shadowraze_Damage)
	call KillGroup(g)
	set Hero = null
	set g=null
	return false
endfunction

function SF_Necromastery_Learn takes nothing returns nothing
	call UnitAddAbility2(GetTriggerUnit(),'A0CQ')//A0CQ -> Necromastery Effect
endfunction

function SF_Shadowrazes_Learn takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local integer level = GetUnitAbilityLevel(u,'A0EY')//A0EY -> Shadowraze
	if level==1 then
		call UnitAddAbility2(u,'A0F0')//A0F0 -> Shadowraze
		call UnitAddAbility2(u,'A0FH')//A0FH -> Shadowraze
	else
		call SetUnitAbilityLevel(u,'A0F0',level)//A0F0 -> Shadowraze
		call SetUnitAbilityLevel(u,'A0FH',level)//A0FH -> Shadowraze
	endif
	set u = null
endfunction

function FEG takes nothing returns boolean
	return AliveNonBuildOrMarker(GetFilterUnit()) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1))
endfunction

function SF_RequiemOfSouls takes unit u returns nothing
	local group g
	local unit u2
	local integer lvl
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A0HH')//A0HH -> Requiem of Souls Cripple Far
	set g=GetAvailableGroup()
	set tt_unit1=u
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),700,Condition(function FEG))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call SetUnitX(d,GetUnitX(u2))
		call SetUnitY(d,GetUnitY(u2))
		call SetUnitOwner(d,GetOwningPlayer(u2),false)
		call IssueTargetOrderById(d,852189,u2)
		call GroupRemoveUnit(g,u2)
	endloop
	call UnitRemoveAbility(d,'A0HH')//A0HH -> Requiem of Souls Cripple Far
	set d=null
	call KillGroup(g)
endfunction

function Requiem_Start takes unit u, integer max returns nothing
	local real x = GetWidgetX(u)
	local real y = GetWidgetY(u)
	local unit d = CreateUnit(GetOwningPlayer(u),'e00E',x,y,0)//e00E -> Spellcaster
	local integer loopA = 0
	local integer angle = 360/max
	local integer level = GetUnitAbilityLevel(u,'A29J')//A29J -> Requiem of Souls

	call UnitAddAbility(d,'A0HG')//A0HG -> Requiem of Souls Effect
	call SetUnitAbilityLevel(d,'A0HG',level)//A0HG -> Requiem of Souls Effect
//	call echo("here")
	loop
		exitwhen loopA > max
		call IssuePointOrderById(d,852218,x+50*Cos(bj_DEGTORAD*loopA*angle),y+50*Sin(bj_DEGTORAD*loopA*angle))
		set loopA = loopA + 1
//		call echo(I2S(loopA))
	endloop
//	call echo("there")
	call SF_RequiemOfSouls(u)
	set d = null
endfunction

function RequiemWrapperOnDeath takes nothing returns nothing
	if GetUnitAbilityLevel(GetTriggerUnit(),'A29J')>0 then//A29J -> Requiem of Souls
		call Requiem_Start(GetTriggerUnit(),9)
	endif
endfunction

function RequiemWrapper takes nothing returns nothing
	call Requiem_Start(GetTriggerUnit(),18)
endfunction

function NightHunter_Void takes nothing returns nothing
	local unit Caster
	if(IsDayTime()==false)then
		set Caster=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()),bj_UNIT_FACING)//e00E -> Spellcaster
		call UnitAddAbility2(Caster,'A02R')//A02R -> Time Slow
		call IssueTargetOrderById(Caster,852075,GetSpellTargetUnit())
	else
		set Caster=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()),bj_UNIT_FACING)//e00E -> Spellcaster
		call UnitAddAbility2(Caster,'A1H1')//A1H1 -> Void (balanar, day slow)
		call IssueTargetOrderById(Caster,852075,GetSpellTargetUnit())
	endif
	set Caster=null
endfunction

function FMG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Caster=LoadUnitHandle(HY,h,19)
	call ResetUnitAnimation(Source)
	call RemoveUnit(Caster)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set Source=null
	set Caster=null
	set t=null
	return false
endfunction

function FNG takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'u01I',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))//u01I -> Crippling Fear
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function FMG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,19,Caster)
	call SetUnitVertexColorBJ(Caster,0,0,0,75)
	call SetUnitAnimation(Caster,"spell third")
	set Source=null
	set Caster=null
	set t=null
endfunction

function Fear_Night_OnCast takes nothing returns nothing
	if GetUnitAbilityLevel(GetTriggerUnit(),'A08C')<5 then//A08C -> Crippling Fear
		call FNG()
	endif
endfunction

function FQG takes nothing returns boolean
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit stalker=LoadUnitHandle(HY,h,304)
	local unit dummy=LoadUnitHandle(HY,h,305)
	if GetTriggerEvalCount(GetTriggeringTrigger())==1 then
		call UnitAddAbility(dummy,'Aloc')//Aloc -> Locust
	endif
	if stalker==null or IsDead(stalker)or IsDayTime() or GetUnitAbilityLevel(stalker,'DRKN')+GetUnitAbilityLevel(stalker,'DRKU')==0 then//DRKN -> Darkness, DRKU -> Darkness upgrade
		call ShowUnit(dummy,false)
		call SetUnitX(dummy,GetUnitX(stalker))
		call SetUnitY(dummy,GetUnitY(stalker))
		call UnitRemoveAbility(stalker,'A1VA')//A1VA -> Balanar Aghanim Effect
	else
		call ShowUnit(dummy,true)
		call SetUnitX(dummy,GetUnitX(stalker))
		call SetUnitY(dummy,GetUnitY(stalker))
		call UnitAddAbility2(stalker,'A1VA')//A1VA -> Balanar Aghanim Effect
	endif
	if GetOwningPlayer(dummy)!=GetOwningPlayer(stalker)then
		call SetUnitOwner(dummy,GetOwningPlayer(stalker),true)
	endif
	set stalker=null
	set dummy=null
	return false
endfunction

function HunterInTheNight_Leveling takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A086')//A086 -> Hunter in the Night, QP0T -> Hunter in the Night
	call UnitAddAbility2(u,'P247')//P247 -> Hunter in the Night
	if(IsDayTime() or GetUnitAbilityLevel(u,'A36D')==1)then
		call SetUnitAbilityLevel(u,'P247',5) //S00A//P247 -> Hunter in the Night
	else
		call SetUnitAbilityLevel(u,'P247',lvl) //S00A//P247 -> Hunter in the Night
	endif
	set u=null
endfunction

function Stalker_Fear_Leveling takes nothing returns nothing
	local unit u=GetTriggerUnit()
	call UnitAddAbility2(u,'A08C')//A08C -> Crippling Fear
	if(IsDayTime())then
		call SetUnitAbilityLevel(u,'A08C',5)//A08C -> Crippling Fear
	else
		call SetUnitAbilityLevel(u,'A08C',GetUnitAbilityLevel(u,'A08E'))//A08C -> Crippling Fear, A08E -> Crippling Fear (Learn)
	endif
	set u=null
endfunction

function Nightstalker_Darkness_RemoveVision takes nothing returns nothing
	local real sight
	local real nsight=800
	local integer id
	local integer i
	local integer delta=0
	local integer lvl
	local integer cursightlvl
	if LoadInteger(UnitStats,GetUnitTypeId(GetEnumUnit()),NSIGHT)>0 then
		set nsight=LoadInteger(UnitStats,GetUnitTypeId(GetEnumUnit()),NSIGHT)*1.0
	endif
	if GetPlayerTechResearched(GetOwningPlayer(GetEnumUnit()),'R00I',true)  then
		set nsight=1800.
	endif
	set cursightlvl=R2I(nsight/128)
	if cursightlvl > 5 then
		set delta=IMinIF(cursightlvl-5,8)
	endif
//	call echo("Found unit: "+GetUnitName(GetEnumUnit())+"; delta = "+I2S(delta)+" ("+R2S(nsight)+")")
	if delta > 0 then
		set id='DRK0'-1+delta
		if GetUnitAbilityLevel(GetEnumUnit(),id)==0 then
			call UnitRemoveAbility(GetEnumUnit(),'DRK0')
			call UnitRemoveAbility(GetEnumUnit(),'DRK1')
			call UnitRemoveAbility(GetEnumUnit(),'DRK2')
			call UnitRemoveAbility(GetEnumUnit(),'DRK3')
			call UnitRemoveAbility(GetEnumUnit(),'DRK4')
			call UnitRemoveAbility(GetEnumUnit(),'DRK5')
			call UnitRemoveAbility(GetEnumUnit(),'DRK6')
			call UnitRemoveAbility(GetEnumUnit(),'DRK7')
			call UnitAddAbility2(GetEnumUnit(),id)
		endif
	endif
endfunction

function Nightstalker_Darkness_BringVisionBack takes nothing returns nothing
	if GetUnitAbilityLevel(GetEnumUnit(),'DRK0')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK1')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK2')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK3')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK4')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK5')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK6')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK7')>0 then
		call UnitRemoveAbility(GetEnumUnit(),'DRK0')
		call UnitRemoveAbility(GetEnumUnit(),'DRK1')
		call UnitRemoveAbility(GetEnumUnit(),'DRK2')
		call UnitRemoveAbility(GetEnumUnit(),'DRK3')
		call UnitRemoveAbility(GetEnumUnit(),'DRK4')
		call UnitRemoveAbility(GetEnumUnit(),'DRK5')
		call UnitRemoveAbility(GetEnumUnit(),'DRK6')
		call UnitRemoveAbility(GetEnumUnit(),'DRK7')
	endif
endfunction

function Nightstalker_Darkness_FixVision takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local player p=LoadPlayerHandle(HY,h,0)
	local real limit=LoadReal(HY,h,0)-0.5
	local group g=GetAvailableGroup()
	local group gg=GetAvailableGroup()
	local player p2
	local integer i=0
	loop
		set p2=Player(i)
		if IsPlayerEnemy(p,p2) then
			call GroupEnumUnitsOfPlayer(gg,p2,Condition(function ReturnTrue))
			call GroupAddGroup(gg,g)
		endif
		set i=i+1
		exitwhen i>15
	endloop
	call SaveReal(HY,h,0,limit)
	set tt_player1=p
	if limit>0 then
		call ForGroup(g,function Nightstalker_Darkness_RemoveVision)
	else
		call ForGroup(g,function Nightstalker_Darkness_BringVisionBack)
	endif
	if limit<-20 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	call KillGroup(g)
	call KillGroup(gg)
	set t=null
endfunction

function Nightstalker_Darkness_ReducedVision takes unit u, real dur returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.5,true)
	call TriggerAddCondition(t,Condition(function Nightstalker_Darkness_FixVision))
	call SavePlayerHandle(HY,h,0,GetOwningPlayer(u))
	call SaveReal(HY,h,0,dur)
	set t=null
endfunction

function Nightstalker_Darkness_Start takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local real dur=50.
	local unit d=CreateUnit(Sentinels[1],'e00E',0,0,0)//e00E -> Spellcaster
	call ImitateNightEffect(dur,false)
	call UnitAddAbility(d,'A1T6')//A1T6 -> Eclipse Time Of Day
	call IssueImmediateOrderById(d,852621)
	if Mode_BO then
		call Nightstalker_Darkness_ReducedVision(u,dur)
	endif
	set d=null
	set u=null
endfunction

function StiflingDaggerSideEffects takes unit caster, unit target returns nothing
	local unit d
	if FindItemOfType(caster,Item_Real[MKBOn])!=null or FindItemOfType(caster,Item_Real[MKBOff])!=null then
		if PRD_Get(caster,Item_Real[MKBOn],35) then
			set d=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)
			call UnitAddAbility(d,'A3JP')
			call IssueTargetOrderById(d,852095,target)
			set d=null
			call DamageTarget(caster,target,1,100)
		endif
	endif
	if FindItemOfType(caster,Item_Real[SangeAndYasha])!=null then
		if PRD_Get(caster,Item_Real[SangeAndYasha],16) then
			call SangeApplyGreaterMaim(target)
		endif
	elseif FindItemOfType(caster,Item_Real[Sange])!=null or FindItemOfType(caster,Item_Real[SilverEdge])!=null or FindItemOfType(caster,Item_Real[HeavensHalberd])!=null then
		if PRD_Get(caster,Item_Real[Sange],15) then
			call SangeApplyMaim(target)
		endif
	endif
	if FindItemOfType(caster,Item_Real[CraniumBasher])!=null or FindItemOfType(caster,Item_Real[AbyssalBlade])!=null then
		if PRD_Get(caster,Item_Real[CraniumBasher],25) then
			call DamageTarget(caster,target,1,60.)
			set d=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)
			call UnitAddAbility(d,'A367')
			call IssueTargetOrderById(d,852095,target)
			set d=null
		endif
	endif
	if GetUnitAbilityLevel(caster,'A0JH')>0 or GetUnitAbilityLevel(caster,'A0FJ')>0 then
		call MjollnirLightnings(caster,target)
	endif
	if GetUnitAbilityLevel(caster,'Afbt')>0 and IsMagicImmune(target)==false then
		call DiffusalBladeAct(caster,target)
	endif
	call ApplyDesolatorIfHas(caster,target)
	if ApplySkadiDebuff(caster,target) or ApplyOrbOfVenom(caster,target) then
	endif
	
endfunction

function FVG takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit Source=tt_unit1
	local unit Target=tt_unit2
	local integer Level=(LoadInteger(HY,h,5))
	local real Damage=Level*40+20
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	local boolean b=LoadBoolean(HY,h,6)
	if b then
		set Damage=Damage*LoadReal(HY,h,6)
	endif
	call UnitAddAbility2(Caster,'A0YL')//A0YL -> Stifling Knife Slow
	call SetUnitAbilityLevel(Caster,'A0YL',Level)//A0YL -> Stifling Knife Slow
	call IssueTargetOrderById(Caster,852075,Target)
	if IsUnitType(Target,UNIT_TYPE_HERO) then
		set Damage=Damage/2
	endif
	call DamageTarget(Source,Target,3,Damage)
	if IsDead(Target)==false then
		call StiflingDaggerSideEffects(Source,Target)
	endif
	if b then
		call TextTagOnUnit(I2S(R2I(Damage))+"!",3,Target,0.02,255,0,0,255)
	endif
	set b=false
	if GetUnitAbilityLevel(Source,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(Source),0) then//Aloc -> Locust
		set Source=LoadUnitHandle(HY,GetHandleId(Source),0)
		set b=true
	endif
	if b==false and GetUnitAbilityLevel(Target,'A3E9')==1 and IsMagicImmune(Source)==false then
		set tt_int1=Level
		set tt_unit1=Source
		set tt_unit2=Target
		call ExecuteFunc("StiflingDaggerLotusOrbRefl")
	endif
	set Source=null
	set Target=null
	set Caster=null
endfunction

function FWG takes unit Hero, unit Target, integer lvl returns nothing
	local trigger t=AddProjectile(Hero,Target,'h010',"FVG",1200,false)//h010 -> Stifling Dagger Projectile
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,GetHandleId(t),45)
	call SaveInteger(HY,h,5,lvl)
	call SaveInteger(HY,h,6,lvl-1)
	if lvl>1 and PRD_Get(Hero,'P240',15) then
		call SaveBoolean(HY,h,6,true)
		call SaveReal(HY,h,6,0.5+lvl*1.0)
		call SetUnitScale(u,2.5,0,0)
		call SetUnitVertexColor(u,255,50,50,255)
	endif
	set t=null
	set u=null
endfunction

function StiflingDaggerLotusOrbRefl takes nothing returns nothing
	call LotusOrbFX(tt_unit2)
	if IsBlocked(tt_unit1)==false then
		call FWG(tt_unit2,tt_unit1,tt_int1)
	endif
endfunction

function PA_StiflingDagger takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call FWG(GetTriggerUnit(),GetSpellTargetUnit(),GetUnitAbilityLevel(GetTriggerUnit(),'A0YM'))//A0YM -> Stifling Dagger
	endif
endfunction

function FYG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,30)
	local integer Count=LoadInteger(HY,h,34)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetUnitAbilityLevel(Source,'A1CO')==0 then
		call UnitRemoveAbility(Source,'A1CO')//A1CO -> Phantom Strike
		call UnitRemoveAbility(Source,'B1CO')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
		if GetAttacker()==Source then
			if GetTriggerUnit()!=Target then
				call UnitRemoveAbility(Source,'A1CO')//A1CO -> Phantom Strike
				call UnitRemoveAbility(Source,'B1CO')
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
			else
				set Count=Count+1
				call SaveInteger(HY,h,34,(Count))
				if Count==4 then
					call UnitRemoveAbility(Source,'A1CO')//A1CO -> Phantom Strike
					call UnitRemoveAbility(Source,'B1CO')
					call FlushChildHashtable(HY,h)
					call CleanTrigger(t)
				endif
			endif
		endif
	else
		call UnitRemoveAbility(Source,'A1CO')//A1CO -> Phantom Strike
		call UnitRemoveAbility(Source,'B1CO')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function PA_Blink takes unit Source, unit Target, integer Level returns nothing
	local trigger t
	local integer h
	call DestroyEffect(AddSpecialEffect("war3mapImported\\PhantomStrike.mdx",GetUnitX(Source),GetUnitY(Source)))
	call SetUnitX(Source,GetUnitX(Target))
	call SetUnitY(Source,GetUnitY(Target))
	if IsUnitEnemy(Source,GetOwningPlayer(Target)) then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call UnitAddAbility2(Source,'A1CO')//A1CO -> Phantom Strike
		call AttackOrderDelayed(Source,Target)
		call TriggerRegisterTimerEvent(t,3,false)
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
		call TriggerRegisterDeathEvent(t,Source)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerAddCondition(t,Condition(function FYG))
		call SaveUnitHandle(HY,h,2,Source)
		call SaveUnitHandle(HY,h,30,Target)
	endif
	set t=null
endfunction

function PA_Blink_Wrapper takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local integer lvl=GetUnitAbilityLevel(u,'A0PL')//A0PL -> Phantom Strike
	if GetUnitAbilityLevel(u,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(u),0) then//Aloc -> Locust
		set u=LoadUnitHandle(HY,GetHandleId(u),0)
	endif
	if IsBlocked(target)==false then
		call PA_Blink(u,target,lvl)
//		call echo(GetUnitName(u)+" -> "+GetUnitName(target))
	endif
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set target=null
	set u=null
endfunction

function PA_Blink_PreWrapper takes nothing returns nothing
	local timer t
	local integer h
	if IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		call TimerStart(t,0,false,function PA_Blink_Wrapper)
		set t=null
	endif
endfunction

function FBG takes unit Source,boolean show returns nothing
	local integer Level=GetUnitAbilityLevel(Source,'P239')
	if show==false then
		call UnitRemoveAbility(Source,'A13F')//A13F -> Blur
		call UnitRemoveAbility(Source,'B0A2')//B0A2 -> |cff00ff00Blur|r
	else
		call UnitAddAbility2(Source,'A13F')//A13F -> Blur
	endif
endfunction

function FCG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local group g
	local integer Count=(LoadInteger(HY,h,34))
	local boolean F3G=(LoadBoolean(HY,h,674))
	set Count=Count+1
	call SaveInteger(HY,h,34,(Count))
	if Source!=null and IsDead(Source)==false and GetUnitAbilityLevel(Source,'P239')>0 then //A03P
		set tt_unit1=Source
		set g=GetAvailableGroup()
		if GetUnitAbilityLevel(Source,'A36D')==0 then
			call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1625,Condition(function LV8))
		else
			call GroupAddUnit(g,Source)
		endif
		if FirstOfGroup(g)!=null then
			if F3G then
				set F3G=false
				call SaveBoolean(HY,h,674,(F3G))
				set Count=0
				call SaveInteger(HY,h,34,(Count))
			else
				set Count=0
				call SaveInteger(HY,h,34,(Count))
				call SaveInteger(HY,(GetHandleId((Source))),(4302),2)
				call FBG(Source,true)
				call SetTint(Source,-1,-1,-1,255)
				if GetUnitAbilityLevel(Source,'A20S')==0 then//smoke//A20S -> Smoke of Deceit Container
					call UnitSetUsesAltIcon(Source,false)
				endif
			endif
		else
			if F3G==false then
				set F3G=true
				set Count=0
				call SaveBoolean(HY,h,674,(F3G))
				call SaveInteger(HY,h,34,(Count))
			else
				set Count=0
				call SaveInteger(HY,h,34,(Count))
				call SaveInteger(HY,(GetHandleId((Source))),(4302),1)
				call FBG(Source,false)
				call SetTint(Source,-1,-1,-1,64)
				call UnitSetUsesAltIcon(Source,IsPlayerEnemy(GetOwningPlayer(Source),GetLocalPlayer()) and IsUnitFogged(Source,GetLocalPlayer())==false and IsObserver(GetLocalPlayer())==false)
			endif
		endif
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Source=null
	return false
endfunction

function PhantomAssassin_Blur_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddCondition(t,Condition(function FCG))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,34,0)
	call EvasionSourceActivate(EVASION_SOURCE_BLUR,99999)
	call SaveBoolean(HY,h,674,(false))
	set t=null
	set Source=null
endfunction

function F1G takes nothing returns nothing
	local unit Caster
	if IsUnitInGroup(GetEnumUnit(),DK)==false and IsUnitVisibleLoD(GetEnumUnit(),GetOwningPlayer(J08)) then
		set Caster=CreateUnit(GetOwningPlayer(J08),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)//e00E -> Spellcaster
		call UnitAddAbility2(Caster,'A0RI')//A0RI -> Cage
		call SetUnitAbilityLevel(Caster,'A0RI',GetUnitAbilityLevel(J08,'A0RA'))//A0RI -> Cage, A0RA -> Pit of Malice
		if IssueTargetOrderById(Caster,852106,GetEnumUnit()) then
			call GroupAddUnit(DK,GetEnumUnit())
			call DamageTarget(J08,GetEnumUnit(),1,100)
		endif
		call UnitRemoveAbility(Caster,'A0RI')
		set Caster=null
	endif
	
endfunction

function F0G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer i
	local group g=(LoadGroupHandle(HY,h,22))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local group DA9=GetAvailableGroup()
	local unit XX8=(LoadUnitHandle(HY,h,221))
	set tt_unit1=XX8
	set J08=XX8
	call GroupEnumUnitsInRange(DA9,x,y,300,Condition(function DefaultEnemyFilterWithAncients))
	set DK=g
	call ForGroup(DA9,function F1G)
	call KillGroup(DA9)
	if GetTriggerEvalCount(t)>7*10 then
		set i=1
		loop
			exitwhen i>16
			call DestroyEffect((LoadEffectHandle(HY,h,(2700+i))))
			set i=i+1
		endloop
		call KillGroup(g)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set g=null
	set DA9=null
	set XX8=null
	return false
endfunction

function PitLord_PitOfMalice takes nothing returns nothing
	local integer i=1
	local real F2G=GetSpellTargetX()
	local real G4G=GetSpellTargetY()
	local real x
	local real y
	local integer E9E=16
	local string fx="Abilities\\Spells\\Undead\\Graveyard\\GraveMarker.mdl"
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local group g=GetAvailableGroup()
	call TimedReveal(GetOwningPlayer(GetTriggerUnit()),7,F2G,G4G,300+500)
	call PlaySoundAtPos(BC,F2G,G4G)
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddCondition(t,Condition(function F0G))
	call SaveGroupHandle(HY,h,22,(g))
	call SaveUnitHandle(HY,h,221,(GetTriggerUnit()))
	call SaveReal(HY,h,6,((F2G)*1.))
	call SaveReal(HY,h,7,((G4G)*1.))
	call CreateCorpse(GetOwningPlayer(GetTriggerUnit()),'ugho',F2G,G4G,0)//ugho -> Ghoul
	loop
		exitwhen i>E9E
		set x=F2G+300*Cos(i*360/ E9E*bj_DEGTORAD)
		set y=G4G+300*Sin(i*360/ E9E*bj_DEGTORAD)
		call SaveEffectHandle(HY,h,(2700+i),(AddSpecialEffect(fx,x,y)))
		if i==1 or i==5 or i==9 or i==13 then
			set x=F2G+275*Cos(i*360/ E9E*bj_DEGTORAD)
			set y=G4G+275*Sin(i*360/ E9E*bj_DEGTORAD)
			call CreateCorpse(GetOwningPlayer(GetTriggerUnit()),'ugho',x,y,0)//ugho -> Ghoul
		endif
		set i=i+1
	endloop
	set t=null
	set g=null
endfunction

function G8G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Caster=(LoadUnitHandle(HY,h,393))
	local integer Level=(LoadInteger(HY,h,5))
	local integer MIE=90
	local integer Count=GetTriggerEvalCount(t)

	if GetSpellAbilityId()=='A2MB'then//A2MB -> Dark Rift
		call KillUnit(Caster)
		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)

		set t=null
		set Caster=null
		set Source=null
		return false
	endif

	if Level==1 then
		set MIE=160
	elseif Level==2 then
		set MIE=120
	endif
	call SetUnitX(Caster,GetUnitX(Source))
	call SetUnitY(Caster,GetUnitY(Source))
	if Count>MIE then
		call KillUnit(Caster)
		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)
	elseif Count==30 then
		call ShowUnit(Caster,true)
		call UnitAddAbility(Caster,'Aloc')//Aloc -> Locust
	endif
	set t=null
	set Caster=null
	set Source=null
	return false
endfunction

function G9G takes nothing returns nothing
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
	call AddTimedKeyToUnit(GetEnumUnit(),4406,1)
	call SetUnitPosition(GetEnumUnit(),tt_real1,TJ)
	call PanCameraToTimedForPlayer(GetOwningPlayer(GetEnumUnit()),tt_real1,TJ,0)
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
endfunction


function Pitlord_Rift_Remove takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)

	call UnitRemoveAbility(u,'A2MB')//A2MB -> Dark Rift
	call UnitAddAbility2(u,'A2MB')//A2MB -> Dark Rift

	call Timer_End(t)

	set t = null
	set u = null
endfunction

function Pitlord_Rift_Stop takes unit u returns nothing
	local timer t = CreateTimer()

	call SaveUnitHandle(MHT,GetHandleId(t),0,u)
	call TimerStart(t,0,false,function Pitlord_Rift_Remove)

	set t = null
endfunction

function DarkRiftFilter takes nothing returns boolean
	return IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false and IsPlayerBelongToTeams(GetOwningPlayer(GetFilterUnit()))//Aloc -> Locust, 
endfunction

function GDG takes unit Source,unit Target returns nothing
	local group g=GetAvailableGroup()
	local player p = GetOwningPlayer(Source)
	local real x1 = GetWidgetX(Source)
	local real y1 = GetWidgetY(Source)
	local real x2 = GetWidgetX(Target)
	local real y2 = GetWidgetY(Target)

	call DestroyEffect(AddSpecialEffect("Doodads\\Cinematic\\ShimmeringPortal\\ShimmeringPortal.mdl",x1,y1))
	call DestroyEffect(AddSpecialEffect("Doodads\\Cinematic\\ShimmeringPortal\\ShimmeringPortal.mdl",x2,y2))
	set tt_real1=x2
	set TJ=y2
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x1,y1,475,Condition(function DarkRiftFilter))
	call ForGroup(g,function G9G)
	call KillGroup(g)

	call UnitRemoveAbility(Source,'A2MB')//A2MB -> Dark Rift
	call SetPlayerAbilityAvailable2(p,'A2MB',false)//A2MB -> Dark Rift
	call SetPlayerAbilityAvailable2(p,'A0R0',true)//A0R0 -> Dark Rift

	set g=null
endfunction

function GEG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local player p = GetOwningPlayer(Source)
	local boolean b = GetSpellAbilityId()=='A2MB'//A2MB -> Dark Rift

	if IsDead(Target) or IsDead(Source) or Target==null or Source==null or b then
		if b then
			call Pitlord_Rift_Stop(Source)
		else
			call Error(p,GetObjectName('n03F'))//n03F -> Target unit is not valid or target is dead
		endif

		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call UnitRemoveType(Target,UNIT_TYPE_PEON)
		call SetPlayerAbilityAvailable2(p,'A2MB',false)//A2MB -> Dark Rift
		call SetPlayerAbilityAvailable2(p,'A0R0',true)//A0R0 -> Dark Rift

		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)

		set t=null
		set Source=null
		set Target=null
		return false
	endif

	if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call GDG(Source,Target)
	endif

	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function GFG takes nothing returns boolean
	local real d
	if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))==false or GetUnitAbilityLevel(GetFilterUnit(),'A04R')>0 or GetOwningPlayer(GetFilterUnit())==Player(15) or IsDead(GetFilterUnit()) then//
		return false
	endif
	if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)or(IsCreep(GetFilterUnit()))then
		set d=DistanceBetweenXY(TJ,RJ,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()))
		if d<tt_real1 then
			set tt_real1=d
			set tt_unit1=GetFilterUnit()
		endif
	endif
	return false
endfunction

function GGG takes unit Source returns unit
	local group g
	local real x
	local real y
	set x=GetSpellTargetX()
	set y=GetSpellTargetY()
	set g=GetAvailableGroup()
	set tt_unit1=null
	set tt_real1=9999
	set TJ=x
	set RJ=y
	call GroupEnumUnitsInRange(g,x,y,4000,Condition(function GFG))
	call KillGroup(g)
	set g=null
	return tt_unit1
endfunction

function GHG takes unit Source returns nothing
	local trigger t
	local integer h
	local unit Target=GetSpellTargetUnit()
	local real x
	local real y
	local unit u
	if Target==null then
		set Target=GGG(Source)
	endif
	if Target==null then
		call Error(GetOwningPlayer(Source),GetObjectName('n03H'))//n03H -> No nearby target found
		return
	endif
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A0R0',false)//A0R0 -> Dark Rift
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2MB',true)//A2MB -> Dark Rift
	call UnitAddAbility2(Source,'A2MB')//A2MB -> Dark Rift
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,6-GetUnitAbilityLevel(Source,'A0R0'),false)//A0R0 -> Dark Rift
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function GEG))
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\DarkHands.mdl",Target,"overhead"))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call UnitAddType(Target,UNIT_TYPE_PEON)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function G8G))
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call SaveInteger(HY,h,5,GetUnitAbilityLevel(Source,'A0R0'))//A0R0 -> Dark Rift
	call SaveUnitHandle(HY,h,2,Source)
	set u=CreateUnit(GetOwningPlayer(Source),'h098',GetUnitX(Source),GetUnitY(Source),0)//h098 -> Dark Rift
	call SaveUnitHandle(HY,h,393,u)
	call UnitRemoveAbility(u,'Aloc')//Aloc -> Locust
	call ShowUnit(u,false)
	set t=null
	set Target=null
	set u=null
endfunction

function Pitlord_DarkRift_OnCast takes nothing returns nothing
	local unit Target=GetSpellTargetUnit()
	local unit Hero=GetTriggerUnit()
	if Target!=null then
		if IsUnitEnemy(Target,GetOwningPlayer(Hero)) or IsCreep(Target)==false then
			call InterruptUnit(Hero)
			call Error(GetOwningPlayer(Hero),GetObjectName('n041'))//n041 -> Must target allied unit or building
		endif
	else
		set Target=GGG(Hero)
	endif
	if Target==null then
		call InterruptUnit(Hero)
		call Error(GetOwningPlayer(Hero),GetObjectName('n040'))//n040 -> No nearby target found
	endif
	set Target=null
	set Hero=null
endfunction

function PitLord_DarkRift takes nothing returns nothing
	call GHG(GetTriggerUnit())
endfunction

function Pit_DarkRift_Preload takes nothing returns nothing
	call PreloadUnit('h094')//h094 -> Aura
	call PreloadUnit('h095')//h095 -> Gem_large
	call PreloadUnit('h096')//h096 -> Gem_small
endfunction

function Pitlord_Firestorm_Damage takes nothing returns nothing
	local unit t = GetEnumUnit()

	if GetUnitAbilityLevel(t,'D009')==1 then//D009 -> |cffff0000Fire Storm|r
		if IsUnitType(t,UNIT_TYPE_STRUCTURE) then
			call DamageTarget(group_temp_unit[0],t,1,group_temp_integer[0]/3)
		else
			call DamageTarget(group_temp_unit[0],t,1,group_temp_integer[0])
		endif
	endif

	set t = null
endfunction

function Pitlord_Firestorm_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local unit u = group_temp_unit[0]

	if IsUnitEnemy(u,GetOwningPlayer(t)) and IsDead(t)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false then//
		if IsUnitType(t,UNIT_TYPE_STRUCTURE) then
			call DamageTarget(u,t,1,group_temp_integer[0]/3)
		else
			call DamageTarget(u,t,1,group_temp_integer[0])
		endif
		call Buff_Add(t,'C009','D009',2)
		call GroupAddUnit(LoadGroupHandle(MHT,group_temp_integer[1],1),t)
	endif

	set u = null
	set t = null
	return false
endfunction

function Pitlord_Firestorm_Duration takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer loopA = 0
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local real x = LoadReal(MHT,info,0)
	local real y = LoadReal(MHT,info,1)
	local group g = LoadGroupHandle(MHT,info,1)
	set group_temp_unit[0] = LoadUnitHandle(MHT,info,0)
	set group_temp_integer[0] = LoadInteger(MHT,info,1)
	call ForGroup(g,function Pitlord_Firestorm_Damage)
	call SaveInteger(MHT,info,0,count-1)
	if count>2 then
		set group_temp_integer[0] = LoadInteger(MHT,info,2)
		set group_temp_integer[1] = info
		call GroupEnumUnitsInRange(temp_group,x,y,425,Condition(function Pitlord_Firestorm_Targets))
		if count==3 then
			set t = null
			set g = null
			return
		endif
		loop
			exitwhen loopA == 12
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\RainOfFire\\RainOfFireTarget.mdl",x + GetRandomReal(50,275)*Cos(loopA*30*bj_DEGTORAD),y + GetRandomReal(50,275)*Sin(loopA*30*bj_DEGTORAD)))
			set loopA = loopA + 1
		endloop
	elseif count==1 then
		call KillGroup(g)
		call Timer_End(t)
	endif
	set g = null // no gut :<
	set t = null
endfunction

function Pitlord_Firestorm_Start takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local group g = GetAvailableGroup()
	local integer loopA = 0
	local integer info = GetHandleId(t)
	local integer level = GetUnitAbilityLevel(u,'A01I')//A01I -> Firestorm
	local real x = GetSpellTargetX()
	local real y = GetSpellTargetY()

	loop
		exitwhen loopA == 12
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\RainOfFire\\RainOfFireTarget.mdl",x + GetRandomReal(50,275)*Cos(loopA*30*bj_DEGTORAD),y + GetRandomReal(50,275)*Sin(loopA*30*bj_DEGTORAD)))
		set loopA = loopA + 1
	endloop

	call SaveInteger(MHT,info,0,8)
	call SaveInteger(MHT,info,1,level*5)
	call SaveInteger(MHT,info,2,10 + 15*level)
	call SaveReal(MHT,info,0,x)
	call SaveReal(MHT,info,1,y)
	call SaveUnitHandle(MHT,info,0,u)
	call SaveGroupHandle(MHT,info,1,g)

	call TimerStart(t,.9,true,function Pitlord_Firestorm_Duration)

	set g = null //moar gut :3
	set u = null
	set t = null
endfunction




function Pitlord_Atrophy_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)

	call LoDStat_Sub(LoadUnitHandle(MHT,info,0),LoadInteger(MHT,info,0),"damage")

	call Timer_End(t)
	set t = null
endfunction

function Pitlord_Atrophy_Effect takes unit u, boolean b returns nothing
	local timer t = CreateTimer()
	local integer info = GetHandleId(t)
	local integer damage = 5
	local integer lvl=GetUnitAbilityLevel(u,'AIcd')//AIcd -> Atrophy Aura
	if b then
		set damage = 20
	endif

	call SaveUnitHandle(MHT,info,0,u)
	call SaveInteger(MHT,info,0,damage)
	call LoDStat_Add(u,damage,"damage")

	call TimerStart(t,lvl*5 + 25,false,function Pitlord_Atrophy_End)

	set t = null
endfunction

function Pitlord_Atrophy_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()

	if LoadBoolean(MHT,GetHandleId(t),'AIcd')and IsDead(t)==false and IsUnitEnemy(t,group_temp_player) then//AIcd -> Atrophy Aura
		call Pitlord_Atrophy_Effect(t,IsUnitType(group_temp_unit[0],UNIT_TYPE_HERO))
	endif

	set t = null
	return false
endfunction

function Pitlord_Atrophy_Start takes nothing returns boolean
	local unit u = GetTriggerUnit()
	local integer id = GetUnitTypeId(u)

	if GetUnitAbilityLevel(u,'A04R')==0 and id!='n0F5' and id!='N0MM' and IsUnitIllusion(u)==false and IsDead(u) then//, n0F5 -> Living Dead
		set group_temp_player = GetOwningPlayer(u)
		set group_temp_unit[0] = u

		call GroupEnumUnitsInRange(temp_group,GetWidgetX(group_temp_unit[0]),GetWidgetY(group_temp_unit[0]),925,Condition(function Pitlord_Atrophy_Targets))
	endif

	set u = null
	return false
endfunction

function Pitlord_Atrophy_Init takes nothing returns nothing
	local trigger trig = null
	call SaveBoolean(MHT,GetHandleId(GetTriggerUnit()),'AIcd',true) // works for both illusions as well :3//AIcd -> Atrophy Aura
	if LoadBoolean(MHT,'AIcd',0)then//AIcd -> Atrophy Aura
		return
	endif
	set trig = CreateTrigger()
	call TriggerRegisterAnyUnitEvent(trig,EVENT_PLAYER_UNIT_DEATH)
	call TriggerAddCondition(trig, Condition(function Pitlord_Atrophy_Start))
	call SaveBoolean(MHT,'AIcd',0,true)//AIcd -> Atrophy Aura
	set trig = null
endfunction

function PudgeRotTrig takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer hu=GetHandleId(u)
	local group g
	local unit u2
	local real dmg
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call DestroyTrigger(t)
		call FlushChildHashtable(HY,h)
		call RemoveSavedHandle(HY,hu,'A0AZ')//A0AZ -> Rot slow
	elseif IsUnitHidden(u)==false then
		set g=GetAvailableGroup()
		set tt_unit1=u
		call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),275,Condition(function DefaultEnemyFilterWithAncients))
		set dmg=6*GetUnitAbilityLevel(u,'A06K')//A06K -> Rot
		loop
			set u2=FirstOfGroup(g)
			exitwhen u2==null
			call DamageTarget(u,u2,1,dmg)
			call GroupRemoveUnit(g,u2)
		endloop
		call DamageTarget(u,u,1,dmg)
		call KillGroup(g)
	endif
	
	set t=null
	set u=null
	return false
endfunction

function PudgeRot takes boolean b returns nothing
	local trigger t=null
	local integer h=0
	local unit u=GetTriggerUnit()
	local integer hu=GetHandleId(u)
	if HaveSavedHandle(HY,hu,'A0AZ') then//A0AZ -> Rot slow
		set t=LoadTriggerHandle(HY,hu,'A0AZ')//A0AZ -> Rot slow
		set h=GetHandleId(t)
	elseif b then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,hu,'A0AZ',t)//A0AZ -> Rot slow
		call TriggerRegisterDeathEvent(t,u)
		call TriggerRegisterTimerEvent(t,0.2,true)
		call TriggerRegisterTimerEvent(t,0.0,false)
		call TriggerAddCondition(t,Condition(function PudgeRotTrig))
		call SaveUnitHandle(HY,h,0,u)
	endif
	if b==false then
		if t!=null then
			call DestroyTrigger(t)
			call FlushChildHashtable(HY,h)
			call RemoveSavedHandle(HY,hu,'A0AZ')//A0AZ -> Rot slow
		endif
	endif
	
	set t=null
	set u=null
endfunction

function HEG takes nothing returns boolean
	return GetUnitAbilityLevel(GetTriggerUnit(),'A06K')>0//A06K -> Rot
endfunction

function HFG takes nothing returns nothing
	if(GetIssuedOrderId()==852177)then
		call UnitAddAbility2(GetTriggerUnit(),'A0AZ')//A0AZ -> Rot slow
		//call SetUnitAbilityLevel(GetTriggerUnit(),'A0AZ',GetUnitAbilityLevel(GetTriggerUnit(),'A06K'))//A0AZ -> Rot slow, A06K -> Rot
		call PudgeRot(true)
	elseif(GetIssuedOrderId()==852178)then
		call UnitRemoveAbility(GetTriggerUnit(),'A0AZ')//A0AZ -> Rot slow
		call PudgeRot(false)
	endif
endfunction

function PG9 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
	call TriggerAddCondition(t,Condition(function HEG))
	call TriggerAddAction(t,function HFG)
	set t=null
endfunction

function FleshHeapDistr takes nothing returns nothing
	local unit victim=tt_unit1
	local unit killer=tt_unit2
	local integer i=1
	local integer k=5
	local integer pid
	if IsSentinel(GetOwningPlayer(victim)) then
		loop
			set pid=GetPlayerId(Scourges[i])
			if IsDead(udg_Hero[pid])==false and (GetPlayerId(GetOwningPlayer(killer))==pid or DistanceBetweenUnits(victim,udg_Hero[pid])<725) then
				set FleshHeapCount[pid]=FleshHeapCount[pid]+1
			endif
			set i=i+1
			exitwhen i>k
		endloop
	elseif IsScourge(GetOwningPlayer(victim)) then
		loop
			set pid=GetPlayerId(Sentinels[i])
			if IsDead(udg_Hero[pid])==false and (GetPlayerId(GetOwningPlayer(killer))==pid or DistanceBetweenUnits(victim,udg_Hero[pid])<725) then
				set FleshHeapCount[pid]=FleshHeapCount[pid]+1
			endif
			set i=i+1
			exitwhen i>k
		endloop
	endif
	set killer=null
	set victim=null
endfunction

function HJG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	if GetTriggerEvalCount(t)==1 then
		call ShowUnit(Source,false)
	elseif GetTriggerEvalCount(t)>80 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	return false
endfunction

function Rot_Suicide takes nothing returns nothing
	local unit u
	local trigger t
	local integer h
	local unit victim=GetTriggerUnit()
	local unit killer=GetKillingUnit()
	if GetUnitAbilityLevel(killer,'A06K')>0 then//A06K -> Rot
		if victim==killer then
			set u=CreateUnit(GetOwningPlayer(victim),'h0BB',GetUnitX(victim),GetUnitY(victim),GetUnitFacing(victim))//h0BB -> Pudge suicide Explosion
			call SetUnitTimeScale(u,.75)
			call UnitApplyTimedLife(u,'BTLF',1.)
			call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Undead\\UndeadBlood\\UndeadBloodAbomination.mdl",u,"origin"))
			set u=null
			call SetSoundPosition(SE,GetUnitX(victim),GetUnitY(victim),50)
			call SetSoundVolumeBJ(SE,100)
			call PlaySoundBJ(SE)
			call SetSoundPosition(RE,GetUnitX(victim),GetUnitY(victim),50)
			call SetSoundVolumeBJ(RE,100)
			call PlaySoundBJ(RE)
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call TriggerRegisterTimerEvent(t,.1,true)
			call TriggerAddCondition(t,Condition(function HJG))
			call SaveUnitHandle(HY,h,2,victim)
			set t=null
		endif
	endif
	set victim=null
	set killer=null
endfunction

function HMG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local unit Source=(LoadUnitHandle(HY,(GetHandleId(t)),2))
	local integer h=GetHandleId(Source)
	local integer oldbonus=LoadInteger(MHT,h,'A06D')//A06D -> Flesh Heap
	local integer lvl=GetUnitAbilityLevel(Source,'A06D')//QP13 -> Flesh Heap, A06D -> Flesh Heap
	local integer newbonus=R2I(I2R(FleshHeapCount[GetPlayerId(GetOwningPlayer(Source))])*(.5*lvl))
	if Source==null then
		call FlushChildHashtable(HY,GetHandleId(t))
		call CleanTrigger(t)
	endif
	if newbonus>oldbonus then
		call ModifyHeroStat(bj_HEROSTAT_STR,Source,bj_MODIFYMETHOD_ADD,newbonus-oldbonus)
		call SaveInteger(MHT,h,'A06D',newbonus)//A06D -> Flesh Heap
		call TextTagOnUnit("+"+I2S(newbonus-oldbonus)+" "+GetObjectName('n0MJ'),3,Source,.023,0,255,0,230)//n0MJ -> Str
		if GetUnitPrimaryAttribute(Source)!=3 then
			call SaveInteger(HY,GetHandleId(Source),'axxx',newbonus)
			call BonusDamageSystem(Source)
		endif
	endif
	set t=null
	set Source=null
	return false
endfunction

function Butcher_FleshHeap_Learn takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer i
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddCondition(t,Condition(function HMG))
	call SaveUnitHandle(HY,h,2,(Source))
	set Source=null
	set t=null
endfunction

function Pudge_Hook_BonusPathing takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if IsDead(u)==false then
		call SetUnitPathing(u,true)
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set u=null
	set t=null
endfunction

function HTG takes unit Source,unit Target returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	local unit VCF=CreateUnit(GetOwningPlayer(Source),'e02A',GetUnitX(Target),GetUnitY(Target),0)//e02A -> Spellcaster #4
	call UnitAddAbility2(Caster,'A0PZ')//A0PZ -> Ministun
	call IssueTargetOrderById(Caster,852095,Target)
	call UnitApplyTimedLife(Caster,'BTLF',1)
	call UnitApplyTimedLife(VCF,'BTLF',1)
	set Caster=null
	set VCF=null
endfunction

function HUG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer HVG=(LoadInteger(HY,h,376))
	local boolean dragged=(LoadBoolean(HY,h,377))
	local unit u=(LoadUnitHandle(HY,h,17))
	local unit chain=(LoadUnitHandle(HY,h,(2100+HVG)))
	local real x
	local real y
	local trigger tt
	if dragged then
		
		set x=GetUnitX(chain)
		set y=GetUnitY(chain)
		if DistanceBetweenXY(GetUnitX(chain),GetUnitY(chain),GetUnitX(u),GetUnitY(u))<1200 then
			if IsUnitType(u,UNIT_TYPE_HERO)then
				call SaveBoolean(HeroStats,GetHandleId(u),99,true)
			endif
			call SetUnitX(u,x)
			call SetUnitY(u,y)
		else
			call SaveBoolean(HY,h,377,false)
		endif
		if u==null then
			call SaveBoolean(HY,h,377,false)
		endif
	endif
	call RemoveUnit(chain)
	set HVG=HVG-1
	call SaveInteger(HY,h,376,(HVG))
	if HVG==0 then
		if (IsTerrainPathableFixed(x,y)==false or IsPointInRegion(RestrictedRegion,x,y)) and IsUnitType(u,UNIT_TYPE_HERO) then
			set tt=CreateTrigger()
			call SaveUnitHandle(HY,GetHandleId(tt),0,u)
			call TriggerRegisterTimerEvent(tt,5,false)
			call TriggerAddCondition(tt,Condition(function Pudge_Hook_BonusPathing))
			set tt=null
		else
			call SetUnitPathing(u,true)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set u=null
	set chain=null
	return false
endfunction

function HYG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer i=(LoadInteger(HY,h,376))
	local integer Level=(LoadInteger(HY,h,5))
	local real a=(LoadReal(HY,h,13))
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local trigger RPE=(LoadTriggerHandle(HY,h,11))
	local integer RME=GetHandleId(RPE)
	local group g
	local unit u
	local real x
	local real y
	local real z
	local integer hp=GetHandleId(GetOwningPlayer(Hero))
	local real aoe=110
	if i<20+2.5*Level then
		set i=i+1
		if i==1 then
			set aoe=50
		elseif i==2 then
			set aoe=75
		endif
		call SaveInteger(HY,h,376,(i))
		set x=GetUnitX(Hero)+i*40*Cos(a*bj_DEGTORAD)
		set y=GetUnitY(Hero)+i*40*Sin(a*bj_DEGTORAD)
		call SaveUnitHandle(HY,(RME),(2100+i),(CreateUnit(GetOwningPlayer(Hero),'u00H',x,y,a)))//u00H -> Chain Link
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,x,y,aoe,Condition(function DG9))
		call GroupRemoveUnit(g,Hero)
		if GetUnitTypeId(Hero)=='e00E' then//e00E -> Spellcaster
			call GroupRemoveUnit(g,udg_Hero[GetPlayerId(GetOwningPlayer(Hero))])
		endif
		set u=GroupPickRandomUnit(g)
		call KillGroup(g)
		if u!=null then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call TriggerRegisterTimerEvent(RPE,.03,true)
			call TriggerAddCondition(RPE,Condition(function HUG))
			call SaveInteger(HY,(RME),376,(i))
			call SaveBoolean(HY,(RME),377,(true))
			call SaveUnitHandle(HY,(RME),17,(u))
			call SetUnitPathing(u,false)
			if IsUnitEnemy(u,GetOwningPlayer(Hero))then
				if IsUnitType(u,UNIT_TYPE_HERO) then
					call SaveInteger(HeroStats,hp,'HK_H',LoadInteger(HeroStats,hp,'HK_H')+1)
					call Traffic_RegisterData("HA_Hits"+I2S(GetPlayerId(GetOwningPlayer(Hero))),LoadInteger(HeroStats,hp,'HK_H'))
					call AddTimedKeyToUnit(Hero,4400,1.5)
				endif
				call HTG(Hero,u)
				call DamageTarget(Hero,u,7,90*Level)
				call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",u,"origin"))
			endif
		endif
	else
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call TriggerRegisterTimerEvent(RPE,.03,true)
		call TriggerAddCondition(RPE,Condition(function HUG))
		call SaveInteger(HY,(RME),376,(i))
		call SaveBoolean(HY,(RME),377,(false))
	endif
	set t=null
	set Hero=null
	set RPE=null
	set g=null
	set u=null
	return false
endfunction

function Pudge_MeatHook takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real a=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetSpellTargetX(),GetSpellTargetY())
	local integer Level=GetUnitAbilityLevel(Hero,'A06I')//A06I -> Meat Hook
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer hp=GetHandleId(GetOwningPlayer(Hero))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveInteger(HY,h,376,0)
	call SaveTriggerHandle(HY,h,11,(CreateTrigger()))
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function HYG))
	call SaveInteger(HeroStats,hp,'HK_T',LoadInteger(HeroStats,hp,'HK_T')+1)
	call Traffic_RegisterData("HA_Total"+I2S(GetPlayerId(GetOwningPlayer(Hero))),LoadInteger(HeroStats,hp,'HK_T'))
	set Hero=null
	set t=null
endfunction

function HCG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Level=(LoadInteger(HY,h,5))
	local real Damage=(75+50*Level)+GetHeroHighestStatValue(Source)
	local integer Count=(LoadInteger(HY,h,34))
	if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
		if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and GetSpellAbilityId()=='A1CX')then//A1CX -> Dismember Upgraded
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call RemoveFakeDust(Target)
		endif
	elseif GetTriggerEvalCount(t)>7 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call RemoveFakeDust(Target)
		call InterruptUnit(Source)
	else
		if Level>0 then
			set Count=Count+1
			if(Count<4 and IsUnitType(Target,UNIT_TYPE_HERO))or(Count<8 and IsUnitType(Target,UNIT_TYPE_HERO)==false)then
				call SetWidgetLife(Source,GetWidgetLife(Source)+Damage)
				call DamageTarget(Source,Target,1,Damage)
			endif
			call SaveInteger(HY,h,34,(Count))
			if IsDead(Target)==false and GetUnitAbilityLevel(Target,'Bdet')==0 then
				call AddFakeDust(Source,Target)
			endif
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function H3G takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A1CX')//A1CX -> Dismember Upgraded
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function HCG))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,5,(Level))
	call SaveInteger(HY,h,34,0)
	call TriggerEvaluate(t)
	call AddFakeDust(Source,Target)
	set t=null
	set Source=null
	set Target=null
endfunction

function Pudge_Dismember takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call H3G()
	endif
endfunction

function DismemberDmgDur takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local unit target=(LoadUnitHandle(HY,h,17))
	local integer lvl=(LoadInteger(HY,h,5))
	local real dmg=(50+50*lvl)
	local integer c=(LoadInteger(HY,h,34))
	local unit d
	if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
		if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and GetSpellAbilityId()=='A0FL')then//A0FL -> Dismember
			call RemoveFakeDust(target)
			call FlushChildHashtable(HY,(h))
			call CleanTrigger(t)
		endif
	elseif GetTriggerEvalCount(t)>8 then
		call RemoveFakeDust(target)
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
		call InterruptUnit(caster)
	else
		if lvl>0 then
			set c=c+1
			if(c<4 and IsUnitType(target,UNIT_TYPE_HERO))or(c<8 and IsUnitType(target,UNIT_TYPE_HERO)==false)then
				call DamageTarget(caster,target,1,dmg)
			endif
			call SaveInteger(HY,h,34,(c))
		endif
		if GetUnitAbilityLevel(target,'Bdet')==0 then
			call AddFakeDust(caster,target)
		endif
	endif
	set t=null
	set caster=null
	set target=null
	return false
endfunction

function Pudge_DismemberBasic takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A0FL')//A0FL -> Dismember
	local unit d
	call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function DismemberDmgDur))
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveUnitHandle(HY,h,17,(target))
	call SaveInteger(HY,h,5,(lvl))
	call SaveInteger(HY,h,34,0)
	call AddFakeDust(caster,target)
	call TriggerEvaluate(t)
	set t=null
	set caster=null
	set target=null
endfunction

function Pudge_DismemberBasicWrap takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Pudge_DismemberBasic()
	endif
endfunction

function HealNetherWard takes unit ward,real for returns nothing
	local real maxlife=GetUnitState(ward,UNIT_STATE_MAX_LIFE)
	local real curlife=GetWidgetLife(ward)
	if for>0 then
		if for>(maxlife-curlife)then
			if for>=curlife then
				call SetWidgetLife(ward,maxlife)
				call HealUnitFor(ward,for-(maxlife-curlife))
			else
				call HealUnitFor(ward,for)
			endif
		else
			call SetWidgetLife(ward,GetWidgetLife(ward)+for)
		endif
	endif
endfunction

function Oblivion_NetherWard_DmgBlock takes nothing returns nothing
	local real dmg=.25
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if IsUnitType(GetEventDamageSource(),UNIT_TYPE_HERO)==false then
			call HealNetherWard(GetTriggerUnit(),GetEventDamage()-0.25)
		else
			call HealNetherWard(GetTriggerUnit(),GetEventDamage()-1)
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_DEATH then
		call CleanTrigger(GetTriggeringTrigger())
	endif
endfunction

function Func3411 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit ward=(LoadUnitHandle(HY,h,19))
	local integer lvl=(LoadInteger(HY,h,5))
	local group g
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SetUnitAnimation(ward,"death")
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if IsUnitIdType(GetUnitTypeId(GetEventDamageSource()),UNIT_TYPE_HERO) then
			call HealUnitFor(ward,GetEventDamage()-1)
		else
			call HealUnitFor(ward,GetEventDamage()-0.25)
		endif
	endif
	set t=null
	set ward=null
	return false
endfunction

function Pugna_NetherWardSummon takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A09D')
	local real x=SafeX50(GetSpellTargetX())
	local real y=SafeY50(GetSpellTargetY())
	local unit ward
	local integer id=0
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	if lvl==1 then
		set id='o00M'
	elseif lvl==2 then
		set id='o00L'
	elseif lvl==3 then
		set id='o00O'
	else
		set id='o00N'
	endif
	set ward=CreateUnit(GetTriggerPlayer(),id,x,y,0)
	call TriggerRegisterDeathEvent(t,ward)
	call TriggerRegisterUnitEvent(t,ward,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function Func3411))
	call SaveUnitHandle(HY,h,19,(ward))
	call SaveInteger(HY,h,5,lvl)//A09D -> Nether Ward
	call SetUnitAbilityLevel(ward,'A08T',lvl)//A08T -> Mana Flare, A09D -> Nether Ward
	call SetUnitAbilityLevel(ward,'A0CF',lvl)//A0CF -> Nether Ward, A09D -> Nether Ward
	call IssueImmediateOrder(ward,"manaflareon")
	call UnitApplyTimedLife(ward,'BTLF',30)
	
	set caster=null
	set ward=null
	set t=null
endfunction

function Oblivion_LifeDrain_Duration takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local real lvl=LoadInteger(HY,h,0)
	local boolean isAgh=LoadBoolean(HY,h,0)
	local real suck=0
	local real targetsMana=0
	if GetUnitAbilityLevel(u,'Bdcl')==0 or (GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and(GetSpellAbilityId()=='A0CC' or GetSpellAbilityId()=='A02Z')) then//A0CC -> Life Drain, A02Z -> Life Drain
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if isAgh then
			set suck=30+15*lvl
		else
			set suck=20+10*lvl
		endif
		if (GetWidgetLife(u)+suck>=GetUnitState(u,UNIT_STATE_MAX_LIFE))then
			call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+suck)
		endif
	endif
	set u=null
	set target=null
	set t=null
endfunction


function Oblivion_LifeDrain_Start takes nothing returns nothing
	local unit u
	local unit target
	local trigger t
	local integer h
	local boolean isAgh
	if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO)then
		set isAgh=GetSpellAbilityId()=='A02Z'//A02Z -> Life Drain
		set t=CreateTrigger()
		set h=GetHandleId(t)
		set target=GetSpellTargetUnit()
		set u=GetTriggerUnit()
		call TriggerRegisterTimerEvent(t,0.25,true)
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_ENDCAST)
		call SaveInteger(HY,h,0,GetUnitAbilityLevel(u,GetSpellAbilityId()))
		call SaveBoolean(HY,h,0,isAgh)
		call SaveUnitHandle(HY,h,0,u)
		call SaveUnitHandle(HY,h,1,target)
		call TriggerAddCondition(t,Condition(function Oblivion_LifeDrain_Duration))
	endif
	set t=null
	set target=null
	set u=null
endfunction

function Oblivion_Decripify_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit target=(LoadUnitHandle(HY,h,17))
	call SetUnitVertexColor(target,255,255,255,255)
	call DestroyEffect((LoadEffectHandle(HY,h,32)))
	call UnitRemoveAbility(target,'A30D')
	call UnitRemoveAbility(target,'A30E')
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set target=null
	return false
endfunction

function DecrepifyBonusDur takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if GetUnitAbilityLevel(u,'B01N')==0 or IsDead(u) then//B01N -> Decrepify
		call UnitRemoveAbility(u,LoadInteger(HY,h,0))
		call UnitRemoveAbility(u,LoadInteger(HY,h,1))
		call UnitRemoveAbility(u,'B0HM')//B0HM -> Decrepify
		call UnitRemoveAbility(u,'B38G')//B38G -> Decrepify
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	endif
	set u=null
	set t=null
endfunction

function DecrepifyBonus takes unit caster, unit target, integer lvl returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local integer id
	local integer id2
	local integer id3
	if IsPlayerAlly(GetOwningPlayer(caster),GetOwningPlayer(target)) then
		set id='A30D'
		set id2='A30D'
		call UnitAddAbility2(target,'A44I')
		set id3='A44I'
	else
		set id='A30E'
		set id2='A30E'
		call UnitAddAbilityTimedExF(target,'A3C0'-1+lvl,1,3.5,'B38G')//B38G -> Decrepify
		set id3='A3C0'-1+lvl
	endif
	call TimerStart(t,0.1,true,function DecrepifyBonusDur)
	call SaveUnitHandle(HY,h,0,target)
	call SaveInteger(HY,h,0,id)
	call SaveInteger(HY,h,1,id3)
	call UnitAddAbility2(target,id)
	call UnitMakeAbilityPermanent(target,true,id2)
	set t=null
endfunction

function Oblivion_Decripify_Act takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local unit dummy=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
	local integer lvl=GetUnitAbilityLevel(caster,'A2TD')//A2TD -> Decrepify
	local trigger t
	local integer h
	call UnitAddAbility(dummy,'A0CE')//A0CE -> Decrepify origin
	call SetUnitAbilityLevel(dummy,'A0CE',lvl)//A0CE -> Decrepify origin
	call IssueTargetOrder(dummy,"banish",target)
	if GetUnitTypeId(target)=='n0FJ' or GetUnitTypeId(target)=='n0FI' or GetUnitTypeId(target)=='n0F6' or GetUnitTypeId(target)=='n0FH' then//n0FJ -> Tombstone - Level 1, n0FI -> Tombstone - Level 2, n0F6 -> Tombstone - Level 3, n0FH -> Tombstone - Level 4
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,1.5+0.5*lvl,false)
		call TriggerRegisterDeathEvent(t,target)
		call TriggerAddCondition(t,Condition(function Oblivion_Decripify_Duration))
		call SaveUnitHandle(HY,h,17,(target))
		call SetUnitVertexColor(target,50,255,50,150)
		call SaveEffectHandle(HY,h,32,(AddSpecialEffect("Abilities\\Spells\\Undead\\Cripple\\CrippleTarget.mdl",GetUnitX(target),GetUnitY(target))))
		set t=null
	else
		call DecrepifyBonus(caster,target,lvl)
	endif
	set caster=null
	set target=null
	set dummy=null
endfunction

function Oblivion_Decripify_OnCast takes nothing returns nothing
	local unit u=GetSpellTargetUnit()
	if not ((IsUnitType(u,UNIT_TYPE_STRUCTURE)==false and IsMagicImmune(u)==false)or GetUnitTypeId(u)=='n0FJ' or GetUnitTypeId(u)=='n0FI' or GetUnitTypeId(u)=='n0F6' or GetUnitTypeId(u)=='n0FH') then//n0FJ -> Tombstone - Level 1, n0FI -> Tombstone - Level 2, n0F6 -> Tombstone - Level 3, n0FH -> Tombstone - Level 4
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),"Invalid Target")
	endif
	set u=null
endfunction

function H0G takes unit Source,unit Target returns nothing
	local real H5G=20+40*KE8
	local real E29=70+30*KE8
	local real DV9=H5G+(E29-H5G)*KG8/ 700
	call DamageTarget(Source,Target,1,DV9)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\ChimaeraLightningMissile\\ChimaeraLightningMissile.mdl",Target,"chest"))
endfunction

function H2G takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local group HND=KD8
	local unit Source=KF8
	if IsUnitInGroup(Target,HND)==false then
		call GroupAddUnit(HND,Target)
		call H0G(Source,Target)
	endif
	set Target=null
	set HND=null
	set Source=null
endfunction

function I4G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Caster=LoadUnitHandle(HY,h,19)
	local group HND=LoadGroupHandle(HY,h,133)
	local effect fx
	local integer Count=GetTriggerEvalCount(t)
	local real x
	local real x0=GetUnitX(Source)
	local real y
	local real y0=GetUnitY(Source)
	local integer i
	local integer d
	local group g=GetAvailableGroup()
	call SetUnitX(Caster,GetUnitX(Source))
	call SetUnitY(Caster,GetUnitY(Source))
	set KD8=HND
	set KF8=Source
	set KE8=LoadInteger(HY,h,0)
	if Count>20 then
		set d=21*36+(20-Count)*36
		set KG8=d
		set i=0
		loop
			exitwhen i>36
			set x=x0+d*Cos(360*i/ 36*bj_DEGTORAD)
			set y=y0+d*Sin(360*i/ 36*bj_DEGTORAD)
			set tt_unit1=Source
			call GroupEnumUnitsInRange(g,x,y,100,Condition(function LA8))
			call ForGroup(g,function H2G)
			set i=i+1
		endloop
	else
		set d=Count*36
		set KG8=d
		set i=0
		loop
			exitwhen i>36
			set x=x0+d*Cos(360*i/ 36*bj_DEGTORAD)
			set y=y0+d*Sin(360*i/ 36*bj_DEGTORAD)
			set tt_unit1=Source
			call GroupEnumUnitsInRange(g,x,y,100,Condition(function LA8))
			call ForGroup(g,function H2G)
			set i=i+1
		endloop
	endif
	call KillGroup(g)
	if Count==40 then
		call KillUnit(Caster)
		call KillGroup(HND)
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif Count==20 then
		call GroupClear(HND)
		set fx=null
	endif
	set t=null
	set Caster=null
	set HND=null
	set Source=null
	set g=null
	return false
endfunction

function Razor_PlasmaField takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local real x=GetUnitX(Hero)
	local real y=GetUnitY(Hero)
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'h092',x,y,0)//h092 -> Plasma Field
	local integer i=0
	local integer AUD=36
	local group HND=GetAvailableGroup()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("effects\\Lightning_Ball_Tail_FX.mdx",Hero,"origin"))
	call SaveGroupHandle(HY,h,133,HND)
	call SaveUnitHandle(HY,h,2,Hero)
	call SaveUnitHandle(HY,h,19,Caster)
	call TriggerRegisterTimerEvent(t,.06,true)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
	call TriggerAddCondition(t,Condition(function I4G))
	set t=null
	set Caster=null
	set Hero=null
	set HND=null
endfunction

function I9G takes integer IDG returns boolean
	return IDG!='A09V' and IDG!='A026' and IDG!='A0LZ' and IDG!='A0OI' and IDG!='A0DY' and IDG!='A1WB' and IDG!='AHfa'//A09V -> Poison Attack, A026 -> Frost Arrows, A0LZ -> Glaives of Wisdom, A0OI -> Arcane Orb, A0DY -> Impetus, A1WB -> Impetus, AHfa -> Searing Arrows
endfunction

function IEG takes unit WH8,unit Source,unit Target,integer Level returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(WH8),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A1AK')//A1AK -> Lightning Sentry Bolt
	call SetUnitAbilityLevel(Caster,'A1AK',Level)//A1AK -> Lightning Sentry Bolt
	call IssueTargetOrderById(Caster,852119,Target)
	call UnitAddAbility2(Caster,'A18D')//A18D -> Shock
	call SetUnitAbilityLevel(Caster,'A18D',Level)//A18D -> Shock
	call IssueTargetOrderById(Caster,852111,Target)
	set Caster=null
endfunction

function IFG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level
	if GetSpellTargetUnit()==Source and GetUnitAbilityLevel(Source,'A36D')==0 and I9G(GetSpellAbilityId()) and IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(Source))==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
		set Level=GetUnitAbilityLevel(Source,'P283') //A1E6
		call IEG(Source,Source,GetTriggerUnit(),Level)
	endif
	set t=null
	set Source=null
	return false
endfunction

function Razor_UnstableCurrent_Learn takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function IFG))
	call SaveUnitHandle(HY,h,2,(Source))
	set Source=null
	set t=null
endfunction

function Razor_StaticLink_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer i = LoadInteger(MHT,info,1)

	call LoDStat_Sub(LoadUnitHandle(MHT,info,1),i,"damageneg")
	call LoDStat_Sub(LoadUnitHandle(MHT,info,0),i,"damage")

	call Timer_End(t)
	set t = null
endfunction

function Razor_StaticLink_Duration takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0) + 1
	local integer amount = LoadInteger(MHT,info,1)
	local unit u1 = LoadUnitHandle(MHT,info,0)
	local unit u2 = LoadUnitHandle(MHT,info,1)
	local unit dummy=LoadUnitHandle(MHT,info,33)
	local real x2 = GetWidgetX(u2)
	local real y2 = GetWidgetY(u2)
	local real x1 = GetWidgetX(u1)
	local real y1 = GetWidgetY(u1)
	if count==320 or IsDead(u1) or IsDead(u2) or (x1-x2)*(x1-x2)+(y1-y2)*(y1-y2)>490000 then
		call DestroyLightning(LoadLightningHandle(MHT,info,2))
		call Buff_Add(u1,'C023','D023',18)
		call Buff_Add(u2,'C024','D024',18)
		call TimerStart(t,18,false,function Razor_StaticLink_End)
		call RemoveUnit(dummy)
		set u2 = null
		set u1 = null
		set t = null
		set dummy=null
		return
	endif
	call SaveInteger(MHT,info,0,count)
	call MoveLightning(LoadLightningHandle(MHT,info,2),false,x1,y1,x2,y2)
	call SetUnitPosition(dummy,GetUnitX(u2),GetUnitY(u2))
	//if count/40 == count/40. then
		set count = R2I(LoadInteger(MHT,info,2)*count*1./40.)
		if LoadInteger(MHT,info,1)<=count then
		//set amount = amount + count
			call LoDStat_Add(u2,count-LoadInteger(MHT,info,1),"damageneg")
			call LoDStat_Add(u1,count-LoadInteger(MHT,info,1),"damage")
			call SaveInteger(MHT,info,1,count)
		endif
	//endif
	set dummy=null
	set u2 = null
	set u1 = null
	set t = null
endfunction

function Razor_StaticLink_Start takes nothing returns nothing
	local lightning l = null
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local unit d = GetSpellTargetUnit()
	local integer info = GetHandleId(t)
	local integer i=GetUnitAbilityLevel(u,'A1DP')//A1DP -> Static Link
	local unit dummy
	//check for mulitcast
	
	if GetUnitTypeId(u)=='e00E'then//e00E -> Spellcaster
		set u = udg_Hero[GetPlayerId(GetOwningPlayer(u))]
	endif
	set dummy=CreateUnit(GetOwningPlayer(u),'h088',GetUnitX(d),GetUnitY(d),0)//h088 -> Static Link
	set l = AddLightning("CLSB",true,GetWidgetX(u),GetWidgetY(u),GetWidgetX(d),GetWidgetY(d))
	set i = 7*i
	call SetLightningColor(l,0.3,0.5,1,1)
	call SaveUnitHandle(MHT,info,0,u)
	call SaveUnitHandle(MHT,info,1,d)
	call SaveUnitHandle(MHT,info,33,dummy)
	call SaveLightningHandle(MHT,info,2,l)
	call SaveInteger(MHT,info,0,0)
	//call SaveInteger(MHT,info,1,i)
	call SaveInteger(MHT,info,2,i)
	//call LoDStat_Add(d,i,"damageneg")
	//call LoDStat_Add(u,i,"damage")
	call TimerStart(t,0.025,true,function Razor_StaticLink_Duration)
	set d = null //dult :3
	set u = null
	set l = null
	set t = null
	set dummy=null
endfunction





function ISG takes integer h returns nothing
	local integer i=1
	local integer JBE=LoadInteger(HY,h,136)
	local unit Target
	if JBE==0 then
		return
	endif
	loop
		exitwhen i>JBE
		set Target=LoadUnitHandle(HY,h,2200+i)
		call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[0])
		call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[1])
		call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[2])
		call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[3])
		call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[4])
		call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[5])
		set i=i+1
	endloop
	set Target=null
endfunction

function ITG takes unit Target,integer h returns nothing
	local integer JBE=LoadInteger(HY,h,136)
	set JBE=JBE+1
	call SaveInteger(HY,h,136,JBE)
	call SaveUnitHandle(HY,h,2200+JBE,Target)
endfunction

function IUG takes unit u returns integer
	return GetUnitAbilityLevel(u,Razor_EyeOfStormContainers[0])*1+GetUnitAbilityLevel(u,Razor_EyeOfStormContainers[1])*2+GetUnitAbilityLevel(u,Razor_EyeOfStormContainers[2])*4+GetUnitAbilityLevel(u,Razor_EyeOfStormContainers[3])*8+GetUnitAbilityLevel(u,Razor_EyeOfStormContainers[4])*16
endfunction

function IVG takes unit u,integer d returns nothing
	local integer array b
	local integer a=d
	local integer c=1
	local integer i=0
	local integer E29
	if d<1 then
		call UnitRemoveAbility(u,Razor_EyeOfStormContainers[0])
		call UnitRemoveAbility(u,Razor_EyeOfStormContainers[1])
		call UnitRemoveAbility(u,Razor_EyeOfStormContainers[2])
		call UnitRemoveAbility(u,Razor_EyeOfStormContainers[3])
		call UnitRemoveAbility(u,Razor_EyeOfStormContainers[4])
		call UnitRemoveAbility(u,Razor_EyeOfStormContainers[5])
		return
	endif
	loop
		exitwhen c==0
		set c=a/ 2
		set b[i]=a-c*2
		set a=c
		set i=i+1
	endloop
	set E29=i
	set i=0
	loop
		exitwhen i>E29
		if b[i]==1 then
			call UnitAddAbility2(u,Razor_EyeOfStormContainers[i])
		else
			call UnitRemoveAbility(u,Razor_EyeOfStormContainers[i])
		endif
		set i=i+1
	endloop
endfunction

function IWG takes unit u,integer d returns nothing
	if IsUnitType(u,UNIT_TYPE_STRUCTURE)==false then
		call IVG(u,d+IUG(u))
		call ITG(u,KO8)
	endif
endfunction

function IXG takes unit Source,unit Caster,unit Target,integer Level returns nothing
	call IssueTargetOrderById(Caster,852119,Target)
	call DamageTargetDelayed(GetInvulDamager(Source),Target,2,(50+25*Level)/ 2,.3)
	call IWG(Target,1)
endfunction

function IYG takes nothing returns boolean
	if(IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))and GetUnitTypeId(GetFilterUnit())!='n00L' then//n00L -> Roshan
		if GetWidgetLife(GetFilterUnit())<KN8 then
			set KN8=GetWidgetLife(GetFilterUnit())
			set KM8=GetFilterUnit()
		endif
	endif
	return false
endfunction

function IZG takes nothing returns boolean
	if(IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false))and GetUnitTypeId(GetFilterUnit())!='emow' and GetUnitTypeId(GetFilterUnit())!='uzig' and GetUnitTypeId(GetFilterUnit())!='n00L' then//, emow -> Moon Well, uzig -> Ziggurat, n00L -> Roshan
		if GetWidgetLife(GetFilterUnit())<KN8 then
			set KN8=GetWidgetLife(GetFilterUnit())
			set KM8=GetFilterUnit()
		endif
	endif
	return false
endfunction

function IAG takes unit Source,unit Caster,integer Level returns nothing
	local group g=GetAvailableGroup()
	set KM8=null
	set KN8=999999
	set tt_unit1=Source
	if GetUnitAbilityLevel(Source,'A1UV')>0 then//A1UV -> Eye of the Storm
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),525,Condition(function IZG))
	else
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),525,Condition(function IYG))
	endif
	call KillGroup(g)
	if KM8!=null then
		call IXG(Source,Caster,KM8,Level)
	endif
endfunction

function IBG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local integer Level=(LoadInteger(HY,h,5))
	local integer Count=GetTriggerEvalCount(t)
	local integer interval
	local real delay
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call ISG(h)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if GetTriggerUnit()==Source then
			call KillUnit(Caster)
		endif
	else
		if GetUnitAbilityLevel(Source,'A1UV')>0 then//A1UV -> Eye of the Storm
			if Level==1 then
				set delay=0.6
			elseif Level==2 then
				set delay=0.5
			else
				set delay=0.4
			endif
		else
			if Level==1 then
				set delay=0.7
			elseif Level==2 then
				set delay=0.6
			else
				set delay=0.5
			endif
		endif
		set delay=delay/0.05
		if ModuloInteger(Count,R2I(delay))==0 or Count==1 then
			set KO8=h
			call IAG(Source,Caster,Level)
		endif
		call SetUnitX(Caster,GetUnitX(Source))
		call SetUnitY(Caster,GetUnitY(Source))
	endif
	set t=null
	set Source=null
	set Caster=null
	return false
endfunction

function Razor_EyeOfTheStorm takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A1AO')//A1AO -> Eye of the Storm
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'h081',GetUnitX(Source),GetUnitY(Source),0)//h081 -> Stormseeker FX - 1
	if Level==0 then
		set Level=GetUnitAbilityLevel(Source,'A1UV')//A1UV -> Eye of the Storm
	endif
	if GetUnitTypeId(Source)=='e00E' then//e00E -> Spellcaster
		set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
	endif
	call UnitApplyTimedLife(Caster,'BTLF',30)
	call SetUnitAbilityLevel(Caster,'A1DJ',Level)//A1DJ -> Eye of the Storm Lightning
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterDeathEvent(t,Caster)
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function IBG))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,5,(Level))
	set Source=null
	set Caster=null
	set t=null
endfunction

function Razor_EyeOfStorm_Init takes nothing returns nothing
	set Razor_EyeOfStormContainers[0]='A1DK'//A1DK -> Eye Of The Storm Negative Armor System -1
	set Razor_EyeOfStormContainers[1]='A1DL'//A1DL -> Eye Of The Storm Negative Armor System -2
	set Razor_EyeOfStormContainers[2]='A1DN'//A1DN -> Eye Of The Storm Negative Armor System -4
	set Razor_EyeOfStormContainers[3]='A1DM'//A1DM -> Eye Of The Storm Negative Armor System -8
	set Razor_EyeOfStormContainers[4]='A1DO'//A1DO -> Eye Of The Storm Negative Armor System -16
endfunction

function I6G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	call SetUnitPosition(Hero,SafeX50(x),SafeY50(y))
	call SetUnitAnimation(Hero,"morph ALTERNATE")
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	return false
endfunction

function SK_Burrowstrike takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Hero,'A06O')//A06O -> Burrowstrike
	local real a
	local real x=GetUnitX(Hero)
	local real y=GetUnitY(Hero)
	local real TargetX
	local real TargetY
	local real I1G
	local real I0G
	local real CasterX
	local real CasterY
	local integer CasterAbility
	local unit Caster
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real Damage
	local real DP9=1.65
	local unit D09=null
	if Level==1 then
		set Damage=100
	elseif Level==2 then
		set Damage=160
	elseif Level==3 then
		set Damage=220
	elseif Level==4 then
		set Damage=280
	endif
	if GetSpellTargetUnit()!=null then
		set TargetX=GetUnitX(GetSpellTargetUnit())
		set TargetY=GetUnitY(GetSpellTargetUnit())
	else
		set TargetX=GetSpellTargetX()
		set TargetY=GetSpellTargetY()
	endif
	set a=AngleBetweenXY(x,y,TargetX,TargetY)
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveReal(HY,h,6,((TargetX)*1.))
	call SaveReal(HY,h,7,((TargetY)*1.))
	call TriggerRegisterTimerEvent(t,DistanceBetweenXY(x,y,TargetX,TargetY)/ 2000,false)
	call TriggerAddCondition(t,Condition(function I6G))
	if DistanceBetweenXY(x,y,TargetX,TargetY)<150 then
		set TargetX=x+150*Cos(a*bj_DEGTORAD)
		set TargetY=y+150*Sin(a*bj_DEGTORAD)
	endif
	if GetSpellTargetUnit()!=null and IsBlocked(GetSpellTargetUnit())then
		set D09=GetSpellTargetUnit()
	endif
	call ImpaleFactory(Hero,D09,Damage,DP9,.52,x,y,TargetX,TargetY,175,null,true,1600)
	set Caster=null
	set Hero=null
	set t=null
	set D09=null
endfunction

function I2G takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetEnumUnit()),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)//e00E -> Spellcaster
	call UnitAddAbility(d,'A33J')
	call IssueTargetOrderById(d,852095,GetEnumUnit())
	set d=null
	call DamageTarget(KQ8,GetEnumUnit(),1,130)
	call IssueTargetOrderById(KR8,852075,GetEnumUnit())
endfunction

function J4G takes unit Source,real x,real y,integer Level,integer J7G returns nothing
	local group g=GetAvailableGroup()
	local real r
	local string fx
	if J7G==8 then
		set r=675
	elseif J7G==9 then
		set r=700
	elseif J7G==10 then
		set r=725
	else
		set r=250+50*J7G
	endif
	if J7G<4 then
		set fx="war3mapImported\\EpiPulse_1_4.mdx"
	elseif J7G<8 then
		set fx="war3mapImported\\EpiPulse_5_8.mdx"
	else
		set fx="war3mapImported\\EpiPulse_9_12.mdx"
	endif
	call DestroyEffect(AddSpecialEffect(fx,x,y))
	set tt_unit1=Source
	set KQ8=Source
	set KR8=KP8[GetPlayerId(GetOwningPlayer(Source))]
	call GroupEnumUnitsInRange(g,x,y,r,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(g,function I2G)
	call KillGroup(g)
	call BG8(.03,false,x,y,150+100*J7G,150+100*J7G,72,.03,512)
	set g=null
endfunction

function J8G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local player p=LoadPlayerHandle(HY,h,54)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real LastX=LoadReal(HY,h,23)
	local real LastY=LoadReal(HY,h,24)
	local boolean RIE=LoadBoolean(HY,h,15)
	local integer Level=LoadInteger(HY,h,5)
	local integer EZE=LoadInteger(HY,h,25)
	local integer J9G=4+Level*2
	local real x=LastX
	local real y=LastY
	if RIE then
		set J9G=J9G+2
	endif
	if EZE>J9G then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if Hero!=null and IsDead(Hero)==false then
			set x=GetUnitX(Hero)
			set y=GetUnitY(Hero)
		endif
		call J4G(Hero,x,y,Level,EZE)
		call SaveInteger(HY,h,25,EZE+1)
		call SaveReal(HY,h,23,x*1.)
		call SaveReal(HY,h,24,y*1.)
	endif
	set t=null
	set Hero=null
	return false
endfunction

function JDG takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local player p=GetOwningPlayer(Hero)
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Hero,'A06R')//A06R -> Epicenter
	local boolean RIE=false
	if Level==0 then
		set RIE=true
		set Level=GetUnitAbilityLevel(Hero,'A1B4')//A1B4 -> Epicenter upgrade
	endif
	if IsSentinel(p)then
		set KP8[GetPlayerId(p)]=CreateUnit(Scourges[0],'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
	else
		set KP8[GetPlayerId(p)]=CreateUnit(Sentinels[0],'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
	endif
	call UnitAddAbility2(KP8[GetPlayerId(p)],'A17B')//A17B -> Epicenter Slow
	call SaveUnitHandle(HY,h,14,Hero)
	call SavePlayerHandle(HY,h,54,GetOwningPlayer(Hero))
	call SaveReal(HY,h,23,GetUnitX(Hero))
	call SaveReal(HY,h,24,GetUnitY(Hero))
	call SaveInteger(HY,h,5,Level)
	call SaveInteger(HY,h,25,2)
	call SaveBoolean(HY,h,15,(RIE))
	call TriggerRegisterTimerEvent(t,.35,true)
	call TriggerAddCondition(t,Condition(function J8G))
	call J4G(Hero,GetUnitX(Hero),GetUnitY(Hero),Level,1)
	set Hero=null
	set t=null
endfunction

function JEG takes nothing returns boolean
	if GetSpellAbilityId()=='A06R' or GetSpellAbilityId()=='A1B4' then//A06R -> Epicenter, A1B4 -> Epicenter upgrade
		call JDG()
	endif
	return false
endfunction

function SK_Epicenter takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_FINISH)
	call TriggerAddCondition(t,Condition(function JEG))
	call PreloadQueryAdd('A17B')//A17B -> Epicenter Slow
	set t=null
	
endfunction

function CausticFinalTriggered_Filter takes nothing returns boolean
	if (IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(CausticFinal_SK,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))!=null then
		call DamageTarget(CausticFinal_SK,GetFilterUnit(),1,CausticFinal_dmg)
		call UnitAddAbilityTimedExF(GetFilterUnit(),'A38I',1,3,'B38I')//B38I -> Caustic Finale Poison
	endif
	return false
endfunction

function CausticFinalVisuals_Clean takes nothing returns nothing
	local timer t=GetExpiredTimer()
	call DestroyEffect(LoadEffectHandle(HY,GetHandleId(t),0))
	call CleanTimer(t)
	set t=null
endfunction

function CausticFinalVisuals takes unit victim returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,1,false,function CausticFinalVisuals_Clean)
	call SaveEffectHandle(HY,GetHandleId(t),0,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\PlagueCloud\\PlagueCloudCaster.mdl",victim,"chest"))
	set t=null
endfunction

function CausticFinalAoEDmg takes unit sk, unit victim, integer lvl, boolean halved returns nothing
	local group g=GetAvailableGroup()
	local real dmg=50+40*lvl// only lvl 4 mismatch
	if lvl==4 then
		set dmg=220
	endif
	if halved then
		set dmg=dmg/2
	endif
	set CausticFinal_SK=sk
	set CausticFinal_dmg=dmg
	call CausticFinalVisuals(victim)
	call GroupEnumUnitsInRange(g,GetUnitX(victim),GetUnitY(victim),425,Condition(function CausticFinalTriggered_Filter))
	
	call KillGroup(g)
endfunction

function CausticFinalTriggered_Tick takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit victim=LoadUnitHandle(HY,h,1)
	local unit sk=LoadUnitHandle(HY,h,0)
	local integer lvl=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call CausticFinalAoEDmg(sk,victim,lvl,false)
		call DestroyEffect(LoadEffectHandle(HY,h,10))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call RemoveSavedHandle(HY,GetHandleId(victim),'CFNL')
		call RemoveSavedBoolean(HY,GetHandleId(victim),'CFNL')
	elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		if TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0)then
			call CausticFinalAoEDmg(sk,victim,lvl,true)
			call UnitRemoveAbility(victim,'A348')
			call UnitRemoveAbility(victim,'B03F')//B03F -> Caustic Finale
			call DestroyEffect(LoadEffectHandle(HY,h,10))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call RemoveSavedHandle(HY,GetHandleId(victim),'CFNL')
			call RemoveSavedBoolean(HY,GetHandleId(victim),'CFNL')
		endif
	else//called to burst
		call CausticFinalAoEDmg(sk,victim,lvl,true)
	endif
	set t=null
	set sk=null
	set victim=null
endfunction

function CausticFinalTriggered_Apply takes unit sk, unit target returns nothing
	local trigger t
	local integer h
	local integer ht=GetHandleId(target)
	if LoadBoolean(HY,ht,'CFNL')==false then//no caustic final applied yet
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterDeathEvent(t,target)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddCondition(t,Condition(function CausticFinalTriggered_Tick))
		call SaveBoolean(HY,ht,'CFNL',true)//trigger is there
		call SaveTriggerHandle(HY,ht,'CFNL',t)
		call SaveUnitHandle(HY,h,1,target)//victim
		call SaveEffectHandle(HY,h,10,AddSpecialEffectTarget("Abilities\\Spells\\Other\\AcidBomb\\BottleImpact.mdl",target,"chest"))
		call UnitAddAbility2(target,'A348')
		call SaveBoolean(HY,h,0,IsUnitType(sk,UNIT_TYPE_MELEE_ATTACKER))
	else//there are another caustic finale applied
		set t=LoadTriggerHandle(HY,ht,'CFNL')
		set h=GetHandleId(t)
	endif
	call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+8)//save timestamp where buff should be removed
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(sk,'A0FA'))//store level//A0FA -> Caustic Finale, QP16 -> Caustic Finale
	call SaveUnitHandle(HY,h,0,sk)//store passive's owner
	if (LoadBoolean(HY,h,0) and LoadInteger(HY,h,1)==2) or LoadInteger(HY,h,1)==4 then
		call SaveInteger(HY,h,1,0)
		call TriggerEvaluate(t)
	else
		call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+1)
	endif
	set t=null
endfunction

function JFG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	if((LoadInteger(HY,(GetHandleId((Hero))),(4299)))==1)==false then
		call UnitRemoveAbility(Hero,'B04R')//B04R -> Sand Storm Invisibility
	endif
	call RemoveUnit((LoadUnitHandle(HY,h,379)))
	call RemoveUnit((LoadUnitHandle(HY,h,380)))
	call RemoveUnit((LoadUnitHandle(HY,h,381)))
	call RemoveUnit((LoadUnitHandle(HY,h,382)))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	return false
endfunction

function JGG takes unit Hero,integer Level,unit JHG,unit JIG,unit JJG,unit JKG returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real DP9=1.5
	
	call SaveInteger(HY,(GetHandleId((Hero))),(4299),2)
	call TriggerRegisterTimerEvent(t,DP9,false)
	call TriggerAddCondition(t,Condition(function JFG))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveUnitHandle(HY,h,379,(JHG))
	call SaveUnitHandle(HY,h,380,(JIG))
	call SaveUnitHandle(HY,h,381,(JJG))
	call SaveUnitHandle(HY,h,382,(JKG))
	set t=null
endfunction

function JMG takes nothing returns boolean
	if(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))then
		call DamageTarget(tt_unit1,GetFilterUnit(),1,tt_real1)
	endif
	return false
endfunction

function JNG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local unit JHG=(LoadUnitHandle(HY,h,379))
	local unit JIG=(LoadUnitHandle(HY,h,380))
	local unit JJG=(LoadUnitHandle(HY,h,381))
	local unit JKG=(LoadUnitHandle(HY,h,382))
	local integer Level=GetUnitAbilityLevel(Hero,'A0H0')//A0H0 -> Sand Storm
	local integer Count=GetTriggerEvalCount(t)
	local group g
	local integer JOG=550
	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST or Count>Level*40 then
		call JGG(Hero,Level,JHG,JIG,JJG,JKG)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set g=GetAvailableGroup()
		set tt_unit1=Hero
		set tt_real1=Level*25/2
		call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),JOG,Condition(function JMG))
		call KillGroup(g)
	endif
	set t=null
	set Hero=null
	set JHG=null
	set JIG=null
	set JJG=null
	set JKG=null
	set g=null
	return false
endfunction

function SK_Sandstorm takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit JHG=CreateUnit(GetOwningPlayer(Hero),'e00Q',GetUnitX(Hero)+150,GetUnitY(Hero)+150,0)//e00Q -> Sand Storm (caster)
	local unit JIG=CreateUnit(GetOwningPlayer(Hero),'e00Q',GetUnitX(Hero)+150,GetUnitY(Hero)-150,0)//e00Q -> Sand Storm (caster)
	local unit JJG=CreateUnit(GetOwningPlayer(Hero),'e00Q',GetUnitX(Hero)-150,GetUnitY(Hero)+150,0)//e00Q -> Sand Storm (caster)
	local unit JKG=CreateUnit(GetOwningPlayer(Hero),'e00Q',GetUnitX(Hero)-150,GetUnitY(Hero)-150,0)//e00Q -> Sand Storm (caster)
	local integer Level=GetUnitAbilityLevel(Hero,'A0H0')//A0H0 -> Sand Storm
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)//e00E -> Spellcaster
	call UnitAddAbility(JHG,'A45U')
	call UnitAddAbility(JHG,'A45V')
	call UnitAddAbility(JIG,'A45U')
	call UnitAddAbility(JIG,'A45V')
	call UnitAddAbility(JJG,'A45U')
	call UnitAddAbility(JJG,'A45V')
	call UnitAddAbility(JKG,'A45U')
	call UnitAddAbility(JKG,'A45V')
	call SaveInteger(HY,GetHandleId(Hero),4299,1)
	call UnitAddAbility2(Caster,'A0HO')//A0HO -> Sand Storm Invisibility
	call SetUnitAbilityLevel(Caster,'A0HO',Level)//A0HO -> Sand Storm Invisibility
	call IssueTargetOrderById(Caster,852069,Hero)
	call TriggerRegisterTimerEvent(t,0.5,true)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function JNG))
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveUnitHandle(HY,h,379,(JHG))
	call SaveUnitHandle(HY,h,380,(JIG))
	call SaveUnitHandle(HY,h,381,(JJG))
	call SaveUnitHandle(HY,h,382,(JKG))
	call SetUnitTimeScale(JHG,0)
	call SetUnitTimeScale(JIG,0)
	call SetUnitTimeScale(JJG,0)
	call SetUnitTimeScale(JKG,0)
	set t=null
	set Hero=null
	set Caster=null
	set JHG=null
	set JIG=null
	set JJG=null
	set JKG=null
endfunction

function Slardar_SlithereenCrush takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)//e00E -> Spellcaster
	local group g=GetAvailableGroup()
	local integer Level=GetUnitAbilityLevel(Source,GetSpellAbilityId())
	local unit u
	call UnitAddAbility2(Caster,'A0M9')//A0M9 -> Slithereen Crush slow
	call SetUnitAbilityLevel(Caster,'A0M9',Level)//A0M9 -> Slithereen Crush slow
	call IssueImmediateOrderById(Caster,852096)
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,350+25,Condition(function DefaultEnemyFilterWithAncients))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call DamageTarget(Caster,u,2,50*Level)
		call StunTargetLoD(u,0.5 + Level * 1.0 * 0.5)
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
	set Source=null
	set Caster=null
	set g=null
endfunction

function SlardarSprintDur takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer hu=GetHandleId(u)
	local real finish=LoadReal(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or (GetUnitAbilityLevel(u,'B013')==0 and GetTriggerEvalCount(t)>2) or TimerGetElapsed(GlobalTimer)>=finish then
		call RemoveSavedHandle(HY,hu,'A05C')
		call UnitRemoveAbility(u,'B3JQ')
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
//		call echo("destroy")
	else
		if GetUnitAbilityLevel(u,'B3JQ')==0 and GetUnitAbilityLevel(u,'B07T')==0 and GetUnitAbilityLevel(u,'B39C')==0 then
//			call echo("give")
			call Func0404(u,'I0T9')
		endif
	endif
	set t=null
	set u=null
endfunction

function SlardarSprintAct takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local trigger t
	local integer h
	local integer hu=GetHandleId(u)
	if HaveSavedHandle(HY,hu,'A05C') then
		set t=LoadTriggerHandle(HY,hu,'A05C')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.02,true)
		call TriggerRegisterDeathEvent(t,u)
		call TriggerAddCondition(t,Condition(function SlardarSprintDur))
		call SaveTriggerHandle(HY,hu,'A05C',t)
		call Func0404(u,'I0T9')
		call SaveUnitHandle(HY,h,0,u)
	endif
	call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+12.)
	set u=null
	set t=null
endfunction

function Slardar_AmplifyDamage_Check takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit target=LoadUnitHandle(HY,h,0)
	local real time=TimerGetElapsed(GlobalTimer)
	local real limit=LoadReal(MHT,GetHandleId(target),'A034')//A034 -> Amplify Damage
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call UnitRemoveAbility(target,'A310')
		call UnitRemoveAbility(target,'B30Z')//B30Z -> Amplify Damage
		call FlushChildHashtable(HY,h)
		call RemoveSavedHandle(MHT,GetHandleId(target),'A034')//A034 -> Amplify Damage
		call CleanTrigger(t)
	else
		if time>limit then
			call UnitRemoveAbility(target,'A310')
			call UnitRemoveAbility(target,'B30Z')//B30Z -> Amplify Damage
			call FlushChildHashtable(HY,h)
			call RemoveSavedHandle(MHT,GetHandleId(target),'A034')//A034 -> Amplify Damage
			call CleanTrigger(t)
		endif
	endif
	
	set t=null
	set target=null
endfunction

function Slardar_AmplifyDamage takes nothing returns nothing
	local trigger t
	local integer h
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local real duration
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
	if(IsBlocked(target))then
		set caster=null
		set target=null
		return
	endif
	if IsUnitType(target,UNIT_TYPE_HERO) or IsUnitIllusion(target) then
		set duration=30
	else
		set duration=120
	endif
	call SaveReal(MHT,GetHandleId(target),'A034',TimerGetElapsed(GlobalTimer)+duration)//A034 -> Amplify Damage
	call UnitAddAbility2(target,'A310')
	call SetPlayerAbilityAvailable(GetOwningPlayer(target),'A310',false)
	call UnitMakeAbilityPermanent(target,true,'A30Y')//A30Y -> Amplify Damage FX
	call UnitMakeAbilityPermanent(target,true,'A30Z')
	call SetUnitAbilityLevel(target,'A30Y',lvl)//A30Y -> Amplify Damage FX
	call ShareVision(target,caster,'A310')
	call DetectMagicDispell(target,'A310','B30Z')//B30Z -> Amplify Damage
	if LoadTriggerHandle(MHT,GetHandleId(target),'A304')==null then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
		call TriggerAddCondition(t,Condition(function Slardar_AmplifyDamage_Check))
		call SaveUnitHandle(HY,h,0,target)
		call SaveTriggerHandle(MHT,GetHandleId(target),'A034',t)//A034 -> Amplify Damage
		set t=null
	endif
	set caster=null
	set target=null
endfunction

function JUG takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,221)
	local unit JVG=LoadUnitHandle(HY,h,383)
	local unit Caster
	local real DP9=LoadReal(HY,h,57)
	local integer Level=LoadInteger(HY,h,0)
	local real JWG=(LoadReal(HY,h,6))
	local real JXG=(LoadReal(HY,h,7))
	local real AO8=GetUnitX(u)
	local real AP8=GetUnitY(u)
	if(AO8-JWG)*(AO8-JWG)+(AP8-JXG)*(AP8-JXG)>900 then
		set Caster=CreateUnit(GetOwningPlayer(JVG),('h002'),GetUnitX(u),GetUnitY(u),0)//h002 -> Shadow Path
		call SetUnitAbilityLevel(Caster,('A0I2'),Level)//A0I2 -> Spectral Dagger aura2
		call SetUnitAbilityLevel(Caster,('A0HY'),Level)//A0HY -> Spectral Dagger aura1
		call UnitApplyTimedLife(Caster,'BTLF',7)
		call SaveReal(HY,h,6,((AO8)*1.))
		call SaveReal(HY,h,7,((AP8)*1.))
	endif
	set DP9=DP9+.2
	call SaveReal(HY,h,57,((DP9)*1.))
	if DP9>7 or GetWidgetLife(u)<1 then
		call PauseTimer(t)
		call FlushChildHashtable(HY,h)
	endif
	set t=null
	set u=null
	set JVG=null
	set Caster=null
endfunction

function JYG takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local sound XP8
	local timer t
	local integer h
	call DamageTarget(TmpUnit376,Target,1,TmpReal378)
	
	call GroupAddUnit(TempGroup2,Target)
	if IsUnitType(Target,UNIT_TYPE_HERO) then
		set t=CreateTimer()
		set h=GetHandleId(t)
		set XP8=CreateSound("Sounds\\Spectral Dagger.mp3",false,true,true,10,10,"DefaultEAXON")
		call SetSoundPosition(XP8,GetUnitX(Target),GetUnitY(Target),0)
		call SetSoundDistanceCutoff(XP8,700)
		call StartSound(XP8)
		call KillSoundWhenDone(XP8)
		call SaveUnitHandle(HY,h,221,(Target))
		call SaveUnitHandle(HY,h,383,(TmpUnit376))
		call SaveReal(HY,h,6,((GetUnitX(Target))*1.))
		call SaveReal(HY,h,7,((GetUnitY(Target))*1.))
		call SaveInteger(HY,h,0,tt_int1)
		call TimerStart(t,.2,true,function JUG)
	endif
	set Target=null
	set t=null
endfunction

function JZG takes nothing returns boolean
	return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TmpUnit376))and IsUnitInGroup(GetFilterUnit(),TempGroup2)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetWidgetLife(GetFilterUnit())>1 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false)!=null//
endfunction

function JAG takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local group gg=LoadGroupHandle(HY,h,133)
	local group g=GetAvailableGroup()
	local unit Hero=LoadUnitHandle(HY,h,14)
	local unit Projectile=LoadUnitHandle(HY,h,45)
	local unit Target=LoadUnitHandle(HY,h,30)
	local real TargetX=GetUnitX(Target)
	local real TargetY=GetUnitY(Target)
	local real SourceX=GetUnitX(Projectile)
	local real SourceY=GetUnitY(Projectile)
	local real angle=Atan2(TargetY-SourceY,TargetX-SourceX)
	local real AO8=SafeX50(GetUnitX(Projectile)+30*Cos(angle))
	local real AP8=SafeY50(GetUnitY(Projectile)+30*Sin(angle))
	local unit Caster
	local integer Level=LoadInteger(HY,h,0)
	if(LoadBoolean(HY,h,384))then
		call SaveBoolean(HY,h,384,false)
		set Caster=CreateUnit(GetOwningPlayer(Hero),'h002',SourceX,SourceY,0)//h002 -> Shadow Path
		call SetUnitAbilityLevel(Caster,'A0I2',Level)//A0I2 -> Spectral Dagger aura2
		call SetUnitAbilityLevel(Caster,'A0HY',Level)//A0HY -> Spectral Dagger aura1
		call UnitApplyTimedLife(Caster,'BTLF',12)
	else
		call SaveBoolean(HY,h,384,true)
	endif
	call SetUnitX(Projectile,AO8)
	call SetUnitY(Projectile,AP8)
	call SetUnitFacing(Projectile,angle*bj_RADTODEG)
	set TempGroup2=gg
	set TmpUnit376=Hero
	set TmpReal378=50*Level
	set tt_int1=Level
	call GroupEnumUnitsInRange(g,AO8,AP8,150,Condition(function JZG))
	call ForGroup(g,function JYG)
	call KillGroup(g)
	if(AO8-TargetX)*(AO8-TargetX)+(AP8-TargetY)*(AP8-TargetY)<1600 then
		call PauseTimer(t)
		call FlushChildHashtable(HY,h)
		call KillUnit(Projectile)
		call KillGroup(gg)
	endif
	set gg=null
	set t=null
	set g=null
	set Hero=null
	set Projectile=null
	set Target=null
	set Caster=null
endfunction

function JBG takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local group gg=(LoadGroupHandle(HY,h,133))
	local group g=GetAvailableGroup()
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local unit Projectile=(LoadUnitHandle(HY,h,45))
	local real TargetX=(LoadReal(HY,h,47))
	local real TargetY=(LoadReal(HY,h,48))
	local real SourceX=GetUnitX(Projectile)
	local real SourceY=GetUnitY(Projectile)
	local real angle=(LoadReal(HY,h,13))
	local real nX=SafeX50(GetUnitX(Projectile)+30*Cos(angle))
	local real nY=SafeY50(GetUnitY(Projectile)+30*Sin(angle))
	local unit Caster
	local integer Level=LoadInteger(HY,h,0)
	if(LoadBoolean(HY,h,384))then
		call SaveBoolean(HY,h,384,(false))
		set Caster=CreateUnit(GetOwningPlayer(Hero),('h002'),SourceX,SourceY,0)//h002 -> Shadow Path
		call SetUnitAbilityLevel(Caster,('A0I2'),Level)//A0I2 -> Spectral Dagger aura2
		call SetUnitAbilityLevel(Caster,('A0HY'),Level)//A0HY -> Spectral Dagger aura1
		call UnitApplyTimedLife(Caster,'BTLF',12)
	else
		call SaveBoolean(HY,h,384,(true))
	endif
	call SetUnitX(Projectile,nX)
	call SetUnitY(Projectile,nY)
	set TempGroup2=gg
	set TmpUnit376=Hero
	set TmpReal378=50*GetUnitAbilityLevel(Hero,'A0HW')+50//A0HW -> Spectral Dagger
	call GroupEnumUnitsInRange(g,nX,nY,165,Condition(function JZG))
	call ForGroup(g,function JYG)
	call KillGroup(g)
	if(nX-TargetX)*(nX-TargetX)+(nY-TargetY)*(nY-TargetY)<1600 then
		call PauseTimer(t)
		call FlushChildHashtable(HY,h)
		call KillUnit(Projectile)
		call KillGroup(gg)
	endif
	set gg=null
	set t=null
	set g=null
	set Hero=null
	set Projectile=null
	set Caster=null
endfunction

function JCG takes unit XX8,integer ZG8 returns boolean
	return(GetItemTypeId(UnitItemInSlot(XX8,ZG8))=='pspd')or(GetItemTypeId(UnitItemInSlot(XX8,ZG8))=='oflg')
endfunction

function J3G takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real DP9=LoadReal(HY,h,57)
	local integer VT8=0
	loop
		exitwhen VT8>5
		if JCG(Hero,VT8)then
			if GetUnitAbilityLevel(Hero,('B047'))==0 then//B047 -> Spectral Dagger
				call SetItemDropOnDeath(UnitItemInSlot(Hero,VT8),true)
				if GetItemTypeId(UnitItemInSlot(Hero,VT8))=='oflg' then
					call SetItemDroppable(UnitItemInSlot(Hero,VT8),true)
				endif
			else
				call SetItemDropOnDeath(UnitItemInSlot(Hero,VT8),false)
				if GetItemTypeId(UnitItemInSlot(Hero,VT8))=='oflg' then
					call SetItemDroppable(UnitItemInSlot(Hero,VT8),false)
				endif
			endif
		endif
		set VT8=VT8+1
	endloop
	set DP9=DP9+.2
	call SaveReal(HY,h,57,DP9*1.)
	if GetUnitAbilityLevel(Hero,('B047'))==0 then//B047 -> Spectral Dagger
		call SetUnitPathing(Hero,true)
	else
		call SetUnitPathing(Hero,false)
	endif
	if DP9>30 then
		call PauseTimer(t)
		call FlushChildHashtable(HY,h)
		call SetUnitPathing(Hero,true)
		set VT8=0
		loop
			exitwhen VT8>5
			if JCG(Hero,VT8)then
				call SetItemDropOnDeath(UnitItemInSlot(Hero,VT8),true)
				if GetItemTypeId(UnitItemInSlot(Hero,VT8))=='oflg' then
					call SetItemDroppable(UnitItemInSlot(Hero,VT8),true)
				endif
			endif
			set VT8=VT8+1
		endloop
	endif
	set t=null
	set Hero=null
endfunction

function Spectre_SpectralDagger takes unit Hero, integer lvl returns nothing
	local unit Target=GetSpellTargetUnit()
	local real SourceX=SafeX50(GetUnitX(Hero))
	local real SourceY=SafeY50(GetUnitY(Hero))
	local unit Projectile=CreateUnit(GetOwningPlayer(Hero),('h003'),SourceX,SourceY,0)//h003 -> Shadow Dagger
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local group HND=GetAvailableGroup()
	local real a
	local real TargetX
	local real TargetY
	call SetUnitPathing(Projectile,false)
	call SaveGroupHandle(HY,h,133,HND)
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveUnitHandle(HY,h,45,Projectile)
	if Target!=null then
		call SaveUnitHandle(HY,h,30,Target)
		call SaveInteger(HY,h,0,lvl)
		call TimerStart(t,.035,true,function JAG)
	else
		set TargetX=GetSpellTargetX()
		set TargetY=GetSpellTargetY()
		set a=Atan2(TargetY-SourceY,TargetX-SourceX)
		call SetUnitFacing(Projectile,a*bj_RADTODEG)
		set TargetX=SafeX50(SourceX+2100*Cos(a))
		set TargetY=SafeY50(SourceY+2100*Sin(a))
		call SaveReal(HY,h,47,TargetX*1.)
		call SaveReal(HY,h,48,TargetY*1.)
		call SaveReal(HY,h,13,a*1.)
		call SaveInteger(HY,h,0,lvl)
		call TimerStart(t,.035,true,function JBG)
	endif
	set t=CreateTimer()
	set h=GetHandleId(t)
	call SetUnitPathing(Hero,false)
	call SaveUnitHandle(HY,h,14,Hero)
	call TimerStart(t,.2,true,function J3G)
	set Target=null
	set Projectile=null
	set t=null
	set HND =null
endfunction

function Spectre_SpectralDaggerWrap takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A0HW')//A0HW -> Spectral Dagger
	if GetUnitAbilityLevel(caster,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(caster),0) then//Aloc -> Locust
		set caster=LoadUnitHandle(HY,GetHandleId(caster),0)
	endif
	call Spectre_SpectralDagger(caster,lvl)
	set caster=null
endfunction

function Spectre_Dagger_Preload takes nothing returns nothing
	call CreateSound("Sounds\\Spectral Dagger.mp3",false,false,false,10,10,"DefaultEAXON")
	call PreloadQueryAdd('A0I2')//A0I2 -> Spectral Dagger aura2
	call PreloadQueryAdd('A0HY')//A0HY -> Spectral Dagger aura1
endfunction

function Spectre_Desolate_Filter takes nothing returns boolean
	return(IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and AliveNonBuildOrMarker(GetFilterUnit()))!=null//
endfunction

function Spectre_Desolate_act takes unit attacker, unit target returns nothing
	local group g=GetAvailableGroup()
	local real d=20*GetUnitAbilityLevel(attacker,'P338')
	call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),275,Condition(function Spectre_Desolate_Filter))
	call GroupRemoveUnit(g,target)
	if FirstOfGroup(g)==null then
		if IsUnitIllusion(attacker) or IsUnitType(attacker,UNIT_TYPE_MELEE_ATTACKER)==false then
			set d=0+10*GetUnitAbilityLevel(attacker,'P338')
			if GetUnitAbilityLevel(attacker,'B06L')>0then//B06L -> Illusion
				set d=d*0.75
			endif
		endif
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayTarget.mdl",target,"overhead"))
		call AddTimedKeyToUnit(attacker,4275,.3)
		call DamageTarget(attacker,target,3,d)
	endif
	call KillGroup(g)
	set g=null
endfunction

function Spectre_Desolate takes unit attacker, unit target returns nothing
	if GetUnitAbilityLevel(attacker,'P338')>0 and (IsUnitIllusion(attacker) or IsUnitType(attacker,UNIT_TYPE_MELEE_ATTACKER)) and GetUnitAbilityLevel(attacker,'A36D')==0 and LoadInteger(HY,GetHandleId(attacker),4275)!=1 and AliveNonBuildOrMarker(target) and target!=Roshan then
		call Spectre_Desolate_act(attacker,target)
	endif
endfunction

function Spectre_Dispersion_Spread takes nothing returns nothing
	local real d=DistanceBetweenUnits(GetTriggerUnit(),GetEnumUnit())-25
	local real multiplier=(1000-d)/700
	if multiplier>1. then
		set multiplier=1.
	endif
	if multiplier>0 then
		//set WL7[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]=true
		call DamageTarget(GetTriggerUnit(),GetEnumUnit(),11,KU8*multiplier)
		//set WL7[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]=false
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayDamage.mdl",GetEnumUnit(),"chest"))
	endif
endfunction

function Spectre_Dispersion_Act takes nothing returns boolean
	local unit Hero=GetTriggerUnit()
	local real Damage=GetEventDamage()
	local integer Level=GetUnitAbilityLevel(Hero,'A0NA')//A0NA -> Dispersion, QP20 -> Dispersion
	local group g
	local unit u
	local real d
	local real multiplier
	local real refdmg
	if IsDamageReal(Damage) and IsRealDamage and GetUnitAbilityLevel(Hero,'A36D')==0  then
		set g=GetAvailableGroup()
		if not(Mode_BO) and GetUnitPrimaryAttribute(Hero)==3 then
			set refdmg=Damage*(.06+.02*Level)
		else
			set refdmg=Damage*(.06+.04*Level)
		endif
		//call HealUnitFor(Hero,refdmg)
		set tt_unit1=Hero
		call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),1025,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			set d=DistanceBetweenUnits(Hero,u)-25
			set multiplier=(1000-d)/700
			if multiplier>1. then
				set multiplier=1.
			endif
			if multiplier>0 then
				call DamageTarget(Hero,u,11,refdmg*multiplier)
				call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayDamage.mdl",u,"chest"))
			endif
			call GroupRemoveUnit(g,u)
		endloop
		//call ForGroup(g,function Spectre_Dispersion_Spread)
		call KillGroup(g)
	endif
	set Hero=null
	set g=null
	return false
endfunction

function Spectre_Dispersion_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function Spectre_Dispersion_Act))
	set t=null
endfunction

function KDG takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local unit Hero=GetTriggerUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call SaveUnitHandle(HY,(GetHandleId(Caster)),387,(Target))
	call UnitAddAbility2(Caster,('A0N9'))//A0N9 -> Haunt Helper
	call SetUnitAbilityLevel(Caster,('A0N9'),GetUnitAbilityLevel(Hero,'A0H9'))//A0N9 -> Haunt Helper, A0H9 -> Haunt
	call IssueTargetOrderById(Caster,852274,Hero)

	set Target = null
	set Caster = null
	set Hero = null
endfunction

function KEG takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())))!=null
endfunction

function KFG takes nothing returns nothing
	local trigger trig = GetTriggeringTrigger()
	local integer h=GetHandleId(trig)
	local unit W39=(LoadUnitHandle(HY,h,386))
	local unit Target=(LoadUnitHandle(HY,h,387))
	local integer KGG=(LoadInteger(HY,h,385))
	if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		set KGG=KGG+1
		call SaveInteger(HY,h,385,(KGG))
	endif
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call DisableTrigger(GetTriggeringTrigger())
		call FlushChildHashtable(HY,(GetHandleId(trig)))
		call SaveInteger(HY,h,385,(KGG))
		if Target==GetTriggerUnit()then
			call KillUnit(W39)
		endif
		call CleanTrigger(trig)
	elseif IsUnitPaused(W39)==false then
		if GetIssuedOrderId()!=ORDER_stunned then
			if KGG==2 then
				call SetUnitVertexColor(W39,255,255,255,255)
			endif
			if KGG>1 then
				call DisableTrigger(trig)
				if DistanceBetweenUnits(W39,Target)<1200 then
					call IssueTargetOrderById(W39,ORDER_attack,Target)
				endif
				call EnableTrigger(trig)
			else
				call DisableTrigger(trig)
				if DistanceBetweenUnits(W39,Target)<1200 then
					call IssueTargetOrderById(W39,ORDER_move,Target)
				endif
				call EnableTrigger(trig)
			endif
		endif
	endif

	set Target = null
	set trig = null
	set W39 = null
endfunction

function KHG takes nothing returns boolean
	return GetUnitAbilityLevel(GetSummonedUnit(),'B06L')>0//B06L -> Illusion
endfunction

function KIG takes nothing returns nothing
	local unit Caster=GetSummoningUnit()
	local unit illus=GetSummonedUnit()
	local unit Target=LoadUnitHandle(HY,GetHandleId(Caster),387)
	local trigger t=CreateTrigger()
	call SaveUnitHandle(HY,GetHandleId(udg_Hero[GetPlayerId(GetOwningPlayer(Caster))]),7100+GetHandleId(illus),Target)
	call SetUnitPathing(illus,false)
	call SetUnitMoveSpeed(illus,400)
	call SetUnitX(illus,GetUnitX(Target))
	call SetUnitY(illus,GetUnitY(Target))
	call IssueTargetOrderById(illus,ORDER_move,Target)
	call SetUnitVertexColor(illus,255,255,255,50)
	call TriggerRegisterUnitEvent(t,illus,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterUnitEvent(t,illus,EVENT_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterDeathEvent(t,illus)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddAction(t,function KFG)
	call DestroyEffect(AddSpecialEffect("units\\nightelf\\SpiritOfVengeance\\SpiritOfVengeance.mdl",GetUnitX(illus),GetUnitY(illus)))
	call SaveUnitHandle(HY,GetHandleId(t),387,Target)
	call SaveUnitHandle(HY,GetHandleId(t),386,illus)
	call SaveInteger(HY,GetHandleId(t),385,0)
	call FlushChildHashtable(HY,GetHandleId(Caster))
	set Caster=null
	set illus=null
	set Target=null
	set t=null
endfunction

function Spectre_Haunt takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local sound s
	call UnitAddAbility2(GetTriggerUnit(),'A0HA')//A0HA -> Reality
	call SetUnitPathing(Hero,false)
	call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function KEG))
	call ForGroup(g,function KDG)
	call SetUnitPathing(Hero,true)
	if FirstOfGroup(g)!=null then
		set s=CreateSound("Abilities\\Spells\\Other\\ANsa\\SacrificeUnit.wav",false,false,false,10,10,"DefaultEAXON")
		call StartSound(s)
		call KillSoundWhenDone(s)
	endif
	call KillGroup(g)
	set g=null
	set Hero=null
endfunction

function Spectre_AddHaunt takes nothing returns nothing
	call UnitAddAbility2(GetTriggerUnit(),'A0HA')//A0HA -> Reality
endfunction

function Spectre_HauntReg takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function KHG))
	call TriggerAddAction(t,function KIG)
	call CreateSound("Abilities\\Spells\\Other\\ANsa\\SacrificeUnit.wav",false,false,false,10,10,"DefaultEAXON")
	call PreloadQueryAdd('A0N9')//A0N9 -> Haunt Helper
	set t = null
	
endfunction

function KOG takes nothing returns boolean
	return GetUnitAbilityLevel(GetFilterUnit(),('B06L'))>0//B06L -> Illusion
endfunction

function KPG takes nothing returns nothing
	local unit XX8
	local real YR8=YX8(GetEnumUnit(),GetSpellTargetLoc())
	if YR8<TmpReal378 then
		set TmpUnit376=GetEnumUnit()
		set TmpReal378=YR8
	endif
	set XX8=null
endfunction

function KQG takes nothing returns unit
	local group g=GetAvailableGroup()
	set TmpUnit376=null
	set TmpReal378=9999999
	call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(GetTriggerUnit()),Condition(function KOG))
	call ForGroup(g,function KPG)
	call KillGroup(g)
	set g=null
	return TmpUnit376
endfunction

function Spectre_Reality_DmgFunc takes nothing returns nothing
	if LoadInteger(HY,GetHandleId(GetEnumUnit()),'A0H9')!=1 then//A0H9 -> Haunt
		call AddTimedKeyToUnit(GetEnumUnit(),'A0H9',6)//A0H9 -> Haunt
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\SpiritLink\\SpiritLinkZapTarget.mdl",GetEnumUnit(),"chest"))
		call DamageTarget(RealityTempUnit,GetEnumUnit(),1,GetUnitAbilityLevel(RealityTempUnit,'A0H9')*50+50)//A0H9 -> Haunt
	endif
endfunction

function Spectre_Reality_AoEDamage takes unit hero, unit illus returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=hero
	call GroupEnumUnitsInRange(g,GetUnitX(illus),GetUnitY(illus),375,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	set RealityTempUnit=hero
	call ForGroup(g,function Spectre_Reality_DmgFunc)
	call KillGroup(g)
	set g=null
endfunction

function Spectre_Reality takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=KQG()
	local unit HYD=(LoadUnitHandle(HY,(GetHandleId(Hero)),(7100+GetHandleId(Target))))
	local real TargetX
	local real TargetY
	if Target==null then
		call Error(GetOwningPlayer(Hero),GetObjectName('n03Z'))//n03Z -> Cannot find any of your Haunting illusions
	else
		set TargetX=GetUnitX(Target)
		set TargetY=GetUnitY(Target)
		call Spectre_Reality_AoEDamage(Hero,Target)
		call SetUnitX(Target,GetUnitX(Hero))
		call SetUnitY(Target,GetUnitY(Hero))
		call SetUnitX(Hero,TargetX)
		call SetUnitY(Hero,TargetY)
		//call KillUnit(Target)
		if DistanceBetweenXY(GetCameraEyePositionX(),GetCameraEyePositionY(),TargetX,TargetY)>1400 then
			call PanCameraToTimedForPlayer(GetOwningPlayer(Hero),TargetX,TargetY,0)
		endif
		call IssueTargetOrderById(Hero,ORDER_attack,HYD)
	endif
	set Hero=null
	set Target=null
	set HYD=null
endfunction

function Spiritbreaker_GreaterBash_Pushing takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit target=(LoadUnitHandle(HY,h,17))
	local unit caster=(LoadUnitHandle(HY,h,2))
	local real angle=(LoadReal(HY,h,13))
	local real x=GetUnitX(target)
	local real y=GetUnitY(target)
	local integer count=GetTriggerEvalCount(t)
	local real dist=LoadReal(HY,h,193)
	local integer limit=(LoadInteger(HY,h,12))
	local integer i
	if count>35 then
		call SaveReal(HY,h,193,dist*0.98)
	endif
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or count>limit then
		set i = LoadInteger(MHT,h,'A0G5')-1//A0G5 -> Greater Bash
		call SaveInteger(MHT,h,'A0G5',i)//A0G5 -> Greater Bash
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",x,y))
		call KillTrees(x,y,150)
		set x=SafeX50(x+dist*Cos(angle))
		set y=SafeY50(y+dist*Sin(angle))
		if(IsPointInRegion(RestrictedRegion,((x)*1.0),((y)*1.0)))==false then
			if IsUnitType(target,UNIT_TYPE_HERO)then
				call SaveBoolean(HeroStats,GetHandleId(target),99,true)
			endif
			call SetUnitX(target,x)
			call SetUnitY(target,y)
		endif
		if count==1 and LoadBoolean(HY,h,0) then
			call IssueTargetOrder(caster,"attack",target)
		endif
	endif
	set t=null
	set target=null
	set caster=null
	return false
endfunction

function Spiritbreaker_Greaterbash_Start takes unit caster, unit target, integer level, boolean attack returns nothing
	local trigger t
	local integer h
	call UnitAddAbilityTimedExF(caster,'A24G',1,3,'B0EC')
	if target==Roshan then
		return
	endif
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.01,true)
	call TriggerRegisterDeathEvent(t,target)
	call TriggerAddCondition(t,Condition(function Spiritbreaker_GreaterBash_Pushing))
	call SaveInteger(HY,h,12,80+20*level)//1,1.2,1.4,1.6
	call SaveUnitHandle(HY,h,2,caster)
	call SaveUnitHandle(HY,h,17,target)
	call SaveBoolean(HY,h,0,attack)
	call SaveReal(HY,h,193,2.0)
	call SaveReal(HY,h,13,Atan2(GetUnitY(target)-GetUnitY(caster),GetUnitX(target)-GetUnitX(caster)))
	call DamageTarget(caster,target,1,GetUnitMoveSpeedLOD(caster)*0.1*level)
	call SaveInteger(MHT,GetHandleId(caster),'A0G5',LoadInteger(MHT,GetHandleId(caster),'A0G5')+1)//A0G5 -> Greater Bash, A0G5 -> Greater Bash
	set t=null
endfunction

function Spiritbreaker_Greaterbash_Cast takes unit u, unit t, boolean b, integer i returns nothing
	//types: 1=greater bash itself, 2=ulti's strike, 3=charge
	local unit d 
	local integer level
	if GetUnitAbilityLevel(u,'A36D')==1 then
		return
	endif
	set level=GetUnitAbilityLevel(u,'A0G5')//A0G5 -> Greater Bash, QP1X -> Greater Bash
	set d=CreateUnit(GetOwningPlayer(t),'e00E',GetUnitX(t),GetUnitY(t),0)//e00E -> Spellcaster
	if level==0 then
		if i==2 then
			set level=4
		elseif i==3 then
			set level=GetUnitAbilityLevel(u,'A1P8')//A1P8 -> Charge of Darkness
		endif
	endif
	call UnitAddAbility(d,'A1WQ')//A1WQ -> Greater Bash Stun
	call SetUnitAbilityLevel(d,'A1WQ',level)//A1WQ -> Greater Bash Stun

	if t==Roshan or IssueTargetOrderById(d,852095,t) then
		call Spiritbreaker_Greaterbash_Start(u,t,level,b)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile_mini.mdl",u,GetProperAttachPoint_Weapon(u)))
	endif
	call KillUnit(d)
	set d = null
endfunction

function GreaterBash_Apply takes unit attacker, unit target returns nothing
	if IsUnitIllusion(attacker)==false and (Mode_BO or LoadReal(MHT,GetHandleId(attacker),'A0G5')<TimerGetElapsed(GlobalTimer)) then//n00L -> Roshan, A0G5 -> Greater Bash
		if GetUnitAbilityLevel(attacker,'A36D')==0 and GetUnitAbilityLevel(attacker,'A3L2')==0 and PRD_Get(attacker,'A0G5',17) then//A0G5 -> Greater Bash
			call SaveReal(MHT,GetHandleId(attacker),'A0G5',TimerGetElapsed(GlobalTimer)+1.5)//A0G5 -> Greater Bash
			call Spiritbreaker_Greaterbash_Cast(attacker,target,true,1)
		endif
	endif
endfunction

function Spiritbreaker_Charge_Retargets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local unit u = group_temp_unit[0]
	local real x1
	local real y1
	local real x2
	local real y2
	local real distance

	if IsUnitEnemy(u,GetOwningPlayer(t)) and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitVisibleLoD(t,GetOwningPlayer(u)) and IsDead(t)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) and IsMagicImmune(t)==false then//
		set u = group_temp_unit[2]
		set x1 = GetWidgetX(u)
		set y1 = GetWidgetY(u)
		set x2 = GetWidgetX(t)
		set y2 = GetWidgetY(t)
		set distance = SquareRoot((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))

		if group_temp_real[0] > distance then
			set group_temp_unit[1] = t
			set group_temp_real[0] = distance
		endif
	endif
	set t = null
	set u = null
	return false
endfunction

function Spiritbreaker_Charge_Retarget takes unit u, unit t, integer i returns boolean
	local string s = ""

	set group_temp_unit[0] = u
	set group_temp_unit[1] = null
	set group_temp_unit[2] = t
	set group_temp_real[0] = 99999.0

	call GroupEnumUnitsInRange(temp_group,GetWidgetX(t),GetWidgetY(t),4000,Condition(function Spiritbreaker_Charge_Retargets))

	if group_temp_unit[1]==null then
		call IssueImmediateOrder(u,"stop")
		return true
	endif
	if group_temp_unit[1]!=null then
		//call UnitShareVision(group_temp_unit[1],GetOwningPlayer(u),true)
		call UnitAddAbility2(group_temp_unit[1],'A315')
		call ShareVision(group_temp_unit[1],u,'A315')
		call SaveUnitHandle(MHT,GetHandleId(u),StringHash("ChargedUnit"),group_temp_unit[1])
	endif
	if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(u))or IsObserver(GetLocalPlayer())then
		set s="Abilities\\Spells\\Other\\HowlOfTerror\\HowlTarget.mdl"
	endif

	call DestroyEffect(LoadEffectHandle(MHT,i,5))
	call DestroyEffect(LoadEffectHandle(MHT,i,4))

	call SaveEffectHandle(MHT,i,4,AddSpecialEffectTarget(s,group_temp_unit[1],"overhead"))
	call SaveEffectHandle(MHT,i,5,AddSpecialEffectTarget(s,group_temp_unit[1],"overhead"))

	call SaveUnitHandle(MHT,i,1,group_temp_unit[1])
	//call UnitShareVision(group_temp_unit[2],GetOwningPlayer(u),false)
	call UnitRemoveAbility(group_temp_unit[2],'A315')
	return false
endfunction

function Spiritbreaker_Charge_End takes timer t, unit u, unit target, integer info returns nothing
	call SetUnitTimeScale(u,1)
	call SetUnitPathing(u,true)
	call SetUnitAnimation(u,"stand")
	call SetTint(u,-1,-1,-1,255)
	if LoadUnitHandle(MHT,GetHandleId(u),StringHash("ChargedUnit"))!=null then
		call UnitRemoveAbility(LoadUnitHandle(MHT,GetHandleId(u),StringHash("ChargedUnit")),'A315')
	endif
	call UnitRemoveAbility(target,'A315')
	call SaveBoolean(MHT,GetHandleId(u),'A1P8',false)//A1P8 -> Charge of Darkness

	call DestroyEffect(LoadEffectHandle(MHT,info,5))
	call DestroyEffect(LoadEffectHandle(MHT,info,4))
	call DestroyEffect(LoadEffectHandle(MHT,info,3))
	call KillGroup(LoadGroupHandle(MHT,info,2))

	call Timer_End(t)
endfunction

function Spiritbreaker_Charge_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local unit u = group_temp_unit[0]
	local group g = LoadGroupHandle(MHT,group_temp_integer[0],2)

	if IsUnitEnemy(u,GetOwningPlayer(t)) and IsUnitInGroup(t,g)==false and t!=group_temp_unit[1] and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsDead(t)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then//
		call GroupAddUnit(g,t)
		call Spiritbreaker_Greaterbash_Cast(u,t,false,3)
	endif

	set t = null // reverse gut E:
	set u = null
	set g = null
	return false
endfunction

function Spiritbreaker_Charge_Duration takes nothing returns nothing
	local timer time = GetExpiredTimer()
	local integer info = GetHandleId(time)
	local unit u = LoadUnitHandle(MHT,info,0)
	local unit t = LoadUnitHandle(MHT,info,1)
	local real x1 = GetWidgetX(u)
	local real y1 = GetWidgetY(u)
	local real distance
	local real angle
	local real speed
	local real x2
	local real y2
	if LoadBoolean(MHT,GetHandleId(u),'A1P8')==false  or (IsDead(t) and Spiritbreaker_Charge_Retarget(u,t,info))then//A1P8 -> Charge of Darkness
		call Spiritbreaker_Charge_End(time,u,t,info)
		//call KillTrees(x1,y1,200)
		set time = null
		set t = null
		set u = null
		return
	endif
	set x2 = GetWidgetX(t)
	set y2 = GetWidgetY(t)
	set speed = LoadReal(MHT,info,0)
	set distance = SquareRoot((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))
	if 100 > distance then
		call Spiritbreaker_Charge_End(time,u,t,info)
		call IssueTargetOrder(u,"attack",t)
		call SetUnitAnimation(u,"attack")
		call Spiritbreaker_Greaterbash_Cast(u,t,true,3)
		//call KillTrees(x1,y1,200)
		set u=CreateUnit(GetOwningPlayer(t),'e00E',GetWidgetX(t),GetWidgetY(t),0)//e00E -> Spellcaster
		call StunTargetLoD(u,(0.4*LoadInteger(MHT,info,0))+0.8)
		set time = null
		set t = null
		set u = null
		return
	endif
	set angle = Atan2(y2-y1,x2-x1)
	set group_temp_integer[0] = info
	set x2 = x1 + speed*Cos(angle)
	set y2 = y1 + speed*Sin(angle)
	set group_temp_unit[0] = u
	set group_temp_unit[1] = t

	call SetUnitFacing(u,angle*bj_RADTODEG)
	call SetUnitX(u,x2)
	call SetUnitY(u,y2)

	call GroupEnumUnitsInRange(temp_group,x2,y2,325,Condition(function Spiritbreaker_Charge_Targets))

	set time = null
	set t = null
	set u = null
endfunction

function Spiritbreaker_Charge_Stop takes nothing returns nothing
	local unit target=LoadUnitHandle(MHT,GetHandleId(GetTriggerUnit()),StringHash("ChargedUnit"))
	call SaveBoolean(MHT,GetHandleId(GetTriggerUnit()),'A1P8',false)//A1P8 -> Charge of Darkness
	call UnitRemoveAbility(target,'A315')
	set target=null
endfunction

function Spiritbreaker_Charge_Start takes unit caster, integer level returns nothing
	local timer time = CreateTimer()
	local unit target = GetSpellTargetUnit()
	local integer info = GetHandleId(time)
	local integer save = GetHandleId(caster)
	local string s=""
	if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(caster))or IsObserver(GetLocalPlayer())then
		set s="Abilities\\Spells\\Other\\HowlOfTerror\\HowlTarget.mdl"
		call PingMinimapEx(GetWidgetX(target),GetWidgetY(target),2,255,255,255,false)
	endif
	call SetUnitPathing(caster,false)
	call SetUnitTimeScale(caster,2.5)
	call SetUnitAnimationByIndex(caster,LoadInteger(MHT,GetUnitTypeId(caster),'A1P8'))//A1P8 -> Charge of Darkness
	call SetTint(caster,-1,-1,-1,100)
	call UnitAddAbility2(target,'A315')
	call ShareVision(target,caster,'A315')
	call SaveBoolean(MHT,save,'A1P8',true)//A1P8 -> Charge of Darkness
	call SaveUnitHandle(MHT,info,0,caster)
	call SaveUnitHandle(MHT,info,1,target)
	call SaveUnitHandle(MHT,GetHandleId(caster),StringHash("ChargedUnit"),target)
	call SaveGroupHandle(MHT,info,2,GetAvailableGroup())
	call SaveEffectHandle(MHT,info,3,AddSpecialEffectTarget("war3mapImported\\ShockwaveMissilePurple.mdx",caster,"origin"))
	call SaveEffectHandle(MHT,info,4,AddSpecialEffectTarget(s,target,"overhead"))
	call SaveEffectHandle(MHT,info,5,AddSpecialEffectTarget(s,target,"overhead"))
	call SaveInteger(MHT,info,0,level)
	call SaveReal(MHT,info,0,level*1.25 + 13.75)
	call TimerStart(time,0.025,true,function Spiritbreaker_Charge_Duration)
	set caster = null
	set target = null
	set time = null
endfunction

function Spiritbreaker_Charge_StartWrap takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A1P8')//A1P8 -> Charge of Darkness
	if GetUnitAbilityLevel(caster,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(caster),0) then//Aloc -> Locust
		set caster=LoadUnitHandle(HY,GetHandleId(caster),0)
	endif
	if IsBlocked(GetSpellTargetUnit())==false then
		call Spiritbreaker_Charge_Start(caster,lvl)
	endif
	set caster=null
endfunction

function Spiritbreaker_Charge_Learn takes nothing returns nothing
	call SetPlayerAbilityAvailable2(GetOwningPlayer(GetTriggerUnit()),'A179',false)//A179 -> Spell Immunity
endfunction

function Spiritbreaker_EmpoweringHaste_Periodic takes nothing returns nothing
	local integer i=1
	local integer prevbonus
	local integer newbonus
	local unit u
	loop
		set u=udg_Hero[i]
		if GetUnitAbilityLevel(u,'P310')>0 and u!=null and IsDead(u)==false and IsHeroDead[i]==false then
			set prevbonus=LoadInteger(MHT,GetHandleId(u),'P310')
			set newbonus=R2I(0.03*GetUnitAbilityLevel(u,'P310')*GetUnitMoveSpeedLOD(u))
			if prevbonus!=newbonus then
				if prevbonus>newbonus then
					call LoDStat_Sub(u,prevbonus-newbonus,"damage")
					call SaveInteger(MHT,GetHandleId(u),'P310',newbonus)
				else
					call LoDStat_Add(u,newbonus-prevbonus,"damage")
					call SaveInteger(MHT,GetHandleId(u),'P310',newbonus)
				endif
			endif
		endif
		set i=i+1
		if i==6 then
			set i=7
		endif
		exitwhen i>11
	endloop
	set u=null
endfunction

function Spiritbreaker_EmpoweringHaste takes nothing returns nothing
	call TimerStart(CreateTimer(),0.5,true,function Spiritbreaker_EmpoweringHaste_Periodic)
endfunction

function Spiritbreaker_EmpoweringHaste_PostEnd takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer lvl=LoadInteger(HY,h,0)
	call UnitRemoveAbility(u,'A44L')
	call UnitRemoveAbility(u,'B03Y')//B03Y -> Empowering Haste
	call SetPlayerAbilityAvailable(GetOwningPlayer(u),'P310',true)
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set u=null
	set t=null
endfunction

function SBAuraTick2 takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	call UnitRemoveAbility(u,'A44M')
	call UnitRemoveAbility(u,'B44M')//B44M -> Empowering Haste Overheat
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set u=null
	set t=null
endfunction

function SBAuraTick1 takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	call UnitRemoveAbility(u,'A44K')
	call UnitRemoveAbility(u,'B44K')//B44K -> |c0003ff00Empowering Haste Turbo|r
	if IsDead(u)==false then
		call UnitAddAbility3(u,'A44M',GetUnitAbilityLevel(u,'A0ES'))//A0ES -> Empowering Haste
		call TimerStart(t,6,false,function SBAuraTick2)
	else
		call FlushChildHashtable(HY,h)
		call DestroyTimer(t)
	endif
	set u=null
	set t=null
endfunction

function Spiritbreaker_EmpoweringHaste_Act takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local unit u=GetTriggerUnit()
	call TimerStart(t,6,false,function SBAuraTick1)
	call SaveUnitHandle(HY,h,0,u)
	call UnitAddAbility3(u,'A44K',GetUnitAbilityLevel(u,'A0ES'))//A0ES -> Empowering Haste
	set u=null
	set t=null
endfunction

function M7G takes unit Source,unit Target returns nothing
	call Spiritbreaker_Greaterbash_Cast(Source,Target,true,2)
endfunction

function M8G takes nothing returns nothing
	call Spiritbreaker_Greaterbash_Cast(K38,GetEnumUnit(),false,2)
endfunction

function M9G takes unit Source,unit Targer returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	set K38=Source
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),275,Condition(function DefaultEnemyFilterWithAncients))
	call ForGroup(g,function M8G)
	call KillGroup(g)
	set g=null
endfunction

function MDG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Count=GetTriggerEvalCount(t)
	local integer MEG
	local integer Level
	local real a
	local real LastX=(LoadReal(HY,h,23))
	local real LastY=(LoadReal(HY,h,24))
	local real x=GetUnitX(Target)
	local real y=GetUnitY(Target)
	local real d=DistanceBetweenXY(x,y,LastX,LastY)
	call SaveReal(HY,h,23,((x)*1.))
	call SaveReal(HY,h,24,((y)*1.))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or d>1800 or Count>100 then
		call SetTint(Source,-1,-1,-1,255)
		call UnitRemoveAbility(Target,'A314')
		call UnitRemoveAbility(Source,'A179')//A179 -> Spell Immunity
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set MEG=50+Count*2
		call SetTint(Source,-1,-1,-1,MEG)
		if Count==1 then
			set Level=(LoadInteger(HY,h,5))
			set a=Atan2(GetUnitY(Target)-GetUnitY(Source),GetUnitX(Target)-GetUnitX(Source))
			call SetUnitPosition(Source,GetUnitX(Target)+80*Cos(a),GetUnitY(Target)+80*Sin(a))
			call SetUnitAnimation(Source,"attack")
			call IssueTargetOrderById(Source,ORDER_attack,Target)
			if LoadBoolean(HY,h,0) then
				call M9G(Source,Target)
			else
				call M7G(Source,Target)
			endif
			call DamageTarget(Source,Target,1,50+100*Level)
			if GetUnitAbilityLevel(Target,'A3E9')==1 and IsDead(Target)==false and IsDead(Source)==false then
				call SaveUnitHandle(TempHash,'A3E9',0,Target)
				call SaveUnitHandle(TempHash,'A3E9',1,Source)
				call SaveInteger(TempHash,'A3E9',0,LoadInteger(HY,h,4))
				call SaveInteger(TempHash,'A3E9',0,Level)
				call ExecuteFunc("Spiritbreaker_NetherStrikeLotus")
			endif
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function MFG takes unit Source, unit Target, integer aid, integer Level returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local boolean b=aid=='A1D8'//A1D8 -> Nether Strike Upgrade
	call UnitAddAbility2(Target,'A314')
	call ShareVision(Target,Source,'A314')
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,5,(Level))
	call SaveInteger(HY,h,4,aid)
	call SaveBoolean(HY,h,0,b)
	call SaveReal(HY,h,23,((GetUnitX(Target))*1.))
	call SaveReal(HY,h,24,((GetUnitY(Target))*1.))
	call TriggerRegisterTimerEvent(t,.01,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function MDG))
	if b then
		call UnitAddAbility2(Source,'A179')//A179 -> Spell Immunity
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A179',false)//A179 -> Spell Immunity
	endif
	set t=null
endfunction

function Spiritbreaker_NetherStrike takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer aid=GetSpellAbilityId()
	local integer lvl=GetUnitAbilityLevel(caster,aid)
	if GetUnitAbilityLevel(caster,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(caster),0) then//Aloc -> Locust
		set caster=LoadUnitHandle(HY,GetHandleId(caster),0)
	endif
	if IsBlocked(GetSpellTargetUnit())==false then
		call MFG(caster,GetSpellTargetUnit(),aid,lvl)
	endif
	set caster=null
endfunction

function Spiritbreaker_NetherStrikeLotus takes nothing returns nothing
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	if IsBlocked(target)==false then
		call MFG(LoadUnitHandle(TempHash,'A3E9',0),target,LoadInteger(TempHash,'A3E9',0),LoadInteger(TempHash,'A3E9',1))
	else
		call RemoveLinkenBuff(target)
	endif
	set target=null
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function MJG takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real MKG=(LoadReal(HY,h,295))
	local real MMG=(LoadReal(HY,h,296))
	local integer Level=LoadInteger(HY,h,2)
	local real MNG=.25
	if GetSpellTargetUnit()==Source then
		call AddTimedKeyToUnit(Source,'AFRZ',0.03)
		call SetWidgetLife(Source,RMaxBJ(GetUnitState(Source,UNIT_STATE_MAX_LIFE)*MMG*.01,GetUnitState(Source,UNIT_STATE_MAX_LIFE)*MNG))
	endif
	if GetSpellTargetUnit()==Target and GetWidgetLife(Target)>0.5 then
		call AddTimedKeyToUnit(Target,'AFRZ',0.03)
		call SetUnitLifePercentBJ(Target,MKG)
		if GetUnitLifePercent(Target)<25 then
			call SetUnitLifePercentBJ(Target,25.)
		endif
	endif
	if GetTriggerEvalCount(t)==2 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set Source=null
	set Target=null
	set t=null
endfunction

function MOG takes nothing returns boolean
	if GetSpellAbilityId()=='A07R' then//A07R -> Sunder projectile enemy
		call MJG()
	endif
	return false
endfunction

function TB_Sunder takes unit Source, integer lvl returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Target=GetSpellTargetUnit()
	local unit Caster
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,2,lvl)
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveReal(HY,h,295,((GetUnitLifePercent(Source))*1.))
	call SaveReal(HY,h,296,((GetUnitLifePercent(Target))*1.))
	call TriggerAddCondition(t,Condition(function MOG))
	set Caster=CreateUnit(GetOwningPlayer(Target),'e00Y',GetUnitX(Target),GetUnitY(Target),0)//e00Y -> Spellcaster #2
	call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_SPELL_EFFECT)
	call UnitAddAbility2(Caster,'A07R')//A07R -> Sunder projectile enemy
	call IssueTargetOrderById(Caster,852095,Source)
	call ShowUnit(Caster,false)
	call SetUnitPathing(Caster,false)
	call SetUnitInvulnerable(Caster,true)
	call UnitApplyTimedLife(Caster,'BTLF',.2)
	set Caster=CreateUnit(GetOwningPlayer(Source),'e00Y',GetUnitX(Source),GetUnitY(Source),0)//e00Y -> Spellcaster #2
	call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_SPELL_EFFECT)
	call UnitAddAbility2(Caster,'A07R')//A07R -> Sunder projectile enemy
	call IssueTargetOrderById(Caster,852095,Target)
	call ShowUnit(Caster,false)
	call SetUnitPathing(Caster,false)
	call SetUnitInvulnerable(Caster,true)
	call UnitApplyTimedLife(Caster,'BTLF',.2)
	set t=null
	set Target=null
	set Caster=null
endfunction

function TB_SunderWrapper takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
	if GetUnitAbilityLevel(caster,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(caster),0) then//Aloc -> Locust
		set caster=LoadUnitHandle(HY,GetHandleId(caster),0)
	endif
	if IsBlocked(GetSpellTargetUnit())==false then
		call TB_Sunder(caster,lvl)
	endif
	set caster=null
endfunction

function Terrorblase_Reflection_Duration takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local unit d = LoadUnitHandle(MHT,info,0)
	local unit u = LoadUnitHandle(MHT,info,1)

	if IsDead(u) or IsDead(d)then
		call DestroyEffect(LoadEffectHandle(MHT,info,2))
		call KillUnit(d)
		call Timer_End(t)
	endif

	call IssueTargetOrder(d,"attack",u)

	set d = null
	set u = null
	set t = null
endfunction

function Terrorblase_Reflection_Illusion takes nothing returns nothing
	local integer load = GetHandleId(GetTriggerUnit())
	local unit d = GetSummonedUnit()
	local unit u = LoadUnitHandle(MHT,load,0)
	local timer t = LoadTimerHandle(MHT,load,1)
	local integer info = GetHandleId(t)
	call SetUnitMoveSpeed(d,522)
	call UnitAddAbility(d,'Aloc')//Aloc -> Locust
	call SetUnitOwner(d,LoadPlayerHandle(MHT,load,2),false)
	call IssueTargetOrder(d,"attack",u)
	call SetUnitX(d,GetWidgetX(u) + 100*Cos(GetRandomReal(-1.8,1.8)))
	call SetUnitY(d,GetWidgetY(u) + 100*Sin(GetRandomReal(-1.8,1.8)))

	call SaveUnitHandle(MHT,info,0,d)
	call SaveUnitHandle(MHT,info,1,u)
	call SaveEffectHandle(MHT,info,2,AddSpecialEffectTarget("war3mapImported\\UnholyPresence.mdx",u,"overhead"))

	call TimerStart(t,0.2,true,function Terrorblase_Reflection_Duration)
	call FlushChildHashtable(MHT,load)

	set t = null
	set u = null
	set d = null
endfunction

//function Terrorblade_Reflection_Start takes nothing returns nothing
//	local unit u = GetTriggerUnit()
//	local unit t = GetSpellTargetUnit()
//	local unit d = CreateUnit(GetOwningPlayer(u),'e00E',0,0,0)//e00E -> Spellcaster
//	local timer time = CreateTimer()
//	local integer info = GetHandleId(d)
//	set TempInteger=GetPlayerId(GetOwningPlayer(t))
//	call Buff_Add(t,'C016','D016',5)
//	call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_SUMMON)
//	call SaveUnitHandle(MHT,info,0,t)
//	call SaveTimerHandle(MHT,info,1,time)
//	call SavePlayerHandle(MHT,info,2,GetOwningPlayer(u))
//	call SaveInteger(MHT,info,'SPEL','A24K') //used to detected illusion spells//A24K -> Reflection Image
//	call UnitAddAbility(d,'A24K')//A24K -> Reflection Image
//	call SetUnitAbilityLevel(d,'A24K',GetUnitAbilityLevel(u,'A2KZ'))//A24K -> Reflection Image, A2KZ -> Reflection
//	call IssueTargetOrderById(d,852274,t)
//	set time = null //look, not the usual order of nulling :O
//	set d = null
//	set t = null
//	set u = null
//endfunction

function ReflectionHeroFilter takes nothing returns boolean
	return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit())) and AliveNonBuildOrMarker(GetFilterUnit()) and IsMagicImmune(GetFilterUnit())==false and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1))
endfunction

function Terrorblade_Reflection_Start takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit u//=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A2KZ')//A2KZ -> Reflection
	local unit d
	local trigger t
	local integer h
	local group g=GetAvailableGroup()
	set tt_unit1=caster
	call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),925,Condition(function ReflectionHeroFilter))
	
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call UnitAddAbilityTimedExF(u,'A26T',1,1.5+lvl,'B0EJ')//A26W -> Soulsteal Container - Level 4, B0EJ -> Soulsteal
		set d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
		call SaveInteger(MHT,GetHandleId(d),'SPEL','A24K') //used to detected illusion spells//A24K -> Reflection Image
		call SaveUnitHandle(MHT,GetHandleId(d),0,u)
		call SaveTimerHandle(MHT,GetHandleId(d),1,CreateTimer())
		call SavePlayerHandle(MHT,GetHandleId(d),2,GetOwningPlayer(caster))
		call UnitAddAbility2(d,'A24K')//A24K -> Reflection Image
		call SetUnitAbilityLevel(d,'A24K',lvl)//A24K -> Reflection Image
		call SaveUnitHandle(HY,GetHandleId(d),'0ILU',u)
		call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_SUMMON)
		call IssueTargetOrderNoLinken(d,852274,u)
		set d=null
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
	call PlaySoundAtPos(sound068,GetUnitX(caster),GetUnitY(caster))
	set caster=null
	set u=null
	set d=null
	set t=null
	set caster=null
endfunction

function TB_SoulSteal_Clear takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local unit target=(LoadUnitHandle(HY,h,17))
	local unit d=(LoadUnitHandle(HY,h,19))
	local integer lvl=(LoadInteger(HY,h,5))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)>28or IsUnitSilenced(caster)or DistanceBetweenUnits(caster,target)>600 or IsUnitVisibleLoD(target,GetOwningPlayer(caster))==false then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(d)
	elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if GetTriggerEvalCount(t)>1 and GetSpellAbilityId()=='A1RA' then//A1RA -> Soulsteal End
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call UnitRemoveAbility(caster,'A1RA')//A1RA -> Soulsteal End
			call KillUnit(d)
		endif
	else
		if IsUnitEnemy(caster,GetOwningPlayer(target))then
			call SetWidgetLife(caster,GetWidgetLife(caster)+lvl*20.0/4.0)
		else
			call SetWidgetLife(target,GetWidgetLife(target)+lvl*20.0/4.0)
		endif
	endif
	set t=null
	set caster=null
	set target=null
	set d=null
	return false
endfunction

function TB_SoulSteal_Moves takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local unit target=(LoadUnitHandle(HY,h,17))
	local unit d=(LoadUnitHandle(HY,h,19))
	local boolean b=HaveSavedHandle(HY,h,21)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call UnitRemoveAbility(caster,'A1RA')//A1RA -> Soulsteal End
		if b then
			call RemoveUnit(LoadUnitHandle(HY,h,21))
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if GetTriggerEvalCount(t)==1 then
			call IssueImmediateOrderById(caster,851993)
		endif
		if IsUnitEnemy(caster,GetOwningPlayer(target)) then
			call SetUnitX(d,GetUnitX(caster))
			call SetUnitY(d,GetUnitY(caster))
			call SetUnitX(LoadUnitHandle(HY,h,21),GetUnitX(target))
			call SetUnitY(LoadUnitHandle(HY,h,21),GetUnitY(target))
		else
			call SetUnitX(d,GetUnitX(target))
			call SetUnitY(d,GetUnitY(target))
		endif
	endif
	set t=null
	set caster=null
	set target=null
	set d=null
	return false
endfunction

function TB_SoulSteal_Start takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A1PH')//A1PH -> Soul Steal
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit d
	
	if GetUnitTypeId(caster)=='e00E' then
		if HaveSavedHandle(HY,GetHandleId(caster),0) then
			set caster=LoadUnitHandle(HY,GetHandleId(caster),0)
		else
			set caster=udg_Hero[GetPlayerId(GetOwningPlayer(caster))]
		endif
	endif
	if IsUnitEnemy(caster,GetOwningPlayer(target)) then
		set d=CreateUnit(GetOwningPlayer(caster),'u01G',0,0,0)//u01G -> Soulsteal Dummy
		call UnitAddAbility(d,'A04L')//A04L -> Soul Steal
		call SetUnitAbilityLevel(d,'A04L',lvl)//A04L -> Soul Steal
		call SetUnitX(d,GetUnitX(caster))
		call SetUnitY(d,GetUnitY(caster))
		call IssueTargetOrderById(d,852487,target)
	else
		call UnitAddAbility2(caster,'A1RA')//A1RA -> Soulsteal End
		set d=CreateUnit(Neutrals,'u01G',0,0,0)//u01G -> Soulsteal Dummy
		call SetUnitUserData(d,GetPlayerId(GetOwningPlayer(caster)))
		call UnitAddAbility(d,'A04L')//A04L -> Soul Steal
		call SetUnitAbilityLevel(d,'A04L',lvl)//A04L -> Soul Steal
		call SetUnitX(d,GetUnitX(target))
		call SetUnitY(d,GetUnitY(target))
		call IssueTargetOrderNoLinken(d,852487,caster)
	endif
	call TriggerRegisterTimerEvent(t,0.25,true)
	call TriggerRegisterDeathEvent(t,caster)
	call TriggerRegisterDeathEvent(t,target)
	call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function TB_SoulSteal_Clear))
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveUnitHandle(HY,h,17,(target))
	call SaveUnitHandle(HY,h,19,(d))
	call SaveInteger(HY,h,5,(lvl))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.01,true)
	call TriggerRegisterDeathEvent(t,d)
	call TriggerAddCondition(t,Condition(function TB_SoulSteal_Moves))
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveUnitHandle(HY,h,17,(target))
	call SaveUnitHandle(HY,h,19,(d))
	if IsUnitEnemy(target,GetOwningPlayer(caster)) then
		call SaveUnitHandle(HY,h,21,CreateUnit(GetOwningPlayer(caster),'hBST',GetUnitX(target),GetUnitY(target),0))
	endif
	set caster=null
	set target=null
	set t=null
	set d=null
endfunction

function TB_SoulSteal takes nothing returns boolean
	if GetUnitTypeId(GetSpellTargetUnit())!='n00L' and(IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))or(IsBlocked(GetSpellTargetUnit())==false))then//n00L -> Roshan
		call TB_SoulSteal_Start()
	endif
	return false
endfunction

function TB_ConjureImage takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(caster,'A0H4')//A0H4 -> Conjure Image
	local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
	if GetUnitTypeId(caster)=='e00E' then//e00E -> Spellcaster
		set caster=udg_Hero[GetPlayerId(GetOwningPlayer(caster))]
	endif
	call UnitAddAbility(d,'A2JN')//A2JN -> Conjure Image
	call SetUnitAbilityLevel(d,'A2JN',Level)//A2JN -> Conjure Image
	call IssueTargetOrderById(d,852274,caster)
	set d = null
	set caster = null
endfunction

function TB_ConjureImage_Leveled takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(u,'A0H4')//A0H4 -> Conjure Image
	local integer id='A275'+lvl
	if lvl==1 then
		call UnitAddAbility2(u,'A33N')
	else
		call SetUnitAbilityLevel(u,'A33N',lvl)
		call UnitRemoveAbility(u,id-1)//remove prev hp regen
	endif
	call UnitAddAbility2(u,id)
	set u=null
endfunction

function Func3585 takes nothing returns nothing
	local unit caster=tt_unit1
	local unit target=tt_unit2
	local integer lvl=GetUnitAbilityLevel(caster,'A046')//A046 -> Gush
	call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",target,"chest"))
	call UnitAddAbilityTimedExF(target,'A3JR',lvl,4,0)
	call UnitAddAbilityTimedExF(target,'A3JS',1,4,'B3JS')//B3EI -> Gush
	call DamageTarget(caster,target,1,60.00+lvl*50.00)
	set caster=null
	set target=null
endfunction

function Tidehunter_Gush takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call AddProjectile(GetTriggerUnit(),GetSpellTargetUnit(),'h0EN',"Func3585",4000,false)//h0EN -> Glimmer Cape
	endif
endfunction

function N4G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=GetEventDamageSource()
	local real d=GetEventDamage()
	local real dmgStored=LoadReal(HY,h,412)
	local real time=LoadReal(HY,h,411)
	local integer lvl=GetUnitAbilityLevel(Source,'A04E')//QP10 -> Kraken Shell, A04E -> Kraken Shell
	if IsPlayerBelongToTeams(GetOwningPlayer(Target)) and GetUnitAbilityLevel(Source,'A36D')==0 then
		if(time+6)<(TimerGetElapsed(GlobalTimer))then
			set dmgStored=0
		endif
		set time=TimerGetElapsed(GlobalTimer)
		set dmgStored=dmgStored+d
		if dmgStored>400 then
			set dmgStored=0
			call RemoveDispellableBuffs(Source)
			call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",Source,"origin"))
		endif
		call SaveReal(HY,h,412,dmgStored)
		call SaveReal(HY,h,411,time)
	endif
	if IsFakeDamage > 0 and (FakeDamageType==2 or FakeDamageType==3) then
		call HealUnitFor(Source,RMinIF(12.*lvl,GetEventDamage()))
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function Tidehunter_KrakenShell_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function N4G))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,412,0.0)
	call SaveReal(HY,h,411,TimerGetElapsed(GlobalTimer))
	set t=null
	set Source=null
endfunction

function KrakenShellAttack takes unit u, unit t returns nothing
	local integer lvl = GetUnitAbilityLevel(t,'A04E') * (1-GetUnitAbilityLevel(t,'A36D'))//
	call echo(I2S(lvl))
	if lvl==0 then
		call UnitRemoveAbility(u,'A3LB')
	else
		call UnitAddAbilityTimedExF(u,'A3LB',lvl,2,0)
	endif
endfunction

function N9G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local group g=(LoadGroupHandle(HY,h,22))
	call KillGroup(g)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set g=null
	return false
endfunction

function NDG takes group g returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveGroupHandle(HY,h,22,(g))
	call TriggerRegisterTimerEvent(t,10,false)
	call TriggerAddCondition(t,Condition(function N9G))
	set t=null
endfunction

function Tidehunter_Ravage takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Caster
	local integer i=1
	local real x1=GetUnitX(Hero)
	local real y1=GetUnitY(Hero)
	local real x2
	local real y2
	local real Damage
	local real DP9
	local integer Level=GetUnitAbilityLevel(Hero,'A29I')//A29I -> Ravage
	local group g=GetAvailableGroup()
	local real d=500
	if Level==1 then
		set DP9=1.5
		set Damage=200
	elseif Level==2 then
		set DP9=1.8
		set Damage=290
	elseif Level==3 then
		set DP9=2.25
		set Damage=380
	endif
	loop
		exitwhen i>16
		set x2=x1+(d+3*100)*Cos(22.5*i*bj_DEGTORAD)
		set y2=y1+(d+3*100)*Sin(22.5*i*bj_DEGTORAD)
		call ImpaleFactory(Hero,null,Damage,DP9,.52,x1,y1,x2,y2,250,g,false,775)
		set i=i+1
	endloop
	call NDG(g)
	set Hero=null
	set Caster=null
	set g=null
endfunction

function Tidehunter_AnchorSmash takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit Source=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A226')//A226 -> Anchor Smash
	local real dmg=50*Level+25
	local unit u
	local unit d=GetInvulDamager(Source)
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),500,Condition(function DefaultEnemyFilterWithAncients))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\CrushingWave\\CrushingWaveDamage.mdl",u,"chest"))
		call DamageTarget(d,u,2,dmg)
		call UnitAddAbilityTimedExF(u,'A228',1,6,'B0E8')//A228 -> Anchor Smash Container, B0E8 -> Anchor Smash
		call UnitMakeAbilityPermanent(u,true,'A227')
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
	set Source=null
	set d=null
endfunction

function NKG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call SetUnitTimeScale(Source,1)
	set t=null
	set Source=null
	return false
endfunction

function Tidehunter_AnhorSmash_OnCast takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call TriggerRegisterTimerEvent(t,.3,false)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function NKG))
	call SaveUnitHandle(HY,h,2,(Source))
	call SetUnitTimeScale(Source,2)
	set t=null
	set Source=null
endfunction

function NPG takes nothing returns boolean
	return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TmpUnit376))and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0)!=null//
endfunction

function NQG takes nothing returns nothing
	call DamageTarget(GetInvulDamager(TmpUnit376),GetEnumUnit(),2,TmpReal378)
endfunction

function NRG takes unit Source,unit Target,real Damage returns nothing
	local group g=GetAvailableGroup()
	set TmpUnit376=Source
	set TmpReal378=Damage
	call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),210,Condition(function NPG))
	call ForGroup(g,function NQG)
	call KillGroup(g)
	set g=null
endfunction

function NSG takes nothing returns boolean
	return(IsUnitInGroup(GetFilterUnit(),TempGroup2)==false and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(TmpUnit376)) and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false and GetFilterUnit()!=K58)!=null//
endfunction

function NTG takes group AffectedGroup,unit LastTarget,unit Source,unit OriginalTargetreturns returns unit
	local group g=GetAvailableGroup()
	local unit altu=null
	local unit u
	set TempGroup2=AffectedGroup
	set TmpUnit376=Source
	call GroupEnumUnitsInRange(g,GetUnitX(LastTarget),GetUnitY(LastTarget),500,Condition(function NSG))
	set u=FirstOfGroup(g)
	set altu=u
	loop
		exitwhen u==null
		if GetWidgetLife(u)!=GetUnitState(u,UNIT_STATE_MAX_LIFE)then
			if u!=Source and IsUnitType(u,UNIT_TYPE_HERO) and IsUnitType(altu,UNIT_TYPE_HERO)==false then
				set altu=u
			elseif u!=Source and GetWidgetLife(u)< GetWidgetLife(altu) and IsUnitType(u,UNIT_TYPE_HERO) and IsUnitType(altu,UNIT_TYPE_HERO) then
				set altu=u
			elseif u!=Source and IsUnitType(altu,UNIT_TYPE_HERO)==false and GetWidgetLife(u)< GetWidgetLife(altu)then
				set altu=u
			elseif u==Source then
				set altu=u
			endif
		endif
		call GroupRemoveUnit(g,u)
		set u=FirstOfGroup(g)
	endloop
	call KillGroup(g)
	set g=null
	set u=null
	set TEMPUNIT=altu
	set altu=null
	return TEMPUNIT
endfunction

function Dazzle_ShadowWave takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local string NZG="Abilities\\Spells\\Undead\\ReplenishMana\\ReplenishManaCaster.mdl"
	local string NAG="origin"
	local unit array NBG
	local integer x
	local integer i=1
	local integer Level=GetUnitAbilityLevel(Hero,'A0OR')//A0OR -> Shadow Wave
	local real Damage=60+Level*20
	local group NUG=GetAvailableGroup()
	local integer limit=Level+2
	local boolean N3G=false
	set K58=Hero
	call SetWidgetLife(Hero,GetWidgetLife(Hero)+Damage)
	call NRG(Hero,Hero,Damage)
	call GroupAddUnit(NUG,Hero)
	call Z48(NZG,Hero,NAG,2)
	if Target==Hero then
		set NBG[i]=NTG(NUG,Hero,Hero,Target)
	else
		set NBG[i]=Target
	endif
	if NBG[i]==null then
		call KillGroup(NUG)
		set Hero=null
		set Target=null
		return
	endif
	call SetWidgetLife(NBG[i],GetWidgetLife(NBG[i])+Damage)
	call NRG(Hero,NBG[i],Damage)
	call GroupAddUnit(NUG,NBG[i])
	call Z48(NZG,NBG[i],NAG,2)
	call ZO8("SPLK",GetUnitX(Hero),GetUnitY(Hero),GetUnitX(NBG[i]),GetUnitY(NBG[i]),.3,.5,.9,1,.7)
	set i=2
	loop
		exitwhen i>limit or N3G
		set NBG[i]=NTG(NUG,NBG[i-1],Hero,Target)
		if NBG[i]==null then
			set N3G=true
		else
			call GroupAddUnit(NUG,NBG[i])
			call Z48(NZG,NBG[i],NAG,2)
			call SetWidgetLife(NBG[i],GetWidgetLife(NBG[i])+Damage)
			call NRG(Hero,NBG[i],Damage)
			call ZO8("SPLK",GetUnitX(NBG[i-1]),GetUnitY(NBG[i-1]),GetUnitX(NBG[i]),GetUnitY(NBG[i]),.3,.5,.9,1,.7)
			set i=i+1
		endif
	endloop
	call KillGroup(NUG)
	set NUG=null
	set Hero=null
	set Target=null
endfunction

function NLG takes unit Source,unit Target,integer Level returns nothing
	local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'A0NJ')//A0NJ -> Blowdart
	call SetUnitAbilityLevel(Caster,'A0NJ',Level)//A0NJ -> Blowdart
	call IssueTargetOrderById(Caster,852075,Target)
	call UnitRemoveAbility(Caster,'A0NJ')
	set Caster=null
endfunction

function N0G takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,0)
	local integer c=GetTriggerEvalCount(t)
	local real Damage=8+6*Level
	local unit Caster=LoadUnitHandle(HY,h,19)
	if GetUnitAbilityLevel(Target,'A0OW')==0 or c > 6 then
		call UnitRemoveAbility(Target,'A0OW')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call DamageTarget(Caster,Target,2,Damage)//8 ticks
		if Level==1 then
			if c <= 3 then
				call NLG(Source,Target,1)
			endif
		elseif Level==2 then
			if c <= 2 then
				call NLG(Source,Target,1)
			elseif c==3 then
				call NLG(Source,Target,2)
			endif
		elseif Level==3 then
			if c <= 3 then
				call NLG(Source,Target,c)
			endif
		else//lvl 4
			if c < 3 then
				call NLG(Source,Target,c)
			elseif c==3 then
				call StunTargetLoD(Target,1.0)
			endif
		endif
	endif
	set Caster=null
	set Source=null
	set Target=null
	set t=null
endfunction

function N5Gold takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(tt_unit1),'e00E',GetUnitX(tt_unit2),GetUnitY(tt_unit2),0)//e00E -> Spellcaster
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function N0G))
	call SaveUnitHandle(HY,h,2,tt_unit1)
	call SaveUnitHandle(HY,h,17,tt_unit2)
	call SaveUnitHandle(HY,h,19,Caster)
	call SaveInteger(HY,h,0,LoadInteger(HY,GetHandleId(GetTriggeringTrigger()),5))
	call UnitAddAbility2(tt_unit2,'A0OW')
	
	if GetUnitAbilityLevel(tt_unit2,'A3E9')==1 and LoadBoolean(HY,GetHandleId(GetTriggeringTrigger()),0)==false and IsMagicImmune(tt_unit2)==false then
		call SaveUnitHandle(TempHash,'A3E9',0,tt_unit2)
		call SaveUnitHandle(TempHash,'A3E9',1,tt_unit1)
		call SaveInteger(TempHash,'A3E9',0,LoadInteger(HY,GetHandleId(GetTriggeringTrigger()),5))
		call ExecuteFunc("Dazzle_PoisonTouchLotusOrb")
	endif
	call TriggerEvaluate(t)
	set Caster=null
	set t=null
endfunction

function N5G takes unit caster, unit target, integer lvl, boolean lotus returns nothing
	local trigger t=AddProjectile(caster,target,'e00E',"N5Gold",1300,true)//e00E -> Spellcaster
	call SaveInteger(HY,GetHandleId(t),5,lvl)
	call SaveBoolean(HY,GetHandleId(t),0,lotus)
	set t=null
endfunction

function Dazzle_PoisonTouch takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A0NQ')//A0NQ -> Poison Touch
	if IsBlocked(target)==false then
		call N5G(caster,target,lvl,false)
	endif
	set caster=null
	set target=null
endfunction

function Dazzle_PoisonTouchLotusOrb takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	local integer lvl=LoadInteger(TempHash,'A3E9',0)
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	if IsBlocked(target)==false then
		call N5G(caster,target,lvl,true)
	endif
	set caster=null
	set target=null
endfunction

function Dazzle_PoisonTouch_Preload takes nothing returns nothing
	call PreloadQueryAdd('A0NJ')//A0NJ -> Blowdart
endfunction

function N2G takes nothing returns nothing//weave
	local unit Target=GetEnumUnit()
	local integer armor=LoadInteger(HeroStats,GetHandleId(Target),GetHandleId(GetTriggeringTrigger()))
	if IsUnitAlly(Target,tt_player1)==false then
		call LoDStat_Sub(Target,armor,"armourneg")
	else
		call LoDStat_Sub(Target,armor,"armour")
	endif
	call SaveInteger(HeroStats,GetHandleId(Target),GetHandleId(GetTriggeringTrigger()),0)
	set Target=null
endfunction

function O4G takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local integer armor=R2I(tt_int1*tt_real1)
	local integer prevarmor
	if tt_int1>0 then
		set prevarmor=R2I((tt_int1-1)*tt_real1)
		if IsUnitAlly(Target,tt_player1)==false then
			call LoDStat_Sub(Target,prevarmor,"armourneg")
		else
			call LoDStat_Sub(Target,prevarmor,"armour")
		endif
	endif
	if IsDead(Target)==false then
		if IsUnitAlly(Target,tt_player1)==false then
			call LoDStat_Add(Target,armor,"armourneg")
			call SaveInteger(HeroStats,GetHandleId(Target),GetHandleId(GetTriggeringTrigger()),armor)
		else
			call LoDStat_Add(Target,armor,"armour")
			call SaveInteger(HeroStats,GetHandleId(Target),GetHandleId(GetTriggeringTrigger()),armor)
		endif
	endif
	set Target=null
endfunction

function O7G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local group g=(LoadGroupHandle(HY,h,22))
	local player p=(LoadPlayerHandle(HY,h,54))
	local integer Count=GetTriggerEvalCount(t)
	local integer DP9=(LoadInteger(HY,h,188))
	local real armor=LoadReal(HY,h,0)
	set tt_player1=p
	set tt_int1=Count
	set tt_real1=armor
	if Count==DP9 then
		call ForGroup(g,function N2G)
		call KillGroup(g)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call ForGroup(g,function O4G)
	endif
	set t=null
	set g=null
	return false
endfunction

function O8G takes nothing returns nothing
	call Z48("Abilities\\Weapons\\AvengerMissile\\AvengerMissile.mdl",GetEnumUnit(),"chest",3)
	call Z48("Abilities\\Weapons\\AvengerMissile\\AvengerMissile.mdl",GetEnumUnit(),"chest",3)
	call Z48("Abilities\\Weapons\\AvengerMissile\\AvengerMissile.mdl",GetEnumUnit(),"right hand",3)
	call Z48("Abilities\\Weapons\\AvengerMissile\\AvengerMissile.mdl",GetEnumUnit(),"left hand",3)
endfunction

function Dazzle_Weave takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Hero,'A10Q')//A10Q -> Weave
	local integer DP9=24
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'h007',x,y,0)//h007 -> Weave
	local integer a=0
	local boolean RIE=false
	local real armor=Level*0.25+0.5
	if Level==0 then
		set Level=GetUnitAbilityLevel(Hero,'A1DB')//A1DB -> Weave Upgrade
		set DP9=20
		set RIE=true
		set armor=Level*0.25+1.0
	endif
	set tt_int1=DP9
	set a=255
	call SetUnitVertexColor(Caster,255,255,255,a)
	call UnitApplyTimedLife(Caster,'BTLF',5)
	if RIE then
		call GroupEnumUnitsInRange(g,x,y,800,Condition(function DI9))
	else
		call GroupEnumUnitsInRange(g,x,y,600,Condition(function DI9))
	endif
	call ForGroup(g,function O8G)
	call SaveGroupHandle(HY,h,22,(g))
	call SavePlayerHandle(HY,h,54,(GetOwningPlayer(Hero)))
	call SaveInteger(HY,h,188,(DP9))
	call SaveReal(HY,h,0,armor)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function O7G))
	call TriggerEvaluate(t)
	set Hero=null
	set g=null
	set t=null
	set Caster=null
endfunction

function OEG takes string ZS8,unit Target,unit Hero returns nothing
	local texttag tt=CreateTextTag()
	if GetHandleId(tt)>0 then
		call SetTextTagText(tt,ZS8,.033)
		call SetTextTagPosUnit(tt,Target,64)
		call SetTextTagColor(tt,160,0,255,255)
		call SetTextTagVelocity(tt,0,.0355)
		call SetTextTagFadepoint(tt,.15)
		call SetTextTagPermanent(tt,false)
		call SetTextTagLifespan(tt,.65)
		call SetTextTagVisibility(tt,IsUnitAlly(Hero,GetLocalPlayer())or IsObserver(GetLocalPlayer()))
	else
		call DestroyTextTag(tt)
	endif
	set tt=null
endfunction

function OFG takes real DP9 returns string
	if DP9>4.5 then
		return"5.0"
	elseif DP9>4. then
		return"4.5"
	elseif DP9>3.5 then
		return"4.0"
	elseif DP9>3. then
		return"3.5"
	elseif DP9>2.5 then
		return"3.0"
	elseif DP9>2. then
		return"2.5"
	elseif DP9>1.5 then
		return"2.0"
	elseif DP9>1. then
		return"1.5"
	elseif DP9>.5 then
		return"1.0"
	elseif DP9>.0 then
		return"0.5"
	else
		return"0.0"
	endif
	return" "
endfunction

function OGG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Count=GetTriggerEvalCount(t)
	if Count>11 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call OEG(OFG(5.5-.5*Count),Target,Target)
	endif
	set t=null
	set Target=null
	return false
endfunction

function OHG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real Damage=(LoadReal(HY,h,20))
	local real OIG=RMaxIF(GetWidgetLife(Target)-Damage,1)
	local real OJG=(LoadReal(HY,(GetHandleId(Target)),243))
	call SetWidgetLife(Target,OIG)
	call SaveReal(HY,(GetHandleId(Target)),243,((OJG-Damage)*1.))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Target=null
	return false
endfunction

function OKG takes unit Target,real Damage returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real OJG=(LoadReal(HY,(GetHandleId(Target)),243))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveReal(HY,h,20,((Damage)*1.))
	call SaveReal(HY,(GetHandleId(Target)),243,((OJG+Damage)*1.))
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function OHG))
	set t=null
endfunction

function OMG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target
	local real OBF
	local real Damage
	local integer Count=GetTriggerEvalCount(t)
	local real OJG
	local real ONG=(LoadReal(HY,h,389))
	local real OOG=(LoadReal(HY,h,390))
	if ONG!=(TimerGetElapsed(GlobalTimer))then
		set ONG=(TimerGetElapsed(GlobalTimer))
		set OOG=0
		call SaveReal(HY,h,389,((ONG)*1.))
		call SaveReal(HY,h,390,((OOG)*1.))
	endif
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if IsRealDamage then
			set Target=GetTriggerUnit()
			set OJG=(LoadReal(HY,(GetHandleId(Target)),243))
			set OBF=GetWidgetLife(Target)
			set Damage=GetEventDamage()
			if((OBF-OJG-OOG)-Damage)<1 then
				call SetWidgetLife(Target,OBF+Damage+OOG)
				call OKG(Target,Damage)
			else
				set OOG=OOG+Damage
				call SaveReal(HY,h,390,((OOG)*1.))
			endif
		endif
	else
		call SaveInteger(HY,(GetHandleId(((LoadUnitHandle(HY,h,17))))),(2485),2)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call UnitRemoveAbility((LoadUnitHandle(HY,h,17)),'A21I')//A21I -> Shallow Grave
		call UnitRemoveAbility((LoadUnitHandle(HY,h,17)),'B07D')//B07D -> |cff00ff00Shallow Grave|r
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set Target=null
	set t=null
	return false
endfunction

function Dazzle_Grave takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	call UnitAddAbility2(Target,'A21I')//A21I -> Shallow Grave
	call TriggerRegisterTimerEvent(t,5,false)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function OMG))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\DarkHands.mdx",Target,"overhead")))
	call SaveReal(HY,(GetHandleId(Target)),243,(0*1.))
	call SaveReal(HY,h,389,(((TimerGetElapsed(GlobalTimer)))*1.))
	call SaveReal(HY,h,390,(0*1.))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,(GetHandleId((Target))),(2485),1)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function OGG))
	call SaveUnitHandle(HY,h,17,(Target))
	set t=null
	set Source=null
	set Target=null
endfunction

function ORG takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),DK)==false then
		set K28=CreateUnit(GetOwningPlayer(tt_unit1),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)//e00E -> Spellcaster
		
		call UnitAddAbility2(K28,'A17N')//A17N -> Shadow Strike
		call SetUnitAbilityLevel(K28,'A17N',M48)//A17N -> Shadow Strike
		if IssueTargetOrderById(K28,852527,GetEnumUnit())==false then
			call UnitShareVision(GetEnumUnit(),GetOwningPlayer(tt_unit1),true)
			call IssueTargetOrderById(K28,852527,GetEnumUnit())
			call UnitShareVision(GetEnumUnit(),GetOwningPlayer(tt_unit1),false)
		endif
		call GroupAddUnit(DK,GetEnumUnit())
		set K28=null
	endif
endfunction

function OSG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local group g=(LoadGroupHandle(HY,h,22))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local integer Level=(LoadInteger(HY,h,5))
	local real a=(LoadReal(HY,h,13))
	local group V7E
	local real x
	local real y
	local real OTG
	local real OUG
	local real QQE=30
	set M48=Level
	if GetTriggerEvalCount(t)>28 then
		call KillGroup(g)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call ShowUnit(Caster,false)
		call KillUnit(Caster)
	else
		set x=GetUnitX(Caster)
		set y=GetUnitY(Caster)
		set V7E=GetAvailableGroup()
		set DK=g
		set tt_unit1=Caster
		set tt_real1=Level*70
		call GroupEnumUnitsInRange(V7E,x,y,150,Condition(function LA8))
		call ForGroup(V7E,function ORG)
		call KillGroup(V7E)
		set OTG=SafeX50(x+QQE*Cos(a*bj_DEGTORAD))
		set OUG=SafeY50(y+QQE*Sin(a*bj_DEGTORAD))
		call SetUnitX(Caster,OTG)
		call SetUnitY(Caster,OUG)
	endif
	set t=null
	set g=null
	set V7E=null
	set Caster=null
	return false
endfunction

function Venomancer_VenomousGale takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local group g=GetAvailableGroup()
	local unit Hero=GetTriggerUnit()
	local real x1=GetUnitX(Hero)
	local real y1=GetUnitY(Hero)
	local real x2=GetSpellTargetX()
	local real y2=GetSpellTargetY()
	local real a=AngleBetweenXY(x1,y1,x2,y2)
	local integer Level=GetUnitAbilityLevel(Hero,'A173')//A173 -> Venomous Gale
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'h07K',x1,y1,a)//h07K -> Shadowstrike Model
	call PlaySoundAtPos(GE,x1,y1)
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveInteger(HY,h,5,(Level))
	call SaveGroupHandle(HY,h,22,(g))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveUnitHandle(HY,h,14,(Hero))
	call TriggerRegisterTimerEvent(t,.025,true)
	call TriggerAddCondition(t,Condition(function OSG))
	set t=null
	set Caster=null
	set g=null
	set Hero=null
endfunction

function Venomancer_PlagueWard_Vision takes nothing returns nothing
	call ShowUnit(GetTriggerUnit(),false)
	call DestroyTrigger(GetTriggeringTrigger())
endfunction

function Venomancer_PlagueWard_Check takes nothing returns nothing
	local integer id=GetUnitTypeId(GetSummonedUnit())
	local integer lvl
	local trigger t
	local integer h
	local unit u
	if id=='o00T' or id=='o00U' or id=='o00V' or id=='o00W' then//o00T -> Plague Ward 1, o00U -> Plague Ward 2, o00V -> Plague Ward 3, o00W -> Plague Ward 4
		set u=GetSummonedUnit()
		set t=CreateTrigger()
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
		call TriggerAddCondition(t,Condition(function Venomancer_PlagueWard_Vision))
		set t=null
		set lvl=id-'o00T'//o00T -> Plague Ward 1
		if lvl>0 then
			call UnitAddAbility2(u,'QVEN')//QVEN -> Poison Sting
			call SetUnitAbilityLevel(u,'QVEN',lvl)//QVEN -> Poison Sting
		endif
		if RectContainsUnit(WardAbuseRect,u) then
			call UnitAddAbility(u,'Aeth')//Aeth -> Ghost
		endif
		if GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A0A8')>0 then
			call UnitAddAbility3(u,'A3JB',GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A0A8'))
		endif
		set u=null
	endif
endfunction

function Venomancer_PlagueWard_Init takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function Venomancer_PlagueWard_Check))
	set t=null
	set WardAbuseRect=Rect(-1104,-7248,-1474,-6668)
endfunction

function DamageTargetPoison takes unit attacker, unit target, real dmg returns nothing
	if GetWidgetLife(target)>dmg then
		call DamageTarget(attacker,target,1,dmg)
	else
		call DamageTarget(attacker,target,1,RMaxIF(GetWidgetLife(target)-1,0))
	endif
endfunction

function Veno_PoisonNova_Act takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit d
	local integer i=1
	local real angle
	local real x
	local real y
	local real dx
	local real dy
	local real dur=LoadReal(HY,h,0)
	if LoadInteger(HY,h,0)>50*dur then
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
		set t=null
		return
	endif
	loop
		set d=LoadUnitHandle(HY,h,i)
		set x=GetUnitX(d)
		set y=GetUnitY(d)
		set angle=i*20*bj_DEGTORAD
		set dx=SafeX50(x+10*Cos(angle))
		set dy=SafeY50(y+10*Sin(angle))
		call SetUnitX(d,dx)
		call SetUnitY(d,dy)
		set i=i+1
		exitwhen i>18
	endloop
	call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
	set d=null
	set t=null
endfunction

function Venomancer_PoisonNova_Dur takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit damager
	local unit victim=LoadUnitHandle(HY,h,2)
	local integer dur=LoadInteger(HY,h,0)
	local unit rhero
	if IsDead(victim) or dur<1 or GetUnitAbilityLevel(victim,'A42O')==0 then
		call RemoveSavedHandle(MHT,GetHandleId(victim),'A0A6')//A0A6 -> Poison Nova Upg
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
		call UnitRemoveAbility(victim,'A42O')
		call UnitRemoveAbility(victim,'B028')//B028 -> Poison Nova
	else
		set damager=LoadUnitHandle(HY,h,0)
		set rhero=LoadUnitHandle(HY,h,1)
		if IsDead(damager) and damager!=rhero then
			set damager=rhero
		endif
		call DamageTargetPoison(damager,victim,LoadReal(HY,h,0))
		call SaveInteger(HY,h,0,LoadInteger(HY,h,0)-1)
	endif
	set rhero=null
	set damager=null
	set victim=null
	set t=null
endfunction

function Venomancer_PoisonNova_Poisoning takes unit caster, unit u, real dmg, real dur, boolean upg returns nothing
	local timer t
	local integer h
	if HaveSavedHandle(MHT,GetHandleId(u),'A0A6') then//A0A6 -> Poison Nova Upg
		set t=LoadTimerHandle(MHT,GetHandleId(u),'A0A6')//A0A6 -> Poison Nova Upg
		set h=GetHandleId(t)
		call SaveInteger(HY,h,0,R2I(dur))
	else
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,1,true,function Venomancer_PoisonNova_Dur)
		call SaveReal(HY,h,0,dmg)
		call SaveInteger(HY,h,0,R2I(dur))
		call SaveUnitHandle(HY,h,0,caster)
		call SaveUnitHandle(HY,h,2,u)
		call SaveUnitHandle(HY,h,1,udg_Hero[GetPlayerId(GetOwningPlayer(caster))])
		call SaveTimerHandle(MHT,GetHandleId(u),'A0A6',t)//A0A6 -> Poison Nova Upg
		call UnitAddAbility2(u,'A42O')
		if upg and IsUnitType(u,UNIT_TYPE_HERO)then
			call UnitFreezeHP(u,dur)
		endif
	endif
	
	set t=null
endfunction

function PoisonNovaFilter takes nothing returns boolean
	return AliveNonBuildOrMarker(GetFilterUnit()) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and IsUnitInGroup(GetFilterUnit(),TempGroup)==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_MECHANICAL)==false//, Aloc -> Locust
endfunction

function PoisonNovaDur takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local group affected=LoadGroupHandle(HY,h,1)
	local real dmg=LoadReal(HY,h,0)
	local group g=GetAvailableGroup()
	local integer c=GetTriggerEvalCount(t)
	local unit u
	if c>23 then
		call DestroyTrigger(t)
		call FlushChildHashtable(HY,h)
		call KillGroup(affected)
	else
		set tt_unit1=caster
		set TempGroup=affected
		call GroupEnumUnitsInRange(g,LoadReal(HY,h,1),LoadReal(HY,h,2),25*c+255,Condition(function PoisonNovaFilter))
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			call GroupAddUnit(affected,u)
			call Venomancer_PoisonNova_Poisoning(caster,u,LoadReal(HY,h,0),16,LoadBoolean(HY,h,0))
			call GroupRemoveUnit(g,u)
		endloop
	endif
	call KillGroup(g)
	set caster=null
	set t=null
endfunction

function Venomancer_PoisonNova takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
	local boolean isAgh=GetSpellAbilityId()=='A0A6'
	local real dmg
	local group g=GetAvailableGroup()
	local integer i=1
	local unit d
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real x=GetUnitX(caster)
	local real y=GetUnitY(caster)
	loop
		exitwhen i>18
		set d=CreateUnit(GetOwningPlayer(caster),'e017',x,y,0)//e017 -> Nova Missile
		call IssuePointOrder(d,"move",x+675*Cos(i*20*bj_DEGTORAD),y+675*Sin(i*20*bj_DEGTORAD))
		call UnitApplyTimedLife(d,'BTLF',1.15)
		set i=i+1
	endloop
	if isAgh then
		set dmg=35+25*lvl
	else
		set dmg=5+25*lvl
	endif
	call SetUnitAnimation(caster,"attack")
	call TriggerRegisterTimerEvent(t,0.05,true)
	call TriggerAddCondition(t,Condition(function PoisonNovaDur))
	call SaveUnitHandle(HY,h,0,caster)
	call SaveGroupHandle(HY,h,1,g)
	call SaveReal(HY,h,0,dmg)
	call SaveReal(HY,h,1,x)
	call SaveReal(HY,h,2,y)
	call SaveBoolean(HY,h,0,isAgh)
	set t=null
	set caster=null
endfunction


function Viper_Toxin_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	call LoDStat_Sub(LoadUnitHandle(MHT,info,0),LoadInteger(MHT,info,0),"damage")
	call SaveBoolean(MHT,LoadInteger(MHT,info,1),'A1A3',false) //finish cooldown//A1A3 -> Nethertoxin
	call Timer_End(t)
	set t = null
endfunction

function Viper_Toxin_Start takes unit u, unit d, integer level returns nothing
	local timer t = CreateTimer()
	local integer info = GetHandleId(t)
	local integer amount = 0
	local real dr=2.5*level
	local real r=100*GetWidgetLife(d)/GetUnitState(d,UNIT_STATE_MAX_LIFE)
	if r>80 then
	elseif r>60 then
		set dr=dr*2
	elseif r>40 then
		set dr=dr*4
	elseif r>20 then
		set dr=dr*8
	else
		set dr=dr*16
	endif
	if IsUnitIdType(GetUnitTypeId(d),UNIT_TYPE_HERO)==false and IsUnitType(d,UNIT_TYPE_STRUCTURE)==false then
		set dr = dr/2
	endif
	set amount=R2I(dr)
	call LoDStat_Add(u,amount,"damage")
	call SaveUnitHandle(MHT,info,0,u)
	call SaveInteger(MHT,info,0,amount)
	call SaveInteger(MHT,info,1,GetHandleId(u))
	call SaveBoolean(MHT,GetHandleId(u),'A1A3',true) //start cooldown//A1A3 -> Nethertoxin
	call TimerStart(t,.5,false,function Viper_Toxin_End)
	set t = null
endfunction

function Viper_NetherToxin takes unit attacker, unit target returns nothing
	local integer level = GetUnitAbilityLevel(attacker,'A1A3') * (1-GetUnitAbilityLevel(attacker,'A36D'))//A1A3 -> Nethertoxin, QP21 -> Nethertoxin
	if level==0 or LoadBoolean(MHT,GetHandleId(attacker),'A1A3') then//A1A3 -> Nethertoxin
		return
	endif
	if IsUnitEnemy(attacker,GetOwningPlayer(target))then
		call Viper_Toxin_Start(attacker,target,level)
	endif
endfunction

function Viper_CorrosiveSkin_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,5)
	local real JSD=LoadReal(HY,GetHandleId(Target),684)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or JSD<(TimerGetElapsed(GlobalTimer))or IsMagicImmune(Target)then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SaveReal(HY,GetHandleId(Target),684,0.0)
		call UnitRemoveAbility(Target,'A23S')
		call UnitRemoveAbility(Target,'A23P')
		call UnitRemoveAbility(Target,'A23Q')
		call UnitRemoveAbility(Target,'A23R')
		call UnitRemoveAbility(Target,'B0EA')//B0EA -> Corrosive Skin
	else
		set IsCorrosiveSkinDamage=true
		call DamageTarget(Source,Target,1,5+5*Level)
		set IsCorrosiveSkinDamage=false
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function Viper_CorrosiveSkin_Tick takes nothing returns nothing
	local trigger t
	local integer h
	local unit Source=GetTriggerUnit()
	local unit Target=GetEventDamageSource()
	local real JSD=LoadReal(HY,GetHandleId(Target),684)
	local integer Level=GetUnitAbilityLevel(Source,'A0MM')//A0MM -> Corrosive Skin, QP0Y -> Corrosive Skin
	if JSD<=(TimerGetElapsed(GlobalTimer))then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerAddCondition(t,Condition(function Viper_CorrosiveSkin_Duration))
		call SaveUnitHandle(HY,h,2,Source)
		call SaveUnitHandle(HY,h,17,Target)
		call SaveInteger(HY,h,5,Level)
		if IsUnitBADWithSpellbooks(Target)==false then
			if Level==1 then
				call UnitAddAbility2(Target,'A23S')
			elseif Level==2 then
				call UnitAddAbility2(Target,'A23P')
			elseif Level==3 then
				call UnitAddAbility2(Target,'A23Q')
			elseif Level==4 then
				call UnitAddAbility2(Target,'A23R')
			endif
		endif
	endif
	call SaveReal(HY,GetHandleId(Target),684,TimerGetElapsed(GlobalTimer)+4)
	set t=null
	set Source=null
	set Target=null
endfunction

function Viper_CorrosiveSkin_Start takes nothing returns boolean
	if GetUnitAbilityLevel(GetTriggerUnit(),'A0MM')>0 and AliveNonBuildOrMarker(GetEventDamageSource()) and IsUnitEnemy(GetEventDamageSource(),GetOwningPlayer(GetTriggerUnit()))and IsMagicImmune(GetEventDamageSource())==false and DistanceBetweenUnits(GetEventDamageSource(),GetTriggerUnit())<=1400 then //A0MM//A0MM -> Corrosive Skin, QP0Y -> Corrosive Skin, 
		if GetUnitAbilityLevel(GetTriggerUnit(),'A36D')==0 and IsCorrosiveSkinDamage==false then
			call Viper_CorrosiveSkin_Tick()
		endif
	endif
	return false
endfunction

function Viper_CorrosiveSkin_Reg2 takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function Viper_CorrosiveSkin_Start))
	set t=null
endfunction

function ViperPoisonDamage takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit source=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	if IsDead(target) or GetUnitAbilityLevel(target,'B06D')==0 then
		call RemoveSavedHandle(HY,LoadInteger(HY,h,-1),'A09V')
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	else
		call DamageTarget(source,target,1,8+6*LoadInteger(HY,h,0))
	endif
	set source=null
	set target=null
	set t=null
endfunction

function ViperPoisonAttack takes unit attacker, unit target returns nothing
	local timer t
	local integer h
	local integer hu=GetHandleId(target)
	if HaveSavedHandle(HY,hu,'A09V')then
		set t=LoadTimerHandle(HY,hu,'A09V')
		set h=GetHandleId(t)
	else
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveTimerHandle(HY,hu,'A09V',t)
		call TimerStart(t,1,true,function ViperPoisonDamage)
		call SaveUnitHandle(HY,h,0,attacker)
		call SaveUnitHandle(HY,h,1,target)
		call SaveInteger(HY,h,-1,hu)
	endif
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(attacker,'A09V'))
	set t=null
endfunction

function ViperStrikeBaseWrapper takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetUnitFacing(GetTriggerUnit()))
	call UnitAddAbility(d,'A3IF')
	call SetUnitAbilityLevel(d,'A3IF',GetUnitAbilityLevel(GetTriggerUnit(),'A080'))
	call UnitRemoveAbility(GetSpellTargetUnit(),'BEsh')//BEsh -> Shadow Strike
	call UnitRemoveAbility(GetSpellTargetUnit(),'B0AQ')//B0AQ -> Venomous Gale
	call IssueTargetOrder(d,"shadowstrike",GetSpellTargetUnit())
	set d=null
endfunction

function ViperStrikeUpgWrapper takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetUnitFacing(GetTriggerUnit()))
	call UnitAddAbility(d,'A3IG')
	call SetUnitAbilityLevel(d,'A3IG',GetUnitAbilityLevel(GetTriggerUnit(),'A1UZ'))
	call UnitRemoveAbility(GetSpellTargetUnit(),'BEsh')//BEsh -> Shadow Strike
	call UnitRemoveAbility(GetSpellTargetUnit(),'B0AQ')//B0AQ -> Venomous Gale
	call IssueTargetOrder(d,"shadowstrike",GetSpellTargetUnit())
	set d=null
endfunction

function GraveChillOff takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	call LoDStat_Sub(u,64,"attack")
	call SubBonusMSPercent(u,32)
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set u=null
	set t=null
endfunction

function Visage_GraveChill takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local integer lvl=GetUnitAbilityLevel(caster,'A08X')
	call UnitAddAbilityTimedExF(caster,'A3KH',1,2+lvl,'B3KH')
	set caster=null
endfunction

function Visage_GraveChillWrapper takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Visage_GraveChill()
	endif
endfunction

function P8G takes unit Source,integer Level,integer P9G returns nothing
	call UnitRemoveAbility(Source,'A1KR')//A1KR -> IceShell Book - 1,1
	call UnitRemoveAbility(Source,'A1KS')//A1KS -> IceShell Book - 1,2
	call UnitRemoveAbility(Source,'A1KQ')//A1KQ -> IceShell Book - 1,3
	call UnitRemoveAbility(Source,'A1KP')//A1KP -> IceShell Book - 1,4
	call UnitRemoveAbility(Source,'A1K1')//A1K1 -> IceShell Book - 2,1
	call UnitRemoveAbility(Source,'A1KW')//A1KW -> IceShell Book - 2,2
	call UnitRemoveAbility(Source,'A1KX')//A1KX -> IceShell Book - 2,3
	call UnitRemoveAbility(Source,'A1KY')//A1KY -> IceShell Book - 2,4
	call UnitRemoveAbility(Source,'A1L4')//A1L4 -> IceShell Book - 3,1
	call UnitRemoveAbility(Source,'A1L3')//A1L3 -> IceShell Book - 3,2
	call UnitRemoveAbility(Source,'A1L2')//A1L2 -> IceShell Book - 3,3
	call UnitRemoveAbility(Source,'A1L1')//A1L1 -> IceShell Book - 3,4
	call UnitRemoveAbility(Source,'A1L8')//A1L8 -> IceShell Book - 4,1
	call UnitRemoveAbility(Source,'A1L7')//A1L7 -> IceShell Book - 4,2
	call UnitRemoveAbility(Source,'A1L9')//A1L9 -> IceShell Book - 4,3
	call UnitRemoveAbility(Source,'A1LB')//A1LB -> IceShell Book - 4,4
	if Level==1 then
		if P9G==1 then
			call UnitAddAbility2(Source,'A1KR')//A1KR -> IceShell Book - 1,1
		elseif P9G==2 then
			call UnitAddAbility2(Source,'A1KS')//A1KS -> IceShell Book - 1,2
		elseif P9G==3 then
			call UnitAddAbility2(Source,'A1KQ')//A1KQ -> IceShell Book - 1,3
		elseif P9G==4 then
			call UnitAddAbility2(Source,'A1KP')//A1KP -> IceShell Book - 1,4
		endif
	elseif Level==2 then
		if P9G==1 then
			call UnitAddAbility2(Source,'A1K1')//A1K1 -> IceShell Book - 2,1
		elseif P9G==2 then
			call UnitAddAbility2(Source,'A1KW')//A1KW -> IceShell Book - 2,2
		elseif P9G==3 then
			call UnitAddAbility2(Source,'A1KX')//A1KX -> IceShell Book - 2,3
		elseif P9G==4 then
			call UnitAddAbility2(Source,'A1KY')//A1KY -> IceShell Book - 2,4
		endif
	elseif Level==3 then
		if P9G==1 then
			call UnitAddAbility2(Source,'A1L4')//A1L4 -> IceShell Book - 3,1
		elseif P9G==2 then
			call UnitAddAbility2(Source,'A1L3')//A1L3 -> IceShell Book - 3,2
		elseif P9G==3 then
			call UnitAddAbility2(Source,'A1L2')//A1L2 -> IceShell Book - 3,3
		elseif P9G==4 then
			call UnitAddAbility2(Source,'A1L1')//A1L1 -> IceShell Book - 3,4
		endif
	elseif Level==4 then
		if P9G==1 then
			call UnitAddAbility2(Source,'A1L8')//A1L8 -> IceShell Book - 4,1
		elseif P9G==2 then
			call UnitAddAbility2(Source,'A1L7')//A1L7 -> IceShell Book - 4,2
		elseif P9G==3 then
			call UnitAddAbility2(Source,'A1L9')//A1L9 -> IceShell Book - 4,3
		elseif P9G==4 then
			call UnitAddAbility2(Source,'A1LB')//A1LB -> IceShell Book - 4,4
		endif
	endif
endfunction

function PDG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer PEG=(LoadInteger(HY,h,426))
	local unit Source=(LoadUnitHandle(HY,(PEG),2))
	local integer P9G=(LoadInteger(HY,(PEG),425))
	local integer Level=GetUnitAbilityLevel(Source,'A0VX')//A0VX -> Gravekeeper's Cloak, QP23 -> Gravekeeper's Cloak
	set P9G=IMinIF(P9G+1,4)
	call SaveInteger(HY,(PEG),425,(P9G))
	call P8G(Source,Level,P9G)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function rthyrtt takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Cache=LoadInteger(HY,h,426)
	local unit u=LoadUnitHandle(HY,Cache,2)
	local integer P9G=LoadInteger(HY,Cache,425)
	local integer Level=GetUnitAbilityLevel(u,'A0VX')//A0VX -> Gravekeeper's Cloak, QP23 -> Gravekeeper's Cloak
	call P8G(u,Level,P9G)
	call DestroyTrigger(t)
	call FlushChildHashtable(HY,h)
	set u=null
	set t=null
	
endfunction

function PFG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer P9G=(LoadInteger(HY,h,425))
	local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A0VX')//A0VX -> Gravekeeper's Cloak, QP23 -> Gravekeeper's Cloak
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamage()>2 and GetEventDamageSource()!=GetTriggerUnit()and IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource())) and IsRealDamage then
			set P9G=IMaxIF(P9G-1,0)
			if GetUnitAbilityLevel(Source,'A36D')==1 then
				set P9G=0
			endif
			call SaveInteger(HY,h,425,(P9G))
			call P8G(Source,Level,P9G)
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call TriggerRegisterTimerEvent(t,4,false)
			call TriggerAddCondition(t,Condition(function PDG))
			call SaveInteger(HY,h,426,(GetHandleId(GetTriggeringTrigger())))
		endif
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.4,false)
		call TriggerAddCondition(t,Condition(function rthyrtt))
		call SaveInteger(HY,h,426,GetHandleId(GetTriggeringTrigger()))
	 	endif
	set t=null
	set Source=null
	return false
endfunction

function Visage_GravekeeperCloak_Leveling takes nothing returns nothing
	local trigger t
	local integer h
	local unit Source=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A0VX')//QP23 -> Gravekeeper's Cloak, A0VX -> Gravekeeper's Cloak
	if Level==1 then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
		call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
		call TriggerAddCondition(t,Condition(function PFG))
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveInteger(HY,h,425,4)
	endif
	call P8G(Source,Level,4)
	set t=null
	set Source=null
endfunction

function Visage_GravekeeperClock_Reg takes nothing returns nothing
	call HideAbility('A1KR')//A1KR -> IceShell Book - 1,1
	call HideAbility('A1KS')//A1KS -> IceShell Book - 1,2
	call HideAbility('A1KQ')//A1KQ -> IceShell Book - 1,3
	call HideAbility('A1KP')//A1KP -> IceShell Book - 1,4
	call HideAbility('A1K1')//A1K1 -> IceShell Book - 2,1
	call HideAbility('A1KW')//A1KW -> IceShell Book - 2,2
	call HideAbility('A1KX')//A1KX -> IceShell Book - 2,3
	call HideAbility('A1KY')//A1KY -> IceShell Book - 2,4
	call HideAbility('A1L4')//A1L4 -> IceShell Book - 3,1
	call HideAbility('A1L3')//A1L3 -> IceShell Book - 3,2
	call HideAbility('A1L2')//A1L2 -> IceShell Book - 3,3
	call HideAbility('A1L1')//A1L1 -> IceShell Book - 3,4
	call HideAbility('A1L8')//A1L8 -> IceShell Book - 4,1
	call HideAbility('A1L7')//A1L7 -> IceShell Book - 4,2
	call HideAbility('A1L9')//A1L9 -> IceShell Book - 4,3
	call HideAbility('A1LB')//A1LB -> IceShell Book - 4,4
endfunction

function PJG takes nothing returns nothing
	local integer Level
	local unit Source=GetTriggerUnit()
	local unit Caster
	if GetUnitTypeId(Source)=='u017' or GetUnitTypeId(Source)=='u019' or GetUnitTypeId(Source)=='u018' or GetUnitTypeId(Source)=='u01A' or GetUnitTypeId(Source)=='u01B' or GetUnitTypeId(Source)=='u01C' or GetUnitTypeId(Source)=='u01U' or GetUnitTypeId(Source)=='u01V' or GetUnitTypeId(Source)=='u01W' then//u017 -> Stone Form, u019 -> Stone Form, u018 -> Stone Form, u01A -> Stone Form, u01B -> Stone Form, u01C -> Stone Form, u01U -> Stone Form, u01V -> Stone Form, u01W -> Stone Form
		return
	endif
	set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
	if GetUnitTypeId(Source)=='u014' or GetUnitTypeId(Source)=='u01D' or GetUnitTypeId(Source)=='u01R' then//u014 -> Familiar, u01D -> Familiar, u01R -> Familiar
		set Level=1
	elseif GetUnitTypeId(Source)=='u015' or GetUnitTypeId(Source)=='u01E' or GetUnitTypeId(Source)=='u01S' then//u015 -> Familiar, u01E -> Familiar, u01S -> Familiar
		set Level=2
	else
		set Level=3
	endif
	call UnitAddAbility2(Caster,'A1NF')//A1NF -> Stone Form Stun
	call SetUnitAbilityLevel(Caster,'A1NF',Level)//A1NF -> Stone Form Stun
	call IssueImmediateOrderById(Caster,852127)
	set Source=null
	set Caster=null
endfunction

function PKG takes unit PMG,integer Y59,integer Level returns nothing
	local integer PNG
	if Level==1 then
		set PNG=8
	elseif Level==2 then
		set PNG=14
	elseif Level==3 then
		set PNG=22
	endif
	call AddBonusDamage(PMG,Y59*PNG)
endfunction

function POG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit PMG=(LoadUnitHandle(HY,h,2))
	local unit Source=PMG
	local integer Level=(LoadInteger(HY,h,5))
	local integer KAE=(LoadInteger(HY,h,28))
	local integer Y59=(LoadInteger(HY,h,194))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
		if GetAttacker()==PMG then
			set Y59=IMaxBJ(Y59-1,0)
			call SaveInteger(HY,h,194,(Y59))
			call PKG(PMG,Y59,Level)
		endif
	else
		set KAE=KAE+1
		call SaveInteger(HY,h,28,(KAE))
		if ModuloInteger(KAE,15)==0 then
			set Y59=IMinBJ(Y59+1,7)
			call SaveInteger(HY,h,194,(Y59))
		endif
		if GetUnitTypeId(Source)=='u017' or GetUnitTypeId(Source)=='u019' or GetUnitTypeId(Source)=='u018' or GetUnitTypeId(Source)=='u01A' or GetUnitTypeId(Source)=='u01B' or GetUnitTypeId(Source)=='u01C' or GetUnitTypeId(Source)=='u01U' or GetUnitTypeId(Source)=='u01V' or GetUnitTypeId(Source)=='u01W' then//u017 -> Stone Form, u019 -> Stone Form, u018 -> Stone Form, u01A -> Stone Form, u01B -> Stone Form, u01C -> Stone Form, u01U -> Stone Form, u01V -> Stone Form, u01W -> Stone Form
			set Y59=7
			call SaveInteger(HY,h,194,(Y59))
		endif
		call PKG(PMG,Y59,Level)
		if GetUnitTypeId(PMG)=='u017' or GetUnitTypeId(PMG)=='u019' or GetUnitTypeId(PMG)=='u018' or GetUnitTypeId(PMG)=='u01A' or GetUnitTypeId(PMG)=='u01B' or GetUnitTypeId(PMG)=='u01C' or GetUnitTypeId(PMG)=='u01U' or GetUnitTypeId(PMG)=='u01V' or GetUnitTypeId(PMG)=='u01W' then//u017 -> Stone Form, u019 -> Stone Form, u018 -> Stone Form, u01A -> Stone Form, u01B -> Stone Form, u01C -> Stone Form, u01U -> Stone Form, u01V -> Stone Form, u01W -> Stone Form
			call SetWidgetLife(PMG,GetWidgetLife(PMG)+31.25+18.75*Level)
		endif
	endif
	set t=null
	set PMG=null
	set Source=null
	return false
endfunction

function PPG takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())=='u014' or GetUnitTypeId(GetFilterUnit())=='u015' or GetUnitTypeId(GetFilterUnit())=='u016' or GetUnitTypeId(GetFilterUnit())=='u01D' or GetUnitTypeId(GetFilterUnit())=='u01E' or GetUnitTypeId(GetFilterUnit())=='u01F' or GetUnitTypeId(GetFilterUnit())=='u01R' or GetUnitTypeId(GetFilterUnit())=='u01S' or GetUnitTypeId(GetFilterUnit())=='u01T' or GetUnitTypeId(GetFilterUnit())=='u017' or GetUnitTypeId(GetFilterUnit())=='u019' or GetUnitTypeId(GetFilterUnit())=='u018' or GetUnitTypeId(GetFilterUnit())=='u01A' or GetUnitTypeId(GetFilterUnit())=='u01B' or GetUnitTypeId(GetFilterUnit())=='u01C' or GetUnitTypeId(GetFilterUnit())=='u01U' or GetUnitTypeId(GetFilterUnit())=='u01V' or GetUnitTypeId(GetFilterUnit())=='u01W' then//u014 -> Familiar, u015 -> Familiar, u016 -> Familiar, u01D -> Familiar, u01E -> Familiar, u01F -> Familiar, u01R -> Familiar, u01S -> Familiar, u01T -> Familiar, u017 -> Stone Form, u019 -> Stone Form, u018 -> Stone Form, u01A -> Stone Form, u01B -> Stone Form, u01C -> Stone Form, u01U -> Stone Form, u01V -> Stone Form, u01W -> Stone Form
		call KillUnit(GetFilterUnit())
	endif
	return false
endfunction

function Visage_Familiars takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit Source=GetTriggerUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local integer Level=GetUnitAbilityLevel(Source,'A1NE')//A1NE -> Familiars
	local unit PRG
	local unit PSG
	local unit PTG=null
	local trigger t
	local integer h
	local boolean PYF=false
	local integer i
	call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(Source),Condition(function PPG))
	call KillGroup(g)
	if Level==0 then
		set Level=GetUnitAbilityLevel(Source,'A2IG')//A2IG -> Familiars
		set PYF=true
	endif
	if Level==1 then
		set PRG=CreateUnit(GetOwningPlayer(Source),'u014',x+75,y+75,GetUnitFacing(Source))//u014 -> Familiar
		set PSG=CreateUnit(GetOwningPlayer(Source),'u01D',x-75,y-75,GetUnitFacing(Source))//u01D -> Familiar
	elseif Level==2 then
		set PRG=CreateUnit(GetOwningPlayer(Source),'u015',x+75,y+75,GetUnitFacing(Source))//u015 -> Familiar
		set PSG=CreateUnit(GetOwningPlayer(Source),'u01E',x-75,y-75,GetUnitFacing(Source))//u01E -> Familiar
	elseif Level==3 then
		set PRG=CreateUnit(GetOwningPlayer(Source),'u016',x+75,y+75,GetUnitFacing(Source))//u016 -> Familiar
		set PSG=CreateUnit(GetOwningPlayer(Source),'u01F',x-75,y-75,GetUnitFacing(Source))//u01F -> Familiar
	endif
	set i=GetUnitAbilityLevel(Source,'A0A8')
	call SelectUnitAddForPlayer(PRG,GetOwningPlayer(Source))
	call SelectUnitAddForPlayer(PSG,GetOwningPlayer(Source))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",PRG,"origin"))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",PSG,"origin"))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterDeathEvent(t,PRG)
	call TriggerAddCondition(t,Condition(function POG))
	call SaveUnitHandle(HY,h,2,(PRG))
	call SaveInteger(HY,h,5,(Level))
	call SaveInteger(HY,h,28,0)
	call SaveInteger(HY,h,194,7)
	call PKG(PRG,7,Level)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterDeathEvent(t,PSG)
	call TriggerAddCondition(t,Condition(function POG))
	call SaveUnitHandle(HY,h,2,(PSG))
	call SaveInteger(HY,h,5,(Level))
	call SaveInteger(HY,h,28,0)
	call SaveInteger(HY,h,194,7)
	call PKG(PSG,7,Level)
	if PYF then
		if Level==1 then
			set PTG=CreateUnit(GetOwningPlayer(Source),'u01R',x+75,y,GetUnitFacing(Source))//u01R -> Familiar
		elseif Level==2 then
			set PTG=CreateUnit(GetOwningPlayer(Source),'u01S',x+75,y,GetUnitFacing(Source))//u01S -> Familiar
		elseif Level==3 then
			set PTG=CreateUnit(GetOwningPlayer(Source),'u01T',x+75,y,GetUnitFacing(Source))//u01T -> Familiar
		endif
		call SelectUnitAddForPlayer(PTG,GetOwningPlayer(Source))
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",PTG,"origin"))
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerRegisterDeathEvent(t,PTG)
		call TriggerAddCondition(t,Condition(function POG))
		call SaveUnitHandle(HY,h,2,(PTG))
		call SaveInteger(HY,h,5,(Level))
		call SaveInteger(HY,h,28,0)
		call SaveInteger(HY,h,194,7)
		call PKG(PTG,7,Level)
	endif
	if i>0 then
		call FamiliarIncLevel(PRG,i)
		call FamiliarIncLevel(PSG,i)
		call FamiliarIncLevel(PTG,i)
	endif
	set g=null
	set Source=null
	set PRG=null
	set PSG=null
	set PTG=null
	set t=null
endfunction

function PUG takes nothing returns boolean
	if GetSpellAbilityId()=='A1NB' or GetSpellAbilityId()=='A1NC' or GetSpellAbilityId()=='A1ND' or GetSpellAbilityId()=='A1NL' or GetSpellAbilityId()=='A1NM' or GetSpellAbilityId()=='A1NN' or GetSpellAbilityId()=='A2IZ' or GetSpellAbilityId()=='A2J0' or GetSpellAbilityId()=='A2J1' then//A1NB -> Stone Form, A1NC -> Stone Form, A1ND -> Stone Form, A1NL -> Stone Form, A1NM -> Stone Form, A1NN -> Stone Form, A2IZ -> Stone Form, A2J0 -> Stone Form, A2J1 -> Stone Form
		call PJG()
	endif
	return false
endfunction

function Visage_Familiar_StoneForm takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function PUG))
	set t=null
endfunction

function PVG takes unit Source,integer HTD,integer PWG returns nothing
	local string c1="|c0000cc00"
	local string c="||"
	local string p=" "
	local string s=c1+"|||r"
	local string result
	local texttag tt=(LoadTextTagHandle(HY,(GetHandleId(Source)),451))
	if HTD==0 then
		set result=" "
	elseif PWG==1 then
		if HTD==0 then
			set result=c+p+c+p+c
		elseif HTD==1 then
			set result=s+p+c+p+c
		elseif HTD==2 then
			set result=s+p+s+p+c
		elseif HTD==3 then
			set result=s+p+s+p+s
		endif
	elseif PWG==2 then
		if HTD==0 then
			set result=c+p+c+p+c+p+c
		elseif HTD==1 then
			set result=s+p+c+p+c+p+c
		elseif HTD==2 then
			set result=s+p+s+p+c+p+c
		elseif HTD==3 then
			set result=s+p+s+p+s+p+c
		elseif HTD==4 then
			set result=s+p+s+p+s+p+s
		endif
	elseif PWG==3 then
		if HTD==0 then
			set result=c+p+c+p+c+p+c+p+c
		elseif HTD==1 then
			set result=s+p+c+p+c+p+c+p+c
		elseif HTD==2 then
			set result=s+p+s+p+c+p+c+p+c
		elseif HTD==3 then
			set result=s+p+s+p+s+p+c+p+c
		elseif HTD==4 then
			set result=s+p+s+p+s+p+s+p+c
		elseif HTD==5 then
			set result=s+p+s+p+s+p+s+p+s
		endif
	elseif PWG==4 then
		if HTD==0 then
			set result=c+p+c+p+c+p+c+p+c+p+c
		elseif HTD==1 then
			set result=s+p+c+p+c+p+c+p+c+p+c
		elseif HTD==2 then
			set result=s+p+s+p+c+p+c+p+c+p+c
		elseif HTD==3 then
			set result=s+p+s+p+s+p+c+p+c+p+c
		elseif HTD==4 then
			set result=s+p+s+p+s+p+s+p+c+p+c
		elseif HTD==5 then
			set result=s+p+s+p+s+p+s+p+s+p+c
		elseif HTD==6 then
			set result=s+p+s+p+s+p+s+p+s+p+s
		endif
	endif
	call SetTextTagText(tt,result,.023)
	call SetTextTagPosUnit(tt,Source,0)
	call SetTextTagVisibility(tt,GetOwningPlayer(Source)==GetLocalPlayer() and IsDead(Source)==false)
	call SetTextTagPermanent(tt,true)
	set tt=null
endfunction

function PXG takes unit Hero,integer Level returns nothing
	local integer PWG=GetUnitAbilityLevel(Hero,'A1NA')//A1NA -> Soul Assumption
	call PVG(Hero,Level,PWG)
	if Level==0 or((LoadInteger(HY,(GetHandleId((Hero))),(2484)))==1) then
		call UnitRemoveAbility(Hero,'A1O7')//A1O7 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O8')//A1O8 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O9')//A1O9 -> Spell Damage Reduction almost FULL
		call UnitAddAbility2(Hero,'A1O1')//A1O1 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O2')//A1O2 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NZ')//A1NZ -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1N9')//A1N9 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NY')//A1NY -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O0')//A1O0 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O3')//A1O3 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A0LR')//A0LR -> Soul Assumption FX Level 1
		call UnitRemoveAbility(Hero,'A0YP')//A0YP -> Soul Assumption FX Level 2
		call UnitRemoveAbility(Hero,'A0OG')//A0OG -> Soul Assumption FX Level 3
		call UnitRemoveAbility(Hero,'A0YO')//A0YO -> Soul Assumption FX Level 4
		call UnitRemoveAbility(Hero,'A0NF')//A0NF -> Soul Assumption FX Level 5
		call UnitRemoveAbility(Hero,'A0MD')//A0MD -> Soul Assumption FX Level 6
	elseif Level==1 then
		call UnitRemoveAbility(Hero,'A1O7')//A1O7 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O8')//A1O8 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O9')//A1O9 -> Spell Damage Reduction almost FULL
		call UnitRemoveAbility(Hero,'A1O1')//A1O1 -> Soul Assumption
		call UnitAddAbility2(Hero,'A1O2')//A1O2 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NZ')//A1NZ -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1N9')//A1N9 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NY')//A1NY -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O0')//A1O0 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O3')//A1O3 -> Soul Assumption
		call UnitAddAbility2(Hero,'A0LR')//A0LR -> Soul Assumption FX Level 1
		call UnitRemoveAbility(Hero,'A0YP')//A0YP -> Soul Assumption FX Level 2
		call UnitRemoveAbility(Hero,'A0OG')//A0OG -> Soul Assumption FX Level 3
		call UnitRemoveAbility(Hero,'A0YO')//A0YO -> Soul Assumption FX Level 4
		call UnitRemoveAbility(Hero,'A0NF')//A0NF -> Soul Assumption FX Level 5
		call UnitRemoveAbility(Hero,'A0MD')//A0MD -> Soul Assumption FX Level 6
	elseif Level==2 then
		call UnitRemoveAbility(Hero,'A1O7')//A1O7 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O8')//A1O8 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O9')//A1O9 -> Spell Damage Reduction almost FULL
		call UnitRemoveAbility(Hero,'A1O1')//A1O1 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O2')//A1O2 -> Soul Assumption
		call UnitAddAbility2(Hero,'A1NZ')//A1NZ -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1N9')//A1N9 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NY')//A1NY -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O0')//A1O0 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O3')//A1O3 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A0LR')//A0LR -> Soul Assumption FX Level 1
		call UnitAddAbility2(Hero,'A0YP')//A0YP -> Soul Assumption FX Level 2
		call UnitRemoveAbility(Hero,'A0OG')//A0OG -> Soul Assumption FX Level 3
		call UnitRemoveAbility(Hero,'A0YO')//A0YO -> Soul Assumption FX Level 4
		call UnitRemoveAbility(Hero,'A0NF')//A0NF -> Soul Assumption FX Level 5
		call UnitRemoveAbility(Hero,'A0MD')//A0MD -> Soul Assumption FX Level 6
	elseif Level==3 then
		call UnitRemoveAbility(Hero,'A1O7')//A1O7 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O8')//A1O8 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O9')//A1O9 -> Spell Damage Reduction almost FULL
		call UnitRemoveAbility(Hero,'A0LR')//A0LR -> Soul Assumption FX Level 1
		call UnitRemoveAbility(Hero,'A0YP')//A0YP -> Soul Assumption FX Level 2
		call UnitAddAbility2(Hero,'A0OG')//A0OG -> Soul Assumption FX Level 3
		call UnitRemoveAbility(Hero,'A0YO')//A0YO -> Soul Assumption FX Level 4
		call UnitRemoveAbility(Hero,'A0NF')//A0NF -> Soul Assumption FX Level 5
		call UnitRemoveAbility(Hero,'A0MD')//A0MD -> Soul Assumption FX Level 6
		call UnitRemoveAbility(Hero,'A1O1')//A1O1 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O2')//A1O2 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NZ')//A1NZ -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1N9')//A1N9 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NY')//A1NY -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O0')//A1O0 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O3')//A1O3 -> Soul Assumption
		if PWG==1 then
			call UnitAddAbility2(Hero,'A1O7')//A1O7 -> Soul Assumption
		else
			call UnitAddAbility2(Hero,'A1N9')//A1N9 -> Soul Assumption
		endif
	elseif Level==4 then
		call UnitRemoveAbility(Hero,'A1O7')//A1O7 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O8')//A1O8 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O9')//A1O9 -> Spell Damage Reduction almost FULL
		call UnitRemoveAbility(Hero,'A0LR')//A0LR -> Soul Assumption FX Level 1
		call UnitRemoveAbility(Hero,'A0YP')//A0YP -> Soul Assumption FX Level 2
		call UnitRemoveAbility(Hero,'A0OG')//A0OG -> Soul Assumption FX Level 3
		call UnitAddAbility2(Hero,'A0YO')//A0YO -> Soul Assumption FX Level 4
		call UnitRemoveAbility(Hero,'A0NF')//A0NF -> Soul Assumption FX Level 5
		call UnitRemoveAbility(Hero,'A0MD')//A0MD -> Soul Assumption FX Level 6
		call UnitRemoveAbility(Hero,'A1O1')//A1O1 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O2')//A1O2 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NZ')//A1NZ -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1N9')//A1N9 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NY')//A1NY -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O0')//A1O0 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O3')//A1O3 -> Soul Assumption
		if PWG==2 then
			call UnitAddAbility2(Hero,'A1O8')//A1O8 -> Soul Assumption
		else
			call UnitAddAbility2(Hero,'A1NY')//A1NY -> Soul Assumption
		endif
	elseif Level==5 then
		call UnitRemoveAbility(Hero,'A1O7')//A1O7 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O8')//A1O8 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O9')//A1O9 -> Spell Damage Reduction almost FULL
		call UnitRemoveAbility(Hero,'A1O1')//A1O1 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O2')//A1O2 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NZ')//A1NZ -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1N9')//A1N9 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NY')//A1NY -> Soul Assumption
		call UnitAddAbility2(Hero,'A1O0')//A1O0 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O3')//A1O3 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A0LR')//A0LR -> Soul Assumption FX Level 1
		call UnitRemoveAbility(Hero,'A0YP')//A0YP -> Soul Assumption FX Level 2
		call UnitRemoveAbility(Hero,'A0OG')//A0OG -> Soul Assumption FX Level 3
		call UnitRemoveAbility(Hero,'A0YO')//A0YO -> Soul Assumption FX Level 4
		call UnitAddAbility2(Hero,'A0NF')//A0NF -> Soul Assumption FX Level 5
		call UnitRemoveAbility(Hero,'A0MD')//A0MD -> Soul Assumption FX Level 6
		call UnitRemoveAbility(Hero,'A1O1')//A1O1 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O2')//A1O2 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NZ')//A1NZ -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1N9')//A1N9 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NY')//A1NY -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O0')//A1O0 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O3')//A1O3 -> Soul Assumption
		if PWG==3 then
			call UnitAddAbility2(Hero,'A1O9')//A1O9 -> Spell Damage Reduction almost FULL
		else
			call UnitAddAbility2(Hero,'A1O0')//A1O0 -> Soul Assumption
		endif
	elseif Level==6 then
		call UnitRemoveAbility(Hero,'A1O7')//A1O7 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O8')//A1O8 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O9')//A1O9 -> Spell Damage Reduction almost FULL
		call UnitRemoveAbility(Hero,'A1O1')//A1O1 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O2')//A1O2 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NZ')//A1NZ -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1N9')//A1N9 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1NY')//A1NY -> Soul Assumption
		call UnitRemoveAbility(Hero,'A1O0')//A1O0 -> Soul Assumption
		call UnitAddAbility2(Hero,'A1O3')//A1O3 -> Soul Assumption
		call UnitRemoveAbility(Hero,'A0LR')//A0LR -> Soul Assumption FX Level 1
		call UnitRemoveAbility(Hero,'A0YP')//A0YP -> Soul Assumption FX Level 2
		call UnitRemoveAbility(Hero,'A0OG')//A0OG -> Soul Assumption FX Level 3
		call UnitRemoveAbility(Hero,'A0YO')//A0YO -> Soul Assumption FX Level 4
		call UnitRemoveAbility(Hero,'A0NF')//A0NF -> Soul Assumption FX Level 5
		call UnitAddAbility2(Hero,'A0MD')//A0MD -> Soul Assumption FX Level 6
	endif
	if(GetUnitAbilityLevel(Hero,'A1NA')+2)==Level then//A1NA -> Soul Assumption
		call UnitAddAbility2(Hero,'A1NJ')//A1NJ -> Soul Assumption FX Level Final
	else
		call UnitRemoveAbility(Hero,'A1NJ')//A1NJ -> Soul Assumption FX Level Final
	endif
endfunction

function PYG takes unit Source,real Damage returns nothing
	local integer Level=0
	local real PZG=110
	if Damage>PZG*6 then
		set Level=6
	elseif Damage>PZG*5 then
		set Level=5
	elseif Damage>PZG*4 then
		set Level=4
	elseif Damage>PZG*3 then
		set Level=3
	elseif Damage>PZG*2 then
		set Level=2
	elseif Damage>PZG*1 then
		set Level=1
	endif
	set Level=IMinIF(Level,2+GetUnitAbilityLevel(Source,'A1NA'))//A1NA -> Soul Assumption
	call SaveInteger(HY,(GetHandleId(Source)),450,(Level))
	call PXG(Source,Level)
endfunction

function PAG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer PWG=GetUnitAbilityLevel(Source,'A1NA')//A1NA -> Soul Assumption
	call PVG(Source,(LoadInteger(HY,(GetHandleId((Source))),450)),PWG)
	call PYG(Source,(LoadReal(HY,(GetHandleId(Source)),443)))
	set t=null
	set Source=null
	return false
endfunction

function PBG takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit Source=tt_unit1
	local unit Target=tt_unit2
	local real Damage=(LoadReal(HY,h,20))
	set M88=true
	call DamageTarget(Source,Target,1,Damage)
	set M88=false
	if LoadBoolean(HY,h,20)==false and GetUnitAbilityLevel(Target,'A3E9')==1 and IsMagicImmune(Source)==false then
		call SaveUnitHandle(TempHash,'A3E9',0,Target)
		call SaveUnitHandle(TempHash,'A3E9',1,Source)
		call SaveInteger(TempHash,'A3E9',0,LoadInteger(HY,h,20))
		call ExecuteFunc("Visage_SoulAssumptionLotusOrb")
	endif
	call FlushChildHashtable(HY,h)
	set Source=null
	set Target=null
endfunction

function PCG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call PYG(Source,(LoadReal(HY,(GetHandleId(Source)),443)))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function Visage_SoulAssumption takes unit Source, unit Target, integer Level, boolean lotus returns nothing
	local trigger t=AddProjectile(Source,Target,'h0BE',"PBG",1000,false)//h0BE -> Gravekeeper's Cloak Projectile
	local integer h=GetHandleId(t)
	call SaveReal(HY,h,20,((20+Level*65)*1.))
	call SaveInteger(HY,h,20,Level)
	call SaveBoolean(HY,h,20,lotus)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AntiMagicShell\\AntiMagicShell.mdl",Source,"chest"))
	call SaveReal(HY,(GetHandleId(Source)),443,(0*1.))
	call PYG(Source,0)
	call AddTimedKeyToUnit(Source,2484,4)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerAddCondition(t,Condition(function PCG))
	call TriggerRegisterTimerEvent(t,4,false)
	call SaveUnitHandle(HY,h,2,(Source))
	set t=null
endfunction

function Visage_SoulAssumptionWrapper takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Visage_SoulAssumption(GetTriggerUnit(),GetSpellTargetUnit(),LoadInteger(HY,GetHandleId(GetTriggerUnit()),450),false)
	endif
endfunction

function Visage_SoulAssumptionLotusOrb takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	local integer lvl=LoadInteger(TempHash,'A3E9',0)
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	if IsBlocked(target)==false then
		call Visage_SoulAssumption(caster,target,lvl,true)
	endif
	set caster=null
	set target=null
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function P6G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real Damage=(LoadReal(HY,h,20))
	if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A1NA')then//A1NA -> Soul Assumption
		if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT then
			call SaveReal(HY,(GetHandleId(Source)),443,(((LoadReal(HY,(GetHandleId(Source)),443))-Damage)*1.))
		endif
		call PYG(Source,(LoadReal(HY,(GetHandleId(Source)),443)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	return false
endfunction

function Visage_SoulAssumption_Learn takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local integer h=GetHandleId(Source)
	local texttag tt=CreateTextTag()
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function PAG))
	call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
	call SetTextTagText(tt," ",.023)
	call SetTextTagPosUnit(tt,Source,0)
	call SetTextTagVisibility(tt,GetOwningPlayer(Source)==GetLocalPlayer())
	call SetTextTagPermanent(tt,true)
	set M78[GetPlayerId(GetOwningPlayer(Source))]=Source
	call SaveReal(HY,h,443,(0*1.))
	call PYG(Source,0)
	call SaveTextTagHandle(HY,h,451,(tt))
	set Source=null
	set t=null
	set tt=null
endfunction

function P1G takes unit P0G,unit P5G returns nothing
	local real Damage=GetEventDamage()
	local integer Level=GetUnitAbilityLevel(P0G,'A1NA')//A1NA -> Soul Assumption
	local real P2G=(LoadReal(HY,(GetHandleId(P0G)),443))
	local trigger t
	local integer h
	if DistanceBetweenUnits(P0G,P5G)<1400 and M88==false and IsRealDamage then
		if IsDamageReal(Damage)and GetEventDamage()>2 and GetEventDamageSource()!=GetTriggerUnit()and(IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource()))or GetUnitTypeId(GetEventDamageSource())=='n00L')then//n00L -> Roshan
			set P2G=P2G+Damage
			call SaveReal(HY,(GetHandleId(P0G)),443,((P2G)*1.))
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call SaveUnitHandle(HY,h,2,(P0G))
			call SaveReal(HY,h,20,((Damage)*1.))
			call TriggerRegisterTimerEvent(t,6,false)
			call TriggerRegisterDeathEvent(t,P0G)
			call TriggerRegisterUnitEvent(t,P0G,EVENT_UNIT_SPELL_EFFECT)
			call TriggerAddCondition(t,Condition(function P6G))
			call PYG(P0G,P2G)
		endif
	endif
	set t=null
endfunction

function Q4G takes nothing returns nothing
	local integer i=0
	loop
		exitwhen i>12
		if M78[i]!=null then
			call P1G(M78[i],GetTriggerUnit())
		endif
		set i=i+1
	endloop
endfunction

function Visage_SoulAssumption_Reg takes nothing returns nothing
	call RAD("Q4G")
endfunction

function QDG takes nothing returns boolean
	return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TmpUnit376))and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetWidgetLife(GetFilterUnit())>1)!=null//
endfunction

function SlowTargetUpheaval takes unit target, integer lvl returns nothing
	local unit d=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
	local integer slowid
	local integer slowlvl
	local integer i
	if lvl>12 then
		set lvl=12
	elseif lvl<1 then
		set lvl=1
	endif
	set slowid='A3HN'+(lvl-1)/4
	set slowlvl=ModuloInteger(lvl,4)
	if slowlvl==0 then
		set slowlvl=4
	endif
//	call echo(I2S(lvl)+" given, "+Id2String(slowid)+" bolt with lvl="+I2S(slowlvl))
	call UnitAddAbility(d,slowid)
	call SetUnitAbilityLevel(d,slowid,slowlvl)
	call IssueTargetOrder(d,"slow",target)
	set d=null
endfunction

function QEG takes nothing returns nothing
	call SlowTargetUpheaval(GetEnumUnit(),TmpInt377)
endfunction

function QFG takes unit Caster,unit Hero returns nothing
	local group g=GetAvailableGroup()
	set TmpUnit376=Hero
	call GroupEnumUnitsInRange(g,GetUnitX(Caster),GetUnitY(Caster),675,Condition(function QDG))
	call ForGroup(g,function QEG)
	call KillGroup(g)
	set g=null
endfunction

function QGG takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero
	local unit Caster=LoadUnitHandle(HY,h,19)
	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
		call KillUnit(Caster)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEvalCount(t)>22 then
		call KillUnit(Caster)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call InterruptUnit(LoadUnitHandle(HY,h,14))
	else
		call SetUnitAnimation(Caster,"birth")
		set Hero=LoadUnitHandle(HY,h,14)
		set TmpInt377=GetTriggerExecCount(t)*LoadInteger(HY,h,0)/ 2
		call QFG(Caster,Hero)
	endif
	set t=null
	set Caster=null
	set Hero=null
endfunction

function WL_Upheaval takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e01G',GetSpellTargetX(),GetSpellTargetY(),0)//e01G -> Upheaval Model
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddAction(t,function QGG)
	call SaveUnitHandle(HY,h,14,Hero)
	call SaveUnitHandle(HY,h,19,Caster)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
	set Hero=null
	set Caster=null
	set t=null
endfunction

function WL_Upheaval_Preload takes nothing returns nothing
	call PreloadQueryAdd('A0JE')
endfunction

function QJG takes nothing returns nothing
	call UnitAddAbility2(GetEnumUnit(),('A0P2'))//A0P2 -> Fatal Bonds
endfunction

function QKG takes nothing returns nothing
	call UnitRemoveAbility(GetEnumUnit(),('A0P2'))//A0P2 -> Fatal Bonds
endfunction

function QMG takes unit QNG,unit QOG returns nothing
	if QNG!=null and QOG!=null then
		call ZO8("CLPB",GetUnitX(QNG),GetUnitY(QNG),GetUnitX(QOG),GetUnitY(QOG),.7,.1,.9,1,.3)
	endif
endfunction

function QPG takes nothing returns nothing
	local unit Hero=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),14))
	local real Damage=.2*GetEventDamage()
	set Damage=RMinIF(Damage,GetWidgetLife(GetTriggerUnit()))
	if GetWidgetLife(GetEnumUnit())>1 and GetEnumUnit()!=GetTriggerUnit()then
		if GetWidgetLife(GetEnumUnit())<Damage then
			call DamageTarget(Hero,GetEnumUnit(),3,Damage)
		else
			call B18(GetEnumUnit(),Damage)
		endif
	endif
	set Hero=null
endfunction

function QQG takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local group g=(LoadGroupHandle(HY,h,220))
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		call ForGroup(g,function QKG)
		call FlushChildHashtable(HY,h)
		call KillGroup(g)
		call CleanTrigger((t))
	elseif GetEventDamage()>10 and GetEventDamage()<6000 and IsRealDamage then
		call DisableTrigger(t)
		call ForGroup(g,function QPG)
		call EnableTrigger(t)
	endif
	set t=null
	set g=null
endfunction

function QRG takes nothing returns boolean
	return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false)!=null//
endfunction

function WL_FatalBonds_FindClosest takes nothing returns nothing
	set tt_real1=DistanceBetweenUnits(GetEnumUnit(),tt_unit1)
	if tt_real1<tt_real2 then
		set tt_real2=tt_real1
		set TEMPUNIT=GetEnumUnit()
	endif
endfunction

function WL_FatalBounds takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local group g=GetAvailableGroup()
	local integer Level=GetUnitAbilityLevel(Hero,('A0J5'))//A0J5 -> Fatal Bonds
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer i=2
	local group WDF=GetAvailableGroup()
	local unit array QTG
	local string FX="Abilities\\Spells\\Undead\\Curse\\CurseTarget.mdl"
	if GetUnitAbilityLevel(Hero,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(Hero),0) then//Aloc -> Locust
		set Hero=LoadUnitHandle(HY,GetHandleId(Hero),0)
	endif
	call SaveUnitHandle(HY,h,14,(Hero))
	call QMG(Hero,Target)
	call Z48(FX,Target,"overhead",25)
	set QTG[1]=Target
	call SaveUnitHandle(HY,h,246,(QTG[1]))
	call TriggerRegisterUnitEvent(t,QTG[1],EVENT_UNIT_DAMAGED)
	call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),725,Condition(function QRG))
	call GroupRemoveUnit(g,Target)
	call GroupAddUnit(WDF,Target)
	call SaveGroupHandle(HY,h,220,(WDF))
	set tt_unit1=null
	loop
		exitwhen i>(1+2*Level)or FirstOfGroup(g)==null
		set tt_real2=9999
		set tt_unit1=QTG[i-1]
		set TEMPUNIT=null
		call ForGroup(g,function WL_FatalBonds_FindClosest)
		if TEMPUNIT!=null then
			set QTG[i]=TEMPUNIT
			call QMG(QTG[i-1],QTG[i])
			call TriggerRegisterUnitEvent(t,QTG[i],EVENT_UNIT_DAMAGED)
			call GroupAddUnit(WDF,QTG[i])
			call GroupRemoveUnit(g,QTG[i])
			call Z48(FX,QTG[i],"overhead",25)
			set i=i+1
		else
			exitwhen true
			
		endif
	endloop
	call SaveInteger(HY,h,245,(i-1))
	set TmpInt377=GetUnitAbilityLevel(Hero,('A0J5'))//A0J5 -> Fatal Bonds
	call ForGroup(WDF,function QJG)
	call TriggerRegisterTimerEvent(t,25,false)
	call TriggerAddAction(t,function QQG)
	call KillGroup(g)
	set g=null
	set t=null
	set Hero=null
	set Target=null
	set WDF=null
endfunction

function QVG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,0)
	if GetTriggerEvalCount(t)>LoadInteger(HY,h,1) or GetTriggerEventId()==EVENT_WIDGET_DEATH or GetUnitAbilityLevel(Target,'A17K')==0 then//A17K -> Shadow Word
		call UnitRemoveAbility(Target,'A17K')//A17K -> Shadow Word
		call UnitRemoveAbility(Target,'B0AP')//B0AP -> Shadow Word
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call DamageTarget(Source,Target,1,Level*10+10)
	endif
	set Source=null
	set Target=null
	set t=null
	return false
endfunction

function QWG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,0)
	if GetTriggerEvalCount(t)>LoadInteger(HY,h,1) or GetTriggerEventId()==EVENT_WIDGET_DEATH or GetUnitAbilityLevel(Target,'A0P0')==0 then//A0P0 -> Shadow Word
		call UnitRemoveAbility(Target,'A0P0')//A0P0 -> Shadow Word
		call UnitRemoveAbility(Target,'B073')//B073 -> |cff00ff00Shadow Word|r
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SetWidgetLife(Target,GetWidgetLife(Target)+Level*10+10)
	endif
	set Source=null
	set Target=null
	set t=null
	return false
endfunction

function WL_ShadowWord takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterDeathEvent(t,Target)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call SaveInteger(HY,h,1,11)//duration
	if IsUnitAlly(Target,GetOwningPlayer(Source))then
		call TriggerAddCondition(t,Condition(function QWG))
		call UnitAddAbility2(Target,'A0P0')//A0P0 -> Shadow Word
	elseif IsBlocked(GetSpellTargetUnit())==false then
		call TriggerAddCondition(t,Condition(function QVG))
		call UnitAddAbility2(Target,'A17K')//A17K -> Shadow Word
	endif
	set Source=null
	set Target=null
	set t=null
endfunction

function WL_ShadowWordOnCast takes nothing returns nothing
	if IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) and IsMagicImmune(GetSpellTargetUnit()) then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),"Cannot target magic immune enemies")
	endif
endfunction

function WL_ShadowWord_Preload takes nothing returns nothing
	call PreloadQueryAdd('A0P0')//A0P0 -> Shadow Word
	call PreloadQueryAdd('A17K')//A17K -> Shadow Word
endfunction

function QZG takes nothing returns nothing
	call DamageTarget(M98,GetEnumUnit(),1,20+10*MD8)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Immolation\\ImmolationDamage.mdl",GetEnumUnit(),"head"))
endfunction

function QAG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level
	local integer W78=GetUnitTypeId(Source)
	local group g
	local unit u
	local integer i=1
	if W78=='n00U' or W78=='n0KU' then//n00U -> Infernal, n0KU -> Infernal
		set Level=1
	elseif W78=='n00Y' or W78=='n0KV' then//n00Y -> Infernal, n0KV -> Infernal
		set Level=2
	elseif W78=='n00Z' or W78=='n0KW' then//n00Z -> Infernal, n0KW -> Infernal
		set Level=3
	endif
	if GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(Source))],'A0A8')>0 then
		set i=2
	endif
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		set Source=GetTriggerUnit()
		set i=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(Source))],'A0A8')
		if i>0 and GetUnitAbilityLevel(Source,'A3J0')==0 and (GetUnitTypeId(Source)=='n0KU' or GetUnitTypeId(Source)=='n0KV' or GetUnitTypeId(Source)=='n0KW') then
			set g=GetAvailableGroup()
			set tt_unit1=Source
			call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),275,Condition(function DefaultEnemyFilterWithAncients))
			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",GetUnitX(Source),GetUnitY(Source)))
			loop
				set u=FirstOfGroup(g)
				exitwhen u==null
				call DamageTarget(Source,u,1,50+50*i)
				call GroupRemoveUnit(g,u)
			endloop
			call KillGroup(g)
		else
//			call echo("no timer")
		endif
		set Source=null
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set tt_unit1=Source
		set M98=Source
		set MD8=Level
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),325,Condition(function DefaultEnemyFilterWithAncients))
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			call DamageTarget(Source,u,1,(20+10*Level)*i)
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Immolation\\ImmolationDamage.mdl",u,"head"))
			call GroupRemoveUnit(g,u)
		endloop
		
		//call ForGroup(g,function QZG)
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Source=null
	return false
endfunction

function QBG takes unit u returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function QAG))
	call SaveUnitHandle(HY,h,2,(u))
	if GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A0A8')>0 then
		if GetUnitTypeId(u)=='n00U' then
			call UnitAddAbility2(u,'A3IX')
		elseif GetUnitTypeId(u)=='n00Y' then
			call UnitAddAbility2(u,'A3IY')
		elseif GetUnitTypeId(u)=='n00Z' then
			call UnitAddAbility2(u,'A3IZ')
		elseif GetUnitAbilityLevel(u,'BNin')==0 then
			call UnitApplyTimedLife(u,'BTLF',60)
			call UnitAddAbility2(u,'A3J0')
		endif
	endif
	set t=null
endfunction

function QCG takes nothing returns boolean
	local integer W78=GetUnitTypeId(GetTriggerUnit())
	if W78=='n00U' or W78=='n0KU' or W78=='n00Y' or W78=='n0KV' or W78=='n00Z' or W78=='n0KW' then//n00U -> Infernal, n0KU -> Infernal, n00Y -> Infernal, n0KV -> Infernal, n00Z -> Infernal, n0KW -> Infernal
		call QBG(GetTriggerUnit())
	endif
	return false
endfunction

function Q3G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local real PLE=(LoadReal(HY,h,191))
	local real P1E=(LoadReal(HY,h,192))
	local integer Level=GetUnitAbilityLevel(Source,'S00U')//S00U -> Rain of Chaos
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',PLE,P1E,0)//e00E -> Spellcaster
	call UnitAddAbility2(Caster,'S00U')//S00U -> Rain of Chaos
	call SetUnitAbilityLevel(Caster,'S00U',Level)//S00U -> Rain of Chaos
	call IssuePointOrderById(Caster,852224,x,y)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set Source=null
	set Caster=null
	set t=null
	return false
endfunction

function Q6G takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.3,false)
	call TriggerAddCondition(t,Condition(function Q3G))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveReal(HY,h,6,((GetSpellTargetX())*1.))
	call SaveReal(HY,h,7,((GetSpellTargetY())*1.))
	call SaveReal(HY,h,191,((GetUnitX(Source))*1.))
	call SaveReal(HY,h,192,((GetUnitY(Source))*1.))
	set Source=null
	set t=null
endfunction

function WL_Infernal takes nothing returns nothing
	if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
		call Q6G()
	endif
endfunction

function WL_Infernal_Detect takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddCondition(t,Condition(function QCG))
	set t=null
endfunction

function WLFlamingFistAct takes unit attacker, unit target returns nothing
	local group g
	local unit u
	local real a
	local real dmg
	if GetRandomReal(0,100)<40 then
		set g=GetAvailableGroup()
		set a=AngleBetweenUnits(attacker,target)*bj_DEGTORAD
		if GetUnitAbilityLevel(attacker,'A0IM')==1 then//A0IM -> Flaming Fists
			set dmg=80
		elseif GetUnitAbilityLevel(attacker,'A0IQ')==1 then//A0IQ -> Flaming Fists
			set dmg=115
		else
			set dmg=150
		endif
		set tt_unit1=attacker
		call GroupEnumUnitsInRange(g,GetUnitX(target)+150*Cos(a),GetUnitY(target)+150*Sin(a),325,Condition(function DefaultEnemyFilterWithAncients))
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			call DamageTarget(attacker,u,7,dmg)
			call GroupRemoveUnit(g,u)
		endloop
		call KillGroup(g)
	endif
endfunction

function WLFlamingFistWrapper takes nothing returns nothing
	if IsInfernalGolem(UDSG_Attacker) and IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE)==false then
		call WLFlamingFistAct(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function Weaver_Shukuchi_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local unit u = LoadUnitHandle(TempHash,'A0CA',0)//A0CA -> Shukuchi
	local group g = LoadGroupHandle(MHT,GetHandleId(u),StringHash("ShukuGroup"))
	if u!=null and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(u)) and (t!=u) and IsUnitInGroup(t,g)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and IsDead(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then//
		call GroupAddUnit(g,t)
		call DamageTarget(u,t,1,LoadInteger(MHT,GetHandleId(u),StringHash("ShukuDamage")))
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",t,"chest"))
	endif
	set g=null
	set u=null
	set t = null
	return false
endfunction

function Weaver_Shukuchi_Duration takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local unit u = LoadUnitHandle(MHT,info,0)
	local group g
	if GetUnitAbilityLevel(u,'BHfs')==0 then//BHfs -> Shukuchi
		call KillGroup(LoadGroupHandle(MHT,GetHandleId(u),StringHash("ShukuGroup")))
		call Timer_End(t)
		set t = null
		set u = null
		return
	endif
	call SaveUnitHandle(TempHash,'A0CA',0,u)//A0CA -> Shukuchi
	set g= GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetWidgetX(u),GetWidgetY(u),200,Condition(function Weaver_Shukuchi_Targets))
	call KillGroup(g)
	call RemoveSavedHandle(TempHash,'A0CA',0)//A0CA -> Shukuchi
	set g=null
	set t = null
	set u = null
endfunction

function Weaver_Shukuchi_Start takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local integer info = GetHandleId(t)
	local integer level=GetUnitAbilityLevel(u,'A0CA')+GetUnitAbilityLevel(u,'QB01')//A0CA -> Shukuchi, QB01 -> Shukuchi
	call SaveUnitHandle(MHT,info,0,u)
	call SaveGroupHandle(MHT,GetHandleId(u),StringHash("ShukuGroup"),GetAvailableGroup())
	call SaveInteger(MHT,GetHandleId(u),StringHash("ShukuDamage"),level*25 + 50)
	call TimerStart(t,0.05,true,function Weaver_Shukuchi_Duration)
	set t = null
	set u = null
endfunction

function GeminateAttack_Learn takes nothing returns nothing
	call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0CN')//A0CN -> Geminate Attack
	call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0CR')//A0CR -> Geminate Attack
	call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0CS')//A0CS -> Geminate Attack
	call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0CM')//A0CM -> Geminate Attack
endfunction

function IncapacitatingBite_Learn takes nothing returns nothing
	call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0BM')//A0BM -> Incapacitating Bite
	call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0BL')//A0BL -> Incapacitating Bite
	call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0BN')//A0BN -> Incapacitating Bite
	call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0BO')//A0BO -> Incapacitating Bite
endfunction

function Q2G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	call SetUnitState((LoadUnitHandle(HY,h,26)),UNIT_STATE_MANA,(LoadReal(HY,h,242)))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	return false
endfunction

function R4G takes unit u,real R7G returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function Q2G))
	call SaveUnitHandle(HY,h,26,(u))
	call SaveReal(HY,h,242,((R7G)*1.))
	set t=null
endfunction

function Weaver_TimeLapse takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local integer h
	local real hp
	local real mp
	local real x
	local real y
	if GetSpellAbilityId()=='A3DM' then//A3DM -> Time Lapse
		set u=GetSpellTargetUnit()
	endif
	set h=GetHandleId(GetTriggerUnit())
	set hp=RMaxIF((LoadReal(HY,h,(7200+1))),1)
	set mp=RMaxIF((LoadReal(HY,h,(7250+1))),1)
	set x=(LoadReal(HY,h,(7300+1)))
	set y=(LoadReal(HY,h,(7350+1)))
	if(LoadReal(HY,h,(7200+1)))>1 and GetWidgetLife(u)>1 then
		call AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkTarget.mdl",GetUnitX(u),GetUnitY(u))
		call SetUnitX(u,x)
		call SetUnitY(u,y)
		call AddTimedKeyToUnit(u,'AFRZ',0.03)
		call SetWidgetLife(u,hp)
		call SetUnitState(u,UNIT_STATE_MANA,mp)
		if IsUnitType(u,UNIT_TYPE_SUMMONED)==false then
			call UnitRemoveBuffs(u,false,true)
		endif
		call RemoveDispellableBuffs(u)
		call R4G(u,mp)
	endif
	set u=null
endfunction

function Weaver_TimeLapse_Check takes nothing returns nothing
	if IsUnitIllusion(GetSpellTargetUnit()) then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),"Can't target illusions.")
	elseif LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetSpellTargetUnit())),139) and GetOwningPlayer(GetSpellTargetUnit())!=GetOwningPlayer(GetTriggerUnit()) then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),"Target has disablehelp active.")
	endif
endfunction

function RDG takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local unit u=(LoadUnitHandle(HY,(GetHandleId(t)),221))
	local integer h=GetHandleId(u)
	local integer i=1
	local integer k=10
	if h==0 then
		call FlushChildHashtable(HY,LoadInteger(HY,GetHandleId(t),0))
//		call echo("watcher destroyed")
		call DestroyTrigger(t)
		return
	endif
	loop
		exitwhen i>k
		call SaveReal(HY,h,(7300+(i-1)),(((LoadReal(HY,h,(7300+(i)))))*1.))
		call SaveReal(HY,h,(7350+(i-1)),(((LoadReal(HY,h,(7350+(i)))))*1.))
		call SaveReal(HY,h,(7200+(i-1)),(((LoadReal(HY,h,(7200+(i)))))*1.))
		call SaveReal(HY,h,(7250+(i-1)),(((LoadReal(HY,h,(7250+(i)))))*1.))
		set i=i+1
	endloop
	call SaveReal(HY,h,(7300+10),((GetUnitX(u))*1.))
	call SaveReal(HY,h,(7350+10),((GetUnitY(u))*1.))
	call SaveReal(HY,h,(7200+10),((GetWidgetLife(u))*1.))
	call SaveReal(HY,h,(7250+10),((GetUnitState(u,UNIT_STATE_MANA))*1.))
	set t=null
	set u=null
endfunction

function Weaver_TimeLapse_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEventPeriodic(t,.5)
	call TriggerAddAction(t,function RDG)
	call SaveUnitHandle(HY,GetHandleId(t),221,GetTriggerUnit())
	set t=null
endfunction

function RKG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer c=LoadInteger(HY,h,2)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call LoDStat_Sub(Target,c,"armourneg")
		//call UnitRemoveAbility(Target,'A1QZ')
		call SaveInteger(HY,(GetHandleId((Target))),(4290),2)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if GetTriggerUnit()==Target then
			call KillUnit(Source)
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==Source then
			call LoDStat_Add(Target,1,"armourneg")
			call SaveInteger(HY,h,2,c+1)
			//call SetUnitAbilityLevel(Target,'A1QZ',GetUnitAbilityLevel(Target,'A1QZ')+1)
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\SkeletalMageMissile\\SkeletalMageMissile.mdl",Target,"chest"))
		endif
	else
		call SetUnitX(Source,GetUnitX(Target)-40)
		call SetUnitY(Source,GetUnitY(Target)-40)
		if GenericCondition_IsDotAInvis(Target)and IsUnitVisibleLoD(Target,GetOwningPlayer(Source))==false then
			call KillUnit(Source)
		elseif ModuloInteger(GetTriggerEvalCount(t),5)==0 then
			call IssueTargetOrderById(Source,ORDER_attack,Target)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function RMG takes unit RNG,unit Target,integer Level returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer id=GetUnitTypeId(RNG)
	local player p=GetOwningPlayer(RNG)
	local real x=GetUnitX(RNG)
	local real y=GetUnitY(RNG)
	local real a=GetUnitFacing(RNG)
	call KillUnit(RNG)
	set RNG=CreateUnit(p,id,x,y,a)
	call UnitRemoveAbility(RNG,'Avul')//Avul -> Invulnerable
	call SaveUnitHandle(HY,h,2,(RNG))
	call SaveUnitHandle(HY,h,17,(Target))
	//call UnitAddAbility2(Target,'A1QZ')
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerRegisterDeathEvent(t,RNG)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function RKG))
	call TriggerEvaluate(t)
	call UnitApplyTimedLife(RNG,'BTLF',16)
	set t=null
endfunction

function ROG takes nothing returns boolean
	return DefaultEnemyFilterWithAncients() and LoadInteger(HY,GetHandleId(GetFilterUnit()),4290)!=1 and (IsUnitVisibleLoD(GetFilterUnit(),GetOwningPlayer(tt_unit1)) or GenericCondition_IsDotAInvis(GetFilterUnit())==false)
endfunction

function RPG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local group g
	local integer i=1
	local unit Source=LoadUnitHandle(HY,h,2)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local real a=LoadReal(HY,h,137)
	local unit RNG
	local unit Target
	local real TargetX=LoadReal(HY,h,47)
	local real TargetY=LoadReal(HY,h,48)
	set x=SafeX50(x+18*Cos(a))
	set y=SafeY50(y+18*Sin(a))
	call SaveReal(HY,h,6,x*1.)
	call SaveReal(HY,h,7,y*1.)
	if GetTriggerEvalCount(t)>166 then
		loop
			exitwhen i>12
			if(LoadBoolean(HY,h,511+i-1))==false then
				call KillUnit(LoadUnitHandle(HY,h,393+i-1))
			endif
			set i=i+1
		endloop
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set g=GetAvailableGroup()
		set tt_unit1=Source
		call GroupEnumUnitsInRange(g,x,y,400,Condition(function ROG))
		loop
			exitwhen i>12
			if(LoadBoolean(HY,h,511+i-1))==false then
				set RNG=LoadUnitHandle(HY,h,393+i-1)
				set x=LoadReal(HY,h,549+i-1)
				set y=LoadReal(HY,h,567+i-1)
				set x=SafeX50(x+18*Cos(a))
				set y=SafeY50(y+18*Sin(a))
				call SaveReal(HY,h,549+i-1,x*1.)
				call SaveReal(HY,h,567+i-1,y*1.)
				call SetUnitX(RNG,x)
				call SetUnitY(RNG,y)
				set Target=FirstOfGroup(g)
				if Target!=null then
					call GroupRemoveUnit(g,Target)
					call SaveInteger(HY,GetHandleId(Target),4290,1)
					call SaveBoolean(HY,h,511+i-1,true)
					call RMG(RNG,Target,LoadInteger(HY,h,0))
				endif
			endif
			set i=i+1
		endloop
		call KillGroup(g)
		set g=null
		set RNG=null
		set Target=null
	endif
	set t=null
	set Source=null
	return false
endfunction

function Weaver_TheSwarm takes nothing returns nothing
	local real TargetX=GetSpellTargetX()
	local real TargetY=GetSpellTargetY()
	local unit Source=GetTriggerUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local real a=AngleBetweenXY(x,y,TargetX,TargetY)*bj_DEGTORAD
	local unit Caster
	local real AO8=SafeX50(x+3000*Cos(a))
	local real AP8=SafeY50(y+3000*Sin(a))
	local integer i=1
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real offset
	local integer Level=GetUnitAbilityLevel(Source,'A1QW')//A1QW -> The Swarm
	local integer W78
	if Level==1 then
		set W78='u01K'//u01K -> Beetle - Level 1
	elseif Level==2 then
		set W78='u01H'//u01H -> Beetle - Level 2
	elseif Level==3 then
		set W78='u01J'//u01J -> Beetle - Level 3
	elseif Level==4 then
		set W78='u01L'//u01L -> Beetle - Level 4
	endif
	loop
		exitwhen i>12
		set Caster=CreateUnit(GetOwningPlayer(Source),W78,x+GetRandomInt(-300,300),y+GetRandomInt(-300,300),a*bj_RADTODEG)
		call SaveUnitHandle(HY,h,393+i-1,Caster)
		call SaveBoolean(HY,h,511+i-1,false)
		call SaveReal(HY,h,549+i-1,GetUnitX(Caster)*1.)
		call SaveReal(HY,h,567+i-1,GetUnitY(Caster)*1.)
		call UnitAddAbility(Caster,'Aloc')
		call UnitAddAbility(Caster,'Abun')
		set i=i+1
	endloop
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function RPG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,6,x*1.)
	call SaveReal(HY,h,7,y*1.)
	call SaveReal(HY,h,137,a*1.)
	call SaveReal(HY,h,47,AO8*1.)
	call SaveReal(HY,h,48,AP8*1.)
	call SaveInteger(HY,h,0,Level)
	set Source=null
	set Caster=null
	set t=null
endfunction

function Weaver_Swarm_Preload takes nothing returns nothing
	call PreloadUnit('u01K')//u01K -> Beetle - Level 1
	call PreloadUnit('u01H')//u01H -> Beetle - Level 2
	call PreloadUnit('u01J')//u01J -> Beetle - Level 3
	call PreloadUnit('u01L')//u01L -> Beetle - Level 4
	//call PreloadQueryAdd('A1QZ')
endfunction

function RVG takes unit Source,unit FJD returns unit
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,GetUnitX(FJD),GetUnitY(FJD),600,Condition(function NonImmuneEnemyFilter))
	call GroupRemoveUnit(g,FJD)
	set tt_unit1=GroupPickRandomUnit(g)
	call KillGroup(g)
	set g=null
	return tt_unit1
endfunction

function CaskConnect takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit dummy=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local unit source=LoadUnitHandle(HY,h,2)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==dummy then
			if LoadUnitHandle(HY,h,-1)==LoadUnitHandle(HY,h,2) then//1st bounce
				if GetUnitAbilityLevel(target,'A3E9')==1 and IsMagicImmune(source) and LoadBoolean(HY,h,0)==false then
					if IsBlocked(source)==false then
						call SaveUnitHandle(TempHash,'A3E9',0,target)
						call SaveUnitHandle(TempHash,'A3E9',1,source)
						call SaveInteger(TempHash,'A3E9',0,LoadInteger(HY,h,0))
						call ExecuteFunc("WD_ParalyzingCaskLotusOrb")
					else
						call RemoveLinkenBuff(source)
					endif
				endif
			endif
			if IsUnitType(target,UNIT_TYPE_HERO) or IsSuperCreepUnit(target) then
				call StunTargetLoD(target,1)
				call DamageTarget(source,target,1,75)
			else
				call StunTargetLoD(target,5)
				call DamageTarget(source,target,1,50+25*LoadInteger(HY,h,0))
			endif
			if LoadInteger(HY,h,1)>0 then
				call SaveUnitHandle(TempHash,'cask',0,target)
				call RemoveSavedHandle(TempHash,'cask',1)
				call SaveUnitHandle(TempHash,'cask',2,source)
				call SaveInteger(TempHash,'cask',0,LoadInteger(HY,h,0))
				call SaveInteger(TempHash,'cask',1,LoadInteger(HY,h,1))
				call ExecuteFunc("CaskBounce")
			else
				call FlushChildHashtable(TempHash,'cask')
			endif
			call CleanTrigger(t)
			call FlushChildHashtable(HY,h)
		endif
	else
		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)
	endif
	set dummy=null
	set target=null
	set t=null
endfunction

function CastCask takes unit Source,unit bounceFrom, unit bounceTo, integer lvl, integer c, boolean lotus returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(bounceFrom),GetUnitY(bounceFrom),0)//e00E -> Spellcaster
	local boolean b=IsUnitType(bounceTo,UNIT_TYPE_HERO)
	call TriggerRegisterUnitEvent(t,bounceTo,EVENT_UNIT_DAMAGED)
	call TriggerRegisterTimerEvent(t,15,false)
	call SaveUnitHandle(HY,h,0,Caster)
	call SaveUnitHandle(HY,h,-1,bounceFrom)
	call SaveUnitHandle(HY,h,1,bounceTo)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveInteger(HY,h,0,lvl)
	call SaveBoolean(HY,h,0,lotus)
	call SaveInteger(HY,h,1,c-1)
	call TriggerAddCondition(t,Condition(function CaskConnect))
	call UnitAddAbility(Caster,'A0WY')//A0WY -> Paralyzing casks effect fast
	call LotusOrbCasting(Caster,bounceTo,852095)
	set t=null
	set Caster=null
endfunction

function CaskBounce takes nothing returns nothing
	local unit bounceFrom=LoadUnitHandle(TempHash,'cask',0)
	local unit bounceTo=LoadUnitHandle(TempHash,'cask',1)
	local unit Source=LoadUnitHandle(TempHash,'cask',2)
	local integer lvl=LoadInteger(TempHash,'cask',0)
	local integer c=LoadInteger(TempHash,'cask',1)
	if bounceTo==null then
		set bounceTo=RVG(Source,bounceFrom)
	endif
	if bounceTo!=null then
		call CastCask(Source,bounceFrom,bounceTo,lvl,c,LoadBoolean(TempHash,'cask',0))
	endif
	set bounceFrom=null
	set Source=null
endfunction

function myParalyzinCask takes unit Hero, unit target, integer Level, boolean lotus returns nothing
	call SaveUnitHandle(TempHash,'cask',0,Hero)
	call SaveUnitHandle(TempHash,'cask',1,target)
	call SaveUnitHandle(TempHash,'cask',2,Hero)
	call SaveInteger(TempHash,'cask',0,Level)
	call SaveInteger(TempHash,'cask',1,Level*2+1)
	call SaveBoolean(TempHash,'cask',0,lotus)
	call CaskBounce()
endfunction

function WD_ParalyzingCask takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call myParalyzinCask(GetTriggerUnit(),GetSpellTargetUnit(),GetUnitAbilityLevel(GetTriggerUnit(),'A0NM'),false)//A0NM -> Paralyzing Cask
	endif
endfunction

function WD_ParalyzingCaskLotusOrb takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	local integer lvl=LoadInteger(TempHash,'A3E9',0)
	call LotusOrbFX(caster)
	call myParalyzinCask(caster,target,lvl,true)//A0NM -> Paralyzing Cask
	call FlushChildHashtable(TempHash,'A3E9')
	set caster=null
	set target=null
endfunction

function RBG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	local integer Level=GetUnitAbilityLevel(Hero,'A0NE')//A0NE -> Voodoo Restoration
	call UnitRemoveAbility(Hero,'A0NE')//A0NE -> Voodoo Restoration
	call UnitAddAbility2(Hero,'A0NE')//A0NE -> Voodoo Restoration
	call SetUnitAbilityLevel(Hero,'A0NE',Level)//A0NE -> Voodoo Restoration
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Hero=null
	return false
endfunction

function RCG takes unit Target,integer Level returns nothing
	local real VBE=(8+Level*8)/ 3
	call SetWidgetLife(Target,GetWidgetLife(Target)+VBE)
endfunction

function R3G takes nothing returns boolean
	if(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))then
		call RCG(GetFilterUnit(),tt_int1)
	endif
	return false
endfunction

function R6G takes unit Hero returns nothing
	local integer Level=GetUnitAbilityLevel(Hero,'A0NE')//A0NE -> Voodoo Restoration
	local group g=GetAvailableGroup()
	set tt_unit1=Hero
	set tt_int1=Level
	call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),525,Condition(function R3G))
	call KillGroup(g)
	set g=null
endfunction

function RLG takes unit Hero returns nothing
	local integer Level=GetUnitAbilityLevel(Hero,'A0NE')//A0NE -> Voodoo Restoration
	local real R1G=4+4*Level
	call SetUnitState(Hero,UNIT_STATE_MANA,GetUnitState(Hero,UNIT_STATE_MANA)-(R1G/ 3))
	if GetUnitState(Hero,UNIT_STATE_MANA)<R1G then
		if((LoadInteger(HY,(GetHandleId((Hero))),(4265)))==1)==false then
			call IssueImmediateOrderById(Hero,852178)
		endif
	endif
endfunction

function R0G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=(LoadUnitHandle(HY,h,14))
	if GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then
		if GetIssuedOrderId()==852178 then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call SaveUnitHandle(HY,h,14,(Hero))
			call TriggerRegisterTimerEvent(t,0,false)
			call TriggerAddCondition(t,Condition(function RBG))
		endif
	else
		call R6G(Hero)
		call RLG(Hero)
	endif
	set t=null
	set Hero=null
	return false
endfunction

function WD_VoodooRestoration takes nothing returns nothing
	local unit Hero=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,14,Hero)
	call TriggerRegisterTimerEvent(t,.33,true)
	call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_ORDER)
	call TriggerAddCondition(t,Condition(function R0G))
	set Hero=null
	set t=null
endfunction

function S4G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,0)
	local integer Count=GetTriggerEvalCount(t)
	local real S7G=LoadReal(HY,h,392)
	local real S9F=0
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call Buff_Remove(Target,'D002')
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if Count==4 or Count==8 or Count==12 then
			call DestroyEffect(LoadEffectHandle(HY,h,32))
			if Count==12 then
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
			elseif Count==4 or Count==8 then
				call DestroyEffect(LoadEffectHandle(HY,h,32))// to prevent leaks from this \/  stupid frog D:
				call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("effects\\NetherInferno.mdx",Target,"origin"))
			endif
			set S9F=(Level*.08 + 0.08)*RMaxIF(S7G-GetWidgetLife(Target),0)
			if S9F>0 then
				call TextTagOnUnit("+"+I2S(R2I(S9F)),2,Target,.023,68,0,187,216)
			endif
		endif
		call DamageTarget(Source,Target,1,Level*5+S9F)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function S8G takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local unit Target=GetEnumUnit()
	call Buff_Add(Target,'C002','D002',12.)
	call DestroyEffect(AddSpecialEffectTarget("effects\\NetherInferno.mdx",Target,"origin"))
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function S4G))
	call SaveUnitHandle(HY,h,17,Target)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call SaveReal(HY,h,392,GetWidgetLife(Target)*1.)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("effects\\NetherInferno.mdx",Target,"origin"))
	set t=null
	set Source=null
	set Target=null
endfunction

function WDMaledictFilter takes nothing returns boolean
	return(IsUnitIdType(GetUnitTypeId(GetFilterUnit()),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function WD_Maledict takes nothing returns nothing
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),190,Condition(function WDMaledictFilter))
	call ForGroup(g,function S8G)
	call KillGroup(g)
	set g=null
endfunction

function SEG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		call InterruptUnit(Source)
	endif
	set Source=null
	set t=null
	return false
endfunction

function WD_DeathWard takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,(Source))
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_FINISH)
	call TriggerRegisterTimerEvent(t,10,false)
	call TriggerAddCondition(t,Condition(function SEG))
	call LinkenSphere_SpreadOn(Source,false)
	set t=null
	set Source=null
endfunction

function SHG takes nothing returns boolean
	if GetUnitTypeId(GetSummonedUnit())=='o000' or GetUnitTypeId(GetSummonedUnit())=='o001' or GetUnitTypeId(GetSummonedUnit())=='o00A' or GetUnitTypeId(GetSummonedUnit())=='o00X' then//o000 -> Death Ward, o001 -> Death Ward, o00A -> Death Ward, o00X -> Death Ward
		call AddTimedKeyToUnit(GetSummoningUnit(),4265,8)
	endif
	return false
endfunction

function WD_DeathWard_Summon takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function SHG))
	set t=null
endfunction

function SIG takes nothing returns boolean
	local integer id=0
	local unit u
	local real time=TimerGetElapsed(GlobalTimer)
	local real hp
	local integer iceblastlvl
	loop
		exitwhen id>12
		set u=udg_Hero[id]
		set iceblastlvl=GetUnitAbilityLevel(u,'B0CD')
		if u!=null and iceblastlvl==0 and IceBlastTimestamp[id]>time then//B0CD -> Ice Blast
			set IceBlastTimestamp[id]=0
		endif
		if u!=null and iceblastlvl>0 then//B0CD -> Ice Blast
			if IceBlastTimestamp[id]>time and IsDead(u)==false then
				set hp=GetWidgetLife(u)
				if hp<IceBlastLife[id] or LoadInteger(HY,GetHandleId(u),'AFRZ')==1 then
					set IceBlastLife[id]=hp
				endif
				call SetWidgetLife(u,IceBlastLife[id])
				set IceBlastTicks[id]=IceBlastTicks[id]+1
				if IceBlastTicks[id]==10 and iceblastlvl>0 then
					set IceBlastTicks[id]=0
					call DamageTarget(IceBlastCaster[id],u,1,5+10*IceBlastLevel[id])
				endif
			elseif IceBlastTimestamp[id]>time and IsDead(u) then
				set IceBlastTimestamp[id]=0
				set IceBlastLife[id]=99999
			endif
			if(iceblastlvl>0 and IceBlastTimestamp[id]<time)then//B0CD -> Ice Blast
				call UnitRemoveAbility(u,'A1JA')//A1JA -> Ice Blast
				call UnitRemoveAbility(u,'B0CD')//B0CD -> Ice Blast
			endif
		endif
		set id=id+1
	endloop
	set u=null
	return false
endfunction

function SJG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,5)
	local unit Caster
	local string s
	local real endtime=LoadReal(HY,h,0)
	local integer c=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call UnitRemoveAbility(Target,'A1JA')//A1JA -> Ice Blast
		call UnitRemoveAbility(Target,'B0CD')//B0CD -> Ice Blast
		call RemoveSavedHandle(HY,GetHandleId(Target),'A1MI')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call echo("dest 1")
	elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		if TimerGetElapsed(GlobalTimer) > endtime then
			call UnitRemoveAbility(Target,'A1JA')//A1JA -> Ice Blast
			call UnitRemoveAbility(Target,'B0CD')//B0CD -> Ice Blast
			call RemoveSavedHandle(HY,GetHandleId(Target),'A1MI')
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
//			call echo("dest 2")
		else
			set c=c+1
			call SaveInteger(HY,h,0,c)
//			call echo("here")
			if ModuloInteger(c,10)==0 then
				call DamageTarget(LoadUnitHandle(HY,h,0),Target,1,5+10*Level)
			endif
		endif
		
	else
		if GetUnitAbilityLevel(Target,'A1JA')==0 then//B0CD -> Ice Blast
			if GetTriggerEvalCount(t)>4 then
				call UnitRemoveAbility(Target,'A1JA')//A1JA -> Ice Blast
				call UnitRemoveAbility(Target,'B0CD')//B0CD -> Ice Blast
				call RemoveSavedHandle(HY,GetHandleId(Target),'A1MI')
				call FlushChildHashtable(HY,h)
				call DestroyTrigger(t)
//				call echo("dest 3")
			endif
		elseif GetOwningPlayer(Target)!=GetOwningPlayer(GetEventDamageSource())and GetUnitState(Target,UNIT_STATE_MAX_LIFE)*(.09+.01*Level) > GetWidgetLife(Target)and((LoadInteger(HY,(GetHandleId((Target))),(2485)))!=1) then
			call RemoveSavedHandle(HY,GetHandleId(Target),'A1MI')
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
//			call echo("dest 4")
			call UnitRemoveAbility(Target,'A1JA')//A1JA -> Ice Blast
			call UnitRemoveAbility(Target,'B0CD')//B0CD -> Ice Blast
	//		call UnitRemoveAbility(Target,'A1LD')//A1LD -> Gust Container
			set s="Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl"
			call DestroyEffect(AddSpecialEffectTarget(s,Target,"overhead"))
			call DestroyEffect(AddSpecialEffectTarget(s,Target,"chest"))
			call DestroyEffect(AddSpecialEffectTarget(s,Target,"origin"))
			set Caster=CreateUnit(GetOwningPlayer(GetEventDamageSource()),'e00E',0,0,0)//e00E -> Spellcaster
			if IsUnitType(Target,UNIT_TYPE_SUMMONED)==false then
				call UnitRemoveBuffs(Target,true,true)
			endif
			call UnitRemoveAbility(Target,'Aetl')//Aetl -> Ethereal
			call DamageTarget(Caster,Target,4,100000000.)
			set Caster=null
		endif
	endif
	set t=null
	set Target=null
	return false
endfunction

function AA_IceBlast_Frozen takes unit Source,unit Target returns nothing
	local integer Level=GetUnitAbilityLevel(Source,'A1MI')+GetUnitAbilityLevel(Source,'A2QE')//A1MI -> Ice Blast, A2QE -> Ice Blast
	local integer id=GetPlayerId(GetOwningPlayer(Target))
	local trigger t
	local integer h
	local real freezdur=7+Level
//	set IceBlastTimestamp[id]=TimerGetElapsed(GlobalTimer)+7+Level
	if GetUnitAbilityLevel(Source,'A2QE')>0 then//A2QE -> Ice Blast
//		set IceBlastTimestamp[id]=TimerGetElapsed(GlobalTimer)+17
		set freezdur=17
	endif
	if Level>0 and IsUnitType(Target,UNIT_TYPE_HERO) and GetUnitAbilityLevel(Target,'A04R')==0 then//
		if HaveSavedHandle(HY,GetHandleId(Target),'A1MI') then
			set t=LoadTriggerHandle(HY,GetHandleId(Target),'A1MI')
			set h=GetHandleId(t)
		else
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call FlushChildHashtable(HY,h)
			call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
			call TriggerAddCondition(t,Condition(function SJG))
			call TriggerRegisterDeathEvent(t,Target)
			call TriggerRegisterTimerEvent(t,0.1,true)
			call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+freezdur*1.)
			call SaveUnitHandle(HY,h,17,(Target))
			call UnitAddAbility2(Target,'A1JA')//A1JA -> Ice Blast
			call SaveTriggerHandle(HY,GetHandleId(Target),'A1MI',t)
		endif
		call SaveInteger(HY,h,5,(Level))
		call SaveUnitHandle(HY,h,0,Source)
		call UnitFreezeHP(Target,freezdur)
		
	endif
	set t=null
endfunction

function AA_Ulti_Preload takes nothing returns nothing
//	local trigger t=CreateTrigger()
//	local integer id=0
//	call TriggerRegisterTimerEvent(t,.1,true)
//	call TriggerAddCondition(t,Condition(function SIG))
//	loop
//		exitwhen id>12
//		set IceBlastLife[id]=99999
//		set id=id+1
//	endloop
//	set t=null
endfunction

function SRG takes nothing returns nothing
	if IsUnitBADWithSpellbooks(GetEnumUnit())then
		return
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A1HZ')>0 then//A1HZ -> Ice Vortex 1
		call UnitRemoveAbility(GetEnumUnit(),'A1HZ')//A1HZ -> Ice Vortex 1
		call UnitRemoveAbility(GetEnumUnit(),'B0C5')//B0C5 -> Ice Vortex
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A1I4')>0 then//A1I4 -> Ice Vortex 2
		call UnitRemoveAbility(GetEnumUnit(),'A1I4')//A1I4 -> Ice Vortex 2
		call UnitRemoveAbility(GetEnumUnit(),'B0C5')//B0C5 -> Ice Vortex
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A1I3')>0 then//A1I3 -> Ice Vortex 3
		call UnitRemoveAbility(GetEnumUnit(),'A1I3')//A1I3 -> Ice Vortex 3
		call UnitRemoveAbility(GetEnumUnit(),'B0C5')//B0C5 -> Ice Vortex
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A1I6')>0 then//A1I6 -> Ice Vortex 4
		call UnitRemoveAbility(GetEnumUnit(),'A1I6')//A1I6 -> Ice Vortex 4
		call UnitRemoveAbility(GetEnumUnit(),'B0C5')//B0C5 -> Ice Vortex
	endif
endfunction

function SSG takes nothing returns nothing
	if IsUnitBADWithSpellbooks(GetEnumUnit())then
		return
	endif
	if IsMagicImmune(GetEnumUnit())==false then
		if MK8==1 then
			if GetUnitAbilityLevel(GetEnumUnit(),'A1HZ')==0 then//A1HZ -> Ice Vortex 1
				call UnitRemoveAbility(GetEnumUnit(),'B0C5')//B0C5 -> Ice Vortex
				call UnitAddAbility2(GetEnumUnit(),'A1HZ')//A1HZ -> Ice Vortex 1
			endif
		elseif MK8==2 then
			if GetUnitAbilityLevel(GetEnumUnit(),'A1I4')==0 then//A1I4 -> Ice Vortex 2
				call UnitRemoveAbility(GetEnumUnit(),'B0C5')//B0C5 -> Ice Vortex
				call UnitAddAbility2(GetEnumUnit(),'A1I4')//A1I4 -> Ice Vortex 2
			endif
		elseif MK8==3 then
			if GetUnitAbilityLevel(GetEnumUnit(),'A1I3')==0 then//A1I3 -> Ice Vortex 3
				call UnitRemoveAbility(GetEnumUnit(),'B0C5')//B0C5 -> Ice Vortex
				call UnitAddAbility2(GetEnumUnit(),'A1I3')//A1I3 -> Ice Vortex 3
			endif
		elseif MK8==4 then
			if GetUnitAbilityLevel(GetEnumUnit(),'A1I6')==0 then//A1I6 -> Ice Vortex 4
				call UnitRemoveAbility(GetEnumUnit(),'B0C5')//B0C5 -> Ice Vortex
				call UnitAddAbility2(GetEnumUnit(),'A1I6')//A1I6 -> Ice Vortex 4
			endif
		endif
	endif
endfunction

function STG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Caster=LoadUnitHandle(HY,h,19)
	local group GGF=LoadGroupHandle(HY,h,340)
	local real x=GetUnitX(Caster)
	local real y=GetUnitY(Caster)
	local group g=GetAvailableGroup()
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call ForGroup(GGF,function SRG)
		call KillGroup(g)
		call KillGroup(GGF)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call ShowUnit(Caster,false)
		set t=null
		set Source=null
		set Caster=null
		set GGF=null
		return false
	endif
	set MK8=LoadInteger(HY,h,0)
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,LoadReal(HY,h,'0aoe'),Condition(function DefaultEnemyFilterWithAncients))
	call GroupRemoveGroup(g,GGF)
	call ForGroup(GGF,function SRG)
	call ForGroup(g,function SSG)
	call SaveGroupHandle(HY,h,340,g)
	call KillGroup(GGF)
	set t=null
	set Source=null
	set Caster=null
	set GGF=null
	return false
endfunction

function AA_IceVortex takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'n0HQ',GetSpellTargetX(),GetSpellTargetY(),0)//n0HQ -> Snow Tornado
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call UnitApplyTimedLife(Caster,'BTLF',16)
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerRegisterDeathEvent(t,Caster)
	call TriggerAddCondition(t,Condition(function STG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,19,Caster)
	call SaveGroupHandle(HY,h,340,GetAvailableGroup())
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,'A1HS'))//A1HS -> Ice Vortex
	call SaveInteger(TempHash,'MULT',0,'A1HS')
	call SaveReal(HY,h,'0aoe',300)
	set tt_unit1=Source
	call ExecuteFunc("GetMulticastChance")
	if tt_int1>0 then
		call SaveReal(HY,h,'0aoe',300+100*(tt_int1-1))
		call SetUnitScale(Caster,1.+0.33*(tt_int1-1),1,1)
	endif
	set Source=null
	set Caster=null
	set t=null
endfunction

function SWG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local integer lvl=LoadInteger(HY,h,5)
	local real Damage=(100+50*lvl)/ 4
	local integer i=GetTriggerEvalCount(t)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))>765 or GetUnitAbilityLevel(Target,'B0CC')==0 then//B0CC -> Cold Feet
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call DestroyEffect(LoadEffectHandle(HY,h,176))
		call UnitRemoveAbility(Target,'A1J9')//A1J9 -> Cold Feet
		call UnitRemoveAbility(Target,'B0CC')//B0CC -> Cold Feet
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif i==8 or i==16 or i==25 or i==34 then
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\ShivasEnchantment.mdx",Target,"overhead"))
		call DamageTarget(Source,Target,1,Damage)
	elseif i>39 then
		call DestroyEffect(LoadEffectHandle(HY,h,176))
		call UnitRemoveAbility(Target,'A1J9')//A1J9 -> Cold Feet
		call UnitRemoveAbility(Target,'B0CC')//B0CC -> Cold Feet
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call StunTargetLoD(Target,0.5+0.75*lvl)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function SXG takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A1MG')//A1MG -> Cold Feet
	local string s="Doodads\\Cinematic\\GlowingRunes\\GlowingRunes4.mdl"
	if GetUnitTypeId(Source)=='e00E' then//e00E -> Spellcaster
		set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
	endif
	call UnitAddAbility2(Target,'A1J9')//A1J9 -> Cold Feet
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveReal(HY,h,6,GetUnitX(Target)*1.)
	call SaveReal(HY,h,7,GetUnitY(Target)*1.)
	call SaveInteger(HY,h,5,Level)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\ShivasEnchantment.mdx",Target,"overhead"))
	call SaveEffectHandle(HY,h,176,AddSpecialEffect(s,GetUnitX(Target),GetUnitY(Target)))
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function SWG))
	set Source=null
	set Target=null
	set t=null
endfunction

function AA_ColdFeet takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call SXG()
	endif
endfunction

function SZG takes nothing returns nothing
	local unit Source=MO8
	local unit Target=GetEnumUnit()
	local integer Level=MN8
	call AA_IceBlast_Frozen(Source,Target)
	call DamageTarget(Source,Target,1,150+100*Level)
	call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\PlasmaShot.mdl",Target,"chest"))
	set Source=null
	set Target=null
endfunction

function SAG takes nothing returns nothing
	local unit Source=MO8
	local unit Target=GetEnumUnit()
	local integer Level=MN8
	call AA_IceBlast_Frozen(Source,Target)
	set Source=null
	set Target=null
endfunction

function SBG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=LoadUnitHandle(HY,h,45)
	local real TargetX=LoadReal(HY,h,47)
	local real TargetY=LoadReal(HY,h,48)
	local real a=LoadReal(HY,h,13)
	local real RFE=LoadReal(HY,h,432)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer Level=LoadInteger(HY,h,5)
	local real x=GetUnitX(Projectile)+30*Cos(a)
	local real y=GetUnitY(Projectile)+30*Sin(a)
	local group g
	local fogmodifier fm
	if DistanceBetweenXY(x,y,TargetX,TargetY)<35 or x!=SafeX50(x)or y!=SafeY50(y)then
		set x=TargetX
		set y=TargetY
		call SetUnitX(Projectile,x)
		call SetUnitY(Projectile,y)
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		set fm=LoadFogModifierHandle(HY,h,440)
		call FogModifierStop(fm)
		call DestroyFogModifier(fm)
		set fm=null
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(Projectile)
		set tt_unit1=Source
		set MO8=Source
		set MN8=Level
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,x,y,RFE+25,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function SZG)
		call KillGroup(g)
		set g=null
	else
		call SetUnitX(Projectile,x)
		call SetUnitY(Projectile,y)
		set tt_unit1=Source
		set MO8=Source
		set MN8=Level
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,x,y,300,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function SAG)
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Projectile=null
	set Source=null
	return false
endfunction

function SCG takes unit Source,real x,real y,real N2F,effect FX,fogmodifier fm, integer Level returns nothing
	local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0B6',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)//h0B6 -> Ice Blast FX
	local real RFE=RMinIF(275+25*N2F*2,1000)
	local real YR8=DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),x,y)
	if IsUnitEnemy(Projectile,GetLocalPlayer())and IsObserver(GetLocalPlayer())==false then
		call UnitSetUsesAltIcon(Projectile,true)
	endif
	call TriggerRegisterTimerEvent(t,RMinIF(2./(YR8/ 30),.04),true)
	call TriggerAddCondition(t,Condition(function SBG))
	call SaveUnitHandle(HY,h,45,Projectile)
	call SaveReal(HY,h,47,x*1.)
	call SaveReal(HY,h,48,y*1.)
	call SaveReal(HY,h,13,a*1.)
	call SaveReal(HY,h,432,RFE*1.)
	call SaveInteger(HY,h,5,Level)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveFogModifierHandle(HY,h,440,fm)
	call SaveEffectHandle(HY,h,32,FX)
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1MI',true)//A1MI -> Ice Blast
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2QE',true)//A2QE -> Ice Blast
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1MN',false)//A1MN -> Ice Blast Helper
	set t=null
	set Projectile=null
endfunction

function S3G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=LoadUnitHandle(HY,h,45)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real a=LoadReal(HY,h,13)
	local real x
	local real y
	local real N2F=TimerGetElapsed(GlobalTimer)-LoadReal(HY,h,431)
	local string s
	local fogmodifier fm
	local effect FX
	local real S6G=GetUnitX(Projectile)+30*Cos(a)
	local real SLG=GetUnitY(Projectile)+30*Sin(a)
	local integer lvl=LoadInteger(HY,h,0)
	set x=SafeX50(S6G)
	set y=SafeY50(SLG)
	call SetUnitX(Projectile,x)
	call SetUnitY(Projectile,y)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or(GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A1MN')or x!=S6G or y!=SLG then//A1MN -> Ice Blast Helper
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call RemoveUnit(Projectile)
		set s=""
		if IsPlayerAlly(GetOwningPlayer(Source),GetLocalPlayer())or IsObserver(GetLocalPlayer())then
			set s="war3mapImported\\IceWindGroundFX.mdl"
		endif
		set fm=CreateFogModifierRadius(GetOwningPlayer(Source),FOG_OF_WAR_VISIBLE,x,y,500,true,true)
		call FogModifierStart(fm)
		set FX=AddSpecialEffect(s,x,y)
		call SCG(Source,x,y,N2F,FX,fm,lvl)
		set fm=null
		set FX=null
	endif
	set t=null
	set Projectile=null
	set Source=null
	return false
endfunction

function AA_IceBlast takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=CreateUnit(GetOwningPlayer(Source),'H0B8',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)//H0B8 -> Ice Blast
	if IsUnitEnemy(Projectile,GetLocalPlayer())and IsObserver(GetLocalPlayer())==false then
		call UnitSetUsesAltIcon(Projectile,true)
	endif
	call SaveUnitHandle(HY,h,45,Projectile)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,13,a*1.)
	call SaveReal(HY,h,431,TimerGetElapsed(GlobalTimer)*1.)
	call TriggerRegisterTimerEvent(t,.02,true)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call SaveInteger(HY,h,1,GetSpellAbilityId())
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function S3G))
	call SetUnitColor(Projectile,GetPlayerColor(Player(14)))
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1MI',false)//A1MI -> Ice Blast
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2QE',false)//A2QE -> Ice Blast
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1MN',true)//A1MN -> Ice Blast Helper
	call UnitAddAbility2(Source,'A1MN')//A1MN -> Ice Blast Helper
	set Source=null
	set t=null
	set Projectile=null
endfunction

function S5G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=(LoadInteger(HY,h,5))
	local integer S2G=(LoadInteger(HY,(GetHandleId(Source)),449))
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==Source and GetEventDamage()>1 and IsRealDamage then
			call DisableTrigger(t)
			if S2G>0 then
				call SaveInteger(HY,(GetHandleId(Source)),449,(S2G-1))
				call TextTagOnUnit("+"+I2S(40+10*Level),1,Source,.024,100,200,255,255)
				call DamageTarget(Source,Target,1,40+10*Level)
			endif
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	else
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function T4G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer Level=LoadInteger(HY,h,5)
	if GetTriggerEventId()!=EVENT_PLAYER_UNIT_ATTACKED or(LoadInteger(HY,GetHandleId(Source),449))==0 or GetUnitAbilityLevel(Source,'A1HN')==0 then//A1HN -> Chilling Touch buff
		//call DestroyEffect(LoadEffectHandle(HY,h,175))
		//call DestroyEffect(LoadEffectHandle(HY,h,176))
		call SaveInteger(HY,GetHandleId(Source),449,0)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveAbility(Source,'A1HN')//A1HN -> Chilling Touch buff
		call UnitRemoveAbility(Source,'B0CJ')//B0CJ -> Chilling Touch
	elseif GetAttacker()==Source and (LoadInteger(HY,GetHandleId(Source),4289)!=1)then
		call AddTimedKeyToUnit(Source,4289,.4)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
		call TriggerRegisterTimerEvent(t,2.,false)
		call TriggerAddCondition(t,Condition(function S5G))
		call SaveUnitHandle(HY,h,17,GetTriggerUnit())
		call SaveUnitHandle(HY,h,2,Source)
		call SaveInteger(HY,h,5,Level)
	endif
	set t=null
	set Source=null
	return false
endfunction

function T7G takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetEnumUnit()
	local trigger t
	local integer h
	local integer Level=GetUnitAbilityLevel(Source,'A1HQ')//A1HQ -> Chilling Touch
	if LoadInteger(HY,GetHandleId(Target),449)>0 and GetUnitAbilityLevel(Target,'A1HN')==1 then
		call SaveInteger(HY,GetHandleId(Target),449,2+Level+LoadInteger(HY,GetHandleId(Target),449))
		set Source=null
		set Target=null
		return
	endif
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call UnitAddAbility2(Target,'A1HN')//A1HN -> Chilling Touch buff
	
	call SaveUnitHandle(HY,h,2,Target)
	call SaveInteger(HY,h,5,Level)
	call TriggerRegisterTimerEvent(t,30,false)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerAddCondition(t,Condition(function T4G))
	set Source=null
	set Target=null
	set t=null
endfunction

function ChillingTouchAttackFilter takes nothing returns nothing
	local trigger t
	local integer h
	if GetUnitAbilityLevel(UDSG_Attacker,'A1HN')==1 then
		set t=LoadTriggerHandle(HY,GetHandleId(UDSG_Attacker),'A1HN')
		set h=GetHandleId(t)
		call TextTagOnUnit("+"+I2S(R2I(LoadReal(HY,h,1))),1,UDSG_Attacker,.024,100,200,255,255)
		call DamageTarget(UDSG_Attacker,UDSG_Target,1,LoadReal(HY,h,1))
		call SaveInteger(HY,h,0,LoadInteger(HY,h,0)-1)
		set t=null
	endif
endfunction

function ChillingTouchDur takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetUnitAbilityLevel(u,'A1HN')==0 or TimerGetElapsed(GlobalTimer) > LoadReal(HY,h,0) or LoadInteger(HY,h,0)<=0 then
		
		call RemoveSavedHandle(HY,GetHandleId(u),'A1HN')
		call UnitRemoveAbility(u,'A1HN')
		call UnitRemoveAbility(u,'B0CJ')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set u=null
	//call echo(I2S(GetHandleId(GetTriggerEventId())))
	
	set t=null
endfunction

function ChillingTouchApplying takes nothing returns nothing
	local unit target=GetEnumUnit()
	local integer hu=GetHandleId(target)
	local trigger t
	local integer h
	if HaveSavedHandle(HY,hu,'A1HN') then
		set t=LoadTriggerHandle(HY,hu,'A1HN')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call FlushChildHashtable(HY,h)
		call SaveTriggerHandle(HY,hu,'A1HN',t)
		call TriggerRegisterTimerEvent(t,0.2,true)
		call TriggerRegisterDeathEvent(t,target)
		call TriggerAddCondition(t,Condition(function ChillingTouchDur))
		call SaveUnitHandle(HY,h,0,target)
	endif
	call UnitAddAbility2(target,'A1HN')
	call SaveInteger(HY,h,0,tt_int1+2+LoadInteger(HY,h,0))
	call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+30)
	call SaveReal(HY,h,1,tt_int1*10+40)
	
	set t=null
	set target=null
endfunction

function AA_ChillingTouch takes nothing returns nothing
	local group g=GetAvailableGroup()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	call DestroyEffect(AddSpecialEffect("war3mapImported\\IcyWind.mdl",x,y))
	call GroupEnumUnitsInRange(g,x,y,550,Condition(function L58))
	call GroupAddUnit(g,GetTriggerUnit())
	set tt_int1=GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId())
	call ForGroup(g,function ChillingTouchApplying)
	call KillGroup(g)
	set g=null
endfunction

function Slark_DP_Self takes unit u, real dmg returns nothing
	if GetWidgetLife(u)<=dmg*.75 then
		set dmg=GetWidgetLife(u)/ .75-10
	endif
	call DamageTarget(u,u,1,dmg)
endfunction

function TFG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local group g
	local integer i=GetTriggerEvalCount(t)
	local unit u
	local real dmg
	local boolean b=LoadBoolean(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		set Source=null
		return false
	else
		set dmg=LoadReal(HY,h,0)
		if i==1 then
			call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(Source),'h0B2',x,y,0),'BTLF',1)//h0B2 -> DarkPact FX
			call TriggerRegisterTimerEvent(t,.1,true)
		elseif i==10 then
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
		call RemoveDispellableBuffs(Source)
		set g=GetAvailableGroup()
		set tt_unit1=Source
		call GroupEnumUnitsInRange(g,x,y,350,Condition(function DefaultEnemyFilterWithAncients))
		loop
			set u=FirstOfGroup(g)
			exitwhen u==null
			call DamageTarget(Source,u,1,dmg)
			call GroupRemoveUnit(g,u)
		endloop
		if b then
			call Slark_DP_Self(Source,dmg / 2)
		endif
		call KillGroup(g)
	endif
	set t=null
	set g=null
	set Source=null
	return false
endfunction

function Slark_DarkPact takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call SaveBoolean(HY,h,0,true)
	if GetUnitTypeId(Source)=='e00E'then//e00E -> Spellcaster
		set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
		call SaveBoolean(HY,h,0,false)
	endif
	call TriggerRegisterTimerEvent(t,1.5,false)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function TFG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId())*7.5)
	set t=null
	set Source=null
endfunction

function TIG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local player p
	local integer Level=GetUnitAbilityLevel(Source,'A1IN')//A1IN -> Shadow Dance
	local real Time=TimerGetElapsed(GlobalTimer)
	local real seen=LoadReal(HY,h,415)
	local real fade=LoadReal(HY,h,416)
	local integer mult
	if IsDead(Source)then
		set t=null
		set Source=null
		return false
	endif
	if IsSentinel(GetOwningPlayer(Source))then
		set p=Scourges[1]
	else
		set p=Sentinels[1]
	endif
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED and GetOwningPlayer(GetEventDamageSource())==Neutrals then
		if GetUnitAbilityLevel(Source,'A1IE')>0 then//A1IE -> Nightcrawler Container - 1
			call UnitRemoveAbility(Source,'A1IE')//A1IE -> Nightcrawler Container - 1
			call UnitRemoveAbility(Source,'B0C9')//B0C9 -> Nightcrawler
		endif
		if GetUnitAbilityLevel(Source,'A1IF')>0 then//A1IF -> Nightcrawler Container - 2
			call UnitRemoveAbility(Source,'A1IF')//A1IF -> Nightcrawler Container - 2
			call UnitRemoveAbility(Source,'B0C9')//B0C9 -> Nightcrawler
		endif
		if GetUnitAbilityLevel(Source,'A1IG')>0 then//A1IG -> Nightcrawler Container - 3
			call UnitRemoveAbility(Source,'A1IG')//A1IG -> Nightcrawler Container - 3
			call UnitRemoveAbility(Source,'B0C9')//B0C9 -> Nightcrawler
		endif
		call SaveReal(HY,h,414,(Time+2)*1.)
		set t=null
		set Source=null
		return false
	endif
	if(LoadReal(HY,h,414))>Time then
		set t=null
		set Source=null
		return false
	endif
	if (IsUnitVisibleLoD(Source,p) and GetUnitAbilityLevel(Source,'A1HX')==0) or GetUnitAbilityLevel(Source,'A36D')==1 then//A1HX -> Shadow Dance 2
		set fade=0
		if GetUnitAbilityLevel(Source,'A1IE')>0 or GetUnitAbilityLevel(Source,'A1IF')>0 or GetUnitAbilityLevel(Source,'A1IG')>0 then//A1IE -> Nightcrawler Container - 1, A1IF -> Nightcrawler Container - 2, A1IG -> Nightcrawler Container - 3
			set seen=seen+.1
			if seen>.4 then
				set seen=0
				if GetUnitAbilityLevel(Source,'A1IE')>0 then//A1IE -> Nightcrawler Container - 1
					call UnitRemoveAbility(Source,'A1IE')//A1IE -> Nightcrawler Container - 1
					call UnitRemoveAbility(Source,'B0C9')//B0C9 -> Nightcrawler
				endif
				if GetUnitAbilityLevel(Source,'A1IF')>0 then//A1IF -> Nightcrawler Container - 2
					call UnitRemoveAbility(Source,'A1IF')//A1IF -> Nightcrawler Container - 2
					call UnitRemoveAbility(Source,'B0C9')//B0C9 -> Nightcrawler
				endif
				if GetUnitAbilityLevel(Source,'A1IG')>0 then//A1IG -> Nightcrawler Container - 3
					call UnitRemoveAbility(Source,'A1IG')//A1IG -> Nightcrawler Container - 3
					call UnitRemoveAbility(Source,'B0C9')//B0C9 -> Nightcrawler
				endif
			endif
		endif
		call SaveReal(HY,h,415,seen*1.)
		call SaveReal(HY,h,416,fade*1.)
	elseif (IsUnitVisibleLoD(Source,p)==false or GetUnitAbilityLevel(Source,'A1HX')>0) and GetUnitAbilityLevel(Source,'A36D')==0 then//A1HX -> Shadow Dance 2
		set seen=0
		if(GetUnitAbilityLevel(Source,'A1IE'-1+Level)==0)then//A1IE -> Nightcrawler Container - 1
			set fade=fade+.1
			if fade>.4 then
				set fade=0
				if Level==1 then
					if GetUnitAbilityLevel(Source,'A1IE')==0 then//A1IE -> Nightcrawler Container - 1
						call UnitAddAbility2(Source,'A1IE')//A1IE -> Nightcrawler Container - 1
						call UnitMakeAbilityPermanent(Source,true,'A1I7')//A1I7 -> Nightcrawler FX
						call UnitMakeAbilityPermanent(Source,true,'A1I8')//A1I8 -> Nightcrawler MS - 1
					endif
				endif
				if Level==2 then
					if GetUnitAbilityLevel(Source,'A1IE')>0 then//A1IE -> Nightcrawler Container - 1
						call UnitRemoveAbility(Source,'A1IE')//A1IE -> Nightcrawler Container - 1
						call UnitRemoveAbility(Source,'B0C9')//B0C9 -> Nightcrawler
					endif
					if GetUnitAbilityLevel(Source,'A1IF')==0 then//A1IF -> Nightcrawler Container - 2
						call UnitAddAbility2(Source,'A1IF')//A1IF -> Nightcrawler Container - 2
						call UnitMakeAbilityPermanent(Source,true,'A1I7')//A1I7 -> Nightcrawler FX
						call UnitMakeAbilityPermanent(Source,true,'A1I9')//A1I9 -> Nightcrawler MS - 2
					endif
				endif
				if Level==3 then
					if GetUnitAbilityLevel(Source,'A1IE')>0 then//A1IE -> Nightcrawler Container - 1
						call UnitRemoveAbility(Source,'A1IE')//A1IE -> Nightcrawler Container - 1
						call UnitRemoveAbility(Source,'B0C9')//B0C9 -> Nightcrawler
					endif
					if GetUnitAbilityLevel(Source,'A1IF')>0 then//A1IF -> Nightcrawler Container - 2
						call UnitRemoveAbility(Source,'A1IF')//A1IF -> Nightcrawler Container - 2
						call UnitRemoveAbility(Source,'B0C9')//B0C9 -> Nightcrawler
					endif
					if GetUnitAbilityLevel(Source,'A1IG')==0 then//A1IG -> Nightcrawler Container - 3
						call UnitAddAbility2(Source,'A1IG')//A1IG -> Nightcrawler Container - 3
						call UnitMakeAbilityPermanent(Source,true,'A1I7')//A1I7 -> Nightcrawler FX
						call UnitMakeAbilityPermanent(Source,true,'A1IA')//A1IA -> Nightcrawler MS - 3
					endif
				endif
			endif
		elseif IsDead(Source)==false then
			set mult=2+Level
			call SetWidgetLife(Source,GetWidgetLife(Source)+GetUnitState(Source,UNIT_STATE_MAX_LIFE)/1000*mult)//1000 = 0.1% per 0.1s
		endif
		call SaveReal(HY,h,415,seen*1.)
		call SaveReal(HY,h,416,fade*1.)
	endif
	set t=null
	set Source=null
	return false
endfunction

function Slark_ShadowDance_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveReal(HY,h,415,0.0)
	call SaveReal(HY,h,416,0.0)
	call SaveReal(HY,h,414,TimerGetElapsed(GlobalTimer))
	call SaveUnitHandle(HY,h,2,GetTriggerUnit())
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function TIG))
	set t=null
endfunction

function Slark_ShadowDance_Attacked takes unit attacker, unit victim returns boolean
	if GetUnitAbilityLevel(victim,'A1HX')>0 then//A1HX -> Shadow Dance 2
		call IssueImmediateOrder(attacker,"stop")
		call Error(GetOwningPlayer(attacker),"This unit can't be attacked")
		return true
	endif
	return false
endfunction

function Slark_ImitateInvis takes nothing returns nothing
	local unit target=GetSpellTargetUnit()
	local unit u=GetTriggerUnit()
	if GetUnitAbilityLevel(target,'A1HX')>0 and ((IsUnitEnemy(target,GetOwningPlayer(u)) and GetUnitAbilityLevel(u,'Aloc')==0) or IsUnitType(u,UNIT_TYPE_HERO)==false and GetUnitTypeId(u)!='u00L') then//A1HX -> Shadow Dance 2, Aloc -> Locust, u00L -> ChronoSphere
		call IssueImmediateOrder(u,"stop")
		if IsUnitType(u,UNIT_TYPE_HERO)==false then
			call Error(GetOwningPlayer(u),"This unit can't be target for spell")
		endif
	endif
	set target=null
	set u=null
endfunction

function Slark_ShadowDance_Init takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CAST)
	call TriggerAddCondition(t,Condition(function Slark_ImitateInvis))
	set t=null
endfunction

function Slark_EssenceShift_RestoreStats takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer agi=LoadInteger(HY,h,422)
	local integer str=LoadInteger(HY,h,423)
	local integer int=LoadInteger(HY,h,424)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		if(LoadBoolean(HY,h,276))==false and GetTriggerUnit()==Source then
			call SaveBoolean(HY,h,276,(true))
			call SetHeroAgi(Source,GetHeroAgi(Source,false)-agi-str-int,true)
			call SaveInteger(HeroStats,GetHandleId(Source),31,LoadInteger(HeroStats,GetHandleId(Source),31)-agi-str-int)
			if LoadInteger(HY,h,0)>0 then
				call LoDStat_Sub(Source,LoadInteger(HY,h,0),"damage")
			endif
		elseif(LoadBoolean(HY,h,277))==false and GetTriggerUnit()==Target then
			call SaveBoolean(HY,h,277,(true))
			call SetHeroAgi(Target,GetHeroAgi(Target,false)+agi,true)
			call SetHeroStr(Target,GetHeroStr(Target,false)+str,true)
			call SetHeroInt(Target,GetHeroInt(Target,false)+int,true)
		endif
	else
		if(LoadBoolean(HY,h,276))==false then
			call SaveBoolean(HY,h,276,(true))
			call SetHeroAgi(Source,GetHeroAgi(Source,false)-agi-str-int,true)
			call SaveInteger(HeroStats,GetHandleId(Source),31,LoadInteger(HeroStats,GetHandleId(Source),31)-agi-str-int)
			if LoadInteger(HY,h,0)>0 then
				call LoDStat_Sub(Source,LoadInteger(HY,h,0),"damage")
			endif
		endif
		if(LoadBoolean(HY,h,277))==false then
			call SaveBoolean(HY,h,277,(true))
			call SetHeroAgi(Target,GetHeroAgi(Target,false)+agi,true)
			call SetHeroStr(Target,GetHeroStr(Target,false)+str,true)
			call SetHeroInt(Target,GetHeroInt(Target,false)+int,true)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function Slark_EssenceShift_StealPart takes unit Source,unit Target returns nothing
	local integer Level=GetUnitAbilityLevel(Source,'A1HR')//A1HR -> Essence Shift, QP1F -> Essence Shift
	local trigger t
	local integer h
	local integer agi
	local integer str
	local integer int
	local real dur
	local integer i=LoadInteger(MHT,GetHandleId(Source),EssenceShiftHash)+1
	local integer pid=GetPlayerId(GetOwningPlayer(Source))
	set agi=IMinBJ(GetHeroAgi(Target,false)-1,1)
	set str=IMinBJ(GetHeroStr(Target,false)-1,1)
	set int=IMinBJ(GetHeroInt(Target,false)-1,1)
	if i>3 then
		set i=1
	endif
	call SaveInteger(MHT,GetHandleId(Source),EssenceShiftHash,i)
	if((not(Mode_BO))and (i<3 or IsUnitIdType(GetUnitTypeId(Source),UNIT_TYPE_RANGED_ATTACKER)==false)) or Mode_BO then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SetHeroAgi(Source,GetHeroAgi(Source,false)+agi+str+int,true)
		call SaveInteger(HeroStats,GetHandleId(Source),31,LoadInteger(HeroStats,GetHandleId(Source),31)+agi+str+int)
		if GetUnitPrimaryAttribute(Source)!=2 then
			call LoDStat_Add(Source,agi+str+int,"damage")
			call SaveInteger(HY,h,0,agi+str+int)
		endif
		call SetHeroAgi(Target,GetHeroAgi(Target,false)-agi,true)
		call SetHeroStr(Target,GetHeroStr(Target,false)-str,true)
		call SetHeroInt(Target,GetHeroInt(Target,false)-int,true)
		call SaveInteger(HY,h,422,agi)
		call SaveInteger(HY,h,424,str)
		call SaveInteger(HY,h,423,int)
		call SaveUnitHandle(HY,h,2,Source)
		call SaveUnitHandle(HY,h,17,Target)
		call SaveBoolean(HY,h,276,false)
		call SaveBoolean(HY,h,277,false)
		set dur=20*Level
		call TriggerRegisterTimerEvent(t,dur,false)
		call TriggerRegisterDeathEvent(t,Source)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerAddCondition(t,Condition(function Slark_EssenceShift_RestoreStats))
		set t=null
	endif
endfunction

function Slark_EssenceShift_Actions takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	if GetTriggerEventId()!=EVENT_WIDGET_DEATH then
		call Slark_EssenceShift_StealPart(Source,Target)
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function Slark_EssenceShift_OnHit takes unit attacker, unit target returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.01,false)
	call TriggerAddCondition(t,Condition(function Slark_EssenceShift_Actions))
	call TriggerRegisterDeathEvent(t,attacker)
	call TriggerRegisterDeathEvent(t,target)
	call SaveUnitHandle(HY,h,2,attacker)
	call SaveUnitHandle(HY,h,17,target)
	set t=null
endfunction

function TAG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Caster=LoadUnitHandle(HY,h,19)
	local integer Level=LoadInteger(HY,h,5)
	if GetTriggerEvalCount(t)>3/ .03 then
		call UnitRemoveType(Source,UNIT_TYPE_PEON)
		call KillUnit(Caster)
		call SetTint(Source,-1,-1,-1,255)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call SetUnitX(Caster,GetUnitX(Source))
		call SetUnitY(Caster,GetUnitY(Source))
	endif
	//call UnitRemoveAbility(Source,'A04R')//
	set t=null
	set Source=null
	set Caster=null
	return false
endfunction

function Slark_ShadowDance takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A1IN')//A1IN -> Shadow Dance
	local real d=3
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'h0B1',GetUnitX(Source),GetUnitY(Source),0)//h0B1 -> Shadow Dance
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer i=-5
	local integer trans=255
	call ShowHideUnit(Source)
	call AddTimedAbility(Source,'A1HW',1,d)//A1HW -> Shadow Dance 1
	call AddTimedAbility(Source,'A1HX',1,d)//A1HX -> Shadow Dance 2
	call UnitAddType(Source,UNIT_TYPE_PEON)
	if IsUnitAlly(Source,GetLocalPlayer()) then
		set trans=0
	endif
	call SetTint(Source,-1,-1,-1,trans)
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function TAG))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,5,(Level))
	
	set Source=null
	set Caster=null
	set t=null
endfunction

function T3G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=GetTriggerEvalCount(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local lightning ZQ8=LoadLightningHandle(HY,h,196)
	local integer Level=LoadInteger(HY,h,5)
	local real SourceX=LoadReal(HY,h,189)
	local real SourceY=LoadReal(HY,h,190)
	local real TargetX=GetUnitX(Target)
	local real TargetY=GetUnitY(Target)
	local real AO8
	local real AP8
	local real LastX=LoadReal(HY,h,23)
	local real LastY=LoadReal(HY,h,24)
	local real a
	local real YR8=DistanceBetweenXY(LastX,LastY,TargetX,TargetY)
	call SaveReal(HY,h,23,((TargetX)*1.))
	call SaveReal(HY,h,24,((TargetY)*1.))
	if YR8>100 or Count>(3.5/ .03)or IsMagicImmune(Target) or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call DestroyLightning(ZQ8)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call MoveLightning(ZQ8,true,SourceX,SourceY,TargetX,TargetY)
		if DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)>325 then
			set a=Atan2(TargetY-SourceY,TargetX-SourceX)
			set AO8=SourceX+325*Cos(a)
			set AP8=SourceY+325*Sin(a)
			call SetUnitX(Target,AO8)
			call SetUnitY(Target,AP8)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set ZQ8=null
	return false
endfunction

function T6G takes unit Source,unit Target,integer Level returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local lightning ZQ8=AddLightning("PONC",true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
	call SetLightningColor(ZQ8,1,1,1,1)
	call SaveLightningHandle(HY,h,196,(ZQ8))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,189,((GetUnitX(Source))*1.))
	call SaveReal(HY,h,190,((GetUnitY(Source))*1.))
	call SaveReal(HY,h,23,((GetUnitX(Target))*1.))
	call SaveReal(HY,h,24,((GetUnitY(Target))*1.))
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function T3G))
	call DamageTarget(Source,Target,1,60*Level)
	call IssueTargetOrderById(Source,ORDER_attack,Target)
	set t=null
	set ZQ8=null
endfunction

function TLG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=GetTriggerEvalCount(t)
	local integer Level=LoadInteger(HY,h,5)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real a=LoadReal(HY,h,13)
	local real PLE=LoadReal(HY,h,189)
	local real P1E=LoadReal(HY,h,190)
	local real TargetX=LoadReal(HY,h,47)
	local real TargetY=LoadReal(HY,h,48)
	local real AO8=PLE+(30*(20+4*2)/ 30)*Count*Cos(a*bj_DEGTORAD)
	local real AP8=P1E+(30*(20+4*2)/ 30)*Count*Sin(a*bj_DEGTORAD)
	local real AHE=SquareRoot((AO8-TargetX)*(AO8-TargetX)+(AP8-TargetY)*(AP8-TargetY))
	local real AIE=700
	local real AJE=175
	local real AKE=(1-AHE/ AIE)*AJE*2
	local group g=GetAvailableGroup()
	local unit Target
	if Count==1 then
		call SetUnitTimeScale(Source,1.5)
	endif
	if AKE>AJE then
		set AKE=AJE*2-AKE
	endif
	if IsBuggyFlying(Source)==false then
		call SetUnitFlyHeight(Source,GetUnitDefaultFlyHeight(Source)+RMaxIF(AKE,0),0)
	endif
	if IsUnitType(Source,UNIT_TYPE_HERO)then
		call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
	endif
	call SetUnitX(Source,SafeX50(AO8))
	call SetUnitY(Source,SafeY50(AP8))
	call SetUnitFacing(Source,a)
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,AO8,AP8,120,Condition(function DF9))
	set Target=FirstOfGroup(g)
	call KillGroup(g)
	if AHE<30 or Target!=null or GetTriggerEvalCount(t)>75 then
		if IsBuggyFlying(Source)==false then
			call SetUnitFlyHeight(Source,GetUnitDefaultFlyHeight(Source),0)
		endif
		call SetUnitFacing(Source,a)
		call SetUnitTimeScale(Source,1)
		call SetUnitAnimation(Source,"stand")
		call SetUnitPathing(Source,true)
		call UnitRemoveAbility(Source,'A1J6')//A1J6 -> Pounce FX
		call KillTrees(GetUnitX(Source),GetUnitY(Source),100)
		if Target!=null and IsMagicImmune(Target)==false then
			call AddTimedKeyToUnit(Target,4408,5)
			call T6G(Source,Target,Level)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	set g=null
	return false
endfunction

function Slark_Pounce takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A1J7')//A1J7 -> Pounce
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real YR8=700
	local real a=GetUnitFacing(Source)
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real TargetX=SafeX50(SourceX+YR8*Cos(a*bj_DEGTORAD))
	local real TargetY=SafeY50(SourceY+YR8*Sin(a*bj_DEGTORAD))
	call UnitAddAbility2(Source,'Amrf')//Amrf -> Crow Form
	call UnitRemoveAbility(Source,'Amrf')//Amrf -> Crow Form
	call SetUnitPathing(Source,false)
	call UnitAddAbility2(Source,'A1J6')//A1J6 -> Pounce FX
	call TriggerRegisterTimerEvent(t,.03,true)
	call TriggerAddCondition(t,Condition(function TLG))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveReal(HY,h,189,((SourceX)*1.))
	call SaveReal(HY,h,190,((SourceY)*1.))
	call SaveReal(HY,h,47,((TargetX)*1.))
	call SaveReal(HY,h,48,((TargetY)*1.))
	set Source=null
	set t=null
endfunction

function T5G takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit Source=tt_unit1
	local unit Target=tt_unit2
	local real Damage=LoadReal(HY,h,20)
	call DamageTarget(Source,Target,1,Damage)
	set Source=null
	set Target=null
endfunction

function T2G takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetEnumUnit()
	local trigger t=AddProjectile(Source,Target,'h0BP',"T5G",700,false)//h0BP -> Scream of Pain Projectile
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A04A')//A04A -> Scream of Pain
	local real Damage
	if Level==1 then
		set Damage=85
	elseif Level==2 then
		set Damage=165
	elseif Level==3 then
		set Damage=225
	elseif Level==4 then
		set Damage=300
	endif
	call SaveReal(HY,h,20,((Damage)*1.))
	set Source=null
	set Target=null
	set t=null
endfunction

function QoP_ScreamOfPain takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local integer Level=GetUnitAbilityLevel(Source,'A04A')//A04A -> Scream of Pain
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),500,Condition(function LR8))
	call ForGroup(g,function T2G)
	call KillGroup(g)
	call PlaySoundOnUnitBJ(QE,100,Source)
	set Source=null
	set g=null
endfunction

function myWavesFilter takes unit u, unit dummy returns boolean
	return(IsUnitEnemy(dummy,GetOwningPlayer(u))and( AliveNonBuildOrMarker(u)))!=null
endfunction

function myWavesDamage takes unit u, unit victim, integer dt, real dmg, boolean immune returns nothing
	if myWavesFilter(victim,u) then
		if IsMagicImmune(victim)==false then
			call DamageTarget(u,victim,dt,dmg)
		elseif immune then
			call DamageTarget(u,victim,7,dmg)
		endif
	endif
endfunction

function myWaves takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local real dmg=LoadReal(HY,h,0)
	local real angle=LoadReal(HY,h,3)*bj_DEGTORAD
	local real speed=LoadReal(HY,h,4)
	local real tX=LoadReal(HY,h,5)
	local real tY=LoadReal(HY,h,6)
	local real startaoe=LoadReal(HY,h,8)
	local real step=LoadReal(HY,h,9)
	local unit victim
	local group g
	local group gg
	local boolean isDynamic=LoadBoolean(HY,h,10)
	local boolean final=false
	local integer dt=LoadInteger(HY,h,1)
	local boolean immune=LoadBoolean(HY,h,0)
	if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		call SetUnitX(u,GetUnitX(u)+speed*Cos(angle))
		call SetUnitY(u,GetUnitY(u)+speed*Sin(angle))
		call SaveInteger(HY,h,12,LoadInteger(HY,h,12)+1)
		if DistanceBetweenXY(GetUnitX(u),GetUnitY(u),tX,tY) < 100 or LoadInteger(HY,h,12) > LoadInteger(HY,h,13) then
			set final=true
			call SetUnitX(u,tX)
			call SetUnitY(u,tY)
		endif
	else
		set victim=GetTriggerUnit()
	endif
	if isDynamic then
		set g=LoadGroupHandle(HY,h,2)
		set gg=GetAvailableGroup()
		set tt_unit1=u
		call GroupEnumUnitsInRange(gg,GetUnitX(u),GetUnitY(u),startaoe + step * (GetTriggerEvalCount(t)-1),Condition(function LA8))
		call GroupRemoveGroup(g,gg)
		loop
			set victim=FirstOfGroup(gg)
			exitwhen victim==null
			call GroupRemoveUnit(gg,victim)
			call GroupAddUnit(g,victim)
			call myWavesDamage(LoadUnitHandle(HY,h,17),victim,dt,dmg,immune)
		endloop
		call KillGroup(gg)
		set gg=null
		if final then
			call KillGroup(g)
		endif
	else
		call myWavesDamage(LoadUnitHandle(HY,h,17),victim,dt,dmg,immune)
	endif
	if final then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(u)
		//call echo("destroyed")
	endif
	set u=null
	set g=null
	set gg=null
	set t=null
endfunction

function mySonicWave takes unit caster, integer uid, real dmg, real distance, real startaoe, real aoe, real fX, real fY, real tX, real tY, real speed, integer dt, boolean immune returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real angle=AngleBetweenXY(fX,fY,tX,tY)
	local unit u=CreateUnit(GetOwningPlayer(caster),uid,fX,fY,angle)
	local real per=0.02
	call SetUnitX(u,fX+startaoe*Cos(angle*bj_DEGTORAD))
	call SetUnitY(u,fY+startaoe*Sin(angle*bj_DEGTORAD))
	//call echo(R2S(fX)+" - "+R2S(fY)+" : "+R2S(GetUnitX(u))+" - "+R2S(GetUnitY(u)))
	call SaveUnitHandle(HY,h,0,u)
	call SaveReal(HY,h,0,dmg)
	call SaveReal(HY,h,1,distance)
	call SaveReal(HY,h,2,aoe)
	call SaveUnitHandle(HY,h,17,caster)
	if startaoe != aoe then
		call SaveReal(HY,h,8,startaoe)
		call SaveReal(HY,h,9,(aoe - startaoe) * per)
		call SaveGroupHandle(HY,h,2,GetAvailableGroup())
		call SaveBoolean(HY,h,10,true)//its dynamic aoe
	else
		call TriggerRegisterUnitInRange(t,u,aoe+25,Condition(function ReturnTrue))
	endif
	call SaveReal(HY,h,3,angle)
	call SaveReal(HY,h,4,speed * per)
	call SaveInteger(HY,h,13,R2I(distance / LoadReal(HY,h,4))+1)
	call SaveReal(HY,h,5,GetUnitX(u)+distance*Cos(angle*bj_DEGTORAD))
	call SaveReal(HY,h,6,GetUnitY(u)+distance*Sin(angle*bj_DEGTORAD))
	call SaveInteger(HY,h,1,dt)//damage type
	call SaveBoolean(HY,h,0,immune)//affects magic immune
	call TriggerRegisterTimerEvent(t,per,true)
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerAddCondition(t,Condition(function myWaves))
	set u=null
	set t=null
endfunction

function MyQoPSW takes nothing returns nothing
	local real dmg=325
	if GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId())==3 then
		set dmg=555
	elseif GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId())==2 then
		set dmg=440
	endif
	call mySonicWave(GetTriggerUnit(),'h02C',dmg,800,100,450,GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetSpellTargetX(),GetSpellTargetY(),800,7,true)//h02C -> Observer Wards
endfunction

function MyQoPSWBasic takes nothing returns nothing
	local real dmg=200+90*GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId())
	call mySonicWave(GetTriggerUnit(),'h02C',dmg,800,100,450,GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetSpellTargetX(),GetSpellTargetY(),800,7,true)//h02C -> Observer Wards
endfunction

function Func3848 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local unit target=LoadUnitHandle(HY,h,3)
	local real r=LoadReal(HY,h,0)-0.1
	local unit d
	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
		call RemoveFakeDust(target)
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	elseif r<=0 then
		call RemoveFakeDust(target)
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
		call InterruptUnit(caster)
	else
		call SaveReal(HY,h,0,r)
		call DamageTarget(caster,target,1,LoadReal(HY,h,1))
		if GetUnitAbilityLevel(target,'Bdet')==0 then
			call AddFakeDust(caster,target)
		endif
	endif
	set t=null
	set caster=null
	set target=null
	return false
endfunction

function ShadowShaman_Shackles takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer lvl=GetUnitAbilityLevel(caster,'A00P')//A00P -> Shackles
	local unit target=GetSpellTargetUnit()
	local real dmg=0
	local unit d
	if lvl==1 then
		set dmg=4.28
	elseif lvl==2 then
		set dmg=5.14
	elseif lvl==3 then
		set dmg=5.58
	else
		set dmg=6.
	endif
	call TriggerRegisterTimerEvent(t,0.1,true)
	call SaveReal(HY,h,0,2.75+0.75*lvl)
	call SaveReal(HY,h,1,dmg)
	//call TriggerRegisterTimerEvent(t,1+1.75+0.75*lvl,false)
	call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function Func3848))
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveUnitHandle(HY,h,3,target)
	call AddFakeDust(caster,target)
	set target=null
	set caster=null
	set t=null
endfunction

function ShadowShaman_MassSerpentWard takes unit u returns nothing
	local integer lvl=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A0A8')
	if lvl>0 then
		call UnitAddAbility3(u,'A3IO',lvl)
	endif
endfunction

function EtherShockWrapper takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetUnitFacing(GetTriggerUnit()))
	call UnitAddAbility(d,'A3IB')
	call SetUnitAbilityLevel(d,'A3IB',GetUnitAbilityLevel(GetTriggerUnit(),'A010'))
	call IssueTargetOrder(d,"forkedlightning",GetSpellTargetUnit())
	set d=null
endfunction

function UEG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit target = LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,5)

	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)==4 or IsMagicImmune(Source)then
		call Buff_Remove(target,'D011')
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	if GetTriggerEventId()!=EVENT_WIDGET_DEATH then
		call DamageTarget(Source,target,1,10 + (Level-1)*20)
	endif

	set t=null
	set target = null
	set Source=null
	return false
endfunction

function Phoenix_Dive_DisarmEnd takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer c=LoadInteger(HY,h,0)+1
	if IsMagicImmune(u) or c>20 or IsDead(u) then
		call UnitRemoveAbility(u,'A43V')
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	else
		call SaveInteger(HY,h,0,c)
	endif
	set u=null
	set t=null
endfunction

function Phoenix_Dive_Disarm takes unit u returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.1,true,function Phoenix_Dive_DisarmEnd)
	call UnitAddAbility2(u,'A43V')
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	set t=null
endfunction

function UFG takes unit u, unit Source, integer Level returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function UEG))
	call Buff_Add(Source,'C011','D011',4)
	if IsUnitType(Source,UNIT_TYPE_HERO) then
		call Phoenix_Dive_Disarm(Source)
	endif
	call SaveUnitHandle(HY,h,2,u)
	call SaveUnitHandle(HY,h,17,Source)
	call SaveInteger(HY,h,5,(Level))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl",Source,"chest")))
	set t=null
endfunction

function UGG takes nothing returns boolean
	local unit u = GetEnumUnit()

	if IsUnitInGroup(u,MQ8)==false and IsMagicImmune(u)==false then
		call GroupAddUnit(MQ8,u)
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\FireBlast.mdx",u,"chest"))
		call UFG(MS8,u,MR8)
	endif

	set u = null
	return false
endfunction

function UHG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=(LoadInteger(HY,h,34))
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real SourceX=(LoadReal(HY,h,189))
	local real SourceY=(LoadReal(HY,h,190))
	local real TargetX=(LoadReal(HY,h,47))
	local real TargetY=(LoadReal(HY,h,48))
	local real a=(LoadReal(HY,h,13))
	local real UIG=(1-I2R(Count)/ 50)*bj_PI
	local real UJG=1400/ 2*Cos(UIG)
	local real UKG=500/ 2*Sin(UIG)
	local real x=SafeX50(TargetX+UJG*Cos(a)-UKG*Sin(a))
	local real y=SafeY50(TargetY+UJG*Sin(a)+UKG*Cos(a))
	local group HND=(LoadGroupHandle(HY,h,133))
	local group g
	local integer Level=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()!='A1Z2' and Count>0)or Count>100 or IsUnitDisabledAny(Source)then//A1Z2 -> Target Fire Spirits
		call KillTrees(x,y,300)
		call SetTint(Source,-1,-1,-1,255)
		if(LoadInteger(HY,(GetHandleId(Source)),704))==0 or(LoadInteger(HY,(GetHandleId(Source)),704))=='A1RJ' then//A1RJ -> Icarus Dive
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1RJ',true)//A1RJ -> Icarus Dive
		endif
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A20N',false)//A20N -> Icarus Dive End
		call SetUnitPathing(Source,true)
		call KillGroup(HND)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		if ModuloInteger(Count,10)==0 then
			call KillTrees(x,y,200)
		endif
		call SaveInteger(HY,h,34,(Count+1))
		if IsUnitType(Source,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
		endif
		call SetUnitX(Source,x)
		call SetUnitY(Source,y)
		call SetUnitFacing(Source,(a+UIG-bj_PI/ 2)*bj_RADTODEG)
		set g=GetAvailableGroup()
		set MQ8=HND
		set tt_unit1=Source
		set MS8=Source
		set MR8=Level
		call GroupEnumUnitsInRange(g,x,y,325,Condition(function NonImmuneEnemyFilter))
		call ForGroup(g,function UGG)
		call KillGroup(g)
	endif
	set t=null
	set Source=null
	set g=null
	set HND=null
	return false
endfunction

function Phoenix_Dive takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real a=AngleBetweenXY(SourceX,SourceY,GetSpellTargetX(),GetSpellTargetY())*bj_DEGTORAD
	local real TargetX=SourceX+1400/ 2*Cos(a)
	local real TargetY=SourceY+1400/ 2*Sin(a)
	local real life = GetWidgetLife(Source)
	call SetWidgetLife(Source,life - life*.15)
	call AddTimedKeyToUnit(Source,4301,2)
	call AddTimedKeyToUnit(Source,4415,2)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function UHG))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveReal(HY,h,189,((SourceX)*1.))
	call SaveReal(HY,h,190,((SourceY)*1.))
	call SaveReal(HY,h,47,((TargetX)*1.))
	call SaveReal(HY,h,48,((TargetY)*1.))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call SaveGroupHandle(HY,h,133,(GetAvailableGroup()))
	call SetUnitPathing(Source,false)
	call SetTint(Source,-1,-1,-1,50)
	call UnitAddAbility2(Source,'A20N')//A20N -> Icarus Dive End
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1RJ',false)//A1RJ -> Icarus Dive
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A20N',true)//A20N -> Icarus Dive End
	set t=null
	set Source=null
endfunction

function UOG takes nothing returns nothing
	local unit Source=MT8
	local unit Target=GetEnumUnit()
	call DamageTarget(Source,Target,1,40+20*MU8)
	call Z48("Doodads\\Cinematic\\FireTrapUp\\FireTrapUp.mdl",Target,"origin",1)
	set Source=null
	set Target=null
endfunction

function UPG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer Level=LoadInteger(HY,h,0)
	local group g
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set tt_unit1=Source
		set MT8=Source
		set MU8=Level
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1025,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function UOG)
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Source=null
	return false
endfunction

function UQG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit URG=LoadUnitHandle(HY,h,589)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit target=LoadUnitHandle(HY,h,3)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		//call echo(R2S(GetEventDamage())+" from "+GetUnitName(GetEventDamageSource())+" "+B2S(IsFakeDamage)+" "+I2S(FakeDamageType))
		if IsFakeDamage>0 or IsUnitIllusion(GetEventDamageSource()) then
			call HealUnitFor(URG,GetEventDamage())
		endif
	else
		if GetUnitX(URG)!=x or GetUnitY(URG)!=y then
			call SetUnitPosition(URG,x,y)
		endif
		call IssueImmediateOrder(target,"stop")
		if GetUnitX(target)!=x or GetUnitY(target)!=y then
			call SetUnitPosition(target,x,y)
		endif
		if GetUnitY(Source)!=x or GetUnitY(Source)!=y then
			call SetUnitPosition(Source,x,y)
		endif
		set URG = LoadUnitHandle(HY,h,19)
		call SetUnitX(URG,GetWidgetX(Source))
		call SetUnitY(URG,GetWidgetY(Source))
	endif
	if GetTriggerEvalCount(t)==1 then
		call PauseUnit(Source,true)
	endif
	set t=null
	set URG=null
	set Source=null
	return false
endfunction

function USG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit target=LoadUnitHandle(HY,h,3)
	local unit UTG=LoadUnitHandle(HY,h,588)
	local unit URG=LoadUnitHandle(HY,h,589)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local unit WCE=LoadUnitHandle(HY,h,239)
	local integer Level=LoadInteger(HY,h,0)
	local group g
	local unit Caster
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call StopSound(IF,false,false)
		call ShowUnit(UTG,false)
		call ShowUnit(WCE,false)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call ShowUnit(Source,true)
		call UnitRemoveAbility(Source,'A04R')//
		call SetUnitInvulnerable(Source,false)
		call PauseUnit(Source,false)
		
		if target!=null and target!=Source then
			call ShowUnit(target,true)
			call UnitRemoveAbility(target,'A04R')//
			call SetUnitInvulnerable(target,false)
			call PauseUnit(target,false)
			if GetLocalPlayer()==GetOwningPlayer(target)then
				call ClearSelection()
				call SelectUnit(target,true)
			endif
			call SetWidgetLife(target,1)
			set Caster=CreateUnit(GetOwningPlayer(GetKillingUnit()),'e00E',0,0,0)//e00E -> Spellcaster
			if IsUnitType(target,UNIT_TYPE_SUMMONED)==false then
				call UnitRemoveBuffs(target,true,true)
			endif
			call UnitRemoveAbility(target,'Aetl')//Aetl -> Ethereal
			call DamageTarget(Caster,target,4,100000000)
		endif
		if GetLocalPlayer()==GetOwningPlayer(Source)then
			call ClearSelection()
			call SelectUnit(Source,true)
		endif
		call SetWidgetLife(Source,1)
		set Caster=CreateUnit(GetOwningPlayer(GetKillingUnit()),'e00E',0,0,0)//e00E -> Spellcaster
		if IsUnitType(Source,UNIT_TYPE_SUMMONED)==false then
			call UnitRemoveBuffs(Source,true,true)
		endif
		call UnitRemoveAbility(Source,'Aetl')//Aetl -> Ethereal
		call DamageTarget(Caster,Source,4,100000000)
		set Caster=null
	else
		if GetTriggerEvalCount(t)==1 then
			call SetUnitFlyHeight(URG,0,200)
		elseif GetTriggerEvalCount(t)==2 then
			call PauseUnit(URG,false)
			call UnitApplyTimedLife(URG,'BTLF',.1)
			call StopSound(IF,false,false)
			call StartSound(OF)
			call DestroyEffect(AddSpecialEffect("war3mapImported\\FireNova2.mdx",GetUnitX(UTG),GetUnitY(UTG)))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			
			call ShowUnit(Source,true)
			call UnitRemoveAbility(Source,'A04R')//
			call RemoveDispellableBuffs(target)
			call RefreshWithBalance(Source,false)
			call RemoveAbilsForUnit(Source)
			call SetUnitInvulnerable(Source,false)
			call SetUnitAnimationByIndex(Source,8)
			call QueueUnitAnimation(Source,"idle")
			call PauseUnit(Source,false)
			if GetLocalPlayer()==GetOwningPlayer(Source)then
				call ClearSelection()
				call SelectUnit(Source,true)
			endif
			
			if target!=null and target!=Source then
				call ShowUnit(target,true)
				call UnitRemoveAbility(target,'A04R')//
				call SetUnitInvulnerable(target,false)
				call SetUnitAnimationByIndex(target,8)
				call QueueUnitAnimation(target,"idle")
				call PauseUnit(target,false)
				
				call RefreshWithBalance(target,false)
				call RemoveAbilsForUnit(target)
				call RemoveDispellableBuffs(target)
				
				if GetLocalPlayer()==GetOwningPlayer(target) and IsUnitIllusion(target)==false then
					call ClearSelection()
					call SelectUnit(target,true)
				endif
				call AddTimedKeyToUnit(target,'AFRZ',0.03)
				call SetWidgetLife(target,GetUnitState(target,UNIT_STATE_MAX_LIFE))
				call SetUnitState(target,UNIT_STATE_MANA,GetUnitState(target,UNIT_STATE_MAX_MANA))
			endif
			call ShowUnit(UTG,false)
			call ShowUnit(WCE,false)
			call AddTimedKeyToUnit(Source,'AFRZ',0.03)
			call SetWidgetLife(Source,GetUnitState(Source,UNIT_STATE_MAX_LIFE))
			call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MAX_MANA))
			set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
			call UnitAddAbility2(Caster,'A1ZT')//A1ZT -> Supernova Stun
			call SetUnitAbilityLevel(Caster,'A1ZT',Level)//A1ZT -> Supernova Stun
			call IssueImmediateOrderById(Caster,852127)
			set Caster=null
		endif
	endif
	set t=null
	set Source=null
	set UTG=null
	set WCE=null
	set URG=null
	set g=null
	set target=null
	return false
endfunction

function UUG takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local unit UTG
	local unit URG
	local unit WCE=CreateUnit(GetOwningPlayer(Source),'h0CL',GetUnitX(Source),GetUnitY(Source),0)//h0CL -> Phoenix Down Ground
	local integer Level=GetUnitAbilityLevel(Source,'A1RK')+GetUnitAbilityLevel(Source,'A43H')//A1RK -> Supernova, A43H -> Supernova
	local unit Caster
	local unit target=GetSpellTargetUnit()
	
	set UTG=CreateUnit(GetOwningPlayer(Source),'h0BX',x,y,0)//h0BX -> Supernova Ground
	if Level==1 then
		set URG=CreateUnit(GetOwningPlayer(Source),'h0CV',x,y,0)//h0CV -> Supernova Sun 1
	elseif Level==2 then
		set URG=CreateUnit(GetOwningPlayer(Source),'h0CX',x,y,0)//h0CX -> Supernova Sun 2
	elseif Level==3 then
		set URG=CreateUnit(GetOwningPlayer(Source),'h0CW',x,y,0)//h0CW -> Supernova Sun 3
	endif
	call AddSpecialEffectTarget("war3mapImported\\PhoenixDown_2.mdl",UTG,"origin")
	if GetLocalPlayer()==GetOwningPlayer(Source)then
		call ClearSelection()
		call SelectUnit(URG,true)
	endif
	call KillTrees(x,y,400)
	
	call SetUnitInvulnerable(Source,true)
	call ShowUnit(Source,false)
	call UnitAddAbility2(Source,'A04R')//
	
	if target!=null and target!=Source then
		call ShowUnit(target,false)
		call UnitAddAbility2(target,'A04R')//
		call SetUnitX(target,x)
		call SetUnitY(target,y)
	endif
	
	call StartSound(IF)
	call UnitRemoveAbility(URG,'Arav')//Arav -> Storm Crow Form
	call UnitApplyTimedLife(UTG,'BTLF',6.1)
	call UnitApplyTimedLife(WCE,'BTLF',6.1)
	call UnitApplyTimedLife(URG,'BTLF',6.1)
	call TriggerRegisterTimerEvent(t,5.2,false)
	call TriggerRegisterTimerEvent(t,6,false)
	call TriggerAddCondition(t,Condition(function USG))
	call TriggerRegisterUnitEvent(t,URG,EVENT_UNIT_DEATH)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,3,target)
	call SaveUnitHandle(HY,h,588,UTG)
	call SaveUnitHandle(HY,h,589,URG)
	call SaveUnitHandle(HY,h,239,WCE)
	call SaveReal(HY,h,6,GetUnitX(Source)*1.)
	call SaveReal(HY,h,7,GetUnitY(Source)*1.)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterUnitEvent(t,URG,EVENT_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function UPG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerRegisterUnitEvent(t,URG,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,URG,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function UQG))
	call SaveUnitHandle(HY,h,589,URG)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,3,target)
	call SaveReal(HY,h,6,GetUnitX(Source)*1.)
	call SaveReal(HY,h,7,GetUnitY(Source)*1.)
	if EM9(Source,'I0A8')then//I0A8 -> Radiance (|cff00ff00On|r)
		set Caster = CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)//e00E -> Spellcaster
		call UnitAddAbility2(Caster,'A04I')//A04I -> Radiance Damage Aura
		call SaveUnitHandle(HY,h,19,Caster)
		set Caster = null
	endif
	set WCE=null
	set t=null
	set Source=null
	set UTG=null
	set URG=null
	set target=null
endfunction

function Phoenix_Supernova takes nothing returns nothing
	if LoadInteger(HY,GetHandleId(GetTriggerUnit()),1111111)!=1 then
		call UUG()
	endif
endfunction

function Phoenix_Supernova_Preload takes nothing returns nothing
	call PreloadQueryAdd('A1ZT')//A1ZT -> Supernova Stun
endfunction

function Phoenix_Sunray_End takes unit u, timer t, integer info returns nothing
	local player p = GetOwningPlayer(u)
	local integer save = GetHandleId(u)

	call DestroyLightning(LoadLightningHandle(MHT,info,6))
	call DestroyLightning(LoadLightningHandle(MHT,info,5))
	call DestroyLightning(LoadLightningHandle(MHT,info,4))
	call DestroyLightning(LoadLightningHandle(MHT,info,3))
	call DestroyLightning(LoadLightningHandle(MHT,info,2))
	call KillGroup(LoadGroupHandle(MHT,info,1))

	call SaveInteger(HY,save,4312,2)

	if LoadInteger(HY,save,704)==0 or LoadInteger(HY,save,704)=='A1YY' then//A1YY -> Sun Ray
		call SetPlayerAbilityAvailable2(p,'A1YY',true)//A1YY -> Sun Ray
	endif
	if LoadInteger(HY,save,4311)!=1 then
		call UnitRemoveAbility(u,'Abun')//Abun -> Cargo Hold (Orc Burrow)
	endif

	call SetPlayerAbilityAvailable2(p,'A1YY',true)//A1YY -> Sun Ray
	call SaveBoolean(MHT,save,'A1YY',false)//A1YY -> Sun Ray
	call SaveBoolean(MHT,save,'A205',false)//A205 -> Sun Ray Movement
	call UnitRemoveAbility(u,'A205')//A205 -> Sun Ray Movement
	call UnitRemoveAbility(u,'A1Z3')//A1Z3 -> Sun Ray
	call SetUnitPathing(u,true)

	call SetUnitAnimation(u,"stand")

	call StopSound(WF,false,true)

	call Timer_End(t)
endfunction

function Phoenix_Sunray_Target_Condition takes nothing returns boolean
	local unit t = GetFilterUnit()

	if GetUnitAbilityLevel(t,'A04R')==0 and IsDead(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and t!=group_temp_unit[0] and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)!=null) then//
		call GroupAddUnit(LoadGroupHandle(MHT,group_temp_integer[0],1),t)
	endif

	set t = null
	return false
endfunction

function Phoenix_Sunray_Targets takes nothing returns nothing
	local unit t = GetEnumUnit()
	local real amount = (group_temp_real[0] + group_temp_real[1]*GetUnitState(t,UNIT_STATE_MAX_LIFE))/5.

	if IsUnitAlly(group_temp_unit[0],GetOwningPlayer(t))then
		call SetWidgetLife(t,GetWidgetLife(t) + amount*0.5)
	else
		call DamageTarget(group_temp_unit[0],t,3,amount)
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\FireRayTarget.mdx",t,"origin"))
		call TimedReveal(GetOwningPlayer(t),2,GetUnitX(group_temp_unit[0]),GetUnitY(group_temp_unit[0]),500)
	endif

	set t = null
endfunction

function Phoenix_Sunray_Stop takes unit u, integer spell returns nothing
	//disables sunray when the units casts
	//supernova, spell steal, or cancel sunray
	if spell=='A1Z3' or spell=='A1RK' or spell=='A43H' or spell=='A27H' or spell=='A30J' then//A1Z3 -> Sun Ray, A1RK -> Supernova, A43H -> Supernova, A27H -> Spell Steal, A30J -> Spell Steal
		call SaveBoolean(MHT,GetHandleId(u),'A1YY',true)//A1YY -> Sun Ray
	endif
endfunction

function Phoenix_Sunray_Orders takes unit u, integer order returns nothing
	local integer info
	local real x2
	local real y2
	local real x1
	local real y1

	//pi parti :D
	//2 pi: 6.28318
	//1 pi: 3.14159
	//cake > pi \:D/

	if GetUnitAbilityLevel(u,'A205')>0then//A205 -> Sun Ray Movement
		if order==ORDER_attack then //prevents the unit from fleeing
			call DisableTrigger(GAME_TRIGGER)
			call InterruptUnit(u)
			call SetUnitAnimationByIndex(u,LoadInteger(MHT,GetUnitTypeId(u),'A1P8'))//A1P8 -> Charge of Darkness
			call EnableTrigger(GAME_TRIGGER)
			return
		endif

		set info = LoadInteger(MHT,GetHandleId(u),'A1YY')//A1YY -> Sun Ray

		if order==852177then //toggle movement on and off
			call SaveBoolean(MHT,info,1,true)
			call SetUnitAnimationByIndex(u,LoadInteger(MHT,GetUnitTypeId(u),'A1P8'))//A1P8 -> Charge of Darkness
		elseif order==852178then
			call SaveBoolean(MHT,info,1,false)
			call SetUnitAnimation(u,"stand")
		endif

		if order==851971 then //change angle order
			set x1 = GetWidgetX(u)
			set y1 = GetWidgetY(u)

			if GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER then
				set x2 = GetWidgetX(GetOrderTargetUnit())
				set y2 = GetWidgetY(GetOrderTargetUnit())
			else
				set x2 = GetOrderPointX()
				set y2 = GetOrderPointY()
			endif

			set x1 = Atan2(y2-y1,x2-x1)

			if 0 > x1 then
				//call BJDebugMsg("adding pi to angle cause blizzard is dumb") //BEST COMMENT EVA!!! >:333
				set x1 = x1 + 6.28318
			endif

			call SaveBoolean(MHT,info,0,true)
			call SaveReal(MHT,info,0,x1)
			call SaveReal(MHT,info,1,GetUnitFacing(u)*bj_DEGTORAD)

			call DisableTrigger(GAME_TRIGGER)
			call InterruptUnit(u)
			call EnableTrigger(GAME_TRIGGER)
		endif
	endif
endfunction

function Phoenix_Sunray_Duration takes nothing returns nothing
	local group g = null
	local lightning l = null
	local timer t = GetExpiredTimer()
	local integer load
	local integer level
	local integer loopA = 2
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local unit u = LoadUnitHandle(MHT,info,0)
	local boolean active
	local real offset
	local real angle
	local real ax2
	local real ay2
	local real ax1
	local real ay1
	local real x2
	local real y2
	local real z2
	local real x1
	local real y1
	local real z1
	set load = GetHandleId(u)
	if IsDead(u) or IsUnitDisabled(u)or IsUnitSilenced(u) or IsUnitPaused(u) or IsUnitCycloned(u) or LoadInteger(HY,GetHandleId(u),704)==-1 or count>239 or LoadBoolean(MHT,load,'A1YY') then//A1YY -> Sun Ray
		call Phoenix_Sunray_End(u,t,info)
		set t = null
		set u = null
		return
	endif
	set x1 = GetWidgetX(u)
	set y1 = GetWidgetY(u)
	set ax2 = GetWidgetLife(u)
	set angle = GetUnitFacing(u)*bj_DEGTORAD
	call SetWidgetLife(u,ax2 - ax2*0.0015)//6*0.025*0.01
	if LoadBoolean(MHT,info,0) then
		set angle = LoadReal(MHT,info,0)
		set ay2 = angle - GetUnitFacing(u)*bj_DEGTORAD
		set offset = LoadReal(MHT,info,1)
		set ax2 = angle - offset
		if ax2 > 0 then
			set ax1 = bj_DEGTORAD/2
		else
			set ax1 = -bj_DEGTORAD/2
		endif
		if -180*bj_DEGTORAD > ax2 or ax2 > 180*bj_DEGTORAD then
			set ax1 = -ax1
		endif
		set angle = offset + ax1
		call SaveReal(MHT,info,1,angle)
		if HaveSavedReal(MHT,info,2)then
			if 0>ay2 then
				set ay2 = -ay2
			endif
			if 0.02>ay2 then
				call SaveBoolean(MHT,info,0,false)
				call RemoveSavedReal(MHT,info,2)
			endif
		endif
		if LoadBoolean(MHT,info,0) then
			call SaveReal(MHT,info,2,ay2)
		endif
		//is the unit icarus diving \:3/
		if LoadInteger(HY,load,4301)!=1 then
			call SetUnitFacing(u,angle*bj_RADTODEG)
		endif
	endif
	if LoadBoolean(MHT,info,1)then
		set x1 = SafeX50(x1 +5*Cos(angle))
		set y1 = SafeY50(y1 +5*Sin(angle))
		call KillTrees(x1,y1,200)
		if IsUnitType(u,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(u),99,true)
		endif
		call SetUnitX(u,x1)
		call SetUnitY(u,y1)
	endif
	if count==1 then
		call DisableTrigger(GAME_TRIGGER)
		call InterruptUnit(u)
		call EnableTrigger(GAME_TRIGGER)
	endif
	set ax1 = Cos(angle)
	set ay1 = Sin(angle)
	set angle = (GetUnitFacing(u)+90)*bj_DEGTORAD
	set ax2 = Cos(angle)
	set ay2 = Sin(angle)
	set x1 = GetWidgetX(u) + 50*ax1
	set y1 = GetWidgetY(u) + 50*ay1
	call MoveLocation(ZeroLocation,x1,y1)
	set z1 = GetUnitFlyHeight(u)
	if 50>z1 then
		set z1 = 50
	endif
	set z1 = z1 + GetLocationZ(ZeroLocation)
	set x2 = x1 + 1150*ax1
	set y2 = y1 + 1150*ay1
	call MoveLocation(ZeroLocation,x2,y2)
	set z2 = GetLocationZ(ZeroLocation)
	loop
		exitwhen loopA == 7
		set angle = 30*(loopA/5)*Pow(-1,loopA)
		set offset = 30*((8-loopA)/5)*Pow(-1,loopA)
		set l = LoadLightningHandle(MHT,info,loopA)
		call MoveLightningEx(l,false, x1 + angle*ax2,y1 + angle*ay2,z1 + offset, x2,y2,z2)
		set loopA = loopA + 1
	endloop
	call DestroyEffect(AddSpecialEffect("war3mapImported\\FireRayTarget.mdx",x2,y2))
	call SaveInteger(MHT,info,0,count+1)
	if count/10 == count/10. then
		set x2 = x1
		set y2 = y1
		set loopA = 0
		set g = LoadGroupHandle(MHT,info,1)
		set group_temp_unit[0] = u
		set group_temp_integer[0] = info
		loop
			exitwhen loopA == 26
			set x2 = x2 + 50*ax1
			set y2 = y2 + 50*ay1
			call GroupEnumUnitsInRange(temp_group,x2,y2,100,Condition(function Phoenix_Sunray_Target_Condition))
			if loopA/3 == loopA/3.then
				call TimedReveal(GetOwningPlayer(u),2,x2,y2,225)
			endif
			set loopA = loopA + 1
		endloop
		set level = LoadInteger(MHT,info,-1)
		set angle = count/239.
		set offset = 8*level + 8
		set group_temp_real[0] = offset + offset*angle
		set group_temp_real[1] = (level*1.25 + angle*(level*1.25))/100
		call ForGroup(g,function Phoenix_Sunray_Targets)
		call GroupClear(g)
	endif
	set g = null //moar gut! :D
	set u = null
	set t = null
	set l=null   //no gut :P
endfunction

function Phoenix_Sunray_Start takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local timer t = CreateTimer()
	local integer loopA = 2
	local integer info = GetHandleId(t)
	local integer save = GetHandleId(u)

	call UnitAddAbility2(u,'Abun')//Abun -> Cargo Hold (Orc Burrow)
	call UnitAddAbility2(u,'A205')//A205 -> Sun Ray Movement
	call UnitAddAbility2(u,'A1Z3')//A1Z3 -> Sun Ray
	call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A1YY',false)//A1YY -> Sun Ray

	call SetUnitPathing(u,false)
	call SaveInteger(MHT,save,'A1YY',info)//A1YY -> Sun Ray
	call SaveBoolean(MHT,save,'A1YY',false)//A1YY -> Sun Ray

	call SaveUnitHandle(MHT,info,0,u)
	call SaveGroupHandle(MHT,info,1,GetAvailableGroup())
	call SaveBoolean(MHT,info,0,false)
	call SaveBoolean(MHT,info,1,false)
	call SaveInteger(MHT,info,-1,GetUnitAbilityLevel(u,GetSpellAbilityId()))
	call StartSound(WF)
	call SetSoundPosition(WF,GetWidgetX(u),GetWidgetY(u),100)

	call SetUnitAnimationByIndex(u,LoadInteger(MHT,GetUnitTypeId(u),'A1P8'))//A1P8 -> Charge of Darkness

	loop
		exitwhen loopA == 7
		call SaveLightningHandle(MHT,info,loopA,AddLightning("SRAY",false,0,0,0,0))
		set loopA = loopA + 1
	endloop

	call TimerStart(t,0.025,true,function Phoenix_Sunray_Duration)

	set u = null
	set t = null
endfunction

function Phoenix_Spirits_Leveling takes nothing returns nothing
	call UnitAddAbility2(GetTriggerUnit(),'A1YX')//A1YX -> Fire Spirits
	call SetUnitAbilityLevel(GetTriggerUnit(),'A1YX',GetUnitAbilityLevel(GetTriggerUnit(),'A331'))//A1YX -> Fire Spirits, A331 -> Fire Spirits
endfunction

function Phoenix_Spirits_Duration takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local unit target = LoadUnitHandle(MHT,info,0)

	if count<=1 or IsMagicImmune(target) or IsDead(target) then
		call RemoveSavedHandle(MHT,GetHandleId(target),'A1YX')//A1YX -> Fire Spirits
		call DestroyEffect(LoadEffectHandle(MHT,info,2))
		call Timer_End(t)
		call UnitRemoveAbility(target,'C010')
		call UnitRemoveAbility(target,'D010')
		set t = null
		set target = null
		return
	endif

	if count/4 == count/4. then
		call DamageTarget(LoadUnitHandle(MHT,info,1),target,1,LoadInteger(MHT,info,1))
	endif

	call SaveInteger(MHT,info,0,count-1)

	set t = null
	set target = null
endfunction

function Phoenix_Spirits_Damage_Start takes unit caster, unit target, integer lvl returns nothing
	local timer time=LoadTimerHandle(MHT,GetHandleId(target),'A1YX')//A1YX -> Fire Spirits
	local integer info
	if time!=null then
		call SaveInteger(MHT,GetHandleId(time),0,16)
	else
		set time = CreateTimer()
		set info = GetHandleId(time)
		call SaveUnitHandle(MHT,info,0,target)
		call SaveUnitHandle(MHT,info,1,caster)
		call SaveEffectHandle(MHT,info,2,AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl",target,"chest"))
		call SaveInteger(MHT,info,0,16)
		call SaveInteger(MHT,info,1,lvl*20-5)
		call TimerStart(time,0.25,true,function Phoenix_Spirits_Duration)
		call SaveTimerHandle(MHT,GetHandleId(target),'A1YX',time)//A1YX -> Fire Spirits
	endif
	set time = null
endfunction

function Phoenix_Spirits_Damage takes unit target, integer lvl returns nothing
	call Phoenix_Spirits_Damage_Start(group_temp_unit[0],target,lvl)
	call UnitAddAbility2(target,'C010')
endfunction

function Phoenix_Spirits_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()
	local unit u = group_temp_unit[0]

	if AliveNonBuildOrMarker(t) and IsUnitEnemy(u,GetOwningPlayer(t)) and IsMagicImmune(t)==false then
		call UnitAddAbilityTimedExF(t,'A45O'-1+TempInteger,1,4,0)
		call Phoenix_Spirits_Damage(t,TempInteger)
	endif

	set t = null
	set u = null
	return false
endfunction

function HideFireSpiritDelayB takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	call ShowUnit(u,false)
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTimer(t)
	set u=null
	set t=null
endfunction

function HideFireSpiritDelay takes unit u, real d returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,d,false,function HideFireSpiritDelayB)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	set t=null
endfunction

function WXG takes unit Source, unit Projectile, real x, real y, integer lvl returns nothing
	set group_temp_unit[0] = Source
	set TempInteger=lvl
	call GroupEnumUnitsInRange(temp_group,x,y,200,Condition(function Phoenix_Spirits_Targets))
	call DestroyEffect(AddSpecialEffect("war3mapImported\\Firaga_2.mdx",x,y))
	call KillUnit(Projectile)
	call HideFireSpiritDelay(Projectile,1.)
	//call ShowUnit(Projectile,false)
endfunction

function WYG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=LoadInteger(HY,h,34)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local unit WZG=LoadUnitHandle(HY,h,393)
	local real GWG=LoadReal(HY,h,685)
	local real TargetX
	local real TargetY
	local real x
	local real y
	local real a
	local real r=18
	local integer Level=LoadInteger(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		set TargetX=GetUnitX(Target)
		set TargetY=GetUnitY(Target)
		call SaveReal(HY,h,47,TargetX*1.)
		call SaveReal(HY,h,48,TargetY*1.)
		call RemoveSavedHandle(HY,h,17)
		call SaveUnitHandle(HY,h,17,null)
	elseif Target==null then
		set TargetX=LoadReal(HY,h,47)
		set TargetY=LoadReal(HY,h,48)
	else
		set TargetX=GetUnitX(Target)
		set TargetY=GetUnitY(Target)
	endif
	set a=AngleBetweenXY(GetUnitX(WZG),GetUnitY(WZG),TargetX,TargetY)
	call SetUnitFacing(WZG,a)
	set a = a*bj_DEGTORAD
	set x=GetWidgetX(WZG)+r*Cos(a)
	set y=GetWidgetY(WZG)+r*Sin(a)
	call SetUnitX(WZG,x)
	call SetUnitY(WZG,y)
	if DistanceBetweenXY(x,y,TargetX,TargetY)<r*2 then
		call WXG(Source,WZG,x,y,Level)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	set WZG=null
	return false
endfunction

function WAG takes unit Source,unit WZG,unit Target,real GWG,unit Caster returns nothing
	local trigger t=null
	local integer h
	if Source==Target then
		call KillUnit(WZG)
		call ShowUnit(WZG,false)
		return
	endif
	set t = CreateTrigger()
	set h = GetHandleId(t)
	call SetUnitVertexColor(WZG,255,255,255,255)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function WYG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveUnitHandle(HY,h,393,WZG)
	call SaveReal(HY,h,47,GetSpellTargetX()*1.)
	call SaveReal(HY,h,48,GetSpellTargetY()*1.)
	call SaveReal(HY,h,685,GWG*1.)
	call SaveInteger(HY,h,0,Phoenix_TempInt)
	set t=null
endfunction

function WBG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=LoadInteger(HY,h,34)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local unit WCG=LoadUnitHandle(HY,h,393)
	local unit W3G=LoadUnitHandle(HY,h,394)
	local unit W6G=LoadUnitHandle(HY,h,395)
	local unit WLG=LoadUnitHandle(HY,h,396)
	local integer Level=LoadInteger(HY,h,0)
	local real a=GetUnitFacing(Source)
	local real x
	local real y
	local group g
	local group g2
	local real rate=-1*360*.02/ 4
	local real a2
	local real offset
	local real GWG=LoadReal(HY,h,685)
	local real EMF
	local unit Caster=LoadUnitHandle(HY,h,19)
	set Phoenix_TempInt=Level
	if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if GetSpellAbilityId()=='A1Z2' then//A1Z2 -> Target Fire Spirits
			if IsDead(WCG)==false then
				call WAG(Source,WCG,GetSpellTargetUnit(),GWG,Caster)
				call RemoveSavedHandle(HY,h,393)
			elseif IsDead(W3G)==false then
				call WAG(Source,W3G,GetSpellTargetUnit(),GWG,Caster)
				call RemoveSavedHandle(HY,h,394)
			elseif IsDead(W6G)==false then
				call WAG(Source,W6G,GetSpellTargetUnit(),GWG,Caster)
				call RemoveSavedHandle(HY,h,395)
			elseif IsDead(WLG)==false then
				call WAG(Source,WLG,GetSpellTargetUnit(),GWG,Caster)
				call RemoveSavedHandle(HY,h,396)
				call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1Z2',false)//A1Z2 -> Target Fire Spirits
				if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1YX' then//A1YX -> Fire Spirits
					call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1YX',true)//A1YX -> Fire Spirits
				endif
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
			endif
		elseif GetSpellAbilityId()=='A1RK' or GetSpellAbilityId()=='A43H' then//A1RK -> Supernova, A43H -> Supernova
			if WCG!=null and IsDead(WCG)==false then
				call WAG(Source,WCG,Source,GWG,Caster)
			endif
			if W3G!=null and IsDead(W3G)==false then
				call WAG(Source,W3G,Source,GWG,Caster)
			endif
			if W6G!=null and IsDead(W6G)==false then
				call WAG(Source,W6G,Source,GWG,Caster)
			endif
			if WLG!=null and IsDead(WLG)==false then
				call WAG(Source,WLG,Source,GWG,Caster)
			endif
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1Z2',false)//A1Z2 -> Target Fire Spirits
			if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1YX' then//A1YX -> Fire Spirits
				call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1YX',true)//A1YX -> Fire Spirits
			endif
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	else
		set Count=Count+1
		call SaveInteger(HY,h,34,Count)
		if WCG!=null and IsDead(WCG)==false then
			set offset=360*4/ 4.
			set a2=offset+rate*Count
			set x=SafeX50(SourceX+200*Cos(a2*bj_DEGTORAD))
			set y=SafeY50(SourceY+200*Sin(a2*bj_DEGTORAD))
			call SetUnitFacing(WCG,a2-90)
			call SetUnitX(WCG,x)
			call SetUnitY(WCG,y)
		endif
		if W3G!=null and IsDead(W3G)==false then
			set offset=360*3/ 4.
			set a2=offset+rate*Count
			set x=SafeX50(SourceX+200*Cos(a2*bj_DEGTORAD))
			set y=SafeY50(SourceY+200*Sin(a2*bj_DEGTORAD))
			call SetUnitFacing(W3G,a2-90)
			call SetUnitX(W3G,x)
			call SetUnitY(W3G,y)
		endif
		if W6G!=null and IsDead(W6G)==false then
			set offset=360*2/ 4.
			set a2=offset+rate*Count
			set x=SafeX50(SourceX+200*Cos(a2*bj_DEGTORAD))
			set y=SafeY50(SourceY+200*Sin(a2*bj_DEGTORAD))
			call SetUnitFacing(W6G,a2-90)
			call SetUnitX(W6G,x)
			call SetUnitY(W6G,y)
		endif
		if WLG!=null and IsDead(WLG)==false then
			set offset=360*1/ 4.
			set a2=offset+rate*Count
			set x=SafeX50(SourceX+200*Cos(a2*bj_DEGTORAD))
			set y=SafeY50(SourceY+200*Sin(a2*bj_DEGTORAD))
			call SetUnitFacing(WLG,a2-90)
			call SetUnitX(WLG,x)
			call SetUnitY(WLG,y)
		endif
		if Count>800 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
			if WCG!=null and IsDead(WCG)==false then
				call WAG(Source,WCG,Source,GWG,Caster)
			endif
			if W3G!=null and IsDead(W3G)==false then
				call WAG(Source,W3G,Source,GWG,Caster)
			endif
			if W6G!=null and IsDead(W6G)==false then
				call WAG(Source,W6G,Source,GWG,Caster)
			endif
			if WLG!=null and IsDead(WLG)==false then
				call WAG(Source,WLG,Source,GWG,Caster)
			endif
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1Z2',false)//A1Z2 -> Target Fire Spirits
			if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1YX' then//A1YX -> Fire Spirits
				call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1YX',true)//A1YX -> Fire Spirits
			endif
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		else
			call SaveReal(HY,h,685,RMinBJ(.25+.75*(I2R(Count)/ 500.),1))
			if Count==625 then
				call BY8(XF,GetOwningPlayer(Source))
			endif
			if Count>600 then
				if ModuloInteger(Count,10)==0 or ModuloInteger(Count,10)==1 or ModuloInteger(Count,10)==2 or ModuloInteger(Count,10)==3 or ModuloInteger(Count,10)==4 then
					call SetUnitVertexColor(WCG,255,0,0,255)
					call SetUnitVertexColor(W3G,255,0,0,255)
					call SetUnitVertexColor(W6G,255,0,0,255)
					call SetUnitVertexColor(WLG,255,0,0,255)
				else
					call SetUnitVertexColor(WCG,255,255,255,255)
					call SetUnitVertexColor(W3G,255,255,255,255)
					call SetUnitVertexColor(W6G,255,255,255,255)
					call SetUnitVertexColor(WLG,255,255,255,255)
				endif
			endif
		endif
	endif
	set t=null
	set Source=null
	set WCG=null
	set W3G=null
	set W6G=null
	set WLG=null
	set g=null
	set g2=null
	set Caster=null
	return false
endfunction

function Phoenix_FireSpirits takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real x
	local real y
	local unit WCG
	local unit W3G
	local unit W6G
	local unit WLG
	local real a=GetUnitFacing(Source)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',SourceX,SourceY,0)//e00E -> Spellcaster
	call SetWidgetLife(Source,GetWidgetLife(Source)-GetWidgetLife(Source)*.15)
	call UnitAddAbility2(Source,'A1Z2')//A1Z2 -> Target Fire Spirits
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1Z2',true)//A1Z2 -> Target Fire Spirits
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1YX',false)//A1YX -> Fire Spirits
	set x=GetUnitX(Source)+200*Cos(bj_DEGTORAD*360*4/ 4.*-1.)
	set y=GetUnitY(Source)+200*Sin(bj_DEGTORAD*360*4/ 4.*-1.)
	set WCG=CreateUnit(GetOwningPlayer(Source),'h0CU',x,y,360*4/ 4.*-1.)//h0CU -> Fire Spirit
	set x=GetUnitX(Source)+200*Cos(bj_DEGTORAD*360*3/ 4.*-1.)
	set y=GetUnitY(Source)+200*Sin(bj_DEGTORAD*360*3/ 4.*-1.)
	set W3G=CreateUnit(GetOwningPlayer(Source),'h0CU',x,y,360*3/ 4.*-1.)//h0CU -> Fire Spirit
	set x=GetUnitX(Source)+200*Cos(bj_DEGTORAD*360*2/ 4.*-1.)
	set y=GetUnitY(Source)+200*Sin(bj_DEGTORAD*360*2/ 4.*-1.)
	set W6G=CreateUnit(GetOwningPlayer(Source),'h0CU',x,y,360*2/ 4.*-1.)//h0CU -> Fire Spirit
	set x=GetUnitX(Source)+200*Cos(bj_DEGTORAD*360*1/ 4.*-1.)
	set y=GetUnitY(Source)+200*Sin(bj_DEGTORAD*360*1/ 4.*-1.)
	set WLG=CreateUnit(GetOwningPlayer(Source),'h0CU',x,y,360*1/ 4.*-1.)//h0CU -> Fire Spirit
	call SetUnitScale(WCG,2.25,2.25,2.25)
	call SetUnitScale(W3G,2.25,2.25,2.25)
	call SetUnitScale(W6G,2.25,2.25,2.25)
	call SetUnitScale(WLG,2.25,2.25,2.25)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function WBG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,393,WCG)
	call SaveUnitHandle(HY,h,394,W3G)
	call SaveUnitHandle(HY,h,395,W6G)
	call SaveUnitHandle(HY,h,396,WLG)
	call SaveUnitHandle(HY,h,19,Caster)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	set t=null
	set Source=null
	set WCG=null
	set W3G=null
	set W6G=null
	set WLG=null
	set Caster=null
endfunction

function W5G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Count=(LoadInteger(HY,(GetHandleId(Target)),627))
	local real W2G=(LoadReal(HY,(GetHandleId(Target)),628))
	local integer Level=GetUnitAbilityLevel(Source,'A1S4')//A1S4 -> Shadow Poison
	local real Damage=(5+Level*15)*Pow(2,IMinBJ(Count,5)-1)
	if Count==0 then
		set Damage=0
	else
		set Damage=Damage+IMaxBJ(Count-5,0)*50
	endif
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SaveInteger(HY,(GetHandleId(Target)),627,0)
		call SaveReal(HY,(GetHandleId(Target)),628,(0*1.))
	elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if GetSpellAbilityId()=='A1S9' then//A1S9 -> Release Poison
			call DestroyEffect((LoadEffectHandle(HY,h,32)))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call SaveInteger(HY,(GetHandleId(Target)),627,0)
			call SaveReal(HY,(GetHandleId(Target)),628,(0*1.))
			if((LoadInteger(HY,(GetHandleId((Target))),(4293)))==1)then
				call SetUnitInvulnerable(Target,false)
			endif
			call DamageTarget(Source,Target,1,Damage)
			if((LoadInteger(HY,(GetHandleId((Target))),(4293)))==1)then
				call SetUnitInvulnerable(Target,true)
			endif
			call TextTagOnUnit(I2S(R2I(Damage))+"!",2,Target,.025,100,0,200,216)
		endif
	elseif(TimerGetElapsed(GlobalTimer))>W2G then
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SaveInteger(HY,(GetHandleId(Target)),627,0)
		call SaveReal(HY,(GetHandleId(Target)),628,(0*1.))
		if((LoadInteger(HY,(GetHandleId((Target))),(4293)))==1)then
			call SetUnitInvulnerable(Target,false)
		endif
		call DamageTarget(Source,Target,1,Damage)
		if((LoadInteger(HY,(GetHandleId((Target))),(4293)))==1)then
			call SetUnitInvulnerable(Target,true)
		endif
		call TextTagOnUnit(I2S(R2I(Damage))+"!",2,Target,.025,100,0,200,216)
	else
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function X4G takes unit Source,unit Target returns nothing
	local trigger t
	local integer h
	local integer Level=GetUnitAbilityLevel(Source,'A1S4')//A1S4 -> Shadow Poison
	local unit Projectile
	if(LoadInteger(HY,(GetHandleId(Target)),627))>0 then
		call SaveInteger(HY,(GetHandleId(Target)),627,((LoadInteger(HY,(GetHandleId(Target)),627))+1))
		call SaveReal(HY,(GetHandleId(Target)),628,(((TimerGetElapsed(GlobalTimer))+10)*1.))
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveUnitHandle(HY,h,17,(Target))
		call SaveInteger(HY,(GetHandleId(Target)),627,1)
		if IsUnitType(Target,UNIT_TYPE_HERO) then
			call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\shamanyouranus-ShadowyMissile.mdl",Target,"chest")))
		else
			call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\shamanyouranus-ShadowyMissile.mdl",Target,"origin")))
		endif
		call SaveReal(HY,(GetHandleId(Target)),628,(((TimerGetElapsed(GlobalTimer))+10)*1.))
		call TriggerRegisterTimerEvent(t,.05,true)
		call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerAddCondition(t,Condition(function W5G))
		set Projectile=null
	endif
	call TextTagOnUnit("+"+I2S((LoadInteger(HY,(GetHandleId(Target)),627))),3,Target,.025,100,0,200,216)
	call DamageTarget(Source,Target,1,50)
	set t=null
endfunction

function X7G takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),ND8)==false then
		call GroupAddUnit(ND8,GetEnumUnit())
		call X4G(N98,GetEnumUnit())
	endif
endfunction

function X8G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Projectile=(LoadUnitHandle(HY,h,45))
	local integer Count=GetTriggerEvalCount(t)
	local real a=(LoadReal(HY,h,137))
	local real x=SafeX50(GetUnitX(Projectile)+20*Cos(a))
	local real y=SafeY50(GetUnitY(Projectile)+20*Sin(a))
	local group g
	local group HND=(LoadGroupHandle(HY,h,133))
	local unit Target
	if Count==75 then
		call KillGroup(HND)
		call KillUnit(Projectile)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set tt_unit1=Source
		set N98=Source
		set ND8=HND
		call SetUnitX(Projectile,x)
		call SetUnitY(Projectile,y)
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,x,y,215,Condition(function NonImmuneEnemyFilterWithAncients))
		set Target=(LoadUnitHandle(HY,(GetHandleId(Source)),673))
		if Target!=null then
			if DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),x,y)<215 and IsUnitEnemy(Target,GetOwningPlayer(Source)) then
				call GroupAddUnit(g,Target)
			endif
		endif
		call ForGroup(g,function X7G)
		set Target=FirstOfGroup(g)
		call KillGroup(g)
	endif
	set t=null
	set Source=null
	set Projectile=null
	set g=null
	set Target=null
	set HND=null
	return false
endfunction

function SD_ShadowPoison takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),x,y)*bj_DEGTORAD
	local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0C2',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)//h0C2 -> Shadow Poison
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function X8G))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,45,(Projectile))
	call SaveReal(HY,h,137,((a)*1.))
	call SaveGroupHandle(HY,h,133,(GetAvailableGroup()))
	call UnitAddAbility2(Source,'A1S9')//A1S9 -> Release Poison
	set t=null
	set Source=null
	set Projectile=null
endfunction

function XEG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local unit XFG=GetSummonedUnit()
	if GetTriggerEventId()!=EVENT_PLAYER_UNIT_SUMMON then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetUnitAbilityLevel(XFG,'B0DA')>0 and GetOwningPlayer(GetSummoningUnit())==GetOwningPlayer(Source)then//B0DA -> Disruption Illusion
		if IsUnitAlly(Target,GetOwningPlayer(Source)) then
			call SelectUnitAddForPlayer(XFG,GetOwningPlayer(Source))
		else
			call IssueTargetOrderById(XFG,ORDER_attack,Target)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set XFG=null
	return false
endfunction

function XGG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	local integer lvl=LoadInteger(HY,h,0)
	call DestroyEffect(LoadEffectHandle(HY,h,32))
	call SaveInteger(HY,GetHandleId(Target),4293,2)
	call SetUnitInvulnerable(Target,false)
	call PauseUnit(Target,false)
	call ShowUnit(Target,true)
	call RemoveSavedHandle(HY,GetHandleId(Target),673)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	if GetTriggerEventId()!=EVENT_WIDGET_DEATH then
		call ClearSelectionForPlayer(GetOwningPlayer(Target))
		call SelectUnitAddForPlayer(Target,GetOwningPlayer(Target))
		call PlaySoundAtPos(AF,GetUnitX(Target),GetUnitY(Target))
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,3,false)
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
		call TriggerAddCondition(t,Condition(function XEG))
		call SaveUnitHandle(HY,h,2,Source)
		call SaveUnitHandle(HY,h,17,Target)
		call UnitAddAbility2(Caster,'A1S5')//A1S5 -> Disruption Illusion
		if IsUnitIllusion(Target) then
			call SaveUnitHandle(HY,GetHandleId(Caster),'0ILU',LoadUnitHandle(HY,GetHandleId(Target),'0ILU')) //Disruption source info (illu)
		else
			call SaveUnitHandle(HY,GetHandleId(Caster),'0ILU',Target) //Disruption source info (real)
		endif
		call SetUnitAbilityLevel(Caster,'A1S5',lvl)//A1S5 -> Disruption Illusion
		call IssueTargetOrderById(Caster,852274,Target)
		call IssueTargetOrderById(Caster,852274,Target)
	endif
	set t=null
	set Source=null
	set Caster=null
	set Target=null
	return false
endfunction

function XHG takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Target),'o019',GetUnitX(Target),GetUnitY(Target),0)//o019 -> Vision Ground 1800/800
	call UnitApplyTimedLife(Caster,'BTLF',2.6)
	if IsUnitAlly(Target,GetOwningPlayer(Source))==false then
		set Caster=CreateUnit(GetOwningPlayer(Source),'o019',GetUnitX(Target),GetUnitY(Target),0)//o019 -> Vision Ground 1800/800
		call UnitApplyTimedLife(Caster,'BTLF',2.6)
	endif
	call SetUnitInvulnerable(Target,true)
	call PauseUnit(Target,true)
	call ShowUnit(Target,false)
	call SaveEffectHandle(HY,h,32,AddSpecialEffect("war3mapImported\\WILLTHEALMIGHTY-Void5.mdx",GetUnitX(Target),GetUnitY(Target)))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call TriggerRegisterTimerEvent(t,2.5,false)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerAddCondition(t,Condition(function XGG))
	call SaveUnitHandle(HY,GetHandleId(Source),673,Target)
	call SaveInteger(HY,GetHandleId(Target),4293,1)
	set Source=null
	set Target=null
	set t=null
	set Caster=null
endfunction

function SD_Disruption takes nothing returns nothing
	if (IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) or IsBlocked(GetSpellTargetUnit())==false)then
		call XHG()
	endif
endfunction

function SD_Disruption_OnCast takes nothing returns nothing
	if GetSpellTargetUnit()!=GetTriggerUnit()and IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) and LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetSpellTargetUnit())),139) then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))//n038 -> This target has disablehelp on
	endif
endfunction

function XJG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Level=LoadInteger(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,0)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if LoadBoolean(HY,h,0)==false then
			call SaveBoolean(HY,h,0,true)
			call DamageTarget(GetEventDamageSource(),GetTriggerUnit(),3,GetEventDamage()*LoadReal(HY,h,0))
			call SaveBoolean(HY,h,0,false)
		endif
	else
		//call SaveReal(HY,GetHandleId(target),'AMPL',RMaxIF(LoadReal(HY,GetHandleId(target),'AMPL')-LoadReal(HY,h,0),0))
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	return false
endfunction

function SD_SoulCatcher takes nothing returns nothing
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local group g=GetAvailableGroup()
	local unit Source=GetTriggerUnit()
	local unit Target
	local trigger t
	local integer h
	local real r
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,475,Condition(function NonImmuneEnemyFilter))
	set Target=LoadUnitHandle(HY,GetHandleId(Source),673)
	if Target!=null then
		if DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),x,y)<475 and IsUnitEnemy(Target,GetOwningPlayer(Source)) then
			call GroupAddUnit(g,Target)
		endif
	endif
	set Target=GroupPickRandomUnit(g)
	call KillGroup(g)
	call DestroyEffect(AddSpecialEffect("war3mapImported\\Desecrate.mdx",x,y))
	if Target!=null then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
		call TriggerRegisterTimerEvent(t,12,false)
		set r=0.1+0.1*GetUnitAbilityLevel(Source,GetSpellAbilityId())
		//call SaveReal(HY,GetHandleId(Target),'AMPL',LoadReal(HY,GetHandleId(Target),'AMPL')+r)
		call TriggerAddCondition(t,Condition(function XJG))
		call SaveReal(HY,h,0,r)
		call SaveUnitHandle(HY,h,0,Target)
		call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
		call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\void.mdx",Target,"chest"))
	endif
	set g=null
	set Source=null
	set Target=null
	set t=null
endfunction

function XNG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Count=GetTriggerEvalCount(t)
	if Count==5 then
		if(LoadInteger(HY,GetHandleId(Target),4293)==1)then
			call SetUnitInvulnerable(Target,false)
		endif
		call DamageTarget(Source,Target,1,4*(25+25*LoadInteger(HY,h,0)))
		if(LoadInteger(HY,GetHandleId(Target),4293)==1)then
			call SetUnitInvulnerable(Target,true)
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function SD_DemonicPurge_Apply takes unit Source, unit Target returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit d=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function XNG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call UnitAddAbility(d,'A1SA')//A1SA -> Demonic Purge purge
	call SetUnitAbilityLevel(d,'A1SA',GetUnitAbilityLevel(Source,'A343')+GetUnitAbilityLevel(Source,'A34J'))//A1SA -> Demonic Purge purge, A343 -> Demonic Purge, A34J -> Demonic Purge
	call IssueTargetOrder(d,"purge",Target)
	call TriggerEvaluate(t)
	if GetUnitAbilityLevel(Source,'A34J')>0 then//A34J -> Demonic Purge
		call Break(Target,5.)
	endif
	set t=null
	set d=null
endfunction

function SD_DemonicPurge_Filter takes nothing returns boolean
	if (IsUnitEnemy(LoadUnitHandle(TempHash,'A1SA','cast'),GetOwningPlayer(GetFilterUnit()))and (GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and AliveNonBuildOrMarker(GetFilterUnit())))!=null then//Aloc -> Locust
		call SD_DemonicPurge_Apply(LoadUnitHandle(TempHash,'A1SA','cast'),GetFilterUnit())
	endif
	return false
endfunction

function SD_DemonicPurge takes nothing returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=GetTriggerUnit()
	call SaveUnitHandle(TempHash,'A1SA','cast',GetTriggerUnit())
	call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),265,Condition(function SD_DemonicPurge_Filter))
	call RemoveSavedHandle(TempHash,'A1SA','cast')
	call KillGroup(g)
endfunction

function DemonicPurgeRecharge takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local real time=LoadReal(HY,h,0)
	local integer charges=LoadInteger(HY,GetHandleId(u),'A34J')//A34J -> Demonic Purge
	if charges < 3 then
		set time=time-0.2
		if time<=0.then
			call SaveInteger(HY,GetHandleId(u),'A34J',charges+1)//A34J -> Demonic Purge
			call SaveReal(HY,h,0,40.0)
		else
			call SaveReal(HY,h,0,time*1.0)
		endif
	endif
	set u=null
	set t=null
	return false
endfunction

function DemonicPurgeInitRecharging takes unit u returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,0.2,true)
	call TriggerAddCondition(t,Condition(function DemonicPurgeRecharge))
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call SaveReal(HY,GetHandleId(t),0,40.)
	call SaveInteger(HY,GetHandleId(u),'A34J',3)//A34J -> Demonic Purge
	call SaveTriggerHandle(HY,GetHandleId(u),'A34J',t)//A34J -> Demonic Purge
	call DisplayTimedTextToPlayer(GetOwningPlayer(u),0,0,10,"|c00FF0000Hint|r: You can toggle charges counter using chat command |c00bd2222-charges|r")
	set t=null
endfunction

function SD_DemonicPurgeAghCast takes nothing returns nothing
	local unit u=GetTriggerUnit()
	if HaveSavedHandle(HY,GetHandleId(u),'A34J')==false then//A34J -> Demonic Purge
		call DemonicPurgeInitRecharging(u)
	endif
	if LoadInteger(HY,GetHandleId(u),'A34J') < 1 then//A34J -> Demonic Purge
		call Error(GetOwningPlayer(u),"Demonic Purge has no charges left.")
		call InterruptUnit(u)
	endif
	set u=null
endfunction

function SD_DemonicPurgeAgh takes nothing returns nothing
	call SD_DemonicPurge()
	call SaveInteger(HY,GetHandleId(GetTriggerUnit()),'A34J',LoadInteger(HY,GetHandleId(GetTriggerUnit()),'A34J')-1)//A34J -> Demonic Purge, A34J -> Demonic Purge
endfunction

function SD_DemonicPurgeAgh_Learn takes nothing returns nothing
	local integer h=GetHandleId(GetTriggerUnit())
	if HaveSavedHandle(HY,h,'A34J')==false then//A34J -> Demonic Purge
		call DemonicPurgeInitRecharging(GetTriggerUnit())
	endif
endfunction

function SD_DemonicPurgeAgh_Pickup takes nothing returns nothing
	local integer h=GetHandleId(tt_unit1)
	if HaveSavedHandle(HY,h,'A34J')==false then//A34J -> Demonic Purge
		call DemonicPurgeInitRecharging(tt_unit1)
	endif
endfunction

function XQG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=GetTriggerEvalCount(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	call UnitRemoveAbility(Source,'A1SP')//A1SP -> Rocket Barrage Spray
	set t=null
	set Source=null
	return false
endfunction

function Gyro_RocketBarrageOld takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call UnitAddAbility2(Source,'A1SP')//A1SP -> Rocket Barrage Spray
	call UnitMakeAbilityPermanent(Source,true,'A1SP')//A1SP -> Rocket Barrage Spray
	call SetUnitAbilityLevel(Source,'A1SP',GetUnitAbilityLevel(Source,'A1SO'))//A1SP -> Rocket Barrage Spray, A1SO -> Rocket Barrage
	call TriggerRegisterTimerEvent(t,3,false)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerAddCondition(t,Condition(function XQG))
	call SaveUnitHandle(HY,h,2,Source)
	set t=null
	set Source=null
endfunction

function RocketBarrageChecker takes nothing returns nothing
	if GetUnitAbilityLevel(GetTriggerUnit(),'B1SP')>0 then
		call UnitRemoveAbility(GetTriggerUnit(),'B1SP')
	endif
endfunction

function Func3927 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)>3/0.05 then
		call UnitRemoveAbility(LoadUnitHandle(HY,h,2),'A1SP')//A1SP -> Rocket Barrage Spray
		call KillUnit(LoadUnitHandle(HY,h,19))
		call CleanTrigger(t)
		call FlushChildHashtable(HY,h)
	else
		call SetUnitX(LoadUnitHandle(HY,h,19),GetUnitX(LoadUnitHandle(HY,h,2)))
		call SetUnitY(LoadUnitHandle(HY,h,19),GetUnitY(LoadUnitHandle(HY,h,2)))
		call SetUnitFlyHeight(LoadUnitHandle(HY,h,19),GetUnitFlyHeight(LoadUnitHandle(HY,h,2)),0)
	endif
	set t=null
	return false
endfunction

function Gyro_RocketBarrage takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit u=GetTriggerUnit()
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
	local integer lvl=GetUnitAbilityLevel(u,'A1SO')
	if GetUnitTypeId(u)=='e00E' then
		set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
	endif
	call DummyDamageTracking(10)
	call UnitAddAbility2(d,'A1SP')//A1SP -> Rocket Barrage Spray
	call SetUnitAbilityLevel(d,'A1SP',lvl)//A1SP -> Rocket Barrage Spray, A1SO -> Rocket Barrage
	call TriggerRegisterTimerEvent(t,0.05,true)
	call TriggerRegisterDeathEvent(t,u)
	call TriggerAddCondition(t,Condition(function Func3927))
	call SaveUnitHandle(HY,(h),2,(u))
	call SaveUnitHandle(HY,(h),19,d)
	set t=null
	set d=null
	set u=null
endfunction

function XTG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Count=GetTriggerEvalCount(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local unit Projectile=LoadUnitHandle(HY,h,45)
	local real x
	local real y
	local real d
	local real DV9
	local real LastX=GetUnitX(Projectile)
	local real LastY=GetUnitY(Projectile)
	local real a=AngleBetweenXY(LastX,LastY,GetUnitX(Target),GetUnitY(Target))*bj_DEGTORAD
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call UnitShareVision(Projectile,GetOwningPlayer(Target),false)
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if GetTriggerUnit()!=Projectile then
			call KillUnit(Projectile)
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		call UnitRemoveBuffs(Projectile,true,true)
	elseif Count<3/ .02 then
		call SetUnitFacing(Projectile,a*bj_RADTODEG)
	else
		if Count==4/ .02 then
			call UnitShareVision(Projectile,GetOwningPlayer(Target),true)
		endif
		call SetUnitFacing(Projectile,a*bj_RADTODEG)
		set x=LastX+(280+20*Count*.02)*.02*Cos(a)
		set y=LastY+(280+20*Count*.02)*.02*Sin(a)
		call SetUnitPosition(Projectile,x,y)
		call SaveReal(HY,h,23,x*1.)
		call SaveReal(HY,h,24,y*1.)
		if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<20 then
			set d=RMinBJ(DistanceBetweenXY(x,y,LoadReal(HY,h,6),LoadReal(HY,h,7)),1500)
			set x = LoadInteger(HY,h,0)
			set DV9=d/ 1500*(125*x)
			set DV9=RMaxBJ(DV9,50)
			call KillUnit(Projectile)
			call DestroyEffect(LoadEffectHandle(HY,h,32))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call DamageTarget(Source,Target,1,DV9)
			call StunTargetLoD(Target,2 + .2*x)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set Projectile=null
	return false
endfunction

function XUG takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local real a=AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))*bj_DEGTORAD
	local real x=SafeX50(GetUnitX(Source)+150*Cos(a))
	local real y=SafeY50(GetUnitY(Source)+150*Sin(a))
	local integer Level=GetUnitAbilityLevel(Source,'A1SQ')//A1SQ -> Homing Missile
	local unit Projectile
	local integer W78
	local string s="effects\\Snipe Target.mdx"
	if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Source))==false and IsObserver(GetLocalPlayer())==false then
		set s=""
	endif
	if Level==1 then
		set W78='h0CG'//h0CG -> Seeking Missle - 1
	elseif Level==2 then
		set W78='h0C1'//h0C1 -> Seeking Missle - 2
	elseif Level==3 then
		set W78='h0CF'//h0CF -> Seeking Missle - 3
	elseif Level==4 then
		set W78='h0CH'//h0CH -> Seeking Missle - 4
	endif
	set Projectile=CreateUnit(GetOwningPlayer(Source),W78,x,y,a*bj_RADTODEG)
	call UnitRemoveAbility(Projectile,'Amov')//Amov -> Move
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterDeathEvent(t,Projectile)
	call TriggerRegisterUnitEvent(t,Projectile,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function XTG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveInteger(HY,h,0,Level)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveUnitHandle(HY,h,45,Projectile)
	call SaveReal(HY,h,6,GetUnitX(Source)*1.)
	call SaveReal(HY,h,7,GetUnitY(Source)*1.)
	call SaveReal(HY,h,23,GetUnitX(Projectile)*1.)
	call SaveReal(HY,h,24,GetUnitY(Projectile)*1.)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget(s,Target,"overhead"))
	set t=null
	set Source=null
	set Target=null
	set Projectile=null
endfunction

function Gyro_HomingMissile takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call XUG()
	endif
endfunction

function XAG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local group g
	local integer Count=GetTriggerEvalCount(t)
	local fogmodifier fm=LoadFogModifierHandle(HY,h,42)
	local integer lvl=LoadInteger(HY,h,0)
	local unit u2
	if Count==1 then
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\Calldown_FlyUp.mdx",Source,"chest"))
	elseif Count==2 then
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\Calldown_FlyUp.mdx",Source,"chest"))
	elseif Count==3 then
		call DestroyEffect(AddSpecialEffect("war3mapImported\\Calldown_FlyDown.mdx",x,y))
	elseif Count==4 then
		set g=GetAvailableGroup()
		set tt_unit1=Source
		call GroupEnumUnitsInRange(g,x,y,625,Condition(function DefaultEnemyFilterWithAncients))
		
		loop
			set u2=FirstOfGroup(g)
			exitwhen u2==null
			call DamageTarget(Source,u2,1,lvl*50+200)
			call UnitAddAbilityTimedExF(u2,'A1T3',1,2,'B0DG')//A1T3 -> CallDown MS 2, B0DG -> Call Down
			call GroupRemoveUnit(g,u2)
		endloop
		
		call KillGroup(g)
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherFireMissile\\DemolisherFireMissile.mdl",x,y))
	elseif Count==5 then
		call DestroyEffect(AddSpecialEffect("war3mapImported\\Calldown_FlyDown.mdx",x,y))
	elseif Count==6 then
		set g=GetAvailableGroup()
		set tt_unit1=Source
		call GroupEnumUnitsInRange(g,x,y,625,Condition(function DefaultEnemyFilterWithAncients))
		
		loop
			set u2=FirstOfGroup(g)
			exitwhen u2==null
			if LoadBoolean(HY,h,0) then
				call DamageTarget(Source,u2,1,lvl*50+50+75)
			else
				call DamageTarget(Source,u2,1,lvl*50+50)
			endif
			call UnitAddAbilityTimedExF(u2,'A1ST',1,4,'B0DE')//A1ST -> CallDown MS 1, B0DE -> Call Down
			call GroupRemoveUnit(g,u2)
		endloop
		
		call KillGroup(g)
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherFireMissile\\DemolisherFireMissile.mdl",x,y))
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FogModifierStop(fm)
		call DestroyFogModifier(fm)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set g=null
	set fm=null
	return false
endfunction

function Gyro_Calldown takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local string s=""
	local fogmodifier fm=CreateFogModifierRadius(GetOwningPlayer(Source),FOG_OF_WAR_VISIBLE,x,y,450,true,true)
	call FogModifierStart(fm)
	if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Source)) or IsObserver(GetLocalPlayer())then
		set s="war3mapImported\\CallDown_4.mdx"
	endif
	call TriggerRegisterTimerEvent(t,.1,false)
	call TriggerRegisterTimerEvent(t,.8,false)
	call TriggerRegisterTimerEvent(t,1.6,false)
	call TriggerRegisterTimerEvent(t,2,false)
	call TriggerRegisterTimerEvent(t,3.6,false)
	call TriggerRegisterTimerEvent(t,4,false)
	call TriggerAddCondition(t,Condition(function XAG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call SaveBoolean(HY,h,0,GetSpellAbilityId()=='A235')//A235 -> Call Down
	call SaveReal(HY,h,6,x*1.)
	call SaveReal(HY,h,7,y*1.)
	call SaveEffectHandle(HY,h,32,AddSpecialEffect(s,x,y))
	call SaveFogModifierHandle(HY,h,42,fm)
	set t=null
	set Source=null
	set fm=null
endfunction

function X3G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer JDF=LoadInteger(HY,h,375)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer Count
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==Source and(GetEventDamage()>20 or IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)) and IsRealDamage then
			set Count=LoadInteger(HY,JDF,34)
			if Count>0 then
				call SaveInteger(HY,JDF,34,Count+1)
			endif
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	else
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	return false
endfunction

function X6G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	if IsHexed(Source)==false then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveAbility(Source,'A237')
		call UnitAddAbility(Source,'A22B')//A22B -> Flak Cannon Out
		call UnitRemoveAbility(Source,'A22B')//A22B -> Flak Cannon Out
	endif
	set t=null
	set Source=null
	return false
endfunction

function XLG takes unit Source returns nothing
	local trigger t
	local integer h
	if IsHexed(Source)==false then
		call UnitRemoveAbility(Source,'A237')
		call UnitAddAbility(Source,'A22B')//A22B -> Flak Cannon Out
		call UnitRemoveAbility(Source,'A22B')//A22B -> Flak Cannon Out
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(Source))
		call TriggerRegisterTimerEvent(t,.1,true)
		call TriggerAddCondition(t,Condition(function X6G))
		set t=null
	endif
endfunction

function X1G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer Count=LoadInteger(HY,h,34)
	local integer Level=LoadInteger(HY,h,0)
	local integer JDF=h
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
		if IsUnitIllusion(GetAttacker()) and GetUnitAbilityLevel(GetAttacker(),'A1TW')>0 then//A1TW -> Flak Cannon
			call XLG(GetAttacker())
			call UnitRemoveAbility(GetAttacker(),'A1TW')//A1TW -> Flak Cannon
		endif
		if GetAttacker()==Source then
			set Count=Count+1
			if Count>3+Level then
				call UnitRemoveAbility(Source,'A1TW')//A1TW -> Flak Cannon
				call UnitRemoveAbility(Source,'B0DJ')//B0DJ -> Flak Cannon
				call XLG(Source)
				call FlushChildHashtable(HY,h)
				call CleanTrigger(t)
			else
				set t=CreateTrigger()
				set h=GetHandleId(t)
				call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
				call TriggerRegisterTimerEvent(t,2,false)
				call TriggerAddCondition(t,Condition(function X3G))
				call SaveUnitHandle(HY,h,2,Source)
				call SaveInteger(HY,h,375,JDF)
			endif
		endif
	else
		call UnitRemoveAbility(Source,'A1TW')//A1TW -> Flak Cannon
		call UnitRemoveAbility(Source,'B0DJ')//B0DJ -> Flak Cannon
		call XLG(Source)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	return false
endfunction

function Gyro_FlakCannon takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call UnitAddAbility(Source,'A1TW')//A1TW -> Flak Cannon
	call UnitMakeAbilityPermanent(Source,true,'A1TW')//A1TW -> Flak Cannon
	call TriggerRegisterTimerEvent(t,15,false)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerAddCondition(t,Condition(function X1G))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveInteger(HY,h,34,1)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call UnitRemoveAbility(Source,'A237')
	set t=null
	set Source=null
endfunction

function Y4G takes nothing returns boolean
	local unit Target=GetFilterUnit()
	local unit Source=NG8
	local real SourceX=NH8
	local real SourceY=NI8
	local real NHE=NJ8
	local real NIE=NK8
	local real x
	local real y
	local real a
	local real d
	if(IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and AliveNonBuildOrMarker(GetFilterUnit()))then
		set d=DistanceBetweenXY(SourceX,SourceY,GetUnitX(Target),GetUnitY(Target))
		set a=AngleBetweenXY(SourceX,SourceY,GetUnitX(Target),GetUnitY(Target))*bj_DEGTORAD
		if d>NM8 then
			set x=GetUnitX(Target)+11*Cos(a)
			set y=GetUnitY(Target)+11*Sin(a)
		else
			set x=GetUnitX(Target)-11*Cos(a)
			set y=GetUnitY(Target)-11*Sin(a)
		endif
		call SetUnitX(Target,x)
		call SetUnitY(Target,y)
	endif
	set Target=null
	set Source=null
	return false
endfunction

function Y7G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real SourceX=LoadReal(HY,h,6)
	local real SourceY=LoadReal(HY,h,7)
	local real x
	local real y
	local integer i=0
	local group g
	local integer lvl=LoadInteger(HY,h,0)
	if GetTriggerEvalCount(t)>(50*(2+.6*lvl))then
		loop
			exitwhen i>16
			set i=i+1
		endloop
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set g=GetAvailableGroup()
		set NH8=SourceX
		set NI8=SourceY
		set NG8=Source
		set tt_unit1=Source
		loop
			exitwhen i>16
			set x=SourceX+NM8*Cos(bj_DEGTORAD*360.*i/ 16.)
			set y=SourceY+NM8*Sin(bj_DEGTORAD*360.*i/ 16.)
			set NJ8=x
			set NK8=y
			call GroupEnumUnitsInRange(g,x,y,75,Condition(function Y4G))
			set i=i+1
		endloop
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Source=null
	return false
endfunction

function Y8G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real SourceX=LoadReal(HY,h,6)
	local real SourceY=LoadReal(HY,h,7)
	local real x
	local real y
	local integer i=0
	local integer lvl=LoadInteger(HY,h,0)
	call DestroyEffect(LoadEffectHandle(HY,h,32))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	loop
		exitwhen i>16
		set x=SourceX+NM8*Cos(bj_DEGTORAD*360.*i/ 16.)
		set y=SourceY+NM8*Sin(bj_DEGTORAD*360.*i/ 16.)
		set i=i+1
	endloop
	call SaveEffectHandle(HY,h,32,AddSpecialEffect("war3mapImported\\KineticField_FX_Stand.mdx",SourceX,SourceY))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,6,SourceX*1.)
	call SaveReal(HY,h,7,SourceY*1.)
	call SaveInteger(HY,h,0,lvl)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function Y7G))
	set t=null
	set Source=null
	return false
endfunction

function Disruptor_KineticField takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real SourceX=GetSpellTargetX()
	local real SourceY=GetSpellTargetY()
	call SaveEffectHandle(HY,h,32,AddSpecialEffect("war3mapImported\\KineticField_FX_Start.mdx",SourceX,SourceY))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,6,SourceX*1.)
	call SaveReal(HY,h,7,SourceY*1.)
	call TriggerRegisterTimerEvent(t,1.2,false)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,'A1SU'))//A1SU -> Kinetic Field
	call TriggerAddCondition(t,Condition(function Y8G))
	call TimedReveal(GetOwningPlayer(Source),5.5,SourceX,SourceY,325)
	set t=null
	set Source=null
endfunction

function YEG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local unit Projectile=(LoadUnitHandle(HY,h,45))
	local real TargetX=(LoadReal(HY,h,6))
	local real TargetY=(LoadReal(HY,h,7))
	local real x=GetUnitX(Projectile)
	local real y=GetUnitY(Projectile)
	local real a=AngleBetweenXY(x,y,TargetX,TargetY)
	local real d=DistanceBetweenXY(x,y,TargetX,TargetY)
	local real r=(LoadReal(HY,h,671))
	call SetUnitFacing(Projectile,a)
	set x=x+r*Cos(a*bj_DEGTORAD)
	set y=y+r*Sin(a*bj_DEGTORAD)
	call SetUnitX(Projectile,x)
	call SetUnitY(Projectile,y)
	if d<40 then
		call KillUnit(Projectile)
		call DestroyEffect((LoadEffectHandle(HY,h,175)))
		call DestroyEffect((LoadEffectHandle(HY,h,176)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call AddTimedKeyToUnit(Target,4411,1)
		call SetUnitPosition(Target,TargetX,TargetY)
		call PanCameraToTimedForPlayer(GetOwningPlayer(Target),TargetX,TargetY,0)
	elseif IsMagicImmune(Target)then
		call KillUnit(Projectile)
		call DestroyEffect((LoadEffectHandle(HY,h,175)))
		call DestroyEffect((LoadEffectHandle(HY,h,176)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	set Projectile=null
	return false
endfunction

function YFG takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local real x=(LoadReal(HY,(GetHandleId(Target)),7400))
	local real y=(LoadReal(HY,(GetHandleId(Target)),7500))
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0C6',GetUnitX(Target),GetUnitY(Target),0)//h0C6 -> Glimpse Projectile
	local real d=DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))
	local real r=.02*(RMaxBJ(d/ 1.8,600))
	call TriggerAddCondition(t,Condition(function YEG))
	call TriggerRegisterTimerEvent(t,.02,true)
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveUnitHandle(HY,h,45,(Projectile))
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	call SaveReal(HY,h,671,((r)*1.))
	call SaveEffectHandle(HY,h,175,(AddSpecialEffectTarget("effects\\Lightning_Ball_Tail_FX.mdx",Target,"overhead")))
	call SaveEffectHandle(HY,h,176,(AddSpecialEffect("effects\\Lightning_Ball_Tail_FX.mdx",x,y)))
	call TriggerEvaluate(t)
	set Source=null
	set Target=null
	set Projectile=null
	set t=null
endfunction

function Disruptor_Glimpse takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		if IsUnitIllusion(GetSpellTargetUnit())then
			call KillUnit(GetSpellTargetUnit())
		else
			call YFG()
		endif
	endif
endfunction

function YHG takes nothing returns nothing
	local unit Target=GetEnumUnit()
	local integer h=GetHandleId(Target)
	local integer i=1
	loop
		exitwhen i>14
		call SaveReal(HY,h,7400+i-1,LoadReal(HY,h,7400+i)*1.)
		call SaveReal(HY,h,7500+i-1,LoadReal(HY,h,7500+i)*1.)
		set i=i+1
	endloop
	call SaveReal(HY,h,7400+14,GetUnitX(Target)*1.)
	call SaveReal(HY,h,7500+14,GetUnitY(Target)*1.)
	set Target=null
endfunction

function YIG takes nothing returns boolean
	local group g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,0,0,99999,Condition(function DI9))
	call ForGroup(g,function YHG)
	call KillGroup(g)
	set g=null
	return false
endfunction

function Disruptor_Glimpse_Init takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.25,true)
	call TriggerAddCondition(t,Condition(function YIG))
	set t=null
endfunction

function Disruptor_ThunderStrike_Damage takes nothing returns nothing
	if NN8!=GetEnumUnit() then
		call DamageTarget(NO8,GetEnumUnit(),1,NP8*20+20)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",GetEnumUnit(),"chest"))
	endif
endfunction

function Disruptor_ThunderStrike_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local unit Caster=LoadUnitHandle(HY,h,19)
	local integer Level=LoadInteger(HY,h,5)
	local group g
	local integer Count=GetTriggerEvalCount(t)
	local unit d=null
	call SetUnitX(Caster,GetUnitX(Target))
	call SetUnitY(Caster,GetUnitY(Target))
	if Count==1 or Count==100 or Count==200 or Count==300 then
		set g=GetAvailableGroup()
		if IsDead(Target)then
			set d=CreateUnit(GetOwningPlayer(Target),'e00C',GetUnitX(Target),GetUnitY(Target),0)//e00C -> Self Caster
			call UnitApplyTimedLife(d,'BTLF',.2)
			call IssueTargetOrderById(Caster,852119,d)
			set d=null
		else
			call IssueTargetOrderById(Caster,852119,Target)
			call DamageTarget(Source,Target,1,Level*20+20)
		endif
		call Z48("war3mapImported\\ThunderStorm_Groundeffect.mdx",Target,"origin",.6)
		set tt_unit1=Source
		set NO8=Source
		set NN8=Target
		set NP8=Level
		call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),265,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function Disruptor_ThunderStrike_Damage)
		call KillGroup(g)
		set g=null
	endif
	if GetUnitAbilityLevel(Target,'A42Q')==0 or GetTriggerEvalCount(t)==300 then
		call UnitRemoveAbility(Target,'A42Q')
		call UnitRemoveAbility(Target,'B0HH')//B0HH -> Thunder Strike
		call KillUnit(Caster)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	set Target=null
	set Caster=null
	return false
endfunction

function Disruptor_ThunderStrike_Start takes unit Source,unit Target returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A1TV')//A1TV -> Thunder Strike
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e02P',GetUnitX(Target),GetUnitY(Target),0)//e02P -> Lightning Bolter 2
	call UnitAddAbility2(Caster,'A1U7')//A1U7 -> Thunder Surge
	call SetUnitAbilityLevel(Caster,'A1U7',Level)//A1U7 -> Thunder Surge
	call UnitAddAbility2(Caster,'Aloc')//Aloc -> Locust
	call UnitAddAbility2(Target,'A42Q')
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function Disruptor_ThunderStrike_Duration))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveUnitHandle(HY,h,19,Caster)
	call SaveInteger(HY,h,5,Level)
	set Caster=null
	set t=null
endfunction

function Disruptor_ThunderStrike_StartSup takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call Disruptor_ThunderStrike_Start(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function Disruptor_ThunderStrike_Wrapper takes nothing returns nothing
	local timer t
	local integer h
	if IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,0,false,function Disruptor_ThunderStrike_StartSup)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		set t=null
	endif
endfunction

function Disruptor_StaticStormClear takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,GetHandleId(t))
		call CleanTrigger(t)
	else
		if GetUnitAbilityLevel(u,'B0DL')==0 then//B0DL -> Static Storm
			call FlushChildHashtable(HY,GetHandleId(t))
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set u=null
endfunction

function Disruptor_StaticStormSilenceItems takes unit u returns nothing
//	local trigger t=CreateTrigger()
//	local integer h=GetHandleId(t)
//	//call UnitAddAbility2(u,'QINV')
//	//call SetPlayerAbilityAvailable(GetOwningPlayer(u),'QINV',false)
//	call TriggerRegisterTimerEvent(t,.25,true)
//	call TriggerRegisterDeathEvent(t,u)
//	call TriggerAddCondition(t,Condition(function Disruptor_StaticStormClear))
//	call SaveUnitHandle(HY,h,0,u)
	call STFU(u,'B0DL',8)//B0DL -> Static Storm
//	set t=null
endfunction

function YOG takes nothing returns nothing
	call DamageTarget(NR8,GetEnumUnit(),1,NQ8)
	call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\Purge_NoBirth.mdx",GetEnumUnit(),"origin"))
	if NS8 and GetUnitAbilityLevel(GetEnumUnit(),'QINV')==0 and GetUnitAbilityLevel(GetEnumUnit(),'AInv')>0 and IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then//AInv -> Inventory
		call Disruptor_StaticStormSilenceItems(GetEnumUnit())
	endif
endfunction

function YPG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer Level=(LoadInteger(HY,h,5))
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Projectile=(LoadUnitHandle(HY,h,45))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	local group g
	local integer Count=GetTriggerEvalCount(t)
	local boolean isAgh=LoadBoolean(HY,h,0)
	local integer limit=20
	if isAgh then
		set limit=28
	endif
	if Count>limit then
		call StopSound(BF,false,true)
		call KillUnit(Projectile)
		call ShowUnit(Projectile,false)
		call KillUnit(Caster)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set g=GetAvailableGroup()
		set tt_unit1=Source
		set NR8=Source
		set NQ8=.25*(150+50*Level)*(Count/ 20.)
		set NS8=isAgh
		call GroupEnumUnitsInRange(g,GetUnitX(Projectile),GetUnitY(Projectile),475,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function YOG)
		
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Source=null
	set Projectile=null
	set Caster=null
	return false
endfunction

function Disruptor_StaticField takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real TargetX=GetSpellTargetX()
	local real TargetY=GetSpellTargetY()
	local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0CK',TargetX,TargetY,0)//h0CK -> Spark
	local integer Level=GetUnitAbilityLevel(Source,'A1U6')+GetUnitAbilityLevel(Source,'A30N')//A1U6 -> Static Storm, A30N -> Static Storm
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',TargetX,TargetY,0)//e00E -> Spellcaster
	call SetSoundVolume(BF,200)
	call StartSound(BF)
	call SetSoundPosition(BF,TargetX,TargetY,100)
	if IsScourge(GetOwningPlayer(Source))then
		call UnitAddAbility2(Caster,'A1U5')//A1U5 -> Staticstorm effect - scourge
		if GetSpellAbilityId()=='A30N' then//A30N -> Static Storm
			call SetUnitAbilityLevel(Caster,'A1U5',2)//A1U5 -> Staticstorm effect - scourge
		endif
	else
		call UnitAddAbility2(Caster,'A1U4')//A1U4 -> Staticstorm effect - sent
		if GetSpellAbilityId()=='A30N' then//A30N -> Static Storm
			call SetUnitAbilityLevel(Caster,'A1U4',2)//A1U4 -> Staticstorm effect - sent
		endif
	endif
	call IssuePointOrderById(Caster,852473,TargetX,TargetY)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,45,(Projectile))
	call SaveUnitHandle(HY,h,19,(Caster))
	call SaveInteger(HY,h,5,(Level))
	call SaveBoolean(HY,h,0,GetSpellAbilityId()=='A30N')//A30N -> Static Storm
	call TriggerRegisterTimerEvent(t,.25,true)
	call TriggerAddCondition(t,Condition(function YPG))
	set t=null
	set Source=null
	set Caster=null
	set Projectile=null
endfunction

function YSG takes nothing returns nothing
	local integer YTG=NY8
	local unit Target=GetEnumUnit()
	local integer YUG=662-1+YTG
	local real YVG=(LoadReal(HY,(GetHandleId(Target)),(YUG)))
	local real UK8=(TimerGetElapsed(GlobalTimer))
	if YVG<UK8 then
		call SaveReal(HY,(GetHandleId(Target)),(YUG),((UK8+2)*1.))
		if IsUnitType(GetEnumUnit(),UNIT_TYPE_STRUCTURE)==false then
			call DamageTarget(NT8,Target,1,2+6*NX8)
		endif
	endif
	set Target=null
endfunction

function YWG takes nothing returns nothing
	if IsUnitType(GetEnumUnit(),UNIT_TYPE_STRUCTURE)==false then
		call DamageTarget(NT8,GetEnumUnit(),1,NV8)
		if IsMagicImmune(GetEnumUnit())==false then
			call UnitAddAbilityTimedEx(GetEnumUnit(),'A437',3,1,'B0DI')//B0DI -> Spirits
			call DetectMagicDispell(GetEnumUnit(),'A437','B0DI')//B0DI -> Spirits
		endif
	endif
endfunction

function YXG takes unit Source,unit YYG returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	set NV8=25*NX8
	set NT8=Source
	call GroupEnumUnitsInRange(g,GetUnitX(YYG),GetUnitY(YYG),325,Condition(function L38))
	call ForGroup(g,function YWG)
	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FreezingBreath\\FreezingBreathMissile.mdl",GetUnitX(YYG),GetUnitY(YYG)))
	call KillUnit(YYG)
	call KillGroup(g)
	call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(Source),'o00Q',GetUnitX(YYG),GetUnitY(YYG),0),'BTLF',2)//o00Q -> Vision Dummy 400/400
	set g=null
endfunction

function YZG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit U01=(LoadUnitHandle(HY,h,393))
	local unit U02=(LoadUnitHandle(HY,h,394))
	local unit U03=(LoadUnitHandle(HY,h,395))
	local unit U04=(LoadUnitHandle(HY,h,396))
	local unit U05=(LoadUnitHandle(HY,h,397))
	local real x
	local real y
	local real a
	local real d=(LoadReal(HY,h,138))
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real rate
	local integer Count=GetTriggerEvalCount(t)
	local real offset
	local group g
	local integer StillAlive=0
	local real time=2.25
	local real CurrentAngle
	local integer lvl=LoadInteger(HY,h,5)
	if IsDead(U01)==false then
		set StillAlive=StillAlive+1
	endif
	if IsDead(U02)==false then
		set StillAlive=StillAlive+1
	endif
	if IsDead(U03)==false then
		set StillAlive=StillAlive+1
	endif
	if IsDead(U04)==false then
		set StillAlive=StillAlive+1
	endif
	if IsDead(U05)==false then
		set StillAlive=StillAlive+1
	endif
	if StillAlive==5 then
		set time=2.25
	elseif StillAlive==4 then
		set time=2.1
	elseif StillAlive==3 then
		set time=1.95
	elseif StillAlive==2 then
		set time=1.8
	elseif StillAlive==1 then
		set time=1.65
	endif
	set rate=-1*360*.02/ time
	set CurrentAngle=(LoadReal(HY,h,137))+rate
	call SaveReal(HY,h,137,((CurrentAngle)*1.))
	set NX8=lvl
	set NT8=Source
	if Count==50 then
		call ShowUnit(U02,true)
		call SaveBoolean(HY,h,512,(true))
		call UnitAddAbility2(U02,'Aloc')//Aloc -> Locust
	endif
	if Count==100 then
		call ShowUnit(U03,true)
		call SaveBoolean(HY,h,513,(true))
		call UnitAddAbility2(U03,'Aloc')//Aloc -> Locust
	endif
	if Count==150 then
		call ShowUnit(U04,true)
		call SaveBoolean(HY,h,514,(true))
		call UnitAddAbility2(U04,'Aloc')//Aloc -> Locust
	endif
	if Count==200 then
		call ShowUnit(U05,true)
		call SaveBoolean(HY,h,515,(true))
		call UnitAddAbility2(U05,'Aloc')//Aloc -> Locust
	endif
	if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if GetSpellAbilityId()=='A24A' then//A24A -> Oscillate In
			if(LoadBoolean(HY,h,655)) then
				call SaveBoolean(HY,h,655,(false))
				call SaveBoolean(HY,h,656,(false))
			else
				call SaveBoolean(HY,h,655,(true))
				call SaveBoolean(HY,h,656,(false))
			endif
		elseif GetSpellAbilityId()=='A24B' then//A24B -> Oscillate Out
			if(LoadBoolean(HY,h,656)) then
				call SaveBoolean(HY,h,655,(false))
				call SaveBoolean(HY,h,656,(false))
			else
				call SaveBoolean(HY,h,655,(false))
				call SaveBoolean(HY,h,656,(true))
			endif
		endif
	endif
	if(LoadBoolean(HY,h,655))then
		set d=RMaxBJ(d-5,100)
		call SaveReal(HY,h,138,((d)*1.))
	elseif(LoadBoolean(HY,h,656))then
		set d=RMinBJ(d+5,875)
		call SaveReal(HY,h,138,((d)*1.))
	endif
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or Count==950 or(IsDead(U01)and IsDead(U02)and IsDead(U03)and IsDead(U04)and IsDead(U05))or(Count>1 and GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A1T8')then//A1T8 -> Spirits
		if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT then
			call UnitRemoveAbility(Source,'A24A')//A24A -> Oscillate In
			call UnitRemoveAbility(Source,'A24B')//A24B -> Oscillate Out
		endif
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if IsDead(U01)==false then
			call YXG(Source,U01)
		endif
		if IsDead(U02)==false then
			call YXG(Source,U02)
		endif
		if IsDead(U03)==false then
			call YXG(Source,U03)
		endif
		if IsDead(U04)==false then
			call YXG(Source,U04)
		endif
		if IsDead(U05)==false then
			call YXG(Source,U05)
		endif
	else
		set g=GetAvailableGroup()
		if IsDead(U01)==false and(LoadBoolean(HY,h,511))then
			set offset=360*5/ 5.
			set a=offset+CurrentAngle
			set x=SafeX50(SourceX+d*Cos(a*bj_DEGTORAD))
			set y=SafeY50(SourceY+d*Sin(a*bj_DEGTORAD))
			call SetUnitX(U01,x)
			call SetUnitY(U01,y)
			set tt_unit1=Source
			call GroupEnumUnitsInRange(g,x,y,95,Condition(function DF9))
			if FirstOfGroup(g)!=null then
				call YXG(Source,U01)
			endif
			call GroupClear(g)
			set NW8=U01
			set NY8=1
			set NT8=Source
			call GroupEnumUnitsInRange(g,x,y,175,Condition(function LC8))
			call ForGroup(g,function YSG)
			call GroupClear(g)
		endif
		if IsDead(U02)==false and(LoadBoolean(HY,h,512))then
			set offset=360*4/ 5.
			set a=offset+CurrentAngle
			set x=SafeX50(SourceX+d*Cos(a*bj_DEGTORAD))
			set y=SafeY50(SourceY+d*Sin(a*bj_DEGTORAD))
			call SetUnitX(U02,x)
			call SetUnitY(U02,y)
			set tt_unit1=Source
			call GroupEnumUnitsInRange(g,x,y,95,Condition(function DF9))
			if FirstOfGroup(g)!=null then
				call YXG(Source,U02)
			endif
			call GroupClear(g)
			set NW8=U02
			set NY8=2
			set NT8=Source
			call GroupEnumUnitsInRange(g,x,y,175,Condition(function LC8))
			call ForGroup(g,function YSG)
			call GroupClear(g)
		endif
		if IsDead(U03)==false and(LoadBoolean(HY,h,513))then
			set offset=360*3/ 5.
			set a=offset+CurrentAngle
			set x=SafeX50(SourceX+d*Cos(a*bj_DEGTORAD))
			set y=SafeY50(SourceY+d*Sin(a*bj_DEGTORAD))
			call SetUnitX(U03,x)
			call SetUnitY(U03,y)
			set tt_unit1=Source
			call GroupEnumUnitsInRange(g,x,y,95,Condition(function DF9))
			if FirstOfGroup(g)!=null then
				call YXG(Source,U03)
			endif
			call GroupClear(g)
			set NW8=U03
			set NY8=3
			set NT8=Source
			call GroupEnumUnitsInRange(g,x,y,175,Condition(function LC8))
			call ForGroup(g,function YSG)
			call GroupClear(g)
		endif
		if IsDead(U04)==false and(LoadBoolean(HY,h,514))then
			set offset=360*2/ 5.
			set a=offset+CurrentAngle
			set x=SafeX50(SourceX+d*Cos(a*bj_DEGTORAD))
			set y=SafeY50(SourceY+d*Sin(a*bj_DEGTORAD))
			call SetUnitX(U04,x)
			call SetUnitY(U04,y)
			set tt_unit1=Source
			call GroupEnumUnitsInRange(g,x,y,95,Condition(function DF9))
			if FirstOfGroup(g)!=null then
				call YXG(Source,U04)
			endif
			call GroupClear(g)
			set NW8=U04
			set NY8=4
			set NT8=Source
			call GroupEnumUnitsInRange(g,x,y,175,Condition(function LC8))
			call ForGroup(g,function YSG)
			call GroupClear(g)
		endif
		if IsDead(U05)==false and(LoadBoolean(HY,h,515))then
			set offset=360*1/ 5.
			set a=offset+CurrentAngle
			set x=SafeX50(SourceX+d*Cos(a*bj_DEGTORAD))
			set y=SafeY50(SourceY+d*Sin(a*bj_DEGTORAD))
			call SetUnitX(U05,x)
			call SetUnitY(U05,y)
			set tt_unit1=Source
			call GroupEnumUnitsInRange(g,x,y,95,Condition(function DF9))
			if FirstOfGroup(g)!=null then
				call YXG(Source,U05)
			endif
			call GroupClear(g)
			set NW8=U05
			set NY8=5
			set NT8=Source
			call GroupEnumUnitsInRange(g,x,y,175,Condition(function LC8))
			call ForGroup(g,function YSG)
			call GroupClear(g)
		endif
		call KillGroup(g)
	endif
	set t=null
	set Source=null
	set U01=null
	set U02=null
	set U03=null
	set U04=null
	set U05=null
	set g=null
	return false
endfunction

function Wisp_Spirits takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit U01
	local unit U02
	local unit U03
	local unit U04
	local unit U05
	local real x
	local real y
	set x=GetUnitX(Source)+250*Cos(bj_DEGTORAD*360*5/ 5.*-1.)
	set y=GetUnitY(Source)+250*Sin(bj_DEGTORAD*360*5/ 5.*-1.)
	set U01=CreateUnit(GetOwningPlayer(Source),'h0CJ',x,y,360*5/ 5.*-1.)//h0CJ -> Wisps
	call UnitAddAbility2(U01,'Aloc')//Aloc -> Locust
	set x=GetUnitX(Source)+250*Cos(bj_DEGTORAD*360*4/ 5.*-1.)
	set y=GetUnitY(Source)+250*Sin(bj_DEGTORAD*360*4/ 5.*-1.)
	set U02=CreateUnit(GetOwningPlayer(Source),'h0CJ',x,y,360*4/ 5.*-1.)//h0CJ -> Wisps
	call ShowUnit(U02,false)
	call SetUnitInvulnerable(U02,true)
	set x=GetUnitX(Source)+250*Cos(bj_DEGTORAD*360*3/ 5.*-1.)
	set y=GetUnitY(Source)+250*Sin(bj_DEGTORAD*360*3/ 5.*-1.)
	set U03=CreateUnit(GetOwningPlayer(Source),'h0CJ',x,y,360*3/ 5.*-1.)//h0CJ -> Wisps
	call ShowUnit(U03,false)
	call SetUnitInvulnerable(U02,true)
	set x=GetUnitX(Source)+250*Cos(bj_DEGTORAD*360*2/ 5.*-1.)
	set y=GetUnitY(Source)+250*Sin(bj_DEGTORAD*360*2/ 5.*-1.)
	set U04=CreateUnit(GetOwningPlayer(Source),'h0CJ',x,y,360*2/ 5.*-1.)//h0CJ -> Wisps
	call ShowUnit(U04,false)
	call SetUnitInvulnerable(U04,true)
	set x=GetUnitX(Source)+250*Cos(bj_DEGTORAD*360*1/ 5.*-1.)
	set y=GetUnitY(Source)+250*Sin(bj_DEGTORAD*360*1/ 5.*-1.)
	set U05=CreateUnit(GetOwningPlayer(Source),'h0CJ',x,y,360*1/ 5.*-1.)//h0CJ -> Wisps
	call ShowUnit(U05,false)
	call SetUnitInvulnerable(U05,true)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,393,(U01))
	call SaveUnitHandle(HY,h,394,(U02))
	call SaveUnitHandle(HY,h,395,(U03))
	call SaveUnitHandle(HY,h,396,(U04))
	call SaveUnitHandle(HY,h,397,(U05))
	call SaveBoolean(HY,h,511,(true))
	call SaveBoolean(HY,h,512,(false))
	call SaveBoolean(HY,h,513,(false))
	call SaveBoolean(HY,h,514,(false))
	call SaveBoolean(HY,h,515,(false))
	call SaveBoolean(HY,h,655,(false))
	call SaveBoolean(HY,h,656,(false))
	call SaveReal(HY,h,138,(150*1.))
	call SaveInteger(HY,h,5,GetUnitAbilityLevel(Source,'A1T8'))
	call UnitAddAbility2(Source,'A24B')//A24B -> Oscillate Out
	call UnitAddAbility2(Source,'A24A')//A24A -> Oscillate In
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function YZG))
	set Source=null
	set t=null
	set U01=null
	set U02=null
	set U03=null
	set U04=null
	set U05=null
endfunction

function YLG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Level=(LoadInteger(HY,h,5))
	if IsRealDamage then
		call HealUnitFor(Source,GetEventDamage()*.05*Level)
	endif
	set t=null
	set Source=null
	return false
endfunction

function Y1G takes unit u returns nothing
	local trigger t
	call UnitRemoveAbility(u,'A1VM')//A1TS -> Overcharge Container - 1
	if(LoadBoolean(HY,(GetHandleId(u)),708))then
		call SaveBoolean(HY,(GetHandleId(u)),708,(false))
		set t=(LoadTriggerHandle(HY,(GetHandleId(u)),709))
		call FlushChildHashtable(HY,(GetHandleId(t)))
		call CleanTrigger(t)
		call RemoveSavedHandle(HY,(GetHandleId(u)),709)
		set t=null
	endif
endfunction

function Y0G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call Y1G(Source)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function Y5G takes unit u,integer i returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,(u))
	call TriggerRegisterDeathEvent(t,u)
	call TriggerAddCondition(t,Condition(function Y0G))
	call UnitAddAbility3(u,'A1VM',i)
	if(LoadBoolean(HY,(GetHandleId(u)),708))==false then
		call SaveBoolean(HY,(GetHandleId(u)),708,(true))
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(t,Condition(function YLG))
		call SaveTriggerHandle(HY,(GetHandleId(u)),709,(t))
		call SaveUnitHandle(HY,(GetHandleId(t)),2,(u))
		call SaveInteger(HY,(GetHandleId(t)),5,(i))
	endif
	set t=null
endfunction

function Wisp_Overcharge_Act takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Count=(LoadInteger(HY,h,34))
	local integer Level=GetUnitAbilityLevel(Source,'A28Q')//A28Q -> Overcharge
	local unit Target=(LoadUnitHandle(HY,h,17))
	local unit Z4G=(LoadUnitHandle(HY,(GetHandleId(Source)),652))
	local boolean DCD=false
	local real hpcost=.2*(GetWidgetLife(Source)*.025)
	local real mpcost=.2*(GetUnitState(Source,UNIT_STATE_MANA)*.025)
	if GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then
		if GetIssuedOrderId()==852589then
			call Y5G(Source,Level)
		elseif GetIssuedOrderId()==852590then
			call Y1G(Source)
		endif
	endif
	if GetUnitAbilityLevel(Source,'A1VM')>0 then
		set DCD=true
		call SetWidgetLife(Source,RMaxBJ(GetWidgetLife(Source)-hpcost,1))
		call SetUnitState(Source,UNIT_STATE_MANA,RMaxBJ(GetUnitState(Source,UNIT_STATE_MANA)-mpcost,1))
	endif
	if Z4G==null then
		if Target!=null then
			call Y1G(Target)
			set Target=null
			call SaveUnitHandle(HY,h,17,(Target))
		endif
	else
		if Target==null then
			set Target=Z4G
			if DCD then
				call SaveUnitHandle(HY,h,17,(Target))
				call Y5G(Target,Level)
			else
				call Y1G(Target)
			endif
		elseif Target!=Z4G then
			call Y1G(Target)
			if DCD then
				set Target=Z4G
				call SaveUnitHandle(HY,h,17,(Target))
				call Y5G(Target,Level)
			endif
		elseif DCD==false then
			call Y1G(Target)
		elseif Target==Z4G then
			if DCD then
				set Target=Z4G
				call SaveUnitHandle(HY,h,17,(Target))
				call Y5G(Target,Level)
			endif
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set Z4G=null
	return false
endfunction

function Wisp_Overcharge_Learn takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A28Q')//A28Q -> Overcharge
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(null))
	call TriggerRegisterTimerEvent(t,.2,true)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_ORDER)
	call TriggerAddCondition(t,Condition(function Wisp_Overcharge_Act))
	set Source=null
	set t=null
endfunction

function ZEG takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),NA8)==false then
		call GroupAddUnit(NA8,GetEnumUnit())
		call UnitAddAbilityTimedExF(GetEnumUnit(),'A304',1,.25+.5*NC8,'B304')
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\DragonHawkMissile\\DragonHawkMissile.mdl",GetEnumUnit(),"chest"))
	endif
endfunction

function ZFG takes unit Source,unit Target,group HND, integer lvl returns nothing
	local real x1=GetUnitX(Source)
	local real y1=GetUnitY(Source)
	local real x2=GetUnitX(Target)
	local real y2=GetUnitY(Target)
	local real a=AngleBetweenXY(x1,y1,x2,y2)*bj_DEGTORAD
	local real x
	local real y
	local real d=DistanceBetweenXY(x1,y1,x2,y2)
	local group g=GetAvailableGroup()
	local integer i=1
	set NA8=HND
	set NC8=lvl
	loop
		exitwhen i>8
		set tt_unit1=Source
		set x=x1+d*i/ 8*Cos(a)
		set y=y1+d*i/ 8*Sin(a)
		call GroupEnumUnitsInRange(g,x,y,100,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function ZEG)
		call GroupClear(g)
		set i=i+1
	endloop
	call KillGroup(g)
	set g=null
endfunction

function ZGG takes unit Source,unit Target returns boolean
	return((LoadInteger(HY,(GetHandleId((Source))),(4294)))==1)
endfunction

function ZHG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real d=DistanceBetweenUnits(Source,Target)
	local real a=AngleBetweenUnits(Source,Target)*bj_DEGTORAD
	local real x=GetUnitX(Source)+20*Cos(a)
	local real y=GetUnitY(Source)+20*Sin(a)
	local location l
	if d<300 or d>2150 then
		set l=LI8(x,y)
		set x=GetLocationX(l)
		set y=GetLocationY(l)
		if IsUnitType(Source,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
		endif
		call SetUnitX(Source,SafeX50(x))
		call SetUnitY(Source,SafeY50(y))
		call KillTrees(x,y,350)
		call RemoveLocation(l)
		set l=null
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SaveInteger(HY,(GetHandleId((Source))),(4295),2)
	else
		if IsUnitType(Source,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
		endif
		call SetUnitX(Source,x)
		call SetUnitY(Source,y)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function ZIG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local group HND=(LoadGroupHandle(HY,h,133))
	local lightning ZQ8=(LoadLightningHandle(HY,h,196))
	local integer Count=GetTriggerEvalCount(t)
	local real d=DistanceBetweenUnits(Source,Target)
	local real a=1
	local real WEE=GetWidgetLife(Source)
	local real IVD=GetUnitState(Source,UNIT_STATE_MANA)
	local real ZJG=(LoadReal(HY,h,670))
	local real ZKG=(LoadReal(HY,h,667))
	local real ZMG
	local real ZNG
	if Target==null or Source==null or IsDead(Source) or(Count>600 and ZGG(Source,Target)==false and((LoadInteger(HY,(GetHandleId((Source))),(4295)))==1)==false)or(d>925 and((LoadInteger(HY,(GetHandleId((Source))),(4295)))!=1))or GetTriggerEventId()==EVENT_WIDGET_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A1TU')then//A1TU -> End Tether
		call KillGroup(HND)
		call DestroyLightning(ZQ8)
		call UnitRemoveAbility(Target,'A1TM')//A1TH -> Tether Container - Level 1
		call UnitRemoveAbility(Target,'A1TL')//A1TI -> Tether Container - Level 2
		call UnitRemoveAbility(Target,'A1TK')//A1TG -> Tether Container - Level 3
		call UnitRemoveAbility(Target,'A1TN')//A1TJ -> Tether Container - Level 4
		call UnitRemoveAbility(Target,'B0DH')//B0DH -> Tether
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveAbility(Source,'A1TM')//A1TH -> Tether Container - Level 1
		call UnitRemoveAbility(Source,'A1TL')//A1TI -> Tether Container - Level 2
		call UnitRemoveAbility(Source,'A1TK')//A1TG -> Tether Container - Level 3
		call UnitRemoveAbility(Source,'A1TN')//A1TJ -> Tether Container - Level 4
		call UnitRemoveAbility(Source,'B0DH')//B0DH -> Tether
		call UnitRemoveAbility(Source,'A1TU')//A1TU -> End Tether
		if(LoadInteger(HY,(GetHandleId(Source)),704))==0 or(LoadInteger(HY,(GetHandleId(Source)),704))=='A1TA' then//A1TA -> Tether
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1TA',true)//A1TA -> Tether
		endif
		call RemoveSavedHandle(HY,GetHandleId(Source),652)
	else
		set ZMG=WEE/ GetUnitState(Source,UNIT_STATE_MAX_LIFE)
		set ZNG=IVD/ GetUnitState(Source,UNIT_STATE_MAX_MANA)
		if ZMG-ZJG>0 and(ZMG-ZJG)<.5 then
			if((LoadInteger(HY,(GetHandleId((Source))),(4298)))==1)==false then
				call SetWidgetLife(Target,GetWidgetLife(Target) + (ZMG-ZJG)*GetUnitState(Source,UNIT_STATE_MAX_LIFE)*1.5)
			endif
		endif
		if ZNG-ZKG>0 and(ZNG-ZKG)<.5 then
			call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)+(ZNG-ZKG)*GetUnitState(Source,UNIT_STATE_MAX_MANA)*1.5)
		endif
		call SaveReal(HY,h,670,((GetWidgetLife(Source)/ GetUnitState(Source,UNIT_STATE_MAX_LIFE))*1.))
		call SaveReal(HY,h,667,((GetUnitState(Source,UNIT_STATE_MANA)/ GetUnitState(Source,UNIT_STATE_MAX_MANA))*1.))
		call MoveLightning(ZQ8,true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
		call ZFG(Source,Target,HND,LoadInteger(HY,h,0))
		if IsUnitVisibleLoD(Source,GetLocalPlayer())==false and IsUnitVisibleLoD(Target,GetLocalPlayer())==false then
			set a=0
		endif
		if IsObserver(GetLocalPlayer())then
			set a=1
		endif
		if d<700 or((LoadInteger(HY,(GetHandleId((Source))),(4295)))==1) then
			call SetLightningColor(ZQ8,.0,1.,1.,a)
		else
			call SetLightningColor(ZQ8,.8,.7,.4,a)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set HND=null
	set ZQ8=null
	return false
endfunction

function Wisp_Tether takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local lightning ZQ8=AddLightning("CHIM",true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
	local integer Level=GetUnitAbilityLevel(Source,'A1TA')//A1TA -> Tether
	local integer ZEE
	local real d=DistanceBetweenUnits(Source,Target)
	local real a=AngleBetweenUnits(Source,Target)*bj_DEGTORAD
	local location l
	local real x
	local real y
	call SetLightningColor(ZQ8,.0,1.,1.,1)
	call UnitAddAbility2(Source,'A1TU')//A1TU -> End Tether
	if Level==1 then
		set ZEE='A1TM'//A1TH -> Tether Container - Level 1
	elseif Level==2 then
		set ZEE='A1TL'//A1TI -> Tether Container - Level 2
	elseif Level==3 then
		set ZEE='A1TK'//A1TG -> Tether Container - Level 3
	elseif Level==4 then
		set ZEE='A1TN'//A1TJ -> Tether Container - Level 4
	endif
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1TA',false)//A1TA -> Tether
	call UnitAddAbility2(Source,ZEE)
//	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),ZEE,false)
	call UnitAddAbility2(Target,ZEE)
//	call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),ZEE,false)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,0,Level)
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveGroupHandle(HY,h,133,(GetAvailableGroup()))
	call SaveLightningHandle(HY,h,196,(ZQ8))
	call SaveReal(HY,h,670,((GetWidgetLife(Source)/ GetUnitState(Source,UNIT_STATE_MAX_LIFE))*1.))
	call SaveReal(HY,h,667,((GetUnitState(Source,UNIT_STATE_MANA)/ GetUnitState(Source,UNIT_STATE_MAX_MANA))*1.))
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function ZIG))
	call SaveUnitHandle(HY,(GetHandleId(Source)),652,(Target))
	if d>700 then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveUnitHandle(HY,h,17,(Target))
		call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("Abilities\\Weapons\\DragonHawkMissile\\DragonHawkMissile.mdl",Source,"chest")))
		call TriggerRegisterTimerEvent(t,.02,true)
		call TriggerAddCondition(t,Condition(function ZHG))
		call SaveInteger(HY,(GetHandleId((Source))),(4295),1)
	endif
	set Source=null
	set Target=null
	set ZQ8=null
	set t=null
	set l=null
endfunction

function ZQG takes unit Source,real x,real y returns boolean
	local boolean result=false
	local player p=GetOwningPlayer(Source)
	local unit Caster=CreateUnit(p,'e02Q',GetUnitX(Source),GetUnitY(Source),0)//e02Q -> Spellcaster Blink Dummy
	call UnitAddAbility2(Caster,'A1V4')//A1V4 -> Blink (Test Version)
	if IssuePointOrderById(Caster,852525,x,y) then
		call KillUnit(Caster)
		set Caster=null
		set p=null
		return true
	else
		call KillUnit(Caster)
		set Caster=null
		set p=null
		return false
	endif
endfunction

function ZRG takes string ZS8,unit Target returns nothing
	local texttag tt=CreateTextTag()
	call SetTextTagText(tt,ZS8,.033)
	call SetTextTagPosUnit(tt,Target,64)
	call SetTextTagColor(tt,0,50,255,255)
	call SetTextTagVelocity(tt,0,.0355)
	call SetTextTagFadepoint(tt,.15)
	call SetTextTagPermanent(tt,false)
	call SetTextTagLifespan(tt,.85)
	call SetTextTagVisibility(tt,IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Target)))
	set tt=null
endfunction

function ZSG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer Count=GetTriggerEvalCount(t)
	if IsDead(Source)==false and Count<12 then
		call ZRG(I2S(12-Count),Source)
	endif
	if Count==12 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	return false
endfunction

function ZTG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,(GetHandleId(Source)),652))
	local real TargetX=(LoadReal(HY,h,47))
	local real TargetY=(LoadReal(HY,h,48))
	local real SourceX=(LoadReal(HY,h,189))
	local real SourceY=(LoadReal(HY,h,190))
	local fogmodifier fm=(LoadFogModifierHandle(HY,h,42))
	local string s
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SaveInteger(HY,(GetHandleId((Source))),(4294),2)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FogModifierStop(fm)
		call DestroyFogModifier(fm)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call KillTrees(TargetX,TargetY,250)
		call KillTrees(SourceX,SourceY,250)
		set s="Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl"
		if GetTriggerEvalCount(t)==1 then
			if IsDead(Source)==false then
				call DestroyEffect(AddSpecialEffect(s,GetUnitX(Source),GetUnitY(Source)))
				call SetUnitPosition(Source,TargetX,TargetY)
				call PanCameraToTimedForPlayer(GetOwningPlayer(Source),TargetX,TargetY,0)
				call DestroyEffect(AddSpecialEffect(s,GetUnitX(Source),GetUnitY(Source)))
			endif
			if Target!=null and IsDead(Target)==false and GetOwningPlayer(Target)!=Sentinels[0]and GetOwningPlayer(Target)!=Scourges[0]and(LoadBoolean(HY,GetHandleId(GetOwningPlayer(Target)),139)==false)then
				call DestroyEffect(AddSpecialEffect(s,GetUnitX(Target),GetUnitY(Target)))
				call AddTimedKeyToUnit(Target,4402,1)
				call SetUnitPosition(Target,TargetX,TargetY)
				if IsUnitType(Target,UNIT_TYPE_HERO) and IsDead(Target)==false then
					call PanCameraToTimedForPlayer(GetOwningPlayer(Target),TargetX,TargetY,0)
				endif
				call DestroyEffect(AddSpecialEffect(s,GetUnitX(Target),GetUnitY(Target)))
			endif
		else
			if IsDead(Source)==false then
				call DestroyEffect(AddSpecialEffect(s,GetUnitX(Source),GetUnitY(Source)))
				call SetUnitPosition(Source,SourceX,SourceY)
				call PanCameraToTimedForPlayer(GetOwningPlayer(Source),SourceX,SourceY,0)
				call DestroyEffect(AddSpecialEffect(s,GetUnitX(Source),GetUnitY(Source)))
			endif
			if Target!=null and IsDead(Target)==false and GetOwningPlayer(Target)!=Sentinels[0]and GetOwningPlayer(Target)!=Scourges[0]and(LoadBoolean(HY,GetHandleId(GetOwningPlayer(Target)),139)==false)then
				call DestroyEffect(AddSpecialEffect(s,GetUnitX(Target),GetUnitY(Target)))
				call AddTimedKeyToUnit(Target,4402,1)
				call SetUnitPosition(Target,SourceX,SourceY)
				if IsUnitType(Target,UNIT_TYPE_HERO) and IsDead(Target)==false then
					call PanCameraToTimedForPlayer(GetOwningPlayer(Target),SourceX,SourceY,0)
				endif
				call DestroyEffect(AddSpecialEffect(s,GetUnitX(Target),GetUnitY(Target)))
			endif
			call SaveInteger(HY,(GetHandleId((Source))),(4294),2)
			call DestroyEffect((LoadEffectHandle(HY,h,32)))
			call FogModifierStop(fm)
			call DestroyFogModifier(fm)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set fm=null
	return false
endfunction

function ZUG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real TargetX=(LoadReal(HY,h,47))
	local real TargetY=(LoadReal(HY,h,48))
	local fogmodifier fm=null
	local integer Level=GetUnitAbilityLevel(Source,'A1TB')+GetUnitAbilityLevel(Source,'A3FQ')//A1TB -> Relocate
	if IsUnitDisabled(Source)or IsUnitEntangled(Source)or IsDead(Source)then
		call SaveInteger(HY,(GetHandleId((Source))),(4294),2)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEvalCount(t)==(2.75-.25*Level)/ .05 then
		set fm=null//CreateFogModifierRadius(GetOwningPlayer(Source),FOG_OF_WAR_VISIBLE,GetUnitX(Source),GetUnitY(Source),400,true,true)
		call FogModifierStart(fm)
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(Source))
		call TriggerRegisterTimerEvent(t,.01,false)
		call TriggerRegisterTimerEvent(t,12,false)
		call TriggerRegisterDeathEvent(t,Source)
		call TriggerAddCondition(t,Condition(function ZTG))
		call SaveReal(HY,h,189,((GetUnitX(Source))*1.))
		call SaveReal(HY,h,190,((GetUnitY(Source))*1.))
		call SaveReal(HY,h,47,((TargetX)*1.))
		call SaveReal(HY,h,48,((TargetY)*1.))
		call SaveEffectHandle(HY,h,32,(AddSpecialEffect("war3mapImported\\EarthlyEminence.mdl",GetUnitX(Source),GetUnitY(Source))))
		call SaveFogModifierHandle(HY,h,42,(fm))
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(Source))
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddCondition(t,Condition(function ZSG))
	endif
	set Source=null
	set t=null
	set fm=null
	return false
endfunction

function Wisp_Relocate takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local unit Target=(LoadUnitHandle(HY,(GetHandleId(Source)),652))
	local integer id=GetPlayerId(GetOwningPlayer(Source))
	local integer Level=GetUnitAbilityLevel(Source,'A1TB')+GetUnitAbilityLevel(Source,'A3FQ')//A1TB -> Relocate
	local boolean b=false
	call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl",Source,"chest"))
	if IsPlayerAlly(GetOwningPlayer(Source),GetLocalPlayer()) or (udg_ObserverMode and IsObserver(GetLocalPlayer())) or IsVisibleToPlayer(x,y,GetLocalPlayer()) then
		set b=true
		call PingMinimapEx(x,y,4.,255,0,0,false)
	endif
	call TimedReveal(GetOwningPlayer(Source),2.5,x,y,300)
	call SaveUnitHandle(HY,h,2,(Source))
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerAddCondition(t,Condition(function ZUG))
	call SaveReal(HY,h,47,((x)*1.))
	call SaveReal(HY,h,48,((y)*1.))
	call SaveEffectHandle(HY,h,32,(AddSpecialEffect("war3mapImported\\EarthlyEminence.mdl",x,y)))
	call SaveInteger(HY,(GetHandleId((Source))),(4294),1)
	set Source=null
	set Target=null
	set t=null
endfunction

function Wisp_Relocate_OnCast takes nothing returns nothing
	if ZQG(GetTriggerUnit(),GetSpellTargetX(),GetSpellTargetY())==false then
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0KX'))//n0KX -> Cannot Relocate to unexplored terrain.
	else
		if IsSentinel(GetOwningPlayer(GetTriggerUnit()))then
			if IsPointInRegion(N68,GetSpellTargetX(),GetSpellTargetY()) then
				call InterruptUnit(GetTriggerUnit())
				call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n03Y'))//n03Y -> You cannot teleport there
			endif
		else
			if IsPointInRegion(N38,GetSpellTargetX(),GetSpellTargetY()) then
				call InterruptUnit(GetTriggerUnit())
				call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n03Y'))//n03Y -> You cannot teleport there
			endif
		endif
	endif
endfunction

function Wisp_Relocate_Init takes nothing returns nothing
	set N38=CreateRegion()
	call RegionAddRect(N38,G4)
	call RegionAddRect(N38,FountainRectFrogSent)
	set N68=CreateRegion()
	call RegionAddRect(N68,F4)
	call RegionAddRect(N68,FountainRectFrogScourge)
endfunction

function ZXG takes unit Source,unit Target,real SourceX,real SourceY,real a2 returns nothing
	local integer i=0
	local real TargetX
	local real TargetY=GetUnitY(Target)
	local real a
	local real x
	local real y
	local real ZYG
	set a=a2
	set TargetX=SourceX+50*Cos(a*bj_DEGTORAD)
	set TargetY=SourceY+50*Sin(a*bj_DEGTORAD)
	set ZYG=a
	set x=TargetX+200*Cos(ZYG*bj_DEGTORAD)
	set y=TargetY+200*Sin(ZYG*bj_DEGTORAD)
	call B88(CreateDestructable('B006',x,y,-1*ZYG,.6,1),7)//B006 -> Permanent Invisibility
	call KillTrees(x,y,300)
	set ZYG=a-40
	set x=TargetX+200*Cos(ZYG*bj_DEGTORAD)
	set y=TargetY+200*Sin(ZYG*bj_DEGTORAD)
	call B88(CreateDestructable('B006',x,y,-1*ZYG,.6,1),7)//B006 -> Permanent Invisibility
	call KillTrees(x,y,300)
	set ZYG=a-80
	set x=TargetX+200*Cos(ZYG*bj_DEGTORAD)
	set y=TargetY+200*Sin(ZYG*bj_DEGTORAD)
	call B88(CreateDestructable('B006',x,y,-1*ZYG,.6,1),7)//B006 -> Permanent Invisibility
	call KillTrees(x,y,300)
	set ZYG=a+40
	set x=TargetX+200*Cos(ZYG*bj_DEGTORAD)
	set y=TargetY+200*Sin(ZYG*bj_DEGTORAD)
	call B88(CreateDestructable('B006',x,y,-1*ZYG,.6,1),7)//B006 -> Permanent Invisibility
	call KillTrees(x,y,300)
	set ZYG=a+80
	set x=TargetX+200*Cos(ZYG*bj_DEGTORAD)
	set y=TargetY+200*Sin(ZYG*bj_DEGTORAD)
	call B88(CreateDestructable('B006',x,y,-1*ZYG,.6,1),7)//B006 -> Permanent Invisibility
	call KillTrees(x,y,300)
endfunction

function ZZG takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),N58)==false then
		call GroupAddUnit(N58,GetEnumUnit())
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\ChainFreeze_F6.mdx",GetEnumUnit(),"chest"))
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\FrostWyrmMissile\\FrostWyrmMissile.mdl",GetEnumUnit(),"chest"))
		call DamageTarget(NL8,GetEnumUnit(),1,N08*70)
	endif
endfunction

function ZAG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local unit proj=LoadUnitHandle(HY,h,45)
	local real maxX=LoadReal(HY,h,683)
	local real maxY=LoadReal(HY,h,684)
	local real SourceX=GetUnitX(proj)
	local real SourceY=GetUnitY(proj)
	local real angle=Atan2(maxY-SourceY,maxX-SourceX)
	local real nx=SourceX+22*Cos(angle)
	local real ny=SourceY+22*Sin(angle)
	local group gg=LoadGroupHandle(HY,h,133)
	local integer Level=LoadInteger(HY,h,0)
	local group g=GetAvailableGroup()
	set tt_unit1=Source
	set NL8=Source
	set N58=gg
	set N08=Level
	call GroupEnumUnitsInRange(g,nx,ny,225,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	call ForGroup(g,function ZZG)
	call KillGroup(g)
	call SetUnitPosition(proj,nx,ny)
	if DistanceBetweenXY(nx,ny,maxX,maxY)<40 then
		call KillUnit(proj)
		//call ShowUnit(proj,false)
		call SetUnitPathing(proj,true)
		call ZXG(Source,null,nx,ny,angle*bj_RADTODEG)
		call KillGroup(gg)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set Source=null
	set Target=null
	set t=null
	set proj=null
	set gg=null
	set g=null
	return false
endfunction

function Tuskar_IceShards takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit proj=CreateUnit(GetOwningPlayer(Source),'h0CS',GetUnitX(Source),GetUnitY(Source),0)//h0CS -> Ice Shard
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real TargetX=GetSpellTargetX()
	local real TargetY=GetSpellTargetY()
	local real angle=Atan2(TargetY-SourceY,TargetX-SourceX)
	local real maxX=SafeX50(TargetX)
	local real maxY=SafeY50(TargetY)
	call SetUnitFacing(proj,angle*bj_RADTODEG)
	call SetUnitPathing(proj,false)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function ZAG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,683,maxX*1.)
	call SaveReal(HY,h,684,maxY*1.)
	call SaveReal(HY,h,13,angle*1.)
	call SaveUnitHandle(HY,h,45,proj)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call SaveGroupHandle(HY,h,133,GetAvailableGroup())
	set Source=null
	set proj=null
	set t=null
endfunction

function Z6G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,0)
	local integer Count=GetTriggerEvalCount(t)
	local real y=(Count-50)*(Count-50)/ 4.3
	local real Damage
	if Level==1 then
		set Damage=75
	elseif Level==2 then
		set Damage=150
	else
		set Damage=225
	endif
	if Count==1 then
		call IssueTargetOrderById(Source,ORDER_attack,Target)
	endif
	if Count<50 then
		if IsBuggyFlying(Target)==false then
			call SetUnitFlyHeight(Target,700*Count/ 50,0)
		endif
	elseif Count<100 then
		if IsBuggyFlying(Target)==false then
			call SetUnitFlyHeight(Target,700-700*(Count-50)/ 50,0)
		endif
	else
		if IsBuggyFlying(Target)==false then
			call SetUnitFlyHeight(Target,GetUnitDefaultFlyHeight(Target),0)
		endif
		call DestroyEffect(LoadEffectHandle(HY,h,175))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitAddAbilityTimedEx(Target,'A204',1,1+Level,'B0DY')//B0DY -> Walrus Punch
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A204',false)
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function ZLG takes unit Source,unit Target, integer Level returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TextTagOnUnit("WALRUS PUNCH !!",3.5,Source,.03,255,0,0,255)
	call PlaySoundAtPos(VF,GetUnitX(Target),GetUnitY(Target))
	call StunTargetLoD(Target,1.0)
	if IsBuggyFlying(Target)==false then
		call UnitAddAbility2(Target,'Amrf')//Amrf -> Crow Form
		call UnitRemoveAbility(Target,'Amrf')//Amrf -> Crow Form
	endif
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"overhead"))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"head"))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"left,hand"))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"right,hand"))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"chest"))
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"origin"))
	call TriggerRegisterTimerEvent(t,.01,true)
	call TriggerAddCondition(t,Condition(function Z6G))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveInteger(HY,h,0,Level)
	call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\FreezingBreath\\FreezingBreathMissile.mdl",Target,"chest"))
	set t=null
endfunction

function WalrusPunchASFixSup takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	call UnitRemoveAbility(u,'A1UH')
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTimer(t)
	set u=null
	set t=null
endfunction

function WalrusPunchASFix takes unit u returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.2,false,function WalrusPunchASFixSup)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	set t=null
endfunction

function Z1G takes nothing returns boolean
	local trigger t2=GetTriggeringTrigger()
	local integer h2=GetHandleId(t2)
	local unit Source=LoadUnitHandle(HY,h2,2)
	local unit Target=LoadUnitHandle(HY,h2,17)
	local effect Visual=LoadEffectHandle(HY,h2,32)
	local trigger t=LoadTriggerHandle(HY,h2,35)
	local integer h=LoadInteger(HY,h2,375)
	if GetTriggerEvalCount(t2)==1 then
		call IssueTargetOrderById(Source,ORDER_attack,Target)
	else
		if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
			if GetEventDamageSource()==Source and GetEventDamage()>30 and IsRealDamage and IsFakeDamage<1 then
				call AddTimedAbility(Source,'A1UH',1,.1)
				call DestroyEffect(Visual)
				call CleanTrigger(t2)
				call FlushChildHashtable(HY,h2)
				call CleanTrigger(t)
				call FlushChildHashtable(HY,h)
				call ZLG(Source,Target,LoadInteger(HY,h2,0))
			endif
		elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
			if GetAttacker()==Source and GetTriggerUnit()!=Target then
				call FlushChildHashtable(HY,h2)
				call CleanTrigger(t2)
			endif
		else
			
			call UnitRemoveAbility(Source,'A1UH')
			call RemoveSavedHandle(HY,h,17)
			call FlushChildHashtable(HY,h2)
			call CleanTrigger(t2)
		endif
	endif
	set t2=null
	set t=null
	set Source=null
	set Target=null
	set Visual=null
	return false
endfunction

function Z5G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target
	local effect Visual=LoadEffectHandle(HY,h,32)
	local trigger t2
	local integer h2
	if GetTriggerEventId()!=EVENT_PLAYER_UNIT_ATTACKED then
		call DestroyEffect(Visual)
		call UnitRemoveAbility(Source,'A1UH')
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetAttacker()==Source and GetTriggerUnit()!=(LoadUnitHandle(HY,h,17))and IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(Source))==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(Source)!='N0MH' then//N0MH -> Ember Spirit
		set Target=GetTriggerUnit()
		call SaveUnitHandle(HY,h,17,Target)
		set t2=CreateTrigger()
		set h2=GetHandleId(t2)
		call TriggerRegisterTimerEvent(t2,0,false)
		call TriggerRegisterTimerEvent(t2,2,false)
		call TriggerRegisterUnitEvent(t2,Target,EVENT_UNIT_DAMAGED)
		call TriggerRegisterAnyUnitEvent(t2,EVENT_PLAYER_UNIT_ATTACKED)
		call TriggerAddCondition(t2,Condition(function Z1G))
		call SaveUnitHandle(HY,h2,2,Source)
		call SaveUnitHandle(HY,h2,17,Target)
		call SaveEffectHandle(HY,h2,32,Visual)
		call SaveInteger(HY,h2,375,h)
		call SaveTriggerHandle(HY,h2,35,t)
		call SaveInteger(HY,h2,0,LoadInteger(HY,h,0))
	endif
	set t=null
	set Source=null
	set Target=null
	set Visual=null
	set t2=null
	return false
endfunction

function Tuskar_WalrusPunch takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterTimerEvent(t,10,false)
	call TriggerAddCondition(t,Condition(function Z5G))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,null)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\WalrusPunchWeaponFX.mdx",Source,GetProperAttachPoint_Weapon(Source)))
	call UnitAddAbility2(Source,'A1UH')
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	if(GetUnitAbilityLevel(Source,'A0DL')>0) then//A0DL -> Enchant Totem
		call SetUnitAbilityLevel(Source,'A1UL',2)//A1UL -> Walrus Critical 1
	endif
	call UnitMakeAbilityPermanent(Source,true,'A1UL')//A1UL -> Walrus Critical 1
	set t=null
	set Source=null
endfunction

function WalrusKick_Add takes nothing returns nothing
	call UnitAddAbility2(tt_unit1,'A3DF')//A3DF -> Walrus Kick
	call SetPlayerAbilityAvailable(GetOwningPlayer(tt_unit1),'A3DF',true)//A3DF -> Walrus Kick
endfunction

function WalrusKick_Remove takes nothing returns nothing
	call SetPlayerAbilityAvailable(GetOwningPlayer(tt_unit1),'A3DF',false)//A3DF -> Walrus Kick
endfunction

function WalrusKickPeriodic takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,(h),2))
	local unit target=(LoadUnitHandle(HY,(h),17))
	local real initX=(LoadReal(HY,(h),6))
	local real initY=(LoadReal(HY,(h),7))
	local real a=LoadReal(HY,h,1)
	local real startX=(LoadReal(HY,(h),23))
	local real startY=(LoadReal(HY,(h),24))
	local real nX
	local real nY
	local boolean finish=false
	local real step=LoadReal(HY,h,0)
	set nX=startX+step*Cos(a)
	set nY=startY+step*Sin(a)
	if DistanceBetweenXY(nX,nY,initX,initY)<(5+step)then
		set nX=initX
		set nY=initY
		set finish=true
	endif
	set nX=SafeX50(nX)
	set nY=SafeY50(nY)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetUnitAbilityLevel(target,'B08V')>0 or GetTriggerEvalCount(t)>200 then//B08V -> Black Hole
		set finish=true
	else
		call SetUnitPosition(target,nX,nY)
		call SetUnitX(target,nX)
		call SetUnitY(target,nY)
		call KillTrees(nX,nY,120)
		call SaveReal(HY,(h),23,((nX)*1.0))
		call SaveReal(HY,(h),24,((nY)*1.0))
	endif
	if finish then
		call SetUnitPathing(target,true)
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	endif
	set target=null
	set t=null
	set caster=null
	return false
endfunction

function WalrusKickStart takes nothing returns nothing
	local unit target=GetSpellTargetUnit()
	local unit caster=GetTriggerUnit()
	local integer lvl=1
	local trigger t
	local integer h
	local real face
	local real x=GetUnitX(caster)
	local real y=GetUnitY(caster)
	local integer i=-1
	local boolean stop=false
	local real dist=900
	set face=AngleBetweenUnits(caster,target)*bj_DEGTORAD
	set t=CreateTrigger()
	set h=GetHandleId(t)
	loop
		exitwhen stop or i==23
		set i=i+1
		set x=SafeX50(GetUnitX(target)+(dist-i*25)*Cos(face))
		set y=SafeY50(GetUnitY(target)+(dist-i*25)*Sin(face))
		if(IsPointInRegion(RestrictedRegion,((x)*1.0),((y)*1.0)))==false then
			set stop=true
		endif
	endloop
	call SetUnitPathing(target,false)
	call TriggerRegisterTimerEvent(t,0.03,true)
	call TriggerRegisterDeathEvent(t,target)
	call TriggerAddCondition(t,Condition(function WalrusKickPeriodic))
	call SaveUnitHandle(HY,(h),2,(caster))
	call SaveUnitHandle(HY,(h),17,(target))
	call SaveReal(HY,(h),6,((x)*1.0))
	call SaveReal(HY,(h),7,((y)*1.0))
	call SaveReal(HY,(h),23,((GetUnitX(target))*1.0))
	call SaveReal(HY,(h),24,((GetUnitY(target))*1.0))
	call SaveInteger(HY,(h),34,0)
	call SaveReal(HY,h,0,900*0.03)
	call SaveReal(HY,h,1,face)
	call UnitAddAbilityTimedExF(target,'A3DG',1,5,'B3DG')
	call DamageTarget(caster,target,1,200)
	set target=null
	set caster=null
	set t=null
endfunction

function WalrusKickCheck takes nothing returns nothing
	if GetSpellTargetUnit()==Roshan then//n00L -> Roshan
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0K9'))//n0K9 ->  Invalid Target//n0K9 -> Invalid Target
	else
//		call DelayedAnim(GetTriggerUnit(),0,3)
		call AddEffectTargetTimed("Abilities\\Weapons\\FrostWyrmMissile\\FrostWyrmMissile.mdl",GetTriggerUnit(),"hand",0.2)
	endif
endfunction

function WalrusKickEffect takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call WalrusKickStart()
	endif
endfunction

function A7G takes nothing returns nothing
	call ShowUnit(GetEnumUnit(),true)
	call UnitRemoveAbility(GetEnumUnit(),'A04R')//
	call SetUnitInvulnerable(GetEnumUnit(),false)
	call PauseUnit(GetEnumUnit(),false)
	if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
		call SetUnitPosition(GetEnumUnit(),OD8,OE8)
		call SelectUnitForPlayerSingle(GetEnumUnit(),GetOwningPlayer(GetEnumUnit()))
	else
		call SetUnitX(GetEnumUnit(),OD8)
		call SetUnitY(GetEnumUnit(),OE8)
	endif
	if GetEnumUnit()==O48 and O78!=null then
		call IssueTargetOrderById(O48,ORDER_attack,O78)
	endif
	call DestroyEffect(AddSpecialEffect("war3mapImported\\ChainFreeze_F6.mdx",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FrostWyrmMissile\\FrostWyrmMissile.mdl",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
endfunction

function A8G takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),N28)==false then
		call GroupAddUnit(N28,GetEnumUnit())
		call DamageTarget(O48,GetEnumUnit(),1,40*O98+40)
		call StunTargetLoD(GetEnumUnit(),0.25*O98 + 0.25)
	endif
endfunction

function A9G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer Cache=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,(Cache),2))
	local unit Target=(LoadUnitHandle(HY,(Cache),17))
	local unit Projectile=(LoadUnitHandle(HY,(Cache),45))
	local real TargetX=GetUnitX(Target)
	local real TargetY=GetUnitY(Target)
	local real r=(LoadReal(HY,(Cache),671))
	local real a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),TargetX,TargetY)*bj_DEGTORAD
	local real x=GetUnitX(Projectile)+r*Cos(a)
	local real y=GetUnitY(Projectile)+r*Sin(a)
	local group HND=(LoadGroupHandle(HY,(Cache),133))
	local group g
	local integer Count=GetTriggerEvalCount(t)
	local real EMF=RMinBJ(2.5+(Count*.02),10)
	local real RFE=225+40*(Count*.02)
	set O98=GetUnitAbilityLevel(Source,'A1S7')//A1S7 -> Snowball
	set tt_unit1=Source
	set N28=HND
	set O48=Source
	set O78=Target
	set O88=(LoadUnitHandle(HY,(Cache),19))
	call SetUnitX(Projectile,x)
	call SetUnitY(Projectile,y)
	call SetUnitFacing(Projectile,a*bj_RADTODEG-180)
	call SetUnitScale(Projectile,EMF,EMF,EMF)
	if DistanceBetweenXY(x,y,TargetX,TargetY)<r*2 or Count==150 then
		call KillTrees(x,y,200)
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,x,y,RFE,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function A8G)
		call KillGroup(g)
		set g=null
		set OD8=x
		set OE8=y
		set g=LoadGroupHandle(HY,(Cache),22)
		call ForGroup((g),function A7G)
		call KillGroup(g)
		call KillGroup(HND)
		call KillUnit(Projectile)
		call CleanTrigger(t)
		if GetUnitAbilityLevel(Target,'A3E9')==1 and IsMagicImmune(Source)==false then
			call SaveUnitHandle(TempHash,'A3E9',0,Target)
			call SaveUnitHandle(TempHash,'A3E9',1,Source)
			call SaveInteger(TempHash,'A3E9',0,LoadInteger(HY,Cache,5))
			call ExecuteFunc("Tuskar_SnowballLotusOrb")
		endif
		call FlushChildHashtable(HY,(Cache))
	else
		if ModuloInteger(GetTriggerEvalCount(t),5)==0 then
			call KillTrees(x,y,200)
			set g=GetAvailableGroup()
			call GroupEnumUnitsInRange(g,x,y,RFE,Condition(function DefaultEnemyFilterWithAncients))
			call ForGroup(g,function A8G)
			call KillGroup(g)
			set g=null
		endif
	endif
	set t=null
	set Source=null
	set Projectile=null
	set HND=null
	set Target=null
	return false
endfunction

function ADG takes nothing returns nothing
	call DestroyEffect(AddSpecialEffect("war3mapImported\\ChainFreeze_F6.mdx",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
	call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FrostWyrmMissile\\FrostWyrmMissile.mdl",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
	call ShowUnit(GetEnumUnit(),false)
	call UnitAddAbility2(GetEnumUnit(),'A04R')//
	call SetUnitInvulnerable(GetEnumUnit(),true)
	call PauseUnit(GetEnumUnit(),true)
endfunction

function AEG takes nothing returns boolean
	local unit t = GetFilterUnit()
	local player p = GetOwningPlayer(t)
	local boolean b=false
	if IsUnitAlly(O48,p) and (p==GetOwningPlayer(O48) or (LoadBoolean(HY,GetHandleId(p),139)==false and IsUnitType(t,UNIT_TYPE_HERO))) and  AliveNonBuildOrMarker(t) then
		set b=true
	endif
	set t = null
	return b
endfunction

function Tuskar_Snowball takes unit Source, unit Target, integer lvl returns nothing
	local trigger t=CreateTrigger()
	local integer Cache=GetHandleId(t)
	local real SourceX=GetUnitX(Source)
	local real SourceY=GetUnitY(Source)
	local real TargetX=GetUnitX(Target)
	local real TargetY=GetUnitY(Target)
	local real a=AngleBetweenXY(SourceX,SourceY,TargetX,TargetY)*bj_DEGTORAD
	local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0C3',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))//h0C3 -> Snowball
	local group g=GetAvailableGroup()
	set OF8=0
	set O48=Source
	set OF8=675
	call GroupEnumUnitsInRange(g,SourceX,SourceY,255,Condition(function AEG))
	call ForGroup(g,function ADG)
	set O88=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
	call SetUnitTimeScale(Projectile,2)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function A9G))
	call SaveUnitHandle(HY,(Cache),2,(Source))
	call SaveInteger(HY,Cache,5,lvl)
	call SaveUnitHandle(HY,(Cache),17,(Target))
	call SaveUnitHandle(HY,(Cache),19,(O88))
	call SaveUnitHandle(HY,(Cache),45,(Projectile))
	call SaveReal(HY,(Cache),137,((a)*1.))
	call SaveReal(HY,(Cache),671,((OF8*.02)*1.))
	call SaveReal(HY,(Cache),47,((TargetX)*1.))
	call SaveReal(HY,(Cache),48,((TargetY)*1.))
	call SaveGroupHandle(HY,(Cache),22,(g))
	call SaveGroupHandle(HY,(Cache),133,(GetAvailableGroup()))
	set t=null
	set Projectile=null
endfunction

function Tuskar_SnowballWrapper takes nothing returns nothing
	call Tuskar_Snowball(GetTriggerUnit(),GetSpellTargetUnit(),GetUnitAbilityLevel(GetTriggerUnit(),'A1S7'))//A1S7 -> Snowball
endfunction

function Tuskar_SnowballLotusOrb takes nothing returns nothing
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	call Tuskar_Snowball(LoadUnitHandle(TempHash,'A3E9',0),LoadUnitHandle(TempHash,'A3E9',0),LoadInteger(TempHash,'A3E9',0))
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function Tuskar_FrozenSigil_Register takes unit u returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call TriggerAddCondition(t,Condition(function Oblivion_NetherWard_DmgBlock))
	set t=null
endfunction

function FrozenSigilFilter takes nothing returns boolean
	if IsUnitEnemy(GetFilterUnit(),tt_player1) and AliveNonBuildOrMarker(GetFilterUnit()) and IsMagicImmune(GetFilterUnit())==false then
		call UnitAddAbilityTimedExF(GetFilterUnit(),tt_int1,1,2,'B0DT')
	endif
	return false
endfunction

function Func4032 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit sigil=(LoadUnitHandle(HY,h,2))
	local unit caster=(LoadUnitHandle(HY,h,17))
	local group g
	local integer lvl=LoadInteger(HY,h,5)
	if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		if GetTriggerEvalCount(t)==1 then
			call IssueTargetOrder(sigil,"move",caster)
			call TriggerRegisterDeathEvent(t,sigil)
		endif
		set tt_player1=GetOwningPlayer(sigil)
		set tt_int1='A3JT'+lvl-1
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(sigil),GetUnitY(sigil),625,Condition(function FrozenSigilFilter))
		call KillGroup(g)
	else
		call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FrostWyrmMissile\\FrostWyrmMissile.mdl",GetUnitX(sigil),GetUnitY(sigil)))
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
	endif
	
	
	set t=null
	set sigil=null
	set caster=null
	return false
endfunction

function Func4033 takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerAddCondition(t,Condition(function Func4032))
	call TriggerRegisterTimerEvent(t,0.2,true)
	call SaveUnitHandle(HY,h,2,GetSummonedUnit())
	call SaveUnitHandle(HY,h,17,GetSummoningUnit())
	call SaveInteger(HY,h,5,GetUnitAbilityLevel(GetSummoningUnit(),'A1YR'))
	set t=null
endfunction

function AJG takes nothing returns boolean
	local integer id=GetUnitTypeId(GetSummonedUnit())
	if id=='o01J' or id=='o01K' or id=='o01L' or id=='o01M' then//o01J -> Frozen Sigil 1, o01K -> Frozen Sigil 2, o01L -> Frozen Sigil 3, o01M -> Frozen Sigil 4
		call Tuskar_FrozenSigil_Register(GetSummonedUnit())
		call Func4033()
	endif
	return false
endfunction

function Tusk_Sigil_Summon takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function AJG))
	set t=null
endfunction



function AMG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local unit Caster=(LoadUnitHandle(HY,h,19))
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED and IsRealDamage then
		set OH8=GetEventDamageSource()
	else
		call SetUnitX(Source,GetUnitX(Target))
		call SetUnitY(Source,GetUnitY(Target))
		call SetUnitX(Caster,GetUnitX(Target))
		call SetUnitY(Caster,GetUnitY(Target))
	endif
	set t=null
	set Source=null
	set Target=null
	set Caster=null
	return false
endfunction

function ANG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	if GetTriggerEventId()==EVENT_UNIT_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		set OH8=GetEventDamageSource()
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function AOG takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetSummoningUnit()
	local unit Target=GetSummonedUnit()
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
	local integer lvl
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function AMG))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveUnitHandle(HY,h,19,(Caster))
	if EM9(Source,'I0A8')then//I0A8 -> Radiance (|cff00ff00On|r)
		call UnitAddAbility(Caster,'A04I')//A04I -> Radiance Damage Aura
	endif
	if GetUnitAbilityLevel(Source,'A14K')>0 then//A14K -> Detector
		call UnitAddAbility(Caster,'A14K')//A14K -> Detector
	endif
	set lvl=GetUnitAbilityLevel(Source,'A06M')//A06M -> Thunder Clap
	if lvl==0 then
		set lvl=4
	endif
	if GetUnitAbilityLevel(Source,'A1B6')>0 then//A1B6 -> Primal Split upgrade
		call UnitAddAbility2(Target,'A06M')//A06M -> Thunder Clap
		call SetUnitAbilityLevel(Target,'A06M',lvl)//A06M -> Thunder Clap
	endif
	call SaveInteger(HY,GetHandleId(Source),4500,1)
	set t=null
	set Source=null
	set Target=null
	set Caster=null
endfunction

function APG takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetSummoningUnit()
	local unit Target=GetSummonedUnit()
	local integer lvl
	local integer id
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function ANG))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	if GetUnitAbilityLevel(Source,'A1B6')>0 then//A1B6 -> Primal Split upgrade
	if GetUnitTypeId(Target)=='npn2' or GetUnitTypeId(Target)=='npn5' or GetUnitTypeId(Target)=='n012' then//storm//npn2 -> Storm Level 1, npn5 -> Storm Level 2, n012 -> Storm Level 3
		set id='Acdh'//Acdh -> Drunken Haze
		set lvl=GetUnitAbilityLevel(Source,'Acdh')//Acdh -> Drunken Haze
		if lvl==0 then
			set lvl=4
		endif
	else
		set id='Q119'
		set lvl=GetUnitAbilityLevel(Source,'P119')
		if lvl==0 then
			set lvl=4
		endif
	endif
	if id=='Q119' then
		call UnitAddAbility2(Target,id)
		call SetUnitAbilityLevel(Target,'P119',lvl)
		call UnitAddAbility2(Target,'A0MX')//A0MX -> Drunken Brawler
		call SetUnitAbilityLevel(Target,'A0MX',lvl)//A0MX -> Drunken Brawler
	else
		call UnitAddAbility2(Target,id)
		call SetUnitAbilityLevel(Target,id,lvl)
	endif
	endif
	set t=null
	set Source=null
	set Target=null
endfunction

function AQG takes nothing returns boolean
	local integer W78=GetUnitTypeId(GetSummonedUnit())
	if W78=='npn3' or W78=='npn6' or W78=='n010' or W78=='n0GZ' then//npn3 -> Earth, npn6 -> Earth, n010 -> Earth Level 3, n0GZ -> Earth Level 4
		call AOG()
	elseif IsPrimalSplitUnit(W78)then
		call APG()
	endif
	return false
endfunction

function Pandaren_PrimalSplit_Summon takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function AQG))
	set t=null
endfunction

function PandarenSpiritDispellFilter takes nothing returns boolean
	if IsDead(GetFilterUnit())==false and AliveNonBuildOrMarker(GetFilterUnit()) then
		call PurgingTriggered(GetFilterUnit(),IsUnitEnemy(GetFilterUnit(),tt_player1))
	endif
	return false
endfunction

function PandarenSpiritDispell takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local group g=GetAvailableGroup()
	set tt_player1=GetOwningPlayer(u)
	call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),625,Condition(function PandarenSpiritDispellFilter))
	call KillGroup(g)
	set u=null
endfunction

function Brewmaster_Stomp takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
	call UnitAddAbility(d,'A3ID')
	call SetUnitAbilityLevel(d,'A3ID',GetUnitAbilityLevel(GetTriggerUnit(),'A06M'))
	call IssueImmediateOrder(d,"thunderclap")
	set d=null
endfunction

function ARG takes nothing returns nothing
	call StunTargetLoD(GetEnumUnit(),.75+.25*Rubick_TempInt)
endfunction

function ASG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local real a=LoadReal(HY,h,137)
	local real TargetX=LoadReal(HY,h,47)
	local real TargetY=LoadReal(HY,h,48)
	local real SourceX=LoadReal(HY,h,189)
	local real SourceY=LoadReal(HY,h,190)
	local group g
	local real d=DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)/ 25
	local location l
	local integer Count=GetTriggerEvalCount(t)
	local real x=SourceX+d*Count*Cos(a)
	local real y=SourceY+d*Count*Sin(a)
	
	if IsUnitType(Target,UNIT_TYPE_HERO)then
		call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
	endif
	call SetUnitX(Target,SafeX50(x))
	call SetUnitY(Target,SafeY50(y))
	if IsBuggyFlying(Target)==false then
		call SetUnitFlyHeight(Target,325-13*Count,0)
	endif
	if Count==25 then
		if IsUnitType(Target,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
		endif
		call SetUnitX(Target,SafeX50(TargetX))
		call SetUnitY(Target,SafeY50(TargetY))
		if IsPointInRegion(RestrictedRegion,GetUnitX(Target),GetUnitY(Target)) then
			set l=LI8(GetUnitX(Target),GetUnitY(Target))
			if IsUnitType(Target,UNIT_TYPE_HERO)then
				call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
			endif
			call SetUnitX(Target,SafeX75(GetLocationX(l)))
			call SetUnitY(Target,SafeY75(GetLocationY(l)))
			call RemoveLocation(l)
			set l=null
		endif
		set tt_unit1=Source
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),350,Condition(function DefaultEnemyFilter))
		call GroupRemoveUnit(g,Target)
		set Rubick_TempInt=LoadInteger(HY,h,0)
		call ForGroup(g,function ARG)
		call KillGroup(g)
		call KillTrees(GetUnitX(Target),GetUnitY(Target),150)
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",GetUnitX(Target),GetUnitY(Target)))
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call DestroyEffect(LoadEffectHandle(HY,h,176))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		if IsBuggyFlying(Target)==false then
			call SetUnitFlyHeight(Target,GetUnitDefaultFlyHeight(Target),0)
		endif
		call SetUnitPathing(Target,true)
	endif
	set t=null
	set Source=null
	set Target=null
	set g=null
	return false
endfunction

function ATG takes unit Source,unit Target,unit Target2,real AUG,real AVG,effect FX,effect AWG, integer lvl returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local real TargetX=AUG
	local real TargetY=AVG
	local real a=AngleBetweenXY(GetUnitX(Target),GetUnitY(Target),AUG,AVG)*bj_DEGTORAD
	if DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),AUG,AVG)>375 then
		set TargetX=GetUnitX(Target)+375*Cos(a)
		set TargetY=GetUnitY(Target)+375*Sin(a)
	endif
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveReal(HY,h,137,a*1.)
	call SaveReal(HY,h,47,TargetX*1.)
	call SaveReal(HY,h,48,TargetY*1.)
	call SaveReal(HY,h,189,GetUnitX(Target)*1.)
	call SaveReal(HY,h,190,GetUnitY(Target)*1.)
	call SaveEffectHandle(HY,h,32,FX)
	call SaveEffectHandle(HY,h,176,AWG)
	call SaveInteger(HY,h,0,lvl)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function ASG))
	set t=null
endfunction

function AXG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Count=LoadInteger(HY,h,34)
	local integer RHE=LoadInteger(HY,h,12)
	local real TargetX=LoadReal(HY,h,47)
	local real TargetY=LoadReal(HY,h,48)
	local integer AYG=LoadInteger(HY,h,706)
	local real a
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or(GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT and IsUnitDisabled(Target)==false)then
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27F',true)//A27F -> Telekinesis
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27X',false)//A27X -> Telekinesis Land
		call ATG(Source,Target,LoadUnitHandle(HY,h,711),TargetX,TargetY,LoadEffectHandle(HY,h,32),LoadEffectHandle(HY,h,176),LoadInteger(HY,h,0))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if GetSpellAbilityId()=='A27X' then//A27X -> Telekinesis Land
			call DestroyEffect((LoadEffectHandle(HY,h,176)))
			set a=AngleBetweenXY(GetUnitX(Target),GetUnitY(Target),GetSpellTargetX(),GetSpellTargetY())*bj_DEGTORAD
			if DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),GetSpellTargetX(),GetSpellTargetY())>375 then
				set TargetX=GetUnitX(Target)+375*Cos(a)
				set TargetY=GetUnitY(Target)+375*Sin(a)
			else
				set TargetX=GetSpellTargetX()
				set TargetY=GetSpellTargetY()
			endif
			call SaveEffectHandle(HY,h,176,AddSpecialEffect("Abilities\\Spells\\Other\\GeneralAuraTarget\\GeneralAuraTarget.mdl",TargetX,TargetY))
			call SaveReal(HY,h,47,TargetX*1.)
			call SaveReal(HY,h,48,TargetY*1.)
			call SaveUnitHandle(HY,h,711,GetSpellTargetUnit())
			call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("Abilities\\Spells\\Other\\GeneralAuraTarget\\GeneralAuraTarget.mdl",GetSpellTargetUnit(),"origin"))
		endif
	else
		set Count=Count+1
		call SaveInteger(HY,h,34,Count)
		call SetUnitPathing(Target,false)
		if(LoadInteger(HY,h,707))==1 then
			set AYG=AYG+3
		else
			set AYG=AYG-3
		endif
		call SaveInteger(HY,h,706,AYG)
		if AYG==30 then
			call SaveInteger(HY,h,707,-1)
		elseif AYG==-30 then
			call SaveInteger(HY,h,707,1)
		endif
		if IsBuggyFlying(Target)==false then
			if Count<15 then
				call SetUnitFlyHeight(Target,Count*20,0)
			else
				call SetUnitFlyHeight(Target,300+AYG,0)
			endif
		endif
		if Count>(RHE-25)then
			if IsBuggyFlying(Target)==false then
				call SetUnitFlyHeight(Target,300,0)
			endif
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27F',true)//A27F -> Telekinesis
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27X',false)//A27X -> Telekinesis Land
			call ATG(Source,Target,LoadUnitHandle(HY,h,711),TargetX,TargetY,LoadEffectHandle(HY,h,32),LoadEffectHandle(HY,h,176),LoadInteger(HY,h,0))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function AZG takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer Level=GetUnitAbilityLevel(Source,'A27F')//A27F -> Telekinesis
	local real stundur=1.25+.25*Level
	local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	set stundur=StunTargetLoD(Target,stundur)
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27F',false)//A27F -> Telekinesis
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27X',true)//A27X -> Telekinesis Land
	call UnitAddAbility(Source,'A27X')//A27X -> Telekinesis Land
	call SetUnitPathing(Target,false)
	if IsBuggyFlying(Target)==false then
		call UnitAddAbility2(Target,'Amrf')//Amrf -> Crow Form
		call UnitRemoveAbility(Target,'Amrf')//Amrf -> Crow Form
	endif
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveUnitHandle(HY,h,711,Target)
	call SaveInteger(HY,h,12,R2I(stundur/ .02))
	call SaveInteger(HY,h,34,0)
	call SaveInteger(HY,h,0,Level)
	call SaveInteger(HY,h,706,0)
	call SaveInteger(HY,h,707,1)
	call SaveReal(HY,h,47,GetUnitX(Target)*1.)
	call SaveReal(HY,h,48,GetUnitY(Target)*1.)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\AntiGravityTarget.mdx",Target,"origin"))
	call SaveEffectHandle(HY,h,176,AddSpecialEffect("Abilities\\Spells\\Other\\GeneralAuraTarget\\GeneralAuraTarget.mdl",GetUnitX(Target),GetUnitY(Target)))
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function AXG))
	set Source=null
	set Target=null
	set t=null
	set Caster=null
endfunction

function Rubick_Telekinesis takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call AZG()
	endif
endfunction

function Rubick_Telekinez_Preload takes nothing returns nothing
	call PreloadQueryAdd('A282')//A282 -> Telekinesis Stun
endfunction

function ABG takes unit Source,unit Target, integer lvl returns nothing
	local integer id
	if IsUnitType(Target,UNIT_TYPE_HERO) then
		if lvl==1 then
			set id='A27W'//A27W -> Fade Bolt Damage - 1
		elseif lvl==2 then
			set id='A286'//A286 -> Fade Bolt Damage - 2
		elseif lvl==3 then
			set id='A285'//A285 -> Fade Bolt Damage - 3
		else
			set id='A287'//A287 -> Fade Bolt Damage - 4
		endif
	else
		if lvl==1 then
			set id='A291'//A291 -> Fade Bolt Damage Creeps - 1
		elseif lvl==2 then
			set id='A28Z'//A28Z -> Fade Bolt Damage Creeps - 2
		elseif lvl==3 then
			set id='A292'//A292 -> Fade Bolt Damage Creeps - 3
		else
			set id='A290'//A290 -> Fade Bolt Damage Creeps - 4
		endif
	endif
	call AddTimedAbility(Target,id,1,10)
	call PlaySoundAtPos(SF,GetUnitX(Target),GetUnitY(Target))
endfunction

function ACG takes nothing returns nothing
	local real d
	if IsUnitInGroup(GetEnumUnit(),OM8)==false then
		set d=DistanceBetweenUnits(GetEnumUnit(),OK8)
		if d<ON8 then
			set ON8=d
			set OJ8=GetEnumUnit()
		endif
	endif
endfunction

function A3G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local group AlreadyHit=LoadGroupHandle(HY,h,187)
	local real x=GetUnitX(Target)
	local real y=GetUnitY(Target)
	local group g=GetAvailableGroup()
	call GroupAddUnit(AlreadyHit,Target)
	call ABG(Source,Target,LoadInteger(HY,h,0))
	set tt_unit1=Source
	set OJ8=null
	set OK8=Target
	set OM8=AlreadyHit
	set ON8=999999
	call GroupEnumUnitsInRange(g,x,y,465,Condition(function NonImmuneVisibleEnemyFilter))
	call ForGroup(g,function ACG)
	call KillGroup(g)
	if OJ8==null or GetTriggerEvalCount(t)>26 then
		call KillGroup(AlreadyHit)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set Target=OJ8
		call SaveUnitHandle(HY,h,17,Target)
	endif
	set g=null
	set t=null
	set Source=null
	set Target=null
	set AlreadyHit=null
	return false
endfunction

function A6G takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local group AlreadyHit=GetAvailableGroup()
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))//e00E -> Spellcaster
	call PlaySoundAtPos(SF,GetUnitX(Source),GetUnitY(Source))
	call UnitAddAbility2(Caster,'A284')//A284 -> Fade Bolt
	call SetUnitAbilityLevel(Caster,'A284',GetUnitAbilityLevel(Source,'A27G'))//A284 -> Fade Bolt, A27G -> Fade Bolt
	call IssueTargetOrderById(Caster,852119,Target)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveGroupHandle(HY,h,187,AlreadyHit)
	call TriggerRegisterTimerEvent(t,.25,true)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call TriggerAddCondition(t,Condition(function A3G))
	set Source=null
	set Target=null
	set t=null
	set Caster=null
	set AlreadyHit=null
endfunction

function Rubick_Fadebolt takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call A6G()
	endif
endfunction

function RubickAddException takes integer id returns nothing
	set RubickExceptionsList[RubickExC]=id
	set RubickExC=RubickExC+1
endfunction

function A5G takes integer id returns boolean
	local integer i=0
	if isAintItemAbility(id)==false then
		return true
	endif
	loop
		exitwhen i==RubickExC
		if id==RubickExceptionsList[i]then
			return true
		endif
		set i=i+1
	endloop
	return false
endfunction

function A2G takes nothing returns boolean
	local unit u = GetTriggerUnit()
	local integer spell = GetSpellAbilityId()
	local integer info
	if IsUnitType(u,UNIT_TYPE_HERO) and A5G(spell)==false and GetUnitAbilityLevel(u,'A04R')==0 then//
		set info = GetHandleId(u)
		call SaveInteger(HY,info,705,spell)
		call SaveInteger(HY,info,712,GetUnitAbilityLevel(u,spell))
	endif
	set u = null
	return false
endfunction

function B7G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer B8G=(LoadInteger(HY,h,704))
	local integer W7F=(LoadInteger(HY,h,713))
	if B8G==(LoadInteger(HY,(GetHandleId(Source)),704))then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif GetTriggerEvalCount(t)>(15-W7F)and IsDead(Source)==false then
		call UnitRemoveAbility(Source,B8G)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Source=null
	return false
endfunction

function B9G takes unit Source,integer B8G,real DRD returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function B7G))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,704,(B8G))
	call SaveInteger(HY,(GetHandleId(Source)),704,(-1))
	call SaveInteger(HY,h,713,(R2I((TimerGetElapsed(GlobalTimer))-DRD)))
	set t=null
endfunction

function BDG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer B8G=(LoadInteger(HY,h,704))
	local integer Count=(LoadInteger(HY,h,34))
	local integer Level=IMaxIF(GetUnitAbilityLevel(Source,'A27H'),GetUnitAbilityLevel(Source,'A30J'))//A27H -> Spell Steal, A30J -> Spell Steal
	local real DRD=(LoadReal(HY,h,411))
	if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT and GetTriggerEventId()!=EVENT_WIDGET_DEATH then
		if Count==0 then
			call SaveInteger(HY,h,34,1)
			call DisplayTimedTextToPlayer(GetOwningPlayer(Source),0,0,10,"|c00ff0303"+GetObjectName('n0LW')+"|r")//n0LW -> 20 seconds remaining for your stolen spell
		else
			call RemoveSubSpellsFromUnit(Source)
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),B8G,false)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call B9G(Source,B8G,DRD)
		endif
	elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if (GetSpellAbilityId()=='A27H' or GetSpellAbilityId()=='A30J') then//A27H -> Spell Steal, A30J -> Spell Steal
			call RemoveSubSpellsFromUnit(Source)
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),B8G,false)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			call B9G(Source,B8G,DRD)
		elseif GetSpellAbilityId()==B8G then
			call SaveReal(HY,h,411,(((TimerGetElapsed(GlobalTimer)))*1.))
		endif
	elseif GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call RemoveSubSpellsFromUnit(Source)
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),B8G,false)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call B9G(Source,B8G,DRD)
	endif
	set t=null
	set Source=null
	return false
endfunction

function RubickAdvancedSpellSteal takes unit u, integer id, integer lvl returns nothing
	if id=='A2O2'then//A2O2 -> Trueshot Aura
		set tt_unit1=u
		call ExecuteFunc("MyTrueshotRubick")
	endif
endfunction

function BEG takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer B8G=(LoadInteger(HY,h,704))
	local integer Level=(LoadInteger(HY,h,5))
	local real BFG=60*(2+IMaxIF(GetUnitAbilityLevel(Source,'A27H'),GetUnitAbilityLevel(Source,'A30J')))//A27H -> Spell Steal, A30J -> Spell Steal
	local integer id=GetPlayerId(GetOwningPlayer(Source))
	local boolean canSteal=(GetUnitAbilityLevel(Source,B8G)==0)
	local integer i=1
	call PlaySoundAtPos(LF,GetUnitX(Source),GetUnitY(Source))
	loop
		exitwhen i>4+NumberOfExtraAbilities or canSteal==false
		if SkillID[PlayerSkillNumber[id*PlayerSkillOffset+i]]==B8G then
			set canSteal=false
		endif
		if AlternateSkillID[PlayerSkillNumber[id*PlayerSkillOffset+i]]==B8G then
			set canSteal=false
		endif
		set i=i+1
	endloop
	if canSteal then
		if(LoadInteger(HY,(GetHandleId(Target)),710))>0 then
			call SaveInteger(HY,(GetHandleId(Source)),710,((LoadInteger(HY,(GetHandleId(Target)),710))))
		endif
		call TextTagOnUnit(GetObjectName(B8G),3.5,Source,.024,170,0,255,216)
		call SaveInteger(HY,(GetHandleId(Source)),704,(B8G))
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),B8G,true)
		call UnitAddAbility2(Source,B8G)
		call SetUnitAbilityLevel(Source,B8G,Level)
		call RubickAdvancedSpellSteal(Source,B8G,Level)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveInteger(HY,h,34,0)
		call SaveInteger(HY,h,704,(B8G))
		call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
		call TriggerRegisterTimerEvent(t,BFG,false)
		call TriggerRegisterDeathEvent(t,Source)
		call TriggerRegisterTimerEvent(t,BFG-20,false)
		call TriggerAddCondition(t,Condition(function BDG))
	else
		call TextTagOnUnit("Failed ;(",3.5,Source,.024,170,0,255,216)
	endif
	set t=null
	set Source=null
	set Target=null
endfunction

function BGG takes unit Source,unit Target,integer B8G,integer Level returns nothing
	local trigger t=AddProjectile(Target,Source,'h0DB',"BEG",900,false)//h0DB -> Spell Steal Projectile
	local integer h=GetHandleId(t)
	call PlaySoundAtPos(KF,GetUnitX(Target),GetUnitY(Target))
	call TextTagOnUnit(GetObjectName(B8G),3.75,Target,.024,170,0,255,216)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,704,(B8G))
	call SaveInteger(HY,h,5,(Level))
	set t=null
endfunction

function GetAghaVersion takes integer id returns integer
	local integer i=1
	loop
		exitwhen i>AghaCounter
		if id==AghaUpgradedSpellID[i] or id==AghaBaseSpellID[i]  then
			return i
		endif
		
		set i=i+1
	endloop
	return 0
endfunction

function BIG takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	
	local integer id=LoadInteger(HY,(GetHandleId(Target)),705)
	local boolean b=GetSpellAbilityId()=='A30J'//A30J -> Spell Steal
	if(id)!=0 then
		if b then//upgraded
			if GetAghaVersion(id)>0 and AghaUpgradedSpellID[GetAghaVersion(id)]>0 then
				set id=AghaUpgradedSpellID[GetAghaVersion(id)]
			endif
		else
			if GetAghaVersion(id)>0 and AghaBaseSpellID[GetAghaVersion(id)]>0 then
				set id=AghaBaseSpellID[GetAghaVersion(id)]
			endif
		endif
		call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\Nebula.mdx",Target,"origin"))
		call BGG(Source,Target,id,LoadInteger(HY,GetHandleId(Target),712))
	endif
	set Source=null
	set Target=null
endfunction

function Rubick_SpellSteal takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call BIG()
	endif
endfunction

function BKG takes nothing returns nothing
	call RubickAddException('A0A5')//A0A5 -> Summon Spirit Bear
	call RubickAddException('A0AG')//A0AG -> True Form
	call RubickAddException('A0BG')//A0BG -> Spin Web
	call RubickAddException('A0DY')//A0DY -> Impetus
	call RubickAddException('A0ES')//A0ES -> Empowering Haste
	call RubickAddException('A0FH')//A0FH -> Shadowraze
	call RubickAddException('A0GC')//A0GC -> Morph Replicate
	call RubickAddException('A0NS')//A0NS -> Borrowed Time
	call RubickAddException('A0Q5')//A0Q5 -> Assault Cuirass
	call RubickAddException('A0TE')//A0TE -> Orchid Spell Book
	call RubickAddException('A0TK')//A0TK -> Aghanims Spell Book
	call RubickAddException('A0WP')//A0WP -> God's Strength
	call RubickAddException('A0WQ')//A0WQ -> Insatiable Hunger
	call RubickAddException('A03G')//A03G -> Elder Dragon Form
	call RubickAddException('A03J')//A03J -> Exorcism
	call RubickAddException('A04J')//A04J -> Exorcism
	call RubickAddException('A04M')//A04M -> Exorcism
	call RubickAddException('A04N')//A04N -> Exorcism
	call RubickAddException('A073')//A073 -> Exorcism
	call RubickAddException('A1C0')//A1C0 -> Splitshot
	call RubickAddException('A1DA')//A1DA -> Borrowed Time Upgrade
	call RubickAddException('A1EA')//A1EA -> Refraction
	call RubickAddException('A1FQ')//A1FQ -> MKB Spell Book
	call RubickAddException('A1MN')//A1MN -> Ice Blast Helper
	call RubickAddException('A1NA')//A1NA -> Soul Assumption
	call RubickAddException('A1NH')//A1NH -> Unstable Concoction
	call RubickAddException('A1RI')//A1RI -> Metamorphosis
	call RubickAddException('A1S9')//A1S9 -> Release Poison
	call RubickAddException('A1T8')//A1T8 -> Spirits
	call RubickAddException('A1TU')//A1TU -> End Tether
	call RubickAddException('A1TX')//A1TX -> Flak Cannon
	call RubickAddException('A1VG')//A1VG -> War Club
	call RubickAddException('A1VH')//A1VH -> Sentinel
	call RubickAddException('A1VU')//A1VU -> End Charge
	call RubickAddException('A1WF')//A1WF -> Focused Detonate
	call RubickAddException('A1WO')//A1WO -> Ring of Basilius Container
	call RubickAddException('A1Z2')//A1Z2 -> Target Fire Spirits
	call RubickAddException('A1Z3')//A1Z3 -> Sun Ray
	call RubickAddException('A2FX')//A2FX -> Chakram End
	call RubickAddException('A2JL')//A2JL -> Fire Remnant
	call RubickAddException('A2JO')//A2JO -> Fire Remnant
	call RubickAddException('A2JP')//A2JP -> Fire Remnant
	call RubickAddException('A2JQ')//A2JQ -> Fire Remnant
	call RubickAddException('A2JR')//A2JR -> Fire Remnant
	call RubickAddException('A2K9')//A2K9 -> Linken Sphere Stat Bonus Container
	call RubickAddException('A2KE')//A2KE -> Ring of Aquila Container
	call RubickAddException('A2KH')//A2KH -> Refresher Container
	call RubickAddException('A10R')//A10R -> Devour
	call RubickAddException('A11N')//A11N -> X Marks The Spot
	call RubickAddException('A11T')//A11T -> Spirit Form
	call RubickAddException('A20N')//A20N -> Icarus Dive End
	call RubickAddException('A21H')//A21H -> Pulse Nova turn off
	call RubickAddException('A21J')//A21J -> Ancestral Spirit
	call RubickAddException('A24A')//A24A -> Oscillate In
	call RubickAddException('A24B')//A24B -> Oscillate Out
	call RubickAddException('A24E')//A24E -> Song of the Siren
	call RubickAddException('A27F')//A27F -> Telekinesis
	call RubickAddException('A27G')//A27G -> Fade Bolt
	call RubickAddException('A27H')//A27H -> Spell Steal
	call RubickAddException('A27X')//A27X -> Telekinesis Land
	call RubickAddException('A28F')//A28F -> Veil of Discord Spellbook
	call RubickAddException('A28Q')//A28Q -> Overcharge
	call RubickAddException('A30J')//A30J -> Spell Steal
	call RubickAddException('A32D')//A32D -> Digest Spit
	call RubickAddException('A43D')//A43D -> God's Strength Agh
	call RubickAddException('A43P')//A43P -> Chakram End
	call RubickAddException('A121')//A121 -> Illuminate End
	call RubickAddException('A205')//A205 -> Sun Ray Movement
	call RubickAddException('A229')//A229 -> Flak Cannon
	call RubickAddException('A418')//A418 -> Splitshot
	call RubickAddException('ANcr')//ANcr -> Chemical Rage
	call RubickAddException('QB0K')//QB0K -> Chemical Rage
	call RubickAddException('QB03')//QB03 -> Refraction
	call RubickAddException('QM00')//QM00 -> Elder Dragon Form
	call RubickAddException('QM01')//QM01 -> Spirit Form
	call RubickAddException('QM02')//QM02 -> Shapeshift
	call RubickAddException('QM03')//QM03 -> Flesh Golem
	call RubickAddException('QM04')//QM04 -> Firefly
	call RubickAddException('Z234')//Z234 -> Spin Web
endfunction

function Rubick_SpellSteal_Init takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function A2G))
	set t=null
	call BKG()
endfunction

function BMG takes nothing returns nothing
	if IsUnitBADWithSpellbooks(GetEnumUnit())then
		return
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A27N')>0 then//A27N -> Null Field Level 1
		call UnitRemoveAbility(GetEnumUnit(),'A27N')//A27N -> Null Field Level 1
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A27O')>0 then//A27O -> Null Field Level 2
		call UnitRemoveAbility(GetEnumUnit(),'A27O')//A27O -> Null Field Level 2
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A27M')>0 then//A27M -> Null Field Level 3
		call UnitRemoveAbility(GetEnumUnit(),'A27M')//A27M -> Null Field Level 3
	endif
	if GetUnitAbilityLevel(GetEnumUnit(),'A27P')>0 then//A27P -> Null Field Level 4
		call UnitRemoveAbility(GetEnumUnit(),'A27P')//A27P -> Null Field Level 4
	endif
endfunction

function BNG takes nothing returns nothing
	if IsUnitBADWithSpellbooks(GetEnumUnit())then
		return
	endif
	if OQ8==1 then
		if GetUnitAbilityLevel(GetEnumUnit(),'A27N')==0 then//A27N -> Null Field Level 1
			call UnitAddAbility2(GetEnumUnit(),'A27N')//A27N -> Null Field Level 1
		endif
	elseif OQ8==2 then
		if GetUnitAbilityLevel(GetEnumUnit(),'A27O')==0 then//A27O -> Null Field Level 2
			call UnitRemoveAbility(GetEnumUnit(),'A27N')//A27N -> Null Field Level 1
			call UnitAddAbility2(GetEnumUnit(),'A27O')//A27O -> Null Field Level 2
		endif
	elseif OQ8==3 then
		if GetUnitAbilityLevel(GetEnumUnit(),'A27M')==0 then//A27M -> Null Field Level 3
			call UnitRemoveAbility(GetEnumUnit(),'A27N')//A27N -> Null Field Level 1
			call UnitRemoveAbility(GetEnumUnit(),'A27O')//A27O -> Null Field Level 2
			call UnitAddAbility2(GetEnumUnit(),'A27M')//A27M -> Null Field Level 3
		endif
	elseif OQ8==4 then
		if GetUnitAbilityLevel(GetEnumUnit(),'A27P')==0 then//A27P -> Null Field Level 4
			call UnitRemoveAbility(GetEnumUnit(),'A27N')//A27N -> Null Field Level 1
			call UnitRemoveAbility(GetEnumUnit(),'A27O')//A27O -> Null Field Level 2
			call UnitRemoveAbility(GetEnumUnit(),'A27M')//A27M -> Null Field Level 3
			call UnitAddAbility2(GetEnumUnit(),'A27P')//A27P -> Null Field Level 4
		endif
	endif
endfunction

function BOG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local group GGF=(LoadGroupHandle(HY,h,340))
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local group g=GetAvailableGroup()
	if Source==null or GetUnitTypeId(Source)!='E02X' then//E02X -> Grand Magus
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call ForGroup(GGF,function BMG)
		call KillGroup(GGF)
		call KillGroup(g)
		return false
	endif
	set tt_unit1=Source
	set OQ8=GetUnitAbilityLevel(Source,'P211')
	if IsDead(Source)==false then
		call GroupEnumUnitsInRange(g,x,y,925,Condition(function DefaultAllyFilter))
	endif
	call GroupRemoveGroup(g,GGF)
	call ForGroup(GGF,function BMG)
	if IsDead(Source)==false and GetUnitAbilityLevel(Source,'A36D')==0 then
		call ForGroup(g,function BNG)
	endif
	call SaveGroupHandle(HY,h,340,(g))
	call KillGroup(GGF)
	set t=null
	set Source=null
	set GGF=null
	set g=null
	return false
endfunction

function Rubick_NullField_Learn takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	call TriggerRegisterTimerEvent(t,.3,true)
	call TriggerAddCondition(t,Condition(function BOG))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveGroupHandle(HY,h,340,(GetAvailableGroup()))
	set t=null
	set Source=null
endfunction

function Exorcism_MoveDummy takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit hero=LoadUnitHandle(HY,h,1)
	local unit d=LoadUnitHandle(HY,h,0)
	local real lastlife=LoadReal(HY,h,0)
	local integer c=LoadInteger(HY,h,0)+1
	if IsDead(hero) and LoadBoolean(HY,h,0)==false then
		call SaveBoolean(HY,h,0,true)
	endif
	if LoadBoolean(HY,h,0)==false then
		call SetUnitPosition(d,GetUnitX(hero),GetUnitY(hero))
		if GetWidgetLife(d)>lastlife then
			call SetWidgetLife(hero,GetWidgetLife(hero)+(GetWidgetLife(d)-lastlife))
			call SaveReal(HY,h,0,GetWidgetLife(d))
		endif
	endif
	if c>50*50 or IsDead(hero) or IsDead(d) then
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
		call KillUnit(d)
	else
		call SaveInteger(HY,h,0,c)
	endif
	set d=null
	set hero=null
	set t=null
endfunction

function Banshee_Exorcism takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local unit d=CreateUnit(GetOwningPlayer(u),'e01V',GetUnitX(u),GetUnitY(u),0)//e01V -> Spellcaster #3
	local timer t=CreateTimer()
	call KillUnit(LoadUnitHandle(HY,GetHandleId(u),'EXOR'))
	call UnitAddAbility2(d,'A44C')
	call SetUnitAbilityLevel(d,'A44C',GetUnitAbilityLevel(u,GetSpellAbilityId()))
	call IssueImmediateOrder(d,"locustswarm")
	call SetWidgetLife(d,1)
	call TimerStart(t,0.02,true,function Exorcism_MoveDummy)
	call SaveUnitHandle(HY,GetHandleId(t),0,d)
	call SaveUnitHandle(HY,GetHandleId(t),1,u)
	call SaveReal(HY,GetHandleId(t),0,1)
	call SaveUnitHandle(HY,GetHandleId(u),'EXOR',d)
	set t=null
	set u=null
	set d=null
endfunction

function Banshee_CarrionSwarm takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetUnitFacing(GetTriggerUnit()))
	call UnitAddAbility(d,'A3II')
	call SetUnitAbilityLevel(d,'A3II',GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
	if GetSpellTargetUnit()==GetTriggerUnit() then
		call DummyWave(d,"carrionswarm",GetUnitX(GetTriggerUnit())+1*Cos(bj_DEGTORAD*GetUnitFacing(GetTriggerUnit())),GetUnitY(GetTriggerUnit())+1*Sin(bj_DEGTORAD*GetUnitFacing(GetTriggerUnit())))
	else
		call DummyWave(d,"carrionswarm",GetSpellTargetX(),GetSpellTargetY())
	endif
	//call IssuePointOrder(d,"carrionswarm",GetSpellTargetX(),GetSpellTargetY())
	set d=null
endfunction

function WitchcraftSafetyCDDrop takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer id=LoadInteger(HY,h,0)
	local timer tt=LoadTimerHandle(HY,h,0)
	if GetTriggerEventId()!=EVENT_GAME_TIMER_EXPIRED or LoadBoolean(HY,h,0) then
		call ResetCooldownForAbility(u,id)
		call TextTagOnUnit("WITCHCRAFT!!",3.5,u,.03,255,0,0,255)
	endif
	call DestroyTimer(tt)
	call FlushChildHashtable(HY,h)
	call DestroyTrigger(t)
	set tt=null
	set t=null
endfunction

function WitchcraftSafetyCD takes unit u, integer id returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local timer tt=CreateTimer()
	call TimerStart(tt,10,false,null)
	call SaveBoolean(HY,h,0,true)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerRegisterTimerExpireEvent(t,tt)
	call SaveTimerHandle(HY,h,10,tt)
	call TriggerAddCondition(t,Condition(function WitchcraftSafetyCDDrop))
	call SaveUnitHandle(HY,h,0,u)
	call SaveInteger(HY,h,0,id)
	set t=null
	set tt=null
endfunction

function Krobelus_Witchcraft_Check takes nothing returns nothing
	local integer chance
	local unit u
	local integer id=GetSpellAbilityId()
	if GetUnitAbilityLevel(GetTriggerUnit(),'A02C')!=0 and GetCooldown(id,GetUnitAbilityLevel(GetTriggerUnit(),id))>1 then
		set u=GetTriggerUnit()
		if LoadBoolean(CooldownStorage,-id,1) then
			set chance=GetUnitAbilityLevel(u,'A02C')*5-5
		else
			set chance=GetUnitAbilityLevel(u,'A02C')*5+5
		endif
		if chance>0 and CheckStacking(GetSkillIndex(id),-1,"mirrorimage",null)==false and IsMorphSkillId(id)==false then
			if PRD_Get(u,'A02C',chance) or IsL1ch then
				call WitchcraftSafetyCD(u,id)
			endif
		endif
		set u=null
	endif
endfunction

function StormModel_Death takes nothing returns nothing
	local unit u=GetTriggerUnit()
	if GetUnitTypeId(u)=='H00S' then//H00S -> Storm Spirit
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",u,"origin"))
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",u,"origin"))
	endif
	set u=null
endfunction

function BBG takes nothing returns nothing
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\ImmolationRed\\ImmolationRedDamage.mdl",GetEnumUnit(),"chest"))
	call DamageTarget(OR8,GetEnumUnit(),1,(20+10*OS8)/ 5)
endfunction

function BCG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer Level=LoadInteger(HY,h,0)
	local group g
	if (GetUnitAbilityLevel(Source,'B0FP')==0 and GetUnitAbilityLevel(Source,'B0FQ')==0) or (GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A2HS') then//B0FP -> Flame Guard, B0FQ -> Flame Guard
		call DestroyEffect(LoadEffectHandle(HY,h,32))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call UnitRemoveAbility(Source,'A2H7')//A2H7 -> Fire Barrier Container
		call UnitRemoveAbility(Source,'B0FO')//B0FO -> Fire Barrier
		call UnitRemoveAbility(Source,'A2IX')//A2IX -> Fire Barrier - Damage 1
		call UnitRemoveAbility(Source,'A2IW')//A2IW -> Fire Barrier - Damage 2
		call UnitRemoveAbility(Source,'A2IV')//A2IV -> Fire Barrier - Damage 3
		call UnitRemoveAbility(Source,'A2IY')//A2IY -> Fire Barrier - Damage 4
	else
		set tt_unit1=Source
		set OR8=Source
		set OS8=Level
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),400+25,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
		call ForGroup(g,function BBG)
		call KillGroup(g)
	endif
	set g=null
	set t=null
	set Source=null
	return false
endfunction

function Xin_FlameGuard takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)//e00E -> Spellcaster
	local integer Level=GetUnitAbilityLevel(Source,'A2HS')//A2HS -> Flame Guard
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call UnitAddAbility(Caster,'A2H5')//A2H5 -> Fire Barrier
	call SetUnitAbilityLevel(Caster,'A2H5',Level)//A2H5 -> Fire Barrier
	call IssueTargetOrderById(Caster,852186,Source)
	call TriggerRegisterTimerEvent(t,.2,true)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	call TriggerAddCondition(t,Condition(function BCG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\FlameGuard.mdx",Source,"origin"))
	set Source=null
	set Caster=null
	set t=null
endfunction

function SoF_HexDispelling takes unit Source returns nothing
	call UnitRemoveAbility(Source,'BOhx')//BOhx -> Hex
	call UnitRemoveAbility(Source,'B00H')
endfunction

function SoF_CustomBuffRemoval takes unit Source returns nothing
	call UnitRemoveAbility(Source,'A2H9')//A2H9 -> Slight of Fist Container - AS
	call UnitRemoveAbility(Source,'B0FM')//B0FM -> Sleight of Fist
endfunction

function SoF_BonusDmgRemoval takes unit Source returns nothing
	call UnitRemoveAbility(Source,'A2JH')//A2JH -> Slight of Fist Hero Damage Bonus - 1
	call UnitRemoveAbility(Source,'A2JG')//A2JG -> Slight of Fist Hero Damage Bonus - 2
	call UnitRemoveAbility(Source,'A2JJ')//A2JJ -> Slight of Fist Hero Damage Bonus - 3
	call UnitRemoveAbility(Source,'A2JI')//A2JI -> Slight of Fist Hero Damage Bonus - 4
	call UnitRemoveAbility(Source,'B0FL')
endfunction

function SleithOfFistGrow takes unit Source returns nothing
	local integer pid=GetPlayerId(GetOwningPlayer(Source))
	local boolean isranged
	local integer lvl
	if GetUnitAbilityLevel(Source,'A0CY')>0 then//A0CY -> Grow, QP1K -> Grow
		set isranged=IsRangedUnit(Source,pid*PlayerSkillOffset)
		if GetUnitAbilityLevel(Source,'A0CY')>0 then//A0CY -> Grow
			set lvl=GetUnitAbilityLevel(Source,'A0CY')//A0CY -> Grow
		endif
		if isranged==false then
			call UnitAddAbility2(Source,'QF90'-1+lvl)
		else
			call UnitAddAbility2(Source,'QF92'+lvl)
		endif
	endif
	
endfunction

function B5G takes unit Source returns nothing
	call UnitAddAbility2(Source,'A2H9')//A2H9 -> Slight of Fist Container - AS
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2H9',false)//A2H9 -> Slight of Fist Container - AS
endfunction

function B2G takes unit Source, integer Level returns nothing
	if Level<1 then
		return
	endif
	if Level==1 then
		call UnitAddAbility2(Source,'A2JH')//A2JH -> Slight of Fist Hero Damage Bonus - 1
	elseif Level==2 then
		call UnitAddAbility2(Source,'A2JG')//A2JG -> Slight of Fist Hero Damage Bonus - 2
	elseif Level==3 then
		call UnitAddAbility2(Source,'A2JJ')//A2JJ -> Slight of Fist Hero Damage Bonus - 3
	else
		call UnitAddAbility2(Source,'A2JI')//A2JI -> Slight of Fist Hero Damage Bonus - 4
	endif
endfunction

function SleightOfFistCheck takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit xin=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	local group g=LoadGroupHandle(HY,h,2)
	local group gg=LoadGroupHandle(HY,h,3)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		if GetEventDamageSource()==xin and IsFakeDamage<1 then
			call GroupAddUnit(g,target)
			call GroupRemoveUnit(gg,target)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		endif
	else
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set xin=null
	set target=null
	set t=null
endfunction

function SoF_Jumping takes unit xin,unit target, integer lvl returns nothing
	local real a=GetRandomReal(0,360)
	local real x=GetUnitX(target)+50*Cos(a*bj_DEGTORAD)
	local real y=GetUnitY(target)+50*Sin(a*bj_DEGTORAD)
	local trigger t
	local integer h
	call SetUnitPosition(xin,x,y)
	call SetUnitFacing(xin,bj_RADTODEG*Atan2(GetUnitY(target)-GetUnitY(xin),GetUnitX(target)-GetUnitX(xin)))
	call SetUnitAnimation(xin,"Attack")
	call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\Fire_Blink_2.mdx",xin,"chest"))
	call SoF_BonusDmgRemoval(xin)
	if IsUnitType(target,UNIT_TYPE_HERO) or IsUnitIllusion(target) then
		call B2G(xin,lvl)
		call UnitRemoveAbility(xin,'A2JF')//A2JF -> Slight of Fist creep atttack
		if Mode_BO==false then
			if(GetUnitAbilityLevel(xin,'A1J2')>0) then//A1J2 -> Jinada Critical - 1
				call SetUnitAbilityLevel(xin,'A1J2',2)//A1J2 -> Jinada Critical - 1
			elseif(GetUnitAbilityLevel(xin,'A1IT')>0) then//A1IT -> Jinada Critical - 2
				call SetUnitAbilityLevel(xin,'A1IT',2)//A1IT -> Jinada Critical - 2
			elseif(GetUnitAbilityLevel(xin,'A1J1')>0) then//A1J1 -> Jinada Critical - 3
				call SetUnitAbilityLevel(xin,'A1J1',2)//A1J1 -> Jinada Critical - 3
			elseif(GetUnitAbilityLevel(xin,'A1J0')>0) then//A1J0 -> Jinada Critical - 4
				call SetUnitAbilityLevel(xin,'A1J0',2)//A1J0 -> Jinada Critical - 4
			endif
		endif
	else
		call UnitAddAbility2(xin,'A2JF')//A2JF -> Slight of Fist creep atttack
		call SetPlayerAbilityAvailable2(GetOwningPlayer(xin),'A2JF',false)//A2JF -> Slight of Fist creep atttack
	endif
	if IssueTargetOrder(xin,"attack",target)then
		set t=CreateTrigger()
		call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
		call TriggerRegisterTimerEvent(t,0.2,false)
		call TriggerAddCondition(t,Condition(function SleightOfFistCheck))
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,0,xin)
		call SaveUnitHandle(HY,h,1,target)
		call SaveGroupHandle(HY,h,2,LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),187))
		call SaveGroupHandle(HY,h,3,LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),22))
		set t=null
	else
		call GroupAddUnit(LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),187),target)
		call GroupRemoveUnit(LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),22),target)
	endif
	//call IssueTargetOrderById(xin,ORDER_attack,target)
endfunction

function SoF_RemoveDisables takes unit u returns nothing
	call PurgeEntangles(u)
//	call UnitRemoveAbility(u,'B0C1')//B0C1 -> Entangling Roots
//	call UnitRemoveAbility(u,'BEer')//BEer -> Entangling Roots
//	call UnitRemoveAbility(u,'Beng')//Beng -> Ensnare
//	call UnitRemoveAbility(u,'Bena')//Bena -> Ensnare
//	call UnitRemoveAbility(u,'B017')//B017 -> Frostbite
//	call UnitRemoveAbility(u,'B078')//B078 -> Earthbind
//	call UnitRemoveAbility(u,'B08F')//B08F -> Pit of Malice
//	call UnitRemoveAbility(u,'B08E')//B08E -> Pit of Malice
//	call UnitRemoveAbility(u,'B0ER')//B0ER -> Overgrowth
//	call UnitRemoveAbility(u,'B0FN')//B0FN -> Searing Chains
endfunction

function C7G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local real x=LoadReal(HY,h,6)
	local real y=LoadReal(HY,h,7)
	local real SourceX=LoadReal(HY,h,189)
	local real SourceY=LoadReal(HY,h,190)
	local group AlreadyHit=LoadGroupHandle(HY,h,187)
	local group g=LoadGroupHandle(HY,h,22)
	local unit Target=null
	local boolean found=false
	local fogmodifier fm=LoadFogModifierHandle(HY,h,42)
	local integer Level=LoadInteger(HY,h,0)// GetUnitAbilityLevel(Source,'A2H0')//A2H0 -> Sleight of Fist
	local trigger tt
	local boolean end=false
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		set end=true
	endif
//	if Level<1 then
//		set Level=GetUnitAbilityLevel(Source,'QB0L')//QB0L -> Sleight of Fist
//	endif
	loop
		exitwhen FirstOfGroup(g)==null or found
		set Target=FirstOfGroup(g)
		call GroupRemoveUnit(g,Target)
		if IsDead(Target) then
			call GroupRemoveUnit(g,Target)
		elseif IsUnitInGroup(Target,AlreadyHit)and Target!=null then
			set Target=null
			set found=false
		else
			set found=true
		endif
	endloop
	
	call SetUnitPathing(Source,false)
	call SetUnitInvulnerable(Source,true)
	call SoF_RemoveDisables(Source)
	if end or not found or (LoadInteger(HY,GetHandleId(Source),4319))==1 then
		call SaveInteger(HY,GetHandleId(Source),4318,2)
		call SoF_CustomBuffRemoval(Source)
		call UnitRemoveAbility(Source,'QF90')
		call UnitRemoveAbility(Source,'QF91')
		call UnitRemoveAbility(Source,'QF92')
		call UnitRemoveAbility(Source,'QF93')
		call UnitRemoveAbility(Source,'QF94')
		call UnitRemoveAbility(Source,'QF95')
		call UnitRemoveAbility(Source,'A2JF')//A2JF -> Slight of Fist creep atttack
		call SoF_BonusDmgRemoval(Source)
		call SoF_RemoveDisables(Source)
		call SoF_HexDispelling(Source)
		call UnitAddAbility(Source,'A2H2')//A2H2 -> Slight of Fist Out
		call UnitRemoveAbility(Source,'A2H2')//A2H2 -> Slight of Fist Out
		call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A1UL',true)//A1UL -> Walrus Critical 1
		call UnMorphUnit(Source,LoadInteger(HY,h,25))
		call RemoveAbilsForUnit(Source)
		call SoF_RemoveDisables(Source)
		if((LoadInteger(HY,(GetHandleId((Source))),(4319)))==1)==false then
			call SetUnitX(Source,SourceX)
			call SetUnitY(Source,SourceY)
		endif
		call RestoreTint(Source)
		call SetTint(Source,-1,-1,-1,255)
		call SetUnitPathing(Source,true)
		call SetUnitInvulnerable(Source,false)
		if GetUnitAbilityLevel(Source,'A0MQ')+GetUnitAbilityLevel(Source,'A1B6')>0 then//A0MQ -> Primal Split, A1B6 -> Primal Split upgrade
			call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A0MQ',true)//A0MQ -> Primal Split
			call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A1B6',true)//A1B6 -> Primal Split upgrade
		endif
		call SetUnitTimeScale(Source,1)
		call KillGroup(AlreadyHit)
		call KillGroup(g)
		call RemoveUnit((LoadUnitHandle(HY,h,19)))
		call FogModifierStop(fm)
		call DestroyFogModifier(fm)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		call GroupAddUnit(AlreadyHit,Target)
		call SoF_Jumping(Source,Target,Level)
	endif
	set fm=null
	set t=null
	set Source=null
	set Target=null
	set g=null
	set tt=null
	set AlreadyHit=null
	return false
endfunction

function Xin_SleightOfFist takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,0)
	local real x=LoadReal(HY,h,1)
	local real y=LoadReal(HY,h,2)
	local integer Level=LoadInteger(HY,h,0)
	local trigger tt=CreateTrigger()
	local integer th=GetHandleId(tt)
	local fogmodifier fm=CreateFogModifierRadius(GetOwningPlayer(Source),FOG_OF_WAR_VISIBLE,x,y,600,true,true)
	local unit Caster=CreateUnit(GetOwningPlayer(Source),'h0E7',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))//h0E7 -> Fire Panda Dummy
	local group g=GetAvailableGroup()
	local integer id=W28(GetUnitTypeId(Source))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	if Mode_BO==false then
		call SleithOfFistGrow(Source)
	endif
//	call UnitRemoveAbility(Source,'B01N')//B01N -> Decrepify
//	call UnitRemoveAbility(Source,'Aetl')//Aetl -> Ethereal
	call SetUnitVertexColor(Caster,255,255,255,100)
	call FogModifierStart(fm)
	call SaveInteger(HY,GetHandleId(Source),4318,1)
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,150+100*Level+25,Condition(function LZ8))
	call SoF_RemoveDisables(Source)
	call SoF_HexDispelling(Source)
	if GetUnitAbilityLevel(Source,'A0MQ')+GetUnitAbilityLevel(Source,'A1B6')>0 then//ban primal split, else - spirits + hero comeback together (bug-abuse)//A0MQ -> Primal Split, A1B6 -> Primal Split upgrade
		call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A0MQ',false)//A0MQ -> Primal Split
		call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A1B6',false)//A1B6 -> Primal Split upgrade
	endif
	call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A1UL',false)//A1UL -> Walrus Critical 1
	call SaveInteger(HY,th,25,MorphUnit(Source)+1)
	call UnitAddAbility(Source,'A2H1')//A2H1 -> Slight of Fist In
	call UnitRemoveAbility(Source,'A2H1')//A2H1 -> Slight of Fist In
	call RemoveAbilsForUnit(Source)
	call SetTint(Source,-1,-1,-1,125)
	call SetUnitPathing(Source,false)
	call SetUnitInvulnerable(Source,true)
	call SetUnitTimeScale(Source,3)
	call TriggerRegisterTimerEvent(tt,.2,true)
	call TriggerRegisterDeathEvent(tt,Source)
	call TriggerAddCondition(tt,Condition(function C7G))
	call SaveUnitHandle(HY,th,2,Source)
	call SaveInteger(HY,th,0,Level)
	call SaveReal(HY,th,6,x*1.)
	call SaveReal(HY,th,7,y*1.)
	call SaveReal(HY,th,189,GetUnitX(Source)*1.)
	call SaveReal(HY,th,190,GetUnitY(Source)*1.)
	call SaveGroupHandle(HY,th,187,GetAvailableGroup())
	call SaveGroupHandle(HY,th,22,g)
	call SaveFogModifierHandle(HY,th,42,fm)
	call SaveUnitHandle(HY,th,19,Caster)
	call B5G(Source)
	call TriggerEvaluate(tt)
	set Source=null
	set t=null
	set fm=null
	set Caster=null
	set g=null
	set tt=null
endfunction

function Xin_SleightOfFistWrap takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local integer lvl=GetUnitAbilityLevel(u,'A2H0')+GetUnitAbilityLevel(u,'QB0L')//A2H0 -> Sleight of Fist, QB0L -> Sleight of Fist
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,u)
	call SaveReal(HY,h,1,x)
	call SaveReal(HY,h,2,y)
	call SaveInteger(HY,h,0,lvl)
	call TimerStart(t,0,false,function Xin_SleightOfFist)
	set t=null
	set u=null
endfunction

function CDG takes nothing returns boolean
	local unit W39=GetSummonedUnit()
	if IsUnitIllusion(W39) and GetUnitTypeId(W39)=='N0MH' then//N0MH -> Ember Spirit
		call SoF_CustomBuffRemoval(W39)
		call UnitRemoveAbility(W39,'A2JF')//A2JF -> Slight of Fist creep atttack
		call SoF_BonusDmgRemoval(W39)
		call UnitAddAbility(W39,'A2H2')//A2H2 -> Slight of Fist Out
		call UnitRemoveAbility(W39,'A2H2')//A2H2 -> Slight of Fist Out
	endif
	set W39=null
	return false
endfunction

function SleightOfFistAbuseStop takes nothing returns nothing
	if GetUnitAbilityLevel(GetTriggerUnit(),'Aetl')>0 or GetUnitAbilityLevel(GetTriggerUnit(),'B01N')>0 or GetUnitAbilityLevel(GetTriggerUnit(),'B15V')>0 or GetUnitAbilityLevel(GetTriggerUnit(),'Abun')>0 or GetUnitAbilityLevel(GetTriggerUnit(),'B08Y')>0 then//Aetl -> Ethereal, B01N -> Decrepify, B15V -> Last Word, Abun -> Cargo Hold (Orc Burrow), B08Y -> Defeaning Blast
		call InterruptUnit(GetTriggerUnit())
		call Error(GetOwningPlayer(GetTriggerUnit()),"Cannot use this now.")
	endif
endfunction

function Xin_SleightOfFist_Illusions takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function CDG))
	set t=null
endfunction

function CEG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer Level=LoadInteger(HY,h,0)
	local integer RHE=2
	if Level>2 then
		set RHE=3
	endif
	if GetTriggerEvalCount(t)==RHE then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	call DamageTarget(Source,Target,1,20+20*Level)
	set t=null
	set Source=null
	set Target=null
	return false
endfunction

function CFG takes nothing returns nothing
	local unit Source=tt_unit1
	local unit Target=tt_unit2
	local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)//e00E -> Spellcaster
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer lvl=LoadInteger(HY,GetHandleId(GetTriggeringTrigger()),0)
	call UnitAddAbility(Caster,'A2H4')//A2H4 -> Searing Chains ensnare
	call IssueTargetOrderById(Caster,852106,Target)
	call TriggerAddCondition(t,Condition(function CEG))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	call SaveInteger(HY,h,0,lvl)
	call TriggerRegisterTimerEvent(t,0,false)
	call TriggerRegisterTimerEvent(t,1,true)
	set Caster=null
	set Source=null
	set Target=null
	set t=null
endfunction

function Xin_SearingChains takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local real x=GetUnitX(Source)
	local real y=GetUnitY(Source)
	local unit u1=null
	local unit u2=null
	local unit u3=null
	local integer AUD=0
	local unit u
	local trigger t
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,425,Condition(function NonImmuneVisibleEnemyFilter))
	loop
		exitwhen FirstOfGroup(g)==null or AUD==2
		set u=GroupPickRandomUnit(g)
		if u!=null then
			if AUD==0 then
				set u1=u
			elseif AUD==1 then
				set u2=u
			elseif AUD==2 then
				set u3=u
			endif
			set AUD=AUD+1
			call GroupRemoveUnit(g,u)
		endif
	endloop
	call KillGroup(g)
	if u1!=null then
		set t=AddProjectile(Source,u1,'h0E0',"CFG",9000,false)//h0E0 -> Fire Shackles Projectile
		call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	endif
	if u2!=null then
		set t=AddProjectile(Source,u2,'h0E0',"CFG",9000,false)//h0E0 -> Fire Shackles Projectile
		call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	endif
	if u3!=null then
		set t=AddProjectile(Source,u3,'h0E0',"CFG",9000,false)//h0E0 -> Fire Shackles Projectile
		call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
	endif
	set g=null
	set Source=null
	set u=null
	set u1=null
	set u2=null
	set u3=null
	set t=null
endfunction

function CIG takes nothing returns boolean
	local unit Source=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2))
	local integer h=GetHandleId(Source)
	local integer i=0
	local real UK8=(TimerGetElapsed(GlobalTimer))
	local integer CJG=(LoadInteger(HY,h,749))
	local real x
	local real y
	local real t
	loop
		exitwhen i>CJG
		set t=(LoadReal(HY,h,(10000+i)))
		if t+10>UK8 then
			set x=(LoadReal(HY,h,(11000+i)))
			set y=(LoadReal(HY,h,(12000+i)))
		endif
		set i=i+1
	endloop
	set Source=null
	return false
endfunction

function CKG takes integer h,integer CJG,real AO8,real AP8 returns boolean
	local real x
	local real y
	local real t
	local integer i=0
	local real UK8=(TimerGetElapsed(GlobalTimer))
	loop
		exitwhen i>CJG
		set t=(LoadReal(HY,h,(10000+i)))
		if t+10>UK8 then
			set x=(LoadReal(HY,h,(11000+i)))
			set y=(LoadReal(HY,h,(12000+i)))
			if DistanceBetweenXY(x,y,AO8,AP8)<75 then
				return true
			endif
		endif
		set i=i+1
	endloop
	return false
endfunction

function CMG takes integer h,integer CJG returns integer
	local real t
	local integer i=0
	local real UK8=(TimerGetElapsed(GlobalTimer))
	loop
		exitwhen i>CJG
		set t=(LoadReal(HY,h,(10000+i)))
		if t+10<UK8 then
			return i
		endif
		set i=i+1
	endloop
	return-1
endfunction

function CNG takes unit Source,integer COG,real x,real y returns nothing
	local integer h=GetHandleId(Source)
	local integer CJG=(LoadInteger(HY,h,749))
	local integer CPG
	if CKG(h,CJG,x,y)then
		return
	endif
	set CPG=CMG(h,CJG)
	if CPG==-1 then
		set CPG=CJG
		set CJG=CJG+1
		call SaveInteger(HY,h,749,(CJG))
	endif
	call SaveInteger(HY,h,13000,(COG))
	call SaveReal(HY,h,10000,(((TimerGetElapsed(GlobalTimer)))*1.))
	call SaveReal(HY,h,11000,((x)*1.))
	call SaveReal(HY,h,11000,((y)*1.))
endfunction

function CQG takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddCondition(t,Condition(function CIG))
	call SaveUnitHandle(HY,h,2,(Source))
	set Source=null
	set t=null
endfunction

function CRG takes nothing returns nothing
	call DamageTarget(OU8,GetEnumUnit(),1,50+OT8*50)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\LordofFlameMissile\\LordofFlameMissile.mdl",GetEnumUnit(),"origin"))
endfunction

function CSG takes unit Source,unit S4E,real x,real y returns nothing
	local group g
	call KillUnit(S4E)
	call ZD8("war3mapImported\\Firaga_2.mdx",x,y,2)
	set g=GetAvailableGroup()
	set tt_unit1=Source
	set OU8=Source
	set OT8=GetUnitAbilityLevel(Source,'A2JK')//A2JK -> Fire Remnant
	call GroupEnumUnitsInRange(g,x,y,450+25,Condition(function DefaultEnemyFilterWithAncientsNonImmune))
	call UnitRemoveAbility(Source,'A04R')//
	call ForGroup(g,function CRG)
	call UnitAddAbility2(Source,'A04R')//
	call KillGroup(g)
	set g=null
endfunction

function CTG takes unit Source,unit CUG returns nothing
	local integer h=GetHandleId(Source)
	local integer CVG=(LoadInteger(HY,h,746))
	local unit CWG
	local integer i=1
	local integer x
	loop
		exitwhen i>CVG
		set CWG=(LoadUnitHandle(HY,h,(1450+i)))
		if CWG==CUG then
			set CVG=CVG-1
			call SaveUnitHandle(HY,h,(1450+i),((LoadUnitHandle(HY,h,(1450+i+1)))))
			call SaveInteger(HY,h,746,(CVG))
			set x=i+1
			loop
				exitwhen x>CVG
				call SaveUnitHandle(HY,h,(1450+x),((LoadUnitHandle(HY,h,(1450+x+1)))))
				set x=x+1
			endloop
		endif
		set i=i+1
	endloop
	set CWG=null
endfunction

function CXG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit S4E=(LoadUnitHandle(HY,h,19))
	local real NHE=GetUnitX(S4E)
	local real NIE=GetUnitY(S4E)
	local real TargetX=(LoadReal(HY,h,47))
	local real TargetY=(LoadReal(HY,h,48))
	local real a=AngleBetweenXY(NHE,NIE,TargetX,TargetY)*bj_DEGTORAD
	local real AO8
	local real AP8
	local real d=DistanceBetweenXY(NHE,NIE,TargetX,TargetY)
	local real rate=GetUnitMoveSpeedLOD(Source)*2.5*.02
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call CTG(Source,S4E)
		call DestroyEffect((LoadEffectHandle(HY,h,175)))
		call DestroyEffect((LoadEffectHandle(HY,h,176)))
		call DestroyEffect((LoadEffectHandle(HY,h,177)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif d<2 then
		call SetUnitAnimationByIndex(S4E,1)
	else
		if d<rate then
			set AO8=TargetX
			set AP8=TargetY
		else
			set AO8=NHE+rate*Cos(a)
			set AP8=NIE+rate*Sin(a)
		endif
		call SetUnitX(S4E,AO8)
		call SetUnitY(S4E,AP8)
	endif
	set t=null
	set Source=null
	set S4E=null
	return false
endfunction

function CYG takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real a=AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),GetSpellTargetX(),GetSpellTargetY())*bj_DEGTORAD
	local integer h=GetHandleId(Source)
	local integer CVG=(LoadInteger(HY,h,746))
	local integer Level=GetUnitAbilityLevel(Source,'A2JK')//A2JK -> Fire Remnant
	local unit d=CreateUnit(GetOwningPlayer(Source),'h0E8',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)//h0E8 -> Fire Remnant
	local trigger t
	local integer i=1
	set CVG=CVG+1
	call SaveUnitHandle(HY,h,(1450+CVG),(d))
	call SaveInteger(HY,h,746,(CVG))
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call SetUnitVertexColor(d,255,255,255,75)
	call SetUnitTimeScale(d,2)
	call SetUnitAnimationByIndex(d,0)
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerAddCondition(t,Condition(function CXG))
	call TriggerRegisterDeathEvent(t,d)
	call UnitApplyTimedLife(d,'BTLF',45)
	call SaveEffectHandle(HY,h,175,(AddSpecialEffectTarget("war3mapImported\\Phoenix_Missile_smaller.mdx",d,"hand right alternate")))
	call SaveEffectHandle(HY,h,176,(AddSpecialEffectTarget("war3mapImported\\Phoenix_Missile_smaller.mdx",d,"hand left alternate")))
	call SaveEffectHandle(HY,h,177,(AddSpecialEffectTarget("war3mapImported\\FlameDash_Ground.mdx",d,"origin")))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,19,(d))
	call SaveReal(HY,h,47,SafeX50((GetSpellTargetX())*1.))
	call SaveReal(HY,h,48,SafeY50((GetSpellTargetY())*1.))
	set Source=null
	set t=null
	set d=null
endfunction

function Xin_FireRemnants takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local integer HTD=(LoadInteger(HY,(GetHandleId(Source)),747))
	if HTD>0 then
		call CYG()
		call UnitRemoveAbility(Source,OZ8[HTD])
		set HTD=HTD-1
		call SaveInteger(HY,(GetHandleId(Source)),747,(HTD))
		call UnitAddAbility2(Source,OZ8[HTD])
	else
		call Error(GetOwningPlayer(GetTriggerUnit()),"No more charges")
	endif
	set Source=null
endfunction

function CBG takes nothing returns boolean
	return GetUnitTypeId(GetFilterUnit())=='h0E8'//h0E8 -> Fire Remnant
endfunction

function CCG takes nothing returns nothing
	local real YR8=DistanceBetweenXY(GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),OV8,OW8)
	if YR8>OX8 and IsDead(GetEnumUnit())==false then
		set OY8=GetEnumUnit()
		set OX8=YR8
	endif
endfunction

function C3G takes unit Source,real x,real y returns unit
	local group g=GetAvailableGroup()
	set OY8=null
	set OX8=-1
	set OV8=x
	set OW8=y
	call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(Source),Condition(function CBG))
	call ForGroup(g,function CCG)
	call KillGroup(g)
	set g=null
	return OY8
endfunction

function C6G takes unit u1,unit u2 returns real
	local real TAE=DistanceBetweenUnits(u1,u2)
	local real time=TAE/ 1300.
	if time>.4 then
		return TAE/.4
	endif
	return 1300.
endfunction

function CLG takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real I1G=(LoadReal(HY,h,47))
	local real I0G=(LoadReal(HY,h,48))
	local unit S4E=(LoadUnitHandle(HY,h,19))
	local real NHE=GetUnitX(Source)
	local real NIE=GetUnitY(Source)
	local real TargetX=(LoadReal(HY,h,6))
	local real TargetY=(LoadReal(HY,h,7))
	local real a
	local real AO8
	local real AP8
	local real d
	local real AJ8=(LoadReal(HY,h,44))
	local real rate=AJ8*.02
	local group g
	local integer Count=(LoadInteger(HY,h,34))
	if S4E!=null then
		set TargetX=GetUnitX(S4E)
		set TargetY=GetUnitY(S4E)
		call SaveReal(HY,h,6,((TargetX)*1.))
		call SaveReal(HY,h,7,((TargetY)*1.))
	endif
	set a=AngleBetweenXY(NHE,NIE,TargetX,TargetY)*bj_DEGTORAD
	set d=DistanceBetweenXY(NHE,NIE,TargetX,TargetY)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SaveInteger(HY,GetHandleId(Source),4319,2)
		call RestoreTint(Source)
		call SetTint(Source,-1,-1,-1,255)
		call SetUnitTimeScale(Source,1)
		call SetUnitAnimationByIndex(Source,0)
		call SetUnitPathing(Source,true)
		call SetUnitInvulnerable(Source,false)
		call UnitRemoveAbility(Source,'A04R')//
		call DestroyEffect((LoadEffectHandle(HY,h,175)))
		call DestroyEffect((LoadEffectHandle(HY,h,176)))
		call DestroyEffect((LoadEffectHandle(HY,h,177)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif d<rate then
		call SetUnitX(Source,TargetX)
		call SetUnitY(Source,(TargetY))
		call KillTrees(TargetX,TargetY,100)
		call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
		call CSG(Source,S4E,TargetX,TargetY)
		set S4E=C3G(Source,I1G,I0G)
		if S4E==null then
			call SaveInteger(HY,GetHandleId(Source),4319,2)
			call RestoreTint(Source)
			call SetTint(Source,-1,-1,-1,255)
			call SetUnitTimeScale(Source,1)
			call SetUnitAnimationByIndex(Source,1)
			call SetUnitPathing(Source,true)
			call SetUnitInvulnerable(Source,false)
			call UnitRemoveAbility(Source,'A04R')//
			call DestroyEffect((LoadEffectHandle(HY,h,175)))
			call DestroyEffect((LoadEffectHandle(HY,h,176)))
			call DestroyEffect((LoadEffectHandle(HY,h,177)))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		else
			call SaveInteger(HY,h,34,(Count+1))
			call SaveUnitHandle(HY,h,19,(S4E))
			call SaveReal(HY,h,44,((C6G(Source,S4E))*1.))
			call SaveReal(HY,h,6,((GetUnitX(S4E))*1.))
			call SaveReal(HY,h,7,((GetUnitY(S4E))*1.))
		endif
	else
		call SetUnitAnimationByIndex(Source,0)
		call SetUnitPathing(Source,false)
		set AO8=NHE+rate*Cos(a)
		set AP8=NIE+rate*Sin(a)
		if IsUnitType(Source,UNIT_TYPE_HERO)then
			call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
		endif
		call SetUnitX(Source,(AO8))
		call SetUnitY(Source,AP8)
		call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
		call KillTrees(AO8,AP8,100)
		call SetUnitFacing(Source,a*bj_RADTODEG)
	endif
	call CNG(Source,Count,GetUnitX(Source),GetUnitY(Source))
	set t=null
	set Source=null
	set S4E=null
	set g=null
	return false
endfunction

function C1G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+150)
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function Xin_FireRemnantsB takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t
	local integer h=GetHandleId(Source)
	local integer CVG=(LoadInteger(HY,h,746))
	local unit S4E
	if CVG>0 and LoadInteger(HY,GetHandleId(Source),4319)!=1 then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SetTint(Source,255,0,0,75)
		call SetUnitTimeScale(Source,2)
		call SetUnitAnimationByIndex(Source,0)
		call SetUnitPathing(Source,false)
		call SetUnitInvulnerable(Source,true)
		call UnitAddAbility2(Source,'A04R')//
		call SaveInteger(HY,GetHandleId(Source),4319,1)
		call TriggerRegisterTimerEvent(t,.02,true)
		call TriggerAddCondition(t,Condition(function CLG))
		call TriggerRegisterDeathEvent(t,Source)
		call SaveEffectHandle(HY,h,175,(AddSpecialEffectTarget("war3mapImported\\Phoenix_Missile_smaller.mdx",Source,"hand right alternate")))
		call SaveEffectHandle(HY,h,176,(AddSpecialEffectTarget("war3mapImported\\Phoenix_Missile_smaller.mdx",Source,"hand left alternate")))
		call SaveEffectHandle(HY,h,177,(AddSpecialEffectTarget("war3mapImported\\FlameDash_Ground.mdx",Source,"origin")))
		call SaveUnitHandle(HY,h,2,(Source))
		call SaveReal(HY,h,47,((GetSpellTargetX())*1.))
		call SaveReal(HY,h,48,((GetSpellTargetY())*1.))
		set S4E=C3G(Source,GetSpellTargetX(),GetSpellTargetY())
		call SaveUnitHandle(HY,h,19,(S4E))
		call SaveReal(HY,h,44,((C6G(Source,S4E))*1.))
		call SaveReal(HY,h,6,((GetUnitX(S4E))*1.))
		call SaveReal(HY,h,7,((GetUnitY(S4E))*1.))
		call SaveInteger(HY,h,34,1)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,.0,false)
		call TriggerAddCondition(t,Condition(function C1G))
		call SaveUnitHandle(HY,h,2,(Source))
	endif
	set t=null
	set Source=null
	set S4E=null
endfunction

function C2G takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer HTD=(LoadInteger(HY,(GetHandleId(Source)),747))
	local integer Count=(LoadInteger(HY,h,34))
	if HTD<3 then
		set Count=Count-1
		call SaveInteger(HY,h,34,(Count))
		if Count==0 then
			call UnitRemoveAbility(Source,OZ8[HTD])
			set Count=35
			call SaveInteger(HY,h,34,(Count))
			set HTD=HTD+1
			call SaveInteger(HY,(GetHandleId(Source)),747,(HTD))
			call UnitAddAbility2(Source,OZ8[HTD])
		endif
	endif
	set t=null
	set Source=null
	return false
endfunction

function L4G takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call SaveInteger(HY,(GetHandleId(Source)),747,3)
	call UnitAddAbility2(Source,OZ8[3])
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function C2G))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveInteger(HY,h,34,30)
	set Source=null
	set t=null
endfunction

function Xin_FireRemnants_Learn takes nothing returns nothing
	call UnitAddAbility2(GetTriggerUnit(),'A2JL')//A2JL -> Fire Remnant
	call SetUnitAbilityLevel(GetTriggerUnit(),'A2JL',GetUnitAbilityLevel(GetTriggerUnit(),'A2JK'))//A2JL -> Fire Remnant, A2JK -> Fire Remnant
	if GetUnitAbilityLevel(GetTriggerUnit(),'A2JK')==1 then//A2JK -> Fire Remnant
		call L4G()
		call CQG()
	endif
endfunction

function Xin_FireRemnantes_Init takes nothing returns nothing
	set OZ8[0]='A2JO'//A2JO -> Fire Remnant
	set OZ8[1]='A2JQ'//A2JQ -> Fire Remnant
	set OZ8[2]='A2JP'//A2JP -> Fire Remnant
	set OZ8[3]='A2JR'//A2JR -> Fire Remnant
endfunction



function DFH takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local integer CG8=(LoadInteger(HY,h,59))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call UnitRemoveAbility(Source,CG8)
	call UnitRemoveAbility(Source,'B0FJ')//B0FJ -> Moment of Courage
	call UnitRemoveAbility(Source,'B0FK')//B0FK -> Moment of Courage
	set t=null
	set Source=null
	return false
endfunction

function Legion_MoC_Remove takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
	call UnitRemoveAbility(u,'A2GD')//A2GD -> Moment of Courage Container - 1
	call UnitRemoveAbility(u,'A2GE')//A2GE -> Moment of Courage Container - 2
	call UnitRemoveAbility(u,'A2GF')//A2GF -> Moment of Courage Container - 3
	call UnitRemoveAbility(u,'A2GC')//A2GC -> Moment of Courage Container - 4
	call UnitRemoveAbility(u,'B0FJ')//B0FJ -> Moment of Courage
	call UnitRemoveAbility(u,'B0FK')//B0FK -> Moment of Courage
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTimer(t)
	set t=null
	set u=null
endfunction

function Legion_MoC_Clear takes unit u, unit target returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0,false,function Legion_MoC_Remove)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	if IsUnitIllusion(target)==false and IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false and IsUnitType(target,UNIT_TYPE_STRUCTURE)==false then
		call SetWidgetLife(u,GetWidgetLife(u)+GetEventDamage()*(0.1*(GetUnitAbilityLevel(u,'A2EY'))+0.45))//A2EY -> Moment of Courage, QP1O -> Moment of Courage
	endif
	set t=null
endfunction

function Legion_MoC_Act takes unit target returns nothing
	local trigger t
	local integer h
	local integer Level=GetUnitAbilityLevel(target,'A2EY')//A2EY -> Moment of Courage, QP1O -> Moment of Courage
	local integer id
	local integer chance=25
	if IsUnitType(UDSG_Attacker,UNIT_TYPE_HERO) then
		set chance=35
	endif
	if PRD_Get(target,'A2EY',chance) then//A2EY -> Moment of Courage
		call AddTimedKeyToUnit(target,4316,3.3-0.6*Level)
		if Level==1 then
			set id='A2GD'//A2GD -> Moment of Courage Container - 1
		elseif Level==2 then
			set id='A2GE'//A2GE -> Moment of Courage Container - 2
		elseif Level==3 then
			set id='A2GF'//A2GF -> Moment of Courage Container - 3
		elseif Level==4 then
			set id='A2GC'//A2GC -> Moment of Courage Container - 4
		endif
		call SetPlayerAbilityAvailable(GetOwningPlayer(target),id,false)
		call UnitAddAbility2(target,id)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterDeathEvent(t,target)
		call TriggerRegisterTimerEvent(t,0.5,false)
		call TriggerAddCondition(t,Condition(function DFH))
		call SaveUnitHandle(HY,h,2,target)
		call SaveInteger(HY,h,59,id)
		set t=null
	endif
endfunction

function Legion_MoC_OnAttack takes unit attacker, unit target returns nothing
	if GetUnitAbilityLevel(target,'A2EY')>0 and LoadInteger(HY,GetHandleId(target),4316)!=1 and IsUnitEnemy(target,GetOwningPlayer(attacker)) and GetUnitAbilityLevel(target,'A36D')==0 then//A2EY -> Moment of Courage, QP1O -> Moment of Courage
		call Legion_MoC_Act(target)
	endif
endfunction

function DKH takes unit Source,integer Level,unit Target returns nothing
	local integer ph=GetHandleId(GetOwningPlayer(Source))
	local integer dmg=LoadInteger(HeroStats,ph,'DDUE')
	if IsUnitType(Target,UNIT_TYPE_HERO) then
		set ph=GetHandleId(GetOwningPlayer(Source))
		call SaveInteger(HeroStats,ph,'DUEL',LoadInteger(HeroStats,ph,'DUEL')+1)
		call SaveInteger(HeroStats,ph,'DDUE',LoadInteger(HeroStats,ph,'DDUE')+6+4*Level)
		call TextTagOnUnit(GetUnitName(Source)+" Won The Duel!!",5,Source,.03,255,0,0,255)
		call BonusDamageSystem(Source)
	endif
endfunction

function DOH takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer lvl=(LoadInteger(HY,h,5))
	local real Time=(LoadReal(HY,h,442))
	local unit Caster
	local integer ph
	local unit u
	if GetTriggerEvalCount(t)==1 then
		if LoadBoolean(HY,h,0) then
			call STFU(Source,'B467',9999)//B467 -> Duel
			call STFU(Target,'B467',9999)//B467 -> Duel
			call UnitAddAbilityTimedExF(Source,'A467',1,9999,'B467')//B467 -> Duel
			call UnitAddAbilityTimedExF(Target,'A467',1,9999,'B467')//B467 -> Duel
		else
			call STFU(Source,'B467',0.75*lvl+3.25)//B467 -> Duel
			call STFU(Target,'B467',0.75*lvl+3.25)//B467 -> Duel
			call UnitAddAbilityTimedExF(Source,'A467',1,0.75*lvl+3.25,'B467')//B467 -> Duel
			call UnitAddAbilityTimedExF(Target,'A467',1,0.75*lvl+3.25,'B467')//B467 -> Duel
		endif
	endif
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or Time<(TimerGetElapsed(GlobalTimer))or DistanceBetweenUnits(Source,Target)>2000 then
		if GetTriggerEventId()==EVENT_WIDGET_DEATH then
			if GetTriggerUnit()==Source then
				set u=Target
			else
				set u=Source
			endif
			call DKH(u,lvl,GetTriggerUnit())
		endif
		call SaveBoolean(HY,GetHandleId(LoadTriggerHandle(HY,GetHandleId(Source),'STFU')),'SLDR',true)
		call SaveBoolean(HY,GetHandleId(LoadTriggerHandle(HY,GetHandleId(Target),'STFU')),'SLDR',true)
		call UnitRemoveAbility(Source,'A467')
		call UnitRemoveAbility(Source,'B467')//B467 -> Duel
		call UnitRemoveAbility(Target,'A467')
		call UnitRemoveAbility(Target,'B467')//B467 -> Duel
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call SetUnitPathing(Source,true)
		call SetUnitPathing(Target,true)
	elseif GetIssuedOrderId()!=851973 then
		call SetUnitPathing(Source,false)
		call SetUnitPathing(Target,false)
		call DisableTrigger(t)
		call IssueTargetOrderById(Source,ORDER_attack,Target)
		call IssueTargetOrderById(Target,ORDER_attack,Source)
		call EnableTrigger(t)
	else
		if GetUnitAbilityLevel(Source,'Abun')>0 then//Abun -> Cargo Hold (Orc Burrow)
			call UnitRemoveAbility(Source,'NOAT')
			call UnitRemoveAbility(Source,'Abun')//Abun -> Cargo Hold (Orc Burrow)
		endif
		if GetUnitAbilityLevel(Target,'Abun')>0 then//Abun -> Cargo Hold (Orc Burrow)
			call UnitRemoveAbility(Target,'NOAT')
			call UnitRemoveAbility(Target,'Abun')//Abun -> Cargo Hold (Orc Burrow)
		endif
	endif
	set t=null
	set Source=null
	set Target=null
	set Caster=null
	return false
endfunction

function LegionCommander_Duel takes unit Source, unit Target returns nothing
	local integer Level=GetUnitAbilityLevel(Source,'A2CI')+GetUnitAbilityLevel(Source,'A38C')//A2CI -> Duel, A38C -> Duel
	local trigger t
	local integer h
	local boolean agh=GetUnitAbilityLevel(Source,'A38C')>0//A38C -> Duel
	if GetUnitAbilityLevel(Source,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(Source),0) then//Aloc -> Locust
		set Source=LoadUnitHandle(HY,GetHandleId(Source),0)
	endif
//	call echo(GetUnitName(Source)+" -> "+GetUnitName(Target))
	call SetUnitPathing(Source,false)
	call SetUnitPathing(Target,false)
	call IssueTargetOrderById(Source,ORDER_attack,Target)
	call IssueTargetOrderById(Target,ORDER_attack,Source)
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveUnitHandle(HY,h,17,(Target))
	call SaveInteger(HY,h,5,(Level))
	if agh then
		call SaveReal(HY,h,442,(((TimerGetElapsed(GlobalTimer))+9999)*1.))
		call SaveBoolean(HY,h,0,true)
	else
		call SaveReal(HY,h,442,(((TimerGetElapsed(GlobalTimer))+.75*Level+3.25)*1.))
	endif
	call TriggerAddCondition(t,Condition(function DOH))
	call TriggerRegisterTimerEvent(t,.05,true)
	call TriggerRegisterTimerEvent(t,.01,false)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterDeathEvent(t,Target)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_ISSUED_ORDER)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_ORDER)
	set t=null
endfunction

function LegionCommander_PreDuel takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call LegionCommander_Duel(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1))
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
endfunction

function LegionCommander_DuelWrap takes nothing returns nothing
	local timer t
	local integer h
	if IsBlocked(GetSpellTargetUnit())==false then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
		call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
		call TimerStart(t,0,false,function LegionCommander_PreDuel)
		set t=null
	endif
endfunction


function DUH takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer Level=(LoadInteger(HY,h,5))
	local integer Count=(LoadInteger(HY,h,34))
	set Count=Count+1
	call SaveInteger(HY,h,34,(Count))
	if GetTriggerEventId()==EVENT_WIDGET_DEATH or Count>50 or GetUnitAbilityLevel(Target,'A2J4')==0 then
		call UnitRemoveAbility(Target,'A2J4')
		//call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call RemoveSavedHandle(HY,GetHandleId(Target),'A2J2')
		call CleanTrigger(t)
	else
		call SetWidgetLife(Target,GetWidgetLife(Target)+2+1*Level)
		if ModuloInteger(Count,10)==1 then
			call Z48("Abilities\\Spells\\Orc\\SpiritLink\\SpiritLinkZapTarget.mdl",Target,"chest",1.9)
		endif
	endif
	set t=null
	set Target=null
	return false
endfunction

function LegionCommander_PressTheAttack takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A2J2')//A2J2 -> Press The Attack
	local trigger t
	local integer h
	if HaveSavedHandle(HY,GetHandleId(Target),'A2J2') then
		set t=LoadTriggerHandle(HY,GetHandleId(Target),'A2J2')
		set h=GetHandleId(t)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveTriggerHandle(HY,GetHandleId(Target),'A2J2',t)
		call TriggerRegisterTimerEvent(t,.1,true)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerAddCondition(t,Condition(function DUH))
		call SaveUnitHandle(HY,h,17,Target)
	endif
	call RemoveDispellableBuffs(Target)
	call UnitAddAbility3(Target,'A2J4',Level)
	//call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("Abilities\\Spells\\Human\\InnerFire\\InnerFireTarget.mdl",Target,"overhead")))
	call SaveInteger(HY,h,5,Level)
	call SaveInteger(HY,h,34,0)
	call TriggerEvaluate(t)
	set Source=null
	set Target=null
	set t=null
endfunction

function Legion_PtA_Init takes nothing returns nothing
	set O08[1]='A2J4'//A2J9 -> Press The Attack Container - 1
	set O08[2]='A2J5'//A2JA -> Press The Attack Container - 2
	set O08[3]='A2J3'//A2J8 -> Press The Attack Container - 3
	set O08[4]='A2J6'//A2J7 -> Press The Attack Container - 4
endfunction

function DYH takes nothing returns nothing
	if (IsUnitType(GetEnumUnit(),UNIT_TYPE_SUMMONED) and IsPandarenSpirit(GetEnumUnit())==false and GetUnitAbilityLevel(GetEnumUnit(),'ACrk')==0 and GetUnitAbilityLevel(GetEnumUnit(),'A12G')==0) or IsUnitIllusion(GetEnumUnit()) then
		call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)*.5)
	endif
	call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,50*P48+(12+P48*2)*O58+(5+P48*15)*O28)
endfunction

function DZH takes nothing returns nothing
	if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
		set O28=O28+1
	else
		set O58=O58+1
	endif
endfunction

function Legion_Odds_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer h = GetHandleId(t)
	local integer c=LoadInteger(HY,h,0)
	local unit u=LoadUnitHandle(HY,h,0)
	if c >= 5* 7 or GetUnitAbilityLevel(u,'C020')==0 then
		call UnitRemoveAbility(u,'C020')
		call UnitRemoveAbility(u,'D020')
		call SubBonusMSPercent(u,LoadInteger(HY,h,1))
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
		call RemoveSavedHandle(HY,GetHandleId(u),'A2JB')
	else
		call SaveInteger(HY,h,0,c+1)
	endif
	set u=null
	set t = null
endfunction

function LegionCommander_OverhelmingOdds takes nothing returns nothing
	local timer t
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local integer Level=GetUnitAbilityLevel(Source,'A2JB')//A2JB -> Overwhelming Odds
	local group g=GetAvailableGroup()
	local integer h
	call DestroyEffect(AddSpecialEffect("war3mapImported\\OverwhelmingOdds.mdx",x,y))
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,x,y,330+25,Condition(function DefaultEnemyFilterWithAncients))
	set O58=0
	set O28=0
	set P48=Level
	call ForGroup(g,function DZH)
	call ForGroup(g,function DYH)
	call KillGroup(g)
	set x = (9*O28 + 3*O58)
	if x>0 then
		call AddBonusMSPercent(Source,R2I(x))
		call UnitAddAbility2(Source,'C020')
		if HaveSavedHandle(HY,GetHandleId(Source),'A2JB') then
			set t=LoadTimerHandle(HY,GetHandleId(Source),'A2JB')
			set h=GetHandleId(t)
		else
			set t=CreateTimer()
			set h=GetHandleId(t)
			call SaveTimerHandle(HY,GetHandleId(Source),'A2JB',t)
			call TimerStart(t,0.2,true,function Legion_Odds_End)
		endif
		call SaveInteger(HY,h,0,0)
		call SaveUnitHandle(HY,h,0,Source)
		call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+R2I(x))
	endif
	set Source = null
	set t = null
endfunction

function MysticFlareFilterHeroes takes nothing returns boolean
	return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit())) and IsUnitInvulnerable(GetFilterUnit())==false) and IsMagicImmune(GetFilterUnit())!=null
endfunction

function MysticFlareFilterCreeps takes nothing returns boolean
	return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))
endfunction

function D3H takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	local real x=(LoadReal(HY,h,6))
	local real y=(LoadReal(HY,h,7))
	local group g
	local unit u2
	local integer lvl
	local integer c
	if GetTriggerEvalCount(t)>20 then
		call DestroyEffect((LoadEffectHandle(HY,h,32)))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	else
		set g=GetAvailableGroup()
		set tt_unit1=Source
		call GroupEnumUnitsInRange(g,x,y,170+25,Condition(function DE9))
		set lvl=GetUnitAbilityLevel(Source,'A2BG')+GetUnitAbilityLevel(Source,'A30H')//A2BG -> Mystic Flare, A30H -> Mystic Flare
		set c=CountUnitsInGroup(g)
		if c==0 then
			call GroupEnumUnitsInRange(g,x,y,170+25,Condition(function MysticFlareFilterCreeps))
			set c=CountUnitsInGroup(g)
		endif
		loop
			set u2=FirstOfGroup(g)
			exitwhen u2==null
			call DamageTarget(Source,u2,1,((200+400*lvl)/ c)/ 20)
			call GroupRemoveUnit(g,u2)
		endloop
		call KillGroup(g)
		set g=null
	endif
	set t=null
	set Source=null
	return false
endfunction

function Skywrath_MysticFlare takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local string s="war3mapImported\\DivineWrathTarget.mdx"
	local location l=GetSpellTargetLoc()
	call PlaySoundAtPointBJ(PD8,100,l,0)
	call RemoveLocation(l)
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddCondition(t,Condition(function D3H))
	call SaveUnitHandle(HY,h,2,(Source))
	call SaveReal(HY,h,6,((x)*1.))
	call SaveReal(HY,h,7,((y)*1.))
	call DestroyEffect(AddSpecialEffect(s,x,y))
	set t=null
	set Source=null
	set l=null
endfunction

function Skywrath_Ulti_init takes nothing returns nothing
	set PD8=CreateSound("Abilities\\Spells\\Demon\\RainOfFire\\RainOfFireTarget2.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(PD8,"StarfallTarget")
	call SetSoundDuration(PD8,3000)
endfunction

function E9H takes nothing returns nothing
	local unit Source=tt_unit1
	local unit Target=tt_unit2
	local integer Level=LoadInteger(HY,GetHandleId(GetTriggeringTrigger()),0)
	local integer i=GetHeroHighestStatValue(Source)
	local real Damage=40+20*Level+1.6*i
	if GetUnitAbilityLevel(Target,'A3E9')==1 and IsMagicImmune(Source)==false then
		call SaveUnitHandle(TempHash,'A3E9',0,Target)
		call SaveUnitHandle(TempHash,'A3E9',1,Source)
		call SaveInteger(TempHash,'A3E9',0,Level)
		call ExecuteFunc("Skywrath_ArcaneBoltLotusOrb")
	endif
	if i==0 then
		set Damage=40+20*Level+1.6*GetHeroHighestStatValue(udg_Hero[GetPlayerId(GetOwningPlayer(Source))])
	endif
	call DamageTarget(Source,Target,1,Damage)
	set Source=null
	set Target=null
endfunction

function EDH takes unit Source, unit Target, integer lvl returns nothing
	call SaveInteger(HY,GetHandleId(AddProjectile(Source,Target,'h0DQ',"E9H",500,false)),0,lvl)//h0DQ -> Arcane Bolt Projectile
endfunction

function Skywrath_ArcaneBoltLotusOrb takes nothing returns nothing
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	if IsBlocked(LoadUnitHandle(TempHash,'A3E9',1))==false then
		call EDH(LoadUnitHandle(TempHash,'A3E9',0),LoadUnitHandle(TempHash,'A3E9',1),LoadInteger(TempHash,'A3E9',0))
	endif
	call FlushChildHashtable(TempHash,'A3E9')
endfunction

function Skywrath_ArcaneBolt takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call EDH(GetTriggerUnit(),GetSpellTargetUnit(),GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
	endif
endfunction

function EFH takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local real d
	call UnitRemoveAbility(Target,'A2HX')//A2HX -> Arcane Silence Container - 1
	call UnitRemoveAbility(Target,'A2I0')//A2I0 -> Arcane Silence Container - 2
	call UnitRemoveAbility(Target,'A2HY')//A2HY -> Arcane Silence Container - 3
	call UnitRemoveAbility(Target,'A2HZ')//A2HZ -> Arcane Silence Container - 4
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set Target=null
	set t=null
	return false
endfunction

function EGH takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Source=GetTriggerUnit()
	local unit Target=GetSpellTargetUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A2HN')//A2HN -> Ancient Seal
	local real SB8=2+Level
	local integer id='A2HX'//A2HX -> Arcane Silence Container - 1
	if Level==2 then
		set id='A2I0'//A2I0 -> Arcane Silence Container - 2
	elseif Level==3 then
		set id='A2HY'//A2HY -> Arcane Silence Container - 3
	elseif Level==4 then
		set id='A2HZ'//A2HZ -> Arcane Silence Container - 4
	endif
	call UnitAddAbility2(Target,id)
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),id,false)
	call TriggerRegisterTimerEvent(t,SB8,false)
	call TriggerAddCondition(t,Condition(function EFH))
	call SaveUnitHandle(HY,h,2,Source)
	call SaveUnitHandle(HY,h,17,Target)
	set Source=null
	set Target=null
	set t=null
endfunction

function Skywrath_AncientSeal takes nothing returns nothing
	if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and IsBlocked(GetSpellTargetUnit())==false then
		call EGH()
	endif
endfunction

function EIH takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local real x=GetUnitX(tt_unit2)
	local real y=GetUnitY(tt_unit2)
	local unit Caster=CreateUnit(GetOwningPlayer(tt_unit1),'e00E',x,y,0)//e00E -> Spellcaster
	call UnitAddAbility(Caster,'A2IU')//A2IU -> Concussive Shot Slow NEW
	call SetUnitAbilityLevel(Caster,'A2IU',LoadInteger(HY,h,0))//A2IU -> Concussive Shot Slow NEW
	call IssueImmediateOrderById(Caster,852096)
	set Caster=null
endfunction

function EJH takes unit Source,group g returns unit
	local unit EKH=null
	local real d=99999
	local unit EMH=FirstOfGroup(g)
	call GroupRemoveUnit(g,EMH)
	loop
		exitwhen EMH==null
		if DistanceBetweenUnits(Source,EMH)<d then
			set d=DistanceBetweenUnits(Source,EMH)
			set EKH=EMH
		endif
		set EMH=FirstOfGroup(g)
		call GroupRemoveUnit(g,EMH)
	endloop
	set EMH=null
	set TEMPUNIT=EKH
	set EKH=null
	return TEMPUNIT
endfunction

function Skywrath_ConcussiveShot takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=null
	local group g=GetAvailableGroup()
	local trigger t
	set tt_unit1=Source
	call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1600+25,Condition(function DD9))
	set Target=EJH(Source,g)
	call KillGroup(g)
	if Target!=null then
		set t=AddProjectile(Source,Target,'h0E6',"EIH",800,false)//h0E6 -> Concussive Shot Projectile
		call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
		set t=null
	endif
	set g=null
	set Target=null
	set Source=null
endfunction

function FFH takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Target=(LoadUnitHandle(HY,h,17))
	local integer TQG=(LoadInteger(HY,h,422))
	local integer TRG=(LoadInteger(HY,h,423))
	local integer SSF=(LoadInteger(HY,h,424))
	if GetUnitAbilityLevel(Target,'A42S')==0 or GetTriggerEvalCount(t)>35 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call SetHeroAgi(Target,GetHeroAgi(Target,false)+TQG,true)
		call SetHeroStr(Target,GetHeroStr(Target,false)+TRG,true)
		call SetHeroInt(Target,GetHeroInt(Target,false)+SSF,true)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Target=null
	return false
endfunction

function FGH takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local unit Target=GetEnumUnit()
	local integer Level=GetUnitAbilityLevel(Source,'A2FK')//A2FK -> Whirling Death
	local trigger t
	local integer h
	local integer attr
	local integer agi
	local integer str
	local integer int
	local real rate
	if IsUnitType(Target,UNIT_TYPE_HERO) then
		set attr=GetUnitPrimaryAttribute(Target)
		set rate=.15
		call UnitAddAbilityTimedExF(Target,'A42S',1,7,'B0HJ')
		if attr==2 then
			set agi=R2I(rate*GetHeroAgi(Target,false))-1
			set str=0
			set int=0
		elseif attr==3 then
			set agi=0
			set str=R2I(rate*GetHeroStr(Target,false))-1
			set int=0
		elseif attr==1 then
			set agi=0
			set str=0
			set int=R2I(rate*GetHeroInt(Target,false))-1
		endif
		call SetHeroAgi(Target,GetHeroAgi(Target,false)-agi,true)
		call SetHeroStr(Target,GetHeroStr(Target,false)-str,true)
		call SetHeroInt(Target,GetHeroInt(Target,false)-int,true)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,0.2,true)
		call TriggerRegisterDeathEvent(t,Target)
		call TriggerAddCondition(t,Condition(function FFH))
		call SaveInteger(HY,h,422,agi)
		call SaveInteger(HY,h,424,int)
		call SaveInteger(HY,h,423,str)
		call SaveUnitHandle(HY,h,17,Target)
		set t=null
	endif
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",Target,"chest"))
	call DamageTarget(Source,Target,PM8,50+50*Level)
	set Source=null
	set Target=null
endfunction

function Shredder_WhirlingDeath takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local group g=GetAvailableGroup()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),x,y)*bj_DEGTORAD
	set x=GetUnitX(Source)
	set y=GetUnitY(Source)
	if KillTrees(x,y,300)>0 then
		set PM8=3
	else
		set PM8=1
	endif
	call GroupEnumUnitsInRange(g,x,y,300+25,Condition(function LR8))
	call ForGroup(g,function FGH)
	call KillGroup(g)
	call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\WhirlingDeath_01.mdx",Source,"origin"))
	set Source=null
	set g=null
endfunction

function FJH takes unit Source,unit Target returns nothing
	local integer Level=Shredder_TempInt
	call DamageTarget(Source,Target,3,60+40*Level)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",Target,"origin"))
endfunction

function FKH takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),DK)==false then
		call GroupAddUnit(DK,GetEnumUnit())
		call FJH(tt_unit1,GetEnumUnit())
	endif
endfunction

function FMH takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local unit Target=LoadUnitHandle(HY,h,17)
	local integer R9E=LoadInteger(HY,h,18)
	local integer Count=GetTriggerEvalCount(t)
	local unit RDE
	local group REE=LoadGroupHandle(HY,h,16)
	local group g
	local boolean WD9=LoadBoolean(HY,h,727)
	local boolean FNH=LoadBoolean(HY,h,740)
	set Shredder_TempInt=LoadInteger(HY,h,0)
	if IsUnitDisabled(Hero)then
		set FNH=true
		call SaveBoolean(HY,h,740,FNH)
	endif
	if WD9==false then
		set RDE=LoadUnitHandle(HY,h,700+R9E+1-Count)
		call RemoveUnit(RDE)
	else
		set RDE=LoadUnitHandle(HY,h,700+Count)
		if FNH==false then
			if IsUnitType(Hero,UNIT_TYPE_HERO)then
				call SaveBoolean(HeroStats,GetHandleId(Hero),99,true)
			endif
			call SetUnitX(Hero,GetUnitX(RDE))
			call SetUnitY(Hero,GetUnitY(RDE))
		endif
		call RemoveUnit(RDE)
		set g=GetAvailableGroup()
		set tt_unit1=Hero
		set DK=REE
		call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),250,Condition(function LW8))
		call ForGroup(g,function FKH)
		call KillGroup(g)
	endif
	if Count==(R9E)then
		call KillTrees(GetUnitX(Hero),GetUnitY(Hero),90)
		call KillGroup(REE)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set Hero=null
	set Target=null
	set RDE=null
	set REE=null
	set g=null
	return false
endfunction

function FOH takes nothing returns nothing
	if IsValidTree(GetEnumDestructable())and IsDestructableDeadBJ(GetEnumDestructable())==false then
		set PN8=PN8+1
	endif
endfunction

function FPH takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=LoadUnitHandle(HY,h,14)
	local real a=LoadReal(HY,h,13)
	local integer RHE=LoadInteger(HY,h,12)
	local integer Count=GetTriggerEvalCount(t)
	local real x=LoadReal(HY,h,6)+Count*50*Cos(a*bj_DEGTORAD)
	local real y=LoadReal(HY,h,7)+Count*50*Sin(a*bj_DEGTORAD)
	local boolean RIE=LoadBoolean(HY,h,15)
	local unit RJE
	local trigger RKE=LoadTriggerHandle(HY,h,11)
	local integer RME=GetHandleId(RKE)
	local integer ID='u01Q'//u01Q -> Timber Chain Link
	local real RFE=250
	local rect r
	local real d=90
	local integer lvl=LoadInteger(HY,h,0)
	set r=Rect(x-d,y-d,x+d,y+d)
	set PN8=0
	call EnumDestructablesInRect(r,Condition(function ReturnTrue),function FOH)
	if PN8>0 or Count==RHE or Count==(RHE-1)or Count==(RHE-2)then
		set ID='u01P'//u01P -> Timberchain Head
	endif
	set RJE=CreateUnit(GetOwningPlayer(Hero),ID,x,y,a)
	call SaveUnitHandle(HY,RME,700+Count,RJE)
	if PN8>0 then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call TriggerRegisterTimerEvent(RKE,.5/ RHE,true)
		call TriggerAddCondition(RKE,Condition(function FMH))
		call SaveInteger(HY,RME,18,Count)
		call SaveInteger(HY,RME,0,lvl)
		call SaveBoolean(HY,RME,727,true)
		call SaveUnitHandle(HY,RME,14,Hero)
		call SaveGroupHandle(HY,RME,16,GetAvailableGroup())
		call SaveReal(HY,RME,6,x*1.)
		call SaveReal(HY,RME,7,y*1.)
		call SaveBoolean(HY,RME,740,false)
	elseif Count>RHE then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call TriggerRegisterTimerEvent(RKE,.5/ RHE,true)
		call TriggerAddCondition(RKE,Condition(function FMH))
		call SaveInteger(HY,RME,18,Count)
		call SaveInteger(HY,RME,0,lvl)
		call SaveBoolean(HY,RME,727,false)
		call SaveUnitHandle(HY,RME,14,Hero)
		call SaveGroupHandle(HY,RME,16,GetAvailableGroup())
		call SaveBoolean(HY,RME,740,false)
	endif
	set t=null
	set Hero=null
	set RJE=null
	set RKE=null
	return false
endfunction

function Shredder_Timberchain takes nothing returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit Hero=GetTriggerUnit()
	local real a=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetSpellTargetX(),GetSpellTargetY())
	local integer Level=GetUnitAbilityLevel(Hero,'A2E3')//A2E3 -> Timber Chain
	local integer ROE
	local integer RHE
	local trigger RPE=CreateTrigger()
	set ROE=600+200*Level
	set RHE=ROE/ 50
	call SaveUnitHandle(HY,h,14,(Hero))
	call SaveInteger(HY,h,5,(Level))
	call SaveReal(HY,h,13,((a)*1.))
	call SaveInteger(HY,h,12,(RHE))
	call SaveTriggerHandle(HY,h,11,(RPE))
	call SaveReal(HY,h,6,((GetUnitX(Hero))*1.))
	call SaveReal(HY,h,7,((GetUnitY(Hero))*1.))
	call TriggerRegisterTimerEvent(t,.5/ RHE,true)
	call TriggerAddCondition(t,Condition(function FPH))
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
	set t=null
	set Hero=null
	set RPE=null
endfunction

function FTH takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local integer info = GetHandleId(Source)
	call SaveInteger(HY,info,'A2E4',LoadInteger(HY,info,'A2E4')-1)//A2E4 -> Reactive Armor, A2E4 -> Reactive Armor
	if 4*(GetUnitAbilityLevel(Source,'A2E4')) > LoadInteger(HY,GetHandleId(Source),'A2E4') then//A2E4 -> Reactive Armor, A2E4 -> Reactive Armor
		call LoDStat_Sub(Source,1,"regen")
		call LoDStat_Sub(Source,1,"armour")
		call SaveInteger(HY,GetHandleId(Source),'A2E5',LoadInteger(HY,GetHandleId(Source),'A2E5')-1)
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function Shredder_ReactiveArmor_Proc takes unit timber returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	//call echo("here "+I2S(4*(GetUnitAbilityLevel(timber,'A2E4')+GetUnitAbilityLevel(timber,'QP1P')))+" "+I2S(LoadInteger(HY,GetHandleId(timber),'A2E4')))
	if LoadInteger(HY,GetHandleId(timber),'A2E5') < 4*(GetUnitAbilityLevel(timber,'A2E4')) then//A2E4 -> Reactive Armor, A2E4 -> Reactive Armor
		call LoDStat_Add(timber,1,"regen")
		call LoDStat_Add(timber,1,"armour")
		call SaveInteger(HY,GetHandleId(timber),'A2E5',LoadInteger(HY,GetHandleId(timber),'A2E5')+1)
	endif
	call SaveInteger(HY,GetHandleId(timber),'A2E4',LoadInteger(HY,GetHandleId(timber),'A2E4')+1)//A2E4 -> Reactive Armor, A2E4 -> Reactive Armor
	call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\ReactiveArmor.mdx",timber,"chest"))
	call TriggerRegisterTimerEvent(t,16,false)
	call TriggerRegisterDeathEvent(t,timber)
	call TriggerAddCondition(t,Condition(function FTH))
	call SaveUnitHandle(HY,h,2,timber)
	set t=null
endfunction

function Shredder_ReactiveArmor_OnAttack takes unit attacker, unit target returns nothing
	if GetUnitAbilityLevel(target,'A2E4')>0 and GetUnitAbilityLevel(target,'A36D')==0 and IsUnitEnemy(attacker,GetOwningPlayer(target)) then//A2E4 -> Reactive Armor
		call Shredder_ReactiveArmor_Proc(target)
	endif
endfunction

function FXH takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=(LoadUnitHandle(HY,h,2))
	call UnitRemoveAbility(Source,'Bpig')//Bpig -> Immolation
	call UnitRemoveAbility(Source,'BEia')//BEia -> Immolation
	call UnitRemoveAbility(Source,'BNms')//BNms -> Mana Shield
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set Source=null
	return false
endfunction

function GetAvailableDummyChakram takes unit t returns unit
	if HaveSavedHandle(TempHash,'A3GA',0) and GetUnitState(LoadUnitHandle(TempHash,'A3GA',0), UNIT_STATE_LIFE)>0.5 then
		call SetUnitX(LoadUnitHandle(TempHash,'A3GA',0),GetUnitX(t))
		call SetUnitY(LoadUnitHandle(TempHash,'A3GA',0),GetUnitY(t))
		call SetUnitOwner(LoadUnitHandle(TempHash,'A3GA',0),GetOwningPlayer(t),false)
	else
		call SaveUnitHandle(TempHash,'A3GA',0,CreateUnit(GetOwningPlayer(t),'e00E',GetUnitX(t),GetUnitY(t),0))//e00E -> Spellcaster
	endif
	return LoadUnitHandle(TempHash,'A3GA',0)
endfunction

function FYH takes unit Source,unit Target returns nothing
	local unit Caster=GetAvailableDummyChakram(Target)
	local integer WFE=R2I(100*GetWidgetLife(Target)/ GetUnitState(Target,UNIT_STATE_MAX_LIFE))
	local integer Level=IMaxIF( IMinIF( R2I(100-WFE) / 5, 20 ), 1 )
	call UnitAddAbility(Caster,'A3GA'-1+Level)
	call IssueTargetOrderById(Caster,852075,Target)
	call UnitRemoveAbility(Caster,'A3GA'-1+Level)
	set Caster=null
endfunction

function FZH takes nothing returns nothing
	if GameEnded==false then
		call DamageTarget(PS8,GetEnumUnit(),3,(25+25*PT8)*.5)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",GetEnumUnit(),"origin"))
		call FYH(PS8,GetEnumUnit())
	endif
endfunction

function FAH takes nothing returns nothing
	if IsUnitInGroup(GetEnumUnit(),PR8)==false then
		call GroupAddUnit(PR8,GetEnumUnit())
		call DamageTarget(PS8,GetEnumUnit(),3,60+40*PT8)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",GetEnumUnit(),"origin"))
		call FYH(PS8,GetEnumUnit())
	endif
endfunction

function DelayedRemoveTurnOffB takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call UnitRemoveAbility(LoadUnitHandle(HY,h,0),'A43P')//A43P -> Chakram End
	call FlushChildHashtable(HY,h)
	call PauseTimer(t)
	call DestroyTimer(t)
	set t=null
endfunction

function DelayedRemoveTurnOff takes unit u returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0,false,function DelayedRemoveTurnOffB)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	set t=null
endfunction

function FBH takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit Source=LoadUnitHandle(HY,h,2)
	local unit Projectile=LoadUnitHandle(HY,h,45)
	local real TargetX=LoadReal(HY,h,6)
	local real TargetY=LoadReal(HY,h,7)
	local real x
	local real y
	local real a
	local integer state=LoadInteger(HY,h,33)
	local group AlreadyHit=LoadGroupHandle(HY,h,187)
	local group g
	local integer Count=LoadInteger(HY,h,34)
	local real manacost
	local integer spellid=LoadInteger(HY,h,2)
	local integer abun=LoadInteger(HY,h,3)
	local integer turnoff=LoadInteger(HY,h,4)
	call UnitAddAbility2(Source,abun)
	if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
		if GetSpellAbilityId()==turnoff then
			call SaveInteger(HY,h,33,2)
			call GroupClear(AlreadyHit)
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),turnoff,false)
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call TriggerRegisterTimerEvent(t,0,false)
			call TriggerAddCondition(t,Condition(function FXH))
			call SaveUnitHandle(HY,h,2,(Source))
			call UnitRemoveAbilityDelayed(Source,turnoff,0)
		endif
	elseif GetTriggerEventId()==EVENT_WIDGET_DEATH or(LoadInteger(HY,GetHandleId(Source),704))==-1 then
		call UnitRemoveAbilityDelayed(Source,turnoff,0)
		call UnitRemoveAbility(Source,abun)
		if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))==spellid then
			if spellid=='A43Q' then//A43Q -> Chakram Second
				if LoadBoolean(MHT,GetHandleId(Source),'A43Q') then//A43Q -> Chakram Second
					call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),spellid,true)
				endif
			else
				call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),spellid,true)
			endif
		endif
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),turnoff,false)
		if spellid!='A43Q' then//A43Q -> Chakram Second
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2E5',true)//A2E5 -> Chakram
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A43S',true)//A43S -> Chakram
		endif
		call PhaseBootsRemoveImmolation(Source)
		call UnitRemoveAbility(Source,'BNms')//BNms -> Mana Shield
		call KillUnit(Projectile)
		call KillGroup(AlreadyHit)
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	elseif state==0 then
		set a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),TargetX,TargetY)*bj_DEGTORAD
		set x=GetUnitX(Projectile)+18*Cos(a)
		set y=GetUnitY(Projectile)+18*Sin(a)
		call KillTrees(x,y,175)
		if DistanceBetweenXY(x,y,TargetX,TargetY)<40 then
			set x=TargetX
			set y=TargetY
		endif
		call SetUnitX(Projectile,x)
		call SetUnitY(Projectile,y)
		set tt_unit1=Source
		set PS8=Source
		set PT8=LoadInteger(HY,h,0)
		set PR8=AlreadyHit
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,x,y,200+25,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function FAH)
		call KillGroup(g)
		if x==TargetX and y==TargetY then
			call SaveInteger(HY,h,33,1)
			call GroupClear(AlreadyHit)
		endif
	elseif state==1 then
		set Count=Count+1
		if Count==25 then
			set x=GetUnitX(Projectile)
			set y=GetUnitY(Projectile)
			call KillTrees(x,y,175)
			set Count=0
			set tt_unit1=Source
			set PS8=Source
			set PT8=LoadInteger(HY,h,0)
			set g=GetAvailableGroup()
			call GroupEnumUnitsInRange(g,x,y,200+25,Condition(function DefaultEnemyFilterWithAncients))
			call ForGroup(g,function FZH)
			call KillGroup(g)
			set manacost=(15+5*PT8)/ 2
			if GetUnitState(Source,UNIT_STATE_MANA)<manacost or DistanceBetweenUnits(Source,Projectile)>2000 then
				call SaveInteger(HY,h,33,2)
				call GroupClear(AlreadyHit)
				call UnitRemoveAbility(Source,turnoff)
				call PhaseBootsRemoveImmolation(Source)
				call UnitRemoveAbility(Source,'BNms')//BNms -> Mana Shield
			else
				call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)-manacost)
			endif
		endif
		call SaveInteger(HY,h,34,(Count))
	elseif state==2 then
		set a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),GetUnitX(Source),GetUnitY(Source))*bj_DEGTORAD
		set x=GetUnitX(Projectile)+16*Cos(a)
		set y=GetUnitY(Projectile)+16*Sin(a)
		call KillTrees(x,y,175)
		call SetUnitX(Projectile,x)
		call SetUnitY(Projectile,y)
		set tt_unit1=Source
		set PS8=Source
		set PT8=LoadInteger(HY,h,0)
		set PR8=AlreadyHit
		set g=GetAvailableGroup()
		call GroupEnumUnitsInRange(g,x,y,200+25,Condition(function DefaultEnemyFilterWithAncients))
		call ForGroup(g,function FAH)
		call KillGroup(g)
		if DistanceBetweenXY(x,y,GetUnitX(Source),GetUnitY(Source))<40 then
			call UnitRemoveAbility(Source,abun)
			call KillUnit(Projectile)
			call KillGroup(AlreadyHit)
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
			if(LoadInteger(HY,(GetHandleId(Source)),704))==0 or(LoadInteger(HY,(GetHandleId(Source)),704))==spellid then
				if spellid=='A43Q' then//A43Q -> Chakram Second
					if LoadBoolean(MHT,GetHandleId(Source),'A43Q') then//A43Q -> Chakram Second
						call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),spellid,true)
					endif
				else
					call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),spellid,true)
				endif
			endif
			call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),turnoff,false)
			if spellid!='A43Q' then//A43Q -> Chakram Second
				call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2E5',true)//A2E5 -> Chakram
				call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A43S',true)//A43S -> Chakram
			endif
			call UnitRemoveAbility(Source,turnoff)
		endif
	endif
	set t=null
	set Source=null
	set Projectile=null
	set AlreadyHit=null
	set g=null
	return false
endfunction

function Shredder_Chakram takes nothing returns nothing
	local unit Source=GetTriggerUnit()
	local real x=GetSpellTargetX()
	local real y=GetSpellTargetY()
	local real a=AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),x,y)*bj_DEGTORAD
	local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0DS',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)//h0DS -> Chakram
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer abun
	local integer turnoff
	local integer spellid=GetSpellAbilityId()
	call TriggerRegisterTimerEvent(t,.02,true)
	call TriggerRegisterDeathEvent(t,Source)
	call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function FBH))
	call SaveUnitHandle(HY,h,45,Projectile)
	call SaveUnitHandle(HY,h,2,Source)
	call SaveReal(HY,h,6,x*1.)
	call SaveReal(HY,h,7,y*1.)
	call SaveInteger(HY,h,33,0)
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,spellid))
	call SaveGroupHandle(HY,h,187,GetAvailableGroup())
	call SaveInteger(HY,h,2,spellid)
	if spellid=='A2E5' or spellid=='A43S' then//A2E5 -> Chakram, A43S -> Chakram
		set abun='A43N'
		set turnoff='A2FX'//A2FX -> Chakram End
	else
		set abun='A43O'
		set turnoff='A43P'//A43P -> Chakram End
	endif
	
	call UnitAddAbility2(Source,abun)
	call UnitAddAbility2(Source,turnoff)
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),spellid,false)
	if spellid!='A43Q' then//A43Q -> Chakram Second
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2E5',false)//A2E5 -> Chakram
		call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A43S',false)//A43S -> Chakram
	endif
	call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),turnoff,true)
	
	call SaveInteger(HY,h,3,abun)
	call SaveInteger(HY,h,4,turnoff)
	set Source=null
	set t=null
	set Projectile=null
endfunction

function ChakramLevelup takes nothing returns nothing
	if GetUnitAbilityLevel(GetTriggerUnit(),'A43Q')>0 then//A43Q -> Chakram Second
		call SetUnitAbilityLevel(GetTriggerUnit(),'A43Q',GetUnitAbilityLevel(GetTriggerUnit(),'A2E5')+GetUnitAbilityLevel(GetTriggerUnit(),'A43S'))//A43Q -> Chakram Second, A2E5 -> Chakram, A43S -> Chakram
	endif
endfunction

function AghaChakram_Add takes nothing returns nothing
	call UnitAddAbility2(tt_unit1,'A43Q')//A43Q -> Chakram Second
	call SetPlayerAbilityAvailable2(GetOwningPlayer(tt_unit1),'A43Q',GetUnitAbilityLevel(tt_unit1,'A43O')==0)//A43Q -> Chakram Second
	call SaveBoolean(MHT,GetHandleId(tt_unit1),'A43Q',true)//A43Q -> Chakram Second
	call SetUnitAbilityLevel(tt_unit1,'A43Q',GetUnitAbilityLevel(tt_unit1,'A2E5')+GetUnitAbilityLevel(tt_unit1,'A43S'))//A43Q -> Chakram Second, A2E5 -> Chakram, A43S -> Chakram
endfunction

function AghaChakram_Remove takes nothing returns nothing
	call SetPlayerAbilityAvailable2(GetOwningPlayer(tt_unit1),'A43Q',false)//A43Q -> Chakram Second
	call SaveBoolean(MHT,GetHandleId(tt_unit1),'A43Q',false)//A43Q -> Chakram Second
endfunction

function Timber_Chakram_Preload takes nothing returns nothing
	call PreloadQueryAdd('A2DV')
endfunction

function Formless_Clear takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer aid=LoadInteger(HY,h,1)
	local integer hu=GetHandleId(u)
	local integer c=LoadInteger(HY,h,100)+1
	local integer slot
	if c==240 or aid=='DRKN' or aid=='DRKU' or aid=='A29J' then//DRKN -> Darkness, A29J -> Requiem of Souls
		if LoadInteger(MHT,hu,'A40K')!=aid and LoadInteger(MHT,hu,'A40K'+1)!=aid and LoadInteger(MHT,hu,'A40K'+2)!=aid and LoadInteger(MHT,hu,'A40K'+3)!=aid then//A40K -> Unus, A40K -> Unus, A40K -> Unus, A40K -> Unus
			call UnitRemoveAbility(u,aid)
			set slot=LoadInteger(HY,h,2)
			if(LoadBoolean(MHT,hu,'A40K'+slot))then//A40K -> Unus
				call RemoveSavedBoolean(MHT,hu,'A40K'+slot)//A40K -> Unus
			endif
		endif
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	else
		call SaveInteger(HY,h,100,c)
		if LoadInteger(MHT,hu,'A40K')!=aid and LoadInteger(MHT,hu,'A40K'+1)!=aid and LoadInteger(MHT,hu,'A40K'+2)!=aid and LoadInteger(MHT,hu,'A40K'+3)!=aid then//A40K -> Unus, A40K -> Unus, A40K -> Unus, A40K -> Unus
			call SetPlayerAbilityAvailable(GetOwningPlayer(u),aid,false)
		endif
	endif
	set t=null
	set u=null
endfunction

function Formless_DelayedClear takes unit u, integer aid1, integer slot returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.5,true,function Formless_Clear)
	call SetPlayerAbilityAvailable(GetOwningPlayer(u),aid1,false)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call SaveInteger(HY,GetHandleId(t),1,aid1)
	call SaveInteger(HY,GetHandleId(t),2,slot)
	call SaveInteger(MHT,GetHandleId(u),'A40K'+slot,0)//A40K -> Unus
	call RemoveSubSpellsFromUnit(u)
	set t=null
endfunction

function Formless_SpellEffect takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u
	local integer lvl=LoadInteger(HY,h,2)
	local integer i=LoadInteger(HY,h,3)
	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and GetSpellAbilityId()==LoadInteger(HY,h,0) then
		set i=i+1
		if i>=LoadInteger(HY,h,4) then
			set u=LoadUnitHandle(HY,h,0)
			call Formless_DelayedClear(u,LoadInteger(HY,h,0),LoadInteger(HY,h,1))
			call UnitRemoveAbility(u,LoadInteger(HY,h,1)+'A40O')
			call SetPlayerAbilityAvailable(GetOwningPlayer(u),LoadInteger(HY,h,0),false)
			set u=null
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		else
			call SaveInteger(HY,h,3,i)
		endif
	else
		set u=LoadUnitHandle(HY,h,0)
		if GetUnitAbilityLevel(u,'A40S'+LoadInteger(HY,h,1))!=GetUnitAbilityLevel(u,LoadInteger(HY,h,0)) then//A40S -> Unus
			call SetUnitAbilityLevel(u,LoadInteger(HY,h,0),GetUnitAbilityLevel(u,'A40S'+LoadInteger(HY,h,1)))//A40S -> Unus
		endif
		set u=null
	endif
	set t=null
endfunction

function Formless_AddSpell takes unit u, integer sid, integer castid, integer lvl returns nothing
	local trigger t
	local integer h
	if not UnitAddAbility2(u,SkillID[PlayerSkillNumber[sid]]) and GetUnitAbilityLevel(u,SkillID[PlayerSkillNumber[sid]])==0 then
		return
	endif
	set t=CreateTrigger()
	set h=GetHandleId(t)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function Formless_SpellEffect))
	call SaveUnitHandle(HY,h,0,u)
	call SaveInteger(HY,h,0,SkillID[PlayerSkillNumber[sid]])
	call SetUnitAbilityLevel(u,SkillID[PlayerSkillNumber[sid]],lvl)
	call SetPlayerAbilityAvailable(GetOwningPlayer(u),SkillID[PlayerSkillNumber[sid]],true)
	call SaveInteger(MHT,GetHandleId(u),'A40K'+castid,SkillID[PlayerSkillNumber[sid]])//A40K -> Unus
	call SaveInteger(HY,h,1,castid)
	call SaveInteger(HY,h,2,lvl)
	if CheckStacking(GetSkillIndex(sid),-1,"metamorphosis",null) then
		call SaveBoolean(MHT,GetHandleId(u),'A40K'+castid,true)//A40K -> Unus
	endif
	if castid==3 then
		call SaveInteger(HY,h,4,lvl)
	else
		call SaveInteger(HY,h,4,lvl+1)
	endif
	if (castid==3 and lvl<3) or (castid<3 and lvl<4) then
		call TriggerRegisterTimerEvent(t,1,true)
	endif
	call UnitAddAbility2(u,castid+'A40O')
	set t=null
endfunction

function Formless_SpellFilter takes unit u, integer sid, integer sindex returns boolean
	local integer i=GetPlayerId(GetOwningPlayer(u))
	local integer xx
	local integer k
	if isFormlessAbility(sid) or IsPoisonArrowSkill(sid) or isDummyAbility(sid) then
		return false
	endif
	if sid=='A3FQ' or sid=='A3FJ' or sid=='A0KX' or sid=='A0G8' or sid=='A07U' or sid=='A38E' or sid=='A0A5' or sid=='A0AG' or sid=='QM01' or sid=='A0BE' or sid=='A0EY' or sid=='A0NS' or sid=='A0H9' or sid=='A0NE' or sid=='A32E' or sid=='A21F' or sid=='A1S4' or sid=='A1NA' or sid=='A2QM' or sid=='A2TJ' or sid=='A2QI' or sid=='A2TI' or sid=='A06K' or sid=='A1T8' or sid=='A28Q' or sid=='A1TB' or sid=='A0MQ' or sid=='A2O2' or sid=='A0OO' or sid=='A14O' or sid=='A1EA' or sid=='QB03' or sid=='A27H' or sid=='A2JR' or sid=='Z234' or sid=='A0WQ' or sid=='A1C0' or sid=='A0MP' or sid=='A01Y' or sid=='A32Z' or sid=='A0SW' or sid=='A0LV' or sid=='A21M' or sid=='A40B' or sid=='A418' or sid=='A0ES' then//A0KX -> Morph, A0G8 -> Replicate, A07U -> Song of the Siren, A38E -> Song of the Siren, A0A5 -> Summon Spirit Bear, A0AG -> True Form, QM01 -> Spirit Form, A0BE -> Berserker Rage, A0EY -> Shadowraze, A0NS -> Borrowed Time, A0H9 -> Haunt, A0NE -> Voodoo Restoration, A32E -> Digest, A21F -> Pulse Nova, A1S4 -> Shadow Poison, A1NA -> Soul Assumption, A2QM -> Boulder Smash, A2TJ -> Rolling Boulder, A2QI -> Geomagnetic Grip, A2TI -> Magnetize, A06K -> Rot, A1T8 -> Spirits, A28Q -> Overcharge, A1TB -> Relocate, A0MQ -> Primal Split, A2O2 -> Trueshot Aura, A0OO -> Call of the Wild, A14O -> Ball Lightning, A1EA -> Refraction, QB03 -> Refraction, A27H -> Spell Steal, A2JR -> Fire Remnant, Z234 -> Spin Web, A0WQ -> Insatiable Hunger, A1C0 -> Splitshot, A0MP -> Mana Shield, A01Y -> Reincarnation, A32Z -> Devour, A0SW -> Infest, A0LV -> Test of Faith, A21M -> Whirling Axes, A40B -> Bloodlust, A418 -> Splitshot, A0ES -> Empowering Haste
		return false
	endif
	set xx=1
	loop
		if SkillID[PlayerSkillNumber[i*PlayerSkillOffset+xx]]==sid or CheckStacking(sindex,PlayerSkillNumber[i*PlayerSkillOffset+xx],null,null) then
			return false
		endif
		set xx=xx+1
		exitwhen xx>6
	endloop
	if CheckStacking(sindex,-1,"metamorphosis",null) and (isMorphedUnit(u) or LoadBoolean(MHT,GetHandleId(u),'A40K') or LoadBoolean(MHT,GetHandleId(u),'A40K'+1) or LoadBoolean(MHT,GetHandleId(u),'A40K'+2) or LoadBoolean(MHT,GetHandleId(u),'A40K'+3))then//A40K -> Unus, A40K -> Unus, A40K -> Unus, A40K -> Unus
		return false
	endif
	
	if (LoadInteger(MHT,GetHandleId(u),'A40K')==sid or LoadInteger(MHT,GetHandleId(u),'A40K'+1)==sid or LoadInteger(MHT,GetHandleId(u),'A40K'+2)==sid or LoadInteger(MHT,GetHandleId(u),'A40K'+3)==sid) then//A40K -> Unus, A40K -> Unus, A40K -> Unus, A40K -> Unus
		return false
	endif
	return true
endfunction

function Formless_SpellCast takes nothing returns nothing
	local integer i=0
	local integer iu=0
	local integer array a
	local integer array b
	local integer k=1
	local integer pid=0
	local integer xx=0
	local unit u=GetTriggerUnit()
	local integer casterpid=GetPlayerId(GetOwningPlayer(u))
	local integer castid=GetSpellAbilityId()-'A40K'//A40K -> Unus
	local integer rid=0
	local integer c=0
	if k==casterpid then
		set k=2
	endif
	loop
		set xx=1
		loop
			if PlayerSkillNumber[k*PlayerSkillOffset+xx]!=0 then
				if IsPassiveAbility[PlayerSkillNumber[k*PlayerSkillOffset+xx]]==false and Formless_SpellFilter(u,SkillID[PlayerSkillNumber[k*PlayerSkillOffset+xx]],PlayerSkillNumber[k*PlayerSkillOffset+xx]) then
					if xx==4 or xx==6 then
						set b[iu]=k*PlayerSkillOffset+xx
						set iu=iu+1
					else
						set a[i]=k*PlayerSkillOffset+xx
						set i=i+1
					endif
				endif
			endif
			set xx=xx+1
			exitwhen xx>PlayerSkillOffset
		endloop
		set k=k+1
		if k==casterpid then
			set k=k+1
		endif
		if k==6 then
			set k=7
		endif
		exitwhen k>11
	endloop
	if castid==3 then
		if iu>0 then
			set rid=b[GetRandomInt(0,iu-1)]
		endif
	else
		if i>0 then
			set rid=a[GetRandomInt(0,i-1)]
		endif
	endif
	if rid==0 then
		call Error(GetOwningPlayer(u),"Copy failed")
	else
		call Formless_AddSpell(u,rid,castid,GetUnitAbilityLevel(u,GetSpellAbilityId()))
	endif
	set u=null
endfunction

function UndyingZombieHeal takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	if IsDead(tt_unit2)==false then
		call SetWidgetLife(tt_unit2,GetWidgetLife(tt_unit2)+LoadReal(HY,h,'n020')*0.2)
	endif
endfunction

function UndyingZombie takes unit u returns nothing
	local trigger t
	if GetUnitTypeId(u)=='n020' and IsDead(udg_Hero[GetPlayerId(GetOwningPlayer(u))])==false then//n020 -> Living Dead
		set t=AddProjectile(u,udg_Hero[GetPlayerId(GetOwningPlayer(u))],'h00W',"UndyingZombieHeal",400,false)//h00W -> Necrolyte Projectile
		call SaveReal(HY,GetHandleId(t),'n020',GetUnitState(u,UNIT_STATE_MAX_LIFE))
		set t=null
	endif
endfunction

function Adaptiveness_Learn takes nothing returns nothing
	local integer i
	local integer k
	if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
		set i=GetUnitPrimaryAttribute(GetTriggerUnit())
		if GetUnitAbilityLevel(GetTriggerUnit(),'A440')>1 then
			set k=10
		else
			set k=15
		endif
		if i==1 then
			call SetHeroInt(GetTriggerUnit(),GetHeroInt(GetTriggerUnit(),false)+k,true)
		elseif i==2 then
			call SetHeroAgi(GetTriggerUnit(),GetHeroAgi(GetTriggerUnit(),false)+k,true)
		elseif i==3 then
			call SetHeroStr(GetTriggerUnit(),GetHeroStr(GetTriggerUnit(),false)+k,true)
		endif
	endif
endfunction

function Adaptiveness_Instagib takes unit attacker, unit target returns nothing
	if IsUnitType(target,UNIT_TYPE_HERO)==false and IsUnitType(target,UNIT_TYPE_ANCIENT)==false and IsUnitIllusion(target)==false and PRD_Get(attacker,'A43Z',10) then
		call DamageTarget(attacker,target,1,10000)
	endif
endfunction

function ScarabUrnaSwarmFilter takes nothing returns boolean
	if (GetUnitTypeId(GetFilterUnit())=='u012' or GetUnitTypeId(GetFilterUnit())=='u013') and IsDead(GetFilterUnit())==false then
		set tt_int1=tt_int1-1
		return true
	endif
	return false
endfunction

function ScarabUrnaSwarmEntering takes unit u returns nothing
	local player p=GetOwningPlayer(u)
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local real a=GetUnitFacing(u)
	local group g
	local integer lvl=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A00T')
	local real time=99999
	local unit u2=null
	if GetUnitAbilityLevel(u,'BFig')==1 then
		call KillUnit(u)
		call RemoveUnit(u)
		set tt_int1=1+lvl
		set g=GetAvailableGroup()
		call GroupEnumUnitsOfPlayer(g,p,Condition(function ScarabUrnaSwarmFilter))
		if tt_int1<1 then
			loop
				set u=FirstOfGroup(g)
				exitwhen u==null
				if LoadReal(HY,GetHandleId(u),'spwn') < time then
					set u2=u
					set time=LoadReal(HY,GetHandleId(u),'spwn')
				endif
				call GroupRemoveUnit(g,u)
			endloop
		endif
		call KillUnit(u2)
		call KillGroup(g)
		
		set u=CreateUnit(p,'u012',x,y,a)
		call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_EFFECT)
		if GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A0A8')>0 then
			call UnitAddAbility2(u,'A1HW')
		endif
		call SaveReal(HY,GetHandleId(u),'spwn',TimerGetElapsed(GlobalTimer))
		set u=null
	endif
endfunction

function WatcherGhostFilter takes nothing returns boolean
	if GetUnitTypeId(GetFilterUnit())=='ushd' and IsDead(GetFilterUnit())==false then
		set tt_int1=tt_int1-1
		return true
	endif
	return false
endfunction

function WatcherGhostEntering takes unit u returns nothing
	local player p=GetOwningPlayer(u)
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local real a=GetUnitFacing(u)
	local group g
	local integer lvl=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A43Y')
	local real time=99999
	local unit u2=null
	if GetUnitAbilityLevel(u,'BFig')==1 then
		call KillUnit(u)
		call RemoveUnit(u)
		set tt_int1=1+lvl*2
		set g=GetAvailableGroup()
		call GroupEnumUnitsOfPlayer(g,p,Condition(function WatcherGhostFilter))
		if tt_int1<1 then
			loop
				set u=FirstOfGroup(g)
				exitwhen u==null
				if LoadReal(HY,GetHandleId(u),'spwn') < time then
					set u2=u
					set time=LoadReal(HY,GetHandleId(u),'spwn')
				endif
				call GroupRemoveUnit(g,u)
			endloop
		endif
		call KillUnit(u2)
		call KillGroup(g)
		
		set u=CreateUnit(p,'ushd',x,y,a)
		call SaveReal(HY,GetHandleId(u),'spwn',TimerGetElapsed(GlobalTimer))
		set u=null
	endif
endfunction

function HEH takes nothing returns nothing
	local trigger t
	
	set t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddAction(t,function SH8)
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_LEVEL)
	call TriggerAddAction(t,function FixOverexp)
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddAction(t,function BYD)
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddAction(t,function BXD)
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
	call TriggerAddAction(t,function SpellPickingPreventOrders)
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_LEVEL)
	call TriggerAddAction(t,function Q08)
	if Mode_Debug then
		set t=CreateTrigger()
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
		call TriggerAddAction(t,function QU8)
		set t=CreateTrigger()
		call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
		call TriggerAddAction(t,function QT8)
		set t=CreateTrigger()
		call TriggerRegisterPlayerSelectionEventBJ(t,Player(1),true)
		call TriggerAddAction(t,function QS8)
	endif
	call RP8()
	call TriggerSleepAction(1)
	set t=null
endfunction


function Gnoll_Flux_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()

	if IsDead(t)==false and IsUnitAlly(group_temp_unit[0],GetOwningPlayer(t)) and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and t!=group_temp_unit[0] then//
		call SaveBoolean(MHT,99999,99999,false)
		set t = null
	endif

	set t = null
	return false
endfunction

function Gnoll_Flux_Duration takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local unit u = LoadUnitHandle(MHT,info,0)

	if count==120 or IsDead(u)then
		call DestroyEffect(LoadEffectHandle(MHT,info,2))
		call Timer_End(t)
		set t = null
		set u = null
		return
	endif

	call SaveInteger(MHT,info,0,count + 1)

	set group_temp_unit[0] = u
	call SaveBoolean(MHT,99999,99999,true)

	call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),250,Condition(function Gnoll_Flux_Targets))

	if LoadBoolean(MHT,99999,99999)then
		if GetUnitAbilityLevel(u,'D027')==0then
			call Buff_Add(u,'C027','D027',6 - count*0.05)
		endif
		if count/10 == count/10. then
			call DamageTarget(LoadUnitHandle(MHT,info,1),u,1,LoadReal(MHT,info,0))
		endif
	else
		call Buff_Remove(u,'D027')
	endif

	set t = null
	set u = null
endfunction

function Gnoll_Flux_Start takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local unit d = GetSpellTargetUnit()
	local integer info = GetHandleId(t)

	call SaveUnitHandle(MHT,info,0,d)
	call SaveUnitHandle(MHT,info,1,u)
	call SaveEffectHandle(MHT,info,2,AddSpecialEffectTarget("war3mapImported\\Flux3.mdx",d,"origin"))
	call SaveInteger(MHT,info,0,0)
	call SaveReal(MHT,info,0,GetUnitAbilityLevel(u,'A2M1')*7.5)//A2M1 -> Flux

	call TimerStart(t,0.05,true,function Gnoll_Flux_Duration)
	call Buff_Add(d,'C027','D027',6)

	set d = null
	set u = null
	set t = null
endfunction


function Gnoll_Field_Targets takes nothing returns nothing
	local integer key
	local integer info
	local unit u = GetFilterUnit()
	if IsUnitAlly(u,group_temp_player)and (IsUnitType(u,UNIT_TYPE_HERO)or IsUnitType(u,UNIT_TYPE_STRUCTURE))and GetUnitAbilityLevel(u,'A04R')==0 and IsDead(u)==false then//
		call GroupAddUnit(temp_group2,u)		 //adds the unit to group of currently affected units
		if IsUnitInGroup(u,group_temp_group)==false then  //hasn'u been affected by the field
			set info = GetHandleId(u)
			set key = StringHash("field_count")
			call Buff_Add(u,'C028','D028',-1) //adds the buff
			if IsUnitType(u,UNIT_TYPE_HERO)then
				call LoDStat_Add(u,group_temp_integer[0],"attack")
			else
				call LoDStat_Add(u,group_temp_integer[1],"attack")
			endif
			call SaveInteger(MHT,info,key,LoadInteger(MHT,info,key) + 1) //keeps track of the number of times the unit has been affected for field stacking
			call UnitAddAbility(u,'A515')
			call UnitMakeAbilityPermanent(u,true,'A515')
			call UnitMakeAbilityPermanent(u,true,'ACes')//ACes -> Evasion
			set u = null
			return
		endif
		call GroupRemoveUnit(group_temp_group,u) //removes the unit from the group of previously affected units
	endif
	set u = null
endfunction

function Gnoll_Field_Duration takes nothing returns nothing
	local unit u = null
	local timer t = GetExpiredTimer()
	local integer key = StringHash("field_count")
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local integer amount = LoadInteger(MHT,info,1)
	set group_temp_group = LoadGroupHandle(MHT,info,1)
	if count==0 then
		call DestroyEffect(LoadEffectHandle(MHT,info,2))
		loop
			set u = FirstOfGroup(group_temp_group)
			exitwhen u==null
			set info = GetHandleId(u)
			set count = LoadInteger(MHT,info,key)
			if count==1then
				call UnitRemoveAbility(u,'A515')
				call Buff_Remove(u,'D028')
			endif
			call SaveInteger(MHT,info,key,count - 1)
			call LoDStat_Sub(u,amount,"attack")
			call GroupRemoveUnit(group_temp_group,u)
		endloop
		call KillGroup(group_temp_group)
		call Timer_End(t)
		set t = null
		return
	endif
	call SaveInteger(MHT,info,0,count - 1)
	set group_temp_player = LoadPlayerHandle(MHT,info,0)
	set group_temp_integer[0] = amount
	set group_temp_integer[1] = amount/2
	call GroupEnumUnitsInRange(temp_group,LoadReal(MHT,info,0),LoadReal(MHT,info,1),325,Condition(function Gnoll_Field_Targets))
	//removes the bonuses from any unit out of range
	loop
		set u = FirstOfGroup(group_temp_group)
		exitwhen u==null
		set info = GetHandleId(u)
		set count = LoadInteger(MHT,info,key)
		if count==1then
			call UnitRemoveAbility(u,'A515')
			call Buff_Remove(u,'D028')
		endif
		call SaveInteger(MHT,info,key,count - 1)
		call LoDStat_Sub(u,amount,"attack")
		call GroupRemoveUnit(group_temp_group,u)
	endloop
	//updates the current group with the newly affected units
	loop
		set u = FirstOfGroup(temp_group2)
		exitwhen u==null
		call GroupRemoveUnit(temp_group2,u)
		call GroupAddUnit(group_temp_group,u)
	endloop
	set u=null
	set t = null
endfunction

function Gnoll_Field_Start takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local real x = GetSpellTargetX()
	local real y = GetSpellTargetY()
	local integer info = GetHandleId(t)
	local integer level = GetUnitAbilityLevel(u,'A2LM')//A2LM -> Magnetic Field

	call SavePlayerHandle(MHT,info,0,GetOwningPlayer(u))
	call SaveGroupHandle(MHT,info,1,GetAvailableGroup())
	call SaveEffectHandle(MHT,info,2,AddSpecialEffect("war3mapImported\\MagneticField04.mdl",x,y))
	call SaveInteger(MHT,info,0,30 + 5*level)
	call SaveInteger(MHT,info,1,40 + 10*level)
	call SaveReal(MHT,info,0,x)
	call SaveReal(MHT,info,1,y)

	call TimerStart(t,0.1,true,function Gnoll_Field_Duration)
	call EvasionSourceActivate(EVASION_SOURCE_ARCWARDEN,6)
	set t = null
	set u = null
endfunction


function Gnoll_Spark_Closest takes unit u returns nothing
	local real x = GetWidgetX(u) - group_temp_real[0]
	local real y = GetWidgetY(u) - group_temp_real[1]
	local real d = SquareRoot(x*x + y*y)

	if group_temp_real[2] > d then
		set group_temp_real[2] = d
		set group_temp_unit[0] = u
	endif
endfunction

function Gnoll_Spark_Targets takes nothing returns boolean
	local unit t = GetFilterUnit()

	if IsUnitEnemy(t,group_temp_player) and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and IsDead(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then//
		call Gnoll_Spark_Closest(t)
	endif

	set t = null
	return false
endfunction

function Gnoll_Spark_Chase takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local unit u1 = LoadUnitHandle(MHT,info,0)
	local unit u2 = LoadUnitHandle(MHT,info,1)
	local real x2
	local real y2
	local real x1
	local real y1

	if IsDead(u2)then
		call KillUnit(u1)

		call Timer_End(t)
		set u2 = null
		set u1 = null
		set t = null
		return
	endif

	set x1 = GetWidgetX(u1)
	set y1 = GetWidgetY(u1)
	set x2 = x1 - GetWidgetX(u2)
	set y2 = y1 - GetWidgetY(u2)

	if 15>SquareRoot(x2*x2 + y2*y2)then
		call DamageTarget(LoadUnitHandle(MHT,info,3),u2,1,LoadInteger(MHT,info,1))
		call KillUnit(u1)

		call Timer_End(t)
		set u2 = null
		set u1 = null
		set t = null
		return
	endif

	set x2 = Atan2(-y2,-x2)

	call SetUnitX(u1,x1 + 10.625*Cos(x2))
	call SetUnitY(u1,y1 + 10.625*Sin(x2))

	set u2 = null
	set u1 = null
	set t = null
endfunction

function Gnoll_Spark_Duration takes nothing returns nothing
	local unit u = null
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	if count==1000 then
		call KillUnit(LoadUnitHandle(MHT,info,0))
		call Timer_End(t)
		set t = null
		return
	endif
	set group_temp_player = LoadPlayerHandle(MHT,info,2)
	set group_temp_unit[0] = null
	set group_temp_real[0] = LoadReal(MHT,info,0)
	set group_temp_real[1] = LoadReal(MHT,info,1)
	set group_temp_real[2] = 450
	call GroupEnumUnitsInRange(temp_group,group_temp_real[0],group_temp_real[1],400,Condition(function Gnoll_Spark_Targets))
	call SaveInteger(MHT,info,0,count + 1)
	if group_temp_unit[0]!=null then
		set u = LoadUnitHandle(MHT,info,0)
		call SetUnitAnimationByIndex(u,2)
		call SetTint(u,-1,-1,-1,150)
		call SaveUnitHandle(MHT,info,1,group_temp_unit[0])
		call TimerStart(t,0.025,true,function Gnoll_Spark_Chase)
		set u = null
	endif
	set t = null
endfunction

function Gnoll_Spark_Delay takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)

	call TimerStart(t,0.05,true,function Gnoll_Spark_Duration)

	call SetUnitAnimationByIndex(LoadUnitHandle(MHT,info,0),1)

	set t = null
endfunction

function Gnoll_Spark_Start takes nothing returns nothing
	local timer t = CreateTimer()
	local unit u = GetTriggerUnit()
	local player p = GetOwningPlayer(u)
	local real x = GetSpellTargetX()
	local real y = GetSpellTargetY()
	local unit d = CreateUnit(p,'h0EG',x,y,270)//h0EG -> Lightning Seeker Spark effect
	local integer info = GetHandleId(t)

	call UnitAddAbility(d,'Aloc')//Aloc -> Locust
	call UnitAddAbility(d,'A04R')//
	call UnitAddAbility(d,'Arav')//Arav -> Storm Crow Form

	call SaveUnitHandle(MHT,info,0,d)
	call SaveUnitHandle(MHT,info,3,u)
	call SavePlayerHandle(MHT,info,2,p)
	call SaveInteger(MHT,info,0,0)
	call SaveInteger(MHT,info,1,100 + 50*GetUnitAbilityLevel(u,'A2LL'))//A2LL -> Spark Wraith
	call SaveReal(MHT,info,0,x)
	call SaveReal(MHT,info,1,y)

	call SetUnitAnimationByIndex(d,0)

	call TimerStart(t,3,false,function Gnoll_Spark_Delay)

	set p = null
	set d = null
	set u = null
	set t = null
endfunction


function Func4152 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit tempest=(LoadUnitHandle(HY,h,17))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call FlushChildHashtable(HY,(GetHandleId(tempest)))
	call RemoveUnit(tempest)
	set t=null
	set tempest=null
	return false
endfunction

function Func4153 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit tempest=(LoadUnitHandle(HY,h,2))
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	call FlushChildHashtable(HY,(GetHandleId(tempest)))
	call ShowUnit(tempest,false)
	set t=null
	set tempest=null
	return false
endfunction

function Func4154 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local unit tempest=(LoadUnitHandle(HY,h,17))
	local integer lvl=GetUnitAbilityLevel(caster,'A2M0')//A2M0 -> Tempest Double
	if GetTriggerEvalCount(t)==200 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		call KillUnit(tempest)
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",GetUnitX(tempest),GetUnitX(tempest)))
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call SaveUnitHandle(HY,h,2,(tempest))
		call TriggerRegisterTimerEvent(t,0,false)
		call TriggerAddCondition(t,Condition(function Func4153))
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,3,false)
		call TriggerAddCondition(t,Condition(function Func4152))
		call SaveUnitHandle(HY,h,17,(tempest))
	else
		call SuspendHeroXP(tempest,true)
		call UnitModifySkillPoints(tempest,-25)
	endif
	set t=null
	set caster=null
	set tempest=null
	return false
endfunction

function Zet_Tempest_Start takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit tempest
	local integer lvl=GetUnitAbilityLevel(caster,'A2M0')//A2M0 -> Tempest Double
	local integer i=0
	local item it
	local integer dummyItemId='I02M'//I02M -> Dummy Item Scourge
	local integer pid=GetPlayerId(GetOwningPlayer(caster))
	set TempestIncoming=true
//	call echo(B2S(TempestIncoming))
	call DisableTrigger(HeroEnters)
	set tempest=CreateUnit(GetOwningPlayer(caster),GetUnitTypeId(caster),GetUnitX(caster),GetUnitY(caster),0)
	call EnableTrigger(HeroEnters)
	//call Tempest5thStkill(tempest)
	//call SetUnitVertexColor(tempest,255,255,255,130)
	call SetTint(tempest,-1,-1,-1,130)
	call SaveBoolean(HY,GetHandleId(tempest),TEMPEST,true)
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",tempest,"chest"))
	call SelectUnitAddForPlayer(tempest,GetOwningPlayer(caster))
	call DisableTrigger(t_manipulateitem)
	loop
		exitwhen i>5
		if UnitItemInSlot(caster,i)!=null and GetItemTypeId(UnitItemInSlot(caster,i))!=Item_Real[Aegis]and GetItemTypeId(UnitItemInSlot(caster,i))!=Item_Real[RefresherOrb]and GetItemTypeId(UnitItemInSlot(caster,i))!=Item_Real[ObserverWards]and GetItemTypeId(UnitItemInSlot(caster,i))!=Item_Real[SentryWards]and GetItemTypeId(UnitItemInSlot(caster,i))!=Item_Real[Smoke]then
			set it=CreateItem(GetItemTypeId(UnitItemInSlot(caster,i)),0,0)
			if GetItemCharges(UnitItemInSlot(caster,i))>0 then
				call SetItemCharges(it,GetItemCharges(UnitItemInSlot(caster,i)))
			endif
			call UnitAddItem(tempest,it)
			call SetItemPlayer(it,GetOwningPlayer(tempest),false)
			if GetItemTypeId(it)==Item_Real[DivineRapier]or GetItemTypeId(it)==Item_Real[DivineRapierFree]or GetItemTypeId(it)==Item_Real[Gem]then
				call SetItemDropOnDeath(it,false)
			endif
		else
			call UnitAddItem(tempest,CreateItem(dummyItemId,0,0))
		endif
		set i=i+1
	endloop
	call EnableTrigger(t_manipulateitem)
	call SetHeroLevel(tempest,GetHeroLevel(caster),false)
	set i=1
	loop
		exitwhen i>GetUnitAbilityLevel(caster,'Aamk')//Aamk -> Attribute Bonus
		call SelectHeroSkill(tempest,'Aamk')//Aamk -> Attribute Bonus
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>GetUnitAbilityLevel(caster,'A0NR')//Aamk -> Attribute Bonus
		call SelectHeroSkill(tempest,'A0NR')//Aamk -> Attribute Bonus
		set i=i+1
	endloop
	call UnitAddAbility2(tempest,EngineeringUpgradeSkillID[PlayerSkillNumber[pid*PlayerSkillOffset+1]])
	call UnitAddAbility2(tempest,EngineeringUpgradeSkillID[PlayerSkillNumber[pid*PlayerSkillOffset+2]])
	call UnitAddAbility2(tempest,EngineeringUpgradeSkillID[PlayerSkillNumber[pid*PlayerSkillOffset+3]])
	call UnitAddAbility2(tempest,EngineeringUpgradeSkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]])
	
	set i=1
	loop
		exitwhen i>GetUnitAbilityLevel(caster,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+1]])
		call SelectHeroSkill(tempest,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+1]])
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>GetUnitAbilityLevel(caster,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+2]])
		call SelectHeroSkill(tempest,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+2]])
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>GetUnitAbilityLevel(caster,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+3]])
		call SelectHeroSkill(tempest,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+3]])
		set i=i+1
	endloop
	set i=1
	loop
		exitwhen i>GetUnitAbilityLevel(caster,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]])
		call SelectHeroSkill(tempest,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]])
		set i=i+1
	endloop
	call UnitRemoveAbility(tempest,'A2M0')//A2M0 -> Tempest Double
	call UnitModifySkillPoints(tempest,-25)
	call SuspendHeroXP(tempest,true)
	call TriggerRegisterTimerEvent(t,0.1,true)
	call TriggerRegisterDeathEvent(t,tempest)
	call TriggerAddCondition(t,Condition(function Func4154))
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveUnitHandle(HY,h,17,(tempest))
	call SetWidgetLife(caster,GetWidgetLife(caster)*(1-(0.45-0.15*lvl)))
	call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA)*(1-(0.45-0.15*lvl)))
	call SetWidgetLife(tempest,GetWidgetLife(caster))
	call SetUnitState(tempest,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA))
	set TempestIncoming=false
	set caster=null
	set tempest=null
	set t=null
	set it=null
endfunction


function Wyvern_Burn_Buff takes unit u returns boolean
	return GetUnitAbilityLevel(u,'D100')==1 or GetUnitAbilityLevel(u,'D101')==1 or GetUnitAbilityLevel(u,'D102')==1 or GetUnitAbilityLevel(u,'D103')==1//D100 -> |cffff0000Arctic Burn|r, D101 -> |cffff0000Arctic Burn|r, D102 -> |cffff0000Arctic Burn|r, D103 -> |cffff0000Arctic Burn|r
endfunction

function Wyvern_Burn_Duration takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local unit u = LoadUnitHandle(MHT,info,0)
	local real life
	if count==4 or IsDead(u) or Wyvern_Burn_Buff(u)==false then
		call DestroyEffect(LoadEffectHandle(MHT,info,1))
		call Timer_End(t)
		set t = null
		set u = null
		return
	endif
	set life = GetWidgetLife(u)
	set life = life - life*0.09
	if 0.405 > life then
		set life = 0.406
	endif
	call SetWidgetLife(u,life)
	call SaveInteger(MHT,info,0,count + 1)
	set t = null
	set u = null
endfunction

function Wyvern_Burn_Effect takes unit u, unit d, integer level returns nothing
	local timer t = CreateTimer()
	local integer info = GetHandleId(t)
	call Buff_Add(d,'C100' + level,'D100' + level,5)//D100 -> |cffff0000Arctic Burn|r
	call SaveUnitHandle(MHT,info,0,d)
	call SaveEffectHandle(MHT,info,1,AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostDamage\\FrostDamage.mdl",d,"chest"))
	call SaveInteger(MHT,info,0,0)
	call TimerStart(t,1,true,function Wyvern_Burn_Duration)
	set t = null
endfunction

function Wyvern_Burn_Damage_Detect takes nothing returns nothing
	local unit u = null
	local trigger t = GetTriggeringTrigger()
	local integer h = GetHandleId(t)
	if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
		call CleanTrigger(t)
		call FlushChildHashtable(MHT,h)
		set t = null
		return
	endif
	set u = GetEventDamageSource()
	if u==LoadUnitHandle(MHT,h,0) and GetEventDamage()>5 then
		if Wyvern_Burn_Buff(GetTriggerUnit())==false then
			call Wyvern_Burn_Effect(u,GetTriggerUnit(),LoadInteger(MHT,h,0)-1)
		endif
		call CleanTrigger(t)
		call FlushChildHashtable(MHT,h)
	endif
	set t = null
	set u = null
endfunction

function Wyvern_Burn_Damage_Start takes unit u, unit t returns nothing
	local trigger trig = CreateTrigger()
	call SaveUnitHandle(MHT,GetHandleId(trig),0,u)
	call TriggerRegisterUnitEvent(trig,t,EVENT_UNIT_DAMAGED)
	call TriggerRegisterTimerEvent(trig,3,false)
	call SaveInteger(MHT,GetHandleId(trig),0,GetUnitAbilityLevel(u,'A332'))//A332 -> Arctic Burn
	call TriggerAddCondition(trig,Condition(function Wyvern_Burn_Damage_Detect))
	set trig = null
endfunction

function Wyvern_Burn_Attack_Condition takes unit u, unit t returns nothing
	if GetUnitAbilityLevel(u,'D029')==1 and GetUnitAbilityLevel(t,'A04R')==0 and Wyvern_Burn_Buff(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(u,GetOwningPlayer(t)) and GetUnitTypeId(t)!='n00L'then//, n00L -> Roshan
		call Wyvern_Burn_Damage_Start(u,t)
	endif
endfunction

function Wyvern_Burn_End takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local unit u = LoadUnitHandle(MHT,info,0)
	local integer lvl
	local integer h
	if IsDead(u)==false and LoadBoolean(MHT,GetHandleId(u),StringHash("morphedburn")) then
		call UnMorphUnit(u,LoadInteger(MHT,info,1))
		call UnMorphUnit(u,LoadInteger(MHT,info,0))
		call KillTrees(GetWidgetX(u),GetWidgetY(u),150)
		call SaveBoolean(MHT,GetHandleId(u),StringHash("morphedburn"),false)
		call SaveInteger(MHT,GetHandleId(u),StringHash("morphedburn"),0)
		call RemoveAbilsForUnit(u)
		if GetUnitAbilityLevel(u,'A2AI')>0 then//A2AI -> Dragon Tail
			call UnitRemoveAbility(u,'QF0O')
			call SetUnitAbilityLevel(u,'QB0G',GetUnitAbilityLevel(u,'A2AI'))//QB0G -> Dragon Tail, A2AI -> Dragon Tail
		endif
		call Timer_End(t)
	elseif IsDead(u) and LoadBoolean(MHT,GetHandleId(u),StringHash("morphedburn")) then
		call TimerStart(t,1,true,function Wyvern_Burn_End)
	endif
	set t = null
	set u = null
endfunction

function Wyvern_Burn_Start takes nothing returns nothing
	local unit u = GetTriggerUnit()
	if GetUnitTypeId(u)!='N0MA' and GetUnitTypeId(u)!='N0MO' and GetUnitTypeId(u)!='N0MB' and GetUnitTypeId(u)!='N0MC' then//N0MA -> Winter Wyvern, N0MO -> Winter Wyvern, N0MB -> Winter Wyvern, N0MC -> Winter Wyvern
		call RemoveAbilsForUnit(u)
		call Buff_Add(u,'C029','D029',6)
	else
		call KillTrees(GetUnitX(u),GetUnitY(u),200)
	endif
	set u = null
endfunction

function SplinterBlast_TargetsAvailable takes nothing returns boolean
	return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())
endfunction

function Func4060 takes nothing returns nothing
	local integer h=GetHandleId(GetTriggeringTrigger())
	local unit caster=LoadUnitHandle(HY,h,2)
	local unit target=TempTarget
	local integer lvl=LoadInteger(HY,h,0)
	if IsMagicImmune(target)==false then
		call DamageTarget(caster,target,1,20+80*lvl)
		call Buff_Add(target,'C030','D030',4)
		call AddTimedAbility(target,'A2MJ',1,4)//A2MJ -> Frost Wyrm Split - Slow
	endif
	set caster=null
	set target=null
endfunction

function Func4061 takes nothing returns nothing
	local unit u=Wyvern_SplinterBlast_InitialCaster
	local unit target=GetEnumUnit()
	local trigger t=CreateDummyProjectile(Wyvern_SplinterBlast_Helper,target,'h0EC',"Func4060",600)//h0EC -> Ring of Aquila
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,2,u)
	call SaveInteger(HY,h,0,tt_int1)
	set u=null
	set target=null
	set t=null
endfunction

function Func4062 takes unit caster,unit target, integer lvl, boolean lotus returns nothing
	local group g=GetAvailableGroup()
	set tt_unit1=caster
	set Wyvern_SplinterBlast_InitialCaster=caster
	set Wyvern_SplinterBlast_Helper=target
	set tt_int1=lvl
	call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),525,Condition(function SplinterBlast_TargetsAvailable))
	call GroupRemoveUnit(g,target)
	call ForGroup(g,function Func4061)
	call KillGroup(g)
	if GetUnitAbilityLevel(target,'A3E9')==1 and lotus==false and IsMagicImmune(caster) then
		call SaveUnitHandle(TempHash,'A3E9',0,target)
		call SaveUnitHandle(TempHash,'A3E9',1,caster)
		call SaveInteger(TempHash,'A3E9',0,lvl)
		call ExecuteFunc("Wyvern_SplinterBlast_LotusOrb")
	endif
	set caster=null
	set target=null
	set g=null
endfunction

function Func4063 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,2)
	local unit target=LoadUnitHandle(HY,h,17)
	local unit proj=LoadUnitHandle(HY,h,45)
	local real px=GetUnitX(proj)
	local real py=GetUnitY(proj)
	local real tx=GetUnitX(target)
	local real ty=GetUnitY(target)
	local real distance=DistanceBetweenXY(tx,ty,px,py)
	local integer count=GetTriggerEvalCount(t)
	local real angle=AngleBetweenXY(px,py,tx,ty)
	local real newX
	local real newY
	local real speed=distance/((1.0/.02)-count)
	if speed < 650*0.02 then
		set speed=650*0.02
	endif
	set newX=px+speed*Cos(angle*bj_DEGTORAD)
	set newY=py+speed*Sin(angle*bj_DEGTORAD)
	call SetUnitX(proj,newX)
	call SetUnitY(proj,newY)
	call SetUnitFacing(proj,angle)
	if DistanceBetweenXY(tx,ty,newX,newY)<=speed then
		call KillUnit(proj)
		call Func4062(caster,target,LoadInteger(HY,h,0),LoadBoolean(HY,h,0))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
	endif
	set t=null
	set target=null
	set caster=null
	set proj=null
	return false
endfunction

function Wyvern_SplinterBlast_Start takes unit caster, unit target, integer lvl, boolean lotus returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local unit proj=CreateUnit(GetOwningPlayer(caster),'e01E',GetUnitX(caster),GetUnitY(caster),0)//e01E -> Acid Spray Model
	call TriggerRegisterTimerEvent(t,0.02,true)
	call TriggerAddCondition(t,Condition(function Func4063))
	call SaveUnitHandle(HY,h,2,caster)
	call SaveInteger(HY,h,0,lvl)
	call SaveBoolean(HY,h,0,lotus)
	call SaveUnitHandle(HY,h,17,target)
	call SaveUnitHandle(HY,h,45,proj)
	set proj=null
	set t=null
endfunction

function Wyvern_SplinterBlast_StartWrapper takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
	if IsBlocked(target)==false then
		call Wyvern_SplinterBlast_Start(caster,target,lvl,false)
	endif
	set caster=null
	set target=null
endfunction

function Wyvern_SplinterBlast_LotusOrb takes nothing returns nothing
	local unit caster=LoadUnitHandle(TempHash,'A3E9',0)
	local unit target=LoadUnitHandle(TempHash,'A3E9',1)
	local integer lvl=LoadInteger(TempHash,'A3E9',0)
	call LotusOrbFX(LoadUnitHandle(TempHash,'A3E9',0))
	if IsBlocked(target)==false then
		call Wyvern_SplinterBlast_Start(caster,target,lvl,true)
	endif
	set caster=null
	set target=null
	call FlushChildHashtable(TempHash,'A3E9')
endfunction


function Wyvern_Embrace_Duration takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local unit u = LoadUnitHandle(MHT,info,0)
	if count==40 or IsDead(u) or IsUnitHidden(u) or (IsUnitDisabled(u)==false and count>4) then
		set count = 1
		loop
			exitwhen count==10
			call DestroyEffect(LoadEffectHandle(MHT,info,count))
			set count = count + 1
		endloop
		set info = GetHandleId(u)
		set count = LoadInteger(MHT,info,'A516')
		if count==1then
			call UnitRemoveAbility(u,'A516')
		endif
		call SaveInteger(MHT,info,'A516',count - 1)
		call Timer_End(t)
		set t = null
		set u = null
		return
	endif
	call SetWidgetLife(u,GetWidgetLife(u) + 2 + GetUnitState(u,UNIT_STATE_MAX_LIFE)*LoadReal(MHT,info,0))
	call SaveInteger(MHT,info,0,count + 1)
	set t = null
	set u = null
endfunction

function Wyvern_Embrace_Start takes nothing returns nothing
	local timer t = null
	local integer info
	local unit u = GetTriggerUnit()
	local unit u2 = GetSpellTargetUnit()
	local unit dummy=CreateUnit(GetOwningPlayer(u2),'e00E',GetUnitX(u2),GetUnitY(u2),0)//e00E -> Spellcaster
	call UnitAddAbility(dummy,'A2LG')//A2LG -> Frostwyrm Trap Stun
	if IssueTargetOrder(dummy,"thunderbolt",u2) then 
		set t = CreateTimer()
		set info = GetHandleId(t)
		call SaveUnitHandle(MHT,info,0,u2)
		call SaveReal(MHT,info,0,GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A2LB')*0.001 + 0.002)//A2LB -> Cold Embrace
		call SaveInteger(MHT,info,0,0)
		call SaveEffectHandle(MHT,info,1,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"hand right"))
		call SaveEffectHandle(MHT,info,2,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"hand left"))
		call SaveEffectHandle(MHT,info,3,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"foot right"))
		call SaveEffectHandle(MHT,info,4,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"foot left"))
		call SaveEffectHandle(MHT,info,5,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"foot right mount rear"))
		call SaveEffectHandle(MHT,info,6,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"foot left mount rear"))
		call SaveEffectHandle(MHT,info,7,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"head"))
		call SaveEffectHandle(MHT,info,8,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"chest"))
		call SaveEffectHandle(MHT,info,9,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,GetProperAttachPoint_Weapon(u2)))
		call UnitAddAbility(u2,'A516')
		call SaveInteger(MHT,GetHandleId(u2),'A516',LoadInteger(MHT,GetHandleId(u2),'A516') + 1) //for multicast stacking
		call TimerStart(t,0.1,true,function Wyvern_Embrace_Duration)
		set t = null
	endif
	set dummy=null
	set u2 = null
	set u = null
	set t = null
endfunction

function Wyvern_Curse_Reorder takes unit u returns nothing
	if GetUnitAbilityLevel(u,'D031')>0 and UnitIsSleeping(u)==false and GetUnitAbilityLevel(u,'B008')==0 and HW8==false then//B008 -> Shackles
		call DisableTrigger(GAME_TRIGGER)
		call IssueTargetOrder(u,"attack",LoadUnitHandle(MHT,GetHandleId(u),'A0Z0'))//A0Z0 -> Winter's Curse
		call EnableTrigger(GAME_TRIGGER)
	endif
endfunction

function Wyvern_Curse_ForceAttack takes nothing returns nothing
	local unit u=GetEnumUnit()
	call DisableTrigger(trig_WintersCurse)
	call UnitWakeUp(u)
	call IssueTargetOrder(u,"attack",unit_WinterCurseTarget)
	call EnableTrigger(trig_WintersCurse)
	set u=null
endfunction

function Wyvern_Curse_AddKeys takes nothing returns nothing
	call AddTimedKeyToUnit(GetEnumUnit(),4328,0.75)
	if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
		call SelectUnitAddForPlayer(GetEnumUnit(),GetOwningPlayer(GetEnumUnit()))
	endif
endfunction

function Wyvern_Curse_ForGroup takes nothing returns nothing
	local unit u=GetEnumUnit()
	if IsUnitInGroup(u,group_WinterCurse)==false then
		call GroupAddUnit(group_WinterCurse,u)
		call TriggerRegisterUnitEvent(trig_WintersCurse,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
		call TriggerRegisterUnitEvent(trig_WintersCurse,u,EVENT_UNIT_ISSUED_POINT_ORDER)
		call TriggerRegisterUnitEvent(trig_WintersCurse,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
		call SaveInteger(HY,GetHandleId(u),4328,1)
	endif
	set u=null
endfunction

function Wyvern_Curse_Duration takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=(LoadUnitHandle(HY,h,2))
	local unit target=(LoadUnitHandle(HY,h,17))
	local integer lvl=(LoadInteger(HY,h,5))
	local integer counter=(LoadInteger(HY,h,34))
	local group g=(LoadGroupHandle(HY,h,22))
	local group gg
	if GetTriggerEventId()!=EVENT_UNIT_ISSUED_TARGET_ORDER and GetTriggerEventId()!=EVENT_UNIT_ISSUED_POINT_ORDER and GetTriggerEventId()!=EVENT_UNIT_ISSUED_TARGET_ORDER then
		set counter=counter+1
		call SaveInteger(HY,h,34,(counter))
		set group_WinterCurse=g
		set trig_WintersCurse=t
		set gg=GetAvailableGroup()
		set tt_unit1=caster
		call GroupEnumUnitsInRange(gg,GetUnitX(target),GetUnitY(target),375,Condition(function NonImmuneEnemyFilter))
		call GroupRemoveUnit(gg,target)
		call ForGroup(gg,function Wyvern_Curse_ForGroup)
		call KillGroup(gg)
		if counter==(2.25+0.25*lvl)*20 or IsDead(target)then
			call ForGroup(g,function Wyvern_Curse_AddKeys)
			call UnitRemoveAbility(target,'A342')
			call KillGroup(g)
			//call DestroyEffect((LoadEffectHandle(HY,h,32)))
			call DestroyEffect((LoadEffectHandle(HY,h,176)))
			call FlushChildHashtable(HY,h)
			call CleanTrigger(t)
		else
			set trig_WintersCurse=t
			set unit_WinterCurseTarget=target
			call ForGroup(g,function Wyvern_Curse_ForceAttack)
//			if ModuloInteger(counter,20)==0 or counter==0 then
//			endif
		endif
	else
		if UnitIsSleeping(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),'B008')==0 and GetIssuedOrderId()!=851973 then//B008 -> Shackles
			call DisableTrigger(t)
			call ClearSelectionForPlayer(GetOwningPlayer(GetTriggerUnit()))
			call IssueTargetOrder(GetTriggerUnit(),"attack",target)
			call EnableTrigger(t)
		endif
	endif
	set t=null
	set caster=null
	set target=null
	set g=null
	set gg=null
	return false
endfunction

function Wyvern_Curse_Acts takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	local integer lvl=GetUnitAbilityLevel(caster,'A0Z0')//A0Z0 -> Winter's Curse
	local unit target=GetSpellTargetUnit()
	local unit dummy=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
	if GetUnitAbilityLevel(caster,'Aloc')==1 and HaveSavedHandle(HY,GetHandleId(caster),0) then//Aloc -> Locust
		set caster=LoadUnitHandle(HY,GetHandleId(caster),0)
	endif
	set unit_WinterCurseCaster=caster
	call UnitAddAbility2(target,'A342')
	call UnitAddAbility(dummy,'A2NJ')//A2NJ -> Winter's Curse Stun
	call SetUnitAbilityLevel(dummy,'A2NJ',lvl)//A2NJ -> Winter's Curse Stun
	call IssueTargetOrder(dummy,"thunderbolt",target)
	call TriggerRegisterTimerEvent(t,0.05,true)
	call SaveUnitHandle(HY,h,2,(caster))
	call SaveUnitHandle(HY,h,17,(target))
	call SaveInteger(HY,h,5,(lvl))
	call SaveGroupHandle(HY,h,22,(GetAvailableGroup()))
	//call SaveEffectHandle(HY,h,32,(AddSpecialEffectTarget("war3mapImported\\WintersCurse.mdx",target,"overhead")))
	call SaveEffectHandle(HY,h,176,(AddSpecialEffect("war3mapImported\\WintersCurseAoE.mdx",GetUnitX(target),GetUnitY(target))))
	call TriggerAddCondition(t,Condition(function Wyvern_Curse_Duration))
	set caster=null
	set target=null
	set dummy=null
	set t=null
endfunction

function Wyvern_Curse_Real_Start takes nothing returns nothing
	if IsBlocked(GetSpellTargetUnit())==false then
		call Wyvern_Curse_Acts()
	endif
endfunction

function Shadow_Amulet_Effect takes nothing returns nothing
	local unit d = null
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local integer count = LoadInteger(MHT,info,0)
	local unit u = LoadUnitHandle(MHT,info,0)
	if IsDead(u) or (GetUnitAbilityLevel(u,'B0G8')==0 and count > LoadInteger(MHT,info,2)) or (LoadBoolean(MHT,info,0) and (LoadReal(MHT,info,0)!=GetWidgetX(u) or LoadReal(MHT,info,1)!=GetWidgetY(u))) then//B0G8 -> Shadow Amulet
		call SaveBoolean(MHT,GetHandleId(u),'A2N5',false)//A2N5 -> Shadow Amulet Invis Caster
		call UnitRemoveAbility(u,'B0G8')//B0G8 -> Shadow Amulet
		call Timer_End(t)
		set t = null
		set u = null
		return
	endif
	if count==LoadInteger(MHT,info,2) then
		set d = CreateUnit(Player(15),'e00E',0,0,0)//e00E -> Spellcaster
		call UnitAddAbility(d,'A2N5')//A2N5 -> Shadow Amulet Invis Caster
		call RemoveEndlessFadetime(u)
		call IssueTargetOrder(d,"invisibility",u)
		call SaveBoolean(MHT,GetHandleId(u),'A2N5',false)//A2N5 -> Shadow Amulet Invis Caster
		set d = null
		call IssueImmediateOrder(u,"holdposition")
		call SaveReal(MHT,info,0,GetWidgetX(u))
		call SaveReal(MHT,info,1,GetWidgetY(u))
		call SaveBoolean(MHT,info,0,true)
	endif

	call SaveInteger(MHT,info,0,count + 1)

	set t = null
	set u = null
endfunction

function Shadow_Amulet_Setup takes nothing returns nothing
	local timer t = GetExpiredTimer()
	local integer info = GetHandleId(t)
	local unit u = LoadUnitHandle(MHT,info,0)
	call SaveInteger(MHT,info,0,0)
	call SaveInteger(MHT,info,2,R2I(1.5/0.05))
	call TimerStart(t,0.05,true,function Shadow_Amulet_Effect)
	set t = null
	set u = null
endfunction

function Shadow_Amulet_Start takes unit u returns nothing
	local timer t = CreateTimer()
	local string s = ""
	if GetOwningPlayer(u)==GetLocalPlayer()then
		set s = "Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayTarget.mdl"
	endif

	call DestroyEffect(AddSpecialEffectTarget(s,u,"chest"))
	call DestroyEffect(AddSpecialEffectTarget(s,u,"hand,left"))
	call DestroyEffect(AddSpecialEffectTarget(s,u,"hand,right"))

	call SaveUnitHandle(MHT,GetHandleId(t),0,u)
	call TimerStart(t,0.01,false,function Shadow_Amulet_Setup)

	set t = null
endfunction

function Shadow_Amulet_Condition takes nothing returns nothing
	local unit u = GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local integer info = GetHandleId(target)
	if target==null and GetSpellTargetItem()!=null then
		set target=u
		set info = GetHandleId(target)
	endif
	if target!=null then
		if LoadBoolean(MHT,info,'A2N5')==false then//A2N5 -> Shadow Amulet Invis Caster
			call SaveBoolean(MHT,info,'A2N5',true)//A2N5 -> Shadow Amulet Invis Caster
			call Shadow_Amulet_Start(target)
		endif
	endif
	set target=null
	set u = null
endfunction

function CrimsonGuard_Filter takes nothing returns boolean
	return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and IsDead(GetFilterUnit())==false and LoadInteger(HY,GetHandleId(GetFilterUnit()),'CRMS')!=1
endfunction

function CrimsonGuard_Defense takes nothing returns nothing
	call AddTimedKeyToUnit(GetEnumUnit(),'CRMS',70)
	call AddTimedAbility(GetEnumUnit(),'A42L',1,10)
	call UnitMakeAbilityPermanent(GetEnumUnit(),true,'A42K')
	call UnitAddAbilityTimedEx(GetEnumUnit(),'A42N',1,10,'B0HG')//B0HG -> |cff32cd32Crimson Guard|r
	//call UnitAddAbilityTimedEx(GetEnumUnit(),'A45A',1,10,0)
endfunction

function CrimsonGuard_Act takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local group g=GetAvailableGroup()
	set tt_unit1=u
	call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),900+25,Condition(function CrimsonGuard_Filter))
	call ForGroup(g,function CrimsonGuard_Defense)
	
	call KillGroup(g)
	set u=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)//e00E -> Spellcaster
	call UnitAddAbility(u,'AIda')//AIda -> Item Temporary Area Armor Bonus
	call IssueImmediateOrderById(u,852269)
	set g=null
	set u=null
endfunction

function Butterfly_FlutterDur takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if LoadReal(HY,h,0) < TimerGetElapsed(GlobalTimer) then
		call UnitRemoveAbility(u,'A42Y')
		call UnitRemoveAbility(u,'B0HK')//B0HK -> |c0000ff00Flutter|r
		if FindItemOfType(u,Item_Real[Butterfly])!=null then
			call UnitAddAbility2(u,'A431')
			call UnitMakeAbilityPermanent(u,true,'AIev')//AIev -> Evasion
		endif
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
		call RemoveSavedHandle(HY,GetHandleId(u),'AIev')//AIev -> Evasion
		call UnitRecountEvasion(u)
	else
		
	endif
	set t=null
	set u=null
endfunction

function Butterfly_Flutter takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local timer t
	if HaveSavedHandle(HY,GetHandleId(u),'AIev') then//AIev -> Evasion
		set t=LoadTimerHandle(HY,GetHandleId(u),'AIev')//AIev -> Evasion
	else
		set t=CreateTimer()
		call UnitRemoveAbility(u,'AIev')//AIev -> Evasion
		call TimerStart(t,0.5,true,function Butterfly_FlutterDur)
		call SaveUnitHandle(HY,GetHandleId(t),0,u)
		call SaveTimerHandle(HY,GetHandleId(u),'AIev',t)//AIev -> Evasion
	endif
	call SaveReal(HY,GetHandleId(t),0,TimerGetElapsed(GlobalTimer)+6)
	call UnitRemoveAbility(u,'A431')
	call UnitRecountEvasion(u)
	call UnitAddAbility2(u,'A42Y')
	set t=null
	set u=null
endfunction

function MangoUsed takes nothing returns nothing
	if GetSpellTargetItem()!=null then
		call SetUnitState(GetTriggerUnit(),UNIT_STATE_MANA,GetUnitState(GetTriggerUnit(),UNIT_STATE_MANA)+150)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\MoonWell\\MoonWellCasterArt.mdx",GetTriggerUnit(),"origin"))
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl",GetTriggerUnit(),"origin"))
		
	else
		call SetUnitState(GetSpellTargetUnit(),UNIT_STATE_MANA,GetUnitState(GetSpellTargetUnit(),UNIT_STATE_MANA)+150)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\MoonWell\\MoonWellCasterArt.mdx",GetSpellTargetUnit(),"origin"))
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl",GetSpellTargetUnit(),"origin"))
	endif
endfunction

function GlimmerCapeEnd takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if GetTriggerEventId()==EVENT_WIDGET_DEATH then
		call UnitRemoveAbility(u,'A38T')
		call UnitRemoveAbility(u,'A38X')
		call UnitRemoveAbility(u,'A3G1')
		call UnitRemoveAbility(u,'B3G1')
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		if TimerGetElapsed(GlobalTimer)>=LoadReal(HY,h,1) then
			call UnitRemoveAbility(u,'A38T')
			call UnitRemoveAbility(u,'A38X')
			call UnitRemoveAbility(u,'A3G1')
			call UnitRemoveAbility(u,'B3G1')
			call FlushChildHashtable(HY,h)
			call DestroyTrigger(t)
		elseif TimerGetElapsed(GlobalTimer)>=LoadReal(HY,h,0) then
			call UnitAddAbility2(u,'A38T')
			call UnitAddAbility2(u,'A3G1')
		endif
	else
		if (GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED and u==GetAttacker()) or GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
			call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+0.4)
			call UnitRemoveAbility(u,'A38T')
			call UnitRemoveAbility(u,'A3G1')
			call UnitRemoveAbility(u,'B3G1')
		endif
	endif
	
	set t=null
	set u=null
	return false
endfunction

function GlimmerCapeStart takes unit u returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterDeathEvent(t,u)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerRegisterTimerEvent(t,0.1,true)
	call RemoveEndlessFadetime(u)
	//call UnitAddAbility2(u,'A38T')
	call HideAbility('A38T')
	call UnitAddAbility2(u,'A38X')
	call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Invisibility\\InvisibilityTarget.mdl",u,"origin"))
	call TriggerAddCondition(t,Condition(function GlimmerCapeEnd))
	call SaveUnitHandle(HY,h,0,u)
	call SaveReal(HY,h,1,TimerGetElapsed(GlobalTimer)+5.)
	call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+.4)
	set t=null
endfunction

function GlimmerCapeUsed takes nothing returns nothing
	local unit target
	if GetSpellTargetItem()!=null then
		set target=GetTriggerUnit()
	else
		set target=GetSpellTargetUnit()
	endif
	call GlimmerCapeStart(target)
	set target=null
endfunction

function GuardianGreavesHealFilter takes nothing returns boolean
	return IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function GuardianGreavesStart takes nothing returns nothing
	local group g=GetAvailableGroup()
	local unit u
	call PurgingTriggered(GetTriggerUnit(),false)
	//call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIda\\AIdaCaster.mdl",GetTriggerUnit(),"origin"))
	set tt_unit1=GetTriggerUnit()
	call GroupEnumUnitsInRange(g,GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),775,Condition(function GuardianGreavesHealFilter))
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		if LoadInteger(HY,GetHandleId(u),4258)!=1 then
			if IsUnitType(u,UNIT_TYPE_HERO) then
				call AddTimedKeyToUnit(u,4258,25)
			endif
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIre\\AIreTarget.mdl",u,"origin"))
			call DestroyEffect(AddSpecialEffectTarget("Unleash.mdx",u,"chest"))
			call SetWidgetLife(u,GetWidgetLife(u)+250)
		endif
		if GetUnitState(u,UNIT_STATE_MANA) < GetUnitState(u,UNIT_STATE_MAX_MANA) then
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl",u,"origin"))
			call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+160)
		endif
		call GroupRemoveUnit(g,u)
	endloop
	call KillGroup(g)
endfunction

function SolarCrestEnd takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	if TimerGetElapsed(GlobalTimer) < LoadReal(HY,h,0) then
		if GetUnitAbilityLevel(caster,'A39G')==1 then
			call SetUnitAbilityLevel(caster,'A39G',2)
			call UnitRecountEvasion(caster)
		endif
	else
		if HaveSavedHandle(HY,h,1) then
			call UnitRecountEvasion(LoadUnitHandle(HY,h,1))
		endif
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
		call SetUnitAbilityLevel(caster,'A39G',1)
		call UnitRecountEvasion(caster)
	endif
	set caster=null
	set t=null
endfunction

function SolarCrestStart takes nothing returns nothing
	local unit caster=GetTriggerUnit()
	local unit target=GetSpellTargetUnit()
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	local unit d
	if IsUnitAlly(caster,GetOwningPlayer(target)) then
		//call UnitAddAbilityTimedExF(target,'A39L',1,7,'A39L')
		call UnitAddAbilityTimedExF(target,'A39J',1,7,'B39J')//B39J -> |c0000ff00Solar Crest|r
		call UnitAddAbilityTimedExF(target,'A3C8',1,7,'A39M')
		call HideAbility('A3C8')
		call UnitAddAbilityTimedExF(caster,'A39F',1,7,0)
		call UnitAddAbilityTimedExF(target,'A39E',1,7,0)
		//call UnitRecountEvasion(target)
		call SaveUnitHandle(HY,h,1,target)
	else
		call UnitAddAbilityTimedExF(target,'A39F',1,7,'A39F')
		call UnitAddAbilityTimedExF(caster,'A39F',1,7,'A39F')
		call UnitAddAbilityTimedExF(target,'A39I',1,7,'B39I')
		call EvasionSourceActivate(EVASION_DEBUFF_SOLARCREST,8.)
		if target==Roshan then
			call SetUnitAbilityLevel(target,'A39F',2)
		endif
		
	endif
	call TimerStart(t,0.1,true,function SolarCrestEnd)
	call SaveUnitHandle(HY,h,0,caster)
	
	call SetUnitAbilityLevel(caster,'A39G',2)
	call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+7.01)
	//call UnitRecountEvasion(caster)
	set t=null
	set caster=null
	set target=null
endfunction

function LotusOrbAct takes nothing returns nothing
	local unit target
	if GetSpellTargetItem()!=null then
		set target=GetTriggerUnit()
	else
		set target=GetSpellTargetUnit()
	endif
	call UnitAddAbilityTimedExF(target,'A3E9',1,5.,'B3E9')//B3E9 -> |cff00ff00Echo Shell|r
	call PurgingTriggered(target,false)
	set target=null
endfunction

function Silencer_LastWordPassive_Act takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit caster=LoadUnitHandle(HY,h,0)
	local unit silencer=LoadUnitHandle(HY,h,1)
	local unit d
	if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
		set d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
		call UnitAddAbility(d,'A33T')
		call SetUnitAbilityLevel(d,'A33T',GetUnitAbilityLevel(silencer,'A33O'))
		call IssueTargetOrder(d,"drunkenhaze",caster)
		set d=null
	endif
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
	set caster=null
	set silencer=null
endfunction

function Silencer_LastWordPassive_FindSilencer takes nothing returns boolean
	return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsDead(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) and GetUnitAbilityLevel(GetFilterUnit(),'A33O')>0
endfunction

function Silencer_LastWordPassive_Check takes unit caster, integer aid returns nothing
	local trigger t
	local integer h
	local group g
	local unit silencer
	if BalanceOffSpellChecker(aid)==false then
		return
	endif
	set t=CreateTrigger()
	set h=GetHandleId(t)
	set g=GetAvailableGroup()
	call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),800,Condition(function Silencer_LastWordPassive_FindSilencer))
	set silencer=FirstOfGroup(g)
	call KillGroup(g)
	set g=null
	call TriggerRegisterTimerEvent(t,10,false)
	call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function Silencer_LastWordPassive_Act))
	call SaveUnitHandle(HY,h,0,caster)
	call SaveUnitHandle(HY,h,1,silencer)
	set silencer=null
	set t=null
endfunction

function UrnaSwarmInfestB takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local unit d=CreateUnit(GetOwningPlayer(u),'e00E',x,y,0)//e00E -> Spellcaster
	local group g=GetAvailableGroup()
	local unit u2
	call UnitAddAbility(d,'A1GG')//A1GG -> Scarab Silence
	if GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetTriggerPlayer())],'A0A8')>0 then
		call SetUnitAbilityLevel(d,'A1GG',GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetTriggerPlayer())],'A0A8'))
	endif
	set tt_unit1=u
	call GroupEnumUnitsInRange(g,x,y,300,Condition(function DefaultEnemyFilterWithAncients))
	loop
		set u2=FirstOfGroup(g)
		exitwhen u2==null
		call IssueTargetOrder(d,"soulburn",u2)
		call GroupRemoveUnit(g,u2)
	endloop
	call KillGroup(g)
	call KillUnit(u)
	call SetUnitAnimation(u,"death")
	call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UndeadLargeDeathExplode\\UndeadLargeDeathExplode.mdl",x,y))
	set u=null
	set d=null
	set g=null
endfunction

function UrnaSwarmInfest takes nothing returns boolean
	if GetSpellAbilityId()=='A1HH' then//A1HH -> Infestation
		call UrnaSwarmInfestB()
	endif
	return false
endfunction

function SkadiSlowTick takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	if TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0) or GetUnitAbilityLevel(LoadUnitHandle(HY,h,0),'A40W')==0 then
		call RestoreTint(LoadUnitHandle(HY,h,0))
		call UnitRemoveAbility(LoadUnitHandle(HY,h,0),'A40W')
		call UnitRemoveAbility(LoadUnitHandle(HY,h,0),'B0HF')//B0HF -> Frost attack
		call RemoveSavedHandle(HY,GetHandleId(LoadUnitHandle(HY,h,0)),'A40W')
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	endif
	set t=null
endfunction

function SkadiSlow takes unit u, boolean melee returns nothing
	local timer t=LoadTimerHandle(HY,GetHandleId(u),'A40W')
	local integer h
	if t!=null then
		set h=GetHandleId(t)
	else
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,0.1,true,function SkadiSlowTick)
		call UnitAddAbility2(u,'A40W')
		call SaveUnitHandle(HY,h,0,u)
		call SaveTimerHandle(HY,GetHandleId(u),'A40W',t)
	endif
	if melee then
		call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+5)
	else
		call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+2.5)
	endif
	call ApplyFrostColor(u)
	set t=null
endfunction

function OrbOfVenomDur takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local integer c=LoadInteger(HY,h,0)+1
	local real hp
	local unit u=LoadUnitHandle(HY,h,0)
	if c==4 or GetUnitAbilityLevel(u,'B0DM')==0 then//Bpsd -> Poison
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
	else
		call SaveInteger(HY,h,0,c)
		set hp=GetWidgetLife(u)
		call DamageTarget(LoadUnitHandle(HY,h,1),u,1,4)
	endif
	set u=null
	set t=null
endfunction

function OrbOfVenomApply takes unit attacker, unit target returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,1,true,function OrbOfVenomDur)
	call SaveUnitHandle(HY,h,0,target)
	call SaveUnitHandle(HY,h,1,attacker)
	set t=null
endfunction

function PoisonStingDur takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local integer lvl=LoadInteger(HY,h,0)
	local unit veno=LoadUnitHandle(HY,h,0)
	local unit target=LoadUnitHandle(HY,h,1)
	if GetUnitAbilityLevel(target,'Bpoi')+GetUnitAbilityLevel(target,'Bpsd')==0 then//Bpsd -> Poison
		call RemoveSavedHandle(MHT,GetHandleId(target),'Pois')
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
	else
		call DamageTarget(veno,target,11,6*lvl*0.75)
	endif
	set veno=null
	set target=null
	set t=null
endfunction

function PoisonStingApply takes unit attacker, unit target returns nothing
	local timer t
	local integer h
	local integer hu=GetHandleId(target)
	if HaveSavedHandle(MHT,hu,'Pois') then
		set t=LoadTimerHandle(MHT,hu,'Pois')
		set h=GetHandleId(t)
	else
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,1,true,function PoisonStingDur)
		call SaveUnitHandle(HY,h,0,attacker)
		call SaveUnitHandle(HY,h,1,target)
		call SaveTimerHandle(MHT,hu,'Pois',t)
	endif
	call SaveInteger(HY,h,0,GetUnitAbilityLevel(attacker,'P418'))
	set t=null
endfunction

function QuellingBladeDmg takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit target=LoadUnitHandle(HY,h,1)
	local unit attacker
	local real dmg
	if IsDead(target)==false then
		set attacker=LoadUnitHandle(HY,h,0)
		set dmg=LoadReal(HY,h,0)
		if GetUnitAbilityLevel(attacker,'A1AB')>0 then//A1AB -> Demolish BASIC
			call DamageTarget(attacker,target,10,dmg*0.32)
		else
			call DamageTarget(attacker,target,10,dmg*0.12)
		endif
	endif
	call PauseTimer(t)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set target=null
	set attacker=null
	set t=null
endfunction

function QuellingBladeBonus takes unit attacker, unit target, real dmg returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0,false,function QuellingBladeDmg)
	call SaveUnitHandle(HY,GetHandleId(t),0,attacker)
	call SaveUnitHandle(HY,GetHandleId(t),1,target)
	call SaveReal(HY,GetHandleId(t),0,dmg)
	set t=null
endfunction

function CustomUnitBountyAllyFilter takes nothing returns boolean
	return (IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GlobalKiller)) and IsDead(GetFilterUnit())==false and IsHexed(GetFilterUnit())==false)
endfunction

function CustomUnitBountyEnemyFilter takes nothing returns boolean
	return (IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GlobalKiller)) and IsDead(GetFilterUnit())==false and IsHexed(GetFilterUnit())==false)
endfunction

function CustomUnitBountySystemInit takes unit killer, unit dead returns nothing
	local integer i=0
	local integer gold=0
	local integer xp=0
	local group g=null
	local group gg=null
	local integer count=0
	local boolean b=false
	local integer greed=0
	local integer greedlvl=0
	local player p
	if IsUnitType(dead,UNIT_TYPE_HERO) or IsUnitIllusion(dead) or killer==null then
		set dead=null
		set killer=null
		return
	endif
	set b=IsUnitAlly(killer,GetOwningPlayer(dead))
	if b then
		set i=GetUnitTypeId(dead)
		if SacrificedByLich then
			set xp=0
		else
			set xp=LoadInteger(UnitStats,i,EXP)/2
		endif
		
		if xp>0 then
			//set g=GetAvailableGroup()
			set GlobalKiller=killer
			call getHeroesAround()
			//call GroupEnumUnitsInRange(g,GetUnitX(dead),GetUnitY(dead),EXPAOE,Condition(function CustomUnitBountyEnemyFilter))//alive non-hexed enemy heroes
			if(FirstOfGroup(ShareExpGroup)!=null)then
				set GlobalKillerExp=R2I(xp / CountUnitsInGroup(ShareExpGroup))
				call ForGroup(ShareExpGroup,function GiveRealExpToUnitsAround)
			endif
			//call KillGroup(g)
			set GlobalKiller=null
		endif
	endif
	if b==false or SacrificedByLich then
		set i=GetUnitTypeId(dead)
		set p=GetOwningPlayer(killer)
		if(SacrificedByLich==false) and (p!=Sentinels[0] and p!=Scourges[0] and p!=Neutrals)then
			if GetUnitAbilityLevel(killer,'Aloc')==1 then//Aloc -> Locust
				set killer=udg_Hero[GetPlayerId(p)]
			endif
			set greedlvl=GetUnitAbilityLevel(killer,'P155')//Goblin's greed
			if greedlvl>0 and GetUnitAbilityLevel(killer,'A36D')==0 then
				set count=GetHandleId(killer)
				if IsUnitType(dead,UNIT_TYPE_STRUCTURE)==false and (GetUnitAbilityLevel(dead,'A04R')==0) then//
					set greed=IMinIF(LoadInteger(MHT,count,'A0O3')*2+greedlvl*2+2,8*greedlvl)//define gold//A0O3 -> Goblin's Greed
					call SaveInteger(MHT,GetHandleId(p),'A0O3',LoadInteger(MHT,GetHandleId(p),'A0O3') + greed)//A0O3 -> Goblin's Greed, A0O3 -> Goblin's Greed
					call DestroyEffect(AddSpecialEffect("war3mapImported\\GoblinCoin.mdx",GetUnitX(dead),GetUnitY(dead)))
				endif
			endif
			set gold=GetRandomInt(LoadInteger(UnitStats,i,BOUNTYL),LoadInteger(UnitStats,i,BOUNTYH))+greed
			if gold>0 then
				call ImitateBountyGain(p,dead,gold)
			endif
		endif
		set xp=LoadInteger(UnitStats,i,EXP)
		
		if(xp>0 and p!=Neutrals) then
			call ProvideExp(xp,p,killer)
		endif
		set SacrificedByLich=false
	endif
endfunction

function TombStoneZombieAttacked takes nothing returns nothing
	if IsUnitType(UDSG_Attacker,UNIT_TYPE_HERO) or IsUnitType(UDSG_Attacker,UNIT_TYPE_STRUCTURE) or GetUnitAbilityLevel(UDSG_Target,'AZ00')==1 then
		call KillUnit(UDSG_Target)
	else
		call UnitAddAbility(UDSG_Target,'AZ00')
	endif
endfunction

function ZombieTombstoneWrapper takes nothing returns nothing
	if GetUnitTypeId(UDSG_Target)=='n0F5' then//n0F5 -> Living Dead
		call TombStoneZombieAttacked()
	endif
endfunction

function FamiliarAttacked takes nothing returns nothing
	local real curhp=GetWidgetLife(UDSG_Target)
	local real dmg=2500
	if IsUnitType(UDSG_Attacker,UNIT_TYPE_HERO) then
		set dmg=10000
	elseif IsUnitType(UDSG_Attacker,UNIT_TYPE_STRUCTURE) then
		set dmg=5000
	endif
	if curhp>dmg+100.5 then
		call SetWidgetLife(UDSG_Target,curhp-dmg+GetEventDamage())
	else
		call DamageTarget(UDSG_Attacker,UDSG_Target,2,9999999)
	endif
endfunction

function FamiliarDamagedWrapper takes nothing returns nothing
	if IsFamiliarId(GetUnitTypeId(UDSG_Target)) then
		call FamiliarAttacked()
	endif
endfunction

function ViperOrbWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'A09V')>0 and GetUnitAbilityLevel(UDSG_Target,'B06D')>0 then
		call ViperPoisonAttack(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function PreloadingSkills_Viper2 takes nothing returns nothing
	call AddWrapper("ViperOrbWrapper",4)
endfunction

function UDS_Summon takes integer i returns nothing
	local integer k=0
	loop
		exitwhen HaveSavedString(UTable,'DMGE'+i,k)==false
		call ExecuteFunc(LoadStr(UTable,'DMGE'+i,k))
//		call echo(LoadStr(UTable,'DMGE'+i,k)+" "+I2S(i))
		set k=k+1
	endloop
endfunction

function LichFromArmorWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Target,'B0H6')>0 and IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER)==false then//B0H6 -> Frost Armor
		call Lich_FrostArmor_RangedAttack(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function LeoricLifestealWrapper takes nothing returns nothing
	call SK_VampiricAura_Ranged(UDSG_Attacker,UDSG_Target)
endfunction

function VladmirOfferingWrapper takes nothing returns nothing
	local integer lvl
	local real percent
	if GetUnitAbilityLevel(UDSG_Attacker,'B3B5')==0 then//B3B5 -> Vladmir's Offering
		return
	endif
	if IsUnitIllusion(UDSG_Target)==false and IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE)==false and IsUnitType(UDSG_Target,UNIT_TYPE_MECHANICAL)==false and GetUnitAbilityLevel(UDSG_Target,'A04R')==0 and IsUnitEnemy(UDSG_Attacker,GetOwningPlayer(UDSG_Target)) and IsDead(UDSG_Attacker)==false then//
		if IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER) then
			set percent=0.15
		else
			set percent=0.1
		endif
		call SetWidgetLife(UDSG_Attacker,GetWidgetLife(UDSG_Attacker)+GetEventDamage()*percent)
		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\VampiricAura\\VampiricAuraTarget.mdl",UDSG_Attacker,"origin"))
	endif
endfunction

function TranquilBootsWrapper takes nothing returns nothing
	if IsUnitType(UDSG_Target,UNIT_TYPE_HERO) or IsSpiritBear(UDSG_Target) then
		call TranquilBoots_Attackd(UDSG_Target)
	endif
	if IsUnitType(UDSG_Attacker,UNIT_TYPE_HERO) or IsSpiritBear(UDSG_Attacker) then
		call TranquilBoots_Attackd(UDSG_Attacker)
	endif
endfunction

function QuellingBladeWrapper takes nothing returns nothing
	if IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(UDSG_Target,GetOwningPlayer(UDSG_Attacker)) and IsUnitType(UDSG_Target,UNIT_TYPE_HERO)==false and (GetUnitAbilityLevel(UDSG_Attacker,'A1AB')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A1AD')>0) and UDSG_Target!=Roshan then//A1AB -> Demolish BASIC, A1AD -> Demolish BASIC
		call QuellingBladeBonus(UDSG_Attacker,UDSG_Target,UDSG_Dmg)
	endif
endfunction

function MjollnirsWrapper takes nothing returns nothing
	if IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE)==false and IsUnitType(UDSG_Target,UNIT_TYPE_MECHANICAL)==false and IsUnitEnemy(UDSG_Target,GetOwningPlayer(UDSG_Attacker)) and IsUnitIllusion(UDSG_Attacker)==false and (GetUnitAbilityLevel(UDSG_Attacker,'A0JH')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A0FJ')>0) then//A0JH -> Mjollnir, A0FJ -> Maelstrom
		call MjollnirLightnings(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function LunaGlaiveWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'P098')>0 and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 then
		call MoonGlaive(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function DiffusalBladeWrapper takes nothing returns nothing
	if IsUnitEnemy(UDSG_Attacker,GetOwningPlayer(UDSG_Target)) and GetUnitAbilityLevel(UDSG_Attacker,'Afbt')>0 and GetUnitState(UDSG_Target,UNIT_STATE_MANA)>0 then//Afbt -> Diffusal Blade
		call DiffusalBladeAct(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function DesolatorExistsWrapper takes nothing returns nothing
	if IsUnitEnemy(UDSG_Attacker,GetOwningPlayer(UDSG_Target)) and GetUnitAbilityLevel(UDSG_Attacker,'AIcb')>0 then
		call ApplyDesolatorTriggered(UDSG_Target)
	endif
endfunction

function EnchantTotemWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'Broa')>0 then//Enchant Totem//Broa -> Enchant Totem
		call UnitRemoveAbility(UDSG_Attacker,'Broa')//Broa -> Enchant Totem
	endif
endfunction

function EnchantTotemWrapperOnAttack takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'Broa')>0 and IsRangedUnitHasOverAS(UDSG_Attacker) then//Enchant Totem//Broa -> Enchant Totem
		call EnchantTotemRangedFix()
	endif
endfunction

function MoCWrapperAdvanced takes nothing returns nothing
	if LoadInteger(HY,UDSG_TempInt,120)>0 and (GetUnitAbilityLevel(UDSG_Attacker,'A2GD')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A2GE')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A2GF')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A2GC')>0) then//MoC on one hit only!//A2GD -> Moment of Courage Container - 1, A2GE -> Moment of Courage Container - 2, A2GF -> Moment of Courage Container - 3, A2GC -> Moment of Courage Container - 4
		call SaveInteger(HY,UDSG_TempInt,120,LoadInteger(HY,UDSG_TempInt,120)-1)
		call Legion_MoC_Clear(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function MoCWrapperOnAttack takes nothing returns nothing
	call SaveBoolean(HY,UDSG_TempInt,120,GetUnitAbilityLevel(UDSG_Attacker,'B0FJ')>0)//check for MoC//B0FJ -> Moment of Courage
	if GetUnitAbilityLevel(UDSG_Attacker,'B0FJ')>0 then//B0FJ -> Moment of Courage
		call SaveInteger(HY,UDSG_TempInt,120,LoadInteger(HY,UDSG_TempInt,120)+1)
	endif
endfunction

function ElderDragonCorrosiveWrapper takes nothing returns nothing
	if GetUnitTypeId(UDSG_Attacker)=='H00E' or GetUnitTypeId(UDSG_Attacker)=='H00F' or GetUnitTypeId(UDSG_Attacker)=='H00G' then//H00E -> Dragon Knight, H00F -> Dragon Knight, H00G -> Dragon Knight
		call ElderDragon_CorrosiveBreath(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function CausticFinalWrapper takes nothing returns nothing
	if (GetUnitAbilityLevel(UDSG_Attacker,'A0FA')>0) and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 then//A0FA -> Caustic Finale, QP16 -> Caustic Finale
		if IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER)==false and GetRandomInt(0,1)==0 then
			return
		endif
		call CausticFinalTriggered_Apply(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function OldMarksmanshipWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'A43Z')>0 and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 then
		call Adaptiveness_Instagib(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function Ench_Impetus_HitWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Target,'B03U')>0 then//B03U -> Impetus
		call Ench_Impetus_Hit(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function LifestealerFeastWrapperOnAttack takes nothing returns nothing
	if FeastCondition() then
		call Lifestealer_Feast_Start(UDSG_Attacker,UDSG_Target,GetUnitAbilityLevel(UDSG_Attacker,'A0SS'))//A0SS -> Feast, QP1W -> Feast
	endif
endfunction

function LifestealerWrapper takes nothing returns nothing
	if FeastCondition() then
		call Lifestealer_Feast_Act(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function ODOrbWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Target,'B06Y')>0 then//B06Y -> Arcane Orb
		call OD_Orb_Hit(UDSG_Attacker,UDSG_Target,LoadBoolean(HY,UDSG_TempInt,0))
	endif
endfunction

function SilencerOrbWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Target,'B05X')>0 then//B05X -> Glaives of Wisdom
		call Silencer_Glaive_Hit(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function SlarkEssenceShiftWrapper takes nothing returns nothing
	if (GetUnitAbilityLevel(UDSG_Attacker,'A1HR')>0) and IsUnitType(UDSG_Target,UNIT_TYPE_HERO) and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 then//A1HR -> Essence Shift, QP1F -> Essence Shift
		call Slark_EssenceShift_OnHit(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function BarabashWrapper takes nothing returns nothing
	if (GetUnitAbilityLevel(UDSG_Attacker,'A0G5')>0) and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 then//A0G5 -> Greater Bash, QP1X -> Greater Bash
		call GreaterBash_Apply(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function UrsaSwipesWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'P067')>0 and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 then//P067 -> Fury Swipes, QP0A -> Fury Swipes
		call FurySwipesTriggered_Apply(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function OrbOfVenomWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'A1V7')>0 and GetUnitAbilityLevel(UDSG_Target,'B0DM')>0 then//A1V7 -> Orb of Venom - Melee, B0DM -> Orb of Venom
		call OrbOfVenomApply(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function SkadiWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'A2KV')>0 then
		call SkadiSlow(UDSG_Target,IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER))
	endif
endfunction

function PoisonStingWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'P418')>0 and GetUnitAbilityLevel(UDSG_Target,'Bpsd')>0 and AliveNonBuildOrMarker(UDSG_Target) and IsUnitEnemy(UDSG_Attacker,GetOwningPlayer(UDSG_Target)) and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 then//Bpsd -> Poison
		call PoisonStingApply(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function SpectreDesolateWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'P338')>0 and IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER)==false and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 and LoadInteger(HY,GetHandleId(UDSG_Attacker),4275)!=1 and AliveNonBuildOrMarker(UDSG_Target) and UDSG_Target!=Roshan then
		//A322 -> Desolate (illusion placeholder)
		call Spectre_Desolate_act(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function AbaFrostmourneWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 and (GetUnitAbilityLevel(UDSG_Attacker,'A0MG')>0) then//frostmourne//A0MG -> Frostmourne, QP18 -> Frostmourne
		call Abaddon_Frostmourne_Apply(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function SpiritBearDmgWrapper takes  nothing returns nothing
	if IsSpiritBear(UDSG_Attacker) and IsUnitIllusion(UDSG_Attacker)==false then
		call SpiritBearAttack(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function HuskarArrowsWrapper takes nothing returns nothing
	call Huskar_BurningSpears_Wrapper(UDSG_Attacker,UDSG_Target)
endfunction

function GeoStrikeWrapper takes nothing returns nothing
	if (GetUnitAbilityLevel(UDSG_Attacker,'A0N7')>0) and GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 then//QP1B -> Geostrike, A0N7 -> Geostrike
		call GeostrikeTriggered_Apply(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function HuskarBurningSpearsWrapperInit takes nothing returns nothing
	call Huskar_BurningSpears_OnAttack(UDSG_Attacker,UDSG_Target)
endfunction

function VoidBashWrapper takes nothing returns nothing
	call Void_Bash_Condition(UDSG_Attacker,UDSG_Target)
endfunction

function TidebringerWrapper takes nothing returns nothing
	if IsFakeDamage<1 and UDSG_Dmg>40 or IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE) then
		call Kunka_Tidebringer_Effect(UDSG_Attacker,UDSG_Target,UDSG_Dmg)
	endif
endfunction

function TidebringerWrapperOnAttack takes nothing returns nothing
	call Kunka_Tidebringer_Condition(UDSG_Attacker,UDSG_Target)
endfunction

function LanayaBladesWrapper takes nothing returns nothing
	call Psi_Blades_Condition(UDSG_Attacker,UDSG_Target)
endfunction

function WyvernWrapper takes nothing returns nothing
	call Wyvern_Burn_Attack_Condition(UDSG_Attacker,UDSG_Target)
endfunction

function TreantInvisWrapper takes nothing returns nothing
	call Tree_Invis_Cancel(UDSG_Attacker)
endfunction

function AbaFrostmourneWrapperOnAttack takes nothing returns nothing
	call Abbadon_Frostmourne_Attack(UDSG_Attacker,UDSG_Target)
endfunction

function RikiBackStabWrapper takes nothing returns nothing
	call Rikki_BackStab_Condition(UDSG_Attacker,UDSG_Target)
endfunction

function PLOnAttackWrapper takes nothing returns nothing
	call PL_Illusions_OnAttackWrap(UDSG_Attacker,UDSG_Target)
endfunction

function TrollWrapper takes nothing returns nothing
	call Troll_Fervor(UDSG_Attacker,UDSG_Target)
endfunction

function AxeWrappers takes nothing returns nothing
	call AxeAttacked(UDSG_Attacker,UDSG_Target)
endfunction

function ViperWrappers takes nothing returns nothing
	call Viper_NetherToxin(UDSG_Attacker,UDSG_Target)
endfunction

function KrakenShellWrapper takes nothing returns nothing
	call KrakenShellAttack(UDSG_Attacker,UDSG_Target)
endfunction

function SpectreWrappers takes nothing returns nothing
	call Spectre_Desolate(UDSG_Attacker,UDSG_Target)
endfunction

function CentaurReturnWrapper takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Target,'P123')>0 and IsWardUnit(UDSG_Attacker)==false and GetUnitAbilityLevel(UDSG_Attacker,'A04R')==0 and GetUnitAbilityLevel(UDSG_Target,'A36D')==0 then
		call Centaur_Return(UDSG_Attacker,UDSG_Target)
	endif
endfunction

function ShredderWrapper takes nothing returns nothing
	call Shredder_ReactiveArmor_OnAttack(UDSG_Attacker,UDSG_Target)
endfunction

function MoCWrapperOnAttacked takes nothing returns nothing
	call Legion_MoC_OnAttack(UDSG_Attacker,UDSG_Target)
endfunction

function BaneUltiWrapper takes nothing returns nothing
	call Bane_FiendGripUpg_Nightmare(UDSG_Attacker,UDSG_Target)
endfunction

function SimulateBash takes unit attacker, unit target, integer bashtype returns nothing
//bash types:
// 1 = slardar
// 2 = void
// 3 = troll
// 4 = basher
// 5 = mkb
// 6 = brood's hunger
	if bashtype==1 then
		call DamageTarget(attacker,target,2,40+20*GetUnitAbilityLevel(attacker,'A0JJ'))
		call BashTargetLoD(target,1.)
	elseif bashtype==2 then
		call DamageTarget(attacker,target,1,30+10*GetUnitAbilityLevel(attacker,'A081'))
		call BashTargetLoD(target,1.)
	elseif bashtype==3 then
		call DamageTarget(attacker,target,1,10+10*GetUnitAbilityLevel(attacker,'A09E'))
		call BashTargetLoD(target,0.4+0.4*GetUnitAbilityLevel(attacker,'A09E'))
	elseif bashtype==4 then
		call BashTargetLoD(target,1.4)
	elseif bashtype==5 then
		call DamageTarget(attacker,target,1,100)
		call BashTargetLoD(target,0.01)
	elseif bashtype==6 then
		call BashTargetLoD(target,1.)
	endif
//	//call echo("bash happened")
endfunction

function AddingBashOrCritWrapper takes nothing returns nothing
	call AddWrapper("BashOrCritWrapper",0)
endfunction

function SilverEdgeWrapper takes nothing returns nothing
	if LoadBoolean(HY,UDSG_TempInt,20) then
		if IsMagicImmune(UDSG_Target)==false then
			call UnitAddAbilityTimedExF(UDSG_Target,'A39D',1,5.,'B39D')//B39D -> Silver Edge
			call Break(UDSG_Target,5.)
		endif
		call RemoveSavedBoolean(HY,UDSG_TempInt,20)
	endif
endfunction

function SimulateCrit takes unit attacker, unit target, real mult returns nothing
	local texttag tt = CreateTextTag()
	call SetTextTagText(tt,I2S(R2I(GetEventDamage()*mult)) + "!",.025)
	call SetTextTagColor(tt,255,0,0,255)
	call SetTextTagPos(tt,GetUnitX(attacker),GetUnitY(attacker),0.)
	call SetTextTagVelocity(tt,.0,.04)
	call SetTextTagVisibility(tt,IsUnitVisibleLoD(attacker,GetLocalPlayer()))
	call SetTextTagFadepoint(tt,2.)
	call SetTextTagLifespan(tt,5.)
	call SetTextTagPermanent(tt,false)
	set tt=null
//	//call echo("fire "+R2S(mult)+" "+GetUnitName(attacker)+" "+GetUnitName(target))
	call DamageTarget(attacker,target,10,GetEventDamage()*(mult-1))
endfunction

function BashOrCritWrapper takes nothing returns nothing
	if HaveSavedReal(HY,UDSG_TempInt,16) then
		call SimulateCrit(UDSG_Attacker,UDSG_Target,LoadReal(HY,UDSG_TempInt,16))
		call RemoveSavedReal(HY,UDSG_TempInt,16)
		//if HaveSavedBoolean(HY,UDSG_TempInt,16)then//chaos strike
			call ChaosStrikeDebuff()
		//	call RemoveSavedBoolean(HY,UDSG_TempInt,16)
		//endif
	endif
//	if HaveSavedInteger(HY,UDSG_TempInt,17) then
//		call SimulateBash(UDSG_Attacker,UDSG_Target,LoadInteger(HY,UDSG_TempInt,17))
//		call RemoveSavedInteger(HY,UDSG_TempInt,17)
//	endif
endfunction

function ChaosStrikeTriggered takes unit u, integer h returns nothing
	local integer id//=GetUnitTypeId(u)
	local real r1=0
	if PRD_Get(u,'P431',15) then
		set r1=0.75+0.5*GetUnitAbilityLevel(u,'P431')//A03N -> Critical Strike
	endif
	if r1!=0 then
		call SimulateCrit(UDSG_Attacker,UDSG_Target,r1)
		call ChaosStrikeDebuff()
	endif
endfunction

function CalculatePossibleCrits takes nothing returns nothing
	if GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 and LoadBoolean(HY,UDSG_TempInt,11)==false and LoadBoolean(HY,UDSG_TempInt,12)==false and LoadBoolean(HY,UDSG_TempInt,14) then
		if GetUnitAbilityLevel(UDSG_Attacker,'P431')>0 then
			//call echo("try")
			call ChaosStrikeTriggered(UDSG_Attacker,UDSG_TempInt)
		endif
	endif
endfunction

function CalculatePossibleBashes takes nothing returns nothing
	local integer chance
	local boolean isMelee=IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER)
	if GetUnitAbilityLevel(UDSG_Attacker,'A3L2')>0 then//basher abyssal
		if isMelee then
			set chance=25
		else
			set chance=10
		endif
		if LoadInteger(HY,GetHandleId(UDSG_Attacker),'bash')!=1 and PRD_Get(UDSG_Attacker,'A3L2',chance) then
			call AddTimedKeyToUnit(UDSG_Attacker,'bash',2.3)
			call SimulateBash(UDSG_Attacker,UDSG_Target,4)
		endif
	elseif GetUnitAbilityLevel(UDSG_Attacker,'A36D')==0 then
		if GetUnitAbilityLevel(UDSG_Attacker,'A0JJ')>0 then
			if isMelee then
				if PRD_Get(UDSG_Attacker,'A0JJ',5+5*GetUnitAbilityLevel(UDSG_Attacker,'A0JJ')) then
					call SimulateBash(UDSG_Attacker,UDSG_Target,1)
				endif
			else
				if PRD_Get(UDSG_Attacker,'A0JJ',4*GetUnitAbilityLevel(UDSG_Attacker,'A0JJ')) then
					call SimulateBash(UDSG_Attacker,UDSG_Target,1)
				endif
			endif
		elseif GetUnitAbilityLevel(UDSG_Attacker,'A081')>0 then
			if isMelee then
				if PRD_Get(UDSG_Attacker,'A081',5+5*GetUnitAbilityLevel(UDSG_Attacker,'A081')) then
					call SimulateBash(UDSG_Attacker,UDSG_Target,2)
				endif
			else
				if PRD_Get(UDSG_Attacker,'A081',4*GetUnitAbilityLevel(UDSG_Attacker,'A081')) then
					call SimulateBash(UDSG_Attacker,UDSG_Target,2)
				endif
			endif
		elseif GetUnitAbilityLevel(UDSG_Attacker,'A09E')>0 then
			if PRD_Get(UDSG_Attacker,'A09E',10) then
				call SimulateBash(UDSG_Attacker,UDSG_Target,3)
			endif
		elseif GetUnitAbilityLevel(UDSG_Attacker,'A0WW')>0 then
			if IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER) then
				set chance=20
			else
				set chance=10
			endif
			if PRD_Get(UDSG_Attacker,'A0WW',chance) then
				call SimulateBash(UDSG_Attacker,UDSG_Target,6)
			endif
		endif
	endif
	if GetUnitAbilityLevel(UDSG_Attacker,'A061')==1 then
		if PRD_Get(UDSG_Attacker,'A061',35) then
			call SimulateBash(UDSG_Attacker,UDSG_Target,5)
		endif
	endif
endfunction

function Preload_CalculatePossibleCrits takes nothing returns nothing
	call AddWrapper("CalculatePossibleCrits",0)
endfunction

function Preload_CalculatePossibleBashes takes nothing returns nothing
	call AddWrapper("CalculatePossibleBashes",2)
endfunction

function UDS_Landing takes unit attacker, unit target, real dmg returns nothing
	set UDSG_Attacker=attacker
	set UDSG_Target=target
	set UDSG_Dmg=dmg
	set UDSG_TempInt=GetHandleId(GetTriggeringTrigger())
	call UDS_Summon(0)
	if not(LoadBoolean(HY,UDSG_TempInt,10)) then
		return
	endif
	call UDS_Summon(1)
	
	if LoadBoolean(HY,UDSG_TempInt,11)==false and LoadBoolean(HY,UDSG_TempInt,12)==false and LoadBoolean(HY,UDSG_TempInt,14) then//structure mech marker
		call UDS_Summon(2)
		if LoadBoolean(HY,UDSG_TempInt,15) then//enemy
			call UDS_Summon(3)
			if IsMagicImmune(target)==false then
				call UDS_Summon(4)
			endif
		endif
	endif
endfunction

function UDS_Tick takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED and LoadInteger(HY,h,0)>0 then
//		call echo(B2S(GetEventDamage()>0)+" "+B2S((GetEventDamage()!=0)))
		if GetEventDamageSource()==LoadUnitHandle(HY,h,0) and IsRealDamage and IsFakeDamage<1 and (GetEventDamage()>0 or LoadBoolean(HY,h,10)==false) then
			call DisableTrigger(t)
			call UDS_Landing(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1),GetEventDamage())
			call EnableTrigger(t)
			if LoadInteger(HY,h,0)==1 then
				call SaveInteger(HY,h,0,0)
			else
				call SaveInteger(HY,h,0,LoadInteger(HY,h,0)-1)
			endif
		endif
	elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
		call RemoveSavedHandle(MHT,LoadInteger(HY,h,10),LoadInteger(HY,h,11))
		call PauseTimer(LoadTimerHandle(HY,h,3))
		call DestroyTimer(LoadTimerHandle(HY,h,3))
		call FlushChildHashtable(HY,h)
		call CleanTrigger(t)
		set UDSTriggers=UDSTriggers-1
		//call echo("desroyed")
	endif
	set t=null
endfunction

function MissChance takes nothing returns nothing
	local integer chance=0
	local integer pid
	local integer attackerfail=0
	local unit u
	if (EvasionSourcesActive[EVASION_BUFF_MKB] and GetUnitAbilityLevel(UDSG_Attacker,'A1FO')==1 and (IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE)==false or (GetOwningPlayer(UDSG_Target)!=Scourges[0] and GetOwningPlayer(UDSG_Target)!=Sentinels[0]) )) or GetUnitAbilityLevel(UDSG_Target,'A3Q3')==1 then//mkb or wards
		call UnitRemoveAbility(UDSG_Attacker,'a3PQ')
		return
	endif
	if (EvasionSourcesActive[EVASION_BUFF_SILVEREDGE] and  GetUnitAbilityLevel(UDSG_Attacker,'B39C')==1) or (EvasionSourcesActive[EVASION_BUFF_VENDETTA] and GetUnitAbilityLevel(UDSG_Attacker,'B00K')==1) then
		//silver edge / vendetta cannot miss
		//walrus punch to add
		call UnitRemoveAbility(UDSG_Attacker,'a3PQ')
		return
	endif
	if IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER)==false and IsUnitType(UDSG_Attacker,UNIT_TYPE_FLYING)==false then
		if GetTerrainCliffLevel(GetUnitX(UDSG_Attacker),GetUnitY(UDSG_Attacker)) < GetTerrainCliffLevel(GetUnitX(UDSG_Target),GetUnitY(UDSG_Target)) then
			set attackerfail=25
		endif
	endif
	if (EvasionSourcesActive[EVASION_SOURCE_ARCWARDEN] and GetUnitAbilityLevel(UDSG_Target,'ACes')>0) or (EvasionSourcesActive[EVASION_SOURCE_DRUNKENBRAWLER] and GetUnitAbilityLevel(UDSG_Target,'A34E')>0 and GetUnitAbilityLevel(UDSG_Target,'A36D')==0) then//100% evasuion
		set chance=100
	else
		set chance=GetUnitsEvasion(UDSG_Target)
	endif
	
	set attackerfail=MultChance(attackerfail,GetUnitsMissChance(UDSG_Attacker))
	if EvasionSourcesActive[EVASION_BUFF_ATOS] and GetUnitAbilityLevel(UDSG_Target,'B0F5')==1 then//rod of atos
		set chance=R2I(chance*0.6)
		set attackerfail=R2I(attackerfail*0.6)
	endif
	//call echo(I2S(chance)+"% chance to miss, "+I2S(attackerfail)+"% chance to miss for attacker")
	if (chance>0 or attackerfail>0) and (GetRandomInt(1,100) < chance or GetRandomInt(1,100) < attackerfail) then
		set pid=GetPlayerId(GetOwningPlayer(UDSG_Attacker))
		set u=GetPersonalCaster(UDSG_Attacker)
		call SetUnitX(u,GetUnitX(UDSG_Attacker))
		call SetUnitY(u,GetUnitY(UDSG_Attacker))
		call UnitAddAbility(u,'A3PQ')
		call IssueTargetOrder(u,"curse",UDSG_Attacker)
		call UnitRemoveAbility(u,'A3PQ')
		set ThisAttackMissed=true
	else
		call UnitRemoveAbility(UDSG_Attacker,'a3PQ')
		set ThisAttackMissed=false
	endif
endfunction

function UDS takes unit attacker, unit target, boolean isOrb returns nothing
	local trigger t
	local integer h
	local timer tt
	set UDSG_Attacker=attacker
	set UDSG_Target=target
	set UDSG_IsOrb=isOrb
	call UDS_Summon(-1)
	if not(IsPlayerBelongToTeams(GetOwningPlayer(attacker)) or IsPlayerBelongToTeams(GetOwningPlayer(target)) or (HeroLeoricExists and (GetUnitAbilityLevel(attacker,'BVA1')==1 or GetUnitAbilityLevel(attacker,'BVA2')==1 or GetUnitAbilityLevel(attacker,'BVA3')==1 or GetUnitAbilityLevel(attacker,'BVA4')==1)) or (VladmirOfferingInGame and GetUnitAbilityLevel(attacker,'B07O')==1)) then//BVA1 -> Vampiric Aura, BVA2 -> Vampiric Aura, BVA3 -> Vampiric Aura, BVA4 -> Vampiric Aura, B07O -> Vladmir's Offering
		return
	endif
	if HaveSavedHandle(MHT,GetHandleId(attacker),GetHandleId(target)) then
		set t=LoadTriggerHandle(MHT,GetHandleId(attacker),GetHandleId(target))
		set h=GetHandleId(t)
		if ThisAttackMissed==false then
			call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
		endif
		set tt=LoadTimerHandle(HY,h,3)
	else
		set t=CreateTrigger()
		set h=GetHandleId(t)
		set tt=CreateTimer()
		call SaveTimerHandle(HY,h,3,tt)
		call SaveTriggerHandle(MHT,GetHandleId(attacker),GetHandleId(target),t)
		if ThisAttackMissed==false then
			call SaveInteger(HY,h,0,1)
		else
			call SaveInteger(HY,h,0,0)
		endif
		call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
		
		call TriggerRegisterTimerExpireEvent(t,tt)
		call TriggerAddCondition(t,Condition(function UDS_Tick))
		call SaveUnitHandle(HY,h,0,attacker)
		call SaveUnitHandle(HY,h,1,target)
		call SaveInteger(HY,h,10,GetHandleId(attacker))//backup IDs in case if unit removed from game
		call SaveInteger(HY,h,11,GetHandleId(target))
		call SaveBoolean(HY,h,10,IsUnitType(attacker,UNIT_TYPE_HERO) or IsSpiritBear(attacker) or GetUnitTypeId(attacker)=='o00S')
		call SaveBoolean(HY,h,11,IsUnitType(target,UNIT_TYPE_STRUCTURE))
//		call SaveBoolean(HY,h,13,IsSiegeUnit(target))
		call SaveBoolean(HY,h,14,GetUnitAbilityLevel(target,'A04R')==0)//
		call SaveBoolean(HY,h,15,IsUnitEnemy(attacker,GetOwningPlayer(target)))
		set UDSTriggers=UDSTriggers+1
	endif
	set UDSG_TempInt=h
	if LoadBoolean(HY,h,11)==false and LoadBoolean(HY,h,14) then
//		if GetUnitAbilityLevel(attacker,'B09Y')>0 or GetUnitAbilityLevel(attacker,'B3J7')>0 then//B09Y -> Phase
//			//call SimulatePhaseBuffs(attacker,h)
//		elseif GetUnitAbilityLevel(attacker,'P431')>0 and GetUnitAbilityLevel(attacker,'A36D')==0 then
//			call ChaosStrikeTriggered(attacker,h)
//		endif
		if GetUnitAbilityLevel(attacker,'B39C')>0 then//B39C -> Shadow Walk
			call SaveBoolean(HY,h,20,true)
		endif
	endif
	if IsUnitType(attacker,UNIT_TYPE_HERO)then
		call UDS_Summon(-2)
	endif
	//call DisableEvasion(target,0.5)
	//call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+4)
	call TimerStart(tt,4,false,null)
	call SaveBoolean(HY,h,0,isOrb)
	set tt=null
	set t=null
endfunction

function GenericHeroDamagedActions takes nothing returns nothing
	local unit target=GetTriggerUnit()
	local real dmg=GetEventDamage()
	local real heal=0.
	local unit adjattacker=null
	if dmg>0 and dmg<9000 then
		
		set TotalDamage2Heroes[GetPlayerId(GetOwningPlayer(GetEventDamageSource()))]=TotalDamage2Heroes[GetPlayerId(GetOwningPlayer(GetEventDamageSource()))]+R2I(dmg)
		set heal=0.
		if GetUnitAbilityLevel(target,'A3D9')==1 then//is hero
			call SaveUnitHandle(HY,GetHandleId(target),'lstd',udg_Hero[GetPlayerId(GetOwningPlayer(GetEventDamageSource()))])
		endif
		if GetUnitAbilityLevel(target,'A3KF')==1 then
			set TempReal=RMinIF(Treant_LivingArmorHeal(),dmg)
			if TempReal>0 then
				set heal=heal+TempReal
				set dmg=dmg-TempReal
			endif
		endif
		if dmg>0 then
			if GetUnitAbilityLevel(target,'A3DA')==1 then//wraith mode
				set heal=dmg
				set dmg=0
			elseif GetUnitAbilityLevel(target,'C022')==1 then//borrowed time aba
				set heal=dmg*2
				set dmg=0
			elseif GetUnitAbilityLevel(target,'A3KN')==1 then//false promise
				set heal=dmg
				set dmg=0
			elseif GetUnitAbilityLevel(target,'A0RN')>0 and dmg>5 then//refraction//A0RN -> Refraction Prevention
				set heal=dmg
				set dmg=0
			else
				if GetUnitAbilityLevel(target,'A12D')==1 then//ghost ship buff
					set heal=heal+dmg*0.5
					set dmg=dmg-dmg*0.5
				endif
				if GetUnitAbilityLevel(target,'A3KG')==1 then// borrowed time allies
					set heal=heal+dmg*0.5
					call HealUnitFor(LoadUnitHandle(HY,GetHandleId(target),'A3KG'),dmg*0.5)
					set dmg=dmg-dmg*0.5
				endif
				if GetUnitAbilityLevel(target,'A0NA')>0 and GetUnitAbilityLevel(target,'A36D')==0 then//dispersion
					if not(Mode_BO) and GetUnitPrimaryAttribute(target)==3 then
						set heal=heal+dmg*(0.06+0.02*GetUnitAbilityLevel(target,'A0NA'))
						set dmg=dmg-dmg*(0.06+0.02*GetUnitAbilityLevel(target,'A0NA'))
					else
						set heal=heal+dmg*(0.06+0.04*GetUnitAbilityLevel(target,'A0NA'))
						set dmg=dmg-dmg*(0.06+0.04*GetUnitAbilityLevel(target,'A0NA'))
					endif
				endif
				if GetUnitAbilityLevel(target,'A2O4')==2 then//CentaurAghBonus//A2O4 -> Stampede MS Bonus
					set heal=heal+dmg*0.6
					set dmg=dmg-dmg*0.6
				endif
				if LoadInteger(HY,GetHandleId(target),4328)==1 then//winter's curse attacker
					set heal=heal+dmg*0.7
					set dmg=dmg-dmg*0.7
				endif
				if GetUnitAbilityLevel(target,'A1VM')>0 then//overcharge//A1VM -> Overcharge Attack Speed - 1
					set heal=heal+dmg*(0.05*GetUnitAbilityLevel(target,'A1VM'))//A1VM -> Overcharge Attack Speed - 1
					set dmg=dmg-dmg*(0.05*GetUnitAbilityLevel(target,'A1VM'))
				endif
				if dmg>1 then
					if GetUnitAbilityLevel(GetEventDamageSource(),'Aloc')==1 then
						set adjattacker=udg_Hero[GetPlayerId(GetOwningPlayer(GetEventDamageSource()))]
					else
						set adjattacker=GetEventDamageSource()
					endif
					if GetUnitAbilityLevel(adjattacker,'A39D')==1 then//silver edge
						set heal=heal+dmg*0.4
						set dmg=dmg-dmg*0.4
					endif
					set adjattacker=null
				endif
			endif
		endif
		if heal>0 then
			call HealUnitFor(target,heal)
		endif
	endif
	set target=null
endfunction

function AddHeroDamagedTracking takes nothing returns nothing
	if GenericHeroDamagedTrigger==null then
		set GenericHeroDamagedTrigger=CreateTrigger()
		call TriggerAddCondition(GenericHeroDamagedTrigger,Condition(function GenericHeroDamagedActions))
	endif
	call TriggerRegisterUnitEvent(GenericHeroDamagedTrigger,tt_unit1,EVENT_UNIT_DAMAGED)
endfunction

function TowersDamageRegister takes nothing returns nothing
	local real dmg=GetEventDamage()
	local player p=GetOwningPlayer(GetEventDamageSource())
	local unit u=GetTriggerUnit()
	if IsUnitEnemy(u,GetOwningPlayer(GetEventDamageSource())) then
		if GetUnitAbilityLevel(u,'A17R')==1 then
			call HealUnitFor(u,dmg)
		else
			if IsUnitIllusion(GetEventDamageSource()) then
				call HealUnitFor(u,0.25*dmg)
				call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\VampiricAura\\VampiricAuraTarget.mdl",u,"origin"))
				set dmg=dmg*0.75
			endif
			set TotalDamage2Towers[GetPlayerId(p)]=TotalDamage2Towers[GetPlayerId(p)]+R2I(dmg)
		endif
	endif
	set u=null
endfunction

function InitTowersDamageCounter takes nothing returns nothing
	set GenericTowerDamageCounterTrigger=CreateTrigger()
	call TriggerAddAction(GenericTowerDamageCounterTrigger,function TowersDamageRegister)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Top_1,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Mid_1,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Bot_1,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Top_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Mid_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Bot_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Top_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Mid_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Bot_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Tree1,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Sent_Tree2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Elf_Rax_Melee_Top,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Elf_Rax_Melee_Mid,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Elf_Rax_Melee_Bot,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Elf_Rax_Range_Top,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Elf_Rax_Range_Mid,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Elf_Rax_Range_Bot,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,TreeOfLife,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Top_1,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Mid_1,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Bot_1,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Top_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Mid_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Bot_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Top_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Mid_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Bot_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Throne1,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Towers_Scourge_Throne2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Und_Rax_Melee_Top,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Und_Rax_Melee_Mid,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Und_Rax_Melee_Bot,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Und_Rax_Range_Top,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Und_Rax_Range_Mid,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,Und_Rax_Range_Bot,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GenericTowerDamageCounterTrigger,FrozenThrone,EVENT_UNIT_DAMAGED)
endfunction

function BlademailIsIncorrectAttackers takes unit u returns boolean
	local integer id=GetUnitTypeId(u)
	return id=='o00V' or id=='o00T' or id=='o00W' or id=='o00U' or id=='o01C' or id=='o01D' or id=='o01E' or id=='osp4' or id=='o008' or id=='o009' or id=='o000' or id=='o001' or id=='o00A' or id=='o00X' or id=='n00Q' or id=='n00O' or id=='n00P' or id=='n00N' or id=='n01L' or id=='o018' or id=='o002' or id=='o00B' or id=='o01B' or id=='o00M' or id=='o00N' or id=='o00O' or id=='o00L'
	//o00V -> Plague Ward 3, o00T -> Plague Ward 1, o00W -> Plague Ward 4, o00U -> Plague Ward 2, o01C -> Serpent Ward, o01D -> Serpent Ward, o01E -> Serpent Ward, osp4 -> Serpent Ward, o008 -> Serpent Ward, o009 -> Serpent Ward, o000 -> Death Ward, o001 -> Death Ward, o00A -> Death Ward, o00X -> Death Ward, n00Q -> Goblin Land Mine, n00O -> Goblin Land Mine, n00P -> Goblin Land Mine, n00N -> Goblin Land Mine, n01L -> Goblin Land Mine, o018 -> Remote Mine 1, o002 -> Remote Mine 2, o00B -> Remote Mine 3, o01B -> Remote Mine 4, o00M -> Nether Ward 1, o00N -> Nether Ward 4, o00O -> Nether Ward 3, o00L -> Nether Ward 2
endfunction

function BlademailWrapper takes unit attacker, unit target, real dmg returns nothing
	local integer hu=GetHandleId(target)
	if LoadBoolean(HY,hu,'BMON')then
		if IsUnitType(attacker,UNIT_TYPE_STRUCTURE)==false then
			if IsWardUnit(attacker)==false then
				if GetUnitAbilityLevel(attacker,'A04R')>0 then//
					set attacker=udg_Hero[GetPlayerId(GetOwningPlayer(attacker))]
				endif
				call SaveBoolean(HY,hu,'BMON',false)
				set NoReflection=NoReflection+1
				call DamageTarget(target,attacker,3,dmg)
				set NoReflection=NoReflection-1
				call SaveBoolean(HY,hu,'BMON',true)
			endif
		endif
	endif
endfunction

function DamageHappened takes nothing returns boolean
	local unit target=null
	local unit attacker=null
	local unit adjattacker=null
	local real dmg=0
	local integer hu=0
	local real bonusdmg=0
	local player p=null
	local real heal=0
	if IsRealDamage==false then
		return false
	endif
	set target=GetTriggerUnit()
	if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
		set attacker=GetEventDamageSource()
		set dmg=GetEventDamage()
		set bonusdmg=0.
		set bj_cineModePriorDawnDusk=IsUnitType(target,UNIT_TYPE_HERO)//abusing global var
		
		//call echo("Damage to "+GetUnitName(target)+" from "+GetUnitName(attacker))
		if DummyDamageState and GetUnitTypeId(attacker)=='e00E' then//e00E -> Spellcaster
			call MarchOfMachines(attacker,target)
			call BreatheFireBonus(target)
			call LightningStormChecker(attacker,target)
			call Centaur_HoofStompStun(attacker,target)
			call DualBreathDummySlow(attacker,target)
			call WrathOfNatureAgh(attacker,target)
			call RocketBarrageChecker()
		endif
		if dmg>0 and dmg<9000 then
			set hu=GetHandleId(target)
			set TempDataInt[0]=GetUnitTypeId(target)
			if (GetUnitAbilityLevel(attacker,'Aloc')==1) then//Aloc -> Locust
				set adjattacker=udg_Hero[GetPlayerId(GetOwningPlayer(attacker))]
			else
				set adjattacker=attacker
			endif
			if bj_cineModePriorDawnDusk then
				
			else
				if GetUnitAbilityLevel(target,'A1VM')>0 then//overcharge//A1VM -> Overcharge Attack Speed - 1
					set heal=heal+dmg*(0.05*GetUnitAbilityLevel(target,'A1VM'))//A1VM -> Overcharge Attack Speed - 1
					set dmg=dmg-dmg*(0.05*GetUnitAbilityLevel(target,'A1VM'))
				endif
				if GetUnitAbilityLevel(adjattacker,'A39D')==1 then//silver edge debuff
					set TempReal=RMinIF(1.-heal,0.4)
					set heal=heal+TempReal
				endif
				if heal < 1 then
					if GetUnitAbilityLevel(target,'A3KF')==1 then
						set TempReal=Treant_LivingArmorHeal()
						if TempReal>0 then
							set TempReal=RMinIF(1-heal,TempReal/dmg)
							set heal=heal+TempReal
	//						call echo(R2S(dmg*TempReal)+" "+R2S(TempReal))
						endif
					endif
				endif
			endif
			
			if heal>0 then
				if not(IsFrozenSigilId(TempDataInt[0]) or IsNetherWardId(TempDataInt[0]) or IsSupernovaSunId(TempDataInt[0]) or IsTombstoneId(TempDataInt[0]) or IsHomingMissileId(TempDataInt[0]) or IsSwarmBeetleId(TempDataInt[0]) or IsPowerCogId(TempDataInt[0])) then
//					call echo("heal")
					call HealUnitFor(target,dmg*heal)
				else
						//call echo("wards")
				endif
			endif
			set p=GetOwningPlayer(attacker)
			if p!=Sentinels[0] and p!=Scourges[0] and p!=Neutrals then
				if GetUnitAbilityLevel(adjattacker,'A39S')==1  and IsUnitIllusion(target)==false and WL7[GetPlayerId(GetOwningPlayer(target))]==false and GetWidgetLife(adjattacker)>=1 then//octarine healing
					if GetUnitCurrentOrder(attacker)==852487 and (GetUnitAbilityLevel(attacker,'A0CC')!=0 or GetUnitAbilityLevel(attacker,'A02Z')!=0) then//A0CC -> Life Drain, A02Z -> Life Drain
						//pugna life drain damage
						call OctarineHealing(bj_cineModePriorDawnDusk, attacker, dmg)
						////call echo("life drain damage")
					elseif isMineDamage==0 and (GetUnitAbilityLevel(attacker,'Aloc')==1 or IsFakeDamage>0) then//Aloc -> Locust
						call OctarineHealing(bj_cineModePriorDawnDusk, adjattacker, dmg)
					else
						//call echo("Damaged by "+GetUnitName(attacker)+" "+B2S(GetUnitAbilityLevel(attacker,'Aloc')==1)+" "+R2S(dmg))//Aloc -> Locust
					endif
				endif
			endif
			if LoadInteger(HY,GetHandleId(GetTriggeringTrigger()),'AMPL')==0 and NoReflection==0 then
				set bonusdmg=LoadReal(HY,hu,'AMPL')
				if HeroInGame_Queen and (GetUnitAbilityLevel(attacker,'A460')>0) and IsUnitEnemy(attacker,GetOwningPlayer(target)) and AliveNonBuildOrMarker(target) then//A460 -> Mortal Wounds, QP27 -> Mortal Wounds hidden
					call MortalWoundsWrapper(attacker,target)
				endif
				if HeroInGame_BS then
					if (GetUnitAbilityLevel(attacker,'Aloc')>0 or GetUnitAbilityLevel(attacker,'A04R')>0) and IsUnitType(attacker,UNIT_TYPE_HERO)==false then//Aloc -> Locust, 
						set adjattacker=udg_Hero[GetPlayerId(GetOwningPlayer(attacker))]
					else
						set adjattacker=attacker
					endif
					if GetUnitAbilityLevel(adjattacker,'A44Y')>0 or GetUnitAbilityLevel(target,'A44Y')>0 then
						if DistanceBetweenUnits(adjattacker,target)<2200 then
							if GetUnitAbilityLevel(adjattacker,'A44Y')>0 then
								set bonusdmg=bonusdmg+LoadReal(HY,GetHandleId(adjattacker),'A2X9')
							endif
						else
							if GetUnitAbilityLevel(adjattacker,'A44Y')>0 then
								set bonusdmg=bonusdmg+LoadReal(HY,GetHandleId(adjattacker),'A2X9')/2
							endif
							if GetUnitAbilityLevel(target,'A44Y')>0 then
								set bonusdmg=bonusdmg-LoadReal(HY,hu,'A2X9')/2
							endif
						endif
					endif
//					call echo(R2S(dmg)+" dealt, bloodrage bonus = "+R2S(bonusdmg)+" which means "+R2S(dmg*bonusdmg)+" total bonus damage")
				endif
				if bonusdmg > 0 then
					call SaveInteger(HY,GetHandleId(GetTriggeringTrigger()),'AMPL',LoadInteger(HY,GetHandleId(GetTriggeringTrigger()),'AMPL')+1)
					call DamageTarget(attacker,target,3,dmg*bonusdmg)
					call TextTagOnUnitEx("+"+I2S(R2I(dmg*bonusdmg)),4,target,0.028,128,255,0,0,216)//+ " ("+R2S(bonusdmg)+")"
					call SaveInteger(HY,GetHandleId(GetTriggeringTrigger()),'AMPL',LoadInteger(HY,GetHandleId(GetTriggeringTrigger()),'AMPL')-1)
				endif
				//call TextTagOnUnitEx("+"+I2S(R2I(dmg)),4,target,0.028,64,255,0,0,216)
			endif
			if GetUnitAbilityLevel(target,'A43C')>0 and IsUnitEnemy(attacker,GetOwningPlayer(target)) and NoReflection==0 and isMineDamage==0 then
				call BlademailWrapper(attacker,target,dmg)
			endif
			if IsFakeDamage<1 then
				
			endif
			
		endif
		if IsL1ch then
			call TextTagOnUnitEx("+"+I2S(R2I(dmg)),1,target,0.028,64,255,0,0,216)
		endif
	endif
	
	set target=null
	set attacker=null
	return false
endfunction

function DamageRegisterEnter takes nothing returns boolean
	local unit u=GetTriggerUnit()
	local integer hu=GetHandleId(u)
//	call echo(GetUnitName(u)+" entered")
	if GetUnitAbilityLevel(u,'Aloc')==0 and GetOwningPlayer(u)!=Player(15) then//Aloc -> Locust
		call TriggerRegisterUnitEvent(DamageRegister,u,EVENT_UNIT_DAMAGED)
	endif
	set u=null
	return false
endfunction

function IgniteWrapper takes nothing returns nothing
	local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetUnitFacing(GetTriggerUnit()))
	call UnitAddAbility(d,'A3IK')
	call SetUnitAbilityLevel(d,'A3IK',GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
	call IssueTargetOrder(d,"acidbomb",GetSpellTargetUnit())
	set d=null
endfunction

function OctarineLeveling takes unit u, integer lvl returns nothing
	call SetUnitAbilityLevel(u,'A11F',lvl)//A11F -> Avatar
	call SetUnitAbilityLevel(u,'A3BP',lvl)
	call SetUnitAbilityLevel(u,'A1R5',lvl)//A1R5 -> Scroll of Teleporation (fixed)
	call SetUnitAbilityLevel(u,'A11E',lvl)//A11E -> Avatar
	call SetUnitAbilityLevel(u,'A0S3',lvl)//A0S3 -> Avatar
	call SetUnitAbilityLevel(u,'A11D',lvl)//A11D -> Avatar
	call SetUnitAbilityLevel(u,'A11G',lvl)//A11G -> Avatar
	call SetUnitAbilityLevel(u,'A11H',lvl)//A11H -> Avatar
	call SetUnitAbilityLevel(u,'A0T9',lvl)//A0T9 -> ICEARMORNEW (NEW)
	call SetUnitAbilityLevel(u,'A2TK',lvl)
	call SetUnitAbilityLevel(u,'A1WE',lvl)//A1WE -> Manta Image (ranged)
	call SetUnitAbilityLevel(u,'A0B8',lvl)//A0B8 -> Manta Image
	call SetUnitAbilityLevel(u,'AChx',lvl)//AChx -> Guinsoo's Scythe
	call SetUnitAbilityLevel(u,'A0FD',lvl)//A0FD -> Orchid Malevolence
	call SetUnitAbilityLevel(u,'A1T7',lvl)//A1T7 -> Eul Cyclone
	call SetUnitAbilityLevel(u,'A19M',lvl)//A19M -> Force Staff
	call SetUnitAbilityLevel(u,'A02O',lvl)//A02O -> Finger of Death
	call SetUnitAbilityLevel(u,'A08Y',lvl)//A08Y -> Finger of Death
	call SetUnitAbilityLevel(u,'A08Z',lvl)//A08Z -> Finger of Death
	call SetUnitAbilityLevel(u,'A090',lvl)//A090 -> Finger of Death
	call SetUnitAbilityLevel(u,'A092',lvl)//A092 -> Finger of Death
	call SetUnitAbilityLevel(u,'A0HB',lvl)//A0HB -> Item Skeleton Summon lvl 1
	call SetUnitAbilityLevel(u,'A0D3',lvl)//A0D3 -> Item Skeleton Summon lvl 2
	call SetUnitAbilityLevel(u,'A0DF',lvl)//A0DF -> Item Skeleton Summon lvl 3
	call SetUnitAbilityLevel(u,'A02W',lvl)//A02W -> Item Cooldown Reset
	call SetUnitAbilityLevel(u,'A28D',lvl)//A28D -> Veil of Discord
	call SetUnitAbilityLevel(u,'A2EA',lvl)//A2EA -> Rod of atos
	call SetUnitAbilityLevel(u,'A0CK',lvl)//A0CK -> Mekansm Armor + Heal
	call SetUnitAbilityLevel(u,'A0K7',lvl)//A0K7 -> Arcane Ring
	call SetUnitAbilityLevel(u,'A1EW',lvl)//A1EW -> Khadgar's Pipe of Insight
	call SetUnitAbilityLevel(u,'A1MO',lvl)//A1MO -> Urn of shadows
	call SetUnitAbilityLevel(u,'A1ZW',lvl)//A1ZW -> Ancient Jangoo
	call SetUnitAbilityLevel(u,'A2K7',lvl)//A2K7 -> Annihilator Stun
	call SetUnitAbilityLevel(u,'A017',lvl)//A017 -> Wind Walk
	call SetUnitAbilityLevel(u,'A1QD',lvl)//A1QD -> Ether Blast
	call SetUnitAbilityLevel(u,'A1FP',lvl)//A1FP -> Satanic this
	call SetUnitAbilityLevel(u,'AIxk',lvl)//AIxk -> Berserk
	call SetUnitAbilityLevel(u,'A0JL',lvl)//A0JL -> Static Charge
	call SetUnitAbilityLevel(u,'AIpg',lvl)//AIpg -> Item Purge
	call SetUnitAbilityLevel(u,'A2K4',lvl)//A2K4 -> Prudence
	call SetUnitAbilityLevel(u,'A231',lvl)//A231 -> Boots of Travel (fixed)
	call SetUnitAbilityLevel(u,'A28Y',lvl)//A28Y -> Hand of Midas
	call SetUnitAbilityLevel(u,'A12W',lvl)//A12W -> Phase Boots - Phase
	call SetUnitAbilityLevel(u,'A1Q8',lvl)//A1Q8 -> Soul Ring
	call SetUnitAbilityLevel(u,'A0JY',lvl)//A0JY -> Magic Stick
	call SetUnitAbilityLevel(u,'AIbk',lvl)//AIbk -> Blink (Item Version)
	call SetUnitAbilityLevel(u,'A1AC',lvl)//A1AC -> Ghost Potion
	call SetUnitAbilityLevel(u,'AItb',lvl)//AItb -> Dust of Appearance
	call SetUnitAbilityLevel(u,'A38V',lvl)
	call SetUnitAbilityLevel(u,'A395',lvl)
	call SetUnitAbilityLevel(u,'A39C',lvl)
	call SetUnitAbilityLevel(u,'A3AG',lvl)
	call SetUnitAbilityLevel(u,'A42I',lvl)//Crimson
endfunction

function OctarineCoreDrop takes nothing returns nothing
//	call OctarineLeveling(tt_unit1,1)
endfunction

function LotusOrbInterruptingSpell takes integer id returns boolean
	return id=='A04C' or id=='A0A2' or id=='A0MU' or id=='A0I7' or id=='Z604' or id=='A07F' or id=='A0MN' or id=='A0G6' or id=='A08C' or id=='A1H5' or id=='A0OJ' or id=='A27G' or id=='A1S8' or id=='A010' or id=='A0RX' or id=='A2HN' or id=='A14R' or id=='A049' or id=='A33G' or id=='A26N' or id=='A0R5' or id=='A020' or id=='A0EC' or id=='A04Y' or id=='AChx' or id=='A1T7' or id=='A02O' or id=='A08Y' or id=='A08Z' or id=='A090' or id=='A092' or id=='A094'
	//A04C -> Frostbite, A0A2 -> Doom, A0MU -> Doom, A0I7 -> Malefice, Z604 -> Cold Snap, A07F -> Frost Nova, A0MN -> Voodoo, A0G6 -> Adaptive Strike, A08C -> Crippling Fear, A1H5 -> Mana Burn, A0OJ -> Astral Imprisonment, A27G -> Fade Bolt, A1S8 -> Disruption, A010 -> Ether Shock, A0RX -> Voodoo, A2HN -> Ancient Seal, A14R -> Electric Vortex, A049 -> Laser, A33G -> Laser, A26N -> Leech Seed, A0R5 -> Soul Rip, A020 -> Arc Lightning, A0EC -> Bloodrage, A04Y -> Nightmare, AChx -> Guinsoo's Scythe, A1T7 -> Eul Cyclone, A02O -> Finger of Death, A08Y -> Finger of Death, A08Z -> Finger of Death, A090 -> Finger of Death, A092 -> Finger of Death
endfunction

function LotusOrbDelayedCast takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call LotusOrbCasting(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1),LoadInteger(HY,h,0))
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function LotusOrbDelayed takes unit d, unit target, integer order returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0,false,function LotusOrbDelayedCast)
	call SaveUnitHandle(HY,h,0,d)
	call SaveUnitHandle(HY,h,1,target)
	call SaveInteger(HY,h,0,order)
	set t=null
endfunction

function EchoShellLotusOrb takes nothing returns nothing
	local unit target=GetSpellTargetUnit()
	local integer id=GetSpellAbilityId()
	local unit caster=GetTriggerUnit()
	local unit u=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)//e00E -> Spellcaster
	local integer order=GetUnitCurrentOrder(caster)
	local integer i
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_CAST)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_CHANNEL)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_ENDCAST)
	call SaveUnitHandle(HY,GetHandleId(u),0,target)
	call LotusOrbFX(target)
	call UnitAddAbility(u,id)
	call SetUnitAbilityLevel(u,id,GetUnitAbilityLevel(caster,id))
	if id=='A04P' then//A04P -> Assassinate
		call UnitRemoveAbility(u,id)
		set id='A3E3'
		call UnitAddAbility(u,id)
		call SetUnitAbilityLevel(u,id,GetUnitAbilityLevel(caster,'A04P'))//A04P -> Assassinate
		set order=852095
	endif
	
	if LoadBoolean(HY,GetHandleId(caster),'REFL') then
		set caster=LoadUnitHandle(HY,GetHandleId(caster),'REFL')
	endif
	if order>=852008 and order<=852013 then
		call UnitRemoveAbility(u,id)
		set i=GetItemTypeId(UnitItemInSlot(caster,order-852008))
//		call echo(Id2String(i))
		set id=LoadInteger(UTable,'A3E9',i)
		call UnitAddAbility(u,id)
		if LoadBoolean(UTable,'A3E9',i) then
			set order=S2I(LoadStr(UTable,'A3E9',i))
		else
			set order=OrderId(LoadStr(UTable,'A3E9',i))
		endif
	endif
//	call echo("Added "+GetObjectName(id)+" with level "+I2S(GetUnitAbilityLevel(u,id))+", trying to cast via order "+I2S(order)+" ("+OrderId2String(order)+")")
	if LotusOrbInterruptingSpell(id) then
		call LotusOrbDelayed(u,caster,order)
	else
		call LotusOrbCasting(u,caster,order)
	endif
	set u=null
	set target=null
	set caster=null
endfunction

function EchoShellLotusOrbChannelsEnd takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	call UnitRemoveAbility(GetTriggerUnit(),LoadInteger(HY,GetHandleId(t),0))
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTrigger(t)
	set t=null
endfunction

function EchoShellLotusOrbChannels takes nothing returns nothing
	local unit shelled=GetSpellTargetUnit()
	local unit caster=GetTriggerUnit()
	local integer id=GetSpellAbilityId()
	local integer lvl=GetUnitAbilityLevel(caster,id)
	local trigger t
	local integer h
	if GetUnitAbilityLevel(shelled,id)==0 then
		call UnitAddAbility3(shelled,id,lvl)
		set LotusUnloopBool=true
		if IssueTargetOrder(shelled,"drain",caster) then
			set t=CreateTrigger()
			set h=GetHandleId(t)
			call TriggerRegisterUnitEvent(t,shelled,EVENT_UNIT_SPELL_ENDCAST)
			call TriggerRegisterUnitEvent(t,shelled,EVENT_UNIT_ISSUED_ORDER)
			call TriggerRegisterUnitEvent(t,shelled,EVENT_UNIT_ISSUED_TARGET_ORDER)
			call TriggerRegisterUnitEvent(t,shelled,EVENT_UNIT_ISSUED_POINT_ORDER)
			call TriggerAddCondition(t,Condition(function EchoShellLotusOrbChannelsEnd))
			call SaveInteger(HY,h,0,id)
			set t=null
		else
			call UnitRemoveAbility(shelled,id)
		endif
		set LotusUnloopBool=false
	endif
	set shelled=null
	set caster=null
endfunction

function EchoShellLotusOrbStopLeashEnd takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call InterruptUnit(LoadUnitHandle(HY,h,0))
	call LotusOrbFX(LoadUnitHandle(HY,h,1))
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
endfunction

function EchoShellLotusOrbStopLeash takes nothing returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call SaveUnitHandle(HY,h,0,GetTriggerUnit())
	call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
	call TimerStart(t,0,false,function EchoShellLotusOrbStopLeashEnd)
	set t=null
endfunction

function LotusOrbExceptions takes integer id returns boolean
	return id=='A06B' or id=='A471' or id=='A0LK' or id=='A27H' or id=='A05S' or id=='A08V' or id=='A1MO' or id=='A1ZI' or id=='A0FN' or id=='A0K9' or id=='A06I' or id=='A0O7' or id=='A0O6' or id=='A0O5' or id=='A1B1' or id=='A0N8' or id=='A01F' or id=='A02S' or id=='A085' or id=='QB06' or id=='A078' or id=='A1OV'
	//A0LK -> Time Walk, A27H -> Spell Steal, A08V -> Repel, A1MO -> Urn of shadows, A1ZI -> Medallion of Courage, A0FN -> Waveform, A0K9 -> Blink Strike, A06I -> Meat Hook
endfunction

function LotusOrbChannelings takes integer id returns boolean
	return id=='A02N' or id=='A0CC' or id=='A02Z'//A02N -> Mana Drain, A0CC -> Life Drain, A02Z -> Life Drain
endfunction

function LotusOrbNonSupportedYet takes integer id returns boolean
	return id=='A10R'//A10R -> Devour
endfunction

function LotusOrbLeashingStoppedInside takes integer id returns boolean
	return id=='A02Q' or id=='A1D9'//A02Q -> Fiend's Grip, A1D9 -> Fiend's Grip Upgrade
endfunction

function LotusOrbLeashing takes integer id returns boolean
	return id=='A0FL' or id=='A1CX' or id=='A00P' or id=='A02Q' or id=='A1D9'//A0FL -> Dismember, A1CX -> Dismember Upgraded, A00P -> Shackles, A02Q -> Fiend's Grip, A1D9 -> Fiend's Grip Upgrade
endfunction

function LotusOrbWorkaroundInSkill takes integer id returns boolean
	return id=='A0IN' or id=='A1AW' or id=='A05T' or id=='A08H' or id=='A0BZ' or id=='A004' or id=='A0FW' or id=='A0BH' or id=='A055' or id=='QB00' or id=='A0YM' or id=='A2QT' or id=='A10D' or id=='A0G4' or id=='A1D8' or id=='A190' or id=='A1NH' or id=='A2BE' or id=='A02A' or id=='A1NA' or id=='A0NM' or id=='A2LA' or id=='AHtb' or id=='QB0H' or id=='A0JC' or id=='A3FR' or id=='A0NQ'//A05T -> Chain Frost, A08H -> Chain Frost, A0BZ -> Toss, A004 -> Shuriken Toss, A0FW -> Viscous Nasal Goo, A0BH -> Spawn Spiderlings, A055 -> Chaos Bolt, QB00 -> Chaos Bolt, A0YM -> Stifling Dagger, A2QT -> Fortune's End, A10D -> Spirit Lance, A0G4 -> Nether Strike, A1D8 -> Nether Strike Upgrade, A190 -> Storm Bolt, A1NH -> Unstable Concoction, A2BE -> Arcane Bolt, A02A -> Magic Missile, A1NA -> Soul Assumption, A0NM -> Paralyzing Cask, A2LA -> Splinter Blast, AHtb -> Hellfire Blast, QB0H -> Hellfire Blast, A0JC -> Lightning Bolt, A0NQ -> Poison Touch
endfunction

function SpellWrappers_Summon takes nothing returns nothing
	local integer k=0
	loop
		exitwhen HaveSavedString(UTable,'SPLL',k)==false
		call ExecuteFunc(LoadStr(UTable,'SPLL',k))
//		call echo(LoadStr(UTable,'DMGE'+i,k)+" "+I2S(i))
		set k=k+1
	endloop
endfunction

function AddWrapperToSpell takes string s returns nothing
	local integer i=0
	loop
		exitwhen HaveSavedString(UTable,'SPLL',i)==false
		if LoadStr(UTable,'SPLL',i)==s then
			return
		endif
		set i=i+1
	endloop
	call SaveStr(UTable,'SPLL',i,s)
endfunction

function Zeus_StaticField_Worker takes nothing returns nothing
	call Zeus_Static_Field_Condition(GetTriggerUnit(),GetSpellAbilityId())
endfunction

function Earthshaker_Aftershock_Condition_Worker takes nothing returns nothing
	call Earthshaker_Aftershock_Condition(GetTriggerUnit(),GetSpellAbilityId())
endfunction

function Bristleback_Warpath_Condition_Worker takes nothing returns nothing
	call Bristleback_Warpath_Condition(GetTriggerUnit(),GetSpellAbilityId())
endfunction

function Phoenix_Sunray_Stop_Worker takes nothing returns nothing
	call Phoenix_Sunray_Stop(GetTriggerUnit(),GetSpellAbilityId())
endfunction

function Silencer_LastWordPassive_Check_Worker takes nothing returns nothing
	if GetUnitAbilityLevel(GetTriggerUnit(),'B0H0')>0 then
		call Silencer_LastWordPassive_Check(GetTriggerUnit(),GetSpellAbilityId())
	endif
endfunction

//Generic event functions that are called everytime the event occurs
//===========================================================================================
function LoDSpell_Generic takes unit u, integer spell returns nothing
	local integer id=spell
	local unit target=GetSpellTargetUnit()
	call InitOnSpellCDStarts(GetUnitAbilityLevel(u,spell))
//	if GetUnitAbilityLevel(u,'A39S')==1 then
//		call ReduceCooldown(u,id,true,OCTARINECOOLDOWNREDUCE)
//		call OctarineLeveling(u,2)
//	endif
	if target!=null and IsUnitEnemy(u,GetOwningPlayer(target)) and GetUnitAbilityLevel(target,'A3E9')==1 and (GetUnitAbilityLevel(u,'Aloc')==0 or LoadBoolean(HY,GetHandleId(u),'REFL')) then//Aloc -> Locust
		if IsPoisonArrowSkill(id)==false and LotusOrbChannelings(id)==false and LotusOrbNonSupportedYet(id)==false and LotusOrbExceptions(id)==false and LotusUnloopBool==false and LotusOrbWorkaroundInSkill(id)==false then
			if LotusOrbChannelings(id) then
				call EchoShellLotusOrbChannels()
			else
				if LotusOrbLeashing(id)==false then
					call EchoShellLotusOrb()
				elseif LotusOrbLeashingStoppedInside(id)==false then
					call EchoShellLotusOrbStopLeash()
				endif
			endif
		endif
	endif
	call SpellWrappers_Summon()
//	if GetUnitAbilityLevel(u,'B0H0')>0 then//B0H0 -> Last Word aura
//		call Silencer_LastWordPassive_Check(u,spell)
//	endif
	if Reduced_Spell(spell)then
		call Reduced_Spell_Proc(u,spell)
	endif
	if IsPoisonArrowSkill(spell) then
		call UDS(u,target,true)
	endif
	set target=null
endfunction

function LoDOrder_Generic takes unit u, integer order, eventid id returns nothing
	if id==EVENT_UNIT_ISSUED_ORDER then
		if GetUnitAbilityLevel(u,'A0QN')>0 then//A0QN -> Burning Spear
			if order==852255 or order==852458 then//poison arrows on
				call SaveBoolean(MHT,GetHandleId(u),'A0QN',true)//A0QN -> Burning Spear
				call UnitAddAbility2(u,'A40H')
			elseif order==852256 or order==852459 then//poison arrows off
				call SaveBoolean(MHT,GetHandleId(u),'A0QN',false)//A0QN -> Burning Spear
				call UnitRemoveAbility(u,'A40H')
			endif
		endif
		if order==852129 and (IsUnitDisabled(u)or IsUnitCycloned(u)) then//windwalk
			if GetUnitAbilityLevel(u,'A0NS')>0 or GetUnitAbilityLevel(u,'A1DA')>0 then//A0NS -> Borrowed Time, A1DA -> Borrowed Time Upgrade
				if LoadBoolean(MHT,'A0NS',GetHandleId(u)) then//A0NS -> Borrowed Time
					call Abbadon_Time_Effect(u,GetHandleId(u))
				else
					call Error(GetOwningPlayer(GetTriggerUnit()),"Spell is not ready yet.")
				endif
			endif
		endif
//		if order==852150 then
//			call DisableTrigger(GetTriggeringTrigger())
//			call InterruptUnit(GetTriggerUnit())
//			call echo("asdsd")
//			call IssueImmediateOrderById(GetTriggerUnit(),852151)
//			call EnableTrigger(GetTriggeringTrigger())
//		endif
	endif
	if id==EVENT_UNIT_ISSUED_TARGET_ORDER then
		if GetUnitAbilityLevel(u,'A0QN')>0 then//A0QN -> Burning Spear
			if order==852225 then//frost armor
				call InterruptUnit(u)
				set IsOrbAttack=true
				call IssueTargetOrder(u,"attackonce",GetOrderTargetUnit())
				set IsOrbAttack=false
				call UnitAddAbility2(u,'A40H')
				call SaveBoolean(MHT,GetHandleId(u),'A0QN'+1,true)//A0QN -> Burning Spear
				call SaveUnitHandle(MHT,GetHandleId(u),'A0QN'+1,GetOrderTargetUnit())//A0QN -> Burning Spear
			endif
		endif
	endif
	call Phoenix_Sunray_Orders(u,order)
	call Wyvern_Curse_Reorder(u)
endfunction

function LoDAttack_Generic takes unit attacker, unit target returns nothing
	if Slark_ShadowDance_Attacked(attacker,target) then
		return
	endif
	call UDS(attacker,target,false)
endfunction

function BroodSpideriteCreate takes nothing returns nothing
	local integer i=GetUnitAbilityLevel(ADSG_Victim,'A3B8')
	local real x=GetUnitX(ADSG_Victim)
	local real y=GetUnitY(ADSG_Victim)
	local player p=Player(LoadInteger(HY,GetHandleId(ADSG_Victim),'A3B8'))
	local unit u
	if p==Player(0) then
		return
	endif
	if i==0 then
		set i=GetUnitAbilityLevel(udg_Hero[LoadInteger(HY,GetHandleId(ADSG_Victim),'A3B8')],'A0BH')
	endif
	if i==0 then
		set i=4
	endif
	loop
		set u=CreateUnit(p,'n019',x,y,0)//n019 -> Spiderling
		call UnitApplyTimedLife(u,'BTLF',60)
		set i=i-1
		exitwhen i==0
	endloop
endfunction

function BroodSpideriteCheck takes nothing returns nothing
	if LoadInteger(HY,GetHandleId(ADSG_Victim),'A3B8')>0 then
		call BroodSpideriteCreate()
	endif
endfunction

function AddHeroWrappersOnDeath takes unit u returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
	call TriggerAddCondition(t,Condition(function HeroDeath))
	call TriggerAddCondition(t,Condition(function FB_Check))
	call TriggerAddCondition(t,Condition(function StormModel_Death))
	call TriggerAddCondition(t,Condition(function XinModel_Death))
	call TriggerAddCondition(t,Condition(function KaolinModel_Death))
	call TriggerAddCondition(t,Condition(function BloodStoneWrap))
	//call TriggerAddCondition(t,Condition(function Rot_Suicide))
	call TriggerAddCondition(t,Condition(function RequiemWrapperOnDeath))
	call TriggerAddCondition(t,Condition(function BH_TrackKill))
	
	set t=null
endfunction

function DragonhideAuraFilter takes nothing returns boolean
	return GetUnitAbilityLevel(GetFilterUnit(),'B3JF')>0 and IsUnitAlly(GetFilterUnit(),tt_player1) and AliveNonBuildOrMarker(GetFilterUnit()) and GetFilterUnit()!=Roshan//B306 -> Solid Granite Aura
endfunction

function DragonhideAuraTick takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local group affected=LoadGroupHandle(HY,h,1)
	local unit u=LoadUnitHandle(HY,h,0)
	local unit u2
	local group g
	local group gg
	local integer bon
	local integer savedbon
	if IsDead(u) or u==null then
		call FlushChildHashtable(HY,h)
		call PauseTimer(t)
		call DestroyTimer(t)
		loop
			set u2=FirstOfGroup(affected)
			exitwhen u2==null
			call GroupRemoveUnit(affected,u2)
			call LoDStat_Sub(u2,2,"armour")
		endloop
		call KillGroup(affected)
	else
		set g=GetAvailableGroup()
		set tt_player1=GetOwningPlayer(u)
		call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),925,Condition(function DragonhideAuraFilter))
		set gg=GetAvailableGroup()
		call GroupAddGroup(affected,gg)
		loop
			set u2=FirstOfGroup(gg)
			exitwhen u2==null
			if IsUnitInGroup(u2,g)==false then
				call GroupRemoveUnit(affected,u2)
				call LoDStat_Sub(u2,2,"armour")
			endif
			call GroupRemoveUnit(gg,u2)
		endloop
		call KillGroup(gg)
		loop
			set u2=FirstOfGroup(g)
			exitwhen u2==null
			if IsUnitInGroup(u2,affected)==false then
				call LoDStat_Add(u2,2,"armour")
			endif
			call GroupRemoveUnit(g,u2)
			call GroupAddUnit(affected,u2)
		endloop
		call KillGroup(g)
	endif
	set t=null
	set affected=null
	set u=null
	set g=null
	set gg=null
endfunction

function DragonhideAura takes unit u returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0.5,true,function DragonhideAuraTick)
	call SaveUnitHandle(HY,h,0,u)
	call SaveGroupHandle(HY,h,1,GetAvailableGroup())
	set t=null
endfunction

function GenericAegisDeathEventMakeGround takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	call RemoveAbilsForUnit(LoadUnitHandle(HY,h,0))
	call SetTerrainPathable(LoadReal(HY,h,0),LoadReal(HY,h,1),PATHING_TYPE_WALKABILITY,false)
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function DelayedAuraRemoving2 takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	call RemoveAbilsForUnit(u)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set u=null
endfunction

function DelayedAuraRemoving takes unit u, real de returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,de,false,function DelayedAuraRemoving2)
	call SaveUnitHandle(HY,h,0,u)
	set t=null
endfunction

function GenericAegisDeathEvent takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local timer t
	local real x
	local real y
	local integer i=GetUnitTypeId(u)
	local boolean b=false
	local real timeout=0.
	call RemoveDispellableBuffs(u)
	if GetUnitAbilityLevel(u,'AIrc')==1 or GetUnitAbilityLevel(u,'A3DK')>0 or GetUnitAbilityLevel(u,'A01Y')>0 or GetUnitAbilityLevel(u,'A1AZ')>0 or GetUnitAbilityLevel(u,'A46S')==1 or GetUnitAbilityLevel(u,'A14K')==1 then
		if GetUnitAbilityLevel(u,'AIrc')==1 then
			set timeout=5.01
		elseif GetUnitAbilityLevel(u,'A3DK')>0 then
			set timeout=0.01
		endif
		call DelayedAuraRemoving(u,timeout)
		set x=GetUnitX(u)
		set y=GetUnitY(u)
		if IsTerrainPathable(x,y,PATHING_TYPE_WALKABILITY)then
			set t=CreateTimer()
			call TimerStart(t,0,false,function GenericAegisDeathEventMakeGround)
			call SaveReal(HY,GetHandleId(t),0,x)
			call SaveReal(HY,GetHandleId(t),1,y)
			call SaveUnitHandle(HY,GetHandleId(t),0,u)
			call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,true)
			set t=null
		endif
	endif
	set u=null
endfunction

function GenericAegisDeathEventInit takes nothing returns nothing
	if AegisHelper==null then
		set AegisHelper=CreateTrigger()
		call TriggerAddCondition(AegisHelper,Condition(function GenericAegisDeathEvent))
	endif
	call TriggerRegisterDeathEvent(AegisHelper,tt_unit1)
endfunction

function Fix_EnteringHeroes takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local unit rHero=u
	local player p=GetOwningPlayer(u)
	local integer i=1
	local integer lvl=0
	local trigger t
	local boolean b=IsUnitType(u,UNIT_TYPE_HERO)
	local boolean b2=false
	local integer id=GetUnitTypeId(u)
	if b then
		set b2=IsFakeHero2(u)
	endif
	if id=='u00G' then//u00G -> Ghosts
		call ExorcismGhost(u)
	elseif id=='efon' or id=='efo2' then//furion
		call ForceOfNatureEntering(u)
	elseif id=='n01E' or id=='n019' then//spiderling spiderite
		call LittleSpidersEntering(u)
	elseif id=='o005' or id=='o006' or  id=='o007' or  id=='o00F' then//wolves
		call SummonWolvesEntering(u)
	elseif id=='osp4' or id=='o008' or id=='o009' or id=='o01C' or id=='o01D' or id=='o01E'then//serpent ward
		call ShadowShaman_MassSerpentWard(u)
	elseif id=='ushd' then
		call WatcherGhostEntering(u)
	elseif id=='u012' then
		call ScarabUrnaSwarmEntering(u)
	elseif id=='o004' or id=='oeye' then//o004 -> Observer Ward, oeye -> Sentry Ward
		call Func0686(u,u)
		if id=='oeye' then//oeye -> Sentry Ward
			call TimedReveal(GetOwningPlayer(u),12,GetUnitX(u),GetUnitY(u),150)
		endif
	elseif id=='n020' then//living dead//n020 -> Living Dead
		set i=GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A0A8')
		if i>0 then
			call UnitAddAbility3(u,'A3J8',i)
			call UnitAddAbility3(u,'A3J9',i)
		endif
		call AddMaxHPFx(u,R2I(GetUnitState(udg_Hero[GetPlayerId(GetOwningPlayer(u))],UNIT_STATE_MAX_LIFE)*(0.2+0.05*i)))
	endif
	if GetOwningPlayer(u)==Neutrals or GetOwningPlayer(u)==Sentinels[0] or GetOwningPlayer(u)==Scourges[0] then
		if Mode_AH then
			call UnitAddAbility2(u,'A44F')
		endif
		if GetUnitAbilityLevel(u,'A44G')>0 then//A44G -> Solid Granite Aura
			call BonusHPAura(u)
		endif
		if GetUnitAbilityLevel(u,'A3JF')>0 then
			call DragonhideAura(u)
		endif
	endif
	if b and b_isPickTime==false and (b2==false) and LoadBoolean(HY,GetHandleId(u),TEMPEST)==false then//H00M -> Bloodrune
//		call echo(B2S(TempestIncoming))
		set tt_unit1=u
		call GenericAegisDeathEventInit()
		call ExecuteFunc("AddHeroDamagedTracking")
		call GroupAddUnit(AllEnteredHeroesGroup,u)
		call AddHeroWrappersOnDeath(u)
	endif
	if b==false or b2 or b_isPickTime then
		if IsUnitIllusion(u)==false then
			set u=null
			set rHero=null
			return
		endif
	endif
	if IsUnitIllusion(u) then
		set rHero=udg_Hero[GetPlayerId(p)]
		call SelectSummons(u)
	else
		set t=CreateTrigger()
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_HERO_SKILL)
		call TriggerAddCondition(t,Condition(function GeneralLearnC))
		set t=CreateTrigger()
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_ENDCAST)
		call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_EFFECT)
		call TriggerAddCondition(t,Condition(function Wait0SecPlz))
		call SaveUnitHandle(HY,GetHandleId(t),0,u)
		set i=1
		//call echo("del")
		loop
			set lvl=GetUnitAbilityLevel(rHero,PassivesLearningSkill[i])
			if lvl==0 and PassivesSpellbookID[i]>0 then
				call UnitRemoveAbility(u,PassivesSpellbookID[i])
				call UnitRemoveAbility(u,PassivesBuffID[i])
			endif
			set i=i+1
			exitwhen i>PassivesCount
		endloop
	endif
	
	//call BonusEffectWrapper(rHero,rHero)
	set u=null
	set rHero=null
	set t=null
endfunction

function FixPassiveSkills takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddCondition(t,Condition(function FixPassiveSkills_FixHero))
	call TriggerAddCondition(t,Condition(function Fix_EnteringHeroes))
	
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function FixPassiveSkills_LevelIllusions))
	call ExecuteFunc("StoreAllPassives")
	
	set t=null
endfunction

function AddWrapperToDeath takes string s returns nothing
	local integer i=0
	loop
		exitwhen HaveSavedString(UTable,'DEAD',i)==false
		if LoadStr(UTable,'DEAD',i)==s then
			return
		endif
		set i=i+1
	endloop
	call SaveStr(UTable,'DEAD',i,s)
endfunction

function OnDeath_Rot_Suicide takes nothing returns nothing
	//call Rot_Suicide(ADSG_Killer,ADSG_Victim)
endfunction

function OnDeath_Rot_SuicideWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_Rot_Suicide")
endfunction

function OnDeath_BH_TrackKill takes nothing returns nothing
	//call BH_TrackKill(ADSG_Victim)
endfunction

function OnDeath_BH_TrackKillWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_BH_TrackKill")
endfunction

function OnDeath_Silencer_IntSteal takes nothing returns nothing
	call Silencer_IntSteal(ADSG_Killer,ADSG_Victim)
endfunction

function OnDeath_Silencer_IntStealWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_Silencer_IntSteal")
endfunction

function OnDeath_StoneOwnerDeath takes nothing returns nothing
	call StoneOwnerDeath(ADSG_Victim)
endfunction

function OnDeath_StoneOwnerDeathWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_StoneOwnerDeath")
endfunction

function OnDeath_CommandAura takes nothing returns nothing
	if IsUnitType(ADSG_Victim,UNIT_TYPE_HERO) and GetUnitAbilityLevel(ADSG_Victim,'ACac')>0 and IsPlayerBelongToTeams(GetOwningPlayer(ADSG_Killer)) and IsUnitEnemy(ADSG_Killer,GetOwningPlayer(ADSG_Victim))  then//ACac -> Command Aura
		if IsUnitType(ADSG_Killer,UNIT_TYPE_HERO) then
			call VS_VengeanceAuraApply(GetUnitAbilityLevel(ADSG_Victim,'ACac'),ADSG_Killer,ADSG_Victim)//ACac -> Command Aura
		else
			if IsDead(udg_Hero[GetPlayerId(GetOwningPlayer(ADSG_Killer))])==false then
				call VS_VengeanceAuraApply(GetUnitAbilityLevel(ADSG_Victim,'ACac'),udg_Hero[GetPlayerId(GetOwningPlayer(ADSG_Killer))],ADSG_Victim)//ACac -> Command Aura
			endif
		endif
	endif
endfunction

function OnDeath_CommandAuraWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_CommandAura")
endfunction

function OnDeath_RemoteMineDeath takes nothing returns nothing
	call RemoteMineDeath(ADSG_Victim)
endfunction

function OnDeath_RemoteMineDeathWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_RemoteMineDeath")
endfunction

function OnDeath_UndyingZombie takes nothing returns nothing
	call UndyingZombie(ADSG_Victim)
endfunction

function OnDeath_UndyingZombieWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_UndyingZombie")
endfunction

function OnDeath_Templar_Trap_Start_Wrap takes nothing returns nothing
	call Templar_Trap_Start_Wrap(ADSG_Victim)
endfunction

function OnDeath_Templar_Trap_Start_WrapWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_Templar_Trap_Start_Wrap")
endfunction

function OnDeath_CourierDeath takes nothing returns nothing
	call CourierDeath(ADSG_Victim)
endfunction

function OnDeath_SpiritBear_Death takes nothing returns nothing
	call SpiritBear_Death(ADSG_Killer,ADSG_Victim)
	call Lone_HeroDeath_KillBear(ADSG_Victim)
endfunction

function OnDeath_SpiritBear_DeathWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_SpiritBear_Death")
endfunction

function OnDeath_BroodSpideriteCheck takes nothing returns nothing
	call BroodSpideriteCheck()
endfunction

function OnDeath_BroodSpideriteCheckWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_BroodSpideriteCheck")
endfunction

function OnDeath_WrathOfNatureKillsWrapper takes nothing returns nothing
	call AddWrapperToDeath("WrathOfNatureKills")
endfunction

function OnDeath_Alchemist_Greed_Condition takes nothing returns nothing
	call Alchemist_Greed_Condition(ADSG_Killer,ADSG_Victim)
endfunction

function OnDeath_Alchemist_Greed_ConditionWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_Alchemist_Greed_Condition")
endfunction

function OnDeath_BS_BloodBath takes nothing returns nothing
	call BS_BloodBath(ADSG_Killer,ADSG_Victim)
endfunction

function OnDeath_BS_BloodBathWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_BS_BloodBath")
endfunction

function OnDeath_Sadist_Condition takes nothing returns nothing
	call Sadist_Condition(ADSG_Killer,ADSG_Victim)
endfunction

function OnDeath_Sadist_ConditionWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_Sadist_Condition")
endfunction

function OnDeath_NecromasteryReact takes nothing returns nothing
	call NecromasteryReact(ADSG_Killer,ADSG_Victim)
endfunction

function OnDeath_NecromasteryReactWrapper takes nothing returns nothing
	call AddWrapperToDeath("OnDeath_NecromasteryReact")
endfunction

function DeathWrappers_Summon takes nothing returns nothing
	local integer k=0
	loop
		exitwhen HaveSavedString(UTable,'DEAD',k)==false
		call ExecuteFunc(LoadStr(UTable,'DEAD',k))
//		call echo(LoadStr(UTable,'DMGE'+i,k)+" "+I2S(i))
		set k=k+1
	endloop
endfunction

function LoDDeath_Generic takes unit killer, unit victim returns nothing
	if LoadBoolean(UnitStats,GetUnitTypeId(victim),0) or IsUnitIllusion(victim) then
		return
	endif
	set ADSG_Victim=victim
	set ADSG_Killer=killer
	if IsUnitType(victim,UNIT_TYPE_HERO) and LoadBoolean(HY,GetHandleId(victim),TEMPEST)==false then
//		call HeroDeath()
//		call FB_Check(killer,victim)
//		call RequiemWrapperOnDeath(victim)
//		call Rot_Suicide(killer,victim)
//		call StormModel_Death(victim)
//		call XinModel_Death(victim)
//		call BH_TrackKill(victim)
//		call Silencer_IntSteal(killer,victim)
//		call KaolinModel_Death(victim)
//		call StoneOwnerDeath(victim)
//		call Lone_HeroDeath_KillBear(victim)
//		call BloodStoneWrap(victim)
//		if GetUnitAbilityLevel(victim,'ACac')>0 and IsPlayerBelongToTeams(GetOwningPlayer(killer)) and IsUnitEnemy(killer,GetOwningPlayer(victim))  then//ACac -> Command Aura
//			if IsUnitType(killer,UNIT_TYPE_HERO) then
//				call VS_VengeanceAuraApply(GetUnitAbilityLevel(victim,'ACac'),killer,victim)//ACac -> Command Aura
//			else
//				if IsDead(udg_Hero[GetPlayerId(GetOwningPlayer(killer))])==false then
//					call VS_VengeanceAuraApply(GetUnitAbilityLevel(victim,'ACac'),udg_Hero[GetPlayerId(GetOwningPlayer(killer))],victim)//ACac -> Command Aura
//				endif
//			endif
//		endif
	else
		call CreepDeath(killer,victim)
//		call RemoteMineDeath(victim)
//		call UndyingZombie(victim)
//		call Templar_Trap_Start_Wrap(victim)
		call CourierDeath(victim)
//		call SpiritBear_Death(killer,victim)
		call NecronomiconKilled(killer,victim)
		call CustomUnitBountySystemInit(killer,victim)
	endif
	call DeathWrappers_Summon()
//	call BroodSpideriteCheck()
//	call WrathOfNatureKills()
//	call Alchemist_Greed_Condition(killer,victim)
//	call BS_BloodBath(killer,victim)
//	call Sadist_Condition(killer,victim)
//	call NecromasteryReact(killer,victim)
	
endfunction

//function LoDSummon_Generic takes unit u, unit t returns nothing

//endfunction


function LoDDamage_Generic takes unit u, unit t, real d returns nothing
	if d>0 then
		call Abbadon_Time_Condition(t,d)
	endif
endfunction

function EnchantedTotemEffectFromDummy takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local unit caster=LoadUnitHandle(HY,GetHandleId(t),0)
	local unit u=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)//e00E -> Spellcaster
	local integer id='QFZX'
	call UnitRemoveAbility(caster,'Broa')//Broa -> Enchant Totem
	if Mode_BO==false and ((GetUnitAbilityLevel(caster,'A0CG')>0 and IsUnitType(caster,UNIT_TYPE_MELEE_ATTACKER)) or GetUnitAbilityLevel(caster,'A1IQ')>0 or GetUnitAbilityLevel(caster,'A13T')>0 or GetUnitAbilityLevel(caster,'A1YQ')>0 or GetUnitAbilityLevel(caster,'A3DE')>0 or GetUnitAbilityLevel(caster,'A2H0')>0 or GetUnitAbilityLevel(caster,'QB0L')>0 or GetUnitAbilityLevel(caster,'A0KX')>0) then//A0CG -> Geminate Attack, A1IQ -> Jinada, A13T -> Tidebringer, A1YQ -> Walrus Punch, A3DE -> Walrus Punch, A2H0 -> Sleight of Fist, QB0L -> Sleight of Fist, A0KX -> Morph
		set id='QFZY'
	endif
	call UnitAddAbility(u,id)
	call SetUnitAbilityLevel(u,id,GetUnitAbilityLevel(caster,'A0DL'))//A0DL -> Enchant Totem
	call IssueImmediateOrder(u,"roar")
	call FlushChildHashtable(HY,GetHandleId(t))
	call DestroyTrigger(t)
	set t=null
	set u=null
	set caster=null
	return false
endfunction

function EnchantedTotemCasting takes nothing returns nothing
	local unit caster
	local trigger t
	set caster=GetTriggerUnit()
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,0.01,false)
	call TriggerAddCondition(t,Condition(function EnchantedTotemEffectFromDummy))
	call SaveUnitHandle(HY,GetHandleId(t),0,caster)
	set t=null
	set caster=null
endfunction

function OrbWalkingCheck takes unit u returns nothing
	if GetUnitAbilityLevel(u,'Aetl')>0 or GetUnitAbilityLevel(u,'B017')>0 then//Aetl -> Ethereal, B017 -> Frostbite
		call InterruptUnit(u)
	endif
endfunction

//Specific functions are executed here
//===========================================================================================
function LoD_Event_Condition takes nothing returns boolean
	local unit u = null
	local integer i = GetSpellAbilityId()
	local integer l
	local eventid id = GetTriggerEventId()
	if i!=0 then
		if id == EVENT_UNIT_SPELL_EFFECT then
			if IsBackMorph()==false then
				if DetailedSpellInfoDisplaying then
					call BJDebugMsg(GetUnitName(u)+" has used "+GetObjectName(i)+" ["+Id2String(i)+"]")
				endif
				call LoDSpell_Generic(GetTriggerUnit(),i)
				if HaveSavedString(MHT,i,0) then
					call ExecuteFunc(LoadStr(MHT,i,0))
				endif
			endif
		elseif id==EVENT_UNIT_SPELL_ENDCAST then
			if HaveSavedString(MHT,i,1) then
				call ExecuteFunc(LoadStr(MHT,i,1))
			endif
		elseif id==EVENT_UNIT_SPELL_FINISH then
			if HaveSavedString(MHT,i,2) then
				call ExecuteFunc(LoadStr(MHT,i,2))
			endif
		elseif id==EVENT_UNIT_SPELL_CAST then
			if IsPoisonArrowSkill(i) then
				call OrbWalkingCheck(GetTriggerUnit())
				call Viper_NetherToxin(GetTriggerUnit(),GetSpellTargetUnit())
				call KrakenShellAttack(GetTriggerUnit(),GetSpellTargetUnit())
			endif
			if HaveSavedString(MHT,i,3) then
				call ExecuteFunc(LoadStr(MHT,i,3))
			endif
		elseif id==EVENT_UNIT_SPELL_CHANNEL then
			if HaveSavedString(MHT,i,7) then
				call ExecuteFunc(LoadStr(MHT,i,7))
			endif
		endif
	endif
	if id == EVENT_UNIT_HERO_SKILL then
		set u = GetTriggerUnit()
		set i = GetLearnedSkill()
		set l = GetLearnedSkillLevel()
		call Passive_Cooldown_Learn(u,i,l)
		if HaveSavedString(MHT,i,5) then
			call ExecuteFunc(LoadStr(MHT,i,5))
		endif
		if l==1then
			if HaveSavedString(MHT,i,4) then
				call ExecuteFunc(LoadStr(MHT,i,4))
			endif
		endif
		set u = null
	elseif id == EVENT_PLAYER_UNIT_ATTACKED then
		call LoDAttack_Generic(GetAttacker(),GetTriggerUnit())
	elseif id == EVENT_UNIT_ISSUED_ORDER or id == EVENT_UNIT_ISSUED_POINT_ORDER or id == EVENT_UNIT_ISSUED_TARGET_ORDER then
		call LoDOrder_Generic(GetTriggerUnit(),GetIssuedOrderId(),id)//Save (udgtable,handle,2,true) when a units orders are added as an event
	elseif id == EVENT_PLAYER_UNIT_DEATH then
		call LoDDeath_Generic(GetKillingUnit(),GetTriggerUnit())
	elseif id == EVENT_UNIT_SUMMON then
		set u = GetSummoningUnit()
		
		//call LoDSummon_Generic(u,GetTriggerUnit())
		if HaveSavedString(MHT,LoadInteger(MHT,GetHandleId(u),'SPEL'),9) then
			call ExecuteFunc(LoadStr(MHT,LoadInteger(MHT,GetHandleId(u),'SPEL'),9))
		endif
		set u = null
	elseif id == EVENT_UNIT_DAMAGED then
		call LoDDamage_Generic(GetEventDamageSource(),GetTriggerUnit(),GetEventDamage())
	endif
	set u=null
	return false
endfunction

function LoD_Chat_Event takes nothing returns boolean
	// only used for EVENT_PLAYER_CHAT, all other events should be register
	// with GAME_TRIGGER
	if HaveSavedString(MHT,StringHash(GetEventPlayerChatString()),10) then
		call ExecuteFunc(LoadStr(MHT,StringHash(GetEventPlayerChatString()),10))
	endif
	return false
endfunction

function LoDEvent_Add takes nothing returns nothing
	local unit u = GetTriggerUnit()
	if LoadBoolean(MHT,GetHandleId(u),2) then
		set u=null
		return
	endif
	//call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_HERO_SKILL)

	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_CAST)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_EFFECT)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_FINISH)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_CHANNEL)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_ENDCAST)

	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_ISSUED_ORDER)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_ISSUED_POINT_ORDER)
	call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
	call SaveBoolean(MHT,GetHandleId(u),2,true)//used to check if a unit has registered order events

	set u = null
endfunction

function LichFunctionToDisplayTimeLeft takes integer seconds,integer r,integer g,integer b,integer a,real x,real y,integer h returns nothing
	local string s=I2S(seconds)
	local integer i1
	local integer i2
	local integer i3
	if seconds>99 then
		set TIMERIMG[1]=true
		set TIMERIMG[2]=true
		set TIMERIMG[3]=true
		call WriteImageOnGround("Fonts\\"+SubString(s,0,1)+".blp",61,61,x-50,y,0,true)
		call SaveImageHandle(HY,h,1520,tt_image1)
		call SetImageColor(tt_image1,r,g,b,a)
		call WriteImageOnGround("Fonts\\"+SubString(s,1,2)+".blp",61,61,x-20,y,0,true)
		call SaveImageHandle(HY,h,1521,tt_image1)
		call SetImageColor(tt_image1,r,g,b,a)
		call WriteImageOnGround("Fonts\\"+SubString(s,2,3)+".blp",61,61,x+20,y,0,true)
		call SaveImageHandle(HY,h,1522,tt_image1)
		call SetImageColor(tt_image1,r,g,b,a)
	elseif seconds >9 then
		set TIMERIMG[2]=true
		set TIMERIMG[3]=true
		call WriteImageOnGround("Fonts\\"+SubString(s,0,1)+".blp",61,61,x-33,y,0,true)
		call SaveImageHandle(HY,h,1521,tt_image1)
		call SetImageColor(tt_image1,r,g,b,a)
		call WriteImageOnGround("Fonts\\"+SubString(s,1,2)+".blp",61,61,x-3,y,0,true)
		call SaveImageHandle(HY,h,1522,tt_image1)
		call SetImageColor(tt_image1,r,g,b,a)
	else
		set TIMERIMG[2]=true
		set TIMERIMG[3]=true
		call PlaySoundBJ(Sound_Tick)
		call WriteImageOnGround("Fonts\\0.blp",61,61,x-33,y,0,true)
		call SaveImageHandle(HY,h,1521,tt_image1)
		call SetImageColor(tt_image1,r,g,b,a)
		call WriteImageOnGround("Fonts\\"+s+".blp",61,61,x-3,y,0,true)
		call SaveImageHandle(HY,h,1522,tt_image1)
		call SetImageColor(tt_image1,r,g,b,a)
	endif
endfunction

function APShowTimer takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local integer i=R2I(TimerGetRemaining(NK))
	local image im
	local integer k=1
	loop
		set LastTimeActivity[k]=TimerGetElapsed(GlobalTimer)
		set k=k+1
		exitwhen k>11
	endloop
	if TIMERIMG[1] then
		set im=LoadImageHandle(HY,h,1520)
		call DestroyImage(im)
		set TIMERIMG[1]=false
	endif
	if TIMERIMG[2] then
		set im=LoadImageHandle(HY,h,1521)
		call DestroyImage(im)
		set TIMERIMG[2]=false
	endif
	if TIMERIMG[3] then
		set im=LoadImageHandle(HY,h,1522)
		call DestroyImage(im)
		set TIMERIMG[3]=false
	endif
	if i==0 or b_AllPlayersReady then
		call FlushChildHashtable(HY,h)
		call DestroyTrigger(t)
	else
		if (Mode_SD or Mode_MD) and (Mode_D3 or Mode_D4 or Mode_D5) then
			call LichFunctionToDisplayTimeLeft(i,255,2,2,255,-6454,6945,h)
		else
			call LichFunctionToDisplayTimeLeft(i,255,2,2,255,-6970,6726,h)
		endif
	endif
	set t=null
endfunction

function ShowTimersInit takes nothing returns nothing
	local real x
	local real y
	set APShowTimersTrig=CreateTrigger()// timer on taverns
	set Sound_Tick=CreateSound( "Sound\\Interface\\BattleNetTick.wav", false, false, false, 10, 10, "" )
	call SetSoundParamsFromLabel( Sound_Tick, "ChatroomTimerTick" )
	call SetSoundDuration( Sound_Tick, 476 )
	call TriggerRegisterTimerEvent(APShowTimersTrig,1,true)
	call TriggerAddCondition(APShowTimersTrig,Condition(function APShowTimer))
	call TriggerEvaluate(APShowTimersTrig)
	if Mode_SD or Mode_MD then
		set AddTime1=CreateUnit(Player(15),'h302',-7200,7300,270)//h302 -> Altar of Time
		set AddTime2=CreateUnit(Player(15),'h302',-7400,7300,270)//h302 -> Altar of Time
		set AddTime3=CreateUnit(Player(15),'h303',-6600,7300,270)//h303 -> Defiled altar of Time
		set AddTime4=CreateUnit(Player(15),'h303',-6800,7300,270)//h303 -> Defiled altar of Time
		set AltarOfRandom=CreateUnit(Player(15),'h306',-6995,7300,270)//h306 -> Altar of Randomness
	else
		set AddTime1=CreateUnit(Player(15),'h302',-7070,6936,270)//h302 -> Altar of Time
		set AddTime2=CreateUnit(Player(15),'h302',-7070,6616,270)//h302 -> Altar of Time
		set AddTime3=CreateUnit(Player(15),'h303',-6920,6616,270)//h303 -> Defiled altar of Time
		set AddTime4=CreateUnit(Player(15),'h303',-6920,6936,270)//h303 -> Defiled altar of Time
		set AltarOfRandom=CreateUnit(Player(15),'h306',-6995,7200,270)//h306 -> Altar of Randomness
	endif
//	if (Mode_MD or Mode_SD) and i_BonusDraftAmount==0 then
//		call SetUnitPosition(AltarOfRandom,-5751, 7050)
//		call SetUnitPosition(AddTime1,-5700, 6850)
//		call SetUnitPosition(AddTime2,-5800, 6850)
//		call SetUnitPosition(AddTime3,-5700, 6450)
//		call SetUnitPosition(AddTime4,-5800, 6450)
//	endif
endfunction

function MeleeRangeItemsFix takes nothing returns boolean
	local integer i=1
	local integer k=0
	local item it=null
	local boolean f=false
	local integer h=GetHandleId(GetTriggeringTrigger())
	local real time=TimerGetElapsed(GlobalTimer)
	loop
		if IsDead(udg_Hero[i])==false and TimerGetRemaining(HeroRespawnTimer[i])<=0 and time-LoadReal(HY,h,GetHandleId(udg_Hero[i])) > 2 then
			call SaveReal(HY,h,GetHandleId(udg_Hero[i]),time)
			set k=0
			loop
				exitwhen k>5
				set it=UnitItemInSlot(udg_Hero[i],k)
				if it!=null then
					if GetIndex(it)==-1 then
						call UnitRemoveItem(udg_Hero[i],it)
					else
						call RestrictedItems_UpdateMeleeRange(udg_Hero[i],it)
					endif
				endif
				set k=k+1
			endloop
		endif
		set i=i+1
		if i==6 then
			set i=7
		endif
		exitwhen i>12
	endloop
	set it=null
	return false
endfunction

function Kaolin_addsubskill takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	local integer PlayerId=GetPlayerId(GetOwningPlayer(u))
	local integer xx=1
	local boolean b=false
	loop
		if PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]>=441 and PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]<=444 then
			set b=true
		endif
		set xx=xx+1
		exitwhen b or xx>4+NumberOfExtraAbilities
	endloop
	if not LoadBoolean(HY,GetHandleId(u),StringHash("rolling stones")) and b then
		call UnitAddAbility2(u,'A2TH')//A2TH -> Stone Caller
		call Kaolin_RollingBoulder_Init(u)
		call SaveBoolean(HY,GetHandleId(u),StringHash("rolling stones"),true)
	endif
	set u=null
	call FlushChildHashtable(HY,h)
	call DestroyTimer(t)
	set t=null
endfunction

function Kaolin_Prereg takes nothing returns nothing
	local timer t
	local integer h
	if b_isPickTime==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
		set t=CreateTimer()
		set h=GetHandleId(t)
		call TimerStart(t,0,false,function Kaolin_addsubskill)
		call SaveUnitHandle(HY,h,0,GetTriggerUnit())
	endif
	set t=null
endfunction

function Weaver_TimeLapse_LearnFixed takes unit u returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEventPeriodic(t,.5)
	call TriggerAddAction(t,function RDG)
	call SaveUnitHandle(HY,GetHandleId(t),221,u)
	call SaveInteger(HY,GetHandleId(t),0,GetHandleId(u))
	set t=null
endfunction

function TimeLapse_Init takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	call Weaver_TimeLapse_LearnFixed(u)
	set u=null
	call FlushChildHashtable(HY,h)
	call CleanTrigger(t)
	set t=null
endfunction

function TimeLapse_PreInit takes nothing returns nothing
	local trigger t
	local integer h
	local unit u
	local unit d
	if b_isPickTime==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
		set t=CreateTrigger()
		set h=GetHandleId(t)
		set u=GetTriggerUnit()
		call TriggerRegisterTimerEvent(t,0,false)
		call TriggerAddCondition(t,Condition(function TimeLapse_Init))
		call SaveUnitHandle(HY,h,0,u)
		set t=CreateTrigger()
		set h=GetHandleId(t)
		call TriggerRegisterTimerEvent(t,.5,true)
		call TriggerAddCondition(t,Condition(function FQG))
		call SaveUnitHandle(HY,h,304,u)
		set d=CreateUnit(GetOwningPlayer(u),'o01A',GetUnitX(u),GetUnitY(u),0)//o01A -> Vision Dummy 1200/1800
		call SaveUnitHandle(HY,h,305,d)
		call SaveUnitHandle(HeroStats,GetHandleId(u),'DUMM',d)
		set d=null
		set u=null
		set t=null
	endif
endfunction

function Bughunter_Dummies takes nothing returns nothing
	local unit hero
	local unit dummy
	local integer i=1
	local integer lvl=0
	local boolean b=Mode_S5 or Mode_S6
	if b_isPickTime then
		return
	endif
	loop
		set hero=udg_Hero[i]
		set dummy=BugHunterProviders[i]
		set lvl=GetUnitAbilityLevel(hero,'A086')//A086 -> Hunter in the Night, QP0T -> Hunter in the Night
		if lvl==0 and b then
			if SkillID[PlayerSkillNumber[i*PlayerSkillOffset+5]]=='P247' then//P247 -> Hunter in the Night
				set lvl=ExtraAbilityLevel[i*2+1]
			endif
		endif
		if lvl>0 then
			if IsDayTime() or GetUnitAbilityLevel(hero,'A36D')==1 then
				if GetUnitAbilityLevel(dummy,'A330')!=0 then
					call UnitRemoveAbility(dummy,'A330')
				endif
				if IsHeroDead[GetPlayerId(GetOwningPlayer(hero))]==false then
					if GetUnitAbilityLevel(hero,'P247')>0 and GetUnitAbilityLevel(hero,'P247')!=5  then//P247 -> Hunter in the Night, P247 -> Hunter in the Night
						call SetUnitAbilityLevel(hero,'P247',5)//P247 -> Hunter in the Night
					endif
					if GetUnitAbilityLevel(hero,'A116')>0 then//A116 -> Night Stalker FX 1
						call UnitRemoveAbility(hero,'A116')//A116 -> Night Stalker FX 1
						call UnitRemoveAbility(hero,'A117')//A117 -> Night Stalker FX 2
					endif
				endif
			else
				if GetUnitAbilityLevel(dummy,'A330')!=lvl then
					call UnitAddAbility2(dummy,'A330')
					call SetUnitAbilityLevel(dummy,'A330',lvl)
				endif
				if IsHeroDead[GetPlayerId(GetOwningPlayer(hero))]==false then
					if GetUnitAbilityLevel(hero,'P247')!=lvl then//P247 -> Hunter in the Night
						call SetUnitAbilityLevel(hero,'P247',lvl)//P247 -> Hunter in the Night
					endif
					if GetUnitAbilityLevel(hero,'A116')==0 then//A116 -> Night Stalker FX 1
						call UnitAddAbility2(hero,'A116')//A116 -> Night Stalker FX 1
						call UnitAddAbility2(hero,'A117')//A117 -> Night Stalker FX 2
					endif
				endif
			endif
		elseif GetUnitAbilityLevel(dummy,'A330')>0 then
			call UnitRemoveAbility(dummy,'A330')
		endif
		if IsDead(hero)==false and IsHeroDead[GetPlayerId(GetOwningPlayer(hero))]==false and (GetUnitAbilityLevel(hero,'A08E')>0 or SkillID[PlayerSkillNumber[GetPlayerId(GetOwningPlayer(hero))*PlayerSkillOffset+5]]=='A08C') then//A08E -> Crippling Fear (Learn), A08C -> Crippling Fear
			if IsDayTime()==false then
				if GetUnitAbilityLevel(hero,'A08E')>0 then//A08E -> Crippling Fear (Learn)
					call SetUnitAbilityLevel(hero,'A08C',GetUnitAbilityLevel(hero,'A08E'))//A08C -> Crippling Fear, A08E -> Crippling Fear (Learn)
				else
					call SetUnitAbilityLevel(hero,'A08C',ExtraAbilityLevel[GetPlayerId(GetOwningPlayer(hero))*2+1])//A08C -> Crippling Fear
				endif
			else
				call SetUnitAbilityLevel(hero,'A08C',5)//A08C -> Crippling Fear
			endif
		endif
		set i=i+1
		if i==6 then
			set i=7
		endif
		exitwhen i>11
	endloop
	set hero=null
	set dummy=null
endfunction

function NIghtstalker_Passive_Global takes nothing returns nothing
	local timer t=CreateTimer()
	local integer i=1
	loop
		set BugHunterProviders[i]=CreateUnit(Player(i),'e00C',0,0,0)//e00C -> Self Caster
		call UnitAddAbility2(BugHunterProviders[i],'Aloc')//Aloc -> Locust
		set i=i+1
		if i==6 then
			set i=7
		endif
		exitwhen i>11
	endloop
	call TimerStart(t,1,true,function Bughunter_Dummies)
	set t=null
endfunction

function Func0733 takes nothing returns nothing
	local unit t=GetEnumUnit()
	if(LoadInteger(HY,GetHandleId(t),4341)!=1)then
		call AddTimedKeyToUnit(t,4341,0.99)
		call DamageTarget(GetDamageSourceForStickyNapalm(RadianceSourceUnit),t,1,50)
	endif
	call UnitAddAbilityTimedExF(t,'A3Q1',1,1.,'B3DJ')
	set t=null
endfunction

function Func0734 takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,(h),14))
	local group g
	if GetTriggerEventId()==EVENT_UNIT_DROP_ITEM then
		if GetManipulatedItem()==(LoadItemHandle(HY,(h),96)) then
			call FlushChildHashtable(HY,(h))
			call CleanTrigger(t)
		endif
	else
		if u==null then
			call FlushChildHashtable(HY,(h))
			call CleanTrigger(t)
		endif
		if IsDead(u)==false then
			set g=GetAvailableGroup()
			set tt_unit1=u
			call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),725,Condition(function NonImmuneEnemyFilterWithAncients))
			set RadianceSourceUnit=u
			call EvasionSourceActivate(EVASION_DEBUFF_RADIANCE,2.)
			set bj_makeUnitRescuableUnit=CreateUnit(GetOwningPlayer(u),'e00E',0,0,0)//e00E -> Spellcaster
			call UnitAddAbility(bj_makeUnitRescuableUnit,'A3DJ')
			call ForGroup(g,function Func0733)
			call UnitRemoveAbility(bj_makeUnitRescuableUnit,'A3DJ')
			call KillGroup(g)
			set g=null
		endif
	endif
	set t=null
	set u=null
	return false
endfunction

function RadiancePickUp takes unit u returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DROP_ITEM)
	call TriggerAddCondition(t,Condition(function Func0734))
	call SaveUnitHandle(HY,(h),14,(u))
	call SaveItemHandle(HY,(h),96,(GetManipulatedItem()))
	set t=null
endfunction

function GuardianGreavesFilter takes nothing returns boolean
	return IsUnitAlly(tt_unit1,GetOwningPlayer(GetFilterUnit())) and AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function GuardianGreavesRemove takes nothing returns nothing
	call UnitRemoveAbility(GetEnumUnit(),'A393')
	call UnitRemoveAbility(GetEnumUnit(),'A394')
	call UnitRemoveAbility(GetEnumUnit(),'A3E2')
endfunction

function GuardianGreavesAdd takes nothing returns nothing
	if GetUnitAbilityLevel(GetEnumUnit(),'A393')==0 then
		call UnitAddAbility2(GetEnumUnit(),'A393')
		call UnitAddAbility2(GetEnumUnit(),'A394')
	endif
	if IsHeroUnitId(GetUnitTypeId(GetEnumUnit())) then
		if GetWidgetLife(GetEnumUnit()) / GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE) <= 0.2 then
			call SetUnitAbilityLevel(GetEnumUnit(),'A393',2)
			call UnitAddAbility2(GetEnumUnit(),'A3E2')
		elseif GetUnitAbilityLevel(GetEnumUnit(),'A393')==2 then
			call SetUnitAbilityLevel(GetEnumUnit(),'A393',1)
			call UnitRemoveAbility(GetEnumUnit(),'A3E2')
		endif
	endif
endfunction

function GuardianGreavesPeriodic takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,(h),2))
	local group g=(LoadGroupHandle(HY,(h),340))
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local group gg
	if u==null or (GetTriggerEventId()==EVENT_UNIT_DROP_ITEM and GetManipulatedItem()==LoadItemHandle(HY,(h),96)) then
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
		call ForGroup(g,function GuardianGreavesRemove)
		call KillGroup(g)
		set t=null
		return false
	endif
	set gg=GetAvailableGroup()
	set tt_unit1=u
	if IsDead(u)==false then
		set tt_unit1=u
		call GroupEnumUnitsInRange(gg,x,y,925,Condition(function GuardianGreavesFilter))
	endif
	call GroupRemoveGroup(gg,g)
	call ForGroup(g,function GuardianGreavesRemove)
	if IsDead(u)==false then
		call ForGroup(gg,function GuardianGreavesAdd)
	endif
	call SaveGroupHandle(HY,(h),340,(gg))
	call KillGroup(g)
	set t=null
	set u=null
	set g=null
	set gg=null
	return false
endfunction

function GuardianGreavesPickup takes unit u returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.3,true)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DROP_ITEM)
	call TriggerAddCondition(t,Condition(function GuardianGreavesPeriodic))
	call SaveItemHandle(HY,(h),96,(GetManipulatedItem()))
	call SaveUnitHandle(HY,(h),2,(u))
	call SaveGroupHandle(HY,(h),340,(GetAvailableGroup()))
	set t=null
endfunction



function PipeOfInssghtFilter takes nothing returns boolean
	return IsUnitAlly(tt_unit1,GetOwningPlayer(GetFilterUnit())) and AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function PipeOfInsightRemove takes nothing returns nothing
	call RemoveAbilityForSure(GetEnumUnit(),'A3AX')
endfunction

function PipeOfInsightAdd takes nothing returns nothing
	if GetUnitAbilityLevel(GetEnumUnit(),'A3AX')==0 then
		call UnitAddAbility2(GetEnumUnit(),'A3AX')
	endif
endfunction

function PipeOfInsightPeriodic takes nothing returns boolean
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u=(LoadUnitHandle(HY,(h),2))
	local group g=(LoadGroupHandle(HY,(h),340))
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	local group gg
	if u==null or (GetTriggerEventId()==EVENT_UNIT_DROP_ITEM and GetManipulatedItem()==LoadItemHandle(HY,(h),96)) then
		call FlushChildHashtable(HY,(h))
		call CleanTrigger(t)
		call ForGroup(g,function PipeOfInsightRemove)
		call KillGroup(g)
		set t=null
		return false
	endif
	set gg=GetAvailableGroup()
	set tt_unit1=u
	if IsDead(u)==false then
		set tt_unit1=u
		call GroupEnumUnitsInRange(gg,x,y,925,Condition(function PipeOfInssghtFilter))
	endif
	call GroupRemoveGroup(gg,g)
	call ForGroup(g,function PipeOfInsightRemove)
	if IsDead(u)==false then
		//call GroupRemoveUnit(gg,u)
		call ForGroup(gg,function PipeOfInsightAdd)
	endif
	call SaveGroupHandle(HY,(h),340,(gg))
	call KillGroup(g)
	set t=null
	set u=null
	set g=null
	set gg=null
	return false
endfunction

function PipeOfInsightPickup takes unit u returns nothing
	local trigger t=CreateTrigger()
	local integer h=GetHandleId(t)
	call TriggerRegisterTimerEvent(t,0.3,true)
	call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DROP_ITEM)
	call TriggerAddCondition(t,Condition(function PipeOfInsightPeriodic))
	call SaveItemHandle(HY,(h),96,(GetManipulatedItem()))
	call SaveUnitHandle(HY,(h),2,(u))
	call SaveGroupHandle(HY,(h),340,(GetAvailableGroup()))
	set t=null
endfunction

function Func0736 takes nothing returns boolean
	if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
		if GetItemType(GetManipulatedItem())==ITEM_TYPE_PERMANENT then
			if GetIndexNoMute(GetManipulatedItem())==RadianceOn then
				call RadiancePickUp(GetTriggerUnit())
			elseif GetIndexNoMute(GetManipulatedItem())==GuardianGreaves then
				call GuardianGreavesPickup(GetTriggerUnit())
			elseif GetIndexNoMute(GetManipulatedItem())==Pipe then
				call HideAbility('A3AX')
				call PipeOfInsightPickup(GetTriggerUnit())
			endif
		endif
	elseif UnitInventorySize(GetSummonedUnit())>0 and FindItemOfType(GetSummonedUnit(),Item_Real[RadianceOn])!=null then
		call RadiancePickUp(GetSummonedUnit())
	endif
	return false
endfunction

function DoubleClickDisassemble takes unit u, item it, integer slot returns nothing
	local integer emptyslots=1
	local integer reqslots=0
	local integer i=0
	local item newitem
	local integer index=GetIndex(it)
	local player p
	if index!=Perseverance and index!=PowerTreadsAgility and index!=PowerTreadsStrength and index!=PowerTreadsIntelligence and index!=MoonShard and index!=RingOfBasilius and index!=RingOfBasiliusHero and index!=ShivasGuard and index!=ShivasGuardCourier and index!=Mjollnir and index!=ArcaneBoots and index!=HeavensHalberd and index!=HelmOfTheDominator and index!=HelmOfTheDominatorCourier and index!=MantaStyle and index!=MantaStyleRanged and index!=EtherealBlade and index!=SangeAndYasha and index!=RingOfAquila and index!=RingOfAquilaHero and index!=AbyssalBlade and index!=LotusOrb and index!=GlimmerCape and index!=SolarCrest then
		return
	endif
	loop
		if UnitItemInSlot(u,i)==null then
			set emptyslots=emptyslots+1
		endif
		set i=i+1
		exitwhen i>5
	endloop
	if index==Perseverance or index==MoonShard or index==HeavensHalberd or index==RingOfBasilius  or index==RingOfBasiliusHero  or index==ArcaneBoots  or index==HelmOfTheDominator  or index==HelmOfTheDominatorCourier or index==EtherealBlade  or index==SangeAndYasha  or index==RingOfAquila  or index==RingOfAquilaHero or index==AbyssalBlade or index==GlimmerCape or index==SolarCrest then
		set reqslots=2
	elseif index==ShivasGuard or index==PowerTreadsAgility or index==PowerTreadsStrength or index==PowerTreadsIntelligence or index==ShivasGuardCourier or index==Mjollnir or index==MantaStyle or index==MantaStyleRanged or index==LotusOrb then
		set reqslots=3
	endif
	if emptyslots>=reqslots then
		call DisableTrigger(t_manipulateitem)
		set p=GetItemPlayer(it)
		call RemoveItem(it)
		if index==Perseverance then
			call UnitAddItemByIdLoD(u,Item_Real[RingOfHealth],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[VoidStone],p,false,1)
		elseif index==RingOfBasilius or index==RingOfBasiliusHero then
			call UnitAddItemByIdLoD(u,Item_Real[RingOfProtection],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[SobiMask],p,false,1)
		elseif index==ShivasGuard or index==ShivasGuardCourier then
			call UnitAddItemByIdLoD(u,Item_Real[PlateMail],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[MysticStaff],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[RecipeShivasGuard],p,false,1)
		elseif index==Mjollnir then
			call UnitAddItemByIdLoD(u,Item_Real[Hyperstone],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[Maelstrom],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[RecipeMjollnir],p,false,1)
		elseif index==ArcaneBoots then
			call UnitAddItemByIdLoD(u,Item_Real[BootsOfSpeed],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[EnergyBooster],p,false,1)
		elseif index==HelmOfTheDominator or index==HelmOfTheDominatorCourier then
			call UnitAddItemByIdLoD(u,Item_Real[HelmOfIronWill],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[MaskOfDeath],p,false,1)
		elseif index==MantaStyle or index==MantaStyleRanged then
			call UnitAddItemByIdLoD(u,Item_Real[Yasha],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[UltimateOrb],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[RecipeMantaStyle],p,false,1)
		elseif index==EtherealBlade then
			call UnitAddItemByIdLoD(u,Item_Real[Eaglehorn],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[GhostScepter],p,false,1)
		elseif index==SangeAndYasha then
			call UnitAddItemByIdLoD(u,Item_Real[Sange],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[Yasha],p,false,1)
		elseif index==RingOfAquila or index==RingOfAquilaHero then
			call UnitAddItemByIdLoD(u,Item_Real[WraithBand],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[RingOfBasilius],p,false,1)
		elseif index==AbyssalBlade then
			call UnitAddItemByIdLoD(u,Item_Real[CraniumBasher],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[SacredRelic],p,false,1)
		elseif index==LotusOrb then
			call UnitAddItemByIdLoD(u,Item_Real[Perseverance],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[PlateMail],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[RecipeLotusOrb],p,false,1)
		elseif index==GlimmerCape then
			call UnitAddItemByIdLoD(u,Item_Real[PlaneswalkerCloak],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[ShadowAmulet],p,false,1)
		elseif index==SolarCrest then
			call UnitAddItemByIdLoD(u,Item_Real[TalismanOfEvasion],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[MedallionOfCourage],p,false,1)
		elseif index==HeavensHalberd then
			call UnitAddItemByIdLoD(u,Item_Real[TalismanOfEvasion],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[Sange],p,false,1)
		elseif index==MoonShard then
			call UnitAddItemByIdLoD(u,Item_Real[Hyperstone],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[Hyperstone],p,false,1)
		elseif index==PowerTreadsAgility or index==PowerTreadsIntelligence or index==PowerTreadsStrength then
			call UnitAddItemByIdLoD(u,Item_Real[BootsOfSpeed],p,false,1)
			call UnitAddItemByIdLoD(u,Item_Real[GlovesOfHaste],p,false,1)
			if index==PowerTreadsAgility then
				call UnitAddItemByIdLoD(u,Item_Real[BootsOfElvenskin],p,false,1)
			elseif index==PowerTreadsStrength then
				call UnitAddItemByIdLoD(u,Item_Real[BeltOfStrength],p,false,1)
			else
				call UnitAddItemByIdLoD(u,Item_Real[RobeOfMagi],p,false,1)
			endif
		endif
		call EnableTrigger(t_manipulateitem)
	else
		call Error(GetOwningPlayer(u),"Not enough space in the inventory. Disassembling requires "+I2S(reqslots)+" slots at least.")
	endif
	set newitem=null
endfunction

function DoubleRightClick takes nothing returns nothing
	local integer id=GetIssuedOrderId()
	if id>=852002 and id<=852007 then
		if GetOrderTargetItem()==UnitItemInSlot(GetTriggerUnit(),id-852002) then
			call DoubleClickDisassemble(GetTriggerUnit(),GetOrderTargetItem(),id-852002)
		endif
	endif
endfunction

function DoubleRightClickInit takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
	call TriggerAddCondition(t,Condition(function DoubleRightClick))
	set t=null
endfunction

function PushOutToMap takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	if GetUnitTypeId(u)!='hfoo' and GetUnitAbilityLevel(u,'Aloc')==0 then//hfoo ->  , Aloc -> Locust
		if SafeX50(x)!=x then
			call SetUnitX(u,SafeX50(x))
		endif
		if SafeY50(y)!=y then
			call SetUnitY(u,SafeY50(y))
		endif
	endif
	set u=null
endfunction

function PushOutToMap2 takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local real x=GetUnitX(u)
	local real y=GetUnitY(u)
	if GetUnitAbilityLevel(u,'Aloc')==0 and GetOwningPlayer(u)!=Player(15) then//Aloc -> Locust
		call SetUnitPosition(u,x,y)
	endif
	set u=null
endfunction

function PushOut2 takes nothing returns nothing
	local trigger t=CreateTrigger()
	set ExtraBoundaries=CreateRegion()
	set ExtraBoundariesAdv=CreateRegion()
	call RegionAddRect(ExtraBoundaries,Rect(-6424,-7473,-7500,-7885))
	call RegionAddRect(ExtraBoundariesAdv,Rect(5744,6860,7502,7240))
	call RegionAddRect(ExtraBoundariesAdv,Rect(7300,5400,7502,6800))
	call TriggerRegisterEnterRegion(t,ExtraBoundaries,Condition(function ReturnTrue))
	call TriggerRegisterEnterRegion(t,ExtraBoundariesAdv,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function PushOutToMap2))
	set t=null
endfunction

function RoshanPitOccluderHeightFix takes nothing returns nothing
	call SetDestructableOccluderHeight(GetEnumDestructable(),9999)
	//call echo(Id2String(GetDestructableTypeId(GetEnumDestructable())))//YTlb
endfunction

function RoshanPitBlockersFilter takes nothing returns boolean
	return IsValidTree(GetFilterDestructable())==false
endfunction

function RecreateHeroIfMissed takes integer i, integer h returns nothing
	local player p=Player(i)
	local integer k=i*100
	local unit u=CreateUnit(p,LoadInteger(HY,h,k+80),LoadReal(HY,h,k),LoadReal(HY,h,k+1),90)
	local item it=null
	
	set it=CreateItem(LoadInteger(HY,h,k+1),0,0)
	call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+1),true)
	call UnitAddItem(u,it)
	if LoadInteger(HY,h,k+11)>0 then
		call SetItemCharges(it,LoadInteger(HY,h,k+11))
	endif
	set it=CreateItem(LoadInteger(HY,h,k+2),0,0)
	call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+2),true)
	call UnitAddItem(u,it)
	if LoadInteger(HY,h,k+12)>0 then
		call SetItemCharges(it,LoadInteger(HY,h,k+12))
	endif
	set it=CreateItem(LoadInteger(HY,h,k+3),0,0)
	call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+3),true)
	call UnitAddItem(u,it)
	if LoadInteger(HY,h,k+13)>0 then
		call SetItemCharges(it,LoadInteger(HY,h,k+13))
	endif
	set it=CreateItem(LoadInteger(HY,h,k+4),0,0)
	call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+4),true)
	call UnitAddItem(u,it)
	if LoadInteger(HY,h,k+14)>0 then
		call SetItemCharges(it,LoadInteger(HY,h,k+14))
	endif
	set it=CreateItem(LoadInteger(HY,h,k+5),0,0)
	call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+5),true)
	call UnitAddItem(u,it)
	if LoadInteger(HY,h,k+15)>0 then
		call SetItemCharges(it,LoadInteger(HY,h,k+15))
	endif
	set it=CreateItem(LoadInteger(HY,h,k+6),0,0)
	call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+6),true)
	call UnitAddItem(u,it)
	if LoadInteger(HY,h,k+16)>0 then
		call SetItemCharges(it,LoadInteger(HY,h,k+16))
	endif
	set ExtraAbilityLevel[GetPlayerId(p)*2+1]=0
	set ExtraAbilityLevel[GetPlayerId(p)*2+2]=0
	call SmoothLvlup(u,LoadInteger(HY,h,k+30),false,0)
	call DisplayTimedTextToPlayer(p,0,0,20,"|c00ff0000  Your hero was recreated due to a fatal error. Please report this replay at |c00ffff00LegendsOfDota.com|r |c00ff0000if you notice any problems.|r")
	set u=null
	set it=null
endfunction

function SaveHeroesTick takes nothing returns nothing
	local trigger t=GetTriggeringTrigger()
	local integer h=GetHandleId(t)
	local unit u
	local item it
	local integer i=1
	local integer k
	local boolean missing=false
	loop
		if PlayerHaveHero[i] and IsPlayerLeaver(Player(i))==false then
			set missing=false
			set u=udg_Hero[i]
			if u==null or GetUnitTypeId(u)<1 or GetHandleId(u)<1 then
				set missing=true
			endif
			set k=i*100
			if missing==false then
				call SaveBoolean(HY,h,k,true)
				call SaveInteger(HY,h,k+80,GetUnitTypeId(u))
				set it=UnitItemInSlot(u,0)
				call SaveInteger(HY,h,k+1,GetItemTypeId(it))
				call SavePlayerHandle(HY,h,k+1,GetItemPlayer(it))
				call SaveInteger(HY,h,k+11,GetItemCharges(it))
				set it=UnitItemInSlot(u,1)
				call SaveInteger(HY,h,k+2,GetItemTypeId(it))
				call SavePlayerHandle(HY,h,k+2,GetItemPlayer(it))
				call SaveInteger(HY,h,k+12,GetItemCharges(it))
				set it=UnitItemInSlot(u,2)
				call SaveInteger(HY,h,k+3,GetItemTypeId(it))
				call SavePlayerHandle(HY,h,k+3,GetItemPlayer(it))
				call SaveInteger(HY,h,k+13,GetItemCharges(it))
				set it=UnitItemInSlot(u,3)
				call SaveInteger(HY,h,k+4,GetItemTypeId(it))
				call SavePlayerHandle(HY,h,k+4,GetItemPlayer(it))
				call SaveInteger(HY,h,k+14,GetItemCharges(it))
				set it=UnitItemInSlot(u,4)
				call SaveInteger(HY,h,k+5,GetItemTypeId(it))
				call SavePlayerHandle(HY,h,k+5,GetItemPlayer(it))
				call SaveInteger(HY,h,k+15,GetItemCharges(it))
				set it=UnitItemInSlot(u,5)
				call SaveInteger(HY,h,k+6,GetItemTypeId(it))
				call SavePlayerHandle(HY,h,k+6,GetItemPlayer(it))
				call SaveInteger(HY,h,k+16,GetItemCharges(it))
				call SaveReal(HY,h,k,GetUnitX(u))
				call SaveReal(HY,h,k+1,GetUnitY(u))
				call SaveInteger(HY,h,k+30,GetHeroLevel(u))
			endif
			if missing and LoadBoolean(HY,h,k) then
				call RecreateHeroIfMissed(i,h)
			endif
		endif
		
		set i=i+1
		if i==6 then
			set i=7
		endif
		exitwhen i>11
		
	endloop
	
	set u=null
	set it=null
	set t=null
endfunction

function DoubleHold_Blink takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local unit u=LoadUnitHandle(HY,h,0)
	if GetUnitX(u)!=LoadReal(HY,h,0) or GetUnitY(u)!=LoadReal(HY,h,1) or IsDead(u) then
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(HY,h)
		call UnitRemoveAbility(u,'A40E')
	else
		call UnitRemoveAbility(u,'A40E')
		call UnitAddAbility2(u,'A40E')
	endif
	set u=null
	set t=null
endfunction

function DoubleHold_AntiInvis takes unit u returns nothing
	local timer t=CreateTimer()
	call TimerStart(t,0.2,true,function DoubleHold_Blink)
	call SaveUnitHandle(HY,GetHandleId(t),0,u)
	call UnitAddAbility2(u,'A40E')
	call SaveReal(HY,GetHandleId(t),0,GetUnitX(u))
	call SaveReal(HY,GetHandleId(t),1,GetUnitY(u))
	set t=null
endfunction

function ItemOrderGiven_Teleports takes unit u, item it returns nothing
	if GetOrderPointX()==GetItemX(it) and GetOrderPointY()==GetItemY(it) then
	//if GetOrderPointX()==reals011[GetPlayerId(GetOwningPlayer(u))] and GetOrderPointY()==reals012[GetPlayerId(GetOwningPlayer(u))] then
		if IsSentinel(GetOwningPlayer(u)) then
			if RectContainsUnit(FountainRectSent,u) then
				call InterruptUnit(u)
				call Error(GetOwningPlayer(u),GetObjectName('TX0Y'))//TX0Y -> Can't teleport on fountain while standing nearby fountain.
			endif
		else
			if RectContainsUnit(FountainRectScourge,u) then
				call InterruptUnit(u)
				call Error(GetOwningPlayer(u),GetObjectName('TX0Y'))//TX0Y -> Can't teleport on fountain while standing nearby fountain.
			endif
		endif
	endif
endfunction

function ItemsOrdersWrapper takes nothing returns nothing
	local integer slot=GetIssuedOrderId()-852008
	local unit u=GetTriggerUnit()
	local item it=UnitItemInSlot(u,slot)
	local integer id=GetIndex(it)
	local integer i
	local boolean b
	if id==ScrollOfTownPortal or id==bootsOfTravel or id==bootsOfTravel2 then
		call ItemOrderGiven_Teleports(u,it)
	elseif id==DisabledKelensDagger or id==LinkenDummy or id==TranquilBootsBroken or id==DisabledHeartOfTarrasque then
		if GetUnitTypeId(u)!='e00E'then
			call InterruptUnit(u)
		endif
	elseif id==Tango or id==TangoBorrowed then
		call SetUnitAbilityLevel(u,'Aeat',1)//Aeat -> Eat Tree
		call SetUnitAbilityLevel(u,'A2VG',1)
		if GetOrderTargetUnit()!=null and GetUnitTypeId(GetOrderTargetUnit())=='oeye' or GetUnitTypeId(GetOrderTargetUnit())=='o004' then//oeye -> Sentry Ward, o004 -> Observer Ward
			if IsUnitEnemy(GetOrderTargetUnit(),GetOwningPlayer(u)) then
				call SetUnitAbilityLevel(u,'Aeat',2)//Aeat -> Eat Tree
				call SetUnitAbilityLevel(u,'A2VG',2)
			else
				call InterruptUnit(u)
				call Error(GetOwningPlayer(u),GetObjectName('TX0Z'))//TX0Z -> Cannot target ally ward.
			endif
		elseif GetOrderTargetUnit()!=null then
			if IsUnitEnemy(GetOrderTargetUnit(),GetOwningPlayer(u)) then
				call InterruptUnit(u)
				call Error(GetOwningPlayer(u),GetObjectName('TX10'))//TX10 -> Cannot share Tango with enemy.
			elseif (IsUnitType(GetOrderTargetUnit(),UNIT_TYPE_HERO) or IsSpiritBear(GetOrderTargetUnit()))==false then
				call InterruptUnit(u)
				call Error(GetOwningPlayer(u),GetObjectName('TX11'))//TX11 -> Can only share Tango with heroes and Spirit Bear.
			else
				set i=0
				set b=false
				loop
					if UnitItemInSlot(GetOrderTargetUnit(),i)==null then
						set b=true
						exitwhen true
					endif
					set i=i+1
					exitwhen i>5
				endloop
				//call echo("slots")
				if b==false then
					call InterruptUnit(u)
					call Error(GetOwningPlayer(u),GetObjectName('TX12'))//TX12 -> Target has no slots available.
				endif
			endif
		endif
	elseif id==QuellingBlade or id==QuellingBladeRanged or id==BattleFury then
		if GetOrderTargetUnit()!=null and (GetUnitTypeId(GetOrderTargetUnit())=='oeye' or GetUnitTypeId(GetOrderTargetUnit())=='o004' or IsTechiesLandMine(GetOrderTargetUnit())) then//oeye -> Sentry Ward, o004 -> Observer Ward
			call SetUnitAbilityLevel(u,'A1FD',2)
		else
			call SetUnitAbilityLevel(u,'A1FD',1)
		endif
	elseif id==Eul then
		if GetOrderTargetUnit()!=null and IsUnitEnemy(GetOrderTargetUnit(),GetOwningPlayer(u)) and IsMagicImmune(GetOrderTargetUnit()) then
			call InterruptUnit(u)
			call Error(GetOwningPlayer(u),GetObjectName('TX13'))//TX13 -> Cannot target magic immune enemies.
		endif
	elseif id==ForceStaff then
		if GetOrderTargetUnit()!=null then
			if GetOwningPlayer(GetOrderTargetUnit())!=GetOwningPlayer(u) then
				if GetOrderTargetUnit()==Roshan then
					call InterruptUnit(u)
					call Error(GetOwningPlayer(u),GetObjectName('TX14'))//TX14 -> Cannot target Roshan.
				elseif IsUnitAlly(u,GetOwningPlayer(GetOrderTargetUnit())) and LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetOrderTargetUnit())),139) then//disable help
					call InterruptUnit(u)
					call Error(GetOwningPlayer(u),GetObjectName('n038'))//n038 -> This target has disablehelp on
				elseif IsUnitEnemy(u,GetOwningPlayer(GetOrderTargetUnit())) and IsMagicImmune(GetOrderTargetUnit())then
					call InterruptUnit(u)
					call Error(GetOwningPlayer(u),GetObjectName('TX13'))//TX13 -> Cannot target magic immune enemies.
				endif
			endif
			if IsUnitWard(GetOrderTargetUnit()) then
				if IsHomingMissileId(GetUnitTypeId(GetOrderTargetUnit()))==false then
					call InterruptUnit(u)
					call Error(GetOwningPlayer(u),GetObjectName('TX15'))//TX15 -> Cannot target wards.
				endif
			endif
		endif
	elseif id==ObserverWards or id==SentryWards then
		if GetOrderTargetUnit()!=null then
			if (IsUnitType(GetOrderTargetUnit(),UNIT_TYPE_HERO) or IsSpiritBear(GetOrderTargetUnit()))==false then
				call InterruptUnit(u)
				call Error(GetOwningPlayer(u),GetObjectName('TX16'))//TX16 -> Can only share Ward with heroes and Spirit Bear.
			else
				set i=0
				set b=false
				loop
					if UnitItemInSlot(GetOrderTargetUnit(),i)==null then
						set b=true
						exitwhen true
					endif
					set i=i+1
					exitwhen i>5
				endloop
				if b==false then
					call InterruptUnit(u)
					call Error(GetOwningPlayer(u),GetObjectName('TX12'))//TX12 -> Target has no slots available.
				endif
			endif
		else
			if IsTerrainPathable(GetOrderPointX(),GetOrderPointY(),PATHING_TYPE_WALKABILITY) then
				call InterruptUnit(u)
				call Error(GetOwningPlayer(u),GetObjectName('TX17'))//TX17 -> Cannot place ward there.
			elseif RectContainsCoords(FountainRectSent,GetOrderPointX(),GetOrderPointY()) or RectContainsCoords(FountainRectScourge,GetOrderPointX(),GetOrderPointY()) then
				call InterruptUnit(u)
				call Error(GetOwningPlayer(u),GetObjectName('TX18'))//TX18 -> Cannot place ward at fountain area.
			elseif IsPointInRegion(ForbiddenWardsRegion,GetOrderPointX(),GetOrderPointY()) then
				call InterruptUnit(u)
				call Error(GetOwningPlayer(u),GetObjectName('TX17'))//TX17 -> Cannot place ward there.
			endif
		endif
	elseif id==UrnOfShadows then
		if IsUnitEnemy(GetOrderTargetUnit(),GetOwningPlayer(u)) and IsMagicImmune(GetOrderTargetUnit()) then
			call InterruptUnit(u)
			call Error(GetOwningPlayer(u),GetObjectName('n0LR'))//n0LR -> Target is magic immune
		endif
	elseif id==HandOfMidas then
		if isNecronomiconWarriors(GetOrderTargetUnit()) then
			call InterruptUnit(u)
			call Error(GetOwningPlayer(u),GetObjectName('TX19'))//TX19 -> Cannot target Necronomicon warriors.
		endif
	elseif id==LinkensSphere then
		if IsUnitIllusion(GetOrderTargetUnit()) then
			call InterruptUnit(u)
			call Error(GetOwningPlayer(u),GetObjectName('TX0V'))//TX0V -> Can't target illusions.
		endif
	endif
	set u=null
	set it=null
endfunction

function DoubleHold takes nothing returns nothing
	local unit u
	local integer h
	local integer id
//	if GetIssuedOrderId()==852270 then
//		set u=CreateUnit(Player(1),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)//e00E -> Spellcaster
//		call UnitAddAbility(u,'A46H')//A46H -> Doppelganger
//		call echo(B2S(IssuePointOrderById(u,852270,GetOrderPointX(),GetOrderPointY())))
//	endif
//	call echo(GetUnitName(GetTriggerUnit())+" perfoms "+I2S(GetIssuedOrderId())+" "+OrderId2String(GetIssuedOrderId()))
	if IsPlayerBelongToTeams(GetTriggerPlayer())==false or IsUnitIllusion(GetTriggerUnit()) then
		return
	endif
	set id=GetIssuedOrderId()
	set u=GetTriggerUnit()
	if id>=852008 and id<=852013 then
		call ItemsOrdersWrapper()
	elseif id==852583 then//doom
		if GetUnitAbilityLevel(u,'A0A2')>0 or GetUnitAbilityLevel(u,'A0MU')>0 then
			call DoomUltiTargetFilter()
		endif
//	elseif id==852662 and GetUnitAbilityLevel(GetTriggerUnit(),'A315')>0 then//acidbomb supernova agh
//		call SupernovaAghFilter()
//	elseif GetIssuedOrderId()==852669 and GetUnitAbilityLevel(GetTriggerUnit(),'A2TD')>0 then//volcano pugna's ethereal//A2TD -> Decrepify
//		call PugnaEtherealOrder()
	endif
	
	
	set h=GetHandleId(u)
	if GetIssuedOrderId()==851993 then//hold
		if LoadBoolean(HY,h,'ACQR')==false then
			if LoadInteger(HY,h,'ACQR')!=1 then
				call AddTimedKeyToUnit(u,'ACQR',0.2)
			else
				call AddTimedKeyToUnit(u,'ACQR',0)
				call DoubleHold_AntiInvis(u)
				if IsScourge(GetOwningPlayer(u)) then
					call SetPlayerAlliance(GetOwningPlayer(u), Scourges[0], ALLIANCE_HELP_RESPONSE, false)
				else
					call SetPlayerAlliance(GetOwningPlayer(u), Sentinels[0], ALLIANCE_HELP_RESPONSE, false)
				endif
			endif
		endif
	else
		if GetUnitAbilityLevel(u,'A40E')>0 then
			if IsScourge(GetOwningPlayer(u)) then
				call SetPlayerAlliance(GetOwningPlayer(u), Scourges[0], ALLIANCE_HELP_RESPONSE, true)
			else
				call SetPlayerAlliance(GetOwningPlayer(u), Sentinels[0], ALLIANCE_HELP_RESPONSE, true)
			endif
		endif
	endif
	set u=null
endfunction

function RunePickupPriorityF takes nothing returns nothing
	if GetWidgetLife(GetEnumItem())>0 and IsFakeRune(GetItemTypeId(GetEnumItem())) and DistanceBetweenXY(GetWidgetX(GetEnumItem()),GetWidgetY(GetEnumItem()),GetUnitX(GetOrderTargetUnit()),GetUnitY(GetOrderTargetUnit()))<150 then
		call IssueTargetOrder(GetTriggerUnit(),"smart",GetEnumItem())
	endif
endfunction

function RunePickupPriority takes nothing returns boolean
	if GetIssuedOrderId()==851971 and GetOrderTargetUnit()!=null and IsRealHero(GetTriggerUnit()) then
		if (RectContainsUnit(TopRuneSpawnRect,GetOrderTargetUnit())) then
			call EnumItemsInRect(TopRuneSpawnRect,Condition(function ReturnTrue),function RunePickupPriorityF)
		elseif RectContainsUnit(BottomRuneSpawnRect,GetOrderTargetUnit()) then
			call EnumItemsInRect(BottomRuneSpawnRect,Condition(function ReturnTrue),function RunePickupPriorityF)
		endif
	endif
	return false
endfunction

function EscPressedFiler takes nothing returns nothing
	if b_isPickTime then
		if GetUnitTypeId(GetFilterUnit())=='hfoo' then//hfoo ->  
			if GetTriggerPlayer()==GetLocalPlayer() then
				call ClearSelection()
				call SelectUnit(LoadUnitHandle(HY,GetHandleId(GetFilterUnit()),0),true)
			endif
		endif
	endif
endfunction

function EscPressed takes nothing returns nothing
	local group g
	if b_isPickTime then
		set g=GetAvailableGroup()
		call GroupEnumUnitsSelected(g,GetTriggerPlayer(),Condition(function EscPressedFiler))
		call KillGroup(g)
	endif
	call XKD()
endfunction

function TreeReviveSpeed takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local destructable d=LoadDestructableHandle(HY,h,0)
	call SetDestructableAnimationSpeed(d,1)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set d=null
	set t=null
endfunction

function TreeReviveAnim takes destructable d returns nothing
	local timer t=CreateTimer()
	local integer h=GetHandleId(t)
	call TimerStart(t,2,false,function TreeReviveSpeed)
	if GetDestructableTypeId(d)=='NTtw' then
		call SetDestructableAnimation(d,"birth")
		call SetDestructableAnimationSpeed(d,600)
	else
		call SetDestructableAnimation(d,"birth")
		call SetDestructableAnimationSpeed(d,3)
	endif
	call SaveDestructableHandle(HY,h,0,d)
	
	set t=null
endfunction

function TreeReviveTimer takes nothing returns nothing
	local timer t=GetExpiredTimer()
	local integer h=GetHandleId(t)
	local destructable d=LoadDestructableHandle(HY,h,0)
	call DestructableRestoreLife(d,GetDestructableMaxLife(d),false)
	call TreeReviveAnim(d)
	call PauseTimer(t)
	call DestroyTimer(t)
	call FlushChildHashtable(HY,h)
	set t=null
	set d=null
endfunction

function TreeRevive takes nothing returns nothing
	local timer t=CreateTimer()
	local real time=GetRandomReal(180,300)
	call TimerStart(t,time,false,function TreeReviveTimer)
	call SaveDestructableHandle(HY,GetHandleId(t),0,GetTriggerDestructable())
//	call echo(Id2String(GetDestructableTypeId(GetFilterDestructable())))
	set t=null
endfunction

function TreeRevivalGrouping takes nothing returns boolean
	if IsValidTree(GetFilterDestructable()) then
		call TriggerRegisterDeathEvent(TreeRevivalTrigger,GetFilterDestructable())
	else
//		if LoadBoolean(HY,'000D',GetDestructableTypeId(GetFilterDestructable()))==false then
//			set dstr[asdasd]=GetDestructableTypeId(GetFilterDestructable())
//			set asdasd=asdasd+1
//			call SaveBoolean(HY,'000D',GetDestructableTypeId(GetFilterDestructable()),true)
//		endif
	endif
	return false
endfunction

function LoopTrash takes nothing returns nothing
	local timer t=GetExpiredTimer()
	call RemoveItem(CreateItem('I006'+GetRandomInt(0,2),GetLocationX(TopRuneSpawn),GetLocationY(TopRuneSpawn)))//I006 -> |c00ff0303Haste|r
	call RemoveItem(CreateItem('I006'+GetRandomInt(0,2),GetLocationX(BottomRuneSpawn),GetLocationY(BottomRuneSpawn)))//I006 -> |c00ff0303Haste|r
	call RemoveItem(CreateItem(Item_Dummy[DivineRapier],GetRandomReal(-6000,6000),GetRandomReal(-6000,6000)))
	call RemoveItem(CreateItem(Item_Dummy[Gem],GetRandomReal(-6000,6000),GetRandomReal(-6000,6000)))
	//call RemoveUnit(CreateUnit(Player(12),'n00L',GetRectCenterX(RoshanSpawnRect),GetRectCenterY(RoshanSpawnRect),0))//n00L -> Roshan
	call TimerStart(t,GetRandomReal(1.5,3),false,function LoopTrash)
	set t=null
endfunction

function HeroTrasher takes nothing returns nothing
//	local unit u
//	local integer i=1
//	loop
//		if udg_Hero[i]!=null then
//			call echo("go for "+I2S(i))
//			set u=CreateUnit(Neutrals,EMPTYDUMMY,0,0,0)
//			call UnitAddAbility2(u,'A1HX')//A1HX -> Shadow Dance 2
//			call UnitApplyTimedLife(u,'BTLF',1)
//			call SetUnitX(u,GetUnitX(udg_Hero[i]))
//			call SetUnitY(u,GetUnitY(udg_Hero[i]))
//			call AddSpecialEffectTarget("war3mapImported\\modelcrash.mdx",u,"origin")
//		endif
//		set i=i+1
//		exitwhen i>11
//	endloop
//	
//	call TimerStart(GetExpiredTimer(),GetRandomReal(1.5,3.0),false,function HeroTrasher)
//	set u=null
endfunction

function RuneTrasher takes nothing returns nothing
	local timer t=CreateTimer()
//	call TimerStart(t,1,false,function LoopTrash)
//	set t=CreateTimer()
//	call TimerStart(t,6.00,false,function HeroTrasher)
	set t=null
endfunction

function ConvertCircle takes unit u, integer pid returns nothing
	local player p=Player(pid)
	call UnitAddAbility(u,'A141')//A141 -> Glyph of Fortification Sentinel
	if GetLocalPlayer()==p then
		call ClearSelection()
		call SelectUnit(u, true)
		call SetUnitVertexColor(u,255,255,255,255)
	else
		call SetUnitVertexColor(u,255,255,255,25)
	endif
	set CirclesOfPower[pid]=u
	set ItemSpawnX[pid]=GetUnitX(u)
	set ItemSpawnY[pid]=GetUnitY(u)
endfunction

function HackSelectionDropperCheck2 takes nothing returns nothing
	local integer h=GetHandleId(GetExpiredTimer())
	local player p=LoadPlayerHandle(HY,h,0)
	if GetPlayerSlotState(p)==PLAYER_SLOT_STATE_LEFT then
		call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,10, udg_Colors[GetPlayerId(p)]+GetPlayerName(p) + "|r: Maphack detected, kicked.")
	endif
	call FlushChildHashtable(HY,GetHandleId(GetExpiredTimer()))
	call DestroyTimer(GetExpiredTimer())
endfunction

function HackSelectionDropperCheck takes nothing returns nothing
	local timer t=CreateTimer()
	local player p=GetTriggerPlayer()
	local integer h=GetHandleId(t)
	call TimerStart(t,0.1,false,function HackSelectionDropperCheck2)
	call SavePlayerHandle(HY,h,0,p)
	set t=null
endfunction

function ActionSelect takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local player p=GetTriggerPlayer()
	local integer id=GetPlayerId(p)
	if u == ShowPickUnit then
		set testr1[id]=true
		set testr2[id]=true
	endif
	if u == VisPickUnit then
		if ( GetPlayerController(p) == MAP_CONTROL_USER ) and ( GetPlayerSlotState(p) == PLAYER_SLOT_STATE_PLAYING ) then
			if testr1[id] == false or testr2[id] == true then
				if IsUnitVisibleLoD(ShowTUnit, p) == false then
					set amhc[id]=amhc[id]+1
					if ModuloInteger(amhc[id],30)==3 then
						call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,10, udg_Colors[id]+GetPlayerName(p) + "|r: Maphack detected "+I2S(amhc[id]) + " times")
					endif
					if advancedTracking and ModuloInteger(amhc[id],60)==5 then
						call Traffic_RegisterData("MH"+I2S(id),R2I(TimerGetElapsed(GlobalTimer)))
					endif
				endif
				call SelectUnit(ShowPickUnit, false)
			endif
		set testr1[id]=false
		set testr2[id]=false
		endif
	endif
	if ShowPickUnit != u and VisPickUnit != u then
		set counter1[id]=counter1[id] + 1
		if counter1[id] == 12 then
			set lastunit1[id]=u
		endif
		if counter1[id] == 11 then
			set lastunit2[id]=u
		endif
		if counter1[id] > 12 then
			set counter1[id]=12
		endif
	endif
	call HackSelectionDropperCheck()
endfunction

function ActionDeSelect takes nothing returns nothing
	local unit u=GetTriggerUnit()
	local player p=GetTriggerPlayer()
	local integer id=GetPlayerId(p)
	if ShowPickUnit != u and VisPickUnit != u then
		set counter1[id]=counter1[id] - 1
		if lastunit1[id] == u then
			set lastunit1[id]=null
		endif
		if lastunit2[id] == u then
			set lastunit2[id]=null
		endif
	endif
	if u == ShowPickUnit then
		set testr2[id]=false
	endif
endfunction

function DetectMh takes nothing returns nothing
	if DicktB then
		call SetUnitX(ShowPickUnit, GetRectMinX(bj_mapInitialPlayableArea) + 600)
		call SetUnitY(ShowPickUnit, GetRectMaxY(bj_mapInitialPlayableArea) - 600)
	endif
	if counter1[GetPlayerId(GetTriggerPlayer())] <= 10 then
		call SelectUnit(ShowPickUnit, true)
		call SelectUnit(VisPickUnit, true)
		call SelectUnit(VisPickUnit, false)
		call SelectUnit(ShowPickUnit, false)
	else
		call DisableTrigger(TriggerEn1)
		call DisableTrigger(TriggerEn2)
		call SelectUnit(lastunit1[GetPlayerId(GetLocalPlayer())], false)
		call SelectUnit(lastunit2[GetPlayerId(GetLocalPlayer())], false)
		call SelectUnit(ShowPickUnit, true)
		call SelectUnit(VisPickUnit, true)
		call SelectUnit(VisPickUnit, false)
		call SelectUnit(ShowPickUnit, false)
		call SelectUnit(lastunit1[GetPlayerId(GetLocalPlayer())], true)
		call SelectUnit(lastunit2[GetPlayerId(GetLocalPlayer())], true)
		call EnableTrigger(TriggerEn1)
		call EnableTrigger(TriggerEn2)
	endif
	if DicktB  then
		call SetUnitX(ShowPickUnit, GetRectMaxX(bj_mapInitialPlayableArea))
		call SetUnitY(ShowPickUnit, GetRectMinY(bj_mapInitialPlayableArea))
		set DicktB = false
	else 
		set DicktB = true
	endif
endfunction

function InitAMH takes nothing returns nothing
	local integer i=1
	set ShowPickUnit=CreateUnit(Player(12), 'hfoo', GetRectMaxX(bj_mapInitialPlayableArea), GetRectMinY(bj_mapInitialPlayableArea), 0.00)//hfoo ->  
	set VisPickUnit=CreateUnit(Player(12), 'hfoo', GetRectMinX(bj_mapInitialPlayableArea) + 600, GetRectMaxY(bj_mapInitialPlayableArea) - 600, 0.00)//hfoo ->  
	set ShowTUnit=CreateUnit(Player(12), 'hfoo', GetRectMaxX(bj_mapInitialPlayableArea), GetRectMinY(bj_mapInitialPlayableArea), 0.00)//hfoo ->  
	set TriggerEn1=CreateTrigger()
	set TriggerEn2=CreateTrigger()
	loop
		exitwhen i > 12
		call TriggerRegisterPlayerUnitEvent(TriggerEn1, Player(i), EVENT_PLAYER_UNIT_SELECTED, null)
		call TriggerRegisterPlayerUnitEvent(TriggerEn2, Player(i), EVENT_PLAYER_UNIT_DESELECTED, null)
		set i=i + 1
	endloop
	call TriggerAddAction(TriggerEn1, function ActionSelect)
	call TriggerAddAction(TriggerEn2, function ActionDeSelect)
	set TimerMh = CreateTimer()
	//call TimerStart(TimerMh, 1.5, true, function DetectMh)
endfunction

function AntihackInit takes nothing returns nothing
	local trigger t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,0.1,false)
	call TriggerAddAction(t,function InitAMH)
	call RuneTrasher()
	set t=null
endfunction

function RechargeBottleFountain takes unit u returns nothing
	local integer i=0
	local item it
	local integer id
	local integer k=UnitInventorySize(u)
	loop
		exitwhen i>k
		set it=UnitItemInSlot(u,i)
		set id=GetIndex(it)
		if(id==Bottle0 or id==Bottle1 or id==Bottle2)and GetItemUserData(it)>0 then
			call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"overhead"))
			call SoundForPlayer(GetOwningPlayer(u),"Abilities\\Spells\\Human\\Heal\\HealTarget.wav")
			set tt_player1=GetItemPlayer(it)
			call DestroyItem(it)
			set tt_item1=AddItemByIdInSlot(u,Item_Real[Bottle3],i)
			call SetItemPlayer(tt_item1,tt_player1,false)
			call SetItemUserData(tt_item1,1)
			call UnitRemoveAbility(u,'B0GI')//B0GI -> Empty Bottle Slow
		endif
		set i=i+1
	endloop
	set it=null
endfunction

function FountainHealAct takes nothing returns nothing
	local unit u=GetEnumUnit()
	local integer hu=GetHandleId(u)
	if IsDead(u)==false and (HaveSavedReal(HY,hu,'FnLv')==false or TimerGetElapsed(GlobalTimer)-LoadReal(HY,hu,'FnLv')< 2.5) then
		if GetWidgetLife(u) < GetUnitState(u,UNIT_STATE_MAX_LIFE) then
			if GetUnitAbilityLevel(u,'A35Y')==0 then
				call UnitAddAbility2(u,'A35Y')
			endif
			call SetWidgetLife(u,GetWidgetLife(u)+0.004*GetUnitState(u,UNIT_STATE_MAX_LIFE))
		else
			if GetUnitAbilityLevel(u,'A35Y')==1 then
				call UnitRemoveAbility(u,'A35Y')
			endif
		endif
		if GetUnitState(u,UNIT_STATE_MANA) < GetUnitState(u,UNIT_STATE_MAX_MANA) then
			if GetUnitAbilityLevel(u,'A35Z')==0 then
				call UnitAddAbility2(u,'A35Z')
			endif
			call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+0.004*GetUnitState(u,UNIT_STATE_MAX_MANA)+1.4)
		else
			if GetUnitAbilityLevel(u,'A35Z')==1 then
				call UnitRemoveAbility(u,'A35Z')
			endif
		endif
		if HaveSavedReal(HY,hu,'FnLv')==false and UnitInventorySize(u)>0 and ModuloInteger(GetTriggerEvalCount(GetTriggeringTrigger()),2)==1 then
			call RechargeBottleFountain(u)
		endif
	else
		call UnitRemoveAbility(u,'A35Y')
		call UnitRemoveAbility(u,'A35Z')
		call GroupRemoveUnit(bj_lastCreatedGroup,u)
		call GroupRemoveUnit(FountainGroup,u)
//		call echo(GetUnitName(u)+" removed")
	endif
	if IsCourier(u) then
		if HaveSavedReal(HY,hu,'FnLv') then
			call UnitRemoveAbility(u,'Avul')//Avul -> Invulnerable
		elseif GetUnitAbilityLevel(u,'Avul')==0 then//Avul -> Invulnerable
			call UnitAddAbility2(u,'Avul')//Avul -> Invulnerable
		endif
	endif
	//call echo(I2S(tt_int1))
	set u=null
endfunction

function SentinelFountainFilter takes nothing returns boolean
	return IsSentinel(GetOwningPlayer(GetFilterUnit())) and GetWidgetLife(GetFilterUnit())>0.5 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0//Aloc -> Locust
endfunction

function ScourgeFountainFilter takes nothing returns boolean
	return IsScourge(GetOwningPlayer(GetFilterUnit())) and GetWidgetLife(GetFilterUnit())>0.5 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0//Aloc -> Locust
endfunction

function FoutainEnteringFilter takes nothing returns boolean
	return GetUnitPointValue(GetTriggerUnit())!=200
endfunction

function FountainHeal takes nothing returns nothing
	local group g
	local unit u
	if GetTriggerEventId()==EVENT_GAME_LEAVE_REGION then
		if GetUnitAbilityLevel(GetTriggerUnit(),'Aloc')==0 then//Aloc -> Locust
			if (GetTriggeringRegion()==SentFountainReg and IsSentinel(GetOwningPlayer(GetTriggerUnit()))) or (GetTriggeringRegion()==ScourgeFountainReg and IsScourge(GetOwningPlayer(GetTriggerUnit())))then
				call SaveReal(HY,GetHandleId(GetTriggerUnit()),'FnLv',TimerGetElapsed(GlobalTimer))
				call GroupAddUnit(FountainGroup,GetTriggerUnit())
			endif
//			call echo(GetUnitName(GetTriggerUnit())+" left")
		endif
		return
	endif
	set g=GetAvailableGroup()
	call GroupClear(FountainGroup1)
	call GroupEnumUnitsInRect(g,FountainRectSent,Condition(function SentinelFountainFilter))
	call GroupAddGroup(g,FountainGroup1)
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call RemoveSavedReal(HY,GetHandleId(u),'FnLv')
		call GroupRemoveUnit(FountainGroup,u)
//		if IsUnitType(u,UNIT_TYPE_HERO) then
//			call echo(GetUnitName(u)+" cleaned")
//		endif
		call GroupRemoveUnit(g,u)
	endloop
	call GroupClear(g)
	call GroupClear(FountainGroup2)
	call GroupEnumUnitsInRect(g,FountainRectScourge,Condition(function ScourgeFountainFilter))
	call GroupAddGroup(g,FountainGroup2)
	loop
		set u=FirstOfGroup(g)
		exitwhen u==null
		call RemoveSavedReal(HY,GetHandleId(u),'FnLv')
		call GroupRemoveUnit(FountainGroup,u)
		call GroupRemoveUnit(g,u)
	endloop
	set tt_real1=TimerGetElapsed(GlobalTimer)
	set bj_lastCreatedGroup=FountainGroup1
	//set tt_int1=1
	call ForGroup(FountainGroup1,function FountainHealAct)
	set bj_lastCreatedGroup=FountainGroup2
	//set tt_int1=2
	call ForGroup(FountainGroup2,function FountainHealAct)
	//set tt_int1=3
	call ForGroup(FountainGroup,function FountainHealAct)
	call KillGroup(g)
endfunction

function TrackUnitsCastEvents takes nothing returns nothing
	if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)then
		if GetTriggerEventId()!=EVENT_PLAYER_UNIT_SPELL_ENDCAST then
			call UnitChannelingSomething(GetTriggerUnit(),true)
		else
			call UnitChannelingSomething(GetTriggerUnit(),false)
		endif
	endif
endfunction

function InitSomeLists takes nothing returns nothing
	
endfunction


function Buyback_Addunit takes integer id returns nothing
	set buybackC=buybackC+1
	set BuybackUnitId[buybackC]=id
	set BuybackUnitCost[buybackC]=50*buybackC+50
endfunction

function Buyback_Init takes nothing returns nothing
	call Buyback_Addunit('h09G')//h09G -> Revive Hero 50
	call Buyback_Addunit('h09T')//h09T -> Revive Hero 100
	call Buyback_Addunit('h09F')//h09F -> Revive Hero 150
	call Buyback_Addunit('h09H')//h09H -> Revive Hero 200
	call Buyback_Addunit('h09E')//h09E -> Revive Hero 250
	call Buyback_Addunit('h09D')//h09D -> Revive Hero 300
	call Buyback_Addunit('h09C')//h09C -> Revive Hero 350
	call Buyback_Addunit('h09B')//h09B -> Revive Hero 400
	call Buyback_Addunit('h099')//h099 -> Revive Hero 450
	call Buyback_Addunit('h09A')//h09A -> Revive Hero 500
	call Buyback_Addunit('h09J')//h09J -> Revive Hero 550
	call Buyback_Addunit('h09K')//h09K -> Revive Hero 600
	call Buyback_Addunit('h09L')//h09L -> Revive Hero 650
	call Buyback_Addunit('h09M')//h09M -> Revive Hero 700
	call Buyback_Addunit('h09N')//h09N -> Revive Hero 750
	call Buyback_Addunit('h09O')//h09O -> Revive Hero 800
	call Buyback_Addunit('h09P')//h09P -> Revive Hero 850
	call Buyback_Addunit('h09Q')//h09Q -> Revive Hero 900
	call Buyback_Addunit('h09R')//h09R -> Revive Hero 950
	call Buyback_Addunit('h09S')//h09S -> Revive Hero 1000
	call Buyback_Addunit('h09I')//h09I -> Revive Hero 1050
	call Buyback_Addunit('h09Z')//h09Z -> Revive Hero 1100
	call Buyback_Addunit('h09X')//h09X -> Revive Hero 1150
	call Buyback_Addunit('h0A1')//h0A1 -> Revive Hero 1200
	call Buyback_Addunit('h0A2')//h0A2 -> Revive Hero 1250
	call Buyback_Addunit('h0A6')//h0A6 -> Revive Hero 1300
	call Buyback_Addunit('h0A3')//h0A3 -> Revive Hero 1350
	call Buyback_Addunit('h0A4')//h0A4 -> Revive Hero 1400
	call Buyback_Addunit('h09Y')//h09Y -> Revive Hero 1450
	call Buyback_Addunit('h09V')//h09V -> Revive Hero 1500
	call Buyback_Addunit('h0A0')//h0A0 -> Revive Hero 1550
	call Buyback_Addunit('h09U')//h09U -> Revive Hero 1600
	call Buyback_Addunit('h0AF')//h0AF -> Revive Hero 1650
	call Buyback_Addunit('h0AD')//h0AD -> Revive Hero 1700
	call Buyback_Addunit('h0AE')//h0AE -> Revive Hero 1750
	call Buyback_Addunit('h0AC')//h0AC -> Revive Hero 1800
	call Buyback_Addunit('h0AB')//h0AB -> Revive Hero 1850
	call Buyback_Addunit('h0AA')//h0AA -> Revive Hero 1900
	call Buyback_Addunit('h0A9')//h0A9 -> Revive Hero 1950
	call Buyback_Addunit('h0AG')//h0AG -> Revive Hero 2000
	call Buyback_Addunit('h0A7')//h0A7 -> Revive Hero 2050
	call Buyback_Addunit('h0AO')//h0AO -> Revive Hero 2100
	call Buyback_Addunit('h0AY')//h0AY -> Revive Hero 2150
	call Buyback_Addunit('h0AH')//h0AH -> Revive Hero 2200
	call Buyback_Addunit('h0AI')//h0AI -> Revive Hero 2250
	call Buyback_Addunit('h0AJ')//h0AJ -> Revive Hero 2300
	call Buyback_Addunit('h0AP')//h0AP -> Revive Hero 2350
	call Buyback_Addunit('h0AQ')//h0AQ -> Revive Hero 2400
	call Buyback_Addunit('h0AK')//h0AK -> Revive Hero 2450
	call Buyback_Addunit('h0AR')//h0AR -> Revive Hero 2500
	call Buyback_Addunit('h0AL')//h0AL -> Revive Hero 2550
	call Buyback_Addunit('h0AS')//h0AS -> Revive Hero 2600
	call Buyback_Addunit('h09W')//h09W -> Revive Hero 2650
	call Buyback_Addunit('h0AM')//h0AM -> Revive Hero 2700
	call Buyback_Addunit('h0A8')//h0A8 -> Revive Hero 2750
	call Buyback_Addunit('h0AT')//h0AT -> Revive Hero 2800
	call Buyback_Addunit('h0AU')//h0AU -> Revive Hero 2850
	call Buyback_Addunit('h0AN')//h0AN -> Revive Hero 2900
	call Buyback_Addunit('h0AV')//h0AV -> Revive Hero 2950
	call Buyback_Addunit('h0AW')//h0AW -> Revive Hero 3000
	set BuybackID[0]=BuybackUnitId[0]
	set BuybackID[1]=BuybackUnitId[0]
	set BuybackID[2]=BuybackUnitId[0]
	set BuybackID[3]=BuybackUnitId[0]
	set BuybackID[4]=BuybackUnitId[0]
	set BuybackID[5]=BuybackUnitId[0]
	set BuybackID[6]=BuybackUnitId[0]
	set BuybackID[7]=BuybackUnitId[0]
	set BuybackID[8]=BuybackUnitId[0]
	set BuybackID[9]=BuybackUnitId[0]
	set BuybackID[10]=BuybackUnitId[0]
	set BuybackID[11]=BuybackUnitId[0]
	set BuybackID[12]=BuybackUnitId[0]
	set BuybackID[13]=BuybackUnitId[0]
	set BuybackID[14]=BuybackUnitId[0]
endfunction

function CHD takes integer id, integer hid, integer did,integer cmid,string winanim,real scale returns nothing
	set HeroID[id]=hid
	set HeroDummy[id]=did
	if hid>0 then
		set HeroIcon[id]=GetAbilitySoundById(hid,SOUND_TYPE_EFFECT_LOOPED)
//		if StringLength(HeroIcon[id])<20 then
//			call echo(Id2String(hid)+" - len")
//		endif
	endif
	call SaveUnitWinAnimation(hid,winanim)
	call SaveUnitModelScale(hid,scale,did)
	if IsUnitIdType(hid,UNIT_TYPE_MELEE_ATTACKER) then
		set MeleeHeroesAmount=MeleeHeroesAmount+1
		set MeleeHeroesArray[MeleeHeroesAmount]=hid
	else
		set RangeHeroesAmount=RangeHeroesAmount+1
		set RangeHeroesArray[RangeHeroesAmount]=hid
	endif
endfunction

function InitHeroes takes nothing returns nothing
	call CHD(VS,'Hvwd','h03Z','n09U',"stand 4",1.35)//Hvwd -> Vengeful Spirit, h03Z -> Vengeful Spirit, n09U -> Vengeful Spirit
	call CHD(Zeus,'Hmbr','h040','n09A',"attack slam alternate",1.33)//Hmbr -> Lord of Olympus, h040 -> Zeus, n09A -> Zeus
	call CHD(Enchantress,'Emoo','h041','n099',"stand 4",1.)//Emoo -> Enchantress, h041 -> Enchantress, n099 -> Enchantress
	call CHD(Morphling,'O00P','h042','n098',"stand 2",1.)//O00P -> Morphling, h042 -> Morphling, n098 -> Morphling
	call CHD(indexid_CM,'Hjai','h043','n09W',"stand victory",1.)//Hjai -> Crystal Maiden, h043 -> Rylai, n09W -> Rylai
	call CHD(Sven,'H001','h044','n096',"spell",1.)//H001 -> Rogue Knight, h044 -> Sven, n096 -> Sven
	call CHD(NagaSiren,'HC49','h045','n09P',"spell",1.)//HC49 -> Naga Siren, h045 -> Slithice, n09P -> Slithice
	call CHD(ES,'Otch','h046','n09D',"attack slam",1.1)//Otch -> Earthshaker, h046 -> Earthshaker, n09D -> Earthshaker
	call CHD(Riki,'HC92','h047','n09X',"stand 4",1.)//HC92 -> Stealth Assassin, h047 -> Rikimaru, n09X -> Rikimaru
	call CHD(LoneDruid,'N01O','h048','n09Y',"spell slam",1.)//N01O -> Lone Druid, h048 -> Syllabear, n09Y -> Syllabear
	call SaveUnitModelScale('N013',1.1,0)//N013 -> Lone Druid
	call SaveUnitModelScale('N014',1.2,0)//N014 -> Lone Druid
	call SaveUnitModelScale('N015',1.3,0)//N015 -> Lone Druid
	call SaveUnitModelScale('n004',1.0,0)//n004 -> Spirit Bear
	call SaveUnitModelScale('n018',1.1,0)//n018 -> Spirit Bear
	call SaveUnitModelScale('n01C',1.2,0)//n01C -> Spirit Bear
	call SaveUnitModelScale('n01G',1.3,0)//n01G -> Spirit Bear
	call CHD(Lina,'H004','h049','n09Z',"stand victory",1.2)//H004 -> Slayer, h049 -> Lina, n09Z -> Lina
	call CHD(Juggernaut,'Nbbc','h04A','n0A5',"stand victory",1.)//Nbbc -> Juggernaut, h04A -> Yurnero, n0A5 -> Yurnero
	call CHD(Silencer,'N01A','h04B','n097',"stand ready",1.)//N01A -> Silencer, h04B -> Nortrom, n097 -> Nortrom
	call CHD(Treant,'Hamg','h04C','n09F',"stand 3",.72)//Hamg -> Treant Protector, h04C -> Rooftrellen, n09F -> Rooftrellen
	call CHD(Chieftain,'O015','h07P','n0GC',"stand victory",1.1)//O015 -> Tauren Chieftain, h07P -> Tauren Chieftain, n0GC -> Tauren Chieftain
	call CHD(Kotl,'Hblm','h04E','n09G',"stand victory",1.2)//Hblm -> Keeper of the Light, h04E -> Ezalor, n09G -> Ezalor
	call SaveUnitModelScale('H06X',1.5,0)//H06X -> Keeper of the Light
	call SaveUnitModelScale('H06Y',1.5,0)//H06Y -> Keeper of the Light 2
	call SaveUnitModelScale('H06W',1.5,0)//H06W -> Keeper of the Light 3
	call CHD(Ursa,'Huth','h04F','n09V',"stand spell",1.2)//Huth -> Ursa Warrior, h04F -> Ursa, n09V -> Ursa
	call CHD(OgreMagi,'Hmkg','h04G','n0A1',"sleep",1.4)//Hmkg -> Ogre Magi, h04G -> Ogre Magi, n0A1 -> Ogre Magi
	call CHD(Tinker,'Ntin','h04H','n0AA',"stand 2",1.)//Ntin -> Tinker, h04H -> Tinker, n0AA -> Tinker
	call CHD(Furion,'Emns','h04I','n0A4',"spell",1.2)//Emns -> Prophet, h04I -> Furion, n0A4 -> Furion
	call CHD(PL,'Ogrh','h04J','n0A3',"stand victory",1.)//Ogrh -> Phantom Lancer, h04J -> Phantom Lancer, n0A3 -> Phantom Lancer
	call CHD(Tiny,'Ucrl','h04K','n0A7',"spell",.5)//Ucrl -> Stone Giant, h04K -> Tiny, n0A7 -> Tiny
	call SaveUnitModelScale('U01X',.5,0)//U01X -> Stone Giant
	call CHD(Techies,'H00K','h04L','n0A9',"stand 2",1.)//H00K -> Goblin Techies, h04L -> Techies, n0A9 -> Techies
	call CHD(Chen,'H00A','h04M','n0AB',"spell chain lightning",1.)//H00A -> Holy Knight, h04M -> Chen, n0AB -> Chen
	call CHD(Luna,'E005','h04N','n0BE',"spell",1.)//E005 -> Moon Rider, h04N -> Luna, n0BE -> Luna
	call CHD(Sniper,'Usyl','h04O','n0BD',"spell",1.1)//Usyl -> Dwarven Sniper, h04O -> Sniper, n0BD -> Sniper
	call CHD(Troll,'N016','h04P','n0A8',"stand 3",1.25)//N016 -> Troll Warlord, h04P -> Troll, n0A8 -> Troll
	call SaveUnitModelScale('N02B',1.25,0)//N02B -> Troll Warlord
	call SaveUnitModelScale('QTW2',1.25,0)//QTW2 -> Troll Warlord
	call SaveUnitModelScale('QTW3',1.25,0)//QTW3 -> Troll Warlord
	call SaveUnitModelScale('N017',1.25,0)//N017 -> Troll Warlord
	call CHD(Rhasta,'Orkn','h057','n094',"stand victory",1.)//Orkn -> Shadow Shaman, h057 -> Rhasta, n094 -> Rhasta
	call CHD(Wisp,'O01F','h0CI','n0KS',"stand 3",1.3)//O01F -> Guardian Wisp, h0CI -> Wisp, n0KS -> Guardian Wisp
	call CHD(Pandaren,'Npbm','h053','n0AO',"stand ready",1.)//Npbm -> Pandaren Brewmaster, h053 -> Panda, n0AO -> Panda
	call CHD(Centaur,'H000','h04X','n0AN',"stand 3",1.75)//H000 -> Centaur Warchief, h04X -> Centaur, n0AN -> Centaur
	call CHD(Bounty,'Naka','h052','n0AM',"stand var4",1.2)//Naka -> Bounty Hunter, h052 -> Gondar, n0AM -> Gondar
	call CHD(indexid_DK,'Hlgr','h04V','n0AQ',"stand victory",1.35)//Hlgr -> Dragon Knight, h04V -> Knight Davion, n0AQ -> Knight Davion
	call SaveUnitModelScale('H00F',1,0)//H00F -> Dragon Knight
	call SaveUnitModelScale('H00G',1,0)//H00G -> Dragon Knight
	call SaveUnitModelScale('H00E',1,0)//H00E -> Dragon Knight
	call FR9('H00G',255,255,200)//H00G -> Dragon Knight
	call FR9('H00F',255,255,200)//H00F -> Dragon Knight
	call FR9('H00G',255,200,200)//H00G -> Dragon Knight
	call CHD(indexid_AM,'Edem','h04T','n0AR',"stand channel",1.)//Edem -> Anti-Mage, h04T -> Magina, n0AR -> Magina
	call CHD(Trax,'Nbrn','h055','n0AL',"spell",1.)//Nbrn -> Drow Ranger, h055 -> Traxex, n0AL -> Traxex
	call CHD(Omni,'Harf','h04Z','n0AS',"stand victory",1.1)//Harf -> Omniknight, h04Z -> Omniknight, n0AS -> Omniknight
	call CHD(Beastmaster,'H00D','h04S','n0AK',"spell slam",1.)//H00D -> Beastmaster, h04S -> Rexxar, n0AK -> Rexxar
	call CHD(THD,'E00P','h04R','n0AJ',"stand 3",1.)//E00P -> Twin Head Dragon, h04R -> Jakiro, n0AJ -> Jakiro
	call CHD(Alchemist,'N01I','h054','n0AI',"stand 2",1.)//N01I -> Alchemist, h054 -> Alchemist, n0AI -> Alchemist
	call SaveUnitModelScale('N01J',1,0)//N01J -> Alchemist
	call SaveUnitModelScale('N01H',1,0)//N01H -> Alchemist
	call SaveUnitModelScale('N01T',1,0)//N01T -> Alchemist
	call SaveUnitModelScale('H600',1,0)//H600 -> Alchemist
	call SaveUnitModelScale('H601',1,0)//H601 -> Alchemist
	call SaveUnitModelScale('H602',1,0)//H602 -> Alchemist
	call CHD(Potm,'N01V','h04W','n0AH',"stand ready",1.)//N01V -> Priestess of the Moon, h04W -> Mirana, n0AH -> Mirana
	call CHD(Storm,'H00S','h04Q','n0AT',"spell",1.)//H00S -> Storm Spirit, h04Q -> Storm, n0AT -> Storm
	call CHD(Huskar,'H00Q','h04Y','n0AG',"stand alternate 3",1.15)//H00Q -> Sacred Warrior, h04Y -> Huskar, n0AG -> Huskar
	call CHD(Lanaya,'E01Y','h058','n0AF',"stand victory",1.2)//E01Y -> Templar Assassin, h058 -> Lanaya, n0AF -> Lanaya
	call CHD(Puck,'N00B','h050','n0AE',"attack spell",1.1)//N00B -> Faerie Dragon, h050 -> Puck, n0AE -> Puck
	call CHD(Clock,'H00T','h051','n0AU',"Birth",1.5)//H00T -> Clockwerk Goblin, h051 -> Clockwerk, n0AU -> Clockwerk
	call CHD(Admiral,'H06S','h06T','n0EE',"stand victory",1.1)//H06S -> Admiral, h06T -> Kunkka, n0EE -> Kunkka
	call CHD(WR,'N0EG','h07A','n0EH',"stand victory",1.2)//N0EG -> Windrunner, h07A -> Windrunner, n0EH -> Windrunner
	call CHD(Gyro,'E02N','h0CC','n0KN',"stand 3",1.1)//E02N -> Gyrocopter, h0CC -> Gyrocopter, n0KN -> Gyrocopter
	call SaveUnitModelScale('E02O',1.1,0)//E02O -> Gyrocopter
	call CHD(Disruptor,'E02J','h0CD','n0KR',"stand 3",1.1)//E02J -> Disruptor, h0CD -> Disruptor, n0KR -> Thrall
	call CHD(Tusk,'E02I','h0C9','n0KK',"stand 3",1.)//E02I -> Tuskarr, h0C9 -> Tuskarr, n0KK -> Tuskarr
	call CHD(Phoenix,'E02F','h0C8','n0KM',"stand 3",1.05)//E02F -> Phoenix, h0C8 -> Phoenix, n0KM -> Phoenix
	call CHD(BB,'H008','h04U','n0AC',"stand",1.65)//H008 -> Bristleback, h04U -> Bristleback, n0AC -> Bristleback
	call CHD(Rubick,'E02X','h0CT','n0LK',"stand 3",1.15)//E02X -> Grand Magus, h0CT -> Rubick, n0LK -> Rubick
	call CHD(Xin,'N0M0','h0DG','n0M1',"stand 3",1.)//N0M0 -> Ember Spirit, h0DG -> Ember Spirit, n0M1 -> Ember Spirit
	call CHD(Legion,'E02K','h0CA','n0KJ',"stand 3",1.3)//E02K -> Legion Commander, h0CA -> Legion Commander, n0KJ -> Legion Commander
	call CHD(Skywrath,'H0DO','h0DH','n0M6',"stand 3",1.1)//H0DO -> Skywrath Mage, h0DH -> Skywrath Mage, n0M6 -> Skywrath Mage
	call CHD(Timber,'E032','h0EB','n0ME',"stand 3",1.)//E032 -> Goblin Shredder, h0EB -> Goblin Shredder, n0ME -> Goblin Shredder
	set LastSentinelHeroIndexid=57
	set FirstScourgeHeroIndexid=58
	call CHD(Lycan,'U008','h05H','n0B3',"spell",1.2)//U008 -> Lycanthrope, h05H -> Lycan, n0B3 -> Lycan
	call SaveUnitModelScale('E015',1,0)//E015 -> Lycanthrope
	call FR9(HeroID[Lycan],255,75,255)
	call CHD(Brood,'U006','h05I','n0B4',"walk",1.36)//U006 -> Broodmother, h05I -> Broodmother, n0B4 -> Broodmother
	call CHD(PA,'Ewar','h05J','n0B5',"spell slam",1.)//Ewar -> Phantom Assassin, h05J -> Mortred, n0B5 -> Mortred
	call CHD(Medusa,'H00V','h05K','n0B6',"stand ready",1.)//H00V -> Gorgon, h05K -> Medusa, n0B6 -> Medusa
	call SaveUnitModelScale('H08D',1,0)//H08D -> Gorgon
	call SaveUnitModelScale('H08C',1,0)//H08C -> Gorgon
	call SaveUnitModelScale('H084',1,0)//H084 -> Gorgon
	call SaveUnitModelScale('H08B',1,0)//H08B -> Gorgon
	call CHD(Bala,'Udre','h05L','n0B7',"spell slam",1.)//Udre -> Night Stalker, h05L -> Balanar, n0B7 -> Balanar
	call CHD(Leoric,'NC00','h05M','n0C0',"stand victory",1.8)//NC00 -> Skeleton King, h05M -> Leoric, n0C0 -> Leoric
	call FR9(HeroID[Leoric],100,125,100)
	call CHD(Doom,'UC42','h05N','n0BV',"stand victory",1.1)//UC42 -> Doom Bringer, h05N -> Lucifer, n0BV -> Lucifer
	call CHD(NA,'U000','h05O','n0BU',"spell throw",.8)//U000 -> Nerubian Assassin, h05O -> Nerubian Assassin, n0BU -> Nerubian Assassin
	call CHD(Slardar,'UC91','h05P','n0C1',"spell",1.)//UC91 -> Slithereen Guard, h05P -> Slardar, n0C1 -> Slardar
	call FR9(HeroID[Slardar],175,75,200)
	call CHD(QoP,'UC01','h05Q','n0C2',"spell slam",1.3)//UC01 -> Queen of Pain, h05Q -> Akasha, n0C2 -> Akasha
	call CHD(Bone,'E004','h05R','n0BW',"stand victory",1.)//E004 -> Bone Fletcher, h05R -> Clinkz, n0BW -> Clinkz
	call CHD(Void,'EC45','h05S','n0BS',"spell slam",1.3)//EC45 -> Faceless Void, h05S -> Void, n0BS -> Void
	call FR9(HeroID[Void],0,255,150)
	call CHD(Viper,'EC77','h05T','n0BR',"spell slam",1.2)//EC77 -> Netherdrake, h05T -> Viper, n0BR -> Viper
	call FR9(HeroID[Viper],75,255,25)
	call CHD(Razor,'E002','h05U','n0BY',"spell",1.)//E002 -> Lightning Revenant, h05U -> Razor, n0BY -> Razor
	call CHD(Lifestealer,'U00C','h05V','n0BQ',"victory",1.5)//U00C -> Lifestealer, h05V -> N'aix, n0BQ -> N'aix
	call FR9(HeroID[Lifestealer],100,100,100)
	call CHD(Pugna,'H00H','h05W','n0BT',"stand ready",1.)//H00H -> Oblivion, h05W -> Pugna, n0BT -> Pugna
	call CHD(Tide,'Ofar','h05X','n0BP',"attack slam",1.)//Ofar -> Tidehunter, h05X -> Tidehunter, n0BP -> Tidehunter
	call CHD(Bane,'Oshd','h05Y','n0BO',"spell",1.5)//Oshd -> Bane Elemental, h05Y -> Atropos, n0BO -> Atropos
	call FR9(HeroID[Bane],150,0,150)
	call CHD(Necrolyte,'U00E','h05Z','n0B8',"stand victory",1.3)//U00E -> Necrolyte, h05Z -> Necrolyte, n0B8 -> Necrolyte
	call CHD(Pudge,'U00F','h060','n0C5',"stand 3",1.)//U00F -> Butcher, h060 -> Pudge, n0C5 -> Pudge
	call CHD(Barathum,'O00J','h061','n0C3',"stand ready",1.2)//O00J -> Spiritbreaker, h061 -> Barathrum, n0C3 -> Barathrum
	call CHD(Weaver,'Ubal','h062','n0BX',"attack",1.)//Ubal -> Nerubian Weaver, h062 -> Weaver, n0BX -> Weaver
	call FR9(HeroID[Weaver],255,200,200)
	call CHD(indexid_SF,'Nfir','h063','n0BN',"stand channel",1.15)//Nfir -> Shadow Fiend, h063 -> Nevermore, n0BN -> Nevermore
	call FR9(HeroID[indexid_SF],0,0,0)
	call CHD(SK,'U00K','h064','n0C4',"attack 3",1.)//U00K -> Sand King, h064 -> Crixalis, n0C4 -> Crixalis
	call CHD(Axe,'Opgh','h065','n0BM',"stand victory",1.)//Opgh -> Axe, h065 -> Axe, n0BM -> Axe
	call CHD(BS,'Hvsh','h066','n0BZ',"stand victory",1.25)//Hvsh -> Bloodseeker, h066 -> Strygwyr, n0BZ -> Strygwyr
	call FR9(HeroID[BS],250,150,150)
	call CHD(Abaddon,'Udea','h067','n0BL',"stand ready",1.)//Udea -> Lord of Avernus, h067 -> Abaddon, n0BL -> Abaddon
	call CHD(Spectre,'E01B','h068','n0B9',"stand ready",.8)//E01B -> Spectre, h068 -> Spectre, n0B9 -> Spectre
	call CHD(WD,'E01A','h069','n0BK',"stand victory",1.25)//E01A -> Witch Doctor, h069 -> Witch Doctor, n0BK -> Witch Doctor
	call CHD(OD,'U00P','h06A','n0BA',"stand alternate 2",.85)//U00P -> Obsidian Destroyer, h06A -> Destroyer, n0BA -> Destroyer
	call CHD(WL,'E01C','h06C','n0BB',"spell",1.5)//E01C -> Warlock, h06C -> Warlock, n0BB -> Warlock
	call CHD(Geomancer,'H00I','h06D','n0BJ',"spell",1.4)//H00I -> Geomancer, h06D -> Geomancer, n0BJ -> Geomancer
	call SaveUnitModelScale('H00J',1.4,0)//H00J -> Geomancer
	call CHD(Dazzle,'N01W','h06E','n0BI',"spell",1.2)//N01W -> Shadow Priest, h06E -> Dazzle, n0BI -> Dazzle
	call CHD(Pit,'N00R','h06F','n0BC',"stand channel",.95)//N00R -> Pit Lord, h06F -> Pit Lord, n0BC -> Pit Lord
	call CHD(Zombie,'H00R','h06G','n0BH',"stand",2.)//H00R -> Undying, h06G -> Undying, n0BH -> Undying
	call SaveUnitModelScale('H07I',1.3,0)//H07I -> Flesh Golem
	call CHD(DS,'H00N','h06H','n0BG',"spell",1.15)//H00N -> Dark Seer, h06H -> Dark Seer, n0BG -> Dark Seer
	call CHD(Kodo,'KODO','ho0E',0,"stand victory",1.)//KODO -> Chakk, ho0E -> Kodo Beast
	call CHD(Enigma,'Uktl','h04D','n0A6',"stand",1.5)//Uktl -> Enigma, h04D -> Enigma, n0A6 -> Enigma
	call CHD(Batrider,'O016','h07R','n0G9',"stand",1.2)//O016 -> Batrider, h07R -> Batrider, n0G9 -> Batrider
	call SaveUnitModelScale('O017',1.2,0)//O017 -> Batrider
	call CHD(indexid_AA,'N0HP','h0B0','n0HR',"stand",1.17)//N0HP -> Ancient Apparition, h0B0 -> Ancient Apparition, n0HR -> Ancient Apparition
	call SaveUnitModelScale('N0HP',1.2,0)//N0HP -> Ancient Apparition
	call CHD(Slark,'H071','h072','n0EF',"stand 3",1.25)//H071 -> Murloc Nightcrawler, h072 -> Slark, n0EF -> Slark
	call CHD(TB,'Eevi','h056','n0AV',"spell channel",1.)//Eevi -> Soul Keeper, h056 -> Terrorblade, n0AV -> Terrorblade
	call SaveUnitModelScale('Eevm',1,0)//Eevm -> Soul Keeper
	call SaveUnitModelScale('E02V',1,0)//E02V -> Soul Keeper
	call SaveUnitModelScale('E02W',1,0)//E02W -> Soul Keeper
	call SaveUnitModelScale('E02U',1,0)//E02U -> Soul Keeper
	call CHD(Leshrak,'Ekee','h059','n0AW',"stand victory",1.)//Ekee -> Tormented Soul, h059 -> Leshrac, n0AW -> Leshrac
	call CHD(indexid_SD,'E02H','h0CB','n0KL',"stand 3",1.25)//E02H -> Shadow Demon, h0CB -> Eredar, n0KL -> Shadow Demon
	call CHD(Lich,'Ulic','h05A','n0AX',"stand channel",1.3)//Ulic -> Lich, h05A -> Lich, n0AX -> Lich
	call CHD(Banshee,'UC76','h05B','n0AY',"spell wail",1.35)//UC76 -> Death Prophet, h05B -> Krobelus, n0AY -> Krobelus
	call CHD(Lion,'UC18','h05C','n0AZ',"spell callstorm",1.3)//UC18 -> Demon Witch, h05C -> Lion, n0AZ -> Lion
	call FR9(HeroID[Lion],50,100,255)
	call CHD(Veno,'EC57','h05D','n0B0',"attack",1.)//EC57 -> Venomancer, h05D -> Venomancer, n0B0 -> Venomancer
	call FR9(HeroID[Veno],150,200,255)
	call CHD(Magnus,'UC11','h05E','n0A2',"stand channel",1.)//UC11 -> Magnataur, h05E -> Magnus, n0A2 -> Magnus
	call FR9(HeroID[Magnus],150,150,100)
	call CHD(Visage,'UC60','h05F','n0B1',"stand victory",1.)//UC60 -> Necro'lic, h05F -> Visage, n0B1 -> Visage
	call FR9(HeroID[Visage],150,150,150)
	call CHD(Nessaj,'U00A','h05G','n0B2',"stand victory",1.05)//U00A -> Chaos Knight, h05G -> Nessaj, n0B2 -> Nessaj
	call CHD(Wyvern,'N0M7','h0DW','n0M8',"stand victory",.9)//N0M7 -> Winter Wyvern, h0DW -> Winter Wyvern, n0M8 -> Winter Wyvern
	call CHD(Zet,'N0MK','h0EF','n0ML',"stand victory",1.5)//N0MK -> Arc Warden
	call CHD(Earth,'N0MU','ho04',0,"stand 3",1.)//N0MU -> Earth Spirit, ho04 -> Earth Spirit
	call CHD(Oracle,'N0MD','ho05',0,"stand victory",1.25)//N0MD -> Oracle, ho05 -> Oracle
	call CHD(Crabe,'H503','ho06',0,"spell",1.)//H503 -> Utility Lobster, ho06 -> Crabe
	call CHD(Sieger,'H501','ho07',0,"attack",1.2)//H501 -> Sieger, ho07 -> Sieger
	call CHD(Sorcesser,'H502','ho08',0,"spell channel",1.)//H502 -> Sorceress, ho08 -> Sorceress
	call CHD(Invoker,'H00U','ho09',0,"spell",1.)//H00U -> Invoker, ho09 -> Invoker
	call CHD(Formless,'H500','ho0A',0,"attack",1.1)//H500 -> Formless, ho0A -> Formless
	call CHD(SpaceOrc,'H504','ho0B',0,"spell",1.3)//H504 -> Space Orc, ho0B -> Space Orc
	call CHD(OgreLord,'H505','ho0C',0,"sleep",1.7)//H505 -> Ogre Lord, ho0C -> Ogre Lord
	call CHD(FireLord,'H506','ho0D',0,"spell",1.2)//H506 -> Fire Lord, ho0D -> Fire Lord
	call CHD(Queen,'H507','ho0F',0,"attack",1.0)//H507 -> Talon Queen, ho0F -> Alyra
	
	set LastScourgeHeroIndexid=Queen
	
	set AgiHeroesArray[1]='Nbrn'//agility//Nbrn -> Drow Ranger
	set AgiHeroesArray[2]='Edem'//Edem -> Anti-Mage
	set AgiHeroesArray[3]='N016'//N016 -> Troll Warlord
	set AgiHeroesArray[4]='Nbbc'//Nbbc -> Juggernaut
	set AgiHeroesArray[5]='Naka'//Naka -> Bounty Hunter
	set AgiHeroesArray[6]='O00P'//O00P -> Morphling
	set AgiHeroesArray[7]='Usyl'//Usyl -> Dwarven Sniper
	set AgiHeroesArray[8]='E005'//E005 -> Moon Rider
	set AgiHeroesArray[9]='N01O'//N01O -> Lone Druid
	set AgiHeroesArray[10]='HC92'//HC92 -> Stealth Assassin
	set AgiHeroesArray[11]='Hvwd'//Hvwd -> Vengeful Spirit
	set AgiHeroesArray[12]='HC49'//HC49 -> Naga Siren
	set AgiHeroesArray[13]='Huth'//Huth -> Ursa Warrior
	set AgiHeroesArray[14]='Ogrh'//Ogrh -> Phantom Lancer
	set AgiHeroesArray[15]='U006'//U006 -> Broodmother
	set AgiHeroesArray[16]='EC57'//EC57 -> Venomancer
	set AgiHeroesArray[17]='Eevi'//Eevi -> Soul Keeper
	set AgiHeroesArray[18]='Ubal'//Ubal -> Nerubian Weaver
	set AgiHeroesArray[19]='E004'//E004 -> Bone Fletcher
	set AgiHeroesArray[20]='EC77'//EC77 -> Netherdrake
	set AgiHeroesArray[21]='Hvsh'//Hvsh -> Bloodseeker
	set AgiHeroesArray[22]='Nfir'//Nfir -> Shadow Fiend
	set AgiHeroesArray[23]='E002'//E002 -> Lightning Revenant
	set AgiHeroesArray[24]='EC45'//EC45 -> Faceless Void
	set AgiHeroesArray[25]='Ewar'//Ewar -> Phantom Assassin
	set AgiHeroesArray[26]='U000'//U000 -> Nerubian Assassin
	set AgiHeroesArray[27]='H00V'//H00V -> Gorgon
	set AgiHeroesArray[28]='E01B'//E01B -> Spectre
	set AgiHeroesArray[29]='N01V'//N01V -> Priestess of the Moon
	set AgiHeroesArray[30]='H00I'//H00I -> Geomancer
	set AgiHeroesArray[31]='E01Y'//E01Y -> Templar Assassin
	set AgiHeroesArray[32]='H071'//H071 -> Murloc Nightcrawler
	set AgiHeroesArray[33]='E02N'//E02N -> Gyrocopter
	set AgiHeroesArray[34]='N0M0'//N0M0 -> Ember Spirit
	set AgiHeroesArray[35]=HeroID[Zet]//N0MK -> Arc Warden
	set AgiHeroesArray[36]=HeroID[Crabe]
	set AgiHeroesArray[37]=HeroID[Queen]//H507 -> Talon Queen
	set AgilityHeroesAmount=37
	set StrHeroesArray[1]='Npbm'//strength//Npbm -> Pandaren Brewmaster
	set StrHeroesArray[2]='Hlgr'//Hlgr -> Dragon Knight
	set StrHeroesArray[3]='Harf'//Harf -> Omniknight
	set StrHeroesArray[4]='H000'//H000 -> Centaur Warchief
	set StrHeroesArray[5]='H001'//H001 -> Rogue Knight
	set StrHeroesArray[6]='Hamg'//Hamg -> Treant Protector
	set StrHeroesArray[7]='H008'//H008 -> Bristleback
	set StrHeroesArray[8]='Ucrl'//Ucrl -> Stone Giant
	set StrHeroesArray[9]='Otch'//Otch -> Earthshaker
	set StrHeroesArray[10]='NC00'//NC00 -> Skeleton King
	set StrHeroesArray[11]='Udre'//Udre -> Night Stalker
	set StrHeroesArray[12]='UC11'//UC11 -> Magnataur
	set StrHeroesArray[13]='Ofar'//Ofar -> Tidehunter
	set StrHeroesArray[14]='U00F'//U00F -> Butcher
	set StrHeroesArray[15]='U00K'//U00K -> Sand King
	set StrHeroesArray[16]='O00J'//O00J -> Spiritbreaker
	set StrHeroesArray[17]='Udea'//Udea -> Lord of Avernus
	set StrHeroesArray[18]='Opgh'//Opgh -> Axe
	set StrHeroesArray[19]='U00A'//U00A -> Chaos Knight
	set StrHeroesArray[20]='U00C'//U00C -> Lifestealer
	set StrHeroesArray[21]='UC91'//UC91 -> Slithereen Guard
	set StrHeroesArray[22]='UC42'//UC42 -> Doom Bringer
	set StrHeroesArray[23]='U008'//U008 -> Lycanthrope
	set StrHeroesArray[24]='H00D'//H00D -> Beastmaster
	set StrHeroesArray[25]='N01I'//N01I -> Alchemist
	set StrHeroesArray[26]='H00Q'//H00Q -> Sacred Warrior
	set StrHeroesArray[27]='N00R'//N00R -> Pit Lord
	set StrHeroesArray[28]='H00T'//H00T -> Clockwerk Goblin
	set StrHeroesArray[29]='H06S'//H06S -> Admiral
	set StrHeroesArray[30]='H00R'//H00R -> Undying
	set StrHeroesArray[31]='O015'//O015 -> Tauren Chieftain
	set StrHeroesArray[32]='E02I'//E02I -> Tuskarr
	set StrHeroesArray[33]='E02F'//E02F -> Phoenix
	set StrHeroesArray[34]='O01F'//O01F -> Guardian Wisp
	set StrHeroesArray[35]='E032'//E032 -> Goblin Shredder
	set StrHeroesArray[36]='E02K'//E02K -> Legion Commander
	set StrHeroesArray[37]='N0MU'//N0MU -> Earth Spirit
	set StrHeroesArray[38]='KODO'//KODO -> Chakk
	set StrHeroesArray[39]='H501'//H501 -> Sieger
	set StrHeroesArray[40]='H504'//H504 -> Space Orc
	set StrHeroesArray[41]='H505'//H505 -> Ogre Lord
	set StrHeroesArray[42]='H506'//H506 -> Fire Lord
	set StrHeroesAmount=42
	set IntHeroesArray[1]='Orkn'//intel//Orkn -> Shadow Shaman
	set IntHeroesArray[2]='Emoo'//Emoo -> Enchantress
	set IntHeroesArray[3]='Emns'//Emns -> Prophet
	set IntHeroesArray[4]='H004'//H004 -> Slayer
	set IntHeroesArray[5]='Hjai'//Hjai -> Crystal Maiden
	set IntHeroesArray[6]='Uktl'//Uktl -> Enigma
	set IntHeroesArray[7]='Hmbr'//Hmbr -> Lord of Olympus
	set IntHeroesArray[8]='H00K'//H00K -> Goblin Techies
	set IntHeroesArray[9]='Ntin'//Ntin -> Tinker
	set IntHeroesArray[10]='Hmkg'//Hmkg -> Ogre Magi
	set IntHeroesArray[11]='Hblm'//Hblm -> Keeper of the Light
	set IntHeroesArray[12]='N01A'//N01A -> Silencer
	set IntHeroesArray[13]='H00A'//H00A -> Holy Knight
	set IntHeroesArray[14]='Ulic'//Ulic -> Lich
	set IntHeroesArray[15]='Ekee'//Ekee -> Tormented Soul
	set IntHeroesArray[16]='UC76'//UC76 -> Death Prophet
	set IntHeroesArray[17]='UC18'//UC18 -> Demon Witch
	set IntHeroesArray[18]='UC01'//UC01 -> Queen of Pain
	set IntHeroesArray[19]='UC60'//UC60 -> Necro'lic
	set IntHeroesArray[20]='H00H'//H00H -> Oblivion
	set IntHeroesArray[21]='Oshd'//Oshd -> Bane Elemental
	set IntHeroesArray[22]='U00E'//U00E -> Necrolyte
	set IntHeroesArray[23]='E01A'//E01A -> Witch Doctor
	set IntHeroesArray[24]='U00P'//U00P -> Obsidian Destroyer
	set IntHeroesArray[25]='E00P'//E00P -> Twin Head Dragon
	set IntHeroesArray[26]='E01C'//E01C -> Warlock
	set IntHeroesArray[27]='N01W'//N01W -> Shadow Priest
	set IntHeroesArray[28]='H00N'//H00N -> Dark Seer
	set IntHeroesArray[29]='N0EG'//N0EG -> Windrunner
	set IntHeroesArray[30]='H00S'//H00S -> Storm Spirit
	set IntHeroesArray[31]='N00B'//N00B -> Faerie Dragon
	set IntHeroesArray[32]='H00U'//H00U -> Invoker
	set IntHeroesArray[33]='O016'//O016 -> Batrider
	set IntHeroesArray[34]='N0HP'//N0HP -> Ancient Apparition
	set IntHeroesArray[35]='E02H'//E02H -> Shadow Demon
	set IntHeroesArray[36]='E02J'//E02J -> Disruptor
	set IntHeroesArray[37]='E02X'//E02X -> Grand Magus
	set IntHeroesArray[38]='H0DO'//H0DO -> Skywrath Mage
	set IntHeroesArray[39]='N0M7'//N0M7 -> Winter Wyvern
	set IntHeroesArray[40]='N0MD'//N0MD -> Oracle
	set IntHeroesArray[41]='H500'//H500 -> Formless
	set IntHeroesArray[42]='H502'//H502 -> Sorceress
	set IntHeroesAmount=42
//	set RangeHeroesArray[1]='Orkn'//range//Orkn -> Shadow Shaman
//	set RangeHeroesArray[2]='Emoo'//Emoo -> Enchantress
//	set RangeHeroesArray[3]='Emns'//Emns -> Prophet
//	set RangeHeroesArray[4]='H004'//H004 -> Slayer
//	set RangeHeroesArray[5]='Hjai'//Hjai -> Crystal Maiden
//	set RangeHeroesArray[6]='Uktl'//Uktl -> Enigma
//	set RangeHeroesArray[7]='Hmbr'//Hmbr -> Lord of Olympus
//	set RangeHeroesArray[8]='H00K'//H00K -> Goblin Techies
//	set RangeHeroesArray[9]='Ntin'//Ntin -> Tinker
//	set RangeHeroesArray[10]='Nbrn'//Nbrn -> Drow Ranger
//	set RangeHeroesArray[11]='Hblm'//Hblm -> Keeper of the Light
//	set RangeHeroesArray[12]='N01A'//N01A -> Silencer
//	set RangeHeroesArray[13]='H00A'//H00A -> Holy Knight
//	set RangeHeroesArray[14]='Ulic'//Ulic -> Lich
//	set RangeHeroesArray[15]='Ekee'//Ekee -> Tormented Soul
//	set RangeHeroesArray[16]='UC76'//UC76 -> Death Prophet
//	set RangeHeroesArray[17]='UC18'//UC18 -> Demon Witch
//	set RangeHeroesArray[18]='UC01'//UC01 -> Queen of Pain
//	set RangeHeroesArray[19]='UC60'//UC60 -> Necro'lic
//	set RangeHeroesArray[20]='H00H'//H00H -> Oblivion
//	set RangeHeroesArray[21]='Oshd'//Oshd -> Bane Elemental
//	set RangeHeroesArray[22]='U00E'//U00E -> Necrolyte
//	set RangeHeroesArray[23]='E01A'//E01A -> Witch Doctor
//	set RangeHeroesArray[24]='U00P'//U00P -> Obsidian Destroyer
//	set RangeHeroesArray[25]='E00P'//E00P -> Twin Head Dragon
//	set RangeHeroesArray[26]='E01C'//E01C -> Warlock
//	set RangeHeroesArray[27]='N01W'//N01W -> Shadow Priest
//	set RangeHeroesArray[28]='N0EG'//N0EG -> Windrunner
//	set RangeHeroesArray[29]='H00S'//H00S -> Storm Spirit
//	set RangeHeroesArray[30]='N00B'//N00B -> Faerie Dragon
//	set RangeHeroesArray[31]='H00U'//H00U -> Invoker
//	set RangeHeroesArray[32]='N016'//N016 -> Troll Warlord
//	set RangeHeroesArray[33]='O00P'//O00P -> Morphling
//	set RangeHeroesArray[34]='Usyl'//Usyl -> Dwarven Sniper
//	set RangeHeroesArray[35]='E005'//E005 -> Moon Rider
//	set RangeHeroesArray[36]='N01O'//N01O -> Lone Druid
//	set RangeHeroesArray[37]='E01Y'//E01Y -> Templar Assassin
//	set RangeHeroesArray[38]='Hvwd'//Hvwd -> Vengeful Spirit
//	set RangeHeroesArray[39]='EC57'//EC57 -> Venomancer
//	set RangeHeroesArray[40]='Ubal'//Ubal -> Nerubian Weaver
//	set RangeHeroesArray[41]='E004'//E004 -> Bone Fletcher
//	set RangeHeroesArray[42]='EC77'//EC77 -> Netherdrake
//	set RangeHeroesArray[43]='Nfir'//Nfir -> Shadow Fiend
//	set RangeHeroesArray[44]='E002'//E002 -> Lightning Revenant
//	set RangeHeroesArray[45]='H00V'//H00V -> Gorgon
//	set RangeHeroesArray[46]='N01V'//N01V -> Priestess of the Moon
//	set RangeHeroesArray[47]='H00Q'//H00Q -> Sacred Warrior
//	set RangeHeroesArray[48]='O016'//O016 -> Batrider
//	set RangeHeroesArray[49]='N0HP'//N0HP -> Ancient Apparition
//	set RangeHeroesArray[50]='O01F'//O01F -> Guardian Wisp
//	set RangeHeroesArray[51]='E02H'//E02H -> Shadow Demon
//	set RangeHeroesArray[52]='E02N'//E02N -> Gyrocopter
//	set RangeHeroesArray[53]='E02J'//E02J -> Disruptor
//	set RangeHeroesArray[54]='E02F'//E02F -> Phoenix
//	set RangeHeroesArray[55]='E02X'//E02X -> Grand Magus
//	set RangeHeroesArray[56]='H0DO'//H0DO -> Skywrath Mage
//	set RangeHeroesArray[57]='N0MK'//N0MK -> Arc Warden
//	set RangeHeroesArray[58]='N0M7'//N0M7 -> Winter Wyvern
//	set RangeHeroesArray[59]='H500'//H500 -> Formless
//	set RangeHeroesArray[60]='N0MD'//N0MD -> Oracle
//	set RangeHeroesArray[61]='KODO'//KODO -> Chakk
//	set RangeHeroesArray[62]='H501'//H501 -> Sieger
//	set RangeHeroesArray[63]='H502'//H502 -> Sorceress
//	set RangeHeroesArray[64]='H507'//H507 -> Talon Queen
//	set RangeHeroesArray[65]='H506'//H506 -> Fire Lord
//	set RangeHeroesAmount=65
//	set MeleeHeroesArray[1]='Hmkg'//Hmkg -> Ogre Magi
//	set MeleeHeroesArray[2]='H00N'//H00N -> Dark Seer
//	set MeleeHeroesArray[3]='Edem'//Edem -> Anti-Mage
//	set MeleeHeroesArray[4]='Nbbc'//Nbbc -> Juggernaut
//	set MeleeHeroesArray[5]='Naka'//Naka -> Bounty Hunter
//	set MeleeHeroesArray[6]='HC49'//HC49 -> Naga Siren
//	set MeleeHeroesArray[7]='Huth'//Huth -> Ursa Warrior
//	set MeleeHeroesArray[8]='Ogrh'//Ogrh -> Phantom Lancer
//	set MeleeHeroesArray[9]='U006'//U006 -> Broodmother
//	set MeleeHeroesArray[10]='Eevi'//Eevi -> Soul Keeper
//	set MeleeHeroesArray[11]='Hvsh'//Hvsh -> Bloodseeker
//	set MeleeHeroesArray[12]='EC45'//EC45 -> Faceless Void
//	set MeleeHeroesArray[13]='Ewar'//Ewar -> Phantom Assassin
//	set MeleeHeroesArray[14]='U000'//U000 -> Nerubian Assassin
//	set MeleeHeroesArray[15]='E01B'//E01B -> Spectre
//	set MeleeHeroesArray[16]='H00I'//H00I -> Geomancer
//	set MeleeHeroesArray[17]='HC92'//HC92 -> Stealth Assassin
//	set MeleeHeroesArray[18]='Npbm'//Npbm -> Pandaren Brewmaster
//	set MeleeHeroesArray[19]='Hlgr'//Hlgr -> Dragon Knight
//	set MeleeHeroesArray[20]='Harf'//Harf -> Omniknight
//	set MeleeHeroesArray[21]='H000'//H000 -> Centaur Warchief
//	set MeleeHeroesArray[22]='H001'//H001 -> Rogue Knight
//	set MeleeHeroesArray[23]='Hamg'//Hamg -> Treant Protector
//	set MeleeHeroesArray[24]='H008'//H008 -> Bristleback
//	set MeleeHeroesArray[25]='Ucrl'//Ucrl -> Stone Giant
//	set MeleeHeroesArray[26]='Otch'//Otch -> Earthshaker
//	set MeleeHeroesArray[27]='NC00'//NC00 -> Skeleton King
//	set MeleeHeroesArray[28]='Udre'//Udre -> Night Stalker
//	set MeleeHeroesArray[29]='UC11'//UC11 -> Magnataur
//	set MeleeHeroesArray[30]='Ofar'//Ofar -> Tidehunter
//	set MeleeHeroesArray[31]='U00F'//U00F -> Butcher
//	set MeleeHeroesArray[32]='U00K'//U00K -> Sand King
//	set MeleeHeroesArray[33]='O00J'//O00J -> Spiritbreaker
//	set MeleeHeroesArray[34]='Udea'//Udea -> Lord of Avernus
//	set MeleeHeroesArray[35]='Opgh'//Opgh -> Axe
//	set MeleeHeroesArray[36]='U00A'//U00A -> Chaos Knight
//	set MeleeHeroesArray[37]='U00C'//U00C -> Lifestealer
//	set MeleeHeroesArray[38]='UC91'//UC91 -> Slithereen Guard
//	set MeleeHeroesArray[39]='UC42'//UC42 -> Doom Bringer
//	set MeleeHeroesArray[40]='U008'//U008 -> Lycanthrope
//	set MeleeHeroesArray[41]='H00D'//H00D -> Beastmaster
//	set MeleeHeroesArray[42]='N01I'//N01I -> Alchemist
//	set MeleeHeroesArray[43]='N00R'//N00R -> Pit Lord
//	set MeleeHeroesArray[44]='H00T'//H00T -> Clockwerk Goblin
//	set MeleeHeroesArray[45]='H06S'//H06S -> Admiral
//	set MeleeHeroesArray[46]='H00R'//H00R -> Undying
//	set MeleeHeroesArray[47]='O015'//O015 -> Tauren Chieftain
//	set MeleeHeroesArray[48]='H071'//H071 -> Murloc Nightcrawler
//	set MeleeHeroesArray[49]='E02I'//E02I -> Tuskarr
//	set MeleeHeroesArray[50]='N0M0'//N0M0 -> Ember Spirit
//	set MeleeHeroesArray[51]='E032'//E032 -> Goblin Shredder
//	set MeleeHeroesArray[52]='E02K'//E02K -> Legion Commander
//	set MeleeHeroesArray[53]='N0MU'//N0MU -> Earth Spirit
//	set MeleeHeroesArray[54]='H504'//H504 -> Space Orc
//	set MeleeHeroesArray[55]='H505'//H505 -> Ogre Lord
//
//	set MeleeHeroesArray[56]='H503'//H503 -> Utility Lobster
//	set MeleeHeroesAmount=56
	
	call SaveUnitWinAnimation('esen',"stand 4")//esen -> Treant
	call SaveUnitWinAnimation('e00V',"stand 4")//e00V -> Treant
	call SaveUnitWinAnimation('edry',"spell")//edry -> Druid of the Talon
	call SaveUnitWinAnimation('e00W',"spell")//e00W -> Druid of the Talon
	call SaveUnitWinAnimation('ugho',"stand victory")//ugho -> Ghoul
	call SaveUnitWinAnimation('u001',"stand victory")//u001 -> Ghoul
	call SaveUnitWinAnimation('unec',"stand channel")//unec -> Necromancer
	call SaveUnitWinAnimation('u002',"stand channel")//u002 -> Necromancer
	call SaveUnitModelScale('n00M',.4,'n00M')//n00M -> Mini Pudge, n00M -> Mini Pudge
	call SaveUnitModelScale('e02R',.5,'e02R')//e02R -> Goblin Zeppelin, e02R -> Goblin Zeppelin
	call SaveUnitModelScale('e02T',1.2,'e02T')//e02T -> Snow Owl, e02T -> Snow Owl
	call SaveUnitModelScale('e02S',.5,'e02S')//e02S -> Mini Viper, e02S -> Mini Viper
	call SaveUnitModelScale('e030',.5,'e030')//e030 -> Frost Wyrm, e030 -> Frost Wyrm
	call SaveUnitModelScale('n0LS',1,'n0LS')//n0LS -> Grunt, n0LS -> Grunt
	call SaveUnitModelScale('np01',1,'np01')//np01 -> couatl
	
	call VX8()
endfunction

function AddSomethingToPurgeList takes nothing returns nothing
	call AddToPurgeList('A3K2',PURGEDEBUFFID)//desolator
	call AddToPurgeList('A3K3',PURGEDEBUFFID)//desolator
	call AddToPurgeList('BIcb',PURGEDEBUFFID)//desolator//BIcb -> Stygian Desolator
	call AddToPurgeList('A2EC',PURGEDEBUFFID)//rod of atos
	call AddToPurgeList('B0F5',PURGEDEBUFFID)//rod of atos slow//B0F5 -> Cripple
	
	call AddToPurgeList('B08N',PURGEDEBUFFID)//maim slow//B08N -> Maimed
	call AddToPurgeList('B02I',PURGEDEBUFFID)//maim slow//B02I -> Maimed
	
	call AddToPurgeList('A3FL',PURGEBUFFID)//dd
	call AddToPurgeList('B01P',PURGEBUFFID)//B01P -> |c00ff0000Double Damage|r
endfunction

function InitDispellableBuffsList takes nothing returns nothing
	call AddSomethingToPurgeList()
	
	call AddDispellableBuff('BPSE')//BPSE -> Stunned
	call AddDispellableBuff('BSTN')//BSTN -> Stunned
	call AddDispellableBuff('B0BM')//B0BM -> Echo Stomp
	call AddDispellableBuff('B0CF')//B0CF -> Cold Feet
	call AddDispellableBuff('B07N')//B07N -> Ministun
	call AddDispellableBuff('B00Q')//B00Q -> Stunned
	call AddDispellableBuff('B095')//B095 -> Stunned
	call AddDispellableBuff('B0C2')//B0C2 -> Stunned
	call AddDispellableBuff('B02S')//B02S -> Reaper's Scythe
	call AddDispellableBuff('B02F')//B02F -> Nightmare
	call AddDispellableBuff('BUsp')
	call AddDispellableBuff('Bust')
	call AddDispellableBuff('B0AQ')//B0AQ -> Venomous Gale
	call AddDispellableBuff('BUan')//BUan -> Malefice
	call AddDispellableBuff('B0GG')//B0GG -> Stunned
	
	call AddToPurgeList('C010',PURGEDEBUFFID)
	call AddToPurgeList('D010',PURGEDEBUFFID)
	
	call AddToPurgeList('A45O',PURGEDEBUFFID)//phoenix spirits
	call AddToPurgeList('A45P',PURGEDEBUFFID)
	call AddToPurgeList('A45Q',PURGEDEBUFFID)
	call AddToPurgeList('A45R',PURGEDEBUFFID)
	
	call AddToPurgeList('A44Y',PURGECOMMONID)//Bloodrage new
	call AddToPurgeList('B44Y',PURGECOMMONID)
	
	call AddToPurgeList('A45Y',PURGESLOW)//arrow shower
	call AddToPurgeList('A45Z',PURGESLOW)
	call AddToPurgeList('B45Y',PURGESLOW)
	
	call AddToPurgeList('A32F',PURGESLOW)//Digest slow
	call AddToPurgeList('B32F',PURGESLOW)
	
	call AddToPurgeList('A3A0',PURGESLOW)
	call AddToPurgeList('A3A1',PURGESLOW)
	call AddToPurgeList('A3A2',PURGESLOW)
	call AddToPurgeList('A3A3',PURGESLOW)
	call AddToPurgeList('A3A4',PURGESLOW)
	call AddToPurgeList('A3A5',PURGESLOW)
	call AddToPurgeList('A3A6',PURGESLOW)
	call AddToPurgeList('A3A7',PURGESLOW)
	call AddToPurgeList('B079',PURGESLOW)
	
	call AddToPurgeList('C016',PURGESLOW)//reflection
	call AddToPurgeList('D016',PURGESLOW)
	
	call AddToPurgeList('B09Q',PURGESLOW)//torrent
	call AddToPurgeList('B06Q',PURGESLOW)//primal roar clap
	call AddToPurgeList('C000',PURGEBUFFID)//aphotic shield
	call AddToPurgeList('D000',PURGEBUFFID)//aphotic shield
	
	call AddToPurgeList('C108',PURGEBUFFID)//frostmourn buff
	call AddToPurgeList('C109',PURGEBUFFID)//frostmourn buff
	call AddToPurgeList('C10:',PURGEBUFFID)//frostmourn buff
	call AddToPurgeList('C10;',PURGEBUFFID)//frostmourn buff
	call AddToPurgeList('D105',PURGEBUFFID)
	
	call AddToPurgeList('A2IB',PURGEBUFFID)//culling blade
	call AddToPurgeList('B0FV',PURGEBUFFID)
	
	call AddToPurgeList('A44Y',PURGECOMMONID)//bloodrage new
	call AddToPurgeList('B44Y',PURGECOMMONID)
	
	call AddToPurgeList('A0WR',PURGEBUFFID)//brood hunger
	call AddToPurgeList('B01E',PURGEBUFFID)
	
	call AddToPurgeList('A3K9',PURGEBUFFID)//CK reality rift dmg bonus
	
	call AddToPurgeList('A3KA',PURGEBUFFID)//chen's tp
	
	call AddToPurgeList('B00S',PURGEBUFFID)//clinkz strafe
	
	call AddToPurgeList('A3KB',PURGEBUFFID)//surge
	call AddToPurgeList('B07W',PURGEBUFFID)
	
	call AddToPurgeList('Broa',PURGEBUFFID)//enchant totem
	
	call AddToPurgeList('A3DU',PURGEBUFFID)//chakra magic
	call AddToPurgeList('A3DV',PURGEBUFFID)//chakra magic
	call AddToPurgeList('A3DW',PURGEBUFFID)//chakra magic
	call AddToPurgeList('A3DX',PURGEBUFFID)//chakra magic
	call AddToPurgeList('B3DU',PURGEBUFFID)//chakra magic
	
	call AddToPurgeList('C020',PURGEBUFFID)//overwhelming odds
	call AddToPurgeList('D020',PURGEBUFFID)
	
	call AddToPurgeList('B0H6',PURGEBUFFID)//frost armor
	
	call AddToPurgeList('B016',PURGEBUFFID)//rabid
	
	call AddToPurgeList('B019',PURGEBUFFID)//battle cry
	
	call AddToPurgeList('B00U',PURGEBUFFID)//empower
	call AddToPurgeList('A1Q0',PURGEBUFFID)
	call AddToPurgeList('A1Q1',PURGEBUFFID)
	call AddToPurgeList('A1Q2',PURGEBUFFID)
	call AddToPurgeList('A1Q3',PURGEBUFFID)
	
	call AddToPurgeList('C033',PURGEDEBUFFIDHIGH)//halberd
	call AddToPurgeList('D033',PURGEDEBUFFIDHIGH)
	call AddToPurgeList('A3KC',PURGEDEBUFFIDHIGH)
	
	call AddToPurgeList('A3KE',PURGEDEBUFFID)//fate's edict disarm
	call AddToPurgeList('B3KE',PURGEDEBUFFID)//fate's edict disarm
	call AddToPurgeList('A3KD',PURGEDEBUFFID)//fate's edict disarm
	call AddToPurgeList('A2T4',PURGEDEBUFFID)//fate's edict disarm
	
	call AddToPurgeList('A1CO',PURGEBUFFID)//PA blink AS
	call AddToPurgeList('B1CO',PURGEBUFFID)
	
	call AddToPurgeList('A46F',PURGEBUFFID)//Phantom Rush
	call AddToPurgeList('B46F',PURGEBUFFID)
	
	call AddToPurgeList('B01N',PURGECOMMONID)//decrepify
	call AddToPurgeList('A30D',PURGECOMMONID)//decrepify
	call AddToPurgeList('A44I',PURGECOMMONID)//decrepify
	call AddToPurgeList('A30E',PURGECOMMONID)//decrepify
	call AddToPurgeList('A3C0',PURGECOMMONID)//decrepify
	call AddToPurgeList('A3C1',PURGECOMMONID)//decrepify
	call AddToPurgeList('A3C2',PURGECOMMONID)//decrepify
	call AddToPurgeList('A3C3',PURGECOMMONID)//decrepify
	call AddToPurgeList('B38G',PURGECOMMONID)//decrepify
	
	call AddToPurgeList('A24G',PURGEBUFFID)//greater bash
	call AddToPurgeList('B0EC',PURGEBUFFID)
	
	call AddToPurgeList('A23N',PURGEBUFFID)//nature's guise
	call AddToPurgeList('B0E9',PURGEBUFFID)
	call AddToPurgeList('A1GA',PURGEBUFFID)
	call AddToPurgeList('B021',PURGEBUFFID)
	
	call AddToPurgeList('A3KF',PURGEBUFFID)//living armor
	call AddToPurgeList('B3KF',PURGEBUFFID)
	
	call AddToPurgeList('A1N3',PURGEBUFFID)//overpower
	call AddToPurgeList('A1N7',PURGEBUFFID)
	call AddToPurgeList('B0CH',PURGEBUFFID)
	
	call AddToPurgeList('B02H',PURGEBUFFID)//Enrage
	
	call AddToPurgeList('A1ZY',PURGEBUFFID)//janggo endurance
	call AddToPurgeList('B0DX',PURGEBUFFID)
	
	call AddToPurgeList('B0CG',PURGEBUFFID)//urn of shadows ally
	
	call AddToPurgeList('Bcyc',PURGEBUFFID)//euls tornados
	call AddToPurgeList('Bcy2',PURGEBUFFID)
	
	call AddToPurgeList('Aetl',PURGEBUFFID)//Ethereal
	
	call AddToPurgeList('A42L',PURGEBUFFID)//Crimson
	call AddToPurgeList('A42N',PURGEBUFFID)
	call AddToPurgeList('B0HG',PURGEBUFFID)
	
	call AddToPurgeList('B07S',PURGEBUFFID)//berserk
	
	call AddToPurgeList('A3KI',PURGEBUFFID)//static charge
	call AddToPurgeList('B3KI',PURGEBUFFID)
	
	call AddToPurgeList('B06Z',PURGESLOW)//B06Z -> Poison quillbeast
	call AddToPurgeList('B08Q',PURGESLOW)//B08Q -> Arctic Blast
	call AddToPurgeList('B031',PURGESILENCE)//B031 -> Orchid Malevolence
	call AddToPurgeList('B0C1',PURGEENTANGLE)//B0C1 -> Entangling Roots
	call AddToPurgeList('BEer',PURGEENTANGLE)//BEer -> Entangling Roots
	call AddToPurgeList('BHca',PURGESLOW)//BHca -> Cold Arrows
	call AddToPurgeList('Bcsd',PURGESLOW)//Bcsd -> Cold Arrows
	call AddToPurgeList('B0BQ',PURGESLOW)//B0BQ -> Stone Gaze
	call AddToPurgeList('Bprg',PURGESLOW)//Bprg -> Purge
	call AddToPurgeList('Bcri',PURGESLOW)//Bcri -> Grave Chill
	call AddToPurgeList('B090',PURGEDEBUFFID)//Aerial Shackles
	call AddToPurgeList('B008',PURGEDEBUFFID)//B008 -> Shackles
	call AddToPurgeList('B04B',PURGEDEBUFFID)//B04B -> Fiend's Grip
	call AddToPurgeList('B03J',PURGESLOW)//B03J -> Ignite
	call AddToPurgeList('Bslo',PURGESLOW)//Bslo -> Enchant
	call AddToPurgeList('BNdh',PURGESLOW)//BNdh -> Drunken Haze
	call AddToPurgeList('B07U',PURGESILENCE)//B07U -> Silence
	call AddToPurgeList('BNsi',PURGESILENCE)//BNsi -> Silence
	call AddToPurgeList('BNso',PURGESILENCE)//BNso -> Soul Burn
	call AddToPurgeList('B01N',PURGEDEBUFFID)//B01N -> Decrepify
	call AddToPurgeList('B033',PURGEDEBUFFID)//B033 -> Deafening Blast
	call AddToPurgeList('Bpoi',PURGESLOW)//Bpoi -> Poison
	call AddToPurgeList('B00H',PURGEDEBUFFID)//Hex
	call AddToPurgeList('BOhx',PURGEDEBUFFID)//BOhx -> Hex
	call AddToPurgeList('A3B8',PURGEDEBUFFID)//A3B8 -> Parasite
	call AddToPurgeList('B3B8',PURGEDEBUFFID)//B3B8 -> Parasite
	call AddToPurgeList('B06D',PURGESLOW)//B06D -> Poison
	call AddToPurgeList('B0BN',PURGESLOW)//B0BN -> Unstable Current
	call AddToPurgeList('B071',PURGESLOW)//B071 -> Upheaval
	call AddToPurgeList('B02W',PURGEDEBUFFID)//B02W -> Terror
	
	call AddToPurgeList('A294',PURGESLOW)//A294 -> Time Walk
	call AddToPurgeList('A295',PURGESLOW)
	call AddToPurgeList('A296',PURGESLOW)
	call AddToPurgeList('A297',PURGESLOW)
	call AddToPurgeList('B05Q',PURGESLOW)
	call AddToPurgeList('B0GT',PURGESLOW)//B0GT -> Fortune's End
	call AddToPurgeList('A37T',PURGEDEBUFFID)
	call AddToPurgeList('B37T',PURGEDEBUFFID)//B37T -> Flamebreak
	call AddToPurgeList('QH00',PURGESLOW)//QH00 -> Frostmourne FX
	call AddToPurgeList('A1W2',PURGESLOW)//battle hunger
	call AddToPurgeList('B0DO',PURGESLOW)
	call AddToPurgeList('A42R',PURGEDEBUFFID)//Meteor
	call AddToPurgeList('B0HI',PURGEDEBUFFID)//Meteor
	//call AddToPurgeList('A311',PURGEDEBUFFID)//Track 
	call AddToPurgeList('B00L',PURGEDEBUFFID)//B00L -> Track
	call AddToPurgeList('A30Y',PURGEDEBUFFID)//A30Y -> Amplify Damage FX
	call AddToPurgeList('B307',PURGEDEBUFFID)//B307 -> Liquid Fire
	call AddToPurgeList('A334',PURGESLOW)
	call AddToPurgeList('B083',PURGESLOW)//B083 -> Life Break
	
	call AddToPurgeList('B079',PURGESLOW)//B079 -> Geostrike
	call AddToPurgeList('A335',PURGESLOW)//Overload
	call AddToPurgeList('B08B',PURGESLOW)//B08B -> Overload
	
	call AddToPurgeList('B0GR',PURGEDEBUFFID)//B0GR -> Dust of Appearance
	call AddToPurgeList('Bdet',PURGEDEBUFFID)//Bdet -> Dust of Appearance
	call AddToPurgeList('B0GK',PURGESLOW)//B0GK -> Boulder Smash Slow
	call AddToPurgeList('B06Q',PURGESLOW)//B06Q -> Beast Roar
	call AddToPurgeList('BHtc',PURGESLOW)//BHtc -> Thunder Clap
	call AddToPurgeList('B0BR',PURGESLOW)//B0BR -> Earthsplitter
	call AddToPurgeList('A37U',PURGESLOW)//A37U -> Viscous Nasal Goo
	call AddToPurgeList('A37V',PURGESLOW)
	call AddToPurgeList('A37W',PURGESLOW)
	call AddToPurgeList('A37X',PURGESLOW)
	call AddToPurgeList('A3F0'+0,PURGESLOW)
	call AddToPurgeList('A3F0'+1,PURGESLOW)
	call AddToPurgeList('A3F0'+2,PURGESLOW)
	call AddToPurgeList('A3F0'+3,PURGESLOW)
	call AddToPurgeList('A3F0'+4,PURGESLOW)
	call AddToPurgeList('A3F0'+5,PURGESLOW)
	call AddToPurgeList('A3F0'+6,PURGESLOW)
	call AddToPurgeList('A3F0'+7,PURGESLOW)
	call AddToPurgeList('A3F0'+8,PURGESLOW)
	call AddToPurgeList('A3F0'+9,PURGESLOW)
	call AddToPurgeList('A3F0'+10,PURGESLOW)
	call AddToPurgeList('A3F0'+11,PURGESLOW)
	call AddToPurgeList('A3F0'+12,PURGESLOW)
	call AddToPurgeList('A3F0'+13,PURGESLOW)
	call AddToPurgeList('A3F0'+14,PURGESLOW)
	call AddToPurgeList('A3F0'+15,PURGESLOW)
	
	
	call AddToPurgeList('A3EO'+0,PURGESLOW)//crystal nova
	call AddToPurgeList('A3EO'+1,PURGESLOW)
	call AddToPurgeList('A3EO'+2,PURGESLOW)
	call AddToPurgeList('A3EO'+3,PURGESLOW)
	call AddToPurgeList('B386',PURGESLOW)
	
	call AddToPurgeList('A3EK',PURGEDEBUFFID)//untouchable
	call AddToPurgeList('A3EL',PURGEDEBUFFID)
	call AddToPurgeList('A3EM',PURGEDEBUFFID)
	call AddToPurgeList('A3EN',PURGEDEBUFFID)
	call AddToPurgeList('B38B',PURGEDEBUFFID)
	
	
	
	call AddToPurgeList('B37Y',PURGESLOW)
	call AddToPurgeList('B07E',PURGESLOW)//B07E -> Poison Touch
	call AddToPurgeList('B02V',PURGESLOW)//B02V -> Epicenter
	call AddToPurgeList('BNab',PURGESLOW)//BNab -> Gush
	call AddToPurgeList('B03I',PURGEDEBUFFID)//B03I -> Dismember
	call AddToPurgeList('B063',PURGESLOW)//B063 -> Slithereen Crush
	call AddToPurgeList('B03C',PURGESLOW)//B03C -> Spirit Lance
	call AddToPurgeList('B08M',PURGESLOW)//B08M -> Psionic Trap
	call AddToPurgeList('B02G',PURGESLOW)//B02G -> Earthshock
	call AddToPurgeList('B01D',PURGESLOW)//B01D -> Incapacitating Bite
	call AddToPurgeList('B092',PURGESLOW)//B092 -> Stifling Dagger
	call AddToPurgeList('BEsh',PURGESLOW)//BEsh -> Shadow Strike
	call AddToPurgeList('B017',PURGEENTANGLE)//B017 -> Frostbite
	call AddToPurgeList('B0AE',PURGEDEBUFFID)
	call AddToPurgeList('B0AD',PURGEDEBUFFID)//B0AD -> Electric Vortex
	call AddToPurgeList('B08O',PURGEDEBUFFID)//B08O -> Silence
	call AddToPurgeList('Bfro',PURGESLOW)//Bfro -> Slowed
	call AddToPurgeList('B05H',PURGESLOW)//B05H -> Penitence
	call AddToPurgeList('A3QU',PURGESLOW)//
	call AddToPurgeList('A3QV',PURGESLOW)//
	call AddToPurgeList('A3QW',PURGESLOW)//
	call AddToPurgeList('A3QX',PURGESLOW)//
	
	call AddToPurgeList('B0BS',PURGESLOW)//B0BS -> Sticky Napalm
	call AddToPurgeList('B0BF',PURGEDEBUFFID)
	call AddToPurgeList('B0BE',PURGEDEBUFFID)//B0BE -> Flaming Lasso
	call AddToPurgeList('B0CC',PURGEDEBUFFID)//B0CC -> Cold Feet
	call AddToPurgeList('B078',PURGEENTANGLE)//B078 -> Earthbind
	call AddToPurgeList('B00T',PURGEDEBUFFID)//B00T -> Amplify Damage
	call AddToPurgeList('B07V',PURGESILENCE)//B07V -> Silence
	call AddToPurgeList('B00P',PURGESLOW)//B00P -> Void
	call AddToPurgeList('B02M',PURGESILENCE)//B02M -> Crippling Fear
	call AddToPurgeList('B043',PURGESLOW)//B043 -> Untouchable
	call AddToPurgeList('B04Q',PURGESLOW)//B04Q -> Requiem of Souls 
	call AddToPurgeList('B00C',PURGEDEBUFFID)//B00C -> Whirling Axes
	call AddToPurgeList('B09K',PURGEDEBUFFID)//B09K -> Blinding Light
	call AddToPurgeList('B08F',PURGEENTANGLE)//B08F -> Pit of Malice
	call AddToPurgeList('B08E',PURGEENTANGLE)//B08E -> Pit of Malice
	call AddToPurgeList('B0AM',PURGESLOW)//B0AM -> Deathstrike
	call AddToPurgeList('C009',PURGEDEBUFFID)//C009 -> Firestorm
	call AddToPurgeList('D009',PURGEDEBUFFID)//D009 -> Firestorm
	
	call AddToPurgeList('B38I',PURGESLOW)//B38I -> Caustic Finale Slow
	call AddToPurgeList('B09Q',PURGESLOW)//B09Q -> Torrent
	call AddToPurgeList('B0DI',PURGESLOW)//B0DI -> Spirits
	call AddToPurgeList('B0BB',PURGESLOW)//B0BB -> Shrapnel
	call AddToPurgeList('B0AF',PURGEDEBUFFID)//B0AF -> Electric Vortex
	call AddToPurgeList('B08N',PURGESLOW)//B08N -> Maimed
	call AddToPurgeList('B02I',PURGESLOW)//B02I -> Maimed
	call AddToPurgeList('B0BY',PURGESILENCE)//B0BY -> Infestation
	call AddToPurgeList('B02P',PURGEDEBUFFID)//B02P -> Blinded
	call AddToPurgeList('B0EP',PURGESLOW)//B0EP -> Reincarnation
	call AddToPurgeList('B0ER',PURGEENTANGLE)//B0ER -> Overgrowth
	call AddToPurgeList('B0ET',PURGESLOW)//B0ET -> Whirling Axes
	call AddToPurgeList('B0FN',PURGEENTANGLE)//B0FN -> Searing Chains
	call AddToPurgeList('B0FY',PURGESLOW)//B0FY -> Concussive Shot
	call AddToPurgeList('B0FT',PURGESILENCE)//B0FT -> Ancient Seal
	call AddToPurgeList('B0G0',PURGESILENCE)//B0G0 -> Chakram
	
	call AddToPurgeList('Bena',PURGEENTANGLE)//Bena -> Ensnare
	call AddToPurgeList('Beng',PURGEENTANGLE)//Beng -> Ensnare
	call AddToPurgeList('A39F',PURGEDEBUFFID)//solar crest debuff
	call AddToPurgeList('Aetl',PURGECOMMONID)//Aetl -> Ethereal
	
	call AddToPurgeList('A3QU',PURGEDEBUFFID)//penitence
	call AddToPurgeList('A3QV',PURGEDEBUFFID)//penitence
	call AddToPurgeList('A3QW',PURGEDEBUFFID)//penitence
	call AddToPurgeList('A3QX',PURGEDEBUFFID)//penitence
	
	call AddToPurgeList('A3Q2',PURGEDEBUFFID)//whirling axes
	
	call AddToPurgeList('A3Q1',PURGEDEBUFFID)//radiance
	call AddToPurgeList('B3DJ',PURGEDEBUFFID)//radiance
	
	call AddToPurgeList('A3Q0',PURGEDEBUFFID)//laser
	call AddToPurgeList('A3PZ',PURGEDEBUFFID)//bliding light
	
	call AddToPurgeList('A3PV',PURGEDEBUFFID)//incap bite
	call AddToPurgeList('A3PW',PURGEDEBUFFID)//incap bite
	call AddToPurgeList('A3PX',PURGEDEBUFFID)//incap bite
	call AddToPurgeList('A3PY',PURGEDEBUFFID)//incap bite
	
	call AddToPurgeList('A3PR',PURGEDEBUFFID)//drunken haze
	call AddToPurgeList('A3PS',PURGEDEBUFFID)//drunken haze
	call AddToPurgeList('A3PT',PURGEDEBUFFID)//drunken haze
	call AddToPurgeList('A3PU',PURGEDEBUFFID)//drunken haze
	
	
	
	
	
	call AddToPurgeList('A1HN',PURGEBUFFID)//Chlling touch//A1HN -> Chilling Touch buff
	call AddToPurgeList('B0CJ',PURGEBUFFID)//B0CJ -> Chilling Touch
	call AddToPurgeList('A0QO',PURGEBUFFID)//inner vitality//A0QO -> Inner Vitality
	call AddToPurgeList('B080',PURGEBUFFID)//B080 -> |cff00ff00Inner Vitality|r
	call AddToPurgeList('A0VJ',PURGEBUFFID)//alacrity//A0VJ -> Invoke 1
	call AddToPurgeList('A109',PURGEBUFFID)//A109 -> Alacrity Damage Bonus
	call AddToPurgeList('A0P0',PURGEBUFFID)//shadow word ally//A0P0 -> Shadow Word
	call AddToPurgeList('B073',PURGEBUFFID)//B073 -> |cff00ff00Shadow Word|r
	call AddToPurgeList('C025',PURGEBUFFID)//warcry
	call AddToPurgeList('D025',PURGEBUFFID)//D025 -> |cff32cd32Warcry|r
	call AddToPurgeList('A2J4',PURGEBUFFID)//Press the attack
	
	call AddToPurgeList('A42Q',PURGEDEBUFFID)//Thunder strike
	call AddToPurgeList('B0HH',PURGEDEBUFFID)//B0HH -> Thunder Strike
	call AddToPurgeList('A17K',PURGEDEBUFFID)//shadow word enemy//A17K -> Shadow Word
	call AddToPurgeList('B0AP',PURGEDEBUFFID)//B0AP -> Shadow Word
	call AddToPurgeList('B307',PURGEDEBUFFID)//Liquid fire//B307 -> Liquid Fire
	call AddToPurgeList('A10Z',PURGEDEBUFFID)//mana leaks!!!//A10Z -> Mana Leak buff
	call AddToPurgeList('A111',PURGEDEBUFFID)//A111 -> Mana Leak buff
	call AddToPurgeList('A10Y',PURGEDEBUFFID)//A10Y -> Mana Leak buff
	call AddToPurgeList('A110',PURGEDEBUFFID)//A110 -> Mana Leak buff
	call AddToPurgeList('B09M',PURGEDEBUFFID)//B09M -> |cffff0000Mana Leak|r|n|cff4F4F4FLevel:|r 1
	call AddToPurgeList('B09N',PURGEDEBUFFID)//B09N -> |cffff0000Mana Leak|r|n|cff4F4F4FLevel:|r 2
	call AddToPurgeList('B09O',PURGEDEBUFFID)//B09O -> |cffff0000Mana Leak|r|n|cff4F4F4FLevel:|r 3
	call AddToPurgeList('B09L',PURGEDEBUFFID)//B09L -> |cffff0000Mana Leak|r|n|cff4F4F4FLevel:|r 4
	call AddToPurgeList('A1PS',PURGESLOW)//curse of the silence//A1PS -> Curse of the Silent
	call AddToPurgeList('B0CQ',PURGESLOW)//B0CQ -> Curse of the Silent
	call AddToPurgeList('A0OW',PURGESLOW)//poison touch
	call AddToPurgeList('A42S',PURGEDEBUFFID)//whirling death
	call AddToPurgeList('B0HJ',PURGEDEBUFFID)//B0HJ -> Whirling Death
	call AddToPurgeList('A204',PURGESLOW)//walrus punch slow
	call AddToPurgeList('B0DY',PURGESLOW)//B0DY -> Walrus Punch
	
	call AddToPurgeList('A30B',PURGESLOW)
	call AddToPurgeList('B30A',PURGESLOW)
	call AddToPurgeList('A304',PURGESLOW)//Tether
	call AddToPurgeList('B304',PURGESLOW)
	call AddToPurgeList('A0RC',PURGEDEBUFFID)//Templar Assassin's Meld armor
	call AddToPurgeList('A228',PURGEDEBUFFID)//A228 -> Anchor Smash Container
	call AddToPurgeList('B0E8',PURGEDEBUFFID)//A228 -> Anchor Smash Container
	call AddToPurgeList('A264',PURGEDEBUFFID)//Sange maim
	call AddToPurgeList('B02I',PURGEDEBUFFID)//maim
	call AddToPurgeList('A263',PURGEDEBUFFID)//S&Y
	call AddToPurgeList('B08N',PURGEDEBUFFID)//maim
	
	
	call AddToPurgeList('Broa',PURGEBUFFID)//Broa -> Enchant Totem
	call AddToPurgeList('B014',PURGEBUFFID)//B014 -> Repel
	call AddToPurgeList('B00G',PURGEBUFFID)//B00G -> Guardian Angel
	call AddToPurgeList('B016',PURGEBUFFID)//B016 -> Rabid
	call AddToPurgeList('B077',PURGEBUFFID)//B077 -> Frostsaber's Roar
	call AddToPurgeList('B0FP',PURGEBUFFID)//B0FP -> Flame Guard
	call AddToPurgeList('B0FQ',PURGEBUFFID)//B0FQ -> Flame Guard
	call AddToPurgeList('Bblo',PURGEBUFFID)//Bblo -> Bloodlust
	call AddToPurgeList('B013',PURGEBUFFID)//B013 -> Sprint
	call AddToPurgeList('A308',PURGEBUFFID)//frost armor
	call AddToPurgeList('B308',PURGEBUFFID)
endfunction

function PreloadingSkills_Viper takes nothing returns nothing
	call AddWrapper("ViperWrappers",-2)
endfunction

function PreloadingSkills_Tidehunter takes nothing returns nothing
	call AddWrapper("KrakenShellWrapper",-1)
endfunction

function PreloadingSkills_Lanaya takes nothing returns nothing
	call AddWrapper("LanayaBladesWrapper",-1)
endfunction

function PreloadingSkills_Axe takes nothing returns nothing
	call AddWrapper("AxeWrappers",-1)
endfunction

function PreloadingSkills_Riki takes nothing returns nothing
	call AddWrapper("RikiBackStabWrapper",-1)
endfunction

function PreloadingSkills_Wyvern takes nothing returns nothing
	call AddWrapper("WyvernWrapper",-2)
endfunction

function PreloadingSkills_Treant takes nothing returns nothing
	call AddWrapper("TreantInvisWrapper",-1)
endfunction

function PreloadingSkills_Lich takes nothing returns nothing
	call AddWrapper("LichFromArmorWrapper",0)
endfunction

function PreloadingSkills_Leoric takes nothing returns nothing
	call AddWrapper("LeoricLifestealWrapper",0)
	set HeroLeoricExists=true
endfunction

function PreloadingSkills_Void takes nothing returns nothing
	call AddWrapper("VoidBashWrapper",1)
	call ExecuteFunc("Preload_CalculatePossibleBashes")
endfunction

function PreloadingSkills_FireLord takes nothing returns nothing
	call AddWrapper("FireLord_FireshowRangedWrapper",3)
endfunction

function PreloadingSkills_Troll takes nothing returns nothing
	call AddWrapper("TrollWrapper",-2)
endfunction

function PreloadingSkills_Luna takes nothing returns nothing
	call AddWrapper("LunaGlaiveWrapper",0)
endfunction

function PreloadingSkills_Geomancer takes nothing returns nothing
	call AddWrapper("GeoStrikeWrapper",4)
endfunction

function PreloadingSkills_Huskar takes nothing returns nothing
	call AddWrapper("HuskarArrowsWrapper",4)
	call AddWrapper("HuskarBurningSpearsWrapperInit",-2)
endfunction

function PreloadingSkills_SpaceOrc takes nothing returns nothing
	call AddWrapper("OldMarksmanshipWrapper",3)
endfunction

function PreloadingSkills_SK takes nothing returns nothing
	call AddWrapper("CausticFinalWrapper",2)
endfunction

function PreloadingSkills_Spectre takes nothing returns nothing
	call AddWrapper("SpectreWrappers",-1)
	call AddWrapper("SpectreDesolateWrapper",3)
endfunction

function PreloadingSkills_OD takes nothing returns nothing
	call AddWrapper("ODOrbWrapper",3)
endfunction

function PreloadingSkills_Silencer takes nothing returns nothing
	call AddWrapper("SilencerOrbWrapper",3)
endfunction

function PreloadingSkills_Abaddon takes nothing returns nothing
	call AddWrapper("AbaFrostmourneWrapper",3)
	call AddWrapper("AbaFrostmourneWrapperOnAttack",-1)
endfunction

function PreloadingSkills_Bara takes nothing returns nothing
	call AddWrapper("BarabashWrapper",3)
endfunction

function PreloadingSkills_Slark takes nothing returns nothing
	call AddWrapper("SlarkEssenceShiftWrapper",3)
endfunction

function PreloadingSkills_Admiral takes nothing returns nothing
	call AddWrapper("TidebringerWrapper",1)
	call AddWrapper("TidebringerWrapperOnAttack",-2)
endfunction

function PreloadingSkills_Centaur takes nothing returns nothing
	call AddWrapper("CentaurReturnWrapper",0)
endfunction

function PreloadingSkills_DK takes nothing returns nothing
	call AddWrapper("ElderDragonCorrosiveWrapper",1)
endfunction

function PreloadingSkills_ES takes nothing returns nothing
	call AddWrapper("EnchantTotemWrapper",1)
	call AddWrapper("EnchantTotemWrapperOnAttack",-2)
endfunction

function PreloadingSkills_Ench takes nothing returns nothing
	call AddWrapper("Ench_Impetus_HitWrapper",3)
endfunction

function PreloadingSkills_PL takes nothing returns nothing
	call AddWrapper("PLOnAttackWrapper",0)
endfunction

function PreloadingSkills_LoneDruid takes nothing returns nothing
	call AddWrapper("SpiritBearDmgWrapper",3)
endfunction

function PreloadingSkills_Ursa2 takes nothing returns nothing
	call AddWrapper("UrsaOverpowerLanding",-2)
endfunction

function PreloadingSkills_Ursa takes nothing returns nothing
	call AddWrapper("UrsaSwipesWrapper",3)
endfunction

function PreloadingSkills_Bane takes nothing returns nothing
	call AddWrapper("BaneUltiWrapper",-1)
endfunction

function PreloadingSkills_Lifestealer takes nothing returns nothing
	call AddWrapper("LifestealerWrapper",3)
	call AddWrapper("LifestealerFeastWrapperOnAttack",-2)
endfunction

function PreloadingSkills_Veno takes nothing returns nothing
	call AddWrapper("PoisonStingWrapper",0)
endfunction

function PreloadingSkills_WL takes nothing returns nothing
	call AddWrapper("WLFlamingFistWrapper",0)
endfunction

function PreloadingSkills_Legion takes nothing returns nothing
	call AddWrapper("MoCWrapperAdvanced",1)
	call AddWrapper("MoCWrapperOnAttack",-2)
	call AddWrapper("MoCWrapperOnAttacked",-1)
endfunction

function PreloadingSkills_Timber takes nothing returns nothing
	call AddWrapper("ShredderWrapper",0)
endfunction

function PreloadingSkills_Sniper takes nothing returns nothing
	call AddWrapper("SniperHeadshotWrapper",2)
endfunction

function PreloadingSkills_Brood takes nothing returns nothing
	call AddWrapper("BroodPassiveWrapper",3)
endfunction

function PreloadingSkills_BroodHunger takes nothing returns nothing
	call ExecuteFunc("Preload_CalculatePossibleBashes")
	call AddWrapper("BroodHungerWrapper",3)
endfunction

function PreloadingSkills_Zombie takes nothing returns nothing
	call AddWrapper("ZombieTombstoneWrapper",0)
endfunction

function Earthshaker_Aftershock_ConditionWrapper takes nothing returns nothing
	call AddWrapperToSpell("Earthshaker_Aftershock_Condition_Worker")
endfunction

function Bristleback_Warpath_ConditionWrapper takes nothing returns nothing
	call AddWrapperToSpell("Bristleback_Warpath_Condition_Worker")
	call HideAbility('A30P')
endfunction

function Phoenix_Sunray_StopWrapper takes nothing returns nothing
	call AddWrapperToSpell("Phoenix_Sunray_Stop_Worker")
endfunction

function Silencer_LastWordPassive_CheckWrapper takes nothing returns nothing
	call AddWrapperToSpell("Silencer_LastWordPassive_Check_Worker")
endfunction

function Krobelus_Witchcraft_CheckWrapper takes nothing returns nothing
	call AddWrapperToSpell("Krobelus_Witchcraft_Check")
endfunction

function Zeus_StaticFieldWrapper takes nothing returns nothing
	call AddWrapperToSpell("Zeus_StaticField_Worker")
endfunction

function PreloadingSkills_AA takes nothing returns nothing
	call AddWrapper("ChillingTouchAttackFilter",3)
endfunction

function InitPreloadingSkills takes nothing returns nothing
	call SaveStr(MHT,'A060',601,"OnDeath_Sadist_ConditionWrapper")
	call SaveStr(MHT,'A0LE',601,"OnDeath_BS_BloodBathWrapper")
	call SaveStr(MHT,'A0O3',601,"OnDeath_Alchemist_Greed_ConditionWrapper")
	call SaveStr(MHT,'A1W8',601,"OnDeath_WrathOfNatureKillsWrapper")
	call SaveStr(MHT,'A0BH',601,"OnDeath_BroodSpideriteCheckWrapper")
	call SaveStr(MHT,'A0A5',601,"OnDeath_SpiritBear_DeathWrapper")
	call SaveStr(MHT,'A0RP',601,"OnDeath_Templar_Trap_Start_WrapWrapper")
	call SaveStr(MHT,'A0QV',601,"OnDeath_UndyingZombieWrapper")
	call SaveStr(MHT,'A0AK',601,"OnDeath_RemoteMineDeathWrapper")
	call SaveStr(MHT,'P003',601,"OnDeath_CommandAuraWrapper")
	call SaveStr(MHT,'A0LZ',601,"OnDeath_Silencer_IntStealWrapper")
	call SaveStr(MHT,'A2QM',601,"OnDeath_StoneOwnerDeathWrapper")
	call SaveStr(MHT,'A2TJ',601,"OnDeath_StoneOwnerDeathWrapper")
	call SaveStr(MHT,'A2QI',601,"OnDeath_StoneOwnerDeathWrapper")
	call SaveStr(MHT,'A2TI',601,"OnDeath_StoneOwnerDeathWrapper")
	call SaveStr(MHT,'A0BR',601,"OnDeath_NecromasteryReactWrapper")
	call SaveStr(MHT,'Z318',601,"OnDeath_NecromasteryReactWrapper")
	
	call SaveStr(MHT,'A022',600,"AddWrapperForAMManabreak")
	call SaveStr(MHT,'A088',600,"InitMulticastRestrictions")
	call SaveStr(MHT,'A0DJ',600,"Earthshaker_Aftershock_ConditionWrapper")
	call SaveStr(MHT,'A0FV',600,"Bristleback_Warpath_ConditionWrapper")
	call SaveStr(MHT,'A1YY',600,"Phoenix_Sunray_StopWrapper")
	call SaveStr(MHT,'A33Q',600,"Silencer_LastWordPassive_CheckWrapper")
	call SaveStr(MHT,'A02C',600,"Krobelus_Witchcraft_CheckWrapper")
	call SaveStr(MHT,'A0N5',600,"Zeus_StaticFieldWrapper")
//	call SaveStr(MHT,'A03N',600,"AddingBashOrCritWrapper")
	call SaveStr(MHT,'A1A3',600,"PreloadingSkills_Viper")//A1A3 -> Nethertoxin
	call SaveStr(MHT,'A04E',600,"PreloadingSkills_Tidehunter")//A04E -> Kraken Shell
	call SaveStr(MHT,'A0RO',600,"PreloadingSkills_Lanaya")//A0RO -> Psi Blades
	call SaveStr(MHT,'A0C6',600,"PreloadingSkills_Axe")//A0C6 -> Counter Helix
	call SaveStr(MHT,'A0DZ',600,"PreloadingSkills_Riki")//A0DZ -> Backstab
	call SaveStr(MHT,'A332',600,"PreloadingSkills_Wyvern")//A332 -> Arctic Burn
	call SaveStr(MHT,'A01Z',600,"PreloadingSkills_Treant")//A01Z -> Nature's Guise
	call SaveStr(MHT,'A08R',600,"PreloadingSkills_Lich")//A08R -> Frost Armor
	call SaveStr(MHT,'P250',600,"PreloadingSkills_Leoric")//P250 -> Vampiric Aura
	call SaveStr(MHT,'A081',600,"PreloadingSkills_Void")//A081 -> Time Lock
	call SaveStr(MHT,'A45B',600,"PreloadingSkills_FireLord")//A45B -> Fire show
	call SaveStr(MHT,'A0O0',600,"PreloadingSkills_Troll")//A0O0 -> Fervor
	call SaveStr(MHT,'A041',600,"PreloadingSkills_Luna")//A041 -> Moon Glaive
	call SaveStr(MHT,'A0N7',600,"PreloadingSkills_Geomancer")//A0N7 -> Geostrike
	call SaveStr(MHT,'A0QN',600,"PreloadingSkills_Huskar")//A0QN -> Burning Spear
	call SaveStr(MHT,'A440',600,"PreloadingSkills_SpaceOrc")//A440 -> Adaptiveness
	call SaveStr(MHT,'A0FA',600,"PreloadingSkills_SK")//A0FA -> Caustic Finale
	call SaveStr(MHT,'A0FX',600,"PreloadingSkills_Spectre")//A0FX -> Desolate
	call SaveStr(MHT,'A0OI',600,"PreloadingSkills_OD")//A0OI -> Arcane Orb
	call SaveStr(MHT,'A0LZ',600,"PreloadingSkills_Silencer")//A0LZ -> Glaives of Wisdom
	call SaveStr(MHT,'A0MG',600,"PreloadingSkills_Abaddon")//A0MG -> Frostmourne
	call SaveStr(MHT,'A0G5',600,"PreloadingSkills_Bara")//A0G5 -> Greater Bash
	call SaveStr(MHT,'A1HR',600,"PreloadingSkills_Slark")//A1HR -> Essence Shift
	call SaveStr(MHT,'A13T',600,"PreloadingSkills_Admiral")//A13T -> Tidebringer
	call SaveStr(MHT,'A00V',600,"PreloadingSkills_Centaur")//A00V -> Return
	call SaveStr(MHT,'QM00',600,"PreloadingSkills_DK")//QM00 -> Elder Dragon Form
	call SaveStr(MHT,'A0DL',600,"PreloadingSkills_ES")//A0DL -> Enchant Totem
	call SaveStr(MHT,'A0DY',600,"PreloadingSkills_Ench")//A0DY -> Impetus
	call SaveStr(MHT,'A0DB',600,"PreloadingSkills_PL")//A0DB -> Juxtapose
	call SaveStr(MHT,'A0A5',600,"PreloadingSkills_LoneDruid")//A0A5 -> Summon Spirit Bear
	call SaveStr(MHT,'P067',600,"PreloadingSkills_Ursa")//P067 -> Fury Swipes
	call SaveStr(MHT,'QB0P',600,"PreloadingSkills_Ursa2")//P067 -> Fury Swipes
	call SaveStr(MHT,'A02Q',600,"PreloadingSkills_Bane")//A02Q -> Fiend's Grip
	call SaveStr(MHT,'A0SS',600,"PreloadingSkills_Lifestealer")//A0SS -> Feast
	call SaveStr(MHT,'A0MY',600,"PreloadingSkills_Veno")//A0MY -> Poison Sting
	call SaveStr(MHT,'S008',600,"PreloadingSkills_WL")//S008 -> Rain of Chaos
	call SaveStr(MHT,'A2EY',600,"PreloadingSkills_Legion")//A2EY -> Moment of Courage
	call SaveStr(MHT,'A2E4',600,"PreloadingSkills_Timber")//A2E4 -> Reactive Armor
	call SaveStr(MHT,'A03S',600,"PreloadingSkills_Sniper")//A03S -> Headshot
	call SaveStr(MHT,'Q0BK',600,"PreloadingSkills_Brood")//Q0BK -> Incapacitating Bite
	call SaveStr(MHT,'A0WQ',600,"PreloadingSkills_BroodHunger")
	call SaveStr(MHT,'A15V',600,"PreloadingSkills_Zombie")//A15V -> Tombstone
	call SaveStr(MHT,'A09V',600,"PreloadingSkills_Viper2")
	call SaveStr(MHT,'A1HQ',600,"PreloadingSkills_AA")
	call SaveStr(MHT,'A03N',600,"Preload_CalculatePossibleCrits")//chaos strike
	call SaveStr(MHT,'A0JJ',600,"Preload_CalculatePossibleBashes")
	call SaveStr(MHT,'A0BE',600,"Preload_CalculatePossibleBashes")
endfunction

function DetailedSpellInfoDisplayingSwitch takes nothing returns nothing
	if bj_isSinglePlayer then
		if DetailedSpellInfoDisplaying==false then
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('TX1V'))
		else
			call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('TX1W'))
		endif
		set DetailedSpellInfoDisplaying=not DetailedSpellInfoDisplaying
	endif
endfunction

function InitSCMD takes nothing returns nothing
	call SaveStr(SCMD,StringHash("-gameinfo"),0,"WYD")
	call SaveStr(SCMD,StringHash("-recreate"),0,"WAD")
	call SaveStr(SCMD,StringHash("-unstuck"),0,"WBD")
	call SaveStr(SCMD,StringHash("-matchup"),0,"WCD")
	call SaveStr(SCMD,StringHash("-ma"),0,"WCD")
	call SaveStr(SCMD,StringHash("-movespeed"),0,"W3D")
	call SaveStr(SCMD,StringHash("-ms"),0,"W3D")
	call SaveStr(SCMD,StringHash("-nh"),0,"NoSameHotkeyCmd")
	call SaveStr(SCMD,StringHash("-mc"),0,"CheckWhatIsMulticast")
	call SaveStr(SCMD,StringHash("-msa"),0,"W6D")
	call SaveStr(SCMD,StringHash("-disablehelp"),0,"WLD")
	call SaveStr(SCMD,StringHash("-enablehelp"),0,"W1D")
	call SaveStr(SCMD,StringHash("-creepstats"),0,"W0D")
	call SaveStr(SCMD,StringHash("-cs"),0,"W0D")
	call SaveStr(SCMD,StringHash("-cson"),0,"W5D")
	call SaveStr(SCMD,StringHash("-csoff"),0,"W5D")
	call SaveStr(SCMD,StringHash("-hidemsg"),0,"W2D")
	call SaveStr(SCMD,StringHash("-showmsg"),0,"X4D")
	call SaveStr(SCMD,StringHash("-weather snow"),0,"X7D")
	call SaveStr(SCMD,StringHash("-weather rain"),0,"X7D")
	call SaveStr(SCMD,StringHash("-weather off"),0,"X7D")
	call SaveStr(SCMD,StringHash("-weather random"),0,"X7D")
	call SaveStr(SCMD,StringHash("-weather wind"),0,"X7D")
	call SaveStr(SCMD,StringHash("-weather moonlight"),0,"X7D")
	call SaveStr(SCMD,StringHash("-showdeny"),0,"X8D")
	call SaveStr(SCMD,StringHash("-hidedeny"),0,"X8D")
	call SaveStr(SCMD,StringHash("-denyinfo"),0,"X9D")
	call SaveStr(SCMD,StringHash("-di"),0,"X9D")
	call SaveStr(SCMD,StringHash("-don"),0,"XDD")
	call SaveStr(SCMD,StringHash("-deathon"),0,"XDD")
	call SaveStr(SCMD,StringHash("-doff"),0,"XDD")
	call SaveStr(SCMD,StringHash("-deathoff"),0,"XDD")
	call SaveStr(SCMD,StringHash("-hhn"),0,"XFD")
	call SaveStr(SCMD,StringHash("-ui"),0,"ToggleStatusWindow")
	call SaveStr(SCMD,StringHash("-charges"),0,"ToggleChargesDisplay")
	call SaveStr(SCMD,StringHash("-hideheronames"),0,"XFD")
	call SaveStr(SCMD,StringHash("-mute"),0,"XGD")
	call SaveStr(SCMD,StringHash("-afk"),0,"XHD")
	call SaveStr(SCMD,StringHash("-apm"),0,"XJD")
	call SaveStr(SCMD,StringHash("-clear"),0,"XKD")
	call SaveStr(SCMD,StringHash("-c"),0,"XKD")
	call SaveStr(SCMD,StringHash("-fc"),0,"FastClear")
	call SaveStr(SCMD,StringHash("-courier"),0,"XMD")
	call SaveStr(SCMD,StringHash("-rolloff"),0,"XQD")
	call SaveStr(SCMD,StringHash("-rollon"),0,"XRD")
	call SaveStr(SCMD,StringHash("-bonus"),0,"XXD")
	call SaveStr(SCMD,StringHash("-rollhero"),0,"XYD")
	call SaveStr(SCMD,StringHash("-rh"),0,"XYD")
	call SaveStr(SCMD,StringHash("-ii"),0,"XBD")
	call SaveStr(SCMD,StringHash("-iteminfo"),0,"XBD")
	call SaveStr(SCMD,StringHash("-si"),0,"ShowSpellInfo")
	call SaveStr(SCMD,StringHash("-skillinfo"),0,"ShowSpellInfo")
	call SaveStr(SCMD,StringHash("-spellinfo"),0,"ShowSpellInfo")
	call SaveStr(SCMD,StringHash("-ss"),0,"ToggleSkillShowing")
	call SaveStr(SCMD,StringHash("-disableselection"),0,"XLD")
	call SaveStr(SCMD,StringHash("-ds"),0,"XLD")
	call SaveStr(SCMD,StringHash("-enableselection"),0,"X1D")
	call SaveStr(SCMD,StringHash("-unlock"),0,"X6D")
	call SaveStr(SCMD,StringHash("-es"),0,"X1D")
	call SaveStr(SCMD,StringHash("-sleep"),0,"X0D")
	call SaveStr(SCMD,StringHash("-calm"),0,"X2D")
	call SaveStr(SCMD,StringHash("-st"),0,"X5D")
	call SaveStr(SCMD,StringHash("-sp"),0,"HidePassivesFunctionInit")
	call SaveStr(SCMD,StringHash("-show"),0,"Techies_ShowDetonateIcon")
	//call SaveStr(SCMD,StringHash("-cd"),0,"TogglePassiveCooldown")
	call SaveStr(SCMD,StringHash("-cooldown"),0,"TogglePassiveCooldown")
	call SaveStr(SCMD,StringHash("-fix"),0,"FixPassivesPlz")
	call SaveStr(SCMD,StringHash("-reset"),0,"ResetSpells")
	call SaveStr(SCMD,StringHash("-remove"),0,"RemoveUnitFn")
	call SaveStr(SCMD,StringHash("-morph"),0,"RemoveMorphIconFn")
	call SaveStr(SCMD,StringHash("-hud"),0,"AltHUD")
	call SaveStr(SCMD,StringHash("-sddon"),0,"ToggleSDD")
	call SaveStr(SCMD,StringHash("-sddoff"),0,"ToggleSDD")
	call SaveStr(SCMD,StringHash("-ff"),0,"ffWrapper")
	call SaveStr(SCMD,StringHash("-id"),0,"DetailedSpellInfoDisplayingSwitch")
	//call SaveStr(SCMD,StringHash("!ff"),0,"ffWrapper")
	call SaveStr(SCMD,StringHash("!ff"),0,"RGCFFWrapper")//RGC has failed here, replacing with our own FF
	call SaveStr(SCMD,StringHash("-wff"),0,"whoffWrapper")
	call SaveStr(SCMD,StringHash("-addtime"),0,"AddPickTimeWrapper")
	call SaveStr(SCMD,StringHash("-ready"),0,"ReadyCMDWrapper")
	call SaveStr(SCMD,StringHash("-lolwtf"),0,"LOLWTFWrapper")
	call SaveStr(SCMD,StringHash("-random"),0,"RandomHeroWrapper")
	call SaveStr(SCMD,StringHash("-random int"),0,"RandomHeroWrapper")
	call SaveStr(SCMD,StringHash("-random agi"),0,"RandomHeroWrapper")
	call SaveStr(SCMD,StringHash("-random str"),0,"RandomHeroWrapper")
	call SaveStr(SCMD,StringHash("-random melee"),0,"RandomHeroWrapper")
	call SaveStr(SCMD,StringHash("-random range"),0,"RandomHeroWrapper")
	call SaveStr(SCMD,StringHash("-repick"),0,"RepickHeroWrapper")
	call SaveStr(SCMD,StringHash("-ok"),0,"SwitchChatCmd")
	call SaveStr(SCMD,StringHash("-no"),0,"SwitchChatCmd")
	call SaveStr(SCMD,StringHash("-nw"),0,"CMDShowMyNetworth")
	call SaveStr(SCMD,StringHash("-orp"),0,"OldRunePickupStyle")
	call SaveStr(SCMD,StringHash("-shaking"),0,"CMDShakingToggle")
endfunction

function AddDummyAbility takes integer id returns nothing
	set SomeDummyAbilitiesCounter=SomeDummyAbilitiesCounter+1
	set SomeDummyAbilitiesList[SomeDummyAbilitiesCounter]=id
endfunction

function InitDummyAbils takes nothing returns nothing
	call AddDummyAbility('Anh1')//Anh1 -> Heal
	call AddDummyAbility('A3FA')
endfunction

function AddItemAbility takes integer id returns nothing
	set ItemsAbilitiesMax2=ItemsAbilitiesMax2+1
	set ItemsAbilities2[ItemsAbilitiesMax2]=id
endfunction

function InitItemAbils takes nothing returns nothing
	call AddItemAbility('A0B6')//A0B6 -> Item Summon Courier
	call AddItemAbility('A3AG')
	call AddItemAbility('A395')
	call AddItemAbility('A39K')
	call AddItemAbility('A3BP')
	call AddItemAbility('A38V')
	call AddItemAbility('A38R')
	call AddItemAbility('A397')
	call AddItemAbility('A0B8')//A0B8 -> Manta Image
	call AddItemAbility('A0BE')//A0BE -> Berserker Rage
	call AddItemAbility('A0C4')//A0C4 -> Soul Assumption
	call AddItemAbility('A0CK')//A0CK -> Mekansm Armor + Heal
	call AddItemAbility('A0CX')//A0CX -> Staff of Teleportation (item)
	call AddItemAbility('A0D3')//A0D3 -> Item Skeleton Summon lvl 2
	call AddItemAbility('A0DF')//A0DF -> Item Skeleton Summon lvl 3
	call AddItemAbility('A0DY')//A0DY -> Impetus
	call AddItemAbility('A0FD')//A0FD -> Orchid Malevolence
	call AddItemAbility('A0FO')//A0FO -> Bottle Regen
	call AddItemAbility('A0H6')//A0H6 -> Bottle Empty
	call AddItemAbility('A0H7')//A0H7 -> Bottle Rune
	call AddItemAbility('A0HA')//A0HA -> Reality
	call AddItemAbility('A0HB')//A0HB -> Item Skeleton Summon lvl 1
	call AddItemAbility('A0I9')//A0I9 -> BreakPers
	call AddItemAbility('A0JL')//A0JL -> Static Charge
	call AddItemAbility('A0JT')//A0JT -> Item Summon Flying Courier
	call AddItemAbility('A0JY')//A0JY -> Magic Stick
	call AddItemAbility('A0K0')//A0K0 -> Cheese
	call AddItemAbility('A0K5')//A0K5 -> Disassemble
	call AddItemAbility('A0K7')//A0K7 -> Arcane Ring
	call AddItemAbility('A0KW')//A0KW -> Morph
	call AddItemAbility('A0KX')//A0KX -> Morph
	call AddItemAbility('A0LZ')//A0LZ -> Glaives of Wisdom
	call AddItemAbility('A0MP')//A0MP -> Mana Shield
	call AddItemAbility('A0OI')//A0OI -> Arcane Orb
	call AddItemAbility('A0PY')//A0PY -> BasSwap
	call AddItemAbility('A0QN')//A0QN -> Burning Spear
	call AddItemAbility('A0RP')//A0RP -> Psionic Trap
	call AddItemAbility('A0RT')//A0RT -> Psionic Trap
	call AddItemAbility('A0S3')//A0S3 -> Avatar
	call AddItemAbility('A0SA')//A0SA -> Ethereal Jaunt
	call AddItemAbility('A0T7')//A0T7 -> BIGHAND1New
	call AddItemAbility('A0T8')//A0T8 -> BIGHAND2New
	call AddItemAbility('A0T9')//A0T9 -> ICEARMORNEW (NEW)
	call AddItemAbility('A017')//A017 -> Wind Walk
	call AddItemAbility('A02O')//A02O -> Finger of Death
	call AddItemAbility('A02T')//A02T -> Detonate
	call AddItemAbility('A02W')//A02W -> Item Cooldown Reset
	call AddItemAbility('A02X')//A02X -> Observer Ward
	call AddItemAbility('A026')//A026 -> Frost Arrows
	call AddItemAbility('A05Y')//A05Y -> Devour
	call AddItemAbility('A06K')//A06K -> Rot
	call AddItemAbility('A08L')//A08L -> Death Pact item
	call AddItemAbility('A08Y')//A08Y -> Finger of Death
	call AddItemAbility('A08Z')//A08Z -> Finger of Death
	call AddItemAbility('A09V')//A09V -> Poison Attack
	call AddItemAbility('A090')//A090 -> Finger of Death
	call AddItemAbility('A092')//A092 -> Finger of Death
	call AddItemAbility('A1AC')//A1AC -> Ghost Potion
	call AddItemAbility('A1EW')//A1EW -> Khadgar's Pipe of Insight
	call AddItemAbility('A1FD')
	call AddItemAbility('A1FO')//A1FO -> MKBSwap
	call AddItemAbility('A1FP')//A1FP -> Satanic this
	call AddItemAbility('A1IO')//A1IO -> RadSwap
	call AddItemAbility('A1MO')//A1MO -> Urn of shadows
	call AddItemAbility('A1OZ')//A1OZ -> Heal
	call AddItemAbility('A1Q8')//A1Q8 -> Soul Ring
	call AddItemAbility('A1QD')//A1QD -> Ether Blast
	call AddItemAbility('A1QV')//A1QV -> Sentinel
	call AddItemAbility('A1R5')//A1R5 -> Scroll of Teleporation (fixed)
	call AddItemAbility('A1RA')//A1RA -> Soulsteal End
	call AddItemAbility('A1T7')//A1T7 -> Eul Cyclone
	call AddItemAbility('A1WA')//A1WA -> Sapphire Water Temp
	call AddItemAbility('A1WB')//A1WB -> Impetus
	call AddItemAbility('A1WE')//A1WE -> Manta Image (ranged)
	call AddItemAbility('A1ZH')//A1ZH -> Medallion of Courage Container
	call AddItemAbility('A1ZI')//A1ZI -> Medallion of Courage
	call AddItemAbility('A1ZW')//A1ZW -> Ancient Jangoo
	call AddItemAbility('A2EA')//A2EA -> Rod of atos
	call AddItemAbility('A2HO')//A2HO -> Rod of atos 2
	call AddItemAbility('A2HQ')//A2HQ -> Blade of the Reaper
	call AddItemAbility('A2K1')//A2K1 -> Tranquil Boots
	call AddItemAbility('A2K4')//A2K4 -> Prudence
	call AddItemAbility('A2K7')//A2K7 -> Annihilator Stun
	call AddItemAbility('A2KG')//A2KG -> Ring of Aquila
	call AddItemAbility('A2LI')//A2LI -> Avatar
	call AddItemAbility('A2N1')//A2N1 -> Shadow Amulet
	call AddItemAbility('A11D')//A11D -> Avatar
	call AddItemAbility('A11E')//A11E -> Avatar
	call AddItemAbility('A11F')//A11F -> Avatar
	call AddItemAbility('A11G')//A11G -> Avatar
	call AddItemAbility('A11H')//A11H -> Avatar
	call AddItemAbility('A12W')//A12W -> Phase Boots - Phase
	call AddItemAbility('A13D')//A13D -> X Marks The Spot Return
	call AddItemAbility('A14A')//A14A -> Power Treads
	call AddItemAbility('A15W')//A15W -> Blademail
	call AddItemAbility('A19M')//A19M -> Force Staff
	call AddItemAbility('A21V')
	call AddItemAbility('A21W')
	call AddItemAbility('A21X')
	call AddItemAbility('A28D')//A28D -> Veil of Discord
	call AddItemAbility('A28Y')//A28Y -> Hand of Midas
	call AddItemAbility('A42W')//A42W -> Inventory for couriers (cant be used)
	call AddItemAbility('A206')//A206 -> Smoke of Deceit
	call AddItemAbility('A231')//A231 -> Boots of Travel (fixed)
	call AddItemAbility('A269')//A269 -> Ring of Basilius
	call AddItemAbility('A397')
	call AddItemAbility('A449')//A449 -> Psionic Trap
	call AddItemAbility('ACch')//ACch -> Helm of the Dominator
	call AddItemAbility('AChx')//AChx -> Guinsoo's Scythe
	call AddItemAbility('Aeat')//Aeat -> Eat Tree
	call AddItemAbility('AHfa')//AHfa -> Searing Arrows
	call AddItemAbility('AIbk')//AIbk -> Blink (Item Version)
	call AddItemAbility('AIcy')//AIcy -> Cyclone
	call AddItemAbility('AIda')//AIda -> Item Temporary Area Armor Bonus
	call AddItemAbility('AImt')//AImt -> Staff of Teleportation
	call AddItemAbility('AIpg')//AIpg -> Item Purge
	call AddItemAbility('AIpl')//AIpl -> Lesser Clarity Potion
	call AddItemAbility('AIpr')//AIpr -> Sapphire Water
	call AddItemAbility('AIsw')//AIsw -> Sentry Ward
	call AddItemAbility('AItb')//AItb -> Dust of Appearance
	call AddItemAbility('AIxk')//AIxk -> Berserk
	call AddItemAbility('ANLS')
	call AddItemAbility('ANTG')
	call AddItemAbility('A42I')
	call AddItemAbility('A3FA')
	call AddItemAbility('A39C')
endfunction

function RegisterItemAbility takes integer id returns nothing
	call SaveBoolean(SpellsDB,'itid',id,true)
	if isAintItemAbility(id) then
		call AddItemAbility(id)
	endif
//call echo("added item ability "+Id2String(id))
endfunction

function Func1164 takes nothing returns boolean
	if IsPoisonArrowSkill(GetSpellAbilityId())and IsUnitUnableToAttack(GetTriggerUnit())then
		call InterruptUnit(GetTriggerUnit())
	elseif GetUnitCurrentOrder(GetTriggerUnit())>=852008 and GetUnitCurrentOrder(GetTriggerUnit())<=852013 then
		call RegisterItemAbility(GetSpellAbilityId())
	endif
	return false
endfunction

function InitAbilLists1388 takes nothing returns boolean
	call FuncSetMainFuncWork(false)
//	call fInitOverlay(true)
	call LoadingProgressCheckout("Pre mem patching2")
	call ExecuteFunc("SetupMoreMemPatches")
	call LoadingProgressCheckout("mem patching2 done")
	call ExecuteFunc("LibFeaturesFullEnable")
	call ShowObserverSkillPanelF(true)
	call SetManabarEnabledF()
	call fShowSkillPanelForAllUnits(true)
	call SetAttackSpeedLimit(6.)
	call EnableOPLimit()
	
	call InitItemAbils()
	call InitDummyAbils()
	call InitQuests()
	return false
endfunction

function InitLotusOrbItemAbilities takes nothing returns nothing
	
	call SaveInteger(UTable,'A3E9',Item_Real[GuinsooHex],'AChx')//AChx -> Guinsoo's Scythe
	call SaveStr(UTable,'A3E9',Item_Real[GuinsooHex],"hex")
	
	call SaveInteger(UTable,'A3E9',Item_Real[Orchid],'A0FD')//A0FD -> Orchid Malevolence
	call SaveStr(UTable,'A3E9',Item_Real[Orchid],"soulburn")
	
	call SaveInteger(UTable,'A3E9',Item_Real[Eul],'A1T7')//A1T7 -> Eul Cyclone
	call SaveStr(UTable,'A3E9',Item_Real[Eul],"channel")
	
	call SaveInteger(UTable,'A3E9',Item_Real[ForceStaff],'A19M')//A19M -> Force Staff
	call SaveStr(UTable,'A3E9',Item_Real[ForceStaff],"852609")
	call SaveBoolean(UTable,'A3E9',Item_Real[ForceStaff],true)
	
	call SaveInteger(UTable,'A3E9',Item_Real[Dagon1],'A02O')//A02O -> Finger of Death
	call SaveStr(UTable,'A3E9',Item_Real[Dagon1],"fingerofdeath")
	call SaveInteger(UTable,'A3E9',Item_Real[Dagon2],'A08Y')//A08Y -> Finger of Death
	call SaveStr(UTable,'A3E9',Item_Real[Dagon2],"fingerofdeath")
	call SaveInteger(UTable,'A3E9',Item_Real[Dagon3],'A08Z')//A08Z -> Finger of Death
	call SaveStr(UTable,'A3E9',Item_Real[Dagon3],"fingerofdeath")
	call SaveInteger(UTable,'A3E9',Item_Real[Dagon4],'A090')//A090 -> Finger of Death
	call SaveStr(UTable,'A3E9',Item_Real[Dagon4],"fingerofdeath")
	call SaveInteger(UTable,'A3E9',Item_Real[Dagon5],'A092')//A092 -> Finger of Death
	call SaveStr(UTable,'A3E9',Item_Real[Dagon5],"fingerofdeath")
	
	call SaveInteger(UTable,'A3E9',Item_Real[RodOfAtos],'A2EA')//A2EA -> Rod of atos
	call SaveStr(UTable,'A3E9',Item_Real[RodOfAtos],"852609")
	call SaveBoolean(UTable,'A3E9',Item_Real[RodOfAtos],true)
	
	call SaveInteger(UTable,'A3E9',Item_Real[AbyssalBlade],'A2K7')//A2K7 -> Annihilator Stun
	call SaveStr(UTable,'A3E9',Item_Real[AbyssalBlade],"thunderbolt")
	
	call SaveInteger(UTable,'A3E9',Item_Real[EtherealBlade],'A1QD')//A1QD -> Ether Blast
	call SaveStr(UTable,'A3E9',Item_Real[EtherealBlade],"creepheal")
	
	call SaveInteger(UTable,'A3E9',Item_Real[DiffusalBlade],'AIpg')//AIpg -> Item Purge
	call SaveStr(UTable,'A3E9',Item_Real[DiffusalBlade],"purge")
	call SaveInteger(UTable,'A3E9',Item_Real[DiffusalBlade_upg],'AIpg')//AIpg -> Item Purge
	call SaveStr(UTable,'A3E9',Item_Real[DiffusalBlade_upg],"purge")
	
	call SaveInteger(UTable,'A3E9',Item_Real[HeavensHalberd],'A2K4')//A2K4 -> Prudence
	call SaveStr(UTable,'A3E9',Item_Real[HeavensHalberd],"852609")
	call SaveBoolean(UTable,'A3E9',Item_Real[HeavensHalberd],true)
endfunction

function StoreAllUnitsSightRange takes nothing returns nothing
	
	call SaveInteger(UnitStats,'ugho',SIGHT,850)//ugho -> Ghoul
	call SaveInteger(UnitStats,'u001',SIGHT,850)//u001 -> Ghoul
	call SaveInteger(UnitStats,'unec',SIGHT,850)//unec -> Necromancer
	call SaveInteger(UnitStats,'u002',SIGHT,850)//u002 -> Necromancer
	
	call SaveInteger(UnitStats,'esen',SIGHT,850)//esen -> Treant
	call SaveInteger(UnitStats,'e00V',SIGHT,850)//e00V -> Treant
	call SaveInteger(UnitStats,'edry',SIGHT,850)//edry -> Druid of the Talon
	call SaveInteger(UnitStats,'e00W',SIGHT,850)//e00W -> Druid of the Talon
	
	call SaveInteger(UnitStats,'ebal',SIGHT,850)//ebal -> Glaive Thrower
	call SaveInteger(UnitStats,'e026',SIGHT,850)//e026 -> Glaive Thrower
	call SaveInteger(UnitStats,'umtw',SIGHT,850)//umtw -> Meat Wagon
	call SaveInteger(UnitStats,'u00R',SIGHT,850)//u00R -> Meat Wagon
	
	call SaveInteger(UnitStats,'u00T',SIGHT,1800)//u00T -> Spirit Tower - level 4
	call SaveInteger(UnitStats,'u00N',SIGHT,1800)//u00N -> Spirit Tower - level 3
	call SaveInteger(UnitStats,'u00D',SIGHT,1800)//u00D -> Spirit Tower - level 2
	call SaveInteger(UnitStats,'u00M',SIGHT,1800)//u00M -> Spirit Tower - level 1
	
	call SaveInteger(UnitStats,'e00R',SIGHT,1800)//e00R -> Ancient Protector - level 1
	call SaveInteger(UnitStats,'e011',SIGHT,1800)//e011 -> Ancient Protector - level 2
	call SaveInteger(UnitStats,'e00S',SIGHT,1800)//e00S -> Ancient Protector - level 3
	call SaveInteger(UnitStats,'e019',SIGHT,1800)//e019 -> Ancient Protector - level 4
	
	call SaveInteger(UnitStats,'h308',SIGHT,700)//h308 -> Hawk
	call SaveInteger(UnitStats,'h308',NSIGHT,700)//h308 -> Hawk
	
	call SaveInteger(UnitStats,'n01Q',SIGHT,1000)//n01Q -> Scout Hawk
	
	call SaveInteger(UnitStats,'n01R',SIGHT,1300)//n01R -> Greater Hawk
	call SaveInteger(UnitStats,'n01R',NSIGHT,900)//n01R -> Greater Hawk
	
	call SaveInteger(UnitStats,'h309',SIGHT,1600)//h309 -> Legendary Hawk
	call SaveInteger(UnitStats,'h309',NSIGHT,1000)//h309 -> Legendary Hawk
	
	call SaveInteger(UnitStats,'n01M',SIGHT,1400)//n01M -> Quilbeast
	
	call SaveInteger(UnitStats,'n01S',SIGHT,1400)//n01S -> Greater Quilbeast
	
	
	call SaveInteger(UnitStats,'n004',SIGHT,1400)//n004 -> Spirit Bear
	call SaveInteger(UnitStats,'n018',SIGHT,1400)//n018 -> Spirit Bear
	call SaveInteger(UnitStats,'n01C',SIGHT,1400)//n01C -> Spirit Bear
	call SaveInteger(UnitStats,'n01G',SIGHT,1400)//n01G -> Spirit Bear
	
	call SaveInteger(UnitStats,'efon',SIGHT,1200)//efon -> Treant
	call SaveInteger(UnitStats,'osp4',SIGHT,1200)//osp4 -> Serpent Ward
	call SaveInteger(UnitStats,'o008',SIGHT,1200)//o008 -> Serpent Ward
	call SaveInteger(UnitStats,'o009',SIGHT,1200)//o009 -> Serpent Ward
	call SaveInteger(UnitStats,'o01C',SIGHT,1200)//o01C -> Serpent Ward
	call SaveInteger(UnitStats,'o01D',SIGHT,1200)//o01D -> Serpent Ward
	call SaveInteger(UnitStats,'o01E',SIGHT,1200)//o01E -> Serpent Ward
	
	call SaveInteger(UnitStats,'o005',SIGHT,1200)//o005 -> Lycanthropy Wolf 1
	call SaveInteger(UnitStats,'o006',SIGHT,1200)//o006 -> Lycanthropy Wolf 2
	call SaveInteger(UnitStats,'o007',SIGHT,1200)//o007 -> Lycanthropy Wolf 3
	call SaveInteger(UnitStats,'o00F',SIGHT,1200)//o00F -> Lycanthropy Wolf 4
	
	call SaveInteger(UnitStats,'o00T',SIGHT,1200)//o00T -> Plague Ward 1
	call SaveInteger(UnitStats,'o00U',SIGHT,1200)//o00U -> Plague Ward 2
	call SaveInteger(UnitStats,'o00V',SIGHT,1200)//o00V -> Plague Ward 3
	call SaveInteger(UnitStats,'o00W',SIGHT,1200)//o00W -> Plague Ward 4
	
	call SaveInteger(UnitStats,'hwat',SIGHT,1200)//hwat -> Lesser Eidolon
	call SaveInteger(UnitStats,'hwt2',SIGHT,1200)//hwt2 -> Eidolon
	call SaveInteger(UnitStats,'hwt3',SIGHT,1200)//hwt3 -> Greater Eidolon
	call SaveInteger(UnitStats,'h006',SIGHT,1200)//h006 -> Dire Eidolon
	
	call SaveInteger(UnitStats,'n00U',NSIGHT,1800)//n00U -> Infernal
	call SaveInteger(UnitStats,'n00Y',NSIGHT,1800)//n00Y -> Infernal
	call SaveInteger(UnitStats,'n00Z',NSIGHT,1800)//n00Z -> Infernal
	
	call SaveInteger(UnitStats,'n0KU',NSIGHT,1800)//n0KU -> Infernal
	call SaveInteger(UnitStats,'n0KV',NSIGHT,1800)//n0KV -> Infernal
	call SaveInteger(UnitStats,'n0KW',NSIGHT,1800)//n0KW -> Infernal
	
	call SaveInteger(UnitStats,'n027',SIGHT,1200)//n027 -> Forged Spirit
	
	call SaveInteger(UnitStats,'o004',SIGHT,1600)//o004 -> Observer Ward
	call SaveInteger(UnitStats,'o004',NSIGHT,1600)//o004 -> Observer Ward
	
	call SaveInteger(UnitStats,'Usyl',NSIGHT,1000)//Usyl -> Dwarven Sniper
	call SaveInteger(UnitStats,'Naka',NSIGHT,1000)//Naka -> Bounty Hunter
	
	call SaveInteger(UnitStats,'Udre',SIGHT,1200)//Udre -> Night Stalker
	call SaveInteger(UnitStats,'Udre',NSIGHT,1800)//Udre -> Night Stalker
	call SaveInteger(UnitStats,'H071',NSIGHT,1800)//H071 -> Murloc Nightcrawler
	call SaveInteger(UnitStats,'o01N',NSIGHT,1800)//o01N -> Vision Dummy (1200/1800)
	
	
endfunction

function StoreAllUnitsBounty takes nothing returns nothing
	//Bounty - gold per kill; LastTimeActivity - lower, H - higher. Hope 
	//Exp - exp per kill
	
	//creeps
	call SaveInteger(UnitStats,'ugho',BOUNTYL,35)	//ghouls//ugho -> Ghoul
	call SaveInteger(UnitStats,'ugho',BOUNTYH,44)//ugho -> Ghoul
	call SaveInteger(UnitStats,'ugho',EXP,62)//ugho -> Ghoul
	call SaveInteger(UnitStats,'u001',BOUNTYL,18)	//mega ghouls//u001 -> Ghoul
	call SaveInteger(UnitStats,'u001',BOUNTYH,26)//u001 -> Ghoul
	call SaveInteger(UnitStats,'u001',EXP,25)//u001 -> Ghoul
	call SaveInteger(UnitStats,'unec',BOUNTYL,40)	//necros//unec -> Necromancer
	call SaveInteger(UnitStats,'unec',BOUNTYH,49)//unec -> Necromancer
	call SaveInteger(UnitStats,'unec',EXP,41)//unec -> Necromancer
	call SaveInteger(UnitStats,'u002',BOUNTYL,18)	//mega necros//u002 -> Necromancer
	call SaveInteger(UnitStats,'u002',BOUNTYH,26)//u002 -> Necromancer
	call SaveInteger(UnitStats,'u002',EXP,25)//u002 -> Necromancer
	
	call SaveInteger(UnitStats,'esen',BOUNTYL,35)	//treant//esen -> Treant
	call SaveInteger(UnitStats,'esen',BOUNTYH,44)//esen -> Treant
	call SaveInteger(UnitStats,'esen',EXP,62)//esen -> Treant
	call SaveInteger(UnitStats,'e00V',BOUNTYL,18)	//mega treant//e00V -> Treant
	call SaveInteger(UnitStats,'e00V',BOUNTYH,26)//e00V -> Treant
	call SaveInteger(UnitStats,'e00V',EXP,25)//e00V -> Treant
	call SaveInteger(UnitStats,'edry',BOUNTYL,40)	//druids//edry -> Druid of the Talon
	call SaveInteger(UnitStats,'edry',BOUNTYH,49)//edry -> Druid of the Talon
	call SaveInteger(UnitStats,'edry',EXP,41)//edry -> Druid of the Talon
	call SaveInteger(UnitStats,'e00W',BOUNTYL,18)	//mega druids//e00W -> Druid of the Talon
	call SaveInteger(UnitStats,'e00W',BOUNTYH,26)//e00W -> Druid of the Talon
	call SaveInteger(UnitStats,'e00W',EXP,25)//e00W -> Druid of the Talon
	
	call SaveInteger(UnitStats,'ebal',BOUNTYL,66)	//ballista//ebal -> Glaive Thrower
	call SaveInteger(UnitStats,'ebal',BOUNTYH,80)//ebal -> Glaive Thrower
	call SaveInteger(UnitStats,'ebal',EXP,88)//ebal -> Glaive Thrower
	call SaveInteger(UnitStats,'e026',BOUNTYL,66)	//mega ballista//e026 -> Glaive Thrower
	call SaveInteger(UnitStats,'e026',BOUNTYH,80)//e026 -> Glaive Thrower
	call SaveInteger(UnitStats,'e026',EXP,88)//e026 -> Glaive Thrower
	call SaveInteger(UnitStats,'umtw',BOUNTYL,66)	//meat wagon//umtw -> Meat Wagon
	call SaveInteger(UnitStats,'umtw',BOUNTYH,80)//umtw -> Meat Wagon
	call SaveInteger(UnitStats,'umtw',EXP,88)//umtw -> Meat Wagon
	call SaveInteger(UnitStats,'u00R',BOUNTYL,66)	//mega meat wagon//u00R -> Meat Wagon
	call SaveInteger(UnitStats,'u00R',BOUNTYH,80)//u00R -> Meat Wagon
	call SaveInteger(UnitStats,'u00R',EXP,88)//u00R -> Meat Wagon
	
	//buildings sent
	call SaveInteger(UnitStats,'e019',BOUNTYL,150)	//Ancient protector Tier 4//e019 -> Ancient Protector - level 4
	call SaveInteger(UnitStats,'e019',BOUNTYH,250)//e019 -> Ancient Protector - level 4
	call SaveInteger(UnitStats,'e019',EXP,25)//e019 -> Ancient Protector - level 4
	call SaveInteger(UnitStats,'e00S',BOUNTYL,150)	//Ancient protector Tier 3//e00S -> Ancient Protector - level 3
	call SaveInteger(UnitStats,'e00S',BOUNTYH,250)//e00S -> Ancient Protector - level 3
	call SaveInteger(UnitStats,'e00S',EXP,25)//e00S -> Ancient Protector - level 3
	call SaveInteger(UnitStats,'e011',BOUNTYL,150)	//Ancient protector Tier 2//e011 -> Ancient Protector - level 2
	call SaveInteger(UnitStats,'e011',BOUNTYH,250)//e011 -> Ancient Protector - level 2
	call SaveInteger(UnitStats,'e011',EXP,25)//e011 -> Ancient Protector - level 2
	call SaveInteger(UnitStats,'e00R',BOUNTYL,150)	//Ancient protector Tier 1//e00R -> Ancient Protector - level 1
	call SaveInteger(UnitStats,'e00R',BOUNTYH,250)//e00R -> Ancient Protector - level 1
	call SaveInteger(UnitStats,'e00R',EXP,25)//e00R -> Ancient Protector - level 1
	
	call SaveInteger(UnitStats,'eaom',BOUNTYL,100)	//Melee rax (Ancient of war)//eaom -> Ancient of War
	call SaveInteger(UnitStats,'eaom',BOUNTYH,150)//eaom -> Ancient of War
	call SaveInteger(UnitStats,'eaom',EXP,25)//eaom -> Ancient of War
	call SaveInteger(UnitStats,'eaoe',BOUNTYL,100)	//Ranged rax (Ancient of Lore)//eaoe -> Ancient of Lore
	call SaveInteger(UnitStats,'eaoe',BOUNTYH,150)//eaoe -> Ancient of Lore
	call SaveInteger(UnitStats,'eaoe',EXP,25)//eaoe -> Ancient of Lore
	
	call SaveInteger(UnitStats,'edob',BOUNTYL,102)	//Hunters Hall//edob -> Hunter's Hall
	call SaveInteger(UnitStats,'edob',BOUNTYH,120)//edob -> Hunter's Hall
	call SaveInteger(UnitStats,'edob',EXP,25)//edob -> Hunter's Hall
	call SaveInteger(UnitStats,'eaow',BOUNTYL,102)	//Ancient of wind//eaow -> Ancient of Wind
	call SaveInteger(UnitStats,'eaow',BOUNTYH,120)//eaow -> Ancient of Wind
	call SaveInteger(UnitStats,'eaow',EXP,25)//eaow -> Ancient of Wind
	call SaveInteger(UnitStats,'emow',BOUNTYL,102)	//Moon wells//emow -> Moon Well
	call SaveInteger(UnitStats,'emow',BOUNTYH,120)//emow -> Moon Well
	call SaveInteger(UnitStats,'emow',EXP,25)//emow -> Moon Well
	
	//buildings scourge
	call SaveInteger(UnitStats,'u00T',BOUNTYL,150)	//Zigg Tier 4//u00T -> Spirit Tower - level 4
	call SaveInteger(UnitStats,'u00T',BOUNTYH,250)//u00T -> Spirit Tower - level 4
	call SaveInteger(UnitStats,'u00T',EXP,25)//u00T -> Spirit Tower - level 4
	call SaveInteger(UnitStats,'u00N',BOUNTYL,150)	//Zigg Tier 3//u00N -> Spirit Tower - level 3
	call SaveInteger(UnitStats,'u00N',BOUNTYH,250)//u00N -> Spirit Tower - level 3
	call SaveInteger(UnitStats,'u00N',EXP,25)//u00N -> Spirit Tower - level 3
	call SaveInteger(UnitStats,'u00D',BOUNTYL,150)	//Zigg Tier 2//u00D -> Spirit Tower - level 2
	call SaveInteger(UnitStats,'u00D',BOUNTYH,250)//u00D -> Spirit Tower - level 2
	call SaveInteger(UnitStats,'u00D',EXP,25)//u00D -> Spirit Tower - level 2
	call SaveInteger(UnitStats,'u00M',BOUNTYL,150)	//Zigg Tier 1//u00M -> Spirit Tower - level 1
	call SaveInteger(UnitStats,'u00M',BOUNTYH,250)//u00M -> Spirit Tower - level 1
	call SaveInteger(UnitStats,'u00M',EXP,25)//u00M -> Spirit Tower - level 1
	
	call SaveInteger(UnitStats,'usep',BOUNTYL,100)	//Melee rax//usep -> Crypt
	call SaveInteger(UnitStats,'usep',BOUNTYH,150)//usep -> Crypt
	call SaveInteger(UnitStats,'usep',EXP,25)//usep -> Crypt
	call SaveInteger(UnitStats,'utod',BOUNTYL,100)	//Ranged rax//utod -> Temple of the Damned
	call SaveInteger(UnitStats,'utod',BOUNTYH,150)//utod -> Temple of the Damned
	call SaveInteger(UnitStats,'utod',EXP,25)//utod -> Temple of the Damned
	
	call SaveInteger(UnitStats,'ubon',BOUNTYL,102)	//Wyrm nest//ubon -> Boneyard
	call SaveInteger(UnitStats,'ubon',BOUNTYH,120)//ubon -> Boneyard
	call SaveInteger(UnitStats,'ubon',EXP,25)//ubon -> Boneyard
	call SaveInteger(UnitStats,'usap',BOUNTYL,102)	//Sacrifice pit//usap -> Sacrificial Pit
	call SaveInteger(UnitStats,'usap',BOUNTYH,120)//usap -> Sacrificial Pit
	call SaveInteger(UnitStats,'usap',EXP,25)//usap -> Sacrificial Pit
	call SaveInteger(UnitStats,'uzig',BOUNTYL,102)	//Ziggs//uzig -> Ziggurat
	call SaveInteger(UnitStats,'uzig',BOUNTYH,120)//uzig -> Ziggurat
	call SaveInteger(UnitStats,'uzig',EXP,25)//uzig -> Ziggurat
	
	//neutrals
	call SaveInteger(UnitStats,'ndtw',BOUNTYL,54)	//Dark troll warlord//ndtw -> Dark Troll Warlord
	call SaveInteger(UnitStats,'ndtw',BOUNTYH,62)//ndtw -> Dark Troll Warlord
	call SaveInteger(UnitStats,'ndtw',EXP,119)//ndtw -> Dark Troll Warlord
	call SaveInteger(UnitStats,'ndtr',BOUNTYL,26)	//Dark troll//ndtr -> Dark Troll
	call SaveInteger(UnitStats,'ndtr',BOUNTYH,33)//ndtr -> Dark Troll
	call SaveInteger(UnitStats,'ndtr',EXP,62)//ndtr -> Dark Troll
	call SaveInteger(UnitStats,'uske',BOUNTYL,6)	//Skeleton warrior//uske -> Skeleton Warrior
	call SaveInteger(UnitStats,'uske',BOUNTYH,12)//uske -> Skeleton Warrior
	call SaveInteger(UnitStats,'uske',EXP,25)//uske -> Skeleton Warrior
	
	
	call SaveInteger(UnitStats,'nfsh',BOUNTYL,21)	//Forest troll priest//nfsh -> Forest Troll High Priest
	call SaveInteger(UnitStats,'nfsh',BOUNTYH,25)//nfsh -> Forest Troll High Priest
	call SaveInteger(UnitStats,'nfsh',EXP,41)//nfsh -> Forest Troll High Priest
	call SaveInteger(UnitStats,'nftb',BOUNTYL,22)	//Forest troll berserker//nftb -> Forest Troll Berserker
	call SaveInteger(UnitStats,'nftb',BOUNTYH,26)//nftb -> Forest Troll Berserker
	call SaveInteger(UnitStats,'nftb',EXP,41)//nftb -> Forest Troll Berserker
	call SaveInteger(UnitStats,'nkol',BOUNTYL,23)	//Kobold Taskmaster//nkol -> Kobold Taskmaster
	call SaveInteger(UnitStats,'nkol',BOUNTYH,29)//nkol -> Kobold Taskmaster
	call SaveInteger(UnitStats,'nkol',EXP,41)//nkol -> Kobold Taskmaster
	
	call SaveInteger(UnitStats,'nowe',BOUNTYL,67)	//Enraged wildkin//nowe -> Enraged Wildkin
	call SaveInteger(UnitStats,'nowe',BOUNTYH,87)//nowe -> Enraged Wildkin
	call SaveInteger(UnitStats,'nowe',EXP,119)//nowe -> Enraged Wildkin
	call SaveInteger(UnitStats,'nowb',BOUNTYL,15)	//Wildkin//nowb -> Wildkin
	call SaveInteger(UnitStats,'nowb',BOUNTYH,20)//nowb -> Wildkin
	call SaveInteger(UnitStats,'nowb',EXP,25)//nowb -> Wildkin
	
	call SaveInteger(UnitStats,'nomg',BOUNTYL,31)	//Ogre magi//nomg -> Ogre Magi
	call SaveInteger(UnitStats,'nomg',BOUNTYH,49)//nomg -> Ogre Magi
	call SaveInteger(UnitStats,'nomg',EXP,62)//nomg -> Ogre Magi
	call SaveInteger(UnitStats,'nogm',BOUNTYL,23)	//Ogre Mauler//nogm -> Ogre Mauler
	call SaveInteger(UnitStats,'nogm',BOUNTYH,47)//nogm -> Ogre Mauler
	call SaveInteger(UnitStats,'nogm',EXP,41)//nogm -> Ogre Mauler
	
	call SaveInteger(UnitStats,'n026',BOUNTYL,28)	//Mud golem//n026 -> Mud Golem
	call SaveInteger(UnitStats,'n026',BOUNTYH,36)//n026 -> Mud Golem
	call SaveInteger(UnitStats,'n026',EXP,42)//n026 -> Mud Golem
	call SaveInteger(UnitStats,'n127',BOUNTYL,10)	//Mud golem hatchling//n127 -> Shard Golem
	call SaveInteger(UnitStats,'n127',BOUNTYH,16)//n127 -> Shard Golem
	call SaveInteger(UnitStats,'n127',EXP,46)//n127 -> Shard Golem
	call SaveInteger(UnitStats,'n128',BOUNTYL,10)	//Doom hatchling//n128 -> Doom Hatchling
	call SaveInteger(UnitStats,'n128',BOUNTYH,16)//n128 -> Doom Hatchling
	call SaveInteger(UnitStats,'n128',EXP,46)//n128 -> Doom Hatchling
	
	call SaveInteger(UnitStats,'ncnk',BOUNTYL,66)	//Centaur Khan//ncnk -> Centaur Khan
	call SaveInteger(UnitStats,'ncnk',BOUNTYH,78)//ncnk -> Centaur Khan
	call SaveInteger(UnitStats,'ncnk',EXP,119)//ncnk -> Centaur Khan
	call SaveInteger(UnitStats,'ncen',BOUNTYL,20)	//Centaur outrunner//ncen -> Centaur Outrunner
	call SaveInteger(UnitStats,'ncen',BOUNTYH,24)//ncen -> Centaur Outrunner
	call SaveInteger(UnitStats,'ncen',EXP,41)//ncen -> Centaur Outrunner
	
	call SaveInteger(UnitStats,'ngns',BOUNTYL,21)	//Gnoll Assassin//ngns -> Gnoll Assassin
	call SaveInteger(UnitStats,'ngns',BOUNTYH,29)//ngns -> Gnoll Assassin
	call SaveInteger(UnitStats,'ngns',EXP,41)//ngns -> Gnoll Assassin
	
	call SaveInteger(UnitStats,'nfpu',BOUNTYL,76)	//Polar Furbolg Ursa Warrior//nfpu -> Polar Furbolg Ursa Warrior
	call SaveInteger(UnitStats,'nfpu',BOUNTYH,86)//nfpu -> Polar Furbolg Ursa Warrior
	call SaveInteger(UnitStats,'nfpu',EXP,119)//nfpu -> Polar Furbolg Ursa Warrior
	call SaveInteger(UnitStats,'nfpc',BOUNTYL,45)	//Polar Furbolg Champion//nfpc -> Polar Furbolg Champion
	call SaveInteger(UnitStats,'nfpc',BOUNTYH,55)//nfpc -> Polar Furbolg Champion
	call SaveInteger(UnitStats,'nfpc',EXP,88)//nfpc -> Polar Furbolg Champion
	
	call SaveInteger(UnitStats,'n0HW',BOUNTYL,24)	//Harpy Scout//n0HW -> Harpy Scout
	call SaveInteger(UnitStats,'n0HW',BOUNTYH,27)//n0HW -> Harpy Scout
	call SaveInteger(UnitStats,'n0HW',EXP,41)//n0HW -> Harpy Scout
	call SaveInteger(UnitStats,'n0HX',BOUNTYL,34)	//Harpy Storm//n0HX -> Harpy Storm
	call SaveInteger(UnitStats,'n0HX',BOUNTYH,37)//n0HX -> Harpy Storm
	call SaveInteger(UnitStats,'n0HX',EXP,62)//n0HX -> Harpy Storm
	
	call SaveInteger(UnitStats,'ngh1',BOUNTYL,30)	//Ghost//ngh1 -> Ghost
	call SaveInteger(UnitStats,'ngh1',BOUNTYH,40)//ngh1 -> Ghost
	call SaveInteger(UnitStats,'ngh1',EXP,62)//ngh1 -> Ghost
	call SaveInteger(UnitStats,'npfl',BOUNTYL,20)	//Fel Beast//npfl -> Fel Beast
	call SaveInteger(UnitStats,'npfl',BOUNTYH,24)//npfl -> Fel Beast
	call SaveInteger(UnitStats,'npfl',EXP,41)//npfl -> Fel Beast
	
	call SaveInteger(UnitStats,'nkot',BOUNTYL,17)	//Kobold Tunneler//nkot -> Kobold Tunneler
	call SaveInteger(UnitStats,'nkot',BOUNTYH,19)//nkot -> Kobold Tunneler
	call SaveInteger(UnitStats,'nkot',EXP,25)//nkot -> Kobold Tunneler
	call SaveInteger(UnitStats,'nkob',BOUNTYL,7)	//Kobold//nkob -> Kobold
	call SaveInteger(UnitStats,'nkob',BOUNTYH,9)//nkob -> Kobold
	call SaveInteger(UnitStats,'nkob',EXP,25)//nkob -> Kobold
	
	call SaveInteger(UnitStats,'nsat',BOUNTYL,15)	//Satyr Trickster//nsat -> Satyr Trickster
	call SaveInteger(UnitStats,'nsat',BOUNTYH,17)//nsat -> Satyr Trickster
	call SaveInteger(UnitStats,'nsat',EXP,41)//nsat -> Satyr Trickster
	call SaveInteger(UnitStats,'nstl',BOUNTYL,27)	//Satyr Soulstealer//nstl -> Satyr Soulstealer
	call SaveInteger(UnitStats,'nstl',BOUNTYH,33)//nstl -> Satyr Soulstealer
	call SaveInteger(UnitStats,'nstl',EXP,62)//nstl -> Satyr Soulstealer
	call SaveInteger(UnitStats,'nsth',BOUNTYL,77)	//Satyr Hellcaster//nsth -> Satyr Hellcaller
	call SaveInteger(UnitStats,'nsth',BOUNTYH,91)//nsth -> Satyr Hellcaller
	call SaveInteger(UnitStats,'nsth',EXP,119)//nsth -> Satyr Hellcaller
	
	call SaveInteger(UnitStats,'n00S',BOUNTYL,22)	//Alpha wolf//n00S -> Alpha Wolf
	call SaveInteger(UnitStats,'n00S',BOUNTYH,26)//n00S -> Alpha Wolf
	call SaveInteger(UnitStats,'n00S',EXP,62)//n00S -> Alpha Wolf
	call SaveInteger(UnitStats,'nwlg',BOUNTYL,22)	//Giant wolf//nwlg -> Giant Wolf
	call SaveInteger(UnitStats,'nwlg',BOUNTYH,26)//nwlg -> Giant Wolf
	call SaveInteger(UnitStats,'nwlg',EXP,62)//nwlg -> Giant Wolf
	
	
	
	//Ancients
	call SaveInteger(UnitStats,'ngst',BOUNTYL,54)	//Rock golem//ngst -> Rock Golem
	call SaveInteger(UnitStats,'ngst',BOUNTYH,62)//ngst -> Rock Golem
	call SaveInteger(UnitStats,'ngst',EXP,119)//ngst -> Rock Golem
	call SaveInteger(UnitStats,'nggr',BOUNTYL,107)	//Emerald Golem//nggr -> Emerald Golem
	call SaveInteger(UnitStats,'nggr',BOUNTYH,121)//nggr -> Emerald Golem
	call SaveInteger(UnitStats,'nggr',EXP,155)//nggr -> Emerald Golem
	
	call SaveInteger(UnitStats,'nbwm',BOUNTYL,150)	//Black dragon//nbwm -> Black Dragon
	call SaveInteger(UnitStats,'nbwm',BOUNTYH,190)//nbwm -> Black Dragon
	call SaveInteger(UnitStats,'nbwm',EXP,155)//nbwm -> Black Dragon
	call SaveInteger(UnitStats,'nbdk',BOUNTYL,35)	//Black drake//nbdk -> Black Drake
	call SaveInteger(UnitStats,'nbdk',BOUNTYH,45)//nbdk -> Black Drake
	call SaveInteger(UnitStats,'nbdk',EXP,62)//nbdk -> Black Drake
	
	call SaveInteger(UnitStats,'njga',BOUNTYL,152)	//Elder Jungle stalker//njga -> Elder Jungle Stalker
	call SaveInteger(UnitStats,'njga',BOUNTYH,170)//njga -> Elder Jungle Stalker
	call SaveInteger(UnitStats,'njga',EXP,155)//njga -> Elder Jungle Stalker
	call SaveInteger(UnitStats,'njg1',BOUNTYL,52)	//Jungle Stalker//njg1 -> Jungle Stalker
	call SaveInteger(UnitStats,'njg1',BOUNTYH,70)//njg1 -> Jungle Stalker
	call SaveInteger(UnitStats,'njg1',EXP,119)//njg1 -> Jungle Stalker
	
	call SaveInteger(UnitStats,'nbdo',BOUNTYL,86)	//Blue Dragonspawn overseer//nbdo -> Blue Dragonspawn Overseer
	call SaveInteger(UnitStats,'nbdo',BOUNTYH,98)//nbdo -> Blue Dragonspawn Overseer
	call SaveInteger(UnitStats,'nbdo',EXP,119)//nbdo -> Blue Dragonspawn Overseer
	call SaveInteger(UnitStats,'nbds',BOUNTYL,74)	//Blue Dragonspawn Sorcerer//nbds -> Blue Dragonspawn Sorcerer
	call SaveInteger(UnitStats,'nbds',BOUNTYH,82)//nbds -> Blue Dragonspawn Sorcerer
	call SaveInteger(UnitStats,'nbds',EXP,62)//nbds -> Blue Dragonspawn Sorcerer
	
	call SaveInteger(UnitStats,'n0LC',BOUNTYL,89)	//Thunder Lizard big//n0LC -> Thunder Lizard
	call SaveInteger(UnitStats,'n0LC',BOUNTYH,97)//n0LC -> Thunder Lizard
	call SaveInteger(UnitStats,'n0LC',EXP,155)//n0LC -> Thunder Lizard
	call SaveInteger(UnitStats,'n0LD',BOUNTYL,61)	//Thunder Lizard//n0LD -> Thunder Lizard
	call SaveInteger(UnitStats,'n0LD',BOUNTYH,69)//n0LD -> Thunder Lizard
	call SaveInteger(UnitStats,'n0LD',EXP,119)//n0LD -> Thunder Lizard
//super creeps
	call SaveInteger(UnitStats,'n003',BOUNTYL,106)	//Siege golem//n003 -> Siege Golem
	call SaveInteger(UnitStats,'n003',BOUNTYH,700)//n003 -> Siege Golem
	call SaveInteger(UnitStats,'n003',EXP,349)//n003 -> Siege Golem
	call SaveInteger(UnitStats,'n00E',BOUNTYL,158)	//Scary Fish//n00E -> Scary Fish
	call SaveInteger(UnitStats,'n00E',BOUNTYH,950)//n00E -> Scary Fish
	call SaveInteger(UnitStats,'n00E',EXP,410)//n00E -> Scary Fish
	call SaveInteger(UnitStats,'n00D',BOUNTYL,111)	//Ancient Hydra//n00D -> Ancient Hydra
	call SaveInteger(UnitStats,'n00D',BOUNTYH,1200)//n00D -> Ancient Hydra
	call SaveInteger(UnitStats,'n00D',EXP,476)//n00D -> Ancient Hydra
	
	//Roshan
	call SaveInteger(UnitStats,'n00L',BOUNTYL,150)	//Roshan//n00L -> Roshan
	call SaveInteger(UnitStats,'n00L',BOUNTYH,400)//n00L -> Roshan
	call SaveInteger(UnitStats,'n00L',EXP,1789)//n00L -> Roshan
	
	//Summons
	//Rexxar
	call SaveInteger(UnitStats,'h308',BOUNTYL,30)	//Hawk//h308 -> Hawk
	call SaveInteger(UnitStats,'h308',BOUNTYH,30)//h308 -> Hawk
	call SaveInteger(UnitStats,'h308',EXP,155)//h308 -> Hawk
	call SaveInteger(UnitStats,'n01Q',BOUNTYL,40)	//Scout Hawk//n01Q -> Scout Hawk
	call SaveInteger(UnitStats,'n01Q',BOUNTYH,40)//n01Q -> Scout Hawk
	call SaveInteger(UnitStats,'n01Q',EXP,155)//n01Q -> Scout Hawk
	call SaveInteger(UnitStats,'n01R',BOUNTYL,50)	//Greater Scout Hawk//n01R -> Greater Hawk
	call SaveInteger(UnitStats,'n01R',BOUNTYH,50)//n01R -> Greater Hawk
	call SaveInteger(UnitStats,'n01R',EXP,155)//n01R -> Greater Hawk
	call SaveInteger(UnitStats,'h309',BOUNTYL,60)	//Legendary Hawk//h309 -> Legendary Hawk
	call SaveInteger(UnitStats,'h309',BOUNTYH,60)//h309 -> Legendary Hawk
	call SaveInteger(UnitStats,'h309',EXP,155)//h309 -> Legendary Hawk
	
	call SaveInteger(UnitStats,'h30A',BOUNTYL,26)	//Baby Quilbeast//h30A -> Baby Quilbeast
	call SaveInteger(UnitStats,'h30A',BOUNTYH,38)//h30A -> Baby Quilbeast
	call SaveInteger(UnitStats,'h30A',EXP,119)//h30A -> Baby Quilbeast
	call SaveInteger(UnitStats,'n01M',BOUNTYL,26)	//Quilbeast//n01M -> Quilbeast
	call SaveInteger(UnitStats,'n01M',BOUNTYH,38)//n01M -> Quilbeast
	call SaveInteger(UnitStats,'n01M',EXP,119)//n01M -> Quilbeast
	call SaveInteger(UnitStats,'n01S',BOUNTYL,26)	//Greater Quilbeast//n01S -> Greater Quilbeast
	call SaveInteger(UnitStats,'n01S',BOUNTYH,38)//n01S -> Greater Quilbeast
	call SaveInteger(UnitStats,'n01S',EXP,119)//n01S -> Greater Quilbeast
	call SaveInteger(UnitStats,'h30B',BOUNTYL,26)	//Legendary Quilbeast//h30B -> Legendary Quilbeast
	call SaveInteger(UnitStats,'h30B',BOUNTYH,38)//h30B -> Legendary Quilbeast
	call SaveInteger(UnitStats,'h30B',EXP,119)//h30B -> Legendary Quilbeast
	
	//Techies
	
	call SaveInteger(UnitStats,'n00O',EXP,14)//land mines 1-4//n00O -> Goblin Land Mine
	call SaveInteger(UnitStats,'n00P',EXP,14)//n00P -> Goblin Land Mine
	call SaveInteger(UnitStats,'n00Q',EXP,14)//n00Q -> Goblin Land Mine
	call SaveInteger(UnitStats,'n00N',EXP,14)//n00N -> Goblin Land Mine
	call SaveInteger(UnitStats,'n00O',BOUNTYL,10)
	call SaveInteger(UnitStats,'n00O',BOUNTYH,10)
	call SaveInteger(UnitStats,'n00P',BOUNTYL,10)
	call SaveInteger(UnitStats,'n00P',BOUNTYH,10)
	call SaveInteger(UnitStats,'n00Q',BOUNTYL,10)
	call SaveInteger(UnitStats,'n00Q',BOUNTYH,10)
	call SaveInteger(UnitStats,'n00N',BOUNTYL,10)
	call SaveInteger(UnitStats,'n00N',BOUNTYH,10)
	
	call SaveInteger(UnitStats,'otot',EXP,12)//stasis//otot -> Stasis Trap
	call SaveInteger(UnitStats,'otot',BOUNTYL,10)
	call SaveInteger(UnitStats,'otot',BOUNTYH,10)
	
	call SaveInteger(UnitStats,'o01B',EXP,12)//remote mines 1-4//o01B -> Remote Mine
	call SaveInteger(UnitStats,'o018',EXP,12)//o018 -> Remote Mine
	call SaveInteger(UnitStats,'o00B',EXP,12)//o00B -> Remote Mine
	call SaveInteger(UnitStats,'o002',EXP,12)//o002 -> Remote Mine
	call SaveInteger(UnitStats,'o01B',BOUNTYL,10)
	call SaveInteger(UnitStats,'o01B',BOUNTYH,10)
	call SaveInteger(UnitStats,'o018',BOUNTYL,10)
	call SaveInteger(UnitStats,'o018',BOUNTYH,10)
	call SaveInteger(UnitStats,'o00B',BOUNTYL,10)
	call SaveInteger(UnitStats,'o00B',BOUNTYH,10)
	call SaveInteger(UnitStats,'o002',BOUNTYL,10)
	call SaveInteger(UnitStats,'o002',BOUNTYH,10)
	
	//Templar assassin
	call SaveInteger(UnitStats,'e020',BOUNTYL,1)	//Psionic Trap//e020 -> Psionic Trap
	call SaveInteger(UnitStats,'e020',BOUNTYH,1)//e020 -> Psionic Trap
	call SaveInteger(UnitStats,'e020',EXP,24)//e020 -> Psionic Trap
	
	//Tuskar
	call SaveInteger(UnitStats,'o01J',BOUNTYL,90)	//Frozen Sigil 1//o01J -> Frozen Sigil 1
	call SaveInteger(UnitStats,'o01J',BOUNTYH,90)//o01J -> Frozen Sigil 1
	call SaveInteger(UnitStats,'o01K',BOUNTYL,100)	//Frozen Sigil 2//o01K -> Frozen Sigil 2
	call SaveInteger(UnitStats,'o01K',BOUNTYH,100)//o01K -> Frozen Sigil 2
	call SaveInteger(UnitStats,'o01L',BOUNTYL,110)	//Frozen Sigil 3//o01L -> Frozen Sigil 3
	call SaveInteger(UnitStats,'o01L',BOUNTYH,110)//o01L -> Frozen Sigil 3
	call SaveInteger(UnitStats,'o01M',BOUNTYL,120)	//Frozen Sigil 4//o01M -> Frozen Sigil 4
	call SaveInteger(UnitStats,'o01M',BOUNTYH,120)//o01M -> Frozen Sigil 4
	
	//Lone druid
	call SaveInteger(UnitStats,'n004',BOUNTYL,300)	//Spirit Bear 1//n004 -> Spirit Bear
	call SaveInteger(UnitStats,'n004',BOUNTYH,300)//n004 -> Spirit Bear
	call SaveInteger(UnitStats,'n004',EXP,300)//n004 -> Spirit Bear
	call SaveInteger(UnitStats,'n018',BOUNTYL,300)	//Spirit Bear 2//n018 -> Spirit Bear
	call SaveInteger(UnitStats,'n018',BOUNTYH,300)//n018 -> Spirit Bear
	call SaveInteger(UnitStats,'n018',EXP,300)//n018 -> Spirit Bear
	call SaveInteger(UnitStats,'n01C',BOUNTYL,300)	//Spirit Bear 3//n01C -> Spirit Bear
	call SaveInteger(UnitStats,'n01C',BOUNTYH,300)//n01C -> Spirit Bear
	call SaveInteger(UnitStats,'n01C',EXP,300)//n01C -> Spirit Bear
	call SaveInteger(UnitStats,'n01G',BOUNTYL,300)	//Spirit Bear 4//n01G -> Spirit Bear
	call SaveInteger(UnitStats,'n01G',BOUNTYH,300)//n01G -> Spirit Bear
	call SaveInteger(UnitStats,'n01G',EXP,300)//n01G -> Spirit Bear
	
	//Prophet furion
	call SaveInteger(UnitStats,'efon',BOUNTYL,14)	//Force of nature//efon -> Treant
	call SaveInteger(UnitStats,'efon',BOUNTYH,20)//efon -> Treant
	call SaveInteger(UnitStats,'efon',EXP,60)//efon -> Treant
	call SaveInteger(UnitStats,'efo2',BOUNTYL,14)	//wrath of nature mega treant//efo2 -> Mega Treant
	call SaveInteger(UnitStats,'efo2',BOUNTYH,20)//efo2 -> Mega Treant
	call SaveInteger(UnitStats,'efo2',EXP,60)//efo2 -> Mega Treant
	
	//Rhasta Shadow Shaman
	call SaveInteger(UnitStats,'osp4',BOUNTYL,26)	//Mass serpents 1//osp4 -> Serpent Ward
	call SaveInteger(UnitStats,'osp4',BOUNTYH,38)//osp4 -> Serpent Ward
	call SaveInteger(UnitStats,'osp4',EXP,62)//osp4 -> Serpent Ward
	call SaveInteger(UnitStats,'o008',BOUNTYL,26)	//Mass serpents 2//o008 -> Serpent Ward
	call SaveInteger(UnitStats,'o008',BOUNTYH,38)//o008 -> Serpent Ward
	call SaveInteger(UnitStats,'o008',EXP,62)//o008 -> Serpent Ward
	call SaveInteger(UnitStats,'o009',BOUNTYL,26)	//Mass serpents 3//o009 -> Serpent Ward
	call SaveInteger(UnitStats,'o009',BOUNTYH,38)//o009 -> Serpent Ward
	call SaveInteger(UnitStats,'o009',EXP,62)//o009 -> Serpent Ward
	call SaveInteger(UnitStats,'o01C',BOUNTYL,26)	//Mass serpents 1//o01C -> Serpent Ward
	call SaveInteger(UnitStats,'o01C',BOUNTYH,38)//o01C -> Serpent Ward
	call SaveInteger(UnitStats,'o01C',EXP,62)//o01C -> Serpent Ward
	call SaveInteger(UnitStats,'o01D',BOUNTYL,26)	//Mass serpents 2//o01D -> Serpent Ward
	call SaveInteger(UnitStats,'o01D',BOUNTYH,38)//o01D -> Serpent Ward
	call SaveInteger(UnitStats,'o01D',EXP,62)//o01D -> Serpent Ward
	call SaveInteger(UnitStats,'o01E',BOUNTYL,26)	//Mass serpents 3//o01E -> Serpent Ward
	call SaveInteger(UnitStats,'o01E',BOUNTYH,38)//o01E -> Serpent Ward
	call SaveInteger(UnitStats,'o01E',EXP,62)//o01E -> Serpent Ward
	
	//Lycan Wolf
	call SaveInteger(UnitStats,'o005',BOUNTYL,21)	//Wolves 1//o005 -> Lycanthropy Wolf 1
	call SaveInteger(UnitStats,'o005',BOUNTYH,21)//o005 -> Lycanthropy Wolf 1
	call SaveInteger(UnitStats,'o005',EXP,41)//o005 -> Lycanthropy Wolf 1
	call SaveInteger(UnitStats,'o006',BOUNTYL,26)	//Wolves 2//o006 -> Lycanthropy Wolf 2
	call SaveInteger(UnitStats,'o006',BOUNTYH,26)//o006 -> Lycanthropy Wolf 2
	call SaveInteger(UnitStats,'o006',EXP,41)//o006 -> Lycanthropy Wolf 2
	call SaveInteger(UnitStats,'o007',BOUNTYL,36)	//Wolves 3//o007 -> Lycanthropy Wolf 3
	call SaveInteger(UnitStats,'o007',BOUNTYH,36)//o007 -> Lycanthropy Wolf 3
	call SaveInteger(UnitStats,'o007',EXP,41)//o007 -> Lycanthropy Wolf 3
	call SaveInteger(UnitStats,'o00F',BOUNTYL,41)	//Wolves 4//o00F -> Lycanthropy Wolf 4
	call SaveInteger(UnitStats,'o00F',BOUNTYH,41)//o00F -> Lycanthropy Wolf 4
	call SaveInteger(UnitStats,'o00F',EXP,41)//o00F -> Lycanthropy Wolf 4
	
	//urna swarm
	call SaveInteger(UnitStats,'u012',BOUNTYL,26)//little bitches urna swarm//u012 -> Scarab
	call SaveInteger(UnitStats,'u012',BOUNTYH,38)//u012 -> Scarab
	call SaveInteger(UnitStats,'u012',EXP,41)//u012 -> Scarab
	
	//Undying old zombie
	call SaveInteger(UnitStats,'n020',BOUNTYL,14)	//Raise dead//n020 -> Living Dead
	call SaveInteger(UnitStats,'n020',BOUNTYH,28)//n020 -> Living Dead
	call SaveInteger(UnitStats,'n020',EXP,62)//n020 -> Living Dead
	
	call SaveInteger(UnitStats,'n0FJ',BOUNTYL,75)	//Tombstone 1//n0FJ -> Tombstone - Level 1
	call SaveInteger(UnitStats,'n0FJ',BOUNTYH,75)//n0FJ -> Tombstone - Level 1
	call SaveInteger(UnitStats,'n0FJ',EXP,88)//n0FJ -> Tombstone - Level 1
	call SaveInteger(UnitStats,'n0FI',BOUNTYL,100)	//Tombstone 2//n0FI -> Tombstone - Level 2
	call SaveInteger(UnitStats,'n0FI',BOUNTYH,100)//n0FI -> Tombstone - Level 2
	call SaveInteger(UnitStats,'n0FI',EXP,88)//n0FI -> Tombstone - Level 2
	call SaveInteger(UnitStats,'n0F6',BOUNTYL,125)	//Tombstone 3//n0F6 -> Tombstone - Level 3
	call SaveInteger(UnitStats,'n0F6',BOUNTYH,125)//n0F6 -> Tombstone - Level 3
	call SaveInteger(UnitStats,'n0F6',EXP,88)//n0F6 -> Tombstone - Level 3
	call SaveInteger(UnitStats,'n0FH',BOUNTYL,150)	//Tombstone 4//n0FH -> Tombstone - Level 4
	call SaveInteger(UnitStats,'n0FH',BOUNTYH,150)//n0FH -> Tombstone - Level 4
	call SaveInteger(UnitStats,'n0FH',EXP,88)//n0FH -> Tombstone - Level 4
	
	call SaveInteger(UnitStats,'h0CH',BOUNTYL,20)	//Homing missile//h0CH -> Seeking Missle - 4
	call SaveInteger(UnitStats,'h0CH',BOUNTYH,30)//h0CH -> Seeking Missle - 4
	call SaveInteger(UnitStats,'h0CH',EXP,40)//h0CH -> Seeking Missle - 4
	call SaveInteger(UnitStats,'h0CF',BOUNTYL,20)	//Homing missile//h0CF -> Seeking Missle - 3
	call SaveInteger(UnitStats,'h0CF',BOUNTYH,30)//h0CF -> Seeking Missle - 3
	call SaveInteger(UnitStats,'h0CF',EXP,40)//h0CF -> Seeking Missle - 3
	call SaveInteger(UnitStats,'h0C1',BOUNTYL,20)	//Homing missile//h0C1 -> Seeking Missle - 2
	call SaveInteger(UnitStats,'h0C1',BOUNTYH,30)//h0C1 -> Seeking Missle - 2
	call SaveInteger(UnitStats,'h0C1',EXP,40)//h0C1 -> Seeking Missle - 2
	call SaveInteger(UnitStats,'h0CG',BOUNTYL,20)	//Homing missile//h0CG -> Seeking Missle - 1
	call SaveInteger(UnitStats,'h0CG',BOUNTYH,30)//h0CG -> Seeking Missle - 1
	call SaveInteger(UnitStats,'h0CG',EXP,40)//h0CG -> Seeking Missle - 1
	
	//Brood
	call SaveInteger(UnitStats,'n019',BOUNTYL,11)	//Spiderling//n019 -> Spiderling
	call SaveInteger(UnitStats,'n019',BOUNTYH,13)//n019 -> Spiderling
	call SaveInteger(UnitStats,'n019',EXP,62)//n019 -> Spiderling
	call SaveInteger(UnitStats,'n01E',BOUNTYL,16)	//Spiderite//n01E -> Spiderite
	call SaveInteger(UnitStats,'n01E',BOUNTYH,21)//n01E -> Spiderite
	call SaveInteger(UnitStats,'n01E',EXP,41)//n01E -> Spiderite
	
	//Weaver
	call SaveInteger(UnitStats,'u01K',BOUNTYL,32)	//Swarm 1//u01K -> Beetle - Level 1
	call SaveInteger(UnitStats,'u01K',BOUNTYH,34)//u01K -> Beetle - Level 1
	call SaveInteger(UnitStats,'u01K',EXP,41)//u01K -> Beetle - Level 1
	call SaveInteger(UnitStats,'u01H',BOUNTYL,32)	//Swarm 2//u01H -> Beetle - Level 2
	call SaveInteger(UnitStats,'u01H',BOUNTYH,34)//u01H -> Beetle - Level 2
	call SaveInteger(UnitStats,'u01H',EXP,41)//u01H -> Beetle - Level 2
	call SaveInteger(UnitStats,'u01J',BOUNTYL,32)	//Swarm 3//u01J -> Beetle - Level 3
	call SaveInteger(UnitStats,'u01J',BOUNTYH,34)//u01J -> Beetle - Level 3
	call SaveInteger(UnitStats,'u01J',EXP,41)//u01J -> Beetle - Level 3
	call SaveInteger(UnitStats,'u01L',BOUNTYL,32)	//Swarm 4//u01L -> Beetle - Level 4
	call SaveInteger(UnitStats,'u01L',BOUNTYH,34)//u01L -> Beetle - Level 4
	call SaveInteger(UnitStats,'u01L',EXP,41)//u01L -> Beetle - Level 4
	
	//Venomancer
	call SaveInteger(UnitStats,'o00T',BOUNTYL,14)	//Plague ward 1//o00T -> Plague Ward 1
	call SaveInteger(UnitStats,'o00T',BOUNTYH,17)//o00T -> Plague Ward 1
	call SaveInteger(UnitStats,'o00T',EXP,40)//o00T -> Plague Ward 1
	call SaveInteger(UnitStats,'o00U',BOUNTYL,14)	//Plague ward 2//o00U -> Plague Ward 2
	call SaveInteger(UnitStats,'o00U',BOUNTYH,17)//o00U -> Plague Ward 2
	call SaveInteger(UnitStats,'o00U',EXP,50)//o00U -> Plague Ward 2
	call SaveInteger(UnitStats,'o00V',BOUNTYL,14)	//Plague ward 3//o00V -> Plague Ward 3
	call SaveInteger(UnitStats,'o00V',BOUNTYH,17)//o00V -> Plague Ward 3
	call SaveInteger(UnitStats,'o00V',EXP,60)//o00V -> Plague Ward 3
	call SaveInteger(UnitStats,'o00W',BOUNTYL,14)	//Plague ward 4//o00W -> Plague Ward 4
	call SaveInteger(UnitStats,'o00W',BOUNTYH,17)//o00W -> Plague Ward 4
	call SaveInteger(UnitStats,'o00W',EXP,70)//o00W -> Plague Ward 4
	
	//Enigma
	call SaveInteger(UnitStats,'hwat',BOUNTYL,22)	//Lesser eidolon//hwat -> Lesser Eidolon
	call SaveInteger(UnitStats,'hwat',BOUNTYH,36)//hwat -> Lesser Eidolon
	call SaveInteger(UnitStats,'hwat',EXP,25)//hwat -> Lesser Eidolon
	call SaveInteger(UnitStats,'hwt2',BOUNTYL,22)	//Eidolon//hwt2 -> Eidolon
	call SaveInteger(UnitStats,'hwt2',BOUNTYH,36)//hwt2 -> Eidolon
	call SaveInteger(UnitStats,'hwt2',EXP,25)//hwt2 -> Eidolon
	call SaveInteger(UnitStats,'hwt3',BOUNTYL,22)	//Greater eidolon//hwt3 -> Greater Eidolon
	call SaveInteger(UnitStats,'hwt3',BOUNTYH,36)//hwt3 -> Greater Eidolon
	call SaveInteger(UnitStats,'hwt3',EXP,25)//hwt3 -> Greater Eidolon
	call SaveInteger(UnitStats,'h006',BOUNTYL,22)	//Dire eidolon//h006 -> Dire Eidolon
	call SaveInteger(UnitStats,'h006',BOUNTYH,36)//h006 -> Dire Eidolon
	call SaveInteger(UnitStats,'h006',EXP,25)//h006 -> Dire Eidolon
	
	//Oblivion Pugna
	call SaveInteger(UnitStats,'o00M',BOUNTYL,20)	//Nether ward 1//o00M -> Nether Ward 1
	call SaveInteger(UnitStats,'o00M',BOUNTYH,20)//o00M -> Nether Ward 1
	call SaveInteger(UnitStats,'o00L',BOUNTYL,40)	//Nether ward 2//o00L -> Nether Ward 2
	call SaveInteger(UnitStats,'o00L',BOUNTYH,40)//o00L -> Nether Ward 2
	call SaveInteger(UnitStats,'o00O',BOUNTYL,60)	//Nether ward 3//o00O -> Nether Ward 3
	call SaveInteger(UnitStats,'o00O',BOUNTYH,60)//o00O -> Nether Ward 3
	call SaveInteger(UnitStats,'o00N',BOUNTYL,80)	//Nether ward 4//o00N -> Nether Ward 4
	call SaveInteger(UnitStats,'o00N',BOUNTYH,80)//o00N -> Nether Ward 4
	
	//Warlock WL
	call SaveInteger(UnitStats,'n00U',BOUNTYL,100)	//Rain of Chaos 1//n00U -> Infernal
	call SaveInteger(UnitStats,'n00U',BOUNTYH,100)//n00U -> Infernal
	call SaveInteger(UnitStats,'n00U',EXP,196)//n00U -> Infernal
	call SaveInteger(UnitStats,'n00Y',BOUNTYL,150)	//Rain of Chaos 2//n00Y -> Infernal
	call SaveInteger(UnitStats,'n00Y',BOUNTYH,150)//n00Y -> Infernal
	call SaveInteger(UnitStats,'n00Y',EXP,196)//n00Y -> Infernal
	call SaveInteger(UnitStats,'n00Z',BOUNTYL,200)	//Rain of Chaos 3//n00Z -> Infernal
	call SaveInteger(UnitStats,'n00Z',BOUNTYH,200)//n00Z -> Infernal
	call SaveInteger(UnitStats,'n00Z',EXP,196)//n00Z -> Infernal
	
	call SaveInteger(UnitStats,'n0KU',BOUNTYL,50)	//Rain of Chaos upg 1//n0KU -> Infernal
	call SaveInteger(UnitStats,'n0KU',BOUNTYH,50)//n0KU -> Infernal
	call SaveInteger(UnitStats,'n0KU',EXP,196)//n0KU -> Infernal
	call SaveInteger(UnitStats,'n0KV',BOUNTYL,75)	//Rain of Chaos upg 2//n0KV -> Infernal
	call SaveInteger(UnitStats,'n0KV',BOUNTYH,75)//n0KV -> Infernal
	call SaveInteger(UnitStats,'n0KV',EXP,196)//n0KV -> Infernal
	call SaveInteger(UnitStats,'n0KW',BOUNTYL,100)	//Rain of Chaos upg 3//n0KW -> Infernal
	call SaveInteger(UnitStats,'n0KW',BOUNTYH,100)//n0KW -> Infernal
	call SaveInteger(UnitStats,'n0KW',EXP,196)//n0KW -> Infernal
	
	//Invoker Forge
	call SaveInteger(UnitStats,'n027',BOUNTYL,32)	//Forge spirit//n027 -> Forged Spirit
	call SaveInteger(UnitStats,'n027',BOUNTYH,46)//n027 -> Forged Spirit
	call SaveInteger(UnitStats,'n027',EXP,62)//n027 -> Forged Spirit
	
	call SaveInteger(UnitStats,'fRG1',BOUNTYL,32)	//Forge spirit//fRG1 -> Forged Spirit
	call SaveInteger(UnitStats,'fRG1',BOUNTYH,46)//fRG1 -> Forged Spirit
	call SaveInteger(UnitStats,'fRG1',EXP,62)//fRG1 -> Forged Spirit
	
	call SaveInteger(UnitStats,'fRG2',BOUNTYL,32)	//Forge spirit//fRG2 -> Forged Spirit
	call SaveInteger(UnitStats,'fRG2',BOUNTYH,46)//fRG2 -> Forged Spirit
	call SaveInteger(UnitStats,'fRG2',EXP,62)//fRG2 -> Forged Spirit
	
	call SaveInteger(UnitStats,'fRG3',BOUNTYL,32)	//Forge spirit//fRG3 -> Forged Spirit
	call SaveInteger(UnitStats,'fRG3',BOUNTYH,46)//fRG3 -> Forged Spirit
	call SaveInteger(UnitStats,'fRG3',EXP,62)//fRG3 -> Forged Spirit
	
	call SaveInteger(UnitStats,'fRG4',BOUNTYL,32)	//Forge spirit//fRG4 -> Forged Spirit
	call SaveInteger(UnitStats,'fRG4',BOUNTYH,46)//fRG4 -> Forged Spirit
	call SaveInteger(UnitStats,'fRG4',EXP,62)//fRG4 -> Forged Spirit
	
	//Visage
	call SaveInteger(UnitStats,'u014',BOUNTYL,100)	//Familiar 1-1//u014 -> Familiar
	call SaveInteger(UnitStats,'u014',BOUNTYH,100)//u014 -> Familiar
	call SaveInteger(UnitStats,'u014',EXP,41)//u014 -> Familiar
	call SaveInteger(UnitStats,'u01D',BOUNTYL,100)	//Familiar 1-2//u01D -> Familiar
	call SaveInteger(UnitStats,'u01D',BOUNTYH,100)//u01D -> Familiar
	call SaveInteger(UnitStats,'u01D',EXP,41)//u01D -> Familiar
	call SaveInteger(UnitStats,'u01R',BOUNTYL,100)	//Familiar 1-3//u01R -> Familiar
	call SaveInteger(UnitStats,'u01R',BOUNTYH,100)//u01R -> Familiar
	call SaveInteger(UnitStats,'u01R',EXP,41)//u01R -> Familiar
	
	call SaveInteger(UnitStats,'u015',BOUNTYL,100)	//Familiar 2-1//u015 -> Familiar
	call SaveInteger(UnitStats,'u015',BOUNTYH,100)//u015 -> Familiar
	call SaveInteger(UnitStats,'u015',EXP,41)//u015 -> Familiar
	call SaveInteger(UnitStats,'u01E',BOUNTYL,100)	//Familiar 2-2//u01E -> Familiar
	call SaveInteger(UnitStats,'u01E',BOUNTYH,100)//u01E -> Familiar
	call SaveInteger(UnitStats,'u01E',EXP,41)//u01E -> Familiar
	call SaveInteger(UnitStats,'u01S',BOUNTYL,100)	//Familiar 2-3//u01S -> Familiar
	call SaveInteger(UnitStats,'u01S',BOUNTYH,100)//u01S -> Familiar
	call SaveInteger(UnitStats,'u01S',EXP,41)//u01S -> Familiar
	
	call SaveInteger(UnitStats,'u016',BOUNTYL,100)	//Familiar 3-1//u016 -> Familiar
	call SaveInteger(UnitStats,'u016',BOUNTYH,100)//u016 -> Familiar
	call SaveInteger(UnitStats,'u016',EXP,41)//u016 -> Familiar
	call SaveInteger(UnitStats,'u01F',BOUNTYL,100)	//Familiar 3-2//u01F -> Familiar
	call SaveInteger(UnitStats,'u01F',BOUNTYH,100)//u01F -> Familiar
	call SaveInteger(UnitStats,'u01F',EXP,41)//u01F -> Familiar
	call SaveInteger(UnitStats,'u01T',BOUNTYL,100)	//Familiar 3-3//u01T -> Familiar
	call SaveInteger(UnitStats,'u01T',BOUNTYH,100)//u01T -> Familiar
	call SaveInteger(UnitStats,'u01T',EXP,41)//u01T -> Familiar
	
	//Items
	
	
	//Necro
	call SaveInteger(UnitStats,'n00J',BOUNTYL,100)	//warrior 1//n00J -> Necronomicon Warrior 1
	call SaveInteger(UnitStats,'n00J',BOUNTYH,100)//n00J -> Necronomicon Warrior 1
	call SaveInteger(UnitStats,'n00J',EXP,200)//n00J -> Necronomicon Warrior 1
	call SaveInteger(UnitStats,'n00H',BOUNTYL,100)	//archer 1//n00H -> Necronomicon Archer 1
	call SaveInteger(UnitStats,'n00H',BOUNTYH,100)//n00H -> Necronomicon Archer 1
	call SaveInteger(UnitStats,'n00H',EXP,200)//n00H -> Necronomicon Archer 1
	call SaveInteger(UnitStats,'n00A',BOUNTYL,150)	//warrior 2//n00A -> Necronomicon Warrior 2
	call SaveInteger(UnitStats,'n00A',BOUNTYH,150)//n00A -> Necronomicon Warrior 2
	call SaveInteger(UnitStats,'n00A',EXP,300)//n00A -> Necronomicon Warrior 2
	call SaveInteger(UnitStats,'n00G',BOUNTYL,150)	//archer 2//n00G -> Necronomicon Archer 2
	call SaveInteger(UnitStats,'n00G',BOUNTYH,150)//n00G -> Necronomicon Archer 2
	call SaveInteger(UnitStats,'n00G',EXP,300)//n00G -> Necronomicon Archer 2
	call SaveInteger(UnitStats,'n006',BOUNTYL,200)	//warrior 3//n006 -> Necronomicon Warrior 3
	call SaveInteger(UnitStats,'n006',BOUNTYH,200)//n006 -> Necronomicon Warrior 3
	call SaveInteger(UnitStats,'n006',EXP,400)//n006 -> Necronomicon Warrior 3
	call SaveInteger(UnitStats,'n00K',BOUNTYL,200)	//archer 3//n00K -> Necronomicon Archer 3
	call SaveInteger(UnitStats,'n00K',BOUNTYH,200)//n00K -> Necronomicon Archer 3
	call SaveInteger(UnitStats,'n00K',EXP,400)//n00K -> Necronomicon Archer 3
	
	call SaveInteger(UnitStats,'o004',BOUNTYL,50)	//observer wards//o004 -> Observer Ward
	call SaveInteger(UnitStats,'o004',BOUNTYH,50)//o004 -> Observer Ward
	call SaveInteger(UnitStats,'o004',EXP,100)//o004 -> Observer Ward
endfunction

function StoreAllTints takes nothing returns nothing
	call UMD_SaveTints('o007',20,20,20)//o007 -> Lycanthropy Wolf 3
	call UMD_SaveTints('o00F',20,20,20)//o00F -> Lycanthropy Wolf 4
	call UMD_SaveTints('E031',50,50,50)//E031 -> Edgewalker
	call UMD_SaveTints('h05C',50,100,-1)//h05C -> Lion
	call UMD_SaveTints('n0F7',50,50,50)//n0F7 -> Living Dead
	call UMD_SaveTints('n0F8',50,50,50)//n0F8 -> Living Dead
	call UMD_SaveTints('UC18',50,100,-1)//UC18 -> Demon Witch
	call UMD_SaveTints('e02S',75,-1,75)//e02S -> Mini Viper
	call UMD_SaveTints('EC77',75,-1,25)//EC77 -> Netherdrake
	call UMD_SaveTints('h05T',75,-1,25)//h05T -> Viper
	call UMD_SaveTints('h003',100,100,100)//h003 -> Shadow Dagger
	call UMD_SaveTints('h05M',100,125,100)//h05M -> Leoric
	call UMD_SaveTints('h05V',100,100,100)//h05V -> N'aix
	call UMD_SaveTints('NC00',100,125,100)//NC00 -> Skeleton King
	call UMD_SaveTints('ndtr',100,200,-1)//ndtr -> Dark Troll
	call UMD_SaveTints('ngns',100,100,-1)//ngns -> Gnoll Assassin
	call UMD_SaveTints('U00C',100,100,100)//U00C -> Lifestealer
	call UMD_SaveTints('u00V',100,100,100)//u00V -> Hookshot Link
	call UMD_SaveTints('u01N',100,100,100)//u01N -> PreRune
	call UMD_SaveTints('u01Q',100,100,100)//u01Q -> Timber Chain Link
	call UMD_SaveTints('ngh1',110,150,-1)//ngh1 -> Ghost
	call UMD_SaveTints('n010',125,125,125)//n010 -> Earth Level 3
	call UMD_SaveTints('n011',125,125,125)//n011 -> Fire
	call UMD_SaveTints('n012',125,125,125)//n012 -> Storm Level 3
	call UMD_SaveTints('n0F6',125,125,125)//n0F6 -> Tombstone - Level 3
	call UMD_SaveTints('n0FH',125,125,125)//n0FH -> Tombstone - Level 4
	call UMD_SaveTints('n0FI',125,125,125)//n0FI -> Tombstone - Level 2
	call UMD_SaveTints('n0FJ',125,125,125)//n0FJ -> Tombstone - Level 1
	call UMD_SaveTints('n0GZ',125,125,125)//n0GZ -> Earth Level 4
	call UMD_SaveTints('n0H0',125,125,125)//n0H0 -> Fire
	call UMD_SaveTints('n0H1',125,125,125)//n0H1 -> Storm Level 4
	call UMD_SaveTints('npn1',125,125,125)//npn1 -> Fire
	call UMD_SaveTints('npn2',125,125,125)//npn2 -> Storm Level 1
	call UMD_SaveTints('npn3',125,125,125)//npn3 -> Earth
	call UMD_SaveTints('npn4',125,125,125)//npn4 -> Fire
	call UMD_SaveTints('npn5',125,125,125)//npn5 -> Storm Level 2
	call UMD_SaveTints('npn6',125,125,125)//npn6 -> Earth
	call UMD_SaveTints('h047',130,100,-1)//h047 -> Rikimaru
	call UMD_SaveTints('HC92',130,100,-1)//HC92 -> Stealth Assassin
	call UMD_SaveTints('nfsh',130,-1,130)//nfsh -> Forest Troll High Priest
	call UMD_SaveTints('nftb',130,-1,130)//nftb -> Forest Troll Berserker
	call UMD_SaveTints('EC57',150,200,-1)//EC57 -> Venomancer
	call UMD_SaveTints('h05E',150,150,100)//h05E -> Magnus
	call UMD_SaveTints('h05Y',150,0,150)//h05Y -> Atropos
	call UMD_SaveTints('h07M',150,150,150)//h07M -> Venomous Gale FX1
	call UMD_SaveTints('h07N',150,150,150)//h07N -> Venomous Gale FX2
	call UMD_SaveTints('h07O',150,150,150)//h07O -> Venomous Gale FX3
	call UMD_SaveTints('h0B2',150,150,150)//h0B2 -> DarkPact FX
	call UMD_SaveTints('h0B3',150,150,150)//h0B3 -> Gust FX
	call UMD_SaveTints('h0B5',150,150,150)//h0B5 -> Boomerang FX
	call UMD_SaveTints('n00L',150,100,-1)//n00L -> Roshan
	call UMD_SaveTints('n026',150,110,70)//n026 -> Mud Golem
	call UMD_SaveTints('n0LD',150,150,150)//n0LD -> Thunder Lizard
	call UMD_SaveTints('ndr3',150,150,150)//ndr3 -> Greater Dark Minion
	call UMD_SaveTints('njga',150,150,150)//njga -> Elder Jungle Stalker
	call UMD_SaveTints('nwlg',150,120,-1)//nwlg -> Giant Wolf
	call UMD_SaveTints('Oshd',150,0,150)//Oshd -> Bane Elemental
	call UMD_SaveTints('UC11',150,150,100)//UC11 -> Magnataur
	call UMD_SaveTints('UC60',150,150,150)//UC60 -> Necro'lic
	call UMD_SaveTints('nfa1',155,155,-1)//nfa1 -> Pocket Factory
	call UMD_SaveTints('nfa2',155,155,-1)//nfa2 -> Pocket Factory
	call UMD_SaveTints('nfac',155,155,-1)//nfac -> Pocket Factory
	call UMD_SaveTints('osw2',170,170,-1)
	call UMD_SaveTints('u012',170,170,-1)//u012 -> Scarab
	call UMD_SaveTints('u013',170,170,-1)//u013 -> Scarab
	call UMD_SaveTints('h05P',175,75,200)//h05P -> Slardar
	call UMD_SaveTints('u00O',175,175,-1)//u00O -> Icy Path
	call UMD_SaveTints('UC91',175,75,200)//UC91 -> Slithereen Guard
	call UMD_SaveTints('N01W',190,-1,-1)//N01W -> Shadow Priest
	call UMD_SaveTints('h070',200,-1,-1)//h070 -> Coco's Rum
	call UMD_SaveTints('n019',200,200,-1)//n019 -> Spiderling
	call UMD_SaveTints('n01E',200,150,-1)//n01E -> Spiderite
	call UMD_SaveTints('nanm',200,200,-1)//nanm -> Barbed Arachnathid
	call UMD_SaveTints('nbnb',200,200,-1)//nbnb -> Burrowed Barbed Arachnathid
	call UMD_SaveTints('ndr2',200,200,200)//ndr2 -> Dark Minion
	call UMD_SaveTints('nmrl',200,-1,200)//nmrl -> Murloc Tiderunner
	call UMD_SaveTints('o006',200,125,50)//o006 -> Lycanthropy Wolf 2
	call UMD_SaveTints('ndr1',230,230,230)//ndr1 -> Lesser Dark Minion
	call UMD_SaveTints('npfl',240,-1,240)//npfl -> Fel Beast
	call UMD_SaveTints('h066',250,150,150)//h066 -> Strygwyr
	call UMD_SaveTints('Hvsh',250,150,150)//Hvsh -> Bloodseeker
	call UMD_SaveTints('h06J',-1,25,100)//h06J -> BlinkStrike CK
	call UMD_SaveTints('h05H',-1,75,-1)//h05H -> Lycan
	call UMD_SaveTints('U008',-1,75,-1)//U008 -> Lycanthrope
	call UMD_SaveTints('E015',-1,100,-1)//E015 -> Lycanthrope
	call UMD_SaveTints('h00L',0,100,100)//h00L -> Shallow Grave
	call UMD_SaveTints('H004',-1,120,120)//H004 -> Slayer
	call UMD_SaveTints('h049',-1,120,120)//h049 -> Lina
	call UMD_SaveTints('n003',-1,120,180)//n003 -> Siege Golem
	call UMD_SaveTints('n09Z',-1,120,120)//n09Z -> Lina
	call UMD_SaveTints('nfpc',-1,120,150)//nfpc -> Polar Furbolg Champion
	call UMD_SaveTints('nsat',-1,120,-1)//nsat -> Satyr Trickster
	call UMD_SaveTints('nstl',-1,130,150)//nstl -> Satyr Soulstealer
	call UMD_SaveTints('nkot',-1,150,180)//nkot -> Kobold Tunneler
	call UMD_SaveTints('nowe',-1,150,150)//nowe -> Enraged Wildkin
	call UMD_SaveTints('nogm',-1,160,160)//nogm -> Ogre Mauler
	call UMD_SaveTints('o005',-1,170,170)//o005 -> Lycanthropy Wolf 1
	call UMD_SaveTints('osw3',-1,170,170)
	call UMD_SaveTints('H00E',-1,200,200)//H00E -> Dragon Knight
	call UMD_SaveTints('nbdk',-1,200,-1)//nbdk -> Black Drake
	call UMD_SaveTints('nbrg',-1,200,150)//nbrg -> Brigand
	call UMD_SaveTints('nbwm',-1,200,200)//nbwm -> Black Dragon
	call UMD_SaveTints('ndtw',-1,200,110)//ndtw -> Dark Troll Warlord
	call UMD_SaveTints('nmrm',-1,200,200)//nmrm -> Murloc Nightcrawler
	call UMD_SaveTints('Ubal',-1,200,200)//Ubal -> Nerubian Weaver
	call UMD_SaveTints('nsth',-1,-1,140)//nsth -> Satyr Hellcaller
	call UMD_SaveTints('EC45',0,-1,150)//EC45 -> Faceless Void
	call UMD_SaveTints('h05S',0,-1,150)//h05S -> Void
	call UMD_SaveTints('nggr',0,-1,155)//nggr -> Emerald Golem
	call UMD_SaveTints('nkob',-1,-1,165)//nkob -> Kobold
	call UMD_SaveTints('ncen',-1,-1,170)//ncen -> Centaur Outrunner
	call UMD_SaveTints('nowb',-1,-1,170)//nowb -> Wildkin
	call UMD_SaveTints('H00F',-1,-1,200)//H00F -> Dragon Knight
	call UMD_SaveTints('H00G',-1,-1,200)//H00G -> Dragon Knight
	call UMD_SaveTints('n002',-1,-1,200)//n002 -> Supportive Vestments
	call UMD_SaveTints('n009',-1,-1,200)//n009 -> Gateway Relics
	call UMD_SaveTints('n00V',-1,-1,200)//n00V -> Arcane Sanctum
	call UMD_SaveTints('n00W',-1,-1,200)//n00W -> Ancient Weaponry
	call UMD_SaveTints('n00X',-1,-1,200)//n00X -> Enchanted Artifacts
	call UMD_SaveTints('n0HE',-1,-1,200)//n0HE -> Protectorate
	call UMD_SaveTints('h094',-1,0,200)//h094 -> Aura
	call UMD_SaveTints('n006',0,-1,-1)//n006 -> Necronomicon Warrior 3
	call UMD_SaveTints('n00A',0,-1,-1)//n00A -> Necronomicon Warrior 2
	call UMD_SaveTints('n00J',0,-1,-1)//n00J -> Necronomicon Warrior 1
	call UMD_SaveTints('E01P',-1,0,-1)//E01P -> Dummy: SlowTurn-Range
	call UMD_SaveTints('h08Z',-1,0,-1)//h08Z -> Refraction
	call UMD_SaveTints('nfro',0,0,-1)//nfro -> IceFrog
	call UMD_SaveTints('n00G',-1,-1,0)//n00G -> Necronomicon Archer 2
	call UMD_SaveTints('n00H',-1,-1,0)//n00H -> Necronomicon Archer 1
	call UMD_SaveTints('n00K',-1,-1,0)//n00K -> Necronomicon Archer 3
	call UMD_SaveTints('E024',0,-1,0)//E024 -> Dummy: FastTurn-Range
	call UMD_SaveTints('o00T',0,-1,0)//o00T -> Plague Ward 1
	call UMD_SaveTints('o00U',0,-1,0)//o00U -> Plague Ward 2
	call UMD_SaveTints('o00V',0,-1,0)//o00V -> Plague Ward 3
	call UMD_SaveTints('o00W',0,-1,0)//o00W -> Plague Ward 4
	call UMD_SaveTints('e01K',-1,0,0)//e01K -> Meteor (Falling Down)
	call UMD_SaveTints('e01L',-1,0,0)//e01L -> Meteor (Moving)
	call UMD_SaveTints('E021',-1,0,0)//E021 -> Dummy: FastTurn-Melee
	call UMD_SaveTints('u01M',-1,0,0)//u01M -> Rune
	call UMD_SaveTints('u01O',-1,0,0)//u01O -> Rune
	call UMD_SaveTints('H00F',255,255,200)//dk morphed//H00F -> Dragon Knight
	call UMD_SaveTints('H00E',255,200,200)//H00E -> Dragon Knight
	call UMD_SaveTints('H00G',255,200,200)//H00G -> Dragon Knight
	call UMD_SaveTints('HC92',130,100,255)//riki//HC92 -> Stealth Assassin
	call UMD_SaveTints('U008',255,75,255)//lycan//U008 -> Lycanthrope
	call UMD_SaveTints('E015',255,100,255)//lycan wolf//E015 -> Lycanthrope
	call UMD_SaveTints('NC00',100,125,100)//leoric//NC00 -> Skeleton King
	call UMD_SaveTints('UC11',150,150,100)//magnus//UC11 -> Magnataur
	call UMD_SaveTints('Hvsh',250,150,150)//BS//Hvsh -> Bloodseeker
	call UMD_SaveTints('Ubal',255,200,200)//weaver//Ubal -> Nerubian Weaver
	call UMD_SaveTints('Nfir',0,0,0)//sf//Nfir -> Shadow Fiend
	call UMD_SaveTints('EC77',75,255,25)//viper//EC77 -> Netherdrake
	call UMD_SaveTints('Oshd',150,0,150)//bane//Oshd -> Bane Elemental
	call UMD_SaveTints('UC18',50,100,255)//lion//UC18 -> Demon Witch
	call UMD_SaveTints('UC60',150,150,150)//necrolic//UC60 -> Necro'lic
	call UMD_SaveTints('UC91',175,75,200)//slardar//UC91 -> Slithereen Guard
	call UMD_SaveTints('EC45',0,255,150)//void//EC45 -> Faceless Void
	call UMD_SaveTints('U00C',100,100,100)//naix//U00C -> Lifestealer
	call UMD_SaveTints('EC57',150,200,255)//veno//EC57 -> Venomancer
endfunction

function StoreAghaUpgrades1 takes nothing returns nothing
	call SaveAghanimUpgrade('A0O2','A28A','A289',0)//rex//A0O2 -> Primal Roar, A289 -> Primal Roar
	call SaveAghanimUpgrade('A0DH','A1MZ','A1OB',0)//es//A0DH -> Echo Slam, A1OB -> Echo Slam
	call SaveAghanimUpgrade('A0ER','A2S7','A2S8',0)//omni//A0ER -> Guardian Angel, A2S8 -> Guardian Angel
	call SaveAghanimUpgrade('A0MQ','A1BS','A1B6',0)//brewmaster//A0MQ -> Primal Split, A1B6 -> Primal Split upgrade
	call SaveAghanimUpgrade('A0Z8','A1CW','A1CV',0)//clock//A0Z8 -> Hookshot, A1CV -> Hookshot Upgrade
	call SaveAghanimUpgrade('A0QR','A1BL','A1B3',0)//huskar//A0QR -> Life Break, A1B3 -> Life Break upgrade
	call SaveAghanimUpgrade('A0M1','A1BR','A1AX',0)//jugger//A0M1 -> Omnislash, A1AX -> Omnislash upgrade
	call SaveAghanimUpgrade('A29L','A448','A447',0)//Magnus//A29L -> Reverse Polarity, A447 -> Reverse Polarity
	call SaveAghanimUpgrade('A0RP','A44A','A449',0)//lanaya//A0RP -> Psionic Trap, A449 -> Psionic Trap
	call SaveAghanimUpgrade('A054','A0UE','A00U',0)//luna//A054 -> Eclipse, A00U -> Eclipse
	call SaveAghanimUpgrade('A1T5','A236','A235',0)//gyro//A1T5 -> Call Down, A235 -> Call Down
	call SaveAghanimUpgrade('A0IN','A1BT','A1AW',0)//vs//A0IN -> Nether Swap, A1AW -> Nether Swap upgrade
	call SaveAghanimUpgrade('A03R','A0U2','A0AV',0)//cm//A03R -> Freezing Field, A0AV -> Freezing Field
	call SaveAghanimUpgrade('A0S8','A1QR','A1QP',0)//puck//A0S8 -> Dream Coil, A1QP -> Dream Coil
	call SaveAghanimUpgrade('A0LT','A1CT','A1CS',0)//chen//A0LT -> Hand of God, A1CS -> Hand of God upgraded
	call SaveAghanimUpgrade('A29G','A0U0','A29H',0)//zeus//A29G -> Thundergod's Wrath, A29H -> Thundergod's Wrath
	call SaveAghanimUpgrade('A1W8','A0U8','A1W9',0)//furion//A1W8 -> Wrath of Nature, A1W9 -> Wrath of Nature upgrade
	call SaveAghanimUpgrade('A0L3','A2QB','A2QC',0)//silencer//A0L3 -> Global Silence, A2QC -> Global Silence
	call SaveAghanimUpgrade('A01P','A0TO','A09Z',0)//lina//A01P -> Laguna Blade, A09Z -> Laguna Blade
	call SaveAghanimUpgrade('A12P','A1DC','A1D6',0)//wr//A12P -> Focus Fire, A1D6 -> Focus Fire Upgraded
	call SaveAghanimUpgrade('A0AK','A1G0','A1FY',0)//techies//A0AK -> Remote Mines, A1FY -> Remote Mines
	call SaveAghanimUpgrade('A0O5','A1BN','A1B1',0)//thd//A0O5 -> Macropyre, A1B1 -> Macropyre upgrade
	call SaveAghanimUpgrade('A00H','A0TY','A0A1',0)//rhasta//A00H -> Mass Serpent Ward, A0A1 -> Mass Serpent Ward
	call SaveAghanimUpgrade('A04P','A1BV','A1AU',0)//sniper//A04P -> Assassinate, A1AU -> Assassinate upgrade
	call SaveAghanimUpgrade('A0LC','A444','A443',0)//ursa//A0LC -> Enrage, A443 -> Enrage
	call SaveAghanimUpgrade('A0E2','A1MS','A1MR',0)//axe//A0E2 -> Culling Blade, A1MR -> Culling Blade
	call SaveAghanimUpgrade('A0MU','A0UI','A0A2',0)//doom//A0MU -> Doom, A0A2 -> Doom
	call SaveAghanimUpgrade('A0NS','A1DE','A1DA',0)//abaddon//A0NS -> Borrowed Time, A1DA -> Borrowed Time Upgrade
	call SaveAghanimUpgrade('A0FL','A1D5','A1CX',0)//pudge//A0FL -> Dismember, A1CX -> Dismember Upgraded
	call SaveAghanimUpgrade('A0G4','A1DG','A1D8',0)//barathum//A0G4 -> Nether Strike, A1D8 -> Nether Strike Upgrade
	call SaveAghanimUpgrade('A06R','A1BM','A1B4',0)//sk//A06R -> Epicenter, A1B4 -> Epicenter upgrade
	call SaveAghanimUpgrade('A013','A0UA','A0A6',0)//veno//A013 -> Poison Nova, A0A6 -> Poison Nova Upg
	call SaveAghanimUpgrade('A080','A1V0','A1UZ',0)//viper//A080 -> Viper Strike, A1UZ -> Viper Strike
	call SaveAghanimUpgrade('A1AO','A1UW','A1UV',0)//razor//A1AO -> Eye of the Storm, A1UV -> Eye of the Storm
	call SaveAghanimUpgrade('A0J1','A1DD','A1D7',0)//void//A0J1 -> Chronosphere, A1D7 -> Chronosphere Upgraded
	call SaveAghanimUpgrade('A02Q','A1DH','A1D9',0)//bane//A02Q -> Fiend's Grip, A1D9 -> Fiend's Grip Upgrade
	call SaveAghanimUpgrade('A0QK','A21R','A21Q',0)//DS//A0QK -> Wall of Replica, A21Q -> Wall of Replica
	call SaveAghanimUpgrade('A095','A0TQ','A09W',0)//lion//A095 -> Finger of Death, A09W -> Finger of Death
	call SaveAghanimUpgrade('A05T','A0U4','A08H',0)//lich//A05T -> Chain Frost, A08H -> Chain Frost
	call SaveAghanimUpgrade('A067','A0UC','A08P',0)//necrolyte//A067 -> Reaper's Scythe, A08P -> Reaper's Scythe
	call SaveAghanimUpgrade('A0CC','A0TU','A02Z',0)//pugna//A0CC -> Life Drain, A02Z -> Life Drain
	call SaveAghanimUpgrade('A0OK','A1VX','A1VW',0)//od//A0OK -> Sanity's Eclipse, A1VW -> Sanity's Eclipse
	call SaveAghanimUpgrade('A28R','A0TW','A28S',0)//qop//A28R -> Sonic Wave, A28S -> Sonic Wave
endfunction

function StoreAghaUpgrades2 takes nothing returns nothing
	call SaveAghanimUpgrade('S008','A1US','S00U',0)//wl//S008 -> Rain of Chaos, S00U -> Rain of Chaos
	call SaveAghanimUpgrade('A10Q','A1DF','A1DB',0)//dazzle//A10Q -> Weave, A1DB -> Weave Upgrade
	call SaveAghanimUpgrade('A1NE','A2IH','A2IG',0)//visage//A1NE -> Familiars, A2IH -> Aghanim Visage, A2IG -> Familiars
	call SaveAghanimUpgrade('A21F','A0U6','A21G',0)//lesh//A21F -> Pulse Nova, A21G -> Pulse Nova
	call SaveAghanimUpgrade('A0NT','A0UG','A0NX',0)//wd//A0NT -> Death Ward, A0NX -> Death Ward
	call SaveAghanimUpgrade('A1MI','A2QF','A2QE',0)//AA//A1MI -> Ice Blast, A2QE -> Ice Blast
	call SaveAghanimUpgrade('A2BG','A30I','A30H',0)//sky//A2BG -> Mystic Flare, A30H -> Mystic Flare
	call SaveAghanimUpgrade('A27H','A30K','A30J',0)//rubicks//A27H -> Spell Steal, A30J -> Spell Steal
	call SaveAghanimUpgrade('A1BX','A30M','A30L',0)//enigma//A1BX -> Black Hole, A30L -> Black Hole
	call SaveAghanimUpgrade('A1U6','A30O','A30N',0)//disruptor//A1U6 -> Static Storm, A30N -> Static Storm
	call SaveAghanimUpgrade('A343','A34K','A34J',0)//sd//A343 -> Demonic Purge, A34J -> Demonic Purge
	call SaveAghanimUpgrade('A0DY','A1WC','A1WB',0)//ench//A0DY -> Impetus, A1WB -> Impetus
	call SaveAghanimUpgrade('A0WP','A43E','A43D',0)//sven//A0WP -> God's Strength, A43D -> God's Strength Agh
	call SaveAghanimUpgrade('A1RK','A43I','A43H',0)//phoenix//A1RK -> Supernova, A43H -> Supernova
	call SaveAghanimUpgrade('A1A1','A43K','A43J',0)//chieftain//A1A1 -> Earth Splitter, A43J -> Earth Splitter
	call SaveAghanimUpgrade('A2E5','A43R','A43S',0)//shredder//A2E5 -> Chakram, A43S -> Chakram
	call SaveAghanimUpgrade('A07Z','A44R','A44S',0)//treant//A07Z -> Overgrowth, A44S -> Overgrowth Upgrade
	call SaveAghanimUpgrade('A2O6','A3G0','A384',0)//centaurs//A2O6 -> Stampede, A384 -> Stampede
	call SaveAghanimUpgrade('A2CI','A38D','A38C',0)//legion//A2CI -> Duel, A38C -> Duel
	call SaveAghanimUpgrade('A07U','A38F','A38E',0)//naga//A07U -> Song of the Siren, A38E -> Song of the Siren
	call SaveAghanimUpgrade('A1YQ','A3DD','A3DE',0)//tusk//A1YQ -> Walrus Punch, A3DE -> Walrus Punch
	call SaveAghanimUpgrade('A0CT','A3DN','A3DM',0)//weaver//A0CT -> Time Lapse, A3DM -> Time Lapse
	call SaveAghanimUpgrade('A01Y','A1BP','A1AZ',0)//leoric//A01Y -> Reincarnation, A1AZ -> Reincarnation upgrade
	call SaveAghanimUpgrade('A14O','A3FP','A3FJ',0)//Storm
	call SaveAghanimUpgrade('A19O','A1MW','A1MV',0)//Bat
	call SaveAghanimUpgrade('A06B','A472','A471',0)//Suicide
	call SaveAghanimUpgrade('A15S','A3JY','A3JX',0)//Decay
	call SaveAghanimUpgrade('A05E','A3JZ','A33F',0)//Tinker rockets
	call SaveAghanimUpgrade('A049','A33H','A33G',0)//Tinker laser
	call SaveAghanimUpgrade('A28T','A3JA','A361',0)//Chen's Holy persuation
	call SaveAghanimUpgrade('Z610','A3K4','A3K5',0)//invoker Maxed deafening Blast
	call SaveAghanimUpgrade('A1TB','A470','A3FQ',0)//Relocate
	call SaveAghanimUpgrade('A0O3',0     ,'A0O3',0)//giftable agh
	call SaveAghanimUpgrade('QM03',0,0,0)//zombi//QM03 -> Flesh Golem
	call SaveAghanimUpgrade('A0A5',0,0,0)//lone druid//A0A5 -> Summon Spirit Bear
	call SaveAghanimUpgrade('A0CY',0,0,0)//tiny//A0CY -> Grow
	call SaveAghanimUpgrade('A088',0,0,0)//ogre//A088 -> Multi Cast
	call SaveAghanimUpgrade('A085',0,0,0)//A085 -> illuminate
endfunction

function StoreAllPassives takes nothing returns nothing
	call ConvertPassiveData('ACac','Q003','P003','BOac','QP03','QP03')//command aura//ACac -> Command Aura, P003 -> Command Aura, QP03 -> Command Aura, A31F -> Command Aura Illusions visual
	call ConvertPassiveData(0     ,0     ,'A0DW',0     ,'QP04',0     )//untouchable//A0DW -> Untouchable, QP04 -> Untouchable
	call ConvertPassiveData('AHab','Q019','P019','B07M','QP05',0     )//brilliance aura//AHab -> Brilliance Aura, P019 -> Brilliance Aura, B07M -> Brilliance Aura, QP05 -> Brilliance Aura
	call ConvertPassiveData('P022','Q022','A01K',0     ,'QP06',0     )//cleave//A01K -> Great Cleave, QP06 -> Great Cleave
	call ConvertPassiveData('P035','Q035','A0DZ',0     ,'QP07',0     )//backstab//A0DZ -> Backstab, QP07 -> Backstab
	call ConvertPassiveData('A00J','Q036','A0MB',0     ,'QP08','QP08')//permanent invis//A00J -> Permanent Invisibility, A0MB -> Permanent Invisibility, QP08 -> Permanent Invisibility, A31G -> Permanent Invisibility visual
	call ConvertPassiveData('P047','Q047','A00K',0     ,'QP09','QP09')//blade dance//A00K -> Blade Dance, QP09 -> Blade Dance, A31H -> Blade Dance visual
	call ConvertPassiveData(0     ,'Q067','P067',0     ,'QP0A',0     )//fury swipes//P067 -> Fury Swipes, QP0A -> Fury Swipes
	call ConvertPassiveData('P083','Q083','A0DB','B03B','QP0B','QP0B')//Juxtapose//A0DB -> Juxtapose, B03B -> Juxtapose, QP0B -> Juxtapose, A31I -> Juxtapose visual
	call ConvertPassiveData('P098','Q098','A041',0     ,'QP0D','QP0D')//moon glaive//A041 -> Moon Glaive, QP0D -> Moon Glaive, A31K -> Moon Glaive
	call ConvertPassiveData('P099','Q099','A062','B01W','QP0E',0     )//Lunar blessing//A062 -> Lunar Blessing, B01W -> Lunar Blessing, QP0E -> Lunar Blessing
	call ConvertPassiveData('P102','Q102','A03S',0     ,'QP0F',0     )//Headshot//A03S -> Headshot, QP0F -> Headshot
	call ConvertPassiveData('P107','Q107','A0O0',0     ,'QP0G',0     )//fervor//A0O0 -> Fervor, QP0G -> Fervor
	call ConvertPassiveData('P119','Q119','A0MX',0     ,'QP0H','QP0H')//Drunken brawler//A0MX -> Drunken Brawler, QP0H -> Drunken Brawler, A31M -> Drunken Brawler
	call ConvertPassiveData('P123','Q123','A00V','B00M','QP0I','QP0I')//Return//A00V -> Return, B00M -> Return, QP0I -> Return, A31N -> Return
	call ConvertPassiveData('P131','Q131','A0CL','B04D','QP0J',0     )//Dragon Blood//A0CL -> Dragon Blood, B04D -> Dragon Blood, QP0J -> Dragon Blood
	call ConvertPassiveData('P133','Q133','A022',0     ,'QP0K','QP0K')//Mana break//A022 -> Mana Break, QP0K -> Mana Break, A31O -> Mana Break
	call ConvertPassiveData('P135','Q135','A0KY',0     ,'QP0L','QP0L')//Spell Shield//A0KY -> Spell Shield, QP0L -> Spell Shield, A31P -> Spell Shield
	call ConvertPassiveData('P143','Q143','A06A','B01B','QP0M','QP0M')//Degen Aura//A06A -> Degen Aura, B01B -> Degen Aura, QP0M -> Degen Aura, A31Q -> Degen Aura
	call ConvertPassiveData('P147','Q147','A0BD','B00E','QP0N','QP0N')//Inner Beast//A0BD -> Inner Beast, B00E -> Inner Beast, QP0N -> Inner Beast, A31R -> Inner Beast
	call ConvertPassiveData('P155','Q155','A0O3','B00X','QP0O',0     )//Goblin's Greed//A0O3 -> Goblin's Greed, B00X -> Goblin's Greed, QP0O -> Goblin's Greed
	call ConvertPassiveData('P211','Q211','A27V','B0EO','QP0P',0     )//Null Field//A27V -> Null Field, B0EO -> Null Field, QP0P -> Null Field
	call ConvertPassiveData('P231','Q231','A03E','B096','QP0Q',0     )//Feral Impulse//A03E -> Feral Impulse, B096 -> Feral Impulse, QP0Q -> Feral Impulse
	call ConvertPassiveData('P239','Q239','A03P',0     ,'QP0R','QP0R')//Blur//A03P -> Blur, QP0R -> Blur, A31S -> Blur
	call ConvertPassiveData('P240','Q240','A03Q',0     ,'QP0S','QP0S')//Coup de grace//A03Q -> Coup de grace, QP0S -> Coup de grace, A31T -> Coup de grace
	call ConvertPassiveData(0     ,0     ,'A086','B02L','P247',0     )//Hunter in the Night//A086 -> Hunter in the Night, B02L -> Hunter in the Night, QP0T -> Hunter in the Night
	call ConvertPassiveData('AUav','Q250','P250','BVA1','QP0U','QP0U')//Vampiric Aura//AUav -> Vampiric Aura, P250 -> Vampiric Aura, BVA1 -> Vampiric Aura, QP0U -> Vampiric Aura, A31U -> Vampiric Aura
	call ConvertPassiveData('AOcr','Q251','A2S0',0     ,'QP0W','QP0W')//Mortal Strike//AOcr -> Critical Strike, A2S0 -> Mortal Strike, QP0W -> Mortal Strike, A31V -> Mortal Strike
	call ConvertPassiveData(0     ,0     ,'A0JJ',0     ,'QP0V','QP0V')//Slardar Bash//A0JJ -> Bash, QP0V -> Bash, A31W -> Bash
	call ConvertPassiveData(0     ,0     ,'A081',0     ,'QP0X','QP0X')//Time Lock//A081 -> Time Lock, QP0X -> Time Lock, A31X -> Time Lock
	call ConvertPassiveData('P279','Q279','A0MM',0     ,'QP0Y',0     )//Corrosive s//A0MM -> Corrosive Skin, QP0Y -> Corrosive Skin
	call ConvertPassiveData('P283','Q283','A1E6','B03X','QP0Z',0     )//Unstable current//A1E6 -> Unstable Current, B03X -> Unstable Current, QP0Z -> Unstable Current
	call ConvertPassiveData('P294','Q294','A04E',0     ,'QP10',0     )//Kraken Shell//A04E -> Kraken Shell, QP10 -> Kraken Shell
	call ConvertPassiveData('P302','Q302','A01N','B084','QP11',0     )//Heartstopper aura//A01N -> Heartstopper Aura, B084 -> Heartstopper Aura, QP11 -> Heartstopper Aura
	call ConvertPassiveData('P303','Q303','A060',0     ,'QP12',0     )//Sadist//A060 -> Sadist, QP12 -> Sadist
	call ConvertPassiveData('P307','Q307','A06D',0     ,'QP13',0     )//Flesh Heap//A06D -> Flesh Heap, QP13 -> Flesh Heap
	call ConvertPassiveData('P310','Q310','A0ES','B03Y','QP14','QP14')//Empowering haste//A0ES -> Empowering Haste, B03Y -> Empowering Haste, QP14 -> Empowering Haste, A31Y -> Empowering Haste
	call ConvertPassiveData('P319','Q319','A0FU',0     ,'QP15','QP15')//Present of the dark lord//A0FU -> Presence of the Dark Lord, QP15 -> Presence of the Dark Lord, A31Z -> Presence of the Dark Lord
	call ConvertPassiveData(0     ,0     ,'A0FA',0     ,'QP16','QP16')//Caustic Finale//A0FA -> Caustic Finale, QP16 -> Caustic Finale, A320 -> Caustic Finale
	call ConvertPassiveData('P327','Q327','A0C6','B03P','QP17','QP17')//Counter Helix//A0C6 -> Counter Helix, B03P -> Counter Helix, QP17 -> Counter Helix, A321 -> Counter Helix
	call ConvertPassiveData(0     ,0     ,'A0MG',0     ,'QP18',0     )//Frostmourne//A0MG -> Frostmourne, QP18 -> Frostmourne
	call ConvertPassiveData('P338','Q338','A0FX',0     ,'QP19','QP19')//Desolate//A0FX -> Desolate, QP19 -> Desolate hidden, A322 -> Desolate (illusion placeholder)
	call ConvertPassiveData('P347','Q347','A0IF','B06X','QP1A',0     )//Essense aura//A0IF -> Essence Aura, B06X -> Essence Aura, QP1A -> Essence Aura
	call ConvertPassiveData('P355','Q355','A0N7',0     ,'QP1B',0     )//Geostrike//A0N7 -> Geostrike, QP1B -> Geostrike
	call ConvertPassiveData('P363','Q363','AIcd',0     ,'QP1C','QP1C')//Diffusion Aura//AIcd -> Atrophy Aura, QP1C -> Atrophy Aura, A323 -> Diffusion Aura
	call ConvertPassiveData('P418','Q418','A0MY',0     ,'QP1D',0     )//Poison sting//A0MY -> Poison Sting, QP1D -> Poison Sting
	call ConvertPassiveData('P431','Q431','A03N',0     ,'QP1E','QP1E')//Critical Strike//A03N -> Critical Strike, QP1E -> Critical Strike, A324 -> Critical Strike
	call ConvertPassiveData(0     ,0     ,'A1HR',0     ,'QP1F',0     )//essence shift//A1HR -> Essence Shift, QP1F -> Essence Shift
	call ConvertPassiveData(0     ,0     ,'A0DJ',0     ,'QP1G',0     )//aftershock//A0DJ -> Aftershock, QP1G -> Aftershock
	call ConvertPassiveData(0     ,0     ,'QF85',0     ,'QP1H',0     )//aftershock balanced//QF85 -> Aftershock, QP1H -> Aftershock
	call ConvertPassiveData(0     ,0     ,'A1CD',0     ,'QP1I',0     )//natural order//A1CD -> Natural Order, QP1I -> Natural Order
	call ConvertPassiveData(0     ,0     ,'A19Q',0     ,'QP1J',0     )//craggy ext//A19Q -> Craggy Exterior, QP1J -> Craggy Exterior
	call ConvertPassiveData(0     ,0     ,'A0CY',0     ,'QP1K',0     )//Grow!//A0CY -> Grow, QP1K -> Grow
	call ConvertPassiveData(0     ,0     ,'A0QQ',0     ,'QP1L',0     )//Berserker blood//A0QQ -> Berserker's Blood, QP1L -> Berserker's Blood
	call ConvertPassiveData(0     ,0     ,'A0M3',0     ,'QP1M',0     )//Bristleback//A0M3 -> Bristleback, QP1M -> Bristleback
	call ConvertPassiveData(0     ,0     ,'A0FV',0     ,'QP1N',0     )//Warpath//A0FV -> Warpath, QP1N -> Warpath
	call ConvertPassiveData(0     ,0     ,'A2EY',0     ,'QP1O',0     )//Moment of courage//A2EY -> Moment of Courage, QP1O -> Moment of Courage
	call ConvertPassiveData(0     ,0     ,'A2E4',0     ,'QP1P',0     )//Reactive armor//A2E4 -> Reactive Armor, QP1P -> Reactive Armor
	call ConvertPassiveData(0     ,0     ,'A03U',0     ,'QP1Q',0     )//Take aim//A03U -> Take Aim, QP1Q -> Take Aim
	call ConvertPassiveData(0     ,0     ,'A0RO',0     ,'QP1S',0     )//Psi blades//A0RO -> Psi Blades, QP1S -> Psi Blades
	call ConvertPassiveData(0     ,0     ,'A0N5',0     ,'QP1T',0     )//Static field//A0N5 -> Static Field, QP1T -> Static Field
	call ConvertPassiveData(0     ,0     ,'A18X',0     ,'QP1U',0     )//Fiery Soul//A18X -> Fiery Soul, QP1U -> Fiery Soul
	call ConvertPassiveData(0     ,0     ,'A0QW',0     ,'QP1V',0     )//Overload//A0QW -> Overload, QP1V -> Overload
	call ConvertPassiveData(0     ,0     ,'A0SS',0     ,'QP1W',0     )//Feast//A0SS -> Feast, QP1W -> Feast
	call ConvertPassiveData(0     ,0     ,'A0G5',0     ,'QP1X',0     )//Greater Bash//A0G5 -> Greater Bash, QP1X -> Greater Bash
	call ConvertPassiveData(0     ,0     ,'A0LE',0     ,'QP1Y',0     )//Bloodbath//A0LE -> Blood Bath, QP1Y -> Blood Bath
	call ConvertPassiveData(0     ,0     ,'A0I8',0     ,'QP1Z',0     )//Strygwyr's thrist//A0I8 -> Strygwyr's Thirst, QP1Z -> Strygwyr's Thirst
	call ConvertPassiveData(0     ,0     ,'A0NA',0     ,'QP20',0     )//Dispersion//A0NA -> Dispersion, QP20 -> Dispersion
	call ConvertPassiveData(0     ,0     ,'A1A3',0     ,'QP21',0     )//Nethertoxin//A1A3 -> Nethertoxin, QP21 -> Nethertoxin
	call ConvertPassiveData(0     ,0     ,'A0CZ',0     ,'QP22',0     )//Backtrack//A0CZ -> Backtrack, QP22 -> Backtrack
	call ConvertPassiveData(0     ,0     ,'A0VX',0     ,'QP23',0     )//Gravekeeper's Cloak//A0VX -> Gravekeeper's Cloak, QP23 -> Gravekeeper's Cloak
	call ConvertPassiveData(0     ,0     ,'A088',0     ,'QP24',0     )//Multi cast//A088 -> Multi Cast, QP24 -> Multi Cast
	call ConvertPassiveData('A33O','A33P','A33Q',0     ,'A33R',0     )//Last word passive//A33Q -> Last Word, A33R -> Last Word
	call ConvertPassiveData('A09J','A23F','A417',0     ,0     ,0     )//Split shot//A09J -> Split Shot, A23F -> Split Shot Spell Book
	call ConvertPassiveData('A43Z','A442','A440',0     ,'QP25',0     )//old marksmanship//A440 -> Adaptiveness, QP25 -> Adaptiveness
	call ConvertPassiveData(0     ,0     ,'QF88',0     ,'A0VC',0     )//marksmanship
	call ConvertPassiveData('A455','A45C','A45B',0     ,'QP26',0     )//fire show//A45B -> Fire show, QP26 -> Fire show
	call ConvertPassiveData(0     ,0     ,'A460',0     ,'QP27',0     )//mortal wounds//A460 -> Mortal Wounds, QP27 -> Mortal Wounds hidden
	call ConvertPassiveData(0     ,0     ,'A34A',0     ,'QP28',0     )//cheat death//A34A -> Cheat Death, QP28 -> Cheat Death
	call ConvertPassiveData(0     ,0     ,'Q0BK',0     ,'QP29',0     )//incap bite brood//Q0BK -> Incapacitating Bite, QP29 -> Incapacitating Bite hidden
	call ConvertPassiveData(0     ,0     ,'A0A8',0     ,'QP2A',0     )//synergy
	call ConvertPassiveData('A3J7','A3J7','A02C',0     ,'QP2B',0     )//witchcraft
endfunction

function InitAllSkillsTable takes nothing returns nothing
	local integer i=0
	local string s
//	call PreloadEndEx()
//	call PreloadGenClear()
//	call PreloadGenStart()
	call ConvertSkillData(0,null,0,0,0,null)
	set SkillIcon[0]=EmptySlotPath
	set i=VS-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"thunderbolt"),'A02A',0,'Y001',"c")//A02A -> Magic Missile
	call ConvertSkillData(i*4+2,ST(i*4+2,"volcano"),'A17O',0,'Y002',"e")//A17O -> Wave of Terror
	call ConvertSkillData(i*4+3,null,'P003','QP03','Y003',null)//P003 -> Command Aura, QP03 -> Command Aura
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"forkedlightning"),'A0IN','A1AW','Y004',"w")//A0IN -> Nether Swap, A1AW -> Nether Swap upgrade
	set i=Zeus-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"chainlightning"),'A020',0,'Y005',"c")//A020 -> Arc Lightning
	call ConvertSkillData(i*4+2,ST(i*4+2,"thunderbolt"),'A0JC',0,'Y006',"g")//A0JC -> Lightning Bolt
	call ConvertSkillData(i*4+3,null,'A0N5','QP1T','Y007',null)//A0N5 -> Static Field, QP1T -> Static Field
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"roar")+ST(i*4+4,"r1"),'A29G','A29H','Y008',"w")//A29G -> Thundergod's Wrath, A29H -> Thundergod's Wrath
	set i=Enchantress-1
	call ConvertSkillData(i*4+1,null,'A0DW','QP04','Y009',null)//A0DW -> Untouchable, QP04 -> Untouchable
	set IsPassiveAbility[i*4+1]=true
	call ConvertSkillData(i*4+2,ST(i*4+2,"slow"),'A0DX',0,'Y010',"c")//A0DX -> Enchant
	call ConvertSkillData(i*4+3,ST(i*4+3,"locustswarm"),'A01B',0,'Y011',"r")//A01B -> Nature's Attendants
	call ConvertSkillData(i*4+4,ST(i*4+4,"arrows")+ST(i*4+4,"range only"),'A0DY','A1WB','Y012',"t")//A0DY -> Impetus, A1WB -> Impetus
	set IsPermanentAbility[i*4+4]=true
	set i=Morphling-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"carrionswarm"),'QB02',0,'QY02',"w")//QB02 -> Waveform, A0FN -> Waveform
	call ConvertSkillData(i*4+2,ST(i*4+2,"acidbomb"),'A0G6',0,'Y014',"e")//A0G6 -> Adaptive Strike
	call ConvertSkillData(i*4+3,ST(i*4+3,"replenishmana")+ST(i*4+3,"replenishlife")+ST(i*4+3,"abuz agi")+ST(i*4+3,"str bug"),'A0KX',0,'Y015',null)//A0KX -> Morph
	set IsMultiIconAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"item 16")+ST(i*4+4,"coldarrows"),'A0G8',0,'Y016',"r")//A0G8 -> Replicate
	set i=indexid_CM-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"mounthippogryph"),'A1E9',0,'Y017',"v")//A1E9 -> Crystal Nova
	call ConvertSkillData(i*4+2,ST(i*4+2,"entanglingroots"),'A04C',0,'Y018',"e")//A04C -> Frostbite
	call ConvertSkillData(i*4+3,null,'P019','QP05','Y019',null)//P019 -> Brilliance Aura, QP05 -> Brilliance Aura
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"autoharvestlumber"),'A03R','A0AV','Y020',"f")//A03R -> Freezing Field, A0AV -> Freezing Field
	set i=Sven-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"spellshieldaoe"),'A190',0,'Y021',"t")//A190 -> Storm Bolt
	call ConvertSkillData(i*4+2,ST(i*4+2,"melee only"),'A01K','QP06','Y022',null)//A01K -> Great Cleave, QP06 -> Great Cleave
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,ST(i*4+3,"fanofknives"),'A2IS',0,'Y023',"w")//A2IS -> Warcry
	call ConvertSkillData(i*4+4,ST(i*4+4,"roar"),'A0WP','A43D','Y024',"r")//A0WP -> God's Strength, A43D -> God's Strength Agh
	set i=NagaSiren-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"mirrorimage"),'A063',0,'Y025',"r")//A063 -> Mirror Image
	call ConvertSkillData(i*4+2,ST(i*4+2,"unavatar"),'A24D',0,'Y026',"e")//A24D -> Ensnare
	call ConvertSkillData(i*4+3,ST(i*4+3,"fanofknives"),'A2KU',0,'Y027',"d")//A2KU -> Rip Tide
	call ConvertSkillData(i*4+4,ST(i*4+4,"awaken")+ST(i*4+4,"avengerform")+ST(i*4+4,"r2"),'A07U','A38E','Y028',"g")//A07U -> Song of the Siren, A38E -> Song of the Siren
	set i=ES-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"barkskinoff"),'A0SK',0,'Y029',"f")//A0SK -> Fissure
	call ConvertSkillData(i*4+2,ST(i*4+2,"roar"),'A0DL',0,'Y030',"e")//A0DL -> Enchant Totem
	set BalanceStrings[i*4+2]="Enchant Totem in addition with Tidebringer, Geminate attack (on melee), Walrus Punch, Jinada, Morph or Sleight of Fist will only add +100/140/180/220% dmg"
	call ExBalanceStackSwitch(i*4+2,"ET-Drunken")
	call BalanceOffStackSwitch(i*4+2,"bgdmg1")
	call BalanceOffStackSwitch(i*4+2,"bgdmg2")
	call ConvertSkillData(i*4+3,null,'A0DJ','QP1H','Y031',null)//A0DJ -> Aftershock, QP1H -> Aftershock
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"fanofknives"),'A0DH','A1OB','Y032',"c")//A0DH -> Echo Slam, A1OB -> Echo Slam
	
	set i=Riki-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"neutralinteract"),'A0RG',0,'Y033',"c")//A0RG -> Smoke Screen
	call ConvertSkillData(i*4+2,ST(i*4+2,"inv bug 1")+ST(i*4+2,"ibug"),'A0MB','QP08','Y036',null)//A0MB -> Permanent Invisibility, QP08 -> Permanent Invisibility
	set IsPassiveAbility[i*4+2]=true
	set BalanceStrings[i*4+2]="Permanent Invisibility will be removed on spell casting"
	call ConvertSkillData(i*4+3,null,'A0DZ','QP07','Y035',null)//A0DZ -> Backstab, QP07 -> Backstab
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"barkskinon"),'A0K9',0,'Y034',"b")//A0K9 -> Blink Strike
	
	set i=LoneDruid-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"summongrizzly"),'A0A5',0,'Y037',"b")//A0A5 -> Summon Spirit Bear
	call ConvertSkillData(i*4+2,ST(i*4+2,"fanofknives"),'A1EG',0,'Y038',"r")//A1EG -> Rabid
	call ConvertSkillData(i*4+3,null,'A0A8',0,'Y039',null)
	//set IsAbilityDoesNotWork[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"bearform")+ST(i*4+4,"unbearform")+ST(i*4+4,"battleroar")+ST(i*4+4,"metamorphosis")+ST(i*4+4,"melee morph"),'A0AG',0,'Y040',"f")//A0AG -> True Form
	set IsMultiIconAbility[i*4+4]=true
	set i=Lina-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"carrionswarm"),'A01F',0,'Y041',"d")//A01F -> Dragon Slave
	call ConvertSkillData(i*4+2,ST(i*4+2,"restorationoff"),'QB0E',0,'QY0E',"t")//QB0E -> Light Strike Array
	call ConvertSkillData(i*4+3,null,'A18X','QP1U','Y043',null)//A18X -> Fiery Soul, QP1U -> Fiery Soul
	set IsPassiveAbility[i*4+3]=true
	set BalanceStrings[i*4+3]="Spells with a cooldown of 3s or less will only proc Fiery Soul every 2nd cast."
	call ConvertSkillData(i*4+4,ST(i*4+4,"chainlightning"),'A01P','A09Z','Y044',"g")//A01P -> Laguna Blade, A09Z -> Laguna Blade
	set i=Juggernaut-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"whirlwind"),'A05G',0,'Y045',"f")//A05G -> Blade Fury
	call ConvertSkillData(i*4+2,ST(i*4+2,"healingward"),'A047',0,'Y046',"g")//A047 -> Healing Ward
	call ConvertSkillData(i*4+3,null,'A00K','QP09','Y047',null)//A00K -> Blade Dance, QP09 -> Blade Dance
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"thunderbolt"),'A0M1','A1AX','Y048',"e")//A0M1 -> Omnislash, A1AX -> Omnislash upgrade
	set i=Silencer-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"neutralspell"),'A14L',0,'Y049',"c")//A14L -> Curse of the Silent
	call ConvertSkillData(i*4+2,ST(i*4+2,"arrows")+ST(i*4+2,"range only"),'A0LZ',0,'Y050',"w")//A0LZ -> Glaives of Wisdom
	call ConvertSkillData(i*4+3,ST(i*4+3,"transmute"),'A2NT',0,'Y051',"t")//A2NT -> Last Word
	call ConvertSkillData(i*4+4,ST(i*4+4,"battlestations")+ST(i*4+4,"r4"),'A0L3','A2QC','Y052',"e")//A0L3 -> Global Silence, A2QC -> Global Silence
	set i=Treant-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"invisibility"),'A01Z',0,'Y053',"t")//A01Z -> Nature's Guise
	call ConvertSkillData(i*4+2,ST(i*4+2,"unavengerform"),'A26N',0,'Y054',"e")//A26N -> Leech Seed
	call ConvertSkillData(i*4+3,ST(i*4+3,"spiritlink"),'A2ML',0,'Y055',"v")//A2ML -> Living Armor
	call ConvertSkillData(i*4+4,ST(i*4+4,"blight"),'A07Z','A44S','Y056',"r")//A07Z -> Overgrowth, A44S -> Overgrowth Upgrade
	set i=Chieftain-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"holybolt"),'A1AA',0,'Y057',"t")//A1AA -> Echo Stomp
	call ConvertSkillData(i*4+2,ST(i*4+2,"loadcorpse")+ST(i*4+2,"whirlwind"),'A1A8',0,'Y058',"c")//A1A8 -> Ancestral Spirit
	call ConvertSkillData(i*4+3,null,'A1CD','QP1I','Y059',null)//A1CD -> Natural Order, QP1I -> Natural Order
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"board"),'A1A1','A43J','Y060',"e")//A1A1 -> Earth Splitter, A43J -> Earth Splitter
	set i=Kotl-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"carrionscarabs")+ST(i*4+1,"carrionscarabsinstant"),'A085',0,'Y061',"t")//A085 -> Illuminate
	call ConvertSkillData(i*4+2,ST(i*4+2,"spellsteal"),'A10X',0,'Y062',"e")//A10X -> Mana Leak
	call ConvertSkillData(i*4+3,ST(i*4+3,"frenzy"),'A112',0,'Y063',"c")//A112 -> Chakra Magic
	call ConvertSkillData(i*4+4,ST(i*4+4,"range morph")+ST(i*4+4,"metamorphosis")+ST(i*4+4,"phoenixfire")+ST(i*4+4,"creepheal"),'QM01',0,'Y064',"f")//QM01 -> Spirit Form
	set IsMultiIconAbility[i*4+4]=true
	set i=Ursa-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"thunderclap"),'A03Y',0,'Y065',"e")//A03Y -> Earthshock
	call ConvertSkillData(i*4+2,ST(i*4+2,"fanofknives"),'QB0P',0,'QY0P',"v")//QB0P -> Overpower, A1N4 -> Overpower
	call ConvertSkillData(i*4+3,null,'P067','QP0A','Y067',null)//P067 -> Fury Swipes, QP0A -> Fury Swipes
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"berserk"),'A0LC','A443','Y068',"r")//A0LC -> Enrage, A443 -> Enrage
	set i=OgreMagi-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"thunderbolt"),'QB0J',0,'QY0J',"f")//QB0J -> Fireblast, A04W -> Fireblast
	call ConvertSkillData(i*4+2,ST(i*4+2,"acidbomb"),'A011',0,'Y070',"g")//A011 -> Ignite
	call ConvertSkillData(i*4+3,ST(i*4+3,"bloodlust"),'A083',0,'Y071',"b")//A083 -> Bloodlust
	call ConvertSkillData(i*4+4,ST(i*4+4,"carrionscarabsoff"),'A088','QP24','Y072',null)//A088 -> Multi Cast, QP24 -> Multi Cast
	set IsPassiveAbility[i*4+4]=true
	set BalanceStrings[i*4+4]="Multicast chance reduced: x2 by 7%/3.5%/0%, x3 by 7%/3.5%, x4 by 7%"
	set i=Tinker-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"drunkenhaze"),'A049','A33G','Y073',"e")//A049 -> Laser, A33G -> Laser
	call ConvertSkillData(i*4+2,ST(i*4+2,"fanofknives"),'A05E','A33F','Y074',"t")//A05E -> Heat Seeking Missile, A33F -> Heat Seeking Missile
	call ConvertSkillData(i*4+3,ST(i*4+3,"manaflareoff")+ST(i*4+3,"stampede"),'A0BQ',0,'Y075',"c")//A0BQ -> March of the Machines
	set i=i*4+4
	call ConvertSkillData(i,ST(i,"monsoon")+ST(i,"channel")+ST(i,"magicundefense"),'A065',0,'Y076',"r")//A065 -> Rearm
	set BalanceStrings[i]="Rearm has a 9/6/3 cooldown."
	set s=ST(i,"r1")+ST(i,"r4")+ST(i,"r55")+ST(i,"r18") //zeus silencer furion spectre
	if Mode_RC==false then
		set s=ST(i,"r44")+ST(i,"r95")+ST(i,"r2")+ST(i,"r3")+ST(i,"r14")+ST(i,"r17")
		set s=ST(i,"r6")+ST(i,"r7")+ST(i,"r8")+ST(i,"r9")+ST(i,"r123")+ST(i,"r11")+ST(i,"r12")+ST(i,"r15")+ST(i,"r16")
		set s=ST(i,"r19")+ST(i,"r20")+ST(i,"r21")+ST(i,"r22")+ST(i,"r23")+ST(i,"r24")+ST(i,"r25")
		set s=ST(i,"r26")+ST(i,"r27")+ST(i,"r28")
	endif
	call BalanceOffStackSwitch(i,"r29")
	call BalanceOffStackSwitch(i,"r30")
	call BalanceOffStackSwitch(i,"r31")
	set i=Furion-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"carrionswarm"),'A21E',0,'Y077',"t")//A21E -> Sprout
	call ConvertSkillData(i*4+2,ST(i*4+2,"blink"),'A01O',0,'Y078',"r")//A01O -> Teleportation
	call ConvertSkillData(i*4+3,ST(i*4+3,"forceofnature"),'AEfn',0,'Y079',"f")//AEfn -> Force of Nature
	call ConvertSkillData(i*4+4,ST(i*4+4,"chainlightning")+ST(i*4+4,"r55"),'A1W8','A1W9','Y080',"w")//A1W8 -> Wrath of Nature, A1W9 -> Wrath of Nature upgrade
	set i=PL-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"spellstealoff"),'A10D',0,'Y081',"t")//A10D -> Spirit Lance
	call ConvertSkillData(i*4+2,ST(i*4+2,"animatedead"),'A46H',0,'Y082',"d")//A46H -> Doppelganger
	call ConvertSkillData(i*4+3,null,'A46E','A46D','Y084',null)//A46E -> Phantom Rush, A46D -> Phantom Rush Inactive
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,null,'A0DB','QP0B','Y083',null)//A0DB -> Juxtapose, QP0B -> Juxtapose
	set IsPassiveAbility[i*4+4]=true
	set i=Tiny-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"phoenixmorph"),'A0LL',0,'Y085',"v")//A0LL -> Avalanche
	call ConvertSkillData(i*4+2,ST(i*4+2,"carrionscarabson"),'A0BZ',0,'Y086',"t")//A0BZ -> Toss
	call ConvertSkillData(i*4+3,null,'A19Q','QP1J','Y087',null)//A19Q -> Craggy Exterior, QP1J -> Craggy Exterior
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,null,'A0CY','QP1K','Y088',null)//A0CY -> Grow, QP1K -> Grow
	set IsPassiveAbility[i*4+4]=true
	set BalanceStrings[i*4+4]="Only increases damage by 40/80/120 for ranged heroes or heroes with range morphs."
	call BalanceOffStackSwitch(i*4+4,"bgdmg1")
	call BalanceOffStackSwitch(i*4+4,"bgdmg2")
	set IsPermanentAbility[i*4+4]=true
	set i=Techies-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"item 89"),'A05J',0,'Y089',"e")//A05J -> Land Mines
	call ConvertSkillData(i*4+2,ST(i*4+2,"stasistrap"),'A06H',0,'Y090',"t")//A06H -> Stasis Trap
	call ConvertSkillData(i*4+3,ST(i*4+3,"selfdestruct"),'A06B','A471','Y091',"c")//A06B -> Suicide Squad, Attack!
	call ConvertSkillData(i*4+4,ST(i*4+4,"ward")+ST(i*4+4,"chainlightning"),'A0AK','A1FY','Y092',"r")//A0AK -> Remote Mines, A1FY -> Remote Mines
	set IsMultiIconAbility[i*4+4]=true
	set i=Chen-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"drunkenhaze"),'A0KM',0,'Y093',"e")//A0KM -> Penitence
	call ConvertSkillData(i*4+2,ST(i*4+2,"ancestralspirittarget")+ST(i*4+2,"build"),'A0LV',0,'Y094',"t")//A0LV -> Test of Faith
	call ConvertSkillData(i*4+3,ST(i*4+3,"ambush"),'A28T','A361','Y095',"r")//A28T -> Holy Persuasion, A361 -> Holy Persuasion
	call ConvertSkillData(i*4+4,ST(i*4+4,"controlmagic")+ST(i*4+4,"r6"),'A0LT','A1CS','Y096',"d")//A0LT -> Hand of God, A1CS -> Hand of God upgraded
	set i=Luna-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"firebolt"),'A042',0,'Y097',"c")//A042 -> Lucent Beam
	call ConvertSkillData(i*4+2,ST(i*4+2,"buff placer")+ST(i*4+2,"arrows"),'A041','QP0D','Y098',null)//A041 -> Moon Glaive, QP0D -> Moon Glaive
	set IsAbilityDoesNotWork[i*4+2]=true
	set IsPermanentAbility[i*4+2]=true
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,null,'A062','QP0E','Y099',null)//A062 -> Lunar Blessing, QP0E -> Lunar Blessing
	set IsPassiveAbility[i*4+3]=true
	set IsPermanentAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"corporealform")+ST(i*4+4,"r28"),'A054','A00U','Y100',"e")//A054 -> Eclipse, A00U -> Eclipse
	set i=Sniper-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"possession"),'A064',0,'Y101',"r")//A064 -> Shrapnel
	call ConvertSkillData(i*4+2,null,'A03S','QP0F','Y102',null)//A03S -> Headshot, QP0F -> Headshot
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,ST(i*4+3,"range only"),'A03U','QP1Q','Y103',null)//A03U -> Take Aim, QP1Q -> Take Aim
	set IsPassiveAbility[i*4+3]=true
	set IsPermanentAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"thunderbolt"),'A04P','A1AU','Y104',"t")//A04P -> Assassinate, A1AU -> Assassinate upgrade
	set i=Troll-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"metamorphosis")+ST(i*4+1,"bearform")+ST(i*4+1,"unbearform")+ST(i*4+1,"melee morph")+ST(i*4+1,"bash"),'A0BE',0,'Y105',"g")//A0BE -> Berserker Rage
	call ConvertSkillData(i*4+2,ST(i*4+2,"autodispel")+ST(i*4+2,"loadarcher"),'A21M','A21N','Y106',"e")//A21M -> Whirling Axes, A21N -> Whirling Axes
	set IsMultiIconAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,null,'A0O0','QP0G','Y107',null)//A0O0 -> Fervor, QP0G -> Fervor
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"fanofknives"),'A1EJ',0,'Y108',"r")//A1EJ -> Battle Trance
	set i=Rhasta-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"forkedlightning"),'A010',0,'Y109',"r")//A010 -> Ether Shock
	call ConvertSkillData(i*4+2,ST(i*4+2,"hex"),'A0RX',0,'Y110',"d")//A0RX -> Voodoo
	call ConvertSkillData(i*4+3,ST(i*4+3,"magicleash"),'A00P',0,'Y111',"e")//A00P -> Shackles
	call ConvertSkillData(i*4+4,ST(i*4+4,"ward")+ST(i*4+4,"r7"),'A00H','A0A1','Y112',"w")//A00H -> Mass Serpent Ward, A0A1 -> Mass Serpent Ward
	set i=Wisp-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"chainlightning, frenzyoff"),'A1TA',0,'Y113',"t")//A1TA -> Tether
	call ConvertSkillData(i*4+2,ST(i*4+2,"fanofknives")+ST(i*4+2,"battleroar")+ST(i*4+2,"roar"),'A1T8',0,'Y114',"w")//A1T8 -> Spirits
	set IsMultiIconAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,ST(i*4+3,"manashieldon")+ST(i*4+3,"manashieldoff"),'A28Q',0,'Y115',"v")//A28Q -> Overcharge
	call ConvertSkillData(i*4+4,ST(i*4+4,"spellstealon"),'A1TB','A3FQ','Y116',"r")//A1TB -> Relocate
	call BalanceOffStackSwitch(i*4+4,"r30")
	set i=Pandaren-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"thunderclap"),'A06M',0,'Y117',"c")//A06M -> Thunder Clap
	call ConvertSkillData(i*4+2,ST(i*4+2,"drunkenhaze"),'Acdh',0,'Y118',"d")//Acdh -> Drunken Haze
	call ConvertSkillData(i*4+3,null,'A0MX','QP0H','Y119',null)//A0MX -> Drunken Brawler, QP0H -> Drunken Brawler
	set IsPassiveAbility[i*4+3]=true
	call ExBalanceStackSwitch(i*4+3,"ET-Drunken")
	call ExBalanceStackSwitch(i*4+3,"Tide-Drunken")
	call ConvertSkillData(i*4+4,ST(i*4+4,"elementalfury"),'A0MQ','A1B6','Y120',"r")//A0MQ -> Primal Split, A1B6 -> Primal Split upgrade
	set i=Centaur-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"stomp"),'A00S',0,'Y121',"f")//A00S -> Hoof Stomp
	call ConvertSkillData(i*4+2,ST(i*4+2,"firebolt"),'A00L',0,'Y122',"d")//A00L -> Double Edge
	call ConvertSkillData(i*4+3,null,'A00V','QP0I','Y123',null)//A00V -> Return, QP0I -> Return
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"fanofknives")+ST(i*4+4,"r8"),'A2O6','A384','Y124',"t")//A2O6 -> Stampede, A384 -> Stampede
	set i=Bounty-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"thunderbolt"),'A004',0,'Y125',"t")//A004 -> Shuriken Toss
	call ConvertSkillData(i*4+2,ST(i*4+2,"nagabuild")+ST(i*4+2,"r9"),'A1IQ',0,'Y126',null)//A1IQ -> Jinada
	set IsPassiveAbility[i*4+2]=true
	set BalanceStrings[i*4+2]="Jinada only deals 1.25/1.45/1.65/1.85x damage if it procs while 'Sleight of Fist' or 'Grow!' or 'Geminate attack' (on melee) picked"
	call ExBalanceStackSwitch(i*4+2,"Tide-Jinada")
	call ConvertSkillData(i*4+3,ST(i*4+3,"windwalk"),'A07A',0,'Y127',"w")//A07A -> Wind Walk
	call ConvertSkillData(i*4+4,ST(i*4+4,"faeriefire"),'A0B4',0,'Y128',"r")//A0B4 -> Track
	set i=indexid_DK-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"breathoffire"),'A03F',0,'Y129',"f")//A03F -> Breathe Fire
	call ConvertSkillData(i*4+2,ST(i*4+2,"thunderbolt"),'A0AR',0,'Y130',"t")//QB0G -> Dragon Tail, A0AR -> Dragon Tail
	call ConvertSkillData(i*4+3,null,'A0CL','QP0J','Y131',null)//A0CL -> Dragon Blood, QP0J -> Dragon Blood
	set IsPassiveAbility[i*4+3]=true
	set IsPermanentAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"metamorphosis")+ST(i*4+4,"range morph"),'QM00',0,'Y132',"r")//QM00 -> Elder Dragon Form
	set i=indexid_AM-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"orb effect"),'A022','QP0K','Y133',null)//A022 -> Mana Break, QP0K -> Mana Break
	set IsPassiveAbility[i*4+1]=true
	call ConvertSkillData(i*4+2,ST(i*4+2,"blink"),'AEbl',0,'Y134',"b")//AEbl -> Blink
	call ConvertSkillData(i*4+3,null,'A0KY','QP0L','Y135',null)//A0KY -> Spell Shield, QP0L -> Spell Shield
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"thunderbolt"),'A0E3',0,'Y136',"v")//A0E3 -> Mana Void
	set i=Trax-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"arrows")+ST(i*4+1,"range only"),'A026',0,'Y137',"r")//A026 -> Frost Arrows
	call ConvertSkillData(i*4+2,ST(i*4+2,"silence"),'A33A',0,'Y138',"e")//A33A -> Gust
	call ConvertSkillData(i*4+3,ST(i*4+3,"defend"),'A2O2',0,'Y139',null)//A2O2 -> Trueshot Aura
	set BalanceStrings[i*4+3]="Trueshot Aura only works on range creeps, no matter if your hero is range or melee"
	call ConvertSkillData(i*4+4,null,'QF88',0,'QY88',null)//A0VC -> Marksmanship
	set IsPassiveAbility[i*4+4]=true
	set i=Omni-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"channel"),'A08N',0,'Y141',"r")//A08N -> Purification
	call ConvertSkillData(i*4+2,ST(i*4+2,"antimagicshell"),'A08V',0,'Y142',"e")//A08V -> Repel
	call ConvertSkillData(i*4+3,null,'A06A','QP0M','Y143',null)//A06A -> Degen Aura, QP0M -> Degen Aura
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"battleroar"),'A0ER','A2S8','Y144',"g")//A0ER -> Guardian Angel, A2S8 -> Guardian Angel
	set i=Beastmaster-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"cannibalize"),'A0O1',0,'Y145',"w")//A0O1 -> Wild Axes
	call ConvertSkillData(i*4+2,ST(i*4+2,"awaken")+ST(i*4+2,"unsummon"),'A0OO',0,'Y146',"d")//A0OO -> Call of the Wild
	set IsMultiIconAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,null,'A0BD','QP0N','Y147',null)//A0BD -> Inner Beast, QP0N -> Inner Beast
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"thunderbolt"),'A0O2','A289','Y148',"r")//A0O2 -> Primal Roar, A289 -> Primal Roar
	set i=THD-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"carrionswarm"),'A0O7',0,'Y149',"d")//A0O7 -> Dual Breath
	call ConvertSkillData(i*4+2,ST(i*4+2,"breathoffire"),'A0O6',0,'Y150',"t")//A0O6 -> Ice Path
	call ConvertSkillData(i*4+3,ST(i*4+3,"acidbomb"),'A30T',0,'Y151',"q")//A30T -> Liquid Fire
	call ConvertSkillData(i*4+4,ST(i*4+4,"shockwave"),'A0O5','A1B1','Y152',"r")//A0O5 -> Macropyre, A1B1 -> Macropyre upgrade
	set i=Alchemist-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"preservation"),'A0IL',0,'Y153',"d")//A0IL -> Acid Spray
	call ConvertSkillData(i*4+2,ST(i*4+2,"fanofknives")+ST(i*4+2,"corrosivebreath"),'A1NI',0,'Y154',"e")//A1NI -> Unstable Concoction
	call ConvertSkillData(i*4+3,null,'A0O3','QP0O','Y155',null)//A0O3 -> Goblin's Greed, QP0O -> Goblin's Greed
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"metamorphosis")+ST(i*4+4,"melee morph")+ST(i*4+4,"r25"),'QB0K',0,'QY0K',"r")//QB0K -> Chemical Rage
	set i=Potm-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"coupleinstant"),'A0KV',0,'Y157',"t")//A0KV -> Starfall
	call ConvertSkillData(i*4+2,ST(i*4+2,"spies"),'A0L8',0,'Y158',"r")//A0L8 -> Elune's Arrow
	call ConvertSkillData(i*4+3,ST(i*4+3,"windwalk"),'A0LN',0,'Y159',"e")//A0LN -> Leap
	call ConvertSkillData(i*4+4,ST(i*4+4,"corporealform")+ST(i*4+4,"r11"),'A0KU',0,'Y160',"w")//A0KU -> Moonlight Shadow
	set i=Storm-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"fanofknives"),'A14P',0,'Y161',"r")//A14P -> Static Remnant
	call ConvertSkillData(i*4+2,ST(i*4+2,"chainlightning"),'A14R',0,'Y162',"e")//A14R -> Electric Vortex
	call ConvertSkillData(i*4+3,null,'A0QW','QP1V','Y163',null)//A0QW -> Overload, QP1V -> Overload
	set IsPassiveAbility[i*4+3]=true
	set BalanceStrings[i*4+3]="Spells with a cooldown of 3s or less will only proc Overload every 2nd cast (except Ball Lightning)."
	call ConvertSkillData(i*4+4,ST(i*4+4,"channel"),'A14O','A3FJ','Y164',"g")//A14O -> Ball Lightning
	set i=Huskar-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"massteleport"),'A0QP',0,'Y165',"v")//A0QP -> Inner Vitality
	call ConvertSkillData(i*4+2,ST(i*4+2,"arrows"),'A0QN',0,'Y166',"r")//A0QN -> Burning Spear
	call ConvertSkillData(i*4+3,null,'A0QQ','QP1L','Y167',null)//A0QQ -> Berserker's Blood, QP1L -> Berserker's Blood
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"firebolt"),'A0QR','A1B3','Y168',"f")//A0QR -> Life Break, A1B3 -> Life Break upgrade
	set i=Lanaya-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"fanofknives"),'A1EA',0,'Y169',"r")//A1EA -> Refraction
	call ConvertSkillData(i*4+2,ST(i*4+2,"windwalk"),'A0RV',0,'Y170',"d")//A0RV -> Meld
	call ConvertSkillData(i*4+3,ST(i*4+3,"range only"),'A0RO','QP1S','Y171',null)//A0RO -> Psi Blades, QP1S -> Psi Blades
	set IsPassiveAbility[i*4+3]=true
	set IsPermanentAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"curse")+ST(i*4+4,"spiritwolf"),'A0RP','A449','Y172',"c")//A0RP -> Psionic Trap, A449 -> Psionic Trap
	set IsMultiIconAbility[i*4+4]=true
	set i=Puck-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"spiritlink")+ST(i*4+1,"coupletarget"),'A0S9',0,'Y173',"r")//A0S9 -> Illusory Orb
	set IsMultiIconAbility[i*4+1]=true
	call ConvertSkillData(i*4+2,ST(i*4+2,"creepanimatedead"),'A0SC',0,'Y174',"w")//A0SC -> Waning Rift
	call ConvertSkillData(i*4+3,ST(i*4+3,"phaseshift"),'A0SB',0,'Y175',"f")//A0SB -> Phase Shift
	call ConvertSkillData(i*4+4,ST(i*4+4,"rainofchaos"),'A0S8','A1QP','Y176',"c")//A0S8 -> Dream Coil, A1QP -> Dream Coil
	set i=Clock-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"creepdevour"),'A0Z4',0,'Y177',"e")//A0Z4 -> Battery Assault
	call ConvertSkillData(i*4+2,ST(i*4+2,"neutraldetectaoe"),'A0Z5',0,'Y178',"c")//A0Z5 -> Power Cog
	call ConvertSkillData(i*4+3,ST(i*4+3,"blizzard"),'A0Z6',0,'Y179',"r")//A0Z6 -> Rocket Flare
	call ConvertSkillData(i*4+4,ST(i*4+4,"clusterrockets"),'A0Z8','A1CV','Y180',"t")//A0Z8 -> Hookshot, A1CV -> Hookshot Upgrade
	set i=Admiral-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"rejuvination"),'A136',0,'Y181',"e")//A136 -> Torrent
	call ConvertSkillData(i*4+2,ST(i*4+2,"orcbuild")+ST(i*4+2,"r12"),'A13T',0,'Y182',null)//A13T -> Tidebringer
	set IsPassiveAbility[i*4+2]=true
	set BalanceStrings[i*4+2]="Tidebringer only deals 80% AoE damage for ranged attackers."
	call BalanceOffStackSwitch(i*4+2,"bgdmg2")
	call ExBalanceStackSwitch(i*4+2,"Tide-Jinada")
	call ExBalanceStackSwitch(i*4+2,"Tide-Drunken")
	call ConvertSkillData(i*4+3,ST(i*4+3,"incineratearrow")+ST(i*4+3,"incineratearrowoff"),'A11N',0,'Y183',"x")//A11N -> X Marks The Spot
	call BalanceOffStackSwitch(i*4+3,"r29")
	set IsMultiIconAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"spiritofvengeance"),'A11K',0,'Y184',"t")//A11K -> Ghost Ship
	set i=WR-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"chainlightning"),'A12J',0,'Y185',"e")//A12J -> Shackleshot
	call ConvertSkillData(i*4+2,ST(i*4+2,"spirittroll"),'A12K',0,'Y186',"r")//A12K -> Powershot
	call ConvertSkillData(i*4+3,ST(i*4+3,"fanofknives"),'A14I',0,'Y187',"w")//A14I -> Windrunner
	call ConvertSkillData(i*4+4,ST(i*4+4,"incineratearrowon"),'A12P','A1D6','Y188',"f")//A12P -> Focus Fire, A1D6 -> Focus Fire Upgraded
	set i=Gyro-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"creepthunderbolt"),'A1SO',0,'Y189',"r")//A1SO -> Rocket Barrage
	call ConvertSkillData(i*4+2,ST(i*4+2,"chainlightning"),'A1SQ',0,'Y190',"e")//A1SQ -> Homing Missile
	call ConvertSkillData(i*4+3,ST(i*4+3,"orb effect")+ST(i*4+3,"range only")+ST(i*4+3,"fanofknives")+ST(i*4+3,"multi-attack"),'A229',0,'Y191',"f")//A229 -> Flak Cannon
	call ConvertSkillData(i*4+4,ST(i*4+4,"ravenform"),'A1T5','A235','Y192',"c")//A1T5 -> Call Down, A235 -> Call Down
	set i=Disruptor-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"autodispel"),'A1TV',0,'Y193',"c")//A1TV -> Thunder Strike
	call ConvertSkillData(i*4+2,ST(i*4+2,"chainlightning"),'A1SW',0,'Y194',"d")//A1SW -> Glimpse
	call ConvertSkillData(i*4+3,ST(i*4+3,"rechargeoff"),'A1SU',0,'Y195',"e")//A1SU -> Kinetic Field
	call ConvertSkillData(i*4+4,ST(i*4+4,"deathpact"),'A1U6','A30N','Y196',"r")//A1U6 -> Static Storm, A30N -> Static Storm
	set i=Tusk-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"standdown"),'A1YO',0,'Y197',"e")//A1YO -> Ice Shards
	call ConvertSkillData(i*4+2,ST(i*4+2,"frenzyon"),'A1S7',0,'Y198',"w")//A1S7 -> Snowball
	call ConvertSkillData(i*4+3,ST(i*4+3,"summongrizzly"),'A1YR',0,'Y199',"f")//A1YR -> Frozen Sigil
	call ConvertSkillData(i*4+4,ST(i*4+4,"fanofknives")+ST(i*4+4,"autoharvestlumber"),'A1YQ','A3DE','Y200',"r")//A1YQ -> Walrus Punch, A3DE -> Walrus Punch
	call BalanceOffStackSwitch(i*4+4,"bgdmg2")
	set i=Phoenix-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"creepthunderclap"),'A1RJ',0,'Y201',"d")//A1RJ -> Icarus Dive
	call ConvertSkillData(i*4+2,ST(i*4+2,"gold2lumber")+ST(i*4+2,"harvest"),'A1YX',0,'Y202',"f")//A1YX -> Fire Spirits
	call ConvertSkillData(i*4+3,ST(i*4+3,"charm")+ST(i*4+3,"immolation")+ST(i*4+3,"unimmolation")+ST(i*4+3,"animatedead"),'A1YY',0,'Y203',"r")//A1YY -> Sun Ray
	call ConvertSkillData(i*4+4,ST(i*4+4,"rechargeon")+ST(i*4+4,"r123")+ST(i*4+4,"locust"),'A1RK','A43H','Y204',"v")//A1RK -> Supernova, A43H -> Supernova
	set i=BB-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"darkritual"),'A0FW',0,'Y205',"g")//A0FW -> Viscous Nasal Goo
	call ConvertSkillData(i*4+2,ST(i*4+2,"fanofknives"),'A0GP',0,'Y206',"r")//A0GP -> Quill Spray
	call ConvertSkillData(i*4+3,null,'A0M3','QP1M','Y207',null)//A0M3 -> Bristleback, QP1M -> Bristleback
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,null,'A0FV','QP1N','Y208',null)//A0FV -> Warpath, QP1N -> Warpath
	set IsPassiveAbility[i*4+4]=true
	set BalanceStrings[i*4+4]="Spells with a cooldown of 3s or less will only proc Warpath every 2nd cast (except Goo and Quill Spray)."
	set i=Rubick-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"wispharvest"),'A27F',0,'Y209',"z")//A27F -> Telekinesis
	call ConvertSkillData(i*4+2,ST(i*4+2,"tranquility"),'A27G',0,'Y210',"x")//A27G -> Fade Bolt
	call ConvertSkillData(i*4+3,null,'A27V','QP0P','Y211',null)//A27V -> Null Field, QP0P -> Null Field
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"transmute")+ST(i*4+4,"shbug"),'A27H','A30J','Y212',"q")//A27H -> Spell Steal, A30J -> Spell Steal
	set IsMultiIconAbility[i*4+4]=true
	set i=Xin-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"fanofknives"),'A2H3',0,'Y213',"c")//A2H3 -> Searing Chains
	call ConvertSkillData(i*4+2,ST(i*4+2,"recharge")+ST(i*4+2,"metamorphosis"),'QB0L',0,'QY0L',"t")//QB0L -> Sleight of Fist, A2H0 -> Sleight of Fist, QY0L -> Sleight of fist balanced upg
	set BalanceStrings[i*4+2]="Grow! provides less damage while using Sleight of Fist."
	call ConvertSkillData(i*4+3,ST(i*4+3,"darksummoning")+ST(i*4+2,"r27"),'A2HS',0,'Y215',"e")//A2HS -> Flame Guard
	call ConvertSkillData(i*4+4,ST(i*4+4,"ancestralspirit")+ST(i*4+4,"acolyteharvest")+ST(i*4+4,"acidbomb"),'A2JR','A2JL','Y216',"r")//A2JR -> Fire Remnant, A2JL -> Fire Remnant
	set IsMultiIconAbility[i*4+4]=true
	set i=Legion-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"steal"),'A2JB',0,'Y217',"w")//A2JB -> Overwhelming Odds
	call ConvertSkillData(i*4+2,ST(i*4+2,"creepheal"),'A2J2',0,'Y218',"t")//A2J2 -> Press The Attack
	call ConvertSkillData(i*4+3,null,'A2EY','QP1O','Y219',null)//A2EY -> Moment of Courage, QP1O -> Moment of Courage
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"autodispeloff"),'A2CI','A38C','Y220',"d")//A2CI -> Duel, A38C -> Duel
	set i=Skywrath-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"chainlightning"),'A2BE',0,'Y221',"c")//A2BE -> Arcane Bolt
	call ConvertSkillData(i*4+2,ST(i*4+2,"fanofknives"),'A2IT',0,'Y222',"t")//A2IT -> Concussive Shot
	call ConvertSkillData(i*4+3,ST(i*4+3,"soulburn"),'A2HN',0,'Y223',"r")//A2HN -> Ancient Seal
	call ConvertSkillData(i*4+4,ST(i*4+4,"submerge"),'A2BG','A30H','Y224',"e")//A2BG -> Mystic Flare, A30H -> Mystic Flare
	set i=Timber-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"fanofknives"),'A2FK',0,'Y225',"d")//A2FK -> Whirling Death
	call ConvertSkillData(i*4+2,ST(i*4+2,"summonfactory"),'A2E3',0,'Y226',"t")//A2E3 -> Timber Chain
	call ConvertSkillData(i*4+3,null,'A2E4','QP1P','Y227',null)//A2E4 -> Reactive Armor, QP1P -> Reactive Armor
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"massteleport")+ST(i*4+4,"immolation")+ST(i*4+4,"unimmolation")+ST(i*4+4,"windwalk")+ST(i*4+4,"auraunholy"),'A2E5','A43S','Y228',"c")//A2E5 -> Chakram, A43S -> Chakram
	set i=Lycan-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"spiritwolf"),'A03D',0,'Y229',"v")//A03D -> Summon Wolves
	call ConvertSkillData(i*4+2,ST(i*4+2,"deathcoil"),'A0ZF',0,'Y230',"w")//A0ZF -> Howl
	call ConvertSkillData(i*4+3,null,'A03E','QP0Q','Y231',null)//A03E -> Feral Impulse, QP0Q -> Feral Impulse
	set IsPassiveAbility[i*4+3]=true
	set IsPermanentAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"metamorphosis")+ST(i*4+4,"melee morph")+ST(i*4+4,"r95"),'QM02',0,'Y232',"f")//QM02 -> Shapeshift
	set i=Brood-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"parasite"),'A0BH',0,'Y233',"w")//A0BH -> Spawn Spiderlings
	call ConvertSkillData(i*4+2,ST(i*4+2,"restoration")+ST(i*4+2,"inv bug 1"),'Z234',0,'Y234',"b")//Z234 -> Spin Web
	set IsPermanentAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,null,'Q0BK','QP29','Y235',null)//Q0BK -> Incapacitating Bite, QP29 -> Incapacitating Bite hidden
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"bash")+ST(i*4+4,"roar"),'A0WQ',0,'Y236',"t")//A0WQ -> Insatiable Hunger
	set i=PA-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"summonphoenix"),'A0YM',0,'Y237',"d")//A0YM -> Stifling Dagger
	call ConvertSkillData(i*4+2,ST(i*4+2,"deathcoil"),'A0PL',0,'Y238',"b")//A0PL -> Phantom Strike
	call ConvertSkillData(i*4+3,null,'A03P','QP0R','Y239',null)//A03P -> Blur, QP0R -> Blur
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,null,'A03Q','QP0S','Y240',null)//A03Q -> Coup de grace, QP0S -> Coup de grace
	set IsPassiveAbility[i*4+3]=true
	set i=Medusa-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"range only")+ST(i*4+1,"immolation")+ST(i*4+1,"unimmolation"),'A1C0','A418','Y241',"y")//A1C0 -> Splitshot, A418 -> Splitshot
	call ConvertSkillData(i*4+2,ST(i*4+2,"chainlightning"),'A0G2',0,'Y242',"c")//A0G2 -> Mystic Snake
	call ConvertSkillData(i*4+3,ST(i*4+3,"manashieldon")+ST(i*4+3,"manashieldoff")+ST(i*4+3,"shbug"),'A0MP',0,'Y243',"e")//A0MP -> Mana Shield
	call ConvertSkillData(i*4+4,ST(i*4+4,"lavamonster"),'A1AT',0,'Y244',"g")//A1AT -> Stone Gaze
	set i=Bala-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"thunderbolt"),'A02H',0,'Y245',"v")//A02H -> Void
	call ConvertSkillData(i*4+2,ST(i*4+2,"drunkenhaze"),'A08C',0,'Y246',"f")//A08C -> Crippling Fear
	call ConvertSkillData(i*4+3,null,'P247','A086','Y247',null)//P247 -> Hunter in the Night, A086 -> Hunter in the Night
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"battlestations")+ST(i*4+4,"r14"),'DRKN','DRKU','Y248',"r")//DRKN -> Darkness
	set IsPermanentAbility[i*4+4]=true
	set i=Leoric-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"thunderbolt"),'QB0H',0,'QY0H',"t")//QB0H -> Hellfire Blast, AHtb -> Hellfire Blast
	call ConvertSkillData(i*4+2,null,'P250','QP0U','Y250',null)//P250 -> Vampiric Aura, QP0U -> Vampiric Aura
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,ST(i*4+3,"wispharvest"),'A2S0','QP0W','Y251',null)//A2S0 -> Mortal Strike, QP0W -> Mortal Strike
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"reincarnation")+ST(i*4+4,"r15"),'A01Y','A1AZ','Y252',null)//A01Y -> Reincarnation, A1AZ -> Reincarnation upgrade
	set IsPassiveAbility[i*4+4]=true
	set i=Doom-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"channel")+ST(i*4+1,"animatedead")+ST(i*4+1,"stomp")+ST(i*4+1,"tornado")+ST(i*4+1,"ensnare")+ST(i*4+1,"thunderclap")+ST(i*4+1,"purge"),'A10R','A32Z','Y253',"e")//A10R -> Devour, A32Z -> Devour
	set s=ST(i*4+1,"shockwave")+ST(i*4+1,"frostarmor")+ST(i*4+1,"manaburn")+ST(i*4+1,"heal")+ST(i*4+1,"chainlightning")+ST(i*4+1,"raisedead")+ST(i*4+1,"thunderbolt")
	set IsMultiIconAbility[i*4+1]=true
	call ConvertSkillData(i*4+2,ST(i*4+2,"fanofknives"),'A1OP',0,'Y254',"t")//A1OP -> Scorched Earth
	call ConvertSkillData(i*4+3,ST(i*4+3,"firebolt"),'A094',0,'Y255',"v")//A094 -> LVL? Death
	call ConvertSkillData(i*4+4,ST(i*4+4,"doom"),'A0MU','A0A2','Y256',"d")//A0MU -> Doom, A0A2 -> Doom
	set i=NA-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"impale"),'A0X7',0,'Y257',"e")//A0X7 -> Impale
	call ConvertSkillData(i*4+2,ST(i*4+2,"creepheal"),'A1H5',0,'Y258',"r")//A1H5 -> Mana Burn
	call ConvertSkillData(i*4+3,ST(i*4+3,"fanofknives"),'A2KO',0,'Y259',"d")//A2KO -> Spiked Carapace
	call ConvertSkillData(i*4+4,ST(i*4+4,"windwalk"),'A09U',0,'Y260',"v")//A09U -> Vendetta
	set i=Slardar-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"berserk")+ST(i*4+1,"ibug"),'A05C',0,'Y261',"t")//A05C -> Sprint
	call ConvertSkillData(i*4+2,ST(i*4+2,"roar"),'A29K',0,'Y262',"r")//QB0I -> Slithereen Crush, A29K -> Slithereen Crush
	call ConvertSkillData(i*4+3,ST(i*4+3,"bash"),'A0JJ',0,'Y263',null)//A0JJ -> Bash, QP0V -> Bash
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"faeriefire"),'QB0C',0,'QY0C',"g")//QB0C -> Amplify Damage, A034 -> Amplify Damage
	set i=QoP-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"shadowstrike"),'A0Q7',0,'Y265',"d")//A0Q7 -> Shadow Strike
	call ConvertSkillData(i*4+2,ST(i*4+2,"blink"),'A0ME',0,'Y266',"b")//A0ME -> Blink QoP
	call ConvertSkillData(i*4+3,ST(i*4+3,"fanofknives"),'A04A',0,'Y267',"f")//A04A -> Scream of Pain
	call ConvertSkillData(i*4+4,ST(i*4+4,"shockwave"),'A28R','A28S','Y268',"w")//A28R -> Sonic Wave, A28S -> Sonic Wave
	set i=Bone-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"berserk"),'A030',0,'Y269',"t")//A030 -> Strafe
	call ConvertSkillData(i*4+2,ST(i*4+2,"arrows")+ST(i*4+2,"range only")+ST(i*4+2,"channel"),'AHfa',0,'Y270',"r")//AHfa -> Searing Arrows
	call ConvertSkillData(i*4+3,ST(i*4+3,"windwalk"),'QB0A',0,'QY0A',"w")//QB0A -> Skeleton Walk Balance, A025 -> Skeleton Walk
	call ConvertSkillData(i*4+4,ST(i*4+4,"innerfire"),'A04Q',0,'Y272',"e")//A04Q -> Death Pact
	set i=Void-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"carrionswarm"),'A0LK',0,'Y273',"w")//A0LK -> Time Walk
	call ConvertSkillData(i*4+2,null,'A0CZ','QP22','Y274',null)//A0CZ -> Backtrack, QP22 -> Backtrack
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,ST(i*4+3,"bash"),'A081','QP0X','Y275',null)//A081 -> Time Lock, QP0X -> Time Lock
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"clusterrockets")+ST(i*4+4,"r16"),'A0J1','A1D7','Y276',"c")//A0J1 -> Chronosphere, A1D7 -> Chronosphere Upgraded
	set i=Viper-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"arrows")+ST(i*4+1,"range only"),'A09V',0,'Y277',"c")//A09V -> Poison Attack
	call ConvertSkillData(i*4+2,null,'A1A3','QP21','Y278',null)//A1A3 -> Nethertoxin, QP21 -> Nethertoxin
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,null,'A0MM','QP0Y','Y279',null)//A0MM -> Corrosive Skin, QP0Y -> Corrosive Skin
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"shadowstrike"),'A080','A1UZ','Y280',"v")//A080 -> Viper Strike, A1UZ -> Viper Strike
	set i=Razor-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"fanofknives"),'A1E7',0,'Y281',"f")//A1E7 -> Plasma Field
	call ConvertSkillData(i*4+2,ST(i*4+2,"tankdroppilot"),'A1DP',0,'Y282',"c")//A1DP -> Static Link
	call ConvertSkillData(i*4+3,null,'A1E6','QP0Z','Y283',null)//A1E6 -> Unstable Current, QP0Z -> Unstable Current
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"darkportal"),'A1AO','A1UV','Y284',"e")//A1AO -> Eye of the Storm, A1UV -> Eye of the Storm
	set i=Lifestealer-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"852273"),'A0T2',0,'Y285',"r")//A0T2 -> Rage
	call ConvertSkillData(i*4+2,ST(i*4+2,"agi bug 1"),'A0SS','QP1W','Y286',null)//A0SS -> Feast, QP1W -> Feast
	set IsPassiveAbility[i*4+2]=true
	set BalanceStrings[i*4+2]="Feast only regenerates/deals 1.75/2.75/3.75/4.75% HP on ranged heroes."
	call ConvertSkillData(i*4+3,ST(i*4+3,"chainlightning"),'A194',0,'Y287',"w")//A194 -> Open Wounds
	call ConvertSkillData(i*4+4,ST(i*4+4,"decouple"),'A0SW',0,'Y288',"t")//A0SW -> Infest
	set i=Pugna-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"unavatar"),'A0MT',0,'Y289',"b")//A0MT -> Nether Blast
	call ConvertSkillData(i*4+2,ST(i*4+2,"banish"),'A2TD',0,'Y290',"c")//A2TD -> Decrepify
	call ConvertSkillData(i*4+3,ST(i*4+3,"summongrizzly"),'A09D',0,'Y291',"w")//A09D -> Nether Ward
	call ConvertSkillData(i*4+4,ST(i*4+4,"drain"),'A0CC','A02Z','Y292',"d")//A0CC -> Life Drain, A02Z -> Life Drain
	set SkillIcon[i*4+4]="ReplaceableTextures\\CommandButtons\\BTNLifeDrain.blp"
	set i=Tide-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"acidbomb"),'A046',0,'Y293',"g")//A046 -> Gush
	call ConvertSkillData(i*4+2,null,'A04E','QP10','Y294',null)//A04E -> Kraken Shell, QP10 -> Kraken Shell
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,ST(i*4+3,"roar"),'A226',0,'Y295',"c")//A226 -> Anchor Smash
	call ConvertSkillData(i*4+4,ST(i*4+4,"howlofterror"),'A29I',0,'Y296',"v")//A29I -> Ravage
	set i=Bane-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"innerfire"),'A04V',0,'Y297',"e")//A04V -> Enfeeble
	call ConvertSkillData(i*4+2,ST(i*4+2,"chainlightning"),'A0GK',0,'Y298',"b")//A0GK -> Brain Sap
	call ConvertSkillData(i*4+3,ST(i*4+3,"sleep"),'A04Y',0,'Y299',"t")//A04Y -> Nightmare
	call ConvertSkillData(i*4+4,ST(i*4+4,"magicleash"),'A02Q','A1D9','Y300',"f")//A02Q -> Fiend's Grip, A1D9 -> Fiend's Grip Upgrade
	set i=Necrolyte-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"fanofknives"),'A05V',0,'Y301',"d")//A05V -> Death Pulse
	call ConvertSkillData(i*4+2,null,'A01N','QP11','Y302',null)//A01N -> Heartstopper Aura, QP11 -> Heartstopper Aura
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,null,'A060','QP12','Y303',null)//A060 -> Sadist, QP12 -> Sadist
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"thunderbolt"),'A067','A08P','Y304',"r")//A067 -> Reaper's Scythe, A08P -> Reaper's Scythe
	set i=Pudge-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"detectaoe"),'A06I',0,'Y305',"t")//A06I -> Meat Hook
	call ConvertSkillData(i*4+2,ST(i*4+2,"unimmolation"),'A06K',0,'Y306',"r")//A06K -> Rot
	call ConvertSkillData(i*4+3,null,'A06D','QP13','Y307',null)//A06D -> Flesh Heap, QP13 -> Flesh Heap
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"magicleash"),'A0FL','A1CX','Y308',"d")//A0FL -> Dismember, A1CX -> Dismember Upgraded
	set i=Barathum-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"detonate"),'A1P8',0,'Y309',"c")//A1P8 -> Charge of Darkness
	call ConvertSkillData(i*4+2,null,'A0ES','QP14','Y310',null)//A0ES -> Empowering Haste, QP14 -> Empowering Haste
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,ST(i*4+3,"bash"),'A0G5','QP1X','Y311',null)//A0G5 -> Greater Bash, QP1X -> Greater Bash
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"creepheal"),'A0G4','A1D8','Y312',"e")//A0G4 -> Nether Strike, A1D8 -> Nether Strike Upgrade
	set i=Weaver-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"tankloadpilot"),'A1QW',0,'Y313',"r")//A1QW -> The Swarm
	call ConvertSkillData(i*4+2,ST(i*4+2,"windwalk"),'A0CA',0,'Y314',"c")//A0CA -> Shukuchi
	call ConvertSkillData(i*4+3,ST(i*4+3,"orb effect"),'A0CG',0,'Y315',null)//A0CG -> Geminate Attack
	set IsPassiveAbility[i*4+3]=true
	call BalanceOffStackSwitch(i*4+3,"bgdmg2")
	call ConvertSkillData(i*4+4,ST(i*4+4,"disassociate"),'A0CT','A3DM','Y316',"t")//A0CT -> Time Lapse, A3DM -> Time Lapse
	call BalanceOffStackSwitch(i*4+4,"r31")
	set i=indexid_SF-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"roar")+ST(i*4+1,"howlofterror")+ST(i*4+1,"battleroar"),'A0EY',0,'Y317',"z")//A0EY -> Shadowraze
	set IsMultiIconAbility[i*4+1]=true
	call ConvertSkillData(i*4+2,null,'Z318','A0BR','Y318',null)//Z318 -> Necromastery, A0BR -> Necromastery
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,null,'A0FU','QP15','Y319',null)//A0FU -> Presence of the Dark Lord, QP15 -> Presence of the Dark Lord
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+1,"852273"),'A29J',0,'Y320',"r")//A29J -> Requiem of Souls
	set i=SK-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"disenchant"),'A06O',0,'Y321',"e")//A06O -> Burrowstrike
	call ConvertSkillData(i*4+2,ST(i*4+2,"voodoo"),'A0H0',0,'Y322',"r")//A0H0 -> Sand Storm
	call ConvertSkillData(i*4+3,null,'A0FA','QP16','Y323',null)//A0FA -> Caustic Finale, QP16 -> Caustic Finale
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"lightningshield"),'A06R','A1B4','Y324',"c")//A06R -> Epicenter, A1B4 -> Epicenter upgrade
	set i=Axe-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"dismount"),'A0I6',0,'Y325',"e")//A0I6 -> Berserker's Call
	call ConvertSkillData(i*4+2,ST(i*4+2,"creepheal"),'A0S1',0,'Y326',"r")//A0S1 -> Battle Hunger
	call ConvertSkillData(i*4+3,null,'A0C6','QP17','Y327',null)//A0C6 -> Counter Helix, QP17 -> Counter Helix
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"chainlightning"),'A0E2','A1MR','Y328',"c")//A0E2 -> Culling Blade, A1MR -> Culling Blade
	set i=BS-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"farsight"),'A44X',0,'Y61A',"d")//A44X -> Bloodrage New
	call ConvertSkillData(i*4+2,ST(i*4+2,"creepheal"),'A44Z',0,'Y61B',"b")//A44Z -> Blood Rite
	call ConvertSkillData(i*4+3,null,'A0I8','QP1Z','Y331',null)//A0I8 -> Strygwyr's Thirst, QP1Z -> Strygwyr's Thirst
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"shadowsight"),'A0LH',0,'Y332',"r")//A0LH -> Rupture
	set i=Abaddon-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"townbelloff"),'A0I3',0,'Y333',"d")//A0I3 -> Death Coil
	call ConvertSkillData(i*4+2,ST(i*4+2,"chainlightning"),'A0MF',0,'Y334',"t")//A0MF -> Aphotic Shield
	call ConvertSkillData(i*4+3,null,'A0MG','QP18','Y335',null)//A0MG -> Frostmourne, QP18 -> Frostmourne
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"windwalk")+ST(i*4+4,"r17"),'A0NS','A1DA','Y336',"b")//A0NS -> Borrowed Time, A1DA -> Borrowed Time Upgrade
	set i=Spectre-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"tankpilot"),'A0HW',0,'Y337',"d")//A0HW -> Spectral Dagger
	call ConvertSkillData(i*4+2,null,'A0FX','QP19','Y338',null)//A0FX -> Desolate, QP19 -> Desolate hidden
	set IsPassiveAbility[i*4+2]=true
	set BalanceStrings[i*4+2]="Ranged heroes and Illusions only deal half of the damage"
	call ConvertSkillData(i*4+3,null,'A0NA','QP20','Y339',null)//A0NA -> Dispersion, QP20 -> Dispersion
	set IsPassiveAbility[i*4+3]=true
	set BalanceStrings[i*4+3]="Dispersion disperses only 8/10/12/14% damage on STR heroes"
	call ConvertSkillData(i*4+4,ST(i*4+4,"healingspray")+ST(i*4+4,"healingwave")+ST(i*4+4,"r18"),'A0H9',0,'Y340',"t")//A0H9 -> Haunt
	set IsMultiIconAbility[i*4+4]=true
	set i=WD-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"chainlightning"),'A0NM',0,'Y341',"c")//A0NM -> Paralyzing Cask
	call ConvertSkillData(i*4+2,ST(i*4+2,"unimmolation"),'A0NE',0,'Y342',"v")//A0NE -> Voodoo Restoration
	call ConvertSkillData(i*4+3,ST(i*4+3,"renew"),'A0NO',0,'Y343',"e")//A0NO -> Maledict
	call ConvertSkillData(i*4+4,ST(i*4+4,"tornado"),'A0NT','A0NX','Y344',"d")//A0NT -> Death Ward, A0NX -> Death Ward
	set i=OD-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"arrows")+ST(i*4+1,"range only"),'A0OI',0,'Y345',"r")//A0OI -> Arcane Orb
	call ConvertSkillData(i*4+2,ST(i*4+2,"chainlightning"),'A0OJ',0,'Y346',"t")//A0OJ -> Astral Imprisonment
	call ConvertSkillData(i*4+3,ST(i*4+3,"r19"),'A0IF','QP1A','Y347',null)//A0IF -> Essence Aura, QP1A -> Essence Aura
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"blizzard"),'A0OK','A1VW','Y348',"c")//A0OK -> Sanity's Eclipse, A1VW -> Sanity's Eclipse
	set i=WL-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"autodispelon"),'A0J5',0,'Y349',"f")//A0J5 -> Fatal Bonds
	call ConvertSkillData(i*4+2,ST(i*4+2,"creepheal"),'A0AS',0,'Y350',"w")//A0AS -> Shadow Word
	call ConvertSkillData(i*4+3,ST(i*4+3,"blizzard"),'A06P',0,'Y351',"e")//A06P -> Upheaval
	call ConvertSkillData(i*4+4,ST(i*4+4,"inferno")+ST(i*4+4,"r20"),'S008','S00U','Y352',"r")//S008 -> Rain of Chaos, S00U -> Rain of Chaos
	set i=Geomancer-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"renewon"),'A0NB',0,'Y353',"e")//A0NB -> Earthbind
	call ConvertSkillData(i*4+2,ST(i*4+2,"carrionscarabsoff"),'A0N8',0,'Y354',"f")//A0N8 -> Poof
	call ConvertSkillData(i*4+3,null,'A0N7','QP1B','Y355',null)//A0N7 -> Geostrike, QP1B -> Geostrike
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,null,'A0MW','A27C','Y356',null)//A0MW -> Divided We Stand, A27C -> Divided We Stand
	set IsAbilityDoesNotWork[i*4+4]=true
	set i=Dazzle-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"thunderbolt"),'A0NQ',0,'Y357',"t")//A0NQ -> Poison Touch
	call ConvertSkillData(i*4+2,ST(i*4+2,"devourmagic"),'A10L',0,'Y358',"g")//A10L -> Shallow Grave
	call ConvertSkillData(i*4+3,ST(i*4+3,"darkportal"),'A0OR',0,'Y359',"d")//A0OR -> Shadow Wave
	call ConvertSkillData(i*4+4,ST(i*4+4,"renewoff"),'A10Q','A1DB','Y360',"w")//A10Q -> Weave, A1DB -> Weave Upgrade
	set i=Pit-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"unavengerform"),'A01I',0,'Y361',"f")//A01I -> Firestorm
	call ConvertSkillData(i*4+2,ST(i*4+2,"flamestrike"),'A0RA',0,'Y362',"t")//A0RA -> Pit of Malice
	call ConvertSkillData(i*4+3,null,'AIcd','QP1C','Y363',null)//AIcd -> Atrophy Aura, QP1C -> Atrophy Aura
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"divineshield")+ST(i*4+4,"whirlwind"),'A0R0',0,'Y364',"d")//A0R0 -> Dark Rift
	set i=Zombie-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"repair, str bug"),'A15S','A3JX','Y365',"d")//A15S -> Decay
	call ConvertSkillData(i*4+2,ST(i*4+2,"lumber2gold"),'A0R5',0,'Y366',"r")//A0R5 -> Soul Rip
	call ConvertSkillData(i*4+3,ST(i*4+3,"soulpreservation")+ST(i*4+3,"r21"),'A15V',0,'Y367',"t")//A15V -> Tombstone
	call ConvertSkillData(i*4+4,ST(i*4+4,"metamorphosis")+ST(i*4+4,"melee morph")+ST(i*4+4,"r24"),'QM03',0,'Y368',"f")//QM03 -> Flesh Golem
	set IsMultiIconAbility[i*4+4]=true
	set i=DS-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"repairoff"),'A0QE',0,'Y369',"c")//A0QE -> Vacuum
	call ConvertSkillData(i*4+2,ST(i*4+2,"autoentangle")+ST(i*4+2,"r26"),'A0QG',0,'Y370',"e")//A0QG -> Ion Shell
	call ConvertSkillData(i*4+3,ST(i*4+3,"bloodlust"),'A0R7',0,'Y371',"r")//A0R7 -> Surge
	call ConvertSkillData(i*4+4,ST(i*4+4,"manaflareon"),'A0QK','A21Q','Y372',"w")//A0QK -> Wall of Replica, A21Q -> Wall of Replica
	set i=Kodo-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"tranquility"),'A32A',0,'A32T',"f")//A32A -> Spit
	call ConvertSkillData(i*4+2,ST(i*4+2,"curse"),'A32C',0,'A32U',"e")//A32C -> Trample
	call ConvertSkillData(i*4+3,ST(i*4+3,"eattree")+ST(i*4+3,"controlmagic"),'A32E',0,'A32V',"t")//A32E -> Digest
	set IsMultiIconAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"absorb"),'A32G',0,'A32W',"r")//A32G -> Drums of War
	set i=Enigma-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"townbellon"),'A0I7',0,'Y377',"f")//A0I7 -> Malefice
	call ConvertSkillData(i*4+2,ST(i*4+2,"autoentangleinstant"),'A180',0,'Y378',"c")//A180 -> Demonic Conversion
	call ConvertSkillData(i*4+3,ST(i*4+3,"load"),'A0B1',0,'Y379',"d")//A0B1 -> Midnight Pulse
	call ConvertSkillData(i*4+4,ST(i*4+4,"cannibalize"),'A1BX','A30L','Y380',"b")//A1BX -> Black Hole, A30L -> Black Hole
	set i=Batrider-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"repairon"),'A1EL',0,'Y381',"c")//A1EL -> Sticky Napalm
	call ConvertSkillData(i*4+2,ST(i*4+2,"autoharvestgold"),'A19V',0,'Y382',"r")//A19V -> Flamebreak
	call ConvertSkillData(i*4+3,ST(i*4+3,"metamorphosis")+ST(i*4+3,"range morph")+ST(i*4+3,"r3"),'QM04',0,'Y383',"e")//QM04 -> Firefly
	call ConvertSkillData(i*4+4,ST(i*4+4,"chainlightning"),'A19O','A1MV','Y384',"f")//A19O -> Flaming Lasso
	set i=indexid_AA-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"etherealform"),'A1MG',0,'Y385',"c")//A1MG -> Cold Feet
	call ConvertSkillData(i*4+2,ST(i*4+2,"replenish"),'A1HS',0,'Y386',"e")//A1HS -> Ice Vortex
	call ConvertSkillData(i*4+3,ST(i*4+3,"berserk"),'A1HQ',0,'Y387',"g")//A1HQ -> Chilling Touch
	call ConvertSkillData(i*4+4,ST(i*4+4,"taunt")+ST(i*4+4,"fanofknives")+ST(i*4+4,"r22"),'A1MI','A2QE','Y388',"t")//A1MI -> Ice Blast, A2QE -> Ice Blast
	set i=Slark-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"fanofknives"),'A1IM',0,'Y389',"c")//A1IM -> Dark Pact
	call ConvertSkillData(i*4+2,ST(i*4+2,"whirlwind"),'A1J7',0,'Y390',"e")//A1J7 -> Pounce
	call ConvertSkillData(i*4+3,ST(i*4+3,"abuz agi")+ST(i*4+3,"agi bug 1"),'A1HR','QP1F','Y391',null)//A1HR -> Essence Shift, QP1F -> Essence Shift
	set IsPassiveAbility[i*4+3]=true
	set BalanceStrings[i*4+3]="Essence Shift only works on 2/3 the attacks for ranged heroes."
	call ConvertSkillData(i*4+4,ST(i*4+4,"windwalk")+ST(i*4+4,"ibug"),'A1IN',0,'Y392',"d")//A1IN -> Shadow Dance
	set i=TB-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"replenishoff"),'A2KZ',0,'Y393',"c")//A2KZ -> Reflection
	call ConvertSkillData(i*4+2,ST(i*4+2,"board"),'A0H4',0,'Y394',"e")//A0H4 -> Conjure Image
	call ConvertSkillData(i*4+3,ST(i*4+3,"metamorphosis")+ST(i*4+3,"range morph")+ST(i*4+3,"chemicalrage"),'A1RI',0,'Y395',"t")//A1RI -> Metamorphosis
	call ConvertSkillData(i*4+4,ST(i*4+4,"cripple"),'A07Q',0,'Y396',"r")//A07Q -> Sunder
	set i=Leshrak-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"requestsacrifice"),'QB0F',0,'QY0F',"t")//QB0F -> Split Earth, Z397 -> Split Earth
	call ConvertSkillData(i*4+2,ST(i*4+2,"fanofknives"),'A20T',0,'Y398',"c")//A20T -> Diabolic Edict
	call ConvertSkillData(i*4+3,ST(i*4+3,"chainlightning"),'A06V',0,'Y399',"g")//A06V -> Lightning Storm
	call ConvertSkillData(i*4+4,ST(i*4+4,"berserk"),'A21F','A21G','Y400',"v")//A21F -> Pulse Nova, A21G -> Pulse Nova
	set i=indexid_SD-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"chainlightning"),'A1S8',0,'Y401',"d")//A1S8 -> Disruption
	call ConvertSkillData(i*4+2,ST(i*4+2,"replenishon"),'A1SB',0,'Y402',"c")//A1SB -> Soul Catcher
	call ConvertSkillData(i*4+3,ST(i*4+3,"fingerofdeath")+ST(i*4+3,"flare"),'A1S4',0,'Y403',"w")//A1S4 -> Shadow Poison
	set IsMultiIconAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"blizzard"),'A343','A34J','Y404',"g")//A343 -> Demonic Purge, A34J -> Demonic Purge
	set i=Lich-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"frostnova"),'A07F',0,'Y405',"v")//A07F -> Frost Nova
	call ConvertSkillData(i*4+2,ST(i*4+2,"frostarmor"),'A08R',0,'Y406',"f")//A08R -> Frost Armor
	call ConvertSkillData(i*4+3,ST(i*4+3,"innerfire"),'A053',0,'Y407',"d")//A053 -> Dark Ritual
	call ConvertSkillData(i*4+4,ST(i*4+4,"thunderbolt"),'A05T','A08H','Y408',"c")//A05T -> Chain Frost, A08H -> Chain Frost
	set i=Banshee-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"carrionswarm"),'A078',0,'Y409',"r")//QB06 -> Carrion Swarm, A078 -> Carrion Swarm
	call ConvertSkillData(i*4+2,ST(i*4+2,"silence"),'A07M',0,'Y410',"e")//A07M -> Silence
	call ConvertSkillData(i*4+3,null,'A02C',0,'Y411',null)
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"locustswarm"),'A04N',0,'Y412',"x")//A04N -> Exorcism
	set SkillIcon[i*4+4]="ReplaceableTextures\\CommandButtons\\BTNExorcism.blp"
	set i=Lion-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"freezingbreath"),'A0X5',0,'Y413',"e")//A0X5 -> Impale
	call ConvertSkillData(i*4+2,ST(i*4+2,"hex"),'A0MN',0,'Y414',"d")//A0MN -> Voodoo
	call ConvertSkillData(i*4+3,ST(i*4+3,"drain"),'A02N',0,'Y415',"r")//A02N -> Mana Drain
	set SkillIcon[i*4+3]="ReplaceableTextures\\CommandButtons\\BTNManaDrain.blp"
	call ConvertSkillData(i*4+4,ST(i*4+4,"chainlightning"),'A095','A09W','Y416',"f")//A095 -> Finger of Death, A09W -> Finger of Death
	set i=Veno-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"magicdefense"),'A173',0,'Y417',"e")//A173 -> Venomous Gale
	call ConvertSkillData(i*4+2,ST(i*4+2,"buff placer"),'A0MY','QP1D','Y418',null)//A0MY -> Poison Sting, QP1D -> Poison Sting
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,ST(i*4+3,"ward"),'A0MS',0,'Y419',"w")//A0MS -> Plague Ward
	call ConvertSkillData(i*4+4,ST(i*4+4,"summongrizzly"),'A013','A0A6','Y420',"v")//A013 -> Poison Nova, A0A6 -> Poison Nova Upg
	set i=Magnus-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"carrionswarm"),'A02S',0,'Y421',"w")//A02S -> Shockwave
	call ConvertSkillData(i*4+2,ST(i*4+2,"innerfire"),'A037',0,'Y422',"e")//A037 -> Empower
	call ConvertSkillData(i*4+3,ST(i*4+3,"blackarrowon"),'A1RD',0,'Y423',"d")//A1RD -> Skewer
	call ConvertSkillData(i*4+4,ST(i*4+4,"roar"),'A29L','A447','Y424',"v")//A29L -> Reverse Polarity, A447 -> Reverse Polarity
	set i=Visage-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"cripple"),'A08X',0,'Y425',"g")//A08X -> Grave Chill
	call ConvertSkillData(i*4+2,ST(i*4+2,"creepheal"),'A1NA',0,'Y426',"c")//A1NA -> Soul Assumption
	set IsMultiIconAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,null,'A0VX','QP23','Y427',null)//A0VX -> Gravekeeper's Cloak, QP23 -> Gravekeeper's Cloak
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"fanofknives"),'A1NE','A2IG','Y428',"t")//A1NE -> Familiars, A2IG -> Familiars
	set i=Nessaj-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"tankpilot"),'A055',0,'Y429',"c")//QB00 -> Chaos Bolt, A055 -> Chaos Bolt
	call ConvertSkillData(i*4+2,ST(i*4+2,"forceboard"),'A0RW',0,'Y430',"e")//A0RW -> Reality Rift
	call ConvertSkillData(i*4+3,null,'A03N','QP1E','Y431',null)//A03N -> Critical Strike, QP1E -> Critical Strike
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"mirrorimage"),'A03O',0,'Y432',"t")//A03O -> Phantasm
	set i=Wyvern-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"stomp")+ST(i*4+1,"range morph")+ST(i*4+1,"r44")+ST(i*4+1,"metamorphosis"),'A332',0,'Y437',"r")//A332 -> Arctic Burn
	call ConvertSkillData(i*4+2,ST(i*4+2,"unstoneform"),'A2LA',0,'Y438',"t")//A2LA -> Splinter Blast
	call ConvertSkillData(i*4+3,ST(i*4+3,"townbellon"),'A2LB',0,'Y439',"e")//A2LB -> Cold Embrace
	call ConvertSkillData(i*4+4,ST(i*4+4,"unwindwalk"),'A0Z0',0,'Y440',"w")//A0Z0 -> Winter's Curse
	set i=Zet-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"unravenform"),'A2M1',0,'Y433',"c")//A2M1 -> Flux
	call ConvertSkillData(i*4+2,ST(i*4+2,"unrobogoblin"),'A2LM',0,'Y434',"f")//A2LM -> Magnetic Field
	call ConvertSkillData(i*4+3,ST(i*4+3,"undeadbuild"),'A2LL',0,'Y435',"r")//A2LL -> Spark Wraith
	call ConvertSkillData(i*4+4,ST(i*4+4,"metamorphosis")+ST(i*4+4,"summongrizzly"),'A2M0',0,'Y436',"d")//A2M0 -> Tempest Double
	set IsAbilityDoesNotWork[i*4+4]=true
	set i=Earth-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"cripple"),'A2QM',0,'Y443',"d")//A2QM -> Boulder Smash
	set IsMultiIconAbility[i*4+1]=true
	call ConvertSkillData(i*4+2,ST(i*4+2,"unsubmerge"),'A2TJ',0,'Y444',"f")//A2TJ -> Rolling Boulder
	set IsMultiIconAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,ST(i*4+3,"unflamingarrows"),'A2QI',0,'Y445',"r")//A2QI -> Geomagnetic Grip
	set IsMultiIconAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"summonwareagle"),'A2TI',0,'Y446',"t")//A2TI -> Magnetize
	set IsMultiIconAbility[i*4+4]=true
	set i=Oracle-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"webon"),'A2QT',0,'Y453',"t")//A2QT -> Fortune's End
	call ConvertSkillData(i*4+2,ST(i*4+2,"chainlightning"),'A2T5',0,'Y454',"f")//A2T5 -> Fate's Edict
	call ConvertSkillData(i*4+3,ST(i*4+3,"avengerform"),'A2SG',0,'Y455',"e")//A2SG -> Purifying Flames
	call ConvertSkillData(i*4+4,ST(i*4+4,"lavamonster"),'A2TF',0,'Y456',"r")//QB11 -> False Promise, A2TF -> False Promise
	// utility
	set i=Crabe-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"acidbomb"),'A1PH',0,'Y458',"e")//A1PH -> Soul Steal
	call ConvertSkillData(i*4+2,null,'A33Q','A33R','Y459',null)//A33Q -> Last Word, A33R -> Last Word
	set IsPassiveAbility[i*4+2]=true
	call ConvertSkillData(i*4+3,ST(i*4+3,"magicdefense"),'A34A','QP28','A34B',null)//A34A -> Cheat Death, QP28 -> Cheat Death
	call ConvertSkillData(i*4+4,ST(i*4+4,"barkskinoff"),'A33U',0,'Y460',"g")//A33U -> Lightning Grapple
	if (Mode_SD or Mode_MD or Mode_AR)==false then
		set i=Sieger-1
		call ConvertSkillData(i*4+1,ST(i*4+1,"request_hero")+ST(i*4+1,"r23"),'Z601',0,'Y601',"t")//Z601 -> Sun Strike
		call ConvertSkillData(i*4+2,ST(i*4+2,"mechanicalcritter"),'Z602',0,'Y602',"d")//Z602 -> Chaos Meteor
		call ConvertSkillData(i*4+3,ST(i*4+3,"militia"),'Z603',0,'Y603',"f")//Z603 -> Forge Spirit
		call ConvertSkillData(i*4+4,null,0,0,0,null)
		set IsAbilityDoesNotWork[i*4+4]=true
	// water invoker
		set i=Sorcesser-1
		call ConvertSkillData(i*4+1,ST(i*4+1,"militiaconvert"),'Z604',0,'Y604',"y")//Z604 -> Cold Snap
		call ConvertSkillData(i*4+2,ST(i*4+2,"windwalk"),'Z605',0,'Y605',"v")//Z605 -> Ghost Walk
		call ConvertSkillData(i*4+3,ST(i*4+3,"militiaoff"),'Z606',0,'Y606',"g")//Z606 -> Ice Wall
		call ConvertSkillData(i*4+4,null,0,0,0,null)
		set IsAbilityDoesNotWork[i*4+4]=true
	//wex invoker
		set i=Invoker-1
		call ConvertSkillData(i*4+1,ST(i*4+1,"militiaunconvert"),'Z607',0,'Y607',"z")//Z607 -> Alacrity
		call ConvertSkillData(i*4+2,ST(i*4+2,"mindrot"),'Z608',0,'Y608',"x")//Z608 -> Tornado
		call ConvertSkillData(i*4+3,ST(i*4+3,"monsoon"),'Z609',0,'Y609',"c")//Z609 -> EMP
		call ConvertSkillData(i*4+4,ST(i*4+4,"mount"),'Z610','A3K5','Y610',"b")//Z610 -> Deafening Blast
		call BSFC(i*4+4)
	endif
	//FIXLESS
	set i=Formless-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"unload"),'A40K','A40S','Y500',"j")//A40K -> Unus, A40S -> Unus
	call ConvertSkillData(i*4+2,ST(i*4+2,"unloadall"),'A40L','A40T','Y501',"k")//A40L -> Duos, A40T -> Duos
	call ConvertSkillData(i*4+3,ST(i*4+3,"unloadallcorpses"),'A40M','A40U','Y502',"l")//A40M -> Tertius, A40U -> Tertius
	call ConvertSkillData(i*4+4,ST(i*4+4,"undeadbuild"),'A40N','A40V','Y503',"i")//A40N -> Denique, A40V -> Denique
	set i=SpaceOrc-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"lavamonster"),'A0QV',0,'Y614',"d")//A0QV -> Raise Dead
	call ConvertSkillData(i*4+2,ST(i*4+2,"carrionscarabs")+ST(i*4+2,"carrionscarabsoff")+ST(i*4+2,"carrionscarabson"),'A43Y',0,'Y615',"w")//A43Y -> Watcher
	call ConvertSkillData(i*4+3,ST(i*4+3,"carrionscarabs")+ST(i*4+3,"carrionscarabsoff")+ST(i*4+3,"carrionscarabson"),'A00T',0,'Y616',"w")//A00T -> Urna Swarm
	call ConvertSkillData(i*4+4,ST(i*4+4,"renew"),'A46J',0,'Y61K',"c")//A46J -> Mind Control
	//set IsAbilityDoesNotWork[i*4+4]=true
	set i=OgreLord-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"soulburn"),'A0EC',0,'Y329',"d")//A0EC -> Bloodrage
	call ConvertSkillData(i*4+2,ST(i*4+2,"lumber2gold"),'A44U',0,'Y618',"e")//A44U -> Ante Up
	set IsAbilityDoesNotWork[i*4+2]=true
	call ConvertSkillData(i*4+3,null,'A0LE','QP1Y','Y330',null)//A0LE -> Blood Bath, QP1Y -> Blood Bath
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,null,'A440','QP25','Y617',null)//A440 -> Adaptiveness, QP25 -> Adaptiveness
	set IsPassiveAbility[i*4+4]=true
	
	set i=FireLord-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"volcano"),'A451',0,'Y61C',"w")//A451 -> Firewall
	call ConvertSkillData(i*4+2,ST(i*4+2,"stomp"),'A454',0,'Y61D',"t")//A454 -> Fire Stomp
	call ConvertSkillData(i*4+3,null,'A45B','QP26','Y61E',null)//A45B -> Fire show, QP26 -> Fire show
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"fanofknives"),'A456',0,'Y61F',"f")//A456 -> Inferno
	set i=Queen-1
	call ConvertSkillData(i*4+1,ST(i*4+1,"curse"),'A45W',0,'Y61G',"r")//A45W -> Vital Strike
	call ConvertSkillData(i*4+2,ST(i*4+2,"volcano"),'A45X',0,'Y61H',"w")//A45X -> Arrow Shower
	call ConvertSkillData(i*4+3,null,'A460','QP27','Y61I',null)//A460 -> Mortal Wounds, QP27 -> Mortal Wounds hidden
	set IsPassiveAbility[i*4+3]=true
	call ConvertSkillData(i*4+4,ST(i*4+4,"creepthunderclap"),'A461',0,'Y61J',"d")//A461 -> Swoop Down
	set NumberOfHeroes=Queen
	if Mode_SD or Mode_MD or Mode_AR then
		call ExecuteFunc("RollSpellsForInvokerSD")
	endif
	//call PreloadGenEnd("exec"+R2S(GetRandomReal(0,5000000))+".txt")
endfunction

function CID takes integer d_id, integer r_id, integer s_id, integer m_id returns integer
	set ITC=ITC+1
	set Item_Dummy[ITC]=d_id
	set Item_Real[ITC]=r_id
	set Item_SellerUnit[ITC]=s_id
	call SaveBoolean(UnitStats,Item_SellerUnit[ITC],0,true)
	set Item_Mute[ITC]=m_id
	if r_id>0 then
		set Item_Icon[ITC]=GetAbilitySoundById(r_id,SOUND_TYPE_EFFECT_LOOPED)
		if StringLength(Item_Icon[ITC])<20 then
			//call echo(Id2String(r_id)+" - len")
		endif
	endif
	//set Item_Icon[ITC]=IconPath
	return ITC
endfunction

function InitItems takes nothing returns nothing
	local string s=""
	call CID('I0FF','I0FG',0,0)//I0FF -> Temporary Item, I0FG -> Temporary Item
	set BootsOfSpeed=CID('I02Q','I02O','h011','I00A')//I02Q -> Boots of Speed, I02O -> Boots of Speed, h011 -> Boots of Speed, I00A -> Boots of Speed
	set GlovesOfHaste=CID('I02S','I02P','h012','I0CA')//I02S -> Gloves of Haste, I02P -> Gloves of Haste, h012 -> Gloves of Haste, I0CA -> Gloves of Haste
	set BootsOfElvenskin=CID('I02N','I02R','h013','I0CS')//I02N -> Boots of Elvenskin, I02R -> Boots of Elvenskin, h013 -> Boots of Elvenskin, I0CS -> Boots of Elvenskin
	set CircletOfNobility=CID('I02X','I02Y','h015','I0D4')//I02X -> Circlet of Nobility, I02Y -> Circlet of Nobility, h015 -> Circlet of Nobility, I0D4 -> Circlet of Nobility
	set BeltOfStrength=CID('I02Z','I043','h016','I0CV')//I02Z -> Belt of Giant Strength, I043 -> Belt of Giant Strength, h016 -> Belt of Giant Strength, I0CV -> Belt of Giant Strength
	set BladesOfAlacrity=CID('I030','I044','h017','I0D2')//I030 -> Blade of Alacrity, I044 -> Blade of Alacrity, h017 -> Blade of Alacrity, I0D2 -> Blade of Alacrity
	set BladesOfAttack=CID('I031','I045','h018','I0D5')//I031 -> Blades of Attack, I045 -> Blades of Attack, h018 -> Blades of Attack, I0D5 -> Blades of Attack
	set Broadsword=CID('I032','I046','h019','I0CZ')//I032 -> Broadsword, I046 -> Broadsword, h019 -> Broadsword, I0CZ -> Broadsword
	set Chainmail=CID('I033','I047','h01A','I0D7')//I033 -> Chainmail, I047 -> Chainmail, h01A -> Chainmail, I0D7 -> Chain Mail
	set Claymore=CID('I034','I048','h01B','I0CX')//I034 -> Claymore, I048 -> Claymore, h01B -> Claymore, I0CX -> Claymore
	set DemonEdge=CID('I035','I049','h01C','I0CI')//I035 -> Demon Edge, I049 -> Demon Edge, h01C -> Demon Edge, I0CI -> Demon Edge
	set Eaglehorn=CID('I036','I04A','h01D','I0CH')//I036 -> Eaglehorn, I04A -> Eaglehorn, h01D -> Eaglehorn, I0CH -> Eaglehorn
	set EnergyBooster=CID('I037','I04B','h01E','I0CR')//I037 -> Energy Booster, I04B -> Energy Booster, h01E -> Energy Booster, I0CR -> Energy Booster
	set GauntletOfStrength=CID('I038','I04C','h01F','I0CJ')//I038 -> Gauntlets of Strength, I04C -> Gauntlets of Strength, h01F -> Gauntlets of Strength, I0CJ -> Gauntlets of Strength
	set Gem=CID('I039','I04D','h01G','I0DG')//I039 -> Gem of True Sight, I04D -> Gem of True Sight, h01G -> Gem of True Sight, I0DG -> Gem of True Sight
	set GemCourier=CID('I0MS','I0MR',0,'I0MT')//I0MS -> Gem of True Sight (Courier Edition), I0MR -> Gem of True Sight (Courier Edition), I0MT -> Gem of True Sight (Courier Edition)
	set HelmOfIronWill=CID('I03B','I04E','h01H','I0DA')//I03B -> Helm of Iron Will, I04E -> Helm of Iron Will, h01H -> Helm of Iron Will, I0DA -> Helm of Iron Will
	set Hyperstone=CID('I03C','I04F','h01I','I0CQ')//I03C -> Hyperstone, I04F -> Hyperstone, h01I -> Hyperstone, I0CQ -> Hyperstone
	set IronwoodBranch=CID('I03D','I04G','h01J','I0CU')//I03D -> Ironwood Branch, I04G -> Ironwood Branch, h01J -> Ironwood Branch, I0CU -> Ironwood Branch
	set KelensDagger=CID('I03E','I04H','h01K','I0C7')//I03E -> Kelen's Dagger, I04H -> Kelen's Dagger, h01K -> Kelen's Dagger, I0C7 -> Kelen's Dagger
	set DisabledKelensDagger=CID('I03E','I04I','h01K','I0DH')//I03E -> Kelen's Dagger, I04I -> Disabled Kelen's Dagger, h01K -> Kelen's Dagger, I0DH -> Disabled Kelen's Dagger
	set MantleOfIntelligence=CID('I03F','I04J','h01L','I0CM')//I03F -> Mantle of Intelligence, I04J -> Mantle of Intelligence, h01L -> Mantle of Intelligence, I0CM -> Mantle of Intelligence
	set MaskOfDeath=CID('I03G','I04K','h01M','I0CD')//I03G -> Mask of Death, I04K -> Mask of Death, h01M -> Mask of Death, I0CD -> Mask of Death
	set MesserschmidtReaver=CID('I03H','I04L','h01N','I0CG')//I03H -> Messerschmidt's Reaver, I04L -> Messerschmidt's Reaver, h01N -> Messerschmidt's Reaver, I0CG -> Messerschmidt's Reaver
	set MithrilHammer=CID('I03I','I04M','h01O','I0D0')//I03I -> Mithril Hammer, I04M -> Mithril Hammer, h01O -> Mithril Hammer, I0D0 -> Mithril Hammer
	set MysticStaff=CID('I03J','I04N','h01P','I0CN')//I03J -> Mystic Staff, I04N -> Mystic Staff, h01P -> Mystic Staff, I0CN -> Mystic Staff
	set OgreAxe=CID('I03K','I04O','h01Q','I0D8')//I03K -> Ogre Axe, I04O -> Ogre Axe, h01Q -> Ogre Axe, I0D8 -> Ogre Axe
	set PlaneswalkerCloak=CID('I03L','I04P','h01R','I0CE')//I03L -> Planeswalker's Cloak, I04P -> Planeswalker's Cloak, h01R -> Planeswalker's Cloak, I0CE -> Planeswalker's Cloak
	set PlateMail=CID('I03M','I04Q','h01S','I0DB')//I03M -> Plate Mail, I04Q -> Plate Mail, h01S -> Plate Mail, I0DB -> Plate Mail
	set PointBooster=CID('I03N','I04R','h01T','I0CL')//I03N -> Point Booster, I04R -> Point Booster, h01T -> Point Booster, I0CL -> Point Booster
	set Quarterstaff=CID('I03P','I04S','h01U','I0CY')//I03P -> Quarterstaff, I04S -> Quarterstaff, h01U -> Quarterstaff, I0CY -> Quarterstaff
	set RingOfHealth=CID('I03Q','I04T','h01V','I0DI')//I03Q -> Ring of Health, I04T -> Ring of Health, h01V -> Ring of Health, I0DI -> Ring of Health
	set RingOfProtection=CID('I03R','I04U','h01W','I0CW')//I03R -> Ring of Protection, I04U -> Ring of Protection, h01W -> Ring of Protection, I0CW -> Ring of Protection
	set RingOfRegeneration=CID('I03S','I04V','h01X','I0DJ')//I03S -> Ring of Regeneration, I04V -> Ring of Regeneration, h01X -> Ring of Regeneration, I0DJ -> Ring of Regeneration
	set RobeOfMagi=CID('I03T','I04W','h01Y','I0CP')//I03T -> Robe of the Magi, I04W -> Robe of the Magi, h01Y -> Robe of the Magi, I0CP -> Robe of the Magi
	set SacredRelic=CID('I03U','I04X','h01Z','I0CC')//I03U -> Sacred Relic, I04X -> Sacred Relic, h01Z -> Sacred Relic, I0CC -> Sacred Relic
	set SlippersOfAgility=CID('I03V','I04Y','h020','I0C5')//I03V -> Slippers of Agility, I04Y -> Slippers of Agility, h020 -> Slippers of Agility, I0C5 -> Slippers of Agility
	set SobiMask=CID('I03W','I04Z','h021','I0DK')//I03W -> Sobi Mask, I04Z -> Sobi Mask, h021 -> Sobi Mask, I0DK -> Sobi Mask
	set StaffOfWizardry=CID('I03X','I050','h022','I0D1')//I03X -> Staff of Wizardry, I050 -> Staff of Wizardry, h022 -> Staff of Wizardry, I0D1 -> Staff of Wizardry
	set StoutShield=CID('I03A','I051','h023','I0D9')//I03A -> Stout Shield (melee), I051 -> Stout Shield (melee), h023 -> Stout Shield, I0D9 -> Stout Shield (melee)
	set StoutShieldRanged=CID('I0KB','I0KA',0,'I0KC')//I0KB -> Stout Shield (ranged), I0KA -> Stout Shield (ranged), I0KC -> Stout Shield (ranged)
	set UltimateOrb=CID('I03Y','I052','h024','I0C9')//I03Y -> Ultimate Orb, I052 -> Ultimate Orb, h024 -> Ultimate Orb, I0C9 -> Ultimate Orb
	set VitalityBooster=CID('I03Z','I053','h025','I0CK')//I03Z -> Vitality Booster, I053 -> Vitality Booster, h025 -> Vitality Booster, I0CK -> Vitality Booster
	set VoidStone=CID('I040','I054','h026','I0DL')//I040 -> Void Stone, I054 -> Void Stone, h026 -> Void Stone, I0DL -> Void Stone
	set javelin=CID('I041','I055','h027','I0D6')//I041 -> Javelin, I055 -> Javelin, h027 -> Javelin, I0D6 -> Javelin
	set Bottle0Shop=CID('I00L','I0AV','h02B',0)//I00L -> Empty Bottle, I0AV -> Empty Bottle Store, h02B -> Empty Bottle
	set Bottle0=CID('I05E','I0AM',0,'I0DN')//I05E -> Empty Bottle, I0AM -> Empty Bottle, I0DN -> Empty Bottle
	set Bottle1=CID('I0AU','I0AN',0,'I0DO')//I0AU -> Magical Bottle - 1/3, I0AN -> Magical Bottle - 1/3, I0DO -> Magical Bottle - 1/3
	set Bottle2=CID('I0AS','I0AO',0,'I0DP')//I0AS -> Magical Bottle - 2/3, I0AO -> Magical Bottle - 2/3, I0DP -> Magical Bottle - 2/3
	set Bottle3=CID('I0AT','I0AP',0,'I0DQ')//I0AT -> Magical Bottle - 3/3, I0AP -> Magical Bottle - 3/3, I0DQ -> Magical Bottle - 3/3
	set BottleIllusion=CID('I0GW','I0GY',0,'I0H3')//I0GW -> Magical Bottle - Illusion, I0GY -> Magical Bottle - Illusion, I0H3 -> Magical Bottle - Illusion
	set BottleRegen=CID('I0H2','I0GX',0,'I0DR')//I0H2 -> Magical Bottle - Regeneration, I0GX -> Magical Bottle - Regeneration, I0DR -> Magical Bottle - Regeneration
	set BottleHaste=CID('I0GV','I0H1',0,'I0H4')//I0GV -> Magical Bottle - Haste, I0H1 -> Magical Bottle - Haste, I0H4 -> Magical Bottle - Haste
	set BottleBounty=CID('I0Q8','I0Q7',0,'I0Q9')//I0Q8 -> Magical Bottle - Haste, I0Q7 -> Magical Bottle - Bounty, I0Q9 -> Magical Bottle - Bounty
	set BottleDD=CID('I0AR','I0H0',0,'I0H6')//I0AR -> Magical Bottle - Double Damage, I0H0 -> Magical Bottle - Double Damage, I0H6 -> Magical Bottle - Double Damage
	set BottleInvis=CID('I0AQ','I0GZ',0,'I0H5')//I0AQ -> Magical Bottle - Invisibility, I0GZ -> Magical Bottle - Invisibility, I0H5 -> Magical Bottle - Invisibility
	set MagicStick=CID('I0GD','I0GC','h074','I0GE')//I0GD -> Magic Stick, I0GC -> Magic Stick, h074 -> Magic Stick, I0GE -> Magic Stick
	set MagicWand=CID('I0HC','I0HB',0,'I0HA')//I0HC -> Magic Wand, I0HB -> Magic Wand, I0HA -> Magic Wand
	call SaveInteger(HY,'ITDB',CID(0,0,'h07S',0),MagicWand)//h07S -> Magic Wand
	set QuellingBlade=CID('I0HT','I0HR','h07W','I0HV')//I0HT -> Quelling Blade, I0HR -> Quelling Blade, h07W -> Quelling Blade, I0HV -> Quelling Blade
	set QuellingBladeRanged=CID('I0HU','I0HP',0,'I0HW')//I0HU -> Quelling Blade (Ranged), I0HP -> Quelling Blade (Ranged), I0HW -> Quelling Blade Ranged
	set TalismanOfEvasion=CID('I0J7','I0J6','h083','I0J8')//I0J7 -> Talisman of Evasion, I0J6 -> Talisman of Evasion, h083 -> Talisman of Evasion, I0J8 -> Talisman of Evasion
	set GhostScepter=CID('I0JJ','I0JI','h087','I0JK')//I0JJ -> Ghost Scepter, I0JI -> Ghost Scepter, h087 -> Ghost Scepter, I0JK -> Ghost Scepter
	set OrbOfVenom=CID('I0MA','I0M9','h0CM','I0MB')//I0MA -> Orb of Venom, I0M9 -> Orb of Venom, h0CM -> Orb of Venom, I0MB -> Orb of Venom
	set OrbOfVenomRanged=CID('I0MD','I0ME',0,'I0MC')//I0MD -> Orb of Venom (ranged), I0ME -> Orb of Venom (ranged), I0MC -> Orb of Venom (ranged)
	set Tango=CID('I057','I05C','h02A','ITGB')//I057 -> Ancient Tango of Essifation, I05C -> Ancient Tango of Essifation, h02A -> Ancient Tango of Essifation, ITGB -> Ancient Tango of Essifation
	set CrimsonGuard=CID('I0QI','I0QH',0,'I0QJ')//I0QI -> Crimson Guard, I0QH -> Crimson Guard, I0QJ -> Crimson Guard
	set RecipeCrimsonGuard=CID('I0QL','I0QK','ho02','I0QM')//I0QL -> Crimson Guard recipe, I0QK -> Crimson Guard recipe, ho02 -> Crimson Guard, I0QM -> Crimson Guard recipe
	set TangoBorrowed=CID('INTD','INTG',0,0)//INTD -> Ancient Tango of Essifation, INTG -> Borrowed Ancient Tango of Essifation
	set ClarityPotion=CID('I042','I05D','h028','INCP')//I042 -> Clarity Potion, I05D -> Clarity Potion, h028 -> Clarity Potion, INCP -> Borrowed Clarity Potion
	set ghostpotion=CID('I0HO','I0HN','h07V',0)//I0HO -> Ghost Potion, I0HN -> Ghost Potion, h07V -> Ghost Potion
	set HealingSalve=CID('I056','I05F','h029','INHS')//I056 -> Healing Salve, I05F -> Healing Salve, h029 -> Healing Salve, INHS -> Borrowed Healing Salve
	set ObserverWards=CID('I058','I05G','h02C',0)//I058 -> Observer Wards, I05G -> Observer Wards, h02C -> Observer Wards
	set SentryWards=CID('I059','I05H','h02D',0)//I059 -> Sentry Wards, I05H -> Sentry Wards, h02D -> Sentry Wards
	set ScrollOfTownPortal=CID('I05A','I05I','h02E',0)//I05A -> Scroll of Town Portal, I05I -> Scroll of Town Portal, h02E -> Scroll of Town Portal
	set AnimalCourier=CID('I05B','I05J','h02F',0)//I05B -> Animal Courier, I05J -> Animal Courier, h02F -> Animal Courier
	set Cheese=CID('I0B0','I0B1',0,0)//I0B0 -> Cheese, I0B1 -> Cheese
	set FakeCheese=CID('I0TC','I0TD',0,0)//I0B0 -> Cheese, I0B1 -> Cheese
	set dustofappearance=CID('I0GI','I0GH','h076',0)//I0GI -> Dust of Appearance, I0GH -> Dust of Appearance, h076 -> Dust of Appearance
	set wandofillusions=CID('I0KT','I0KS','h0B9',0)//I0KT -> Wand of Illusion, I0KS -> Wand of Illusion, h0B9 -> Wand of Illusion
	set Smoke=CID('I0NF','I0NG','h0D3',0)//I0NF -> Smoke of Deceit, I0NG -> Smoke of Deceit, h0D3 -> Smoke of Deceit
	set Perseverance=CID('I061','I062',0,'I01J')//I061 -> Perseverance, I062 -> Perseverance, I01J -> Perseverance
	set HeaddressOfRejuvenation=CID('I064','I063',0,'I01K')//I064 -> Headdress of Rejuvenation, I063 -> Headdress of Rejuvenation, I01K -> Headdress of Rejuvenation
	set NathrezimBuckler=CID('I065','I066',0,'I01L')//I065 -> Nathrezim Buckler, I066 -> Nathrezim Buckler, I01L -> Nathrezim Buckler
	set RingOfBasilius=CID('I068','I067',0,'I01M')//I068 -> Ring of Basilius, I067 -> Ring of Basilius (|cff00ff00Normal|r), I01M -> Ring of Basilius
	set RingOfBasiliusHero=CID('I069','I06A',0,'I0C6')//I069 -> Ring of Basilius (Heroes), I06A -> Ring of Basilius (|cffff0000Heroes|r), I0C6 -> Ring of Basilius (Heroes)
	set bootsOfTravel=CID('I06C','I06B',0,'I01P')//I06C -> Boots of Travel, I06B -> Boots of Travel, I01P -> Boots of Travel
	set PowerTreadsAgility=CID('I03O','I02T',0,'I01R')//I03O -> Power Treads (Agility), I02T -> Power Treads (Agility), I01R -> Power Treads (Agility)
	set PowerTreadsStrength=CID('I02U','I05Y',0,'I01Q')//I02U -> Power Treads (Strength), I05Y -> Power Treads (Strength), I01Q -> Power Treads (Strength)
	set PowerTreadsIntelligence=CID('I060','I05Z',0,'I01S')//I060 -> Power Treads (Intelligence), I05Z -> Power Treads (Intelligence), I01S -> Power Treads (Intelligence)
	set HandOfMidas=CID('I06E','I06D',0,'I01T')//I06E -> Hand of Midas, I06D -> Hand of Midas, I01T -> Hand of Midas
	set HandOfMidasCourier=CID('I0NO','I0NN',0,'I0NP')//I0NO -> Hand of Midas (Courier Edition), I0NN -> Hand of Midas (Courier Edition), I0NP -> Hand of Midas (Courier Edition)
	set OblivionStaff=CID('I06G','I06F',0,'I01U')//I06G -> Oblivion Staff, I06F -> Oblivion Staff, I01U -> Oblivion Staff
	set Bracer=CID('I06I','I06H',0,'I01V')//I06I -> Bracer, I06H -> Bracer, I01V -> Bracer
	set WraithBand=CID('I06K','I06J',0,'I01W')//I06K -> Wraith Band, I06J -> Wraith Band, I01W -> Wraith Band
	set NullTalisman=CID('I06M','I06L',0,'I01X')//I06M -> Null Talisman, I06L -> Null Talisman, I01X -> Null Talisman
	set Yasha=CID('I08F','I08G',0,'I01Y')//I08F -> Yasha, I08G -> Yasha, I01Y -> Yasha
	set Sange=CID('I08I','I08H',0,'I01Z')//I08I -> Sange, I08H -> Sange, I01Z -> Sange
	set CraniumBasher=CID('I08J','I08K',0,'I020')//I08J -> Cranium Basher, I08K -> Cranium Basher, I020 -> Cranium Basher
	set BladeMail=CID('I08N','I08O',0,'I021')//I08N -> Blade Mail, I08O -> Blade Mail, I021 -> Blade Mail
	set Maelstrom=CID('I08Q','I08P',0,'I022')//I08Q -> Maelstrom, I08P -> Maelstrom, I022 -> Maelstrom
	set DiffusalBlade=CID('I08S','I08R',0,'I023')//I08S -> Diffusal Blade Level 1, I08R -> Diffusal Blade Level 1, I023 -> Diffusal Blade Level 1
	set DiffusalBlade_upg=CID('I0JB','I0J9',0,'I0JD')//I0JB -> Diffusal Blade Level 2, I0J9 -> Diffusal Blade Level 2, I0JD -> Diffusal Blade Level 2
	set DiffusalBlade_empty=CID('I0EW','I0EV',0,'I0EX')//I0EW -> Diffusal Blade Level 1 (Empty), I0EV -> Diffusal Blade Level 1 (Empty), I0EX -> Diffusal Blade (Empty)
	set DiffusalBlade_upg_empty=CID('I0JC','I0JA',0,'I0JE')//I0JC -> Diffusal Blade Level 2 (Empty), I0JA -> Diffusal Blade Level 2 (Empty), I0JE -> Diffusal Blade Level 2(Empty)
	set HelmOfTheDominator=CID('I08U','I08T',0,'I024')//I08U -> Helm of the Dominator, I08T -> Helm of the Dominator, I024 -> Helm of the Dominator
	set HelmOfTheDominatorCourier=CID('I08W','I08V',0,'I0CO')//I08W -> Helm of the Dominator (Courier Edition), I08V -> Helm of the Dominator (Courier Edition), I0CO -> Helm of the Dominator (Courier)
	set MaskOfMadness=CID('I08X','I08Y',0,'I025')//I08X -> Mask of Madness, I08Y -> Mask of Madness, I025 -> Mask of Madness
	set Eul=CID('I090','I08Z',0,'I026')//I090 -> Eul's Scepter of Divinity, I08Z -> Eul's Scepter of Divinity, I026 -> Eul's Scepter of Divinity
	set SoulBooster=CID('I092','I091',0,'I027')//I092 -> Soul Booster, I091 -> Soul Booster, I027 -> Soul Booster
	set Mekansm=CID('I094','I093',0,'I028')//I094 -> Mekansm, I093 -> Mekansm, I028 -> Mekansm
	set SangeAndYasha=CID('I096','I095',0,'I029')//I096 -> Sange and Yasha, I095 -> Sange and Yasha, I029 -> Sange and Yasha
	set Desolator=CID('I098','I097',0,'I02A')//I098 -> Stygian Desolator, I097 -> Stygian Desolator, I02A -> Stygian Desolator
	set BattleFury=CID('I09A','I099',0,'I02B')//I09A -> Battle Fury, I099 -> Battle Fury, I02B -> Battle Fury
	set Crystalys=CID('I09B','I09C',0,'I02C')//I09B -> Crystalys, I09C -> Crystalys, I02C -> Crystalys
	set BKB10=CID('I0G2','I0FZ',0,'I0G8')//I0G2 -> Black King Bar 10, I0FZ -> Black King Bar 10, I0G8 -> Black King Bar 10
	set BKB09=CID('I0G6','I0G0',0,'I0G9')//I0G6 -> Black King Bar 9, I0G0 -> Black King Bar 9, I0G9 -> Black King Bar 9
	set BKB08=CID('I09E','I0FY',0,'I0G7')//I09E -> Black King Bar 8, I0FY -> Black King Bar 8, I0G7 -> Black King Bar 8
	set BKB07=CID('I0G5','I0FS',0,'I02D')//I0G5 -> Black King Bar 7, I0FS -> Black King Bar 7, I02D -> Black King Bar 7
	set BKB06=CID('I0G3','I09D',0,'I0GB')//I0G3 -> Black King Bar 6, I09D -> Black King Bar 6, I0GB -> Black King Bar 6
	set BKB05=CID('I0G4','I0G1',0,'I0GA')//I0G4 -> Black King Bar 5, I0G1 -> Black King Bar 5, I0GA -> Black King Bar 5
	set Aegis=CID('I0AX','I0AW',0,0)//I0AX -> Aegis of the Immortal, I0AW -> Aegis of the Immortal
	set FakeAegis=CID('I0TE','I0TF',0,0)
	set MantaStyle=CID('I09G','I09F',0,'I02E')//I09G -> Manta Style, I09F -> Manta Style, I02E -> Manta Style
	set MantaStyleRanged=CID('I0MV','I0MU',0,'I0MW')//I0MV -> Manta Style (ranged), I0MU -> Manta Style (ranged), I0MW -> Manta Style (ranged)
	set LotharsEdge=CID('I09I','I09H',0,'I02F')//I09I -> Lothar's Edge, I09H -> Lothar's Edge, I02F -> Lothar's Edge
	set Dagon1=CID('I09K','I09M',0,'I01G')//I09K -> Dagon Level 1, I09M -> Dagon Level 1, I01G -> Dagon Level 1
	set Dagon2=CID('I09J','I09P',0,'I02G')//I09J -> Dagon Level 2, I09P -> Dagon Level 2, I02G -> Dagon Level 2
	set Dagon3=CID('I09Q','I09N',0,'I0DC')//I09Q -> Dagon Level 3, I09N -> Dagon Level 3, I0DC -> Dagon Level 3
	set Dagon4=CID('I09S','I09O',0,'I0DD')//I09S -> Dagon Level 4, I09O -> Dagon Level 4, I0DD -> Dagon Level 4
	set Dagon5=CID('I09R','I09L',0,'I0D3')//I09R -> Dagon Level 5, I09L -> Dagon Level 5, I0D3 -> Dagon Level 5
	set Necronomicon1=CID('I09U','I09T',0,'I02H')//I09U -> Necronomicon Level 1, I09T -> Necronomicon Level 1, I02H -> Necronomicon Level 1
	set Necronomicon2=CID('I09V','I09X',0,'I02I')//I09V -> Necronomicon Level 2, I09X -> Necronomicon Level 2, I02I -> Necronomicon Level 2
	set Necronomicon3=CID('I09W','I09Y',0,'I02J')//I09W -> Necronomicon Level 3, I09Y -> Necronomicon Level 3, I02J -> Necronomicon Level 3
	set LinkensSphere=CID('I0A0','I09Z',0,'I0BO')//I0A0 -> Linken's Sphere, I09Z -> Linken's Sphere, I0BO -> Linkin's Sphere
	set LinkenDummy=CID('I0HK','I0HJ',0,'I0HL')//I0HK -> Linken's Sphere, I0HJ -> Linken's Sphere, I0HL -> Linkin's Sphere
	set DivineRapier=CID('I0A2','I0A1',0,'I0BP')//I0A2 -> |c00000000Divine Rapier|r, I0A1 -> |c00000000Divine Rapier|r, I0BP -> Divine Rapier
	set DivineRapierFree=CID('I0LI','I0LJ',0,'I0LK')//I0LI -> |c00000000Divine Rapier|r, I0LJ -> |c00000000Divine Rapier|r, I0LK -> Divine Rapier
	set Buriza=CID('I0A4','I0A3',0,'I0BQ')//I0A4 -> Buriza-do Kyanon, I0A3 -> Buriza-do Kyanon, I0BQ -> Buriza-do Kyanon
	set MKBOn=CID('I0A6','I0A5',0,'I0BR')//I0A6 -> Monkey King Bar, I0A5 -> Monkey King Bar (True Strike |cff00ff00Active|r), I0BR -> Monkey King Bar
	set MKBOff=CID('I0K8','I0K7',0,'I0K9')//I0K8 -> Monkey King Bar, I0K7 -> Monkey King Bar (True Strike |cffff0000Inactive|r), I0K9 -> Monkey King Bar
	set RadianceOn=CID('I0A7','I0A8',0,'I0BS')//I0A7 -> Radiance, I0A8 -> Radiance (|cff00ff00On|r), I0BS -> Radiance
	set RadianceOff=CID('I0KQ','I0KP',0,'I0KR')//I0KQ -> Radiance, I0KP -> Radiance (|cffff0000Off|r), I0KR -> Radiance
	set HeartOfTarrasque=CID('I0AA','I0A9',0,'I0BT')//I0AA -> Heart of Tarrasque, I0A9 -> Heart of Tarrasque, I0BT -> Heart of Tarrasque
	set DisabledHeartOfTarrasque=CID('I0AA','I0KL',0,'I0KM')//I0AA -> Heart of Tarrasque, I0KL -> Disabled Heart of Tarrasque, I0KM -> Disabled Heart of Tarrasque
	set Satanic=CID('I0AC','I0AB',0,'I0BU')//I0AC -> Satanic, I0AB -> Satanic, I0BU -> Satanic
	set EyeOfSkadi=CID('I0AD','I0AE',0,'I0BV')//I0AD -> Eye of Skadi, I0AE -> Eye of Skadi, I0BV -> Eye of Skadi
	set EyeOfSkadiRanged=CID('I0AG','I0AF',0,'I0CT')//I0AG -> Eye of Skadi (Ranged), I0AF -> Eye of Skadi (Ranged), I0CT -> Eye of Skadi (Ranged)
	set Butterfly=CID('I0AH','I0AI',0,'I0BW')//I0AH -> The Butterfly, I0AI -> The Butterfly, I0BW -> The Butterfly
	set AghanimBasic=CID('I0B8','I0AY',0,'I00B')//I0B8 -> Aghanim's Scepter (Basic), I0AY -> Aghanim's Scepter (Basic)
	set AghanimUpgrader=CID('I0QT','I0QS',0,'I0QU')//I0QT -> Aghanim's Scepter (Upgrader), I0QS -> Aghanim's Scepter Upgrader, I0QU -> Aghanim's Scepter
	set AghanimUpgraderGiftable=CID('I0QT','I0TB',0,'I0TI')//I0QT -> Aghanim's Scepter (Upgrader), I0QS -> Aghanim's Scepter Upgrader, I0QU -> Aghanim's Scepter
	set RefresherOrb=CID('I0AK','I0AJ',0,'I0BX')//I0AK -> Refresher Orb, I0AJ -> Refresher Orb, I0BX -> Refresher Orb
	set GuinsooHex=CID('I07K','I0AL',0,'I0BY')//I07K -> Guinsoo's Scythe of Vyse, I0AL -> Guinsoo's Scythe of Vyse, I0BY -> Guinsoo's Scythe of Vyse
	set Vanguard=CID('I0BB','I0BA',0,'I0BZ')//I0BB -> Vanguard, I0BA -> Vanguard (melee), I0BZ -> Vanguard
	set VanguardRanged=CID('I0LE','I0LC',0,'I0LD')//I0LE -> Vanguard, I0LC -> Vanguard (ranged), I0LD -> Vanguard
	set ArcaneRing=CID('I0BC','I0BD',0,'I00C')//I0BC -> Arcane Ring, I0BD -> Arcane Ring, I00C -> Arcane Ring
	set Mjollnir=CID('I0BF','I0BE',0,'I0C0')//I0BF -> Mjollnir, I0BE -> Mjollnir, I0C0 -> Mjollnir
	set FlyingCourier=CID('I014','I01D',0,0)//I014 -> Flying Courier, I01D -> Flying Courier
	set VladmirsOffering=CID('I0BH','I0BG',0,'I0C1')//I0BH -> Vladmir's Offering, I0BG -> Vladmir's Offering, I0C1 -> Vladmir's Offering
	set AssaultCuirass=CID('I0BI','I0BJ',0,'I0C2')//I0BI -> Assault Cuirass, I0BJ -> Assault Cuirass, I0C2 -> Assault Cuirass
	set bloodstone=CID('I0BL','I0BK',0,'I0C3')//I0BL -> Bloodstone, I0BK -> Bloodstone, I0C3 -> Bloodstone
	set HoodOfDefiance=CID('I0BN','I0BM',0,'I0C4')//I0BN -> Hood of Defiance, I0BM -> Hood of Defiance, I0C4 -> Hood of Defiance
	set ArmletOn=CID('I00S','I00M',0,'I01C')//I00S -> Armlet of Mordiggian, I00M -> Armlet of Mordiggian, I01C -> Armlet of Mordiggian (On)
	set ArmletOff=CID('I00T','I00Q',0,'I01E')//I00T -> Armlet of Mordiggian, I00Q -> Armlet of Mordiggian, I01E -> Armlet of Mordiggian (Off)
	set ArmletOnCourier=CID('I00V','I00N',0,'I01F')//I00V -> Armlet of Mordiggian (Courier Edition), I00N -> Armlet of Mordiggian (Courier Edition), I01F -> Armlet of Mordiggian (On,Courier)
	set ArmletOffCourier=CID('I00W','I00R',0,'I0DE')//I00W -> Armlet of Mordiggian (Courier Edition), I00R -> Armlet of Mordiggian (Courier Edition), I0DE -> Armlet of Mordiggian (Off,Courier)
	set ShivasGuard=CID('I00X','I00Z',0,'I0CF')//I00X -> Shiva's Guard, I00Z -> Shiva's Guard, I0CF -> Shiva's Guard
	set ShivasGuardCourier=CID('I00Y','I010',0,'I0DF')//I00Y -> Shiva's Guard (Courier Edition), I010 -> Shiva's Guard (Courier Edition), I0DF -> Shiva's Guard (Courier)
	set Orchid=CID('I013','I012',0,'I0CB')//I013 -> Orchid Malevolence, I012 -> Orchid Malevolence, I0CB -> Orchid Malevolence
	set PhaseBoots=CID('I0GK','I0GJ',0,'I0GL')//I0GK -> Phase Boots, I0GJ -> Phase Boots, I0GL -> Phase Boots
	set ForceStaff=CID('I0HG','I0HI',0,'I0HH')//I0HG -> Force Staff, I0HI -> Force Staff, I0HH -> Force Staff
	set Pipe=CID('I0I0','I0K6',0,'I0I2')//I0I0 -> Khadgar's Pipe of Insight, I0K6 -> Khadgar's Pipe of Insight, I0I2 -> Khadgar's Pipe of Insight
	set PoormansShield=CID('I0JG','I0JF',0,'I0JH')//I0JG -> Poor Man's Shield (melee), I0JF -> Poor Man's Shield (melee), I0JH -> Poor Man's Shield (melee)
	set PoormansShieldRanged=CID('I0KD','I0KF',0,'I0KE')//I0KD -> Poor Man's Shield (ranged), I0KF -> Poor Man's Shield (ranged), I0KE -> Poor Man's Shield (ranged)
	set UrnOfShadows=CID('I0KX','I0KY',0,'I0KZ')//I0KX -> Urn of Shadows, I0KY -> Urn of Shadows, I0KZ -> Urn of Shadows
	set UrnOfShadowsEmpty=CID('I0LG','I0LF',0,'I0LH')//I0LG -> Urn of Shadows (empty), I0LF -> Urn of Shadows (empty), I0LH -> Urn of Shadows (empty)
	set SoulRing=CID('I0LP','I0LL',0,'I0LQ')//I0LP -> Soul Ring, I0LL -> Soul Ring, I0LQ -> Soul Ring
	set EtherealBlade=CID('I0LR','I0LT',0,'I0LS')//I0LR -> Ethereal Blade, I0LT -> Ethereal Blade, I0LS -> Ethereal Blade
	set ArcaneBoots=CID('I0MJ','I0MI',0,'I0MK')//I0MJ -> Arcane Boots, I0MI -> Arcane Boots, I0MK -> Arcane Boots
	set MedallionOfCourage=CID('I0N1','I0N0',0,'I0N2')//I0N1 -> Medallion of Courage, I0N0 -> Medallion of Courage, I0N2 -> Medallion of Courage
	set janggo=CID('I0ND','I0NE',0,'I0NC')//I0ND -> Ancient Janggo of Endurance, I0NE -> Ancient Janggo of Endurance, I0NC -> Ancient Janggo of Endurance
	set janggoempty=CID('I0NL','I0NK',0,'I0NM')//I0NL -> Ancient Janggo of Endurance (empty), I0NK -> Ancient Janggo of Endurance (empty), I0NM -> Ancient Janggo of Endurance (empty)
	set VeilOfDiscord=CID('I0O2','I0O3',0,'I0O4')//I0O2 -> Veil of Discord, I0O3 -> Veil of Discord, I0O4 -> Veil of Discord
	set BladeOfTheReaper=CID('I0OC','I0OE',0,'I0OD')//I0OC -> Blade of the Reaper, I0OE -> Blade of the Reaper, I0OD -> Blade of the Reaper muted
	set TranquilBoots=CID('I0OF','I0OG',0,'I0OH')//I0OF -> Tranquil Boots, I0OG -> Tranquil Boots, I0OH -> Tranquil Boots
	set TranquilBootsBroken=CID('I0OJ','I0OI',0,'I0OK')//I0OJ -> Tranquil Boots Disabled, I0OI -> Tranquil Boots (broken), I0OK -> Tranquil Boots Disabled
	set RodOfAtos=CID('I0OM','I0OL',0,'I0ON')//I0OM -> Rod of Atos, I0OL -> Rod of Atos, I0ON -> Rod of Atos
	
	set MoonShard=CID('I0SI','I0SJ',0,'I0SK')//I0SI -> Moon Shard, I0SJ -> Moon Shard, I0SK -> Moon Shard
	set OctarineCore=CID('I0SU','I0SV',0,'I0SW')//I0SU -> Octarine Core, I0SV -> Octarine Core, I0SW -> Octarine Core
	set SilverEdge=CID('I0SL','I0SM',0,'I0SN')//I0SL -> Silver Edge, I0SM -> Silver Edge, I0SN -> Silver Edge
	set SolarCrest=CID('I0SR','I0SS',0,'I0ST')//I0SR -> Solar Crest, I0SS -> Solar Crest, I0ST -> Solar Crest
	set LotusOrb=CID('I0T5','I0T6',0,'I0T7')//I0T5 -> Lotus Orb, I0T6 -> Lotus Orb, I0T7 -> Lotus Orb
	
	set Mango=CID('I0S6','I0S7','n12A','I0S8')//I0S6 -> Enchanted Mango, I0S7 -> Enchanted Mango, n12A -> Enchanted Mango, I0S8 -> Enchanted Mango
	set GuardianGreaves=CID('I0SC','I0SD',0,'I0SE')//I0SC -> Guardian Greaves, I0SD -> Guardian Greaves, I0SE -> Guardian Greaves
	set GlimmerCape=CID('I0S9','I0SA',0,'I0SB')//I0S9 -> Glimmer Cape, I0SA -> Glimmer Cape, I0SB -> Glimmer Cape
	set bootsOfTravel2=CID('I0SZ','I0T0',0,'I0T1')//I0SZ -> Boots of Travel Upgraded, I0T0 -> Boots of Travel Upgraded, I0T1 -> Boots of Travel Upgraded
	set ShadowAmulet=CID('I0P9','I0PB','h0EI','I0PA')//I0P9 -> Shadow Amulet, I0PB -> Shadow Amulet, h0EI -> Shadow Amulet, I0PA -> Shadow Amulet
	
	set HeavensHalberd=CID('I0OU','I0OV',0,'I0OW')//I0OU -> Heaven's Halberd, I0OV -> Heaven's Halberd, I0OW -> Heaven's Halberd
	set AbyssalBlade=CID('I0OY','I0OX',0,'I0OZ')//I0OY -> Abyssal Blade, I0OX -> Abyssal Blade, I0OZ -> Abyssal Blade
	set RingOfAquila=CID('I0P0','I0P1',0,'I0P2')//I0P0 -> Ring of Aquila, I0P1 -> Ring of Aquila (|cff00ff00Normal|r), I0P2 -> Ring of Aquila
	set RingOfAquilaHero=CID('I0P3','I0P4',0,'I0P5')//I0P3 -> Ring of Aquila (Heroes), I0P4 -> Ring of Aquila (|cffff0000Heroes|r), I0P5 -> Ring of Aquila (Heroes)
	call SaveInteger(HY,'ITDB',CID(0,0,'h02G',0),Perseverance)//h02G -> Perseverance
	call SaveInteger(HY,'ITDB',CID(0,0,'h086',0),PoormansShield)//h086 -> Poor Man's Shield
	set s="ReplaceableTextures\\CommandButtons\\BTNSnazzyScroll.blp"
	set RecipeMoonShard=CID(0,0,'h0DY',0)//I0OO -> Moon Shard Recipe, I0OP -> Moon Shard Recipe, h0DY -> Moon Shard, I0OQ -> Moon Shard Recipe
	set RecipeLotusOrb=CID('I0T2','I0T3','n12H','I0T4')//I0T2 -> Lotus Orb Recipe, I0T3 -> Lotus Orb Recipe, n12H -> Lotus Orb, I0T4 -> Lotus Orb Recipe
	set RecipeSilverEdge=CID('I0SO','I0SP','n12D','I0SQ')//I0SO -> Silver Edge Recipe, I0SP -> Silver Edge Recipe, n12D -> Silver Edge, I0SQ -> Silver Edge Recipe
	set RecipeGuardianGreaves=CID('I0SF','I0SG','n12C','I0SH')//I0SF -> Guardian Greaves Recipe, I0SG -> Guardian Greaves Recipe, n12C -> Guardian Greaves, I0SH -> Guardian Greaves Recipe
	set RecipeHeaddressOfRejuvenation=CID('I05L','I05R','h02H','I0DS')//I05L -> Headdress of Rejuvenation Recipe, I05R -> Headdress of Rejuvenation Recipe, h02H -> Headdress of Rejuvenation, I0DS -> Headdress of Rejuvenation Recipe
	set RecipeNethrezimBuckler=CID('I05M','I05S','h02I','I0DT')//I05M -> Nathrezim Buckler Recipe, I05S -> Nathrezim Buckler Recipe, h02I -> Nathrezim Buckler, I0DT -> Nathrezim Buckler Recipe
	call SaveInteger(HY,'ITDB',CID(0,0,'h02J',0),RingOfBasiliusHero)//h02J -> Ring of Basilius
	call SaveInteger(HY,'ITDB',CID(0,0,'h014',0),PowerTreadsAgility)//h014 -> Power Treads
	set RecipeBootsOfTravel=CID('I05O','I05T','h02K','I0DU')//I05O -> Boots of Travel Recipe, I05T -> Boots of Travel Recipe, h02K -> Boots of Travel, I0DU -> Boots of Travel Recipe
	set RecipeHandOfMidas=CID('I05P','I05U','h02L','I0DW')//I05P -> Hand of Midas Recipe, I05U -> Hand of Midas Recipe, h02L -> Hand of Midas, I0DW -> Hand of Midas Recipe
	call SaveInteger(HY,'ITDB',CID(0,0,'h02M',0),OblivionStaff)//h02M -> Oblivion Staff
	set RecipeBracer=CID('I05K','I05V','h02N','I0DX')//I05K -> Bracer Recipe, I05V -> Bracer Recipe, h02N -> Bracer, I0DX -> Bracer Recipe
	set RecipeWraithBand=CID('I05N','I05W','h02O','I0DY')//I05N -> Wraith Band Recipe, I05W -> Wraith Band Recipe, h02O -> Wraith Band, I0DY -> Wraith Band Recipe
	set RecipeNullTalisman=CID('I05Q','I05X','h02P','I0DZ')//I05Q -> Null Talisman Recipe, I05X -> Null Talisman Recipe, h02P -> Null Talisman, I0DZ -> Null Talisman Recipe
	set RecipeYasha=CID('I06N','I06O','h02Q','I0E0')//I06N -> Yasha Recipe, I06O -> Yasha Recipe, h02Q -> Yasha, I0E0 -> Yasha Recipe
	set RecipeSange=CID('I06Q','I06P','h02R','I0E1')//I06Q -> Sange Recipe, I06P -> Sange Recipe, h02R -> Sange, I0E1 -> Sange Recipe
	set RecipeCraniumBasher=CID('I06R','I06S','h02S','I0E2')//I06R -> Cranium Basher Recipe, I06S -> Cranium Basher Recipe, h02S -> Cranium Basher, I0E2 -> Cranium Basher Recipe
	call SaveInteger(HY,'ITDB',CID(0,0,'h02T',0),BladeMail)//h02T -> Blade Mail
	set RecipeMaelstrom=CID('I06W','I06V','h02U','I0E4')//I06W -> Maelstrom Recipe, I06V -> Maelstrom Recipe, h02U -> Maelstrom, I0E4 -> Maelstrom Recipe
	set RecipeDiffusalBlade=CID('I06X','I06Y','h02V','I0E5')//I06X -> Diffusal Blade Recipe, I06Y -> Diffusal Blade Recipe, h02V -> Diffusal Blade, I0E5 -> Diffusal Blade Recipe
	call SaveInteger(HY,'ITDB',CID(0,0,'h02W',0),HelmOfTheDominator)//h02W -> Helm of the Dominator
	set RecipeMaskOfMadness=CID('I070','I06Z','h02X','I0E6')//I070 -> Mask of Madness Recipe, I06Z -> Mask of Madness Recipe, h02X -> Mask of Madness, I0E6 -> Mask of Madness Recipe
	set RecipeEul=CID('I071','I072','h02Y','I0E7')//I071 -> Eul's Scepter of Divinity Recipe, I072 -> Eul's Scepter of Divinity Recipe, h02Y -> Eul's Scepter of Divinity, I0E7 -> Eul's Scepter of Divinity Recipe
	call CID(0,0,'h02Z',0)//h02Z -> Soul Booster
	set RecipeMekansm=CID('I074','I073','h030','I0E8')//I074 -> Mekansm Recipe, I073 -> Mekansm Recipe, h030 -> Mekansm, I0E8 -> Mekansm Recipe
	set RecipeSangeAndYasha=CID(0,0,'h031',0)//h031 -> Sange and Yasha
	call SaveInteger(HY,'ITDB',RecipeSangeAndYasha,SangeAndYasha)
	set RecipeDesolator=CID('I076','I07V','h032','I0EA')//I076 -> Stygian Desolator Recipe, I07V -> Stygian Desolator Recipe, h032 -> Stygian Desolator, I0EA -> Stygian Desolator Recipe
	call SaveInteger(HY,'ITDB',CID(0,0,'h033',0),BattleFury)//h033 -> Battle Fury
	set RecipeCrystalys=CID('I077','I07W','h034','I0EB')//I077 -> Crystalys Recipe, I07W -> Crystalys Recipe, h034 -> Crystalys, I0EB -> Crystalys Recipe
	set RecipeBKB=CID('I078','I07X','h035','I0EC')//I078 -> Black King Bar Recipe, I07X -> Black King Bar Recipe, h035 -> Black King Bar, I0EC -> Black King Bar Recipe
	set RecipeMantaStyle=CID('I079','I07Y','h036','I0ED')//I079 -> Manta Style Recipe, I07Y -> Manta Style Recipe, h036 -> Manta Style, I0ED -> Manta Style Recipe
	call SaveInteger(HY,'ITDB',CID(0,0,'h037',0),LotharsEdge)//h037 -> Lothar's Edge
	set RecipeDagon=CID('I07B','I080','h038','I0EF')//I07B -> Dagon Recipe, I080 -> Dagon Recipe, h038 -> Dagon, I0EF -> Dagon Recipe
	set RecipeNecronomicon=CID('I07C','I081','h039','I0EG')//I07C -> Necronomicon Recipe, I081 -> Necronomicon Recipe, h039 -> Necronomicon, I0EG -> Necronomicon Recipe
	set RecipeLinken=CID('I07D','I082','h03A','I0EH')//I07D -> Linken's Sphere Recipe, I082 -> Linken's Sphere Recipe, h03A -> Linken's Sphere, I0EH -> Linken's Sphere Recipe
	call CID(0,0,'h03C',0)//h03C -> Divine Rapier
	set RecipeBuriza=CID('I07E','I083','h03D','I0EI')//I07E -> Buriza-do Kyanon Recipe, I083 -> Buriza-do Kyanon Recipe, h03D -> Buriza-do Kyanon, I0EI -> Buriza-do Kyanon Recipe
	call SaveInteger(HY,'ITDB',CID(0,0,'h03E',0),MKBOn)//h03E -> Monkey King Bar
	set RecipeRadiance=CID('I07G','I07F','h03F','I0EJ')//I07G -> Radiance Recipe, I07F -> Radiance Recipe, h03F -> Radiance, I0EJ -> Radiance Recipe
	set RecipeHeartOfTarrasque=CID('I07H','I084','h03G','I0EK')//I07H -> Heart of Tarrasque Recipe, I084 -> Heart of Tarrasque Recipe, h03G -> Heart of Tarrasque, I0EK -> Heart of Tarrasque Recipe
	set RecipeSatanic=CID('I07O','I085','h03H','I0EL')//I07O -> Satanic Recipe, I085 -> Satanic Recipe, h03H -> Satanic, I0EL -> Satanic Recipe
	set RecipeAghanim=CID(0,0,'h03K',0)//h03K -> Aghanim's Scepter
	call SaveInteger(HY,'ITDB',RecipeAghanim,AghanimBasic)
	set RecipeRefresherOrb=CID('I07J','I088','h03L','I0EO')//I07J -> Refresher Orb Recipe, I088 -> Refresher Orb Recipe, h03L -> Refresher Orb, I0EO -> Refresher Orb Recipe
	call SaveInteger(HY,'ITDB',CID(0,0,'h03M',0),GuinsooHex)//h03M -> Guinsoo's Scythe of Vyse
	call SaveInteger(HY,'ITDB',CID(0,0,'h03N',0),Vanguard)//h03N -> Vanguard
	set RecipeArcaneRing=CID('I07M','I089','h03O','I0EP')//I07M -> Arcane Ring Recipe, I089 -> Arcane Ring Recipe, h03O -> Arcane Ring, I0EP -> Arcane Ring Recipe
	set RecipeFlyingCourier=CID('I07P','I08A','h03Q','I0EQ')//I07P -> Flying Courier Recipe, I08A -> Flying Courier Recipe, h03Q -> Flying Courier, I0EQ -> Flying Courier Recipe
	set RecipeVladmirOffering=CID('I07Q','I08B','h03R','I0ER')//I07Q -> Vladmir's Offering Recipe, I08B -> Vladmir's Offering Recipe, h03R -> Vladmir's Offering, I0ER -> Vladmir's Offering Recipe
	set RecipeAssaultCuirass=CID('I07R','I08C','h03S','I0ES')//I07R -> Assault Cuirass Recipe, I08C -> Assault Cuirass Recipe, h03S -> Assault Cuirass, I0ES -> Assault Cuirass Recipe
	set RecipeBloodstone=CID('I0QQ','I0QN','h03T','I0QR')//I0QQ -> Bloodstone recipe, I0QN -> Bloodstone recipe, h03T -> Bloodstone, I0QR -> Bloodstone recipe
	call SaveInteger(HY,'ITDB',CID(0,0,'h03U',0),HoodOfDefiance)//h03U -> Hood of Defiance
	set RecipeArmlet=CID('I07S','I08D','h03V','I0ET')//I07S -> Armlet of Mordiggian Recipe, I08D -> Armlet of Mordiggian Recipe, h03V -> Armlet of Mordiggian, I0ET -> Armlet of Mordiggian Recipe
	set RecipeShivasGuard=CID('I07T','I08E','h03W','I0EU')//I07T -> Shiva's Guard Recipe, I08E -> Shiva's Guard Recipe, h03W -> Shiva's Guard, I0EU -> Shiva's Guard Recipe
	call SaveInteger(HY,'ITDB',CID(0,0,'h079',0),PhaseBoots)//h079 -> Phase Boots
	set RecipeForceStaff=CID('I0HD','I0HF','h07T','I0HE')//I0HD -> Force Staff Recipe, I0HF -> Force Staff Recipe, h07T -> Force Staff, I0HE -> Force Staff Recipe
	set RecipePipe=CID('I0HX','I0HZ','h07X','I0HY')//I0HX -> Khadgar's Pipe of Insight, I0HZ -> Khadgar's Pipe of Insight Recipe, h07X -> Khadgar's Pipe of Insight, I0HY -> Khadgar's Pipe of Insight
	set RecipeMjollnir=CID('I07L','I0KN','h03P','I0KO')//I07L -> Mjollnir Recipe, I0KN -> Mjollnir Recipe, h03P -> Mjollnir, I0KO -> Mjollnir
	set RecipeUrnOfShadows=CID('I0KW','I0KV','h0BA','I0KU')//I0KW -> Urn of Shadows Recipe, I0KV -> Urn of Shadows Recipe, h0BA -> Urn of Shadows, I0KU -> Urn of Shadows Recipe
	set RecipeSoulRing=CID('I0LM','I0LN','h0BQ','I0LO')//I0LM -> Soul Ring Recipe, I0LN -> Soul Ring Recipe, h0BQ -> Soul Ring, I0LO -> Soul Ring Recipe
	set RecipeJanggo=CID('I0N9','I0NA','h0D1','I0NB')//I0N9 -> Ancient Janggo of Endurance, I0NA -> Ancient Janggo of Endurance Recipe, h0D1 -> Ancient Janggo of Endurance, I0NB -> Ancient Janggo of Endurance Recipe
	set RecipeMedallion=CID('I0NH','I0NI','h0CY','I0NJ')//I0NH -> Medallion of Courage, I0NI -> Medallion of Courage Recipe, h0CY -> Medallion of Courage, I0NJ -> Medallion of Courage
	set RecipeVeilOfDiscord=CID('I0O5','I0O6','h0DD','I0O7')//I0O5 -> Veil of Discord, I0O6 -> Veil of Discord Recipe, h0DD -> Veil of Discord, I0O7 -> Veil of Discord
	set RecipeOrchid=CID('I0OB','I0OA','h03X','I0O9')//I0OB -> Orchid Malevolence, I0OA -> Orchid Malevolence Recipe, h03X -> Orchid Malevolence, I0O9 -> Orchid Malevolence
	set RecipeTranquilBoots=CID(0,0,'h0DU',0)//h0DU -> Tranquil Boots
	call SaveInteger(HY,'ITDB',RecipeTranquilBoots,TranquilBoots)
	
	call SaveInteger(HY,'ITDB',CID(0,0,'h0E9',0),HeavensHalberd)//h0E9 -> Heaven's Halberd
	call SaveInteger(HY,'ITDB',CID(0,0,'h0DV',0),RodOfAtos)//h0DV -> Rod of Atos
	call SaveInteger(HY,'ITDB',CID(0,0,'h0EN',0),GlimmerCape)//h0EN -> Glimmer Cape
	call CID(0,0,'h0EA',0)//h0EA -> Abyssal Blade
	call SaveInteger(HY,'ITDB',CID(0,0,'h0EC',0),RingOfAquilaHero)//h0EC -> Ring of Aquila
	
	
	call SaveInteger(ItemsData,Item_Real[BKB05],'00CD',55)
	call SaveInteger(ItemsData,Item_Real[ShivasGuard],'00CD',30)
	call SaveInteger(ItemsData,Item_Real[BladeMail],'00CD',15)
	call SaveInteger(ItemsData,Item_Real[MantaStyle],'00CD',50)
	call SaveInteger(ItemsData,Item_Real[MantaStyleRanged],'00CD',50)
	call SaveInteger(ItemsData,Item_Real[GuinsooHex],'00CD',30)
	call SaveInteger(ItemsData,Item_Real[Orchid],'00CD',18)
	call SaveInteger(ItemsData,Item_Real[Eul],'00CD',23)
	call SaveInteger(ItemsData,Item_Real[ForceStaff],'00CD',20)
	call SaveInteger(ItemsData,Item_Real[Dagon1],'00CD',35)
	call SaveInteger(ItemsData,Item_Real[Dagon2],'00CD',30)
	call SaveInteger(ItemsData,Item_Real[Dagon3],'00CD',25)
	call SaveInteger(ItemsData,Item_Real[Dagon4],'00CD',20)
	call SaveInteger(ItemsData,Item_Real[Dagon5],'00CD',15)
	call SaveInteger(ItemsData,Item_Real[Necronomicon1],'00CD',95)
	call SaveInteger(ItemsData,Item_Real[Necronomicon2],'00CD',95)
	call SaveInteger(ItemsData,Item_Real[Necronomicon3],'00CD',95)
	call SaveInteger(ItemsData,Item_Real[VeilOfDiscord],'00CD',30)
	call SaveInteger(ItemsData,Item_Real[RodOfAtos],'00CD',10)
	call SaveInteger(ItemsData,Item_Real[Mekansm],'00CD',45)
	call SaveInteger(ItemsData,Item_Real[Pipe],'00CD',60)
	call SaveInteger(ItemsData,Item_Real[MedallionOfCourage],'00CD',7)
	call SaveInteger(ItemsData,Item_Real[EtherealBlade],'00CD',30)
	call SaveInteger(ItemsData,Item_Real[AbyssalBlade],'00CD',60)
	call SaveInteger(ItemsData,Item_Real[LotharsEdge],'00CD',28)
	call SaveInteger(ItemsData,Item_Real[Satanic],'00CD',35)
	call SaveInteger(ItemsData,Item_Real[Mjollnir],'00CD',35)
	call SaveInteger(ItemsData,Item_Real[MaskOfMadness],'00CD',25)
	call SaveInteger(ItemsData,Item_Real[HelmOfTheDominator],'00CD',60)
	call SaveInteger(ItemsData,Item_Real[HeavensHalberd],'00CD',30)
	call SaveInteger(ItemsData,Item_Real[bootsOfTravel],'00CD',45)
	call SaveInteger(ItemsData,Item_Real[bootsOfTravel2],'00CD',45)
	call SaveInteger(ItemsData,Item_Real[HandOfMidas],'00CD',100)
	call SaveInteger(ItemsData,Item_Real[dustofappearance],'00CD',50)
	call SaveInteger(ItemsData,Item_Real[GuardianGreaves],'00CD',40)
	call SaveInteger(ItemsData,Item_Real[GlimmerCape],'00CD',16)
	call SaveInteger(ItemsData,Item_Real[SolarCrest],'00CD',7)
	call SaveInteger(ItemsData,Item_Real[SilverEdge],'00CD',28)
	call SaveInteger(ItemsData,Item_Real[LotusOrb],'00CD',15)
	
	
	set Item_SideShops[CID('I03A','I051','h08K','I0D9')]=StoutShield//I03A -> Stout Shield (melee), I051 -> Stout Shield (melee), h08K -> Stout Shield, I0D9 -> Stout Shield (melee)
	set Item_SideShops[CID('I03Y','I052','h08X','I0C9')]=UltimateOrb//I03Y -> Ultimate Orb, I052 -> Ultimate Orb, h08X -> Ultimate Orb, I0C9 -> Ultimate Orb
	set Item_SideShops[CID('I02S','I02P','h08S','I0CA')]=GlovesOfHaste//I02S -> Gloves of Haste, I02P -> Gloves of Haste, h08S -> Gloves of Haste, I0CA -> Gloves of Haste
	set Item_SideShops[CID('I02N','I02R','h08P','I0CS')]=BootsOfElvenskin//I02N -> Boots of Elvenskin, I02R -> Boots of Elvenskin, h08P -> Boots of Elvenskin, I0CS -> Boots of Elvenskin
	set Item_SideShops[CID('I02Z','I043','h08Q','I0CV')]=BeltOfStrength//I02Z -> Belt of Giant Strength, I043 -> Belt of Giant Strength, h08Q -> Belt of Giant Strength, I0CV -> Belt of Giant Strength
	set Item_SideShops[CID('I031','I045','h08T','I0D5')]=BladesOfAttack//I031 -> Blades of Attack, I045 -> Blades of Attack, h08T -> Blades of Attack, I0D5 -> Blades of Attack
	set Item_SideShops[CID('I03B','I04E','h08N','I0DA')]=HelmOfIronWill//I03B -> Helm of Iron Will, I04E -> Helm of Iron Will, h08N -> Helm of Iron Will, I0DA -> Helm of Iron Will
	set Item_SideShops[CID('I03E','I04H','h08W','I0C7')]=KelensDagger//I03E -> Kelen's Dagger, I04H -> Kelen's Dagger, h08W -> Kelen's Dagger, I0C7 -> Kelen's Dagger
	set Item_SideShops[CID('I03G','I04K','h08O','I0CD')]=MaskOfDeath//I03G -> Mask of Death, I04K -> Mask of Death, h08O -> Mask of Death, I0CD -> Mask of Death
	set Item_SideShops[CID('I03P','I04S','h08U','I0CY')]=Quarterstaff//I03P -> Quarterstaff, I04S -> Quarterstaff, h08U -> Quarterstaff, I0CY -> Quarterstaff
	set Item_SideShops[CID('I03Q','I04T','h08G','I0DI')]=RingOfHealth//I03Q -> Ring of Health, I04T -> Ring of Health, h08G -> Ring of Health, I0DI -> Ring of Health
	set Item_SideShops[CID('I03S','I04V','h08L','I0DJ')]=RingOfRegeneration//I03S -> Ring of Regeneration, I04V -> Ring of Regeneration, h08L -> Ring of Regeneration, I0DJ -> Ring of Regeneration
	set Item_SideShops[CID('I03T','I04W','h08R','I0CP')]=RobeOfMagi//I03T -> Robe of the Magi, I04W -> Robe of the Magi, h08R -> Robe of the Magi, I0CP -> Robe of the Magi
	set Item_SideShops[CID('I03V','I04Y','h08E','I0C5')]=SlippersOfAgility//I03V -> Slippers of Agility, I04Y -> Slippers of Agility, h08E -> Slippers of Agility, I0C5 -> Slippers of Agility
	set Item_SideShops[CID('I03W','I04Z','h08J','I0DK')]=SobiMask//I03W -> Sobi Mask, I04Z -> Sobi Mask, h08J -> Sobi Mask, I0DK -> Sobi Mask
	set Item_SideShops[CID('I0GD','I0GC','h08I','I0GE')]=MagicStick//I0GD -> Magic Stick, I0GC -> Magic Stick, h08I -> Magic Stick, I0GE -> Magic Stick
	set Item_SideShops[CID('I0HT','I0HR','h08F','I0HW')]=QuellingBlade//I0HT -> Quelling Blade, I0HR -> Quelling Blade, h08F -> Quelling Blade, I0HW -> Quelling Blade Ranged
	set Item_SideShops[CID('I0J7','I0J6','h08V','I0J8')]=TalismanOfEvasion//I0J7 -> Talisman of Evasion, I0J6 -> Talisman of Evasion, h08V -> Talisman of Evasion, I0J8 -> Talisman of Evasion
	set Item_SideShops[CID('I040','I054','h08M','I0DL')]=VoidStone//I040 -> Void Stone, I054 -> Void Stone, h08M -> Void Stone, I0DL -> Void Stone
	set Item_SideShops[CID('I05A','I05I','h08H',0)]=ScrollOfTownPortal//I05A -> Scroll of Town Portal, I05I -> Scroll of Town Portal, h08H -> Scroll of Town Portal
	set Item_SideShops[CID('I037','I04B','h093','I0CR')]=EnergyBooster//I037 -> Energy Booster, I04B -> Energy Booster, h093 -> Energy Booster, I0CR -> Energy Booster
	set Item_SideShops[CID('I02Q','I02O','h0BO','I00A')]=BootsOfSpeed//I02Q -> Boots of Speed, I02O -> Boots of Speed, h0BO -> Boots of Speed, I00A -> Boots of Speed
	set Item_SideShops[CID('I0MA','I0M9','h0CN','I0MB')]=OrbOfVenom//I0MA -> Orb of Venom, I0M9 -> Orb of Venom, h0CN -> Orb of Venom sideshop, I0MB -> Orb of Venom
	set Item_SideShops[CID('I033','I047','h0D0','I0D7')]=Chainmail//I033 -> Chainmail, I047 -> Chainmail, h0D0 -> Chainmail, I0D7 -> Chain Mail
	set Item_SideShops[CID('I032','I046','u025','I0CZ')]=Broadsword//I032 -> Broadsword, I046 -> Broadsword, u025 -> Broadsword, I0CZ -> Broadsword
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=RingOfHealth
	set Rec_Comp_2[Recipe_Max]=VoidStone
	set Rec_Final[Recipe_Max]=Perseverance
	set Recipe_Max=Recipe_Max+1
	
	set Rec_Comp_1[Recipe_Max]=Perseverance
	set Rec_Comp_2[Recipe_Max]=PlateMail
	set Rec_Comp_3[Recipe_Max]=RecipeLotusOrb
	set Rec_Final[Recipe_Max]=LotusOrb
	set Recipe_Max=Recipe_Max+1
	
	set Rec_Comp_1[Recipe_Max]=Hyperstone
	set Rec_Comp_2[Recipe_Max]=Hyperstone
	set Rec_Final[Recipe_Max]=MoonShard
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=PlaneswalkerCloak
	set Rec_Comp_2[Recipe_Max]=ShadowAmulet
	set Rec_Final[Recipe_Max]=GlimmerCape
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=MedallionOfCourage
	set Rec_Comp_2[Recipe_Max]=TalismanOfEvasion
	set Rec_Final[Recipe_Max]=SolarCrest
	set Recipe_Max=Recipe_Max+1
	
	set Rec_Comp_1[Recipe_Max]=RingOfRegeneration
	set Rec_Comp_2[Recipe_Max]=IronwoodBranch
	set Rec_Comp_3[Recipe_Max]=RecipeHeaddressOfRejuvenation
	set Rec_Final[Recipe_Max]=HeaddressOfRejuvenation
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Chainmail
	set Rec_Comp_2[Recipe_Max]=IronwoodBranch
	set Rec_Comp_3[Recipe_Max]=RecipeNethrezimBuckler
	set Rec_Final[Recipe_Max]=NathrezimBuckler
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=RingOfProtection
	set Rec_Comp_2[Recipe_Max]=SobiMask
	set Rec_Final[Recipe_Max]=RingOfBasiliusHero
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=BootsOfSpeed
	set Rec_Comp_2[Recipe_Max]=RecipeBootsOfTravel
	set Rec_Final[Recipe_Max]=bootsOfTravel
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=bootsOfTravel
	set Rec_Comp_2[Recipe_Max]=RecipeBootsOfTravel
	set Rec_Final[Recipe_Max]=bootsOfTravel2
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=SoulBooster
	set Rec_Comp_2[Recipe_Max]=MysticStaff
	set Rec_Final[Recipe_Max]=OctarineCore
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=BootsOfSpeed
	set Rec_Comp_2[Recipe_Max]=BootsOfElvenskin
	set Rec_Comp_3[Recipe_Max]=GlovesOfHaste
	set Rec_Final[Recipe_Max]=PowerTreadsAgility
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=BootsOfSpeed
	set Rec_Comp_2[Recipe_Max]=BeltOfStrength
	set Rec_Comp_3[Recipe_Max]=GlovesOfHaste
	set Rec_Final[Recipe_Max]=PowerTreadsStrength
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=BootsOfSpeed
	set Rec_Comp_2[Recipe_Max]=RobeOfMagi
	set Rec_Comp_3[Recipe_Max]=GlovesOfHaste
	set Rec_Final[Recipe_Max]=PowerTreadsIntelligence
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=GlovesOfHaste
	set Rec_Comp_2[Recipe_Max]=RecipeHandOfMidas
	set Rec_Final[Recipe_Max]=HandOfMidas
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Quarterstaff
	set Rec_Comp_2[Recipe_Max]=RobeOfMagi
	set Rec_Comp_3[Recipe_Max]=SobiMask
	set Rec_Final[Recipe_Max]=OblivionStaff
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=CircletOfNobility
	set Rec_Comp_2[Recipe_Max]=GauntletOfStrength
	set Rec_Comp_3[Recipe_Max]=RecipeBracer
	set Rec_Final[Recipe_Max]=Bracer
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=CircletOfNobility
	set Rec_Comp_2[Recipe_Max]=SlippersOfAgility
	set Rec_Comp_3[Recipe_Max]=RecipeWraithBand
	set Rec_Final[Recipe_Max]=WraithBand
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=CircletOfNobility
	set Rec_Comp_2[Recipe_Max]=MantleOfIntelligence
	set Rec_Comp_3[Recipe_Max]=RecipeNullTalisman
	set Rec_Final[Recipe_Max]=NullTalisman
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=BladesOfAlacrity
	set Rec_Comp_2[Recipe_Max]=BootsOfElvenskin
	set Rec_Comp_3[Recipe_Max]=RecipeYasha
	set Rec_Final[Recipe_Max]=Yasha
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=OgreAxe
	set Rec_Comp_2[Recipe_Max]=BeltOfStrength
	set Rec_Comp_3[Recipe_Max]=RecipeSange
	set Rec_Final[Recipe_Max]=Sange
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=javelin
	set Rec_Comp_2[Recipe_Max]=BeltOfStrength
	set Rec_Comp_3[Recipe_Max]=RecipeCraniumBasher
	set Rec_Final[Recipe_Max]=CraniumBasher
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=LotharsEdge
	set Rec_Comp_2[Recipe_Max]=Sange
	set Rec_Comp_3[Recipe_Max]=RecipeSilverEdge
	set Rec_Final[Recipe_Max]=SilverEdge
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Mekansm
	set Rec_Comp_2[Recipe_Max]=ArcaneBoots
	set Rec_Comp_3[Recipe_Max]=RecipeGuardianGreaves
	set Rec_Final[Recipe_Max]=GuardianGreaves
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Broadsword
	set Rec_Comp_2[Recipe_Max]=Chainmail
	set Rec_Comp_3[Recipe_Max]=RobeOfMagi
	set Rec_Final[Recipe_Max]=BladeMail
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=MithrilHammer
	set Rec_Comp_2[Recipe_Max]=GlovesOfHaste
	set Rec_Comp_3[Recipe_Max]=RecipeMaelstrom
	set Rec_Final[Recipe_Max]=Maelstrom
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=BladesOfAlacrity
	set Rec_Comp_2[Recipe_Max]=BladesOfAlacrity
	set Rec_Comp_3[Recipe_Max]=RobeOfMagi
	set Rec_Comp_4[Recipe_Max]=RecipeDiffusalBlade
	set Rec_Final[Recipe_Max]=DiffusalBlade
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=DiffusalBlade
	set Rec_Comp_2[Recipe_Max]=RecipeDiffusalBlade
	set Rec_Final[Recipe_Max]=DiffusalBlade_upg
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=DiffusalBlade_empty
	set Rec_Comp_2[Recipe_Max]=RecipeDiffusalBlade
	set Rec_Final[Recipe_Max]=DiffusalBlade_upg
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=HelmOfIronWill
	set Rec_Comp_2[Recipe_Max]=MaskOfDeath
	set Rec_Final[Recipe_Max]=HelmOfTheDominator
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=MaskOfDeath
	set Rec_Comp_2[Recipe_Max]=RecipeMaskOfMadness
	set Rec_Final[Recipe_Max]=MaskOfMadness
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=SobiMask
	set Rec_Comp_2[Recipe_Max]=StaffOfWizardry
	set Rec_Comp_3[Recipe_Max]=VoidStone
	set Rec_Comp_4[Recipe_Max]=RecipeEul
	set Rec_Final[Recipe_Max]=Eul
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=PointBooster
	set Rec_Comp_2[Recipe_Max]=EnergyBooster
	set Rec_Comp_3[Recipe_Max]=VitalityBooster
	set Rec_Final[Recipe_Max]=SoulBooster
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=HeaddressOfRejuvenation
	set Rec_Comp_2[Recipe_Max]=NathrezimBuckler
	set Rec_Comp_3[Recipe_Max]=RecipeMekansm
	set Rec_Final[Recipe_Max]=Mekansm
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Sange
	set Rec_Comp_2[Recipe_Max]=Yasha
	set Rec_Final[Recipe_Max]=SangeAndYasha
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=MithrilHammer
	set Rec_Comp_2[Recipe_Max]=MithrilHammer
	set Rec_Comp_3[Recipe_Max]=RecipeDesolator
	set Rec_Final[Recipe_Max]=Desolator
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Perseverance
	set Rec_Comp_2[Recipe_Max]=Broadsword
	set Rec_Comp_3[Recipe_Max]=Claymore
	set Rec_Comp_4[Recipe_Max]=QuellingBlade
	set Rec_Final[Recipe_Max]=BattleFury
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Perseverance
	set Rec_Comp_2[Recipe_Max]=Broadsword
	set Rec_Comp_3[Recipe_Max]=Claymore
	set Rec_Comp_4[Recipe_Max]=QuellingBladeRanged
	set Rec_Final[Recipe_Max]=BattleFury
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=BladesOfAttack
	set Rec_Comp_2[Recipe_Max]=Broadsword
	set Rec_Comp_3[Recipe_Max]=RecipeCrystalys
	set Rec_Final[Recipe_Max]=Crystalys
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=MithrilHammer
	set Rec_Comp_2[Recipe_Max]=OgreAxe
	set Rec_Comp_3[Recipe_Max]=RecipeBKB
	set Rec_Final[Recipe_Max]=BKB10
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Yasha
	set Rec_Comp_2[Recipe_Max]=UltimateOrb
	set Rec_Comp_3[Recipe_Max]=RecipeMantaStyle
	set Rec_Final[Recipe_Max]=MantaStyleRanged
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=ShadowAmulet
	set Rec_Comp_2[Recipe_Max]=Claymore
	set Rec_Final[Recipe_Max]=LotharsEdge
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=StaffOfWizardry
	set Rec_Comp_2[Recipe_Max]=NullTalisman
	set Rec_Comp_3[Recipe_Max]=RecipeDagon
	set Rec_Final[Recipe_Max]=Dagon1
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Dagon1
	set Rec_Comp_2[Recipe_Max]=RecipeDagon
	set Rec_Final[Recipe_Max]=Dagon2
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Dagon2
	set Rec_Comp_2[Recipe_Max]=RecipeDagon
	set Rec_Final[Recipe_Max]=Dagon3
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Dagon3
	set Rec_Comp_2[Recipe_Max]=RecipeDagon
	set Rec_Final[Recipe_Max]=Dagon4
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Dagon4
	set Rec_Comp_2[Recipe_Max]=RecipeDagon
	set Rec_Final[Recipe_Max]=Dagon5
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=StaffOfWizardry
	set Rec_Comp_2[Recipe_Max]=BeltOfStrength
	set Rec_Comp_3[Recipe_Max]=RecipeNecronomicon
	set Rec_Final[Recipe_Max]=Necronomicon1
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Necronomicon1
	set Rec_Comp_2[Recipe_Max]=RecipeNecronomicon
	set Rec_Final[Recipe_Max]=Necronomicon2
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Necronomicon2
	set Rec_Comp_2[Recipe_Max]=RecipeNecronomicon
	set Rec_Final[Recipe_Max]=Necronomicon3
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=UltimateOrb
	set Rec_Comp_2[Recipe_Max]=Perseverance
	set Rec_Comp_3[Recipe_Max]=RecipeLinken
	set Rec_Final[Recipe_Max]=LinkensSphere
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=DemonEdge
	set Rec_Comp_2[Recipe_Max]=SacredRelic
	set Rec_Final[Recipe_Max]=DivineRapier
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Crystalys
	set Rec_Comp_2[Recipe_Max]=DemonEdge
	set Rec_Comp_3[Recipe_Max]=RecipeBuriza
	set Rec_Final[Recipe_Max]=Buriza
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=DemonEdge
	set Rec_Comp_2[Recipe_Max]=javelin
	set Rec_Comp_3[Recipe_Max]=javelin
	set Rec_Final[Recipe_Max]=MKBOn
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=SacredRelic
	set Rec_Comp_2[Recipe_Max]=RecipeRadiance
	set Rec_Final[Recipe_Max]=RadianceOn
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=MesserschmidtReaver
	set Rec_Comp_2[Recipe_Max]=VitalityBooster
	set Rec_Comp_3[Recipe_Max]=RecipeHeartOfTarrasque
	set Rec_Final[Recipe_Max]=HeartOfTarrasque
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=MesserschmidtReaver
	set Rec_Comp_2[Recipe_Max]=HelmOfTheDominator
	set Rec_Comp_3[Recipe_Max]=RecipeSatanic
	set Rec_Final[Recipe_Max]=Satanic
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=MesserschmidtReaver
	set Rec_Comp_2[Recipe_Max]=HelmOfTheDominatorCourier
	set Rec_Comp_3[Recipe_Max]=RecipeSatanic
	set Rec_Final[Recipe_Max]=Satanic
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=UltimateOrb
	set Rec_Comp_2[Recipe_Max]=UltimateOrb
	set Rec_Comp_3[Recipe_Max]=PointBooster
	set Rec_Comp_4[Recipe_Max]=OrbOfVenom
	set Rec_Final[Recipe_Max]=EyeOfSkadi
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=UltimateOrb
	set Rec_Comp_2[Recipe_Max]=UltimateOrb
	set Rec_Comp_3[Recipe_Max]=PointBooster
	set Rec_Comp_4[Recipe_Max]=OrbOfVenomRanged
	set Rec_Final[Recipe_Max]=EyeOfSkadi
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=RecipeCrimsonGuard
	set Rec_Comp_2[Recipe_Max]=NathrezimBuckler
	set Rec_Comp_3[Recipe_Max]=Vanguard
	set Rec_Final[Recipe_Max]=CrimsonGuard
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=RecipeCrimsonGuard
	set Rec_Comp_2[Recipe_Max]=NathrezimBuckler
	set Rec_Comp_3[Recipe_Max]=VanguardRanged
	set Rec_Final[Recipe_Max]=CrimsonGuard
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Eaglehorn
	set Rec_Comp_2[Recipe_Max]=Quarterstaff
	set Rec_Comp_3[Recipe_Max]=TalismanOfEvasion
	set Rec_Final[Recipe_Max]=Butterfly
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=SobiMask
	set Rec_Comp_2[Recipe_Max]=Chainmail
	set Rec_Comp_3[Recipe_Max]=RecipeMedallion
	set Rec_Final[Recipe_Max]=MedallionOfCourage
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=PointBooster
	set Rec_Comp_2[Recipe_Max]=OgreAxe
	set Rec_Comp_3[Recipe_Max]=BladesOfAlacrity
	set Rec_Comp_4[Recipe_Max]=StaffOfWizardry
	set Rec_Final[Recipe_Max]=AghanimBasic
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Perseverance
	set Rec_Comp_2[Recipe_Max]=Perseverance
	set Rec_Comp_3[Recipe_Max]=RecipeRefresherOrb
	set Rec_Final[Recipe_Max]=RefresherOrb
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=UltimateOrb
	set Rec_Comp_2[Recipe_Max]=MysticStaff
	set Rec_Comp_3[Recipe_Max]=VoidStone
	set Rec_Final[Recipe_Max]=GuinsooHex
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=VitalityBooster
	set Rec_Comp_2[Recipe_Max]=RingOfHealth
	set Rec_Comp_3[Recipe_Max]=StoutShield
	set Rec_Final[Recipe_Max]=Vanguard
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=VitalityBooster
	set Rec_Comp_2[Recipe_Max]=RingOfHealth
	set Rec_Comp_3[Recipe_Max]=StoutShieldRanged
	set Rec_Final[Recipe_Max]=Vanguard
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=EnergyBooster
	set Rec_Comp_2[Recipe_Max]=RingOfProtection
	set Rec_Comp_3[Recipe_Max]=RecipeArcaneRing
	set Rec_Final[Recipe_Max]=ArcaneRing
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Hyperstone
	set Rec_Comp_2[Recipe_Max]=Maelstrom
	set Rec_Comp_3[Recipe_Max]=RecipeMjollnir
	set Rec_Final[Recipe_Max]=Mjollnir
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=AnimalCourier
	set Rec_Comp_3[Recipe_Max]=RecipeFlyingCourier
	set Rec_Final[Recipe_Max]=FlyingCourier
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=HeaddressOfRejuvenation
	set Rec_Comp_2[Recipe_Max]=RingOfBasilius
	set Rec_Comp_3[Recipe_Max]=MaskOfDeath
	set Rec_Comp_4[Recipe_Max]=RecipeVladmirOffering
	set Rec_Final[Recipe_Max]=VladmirsOffering
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=HeaddressOfRejuvenation
	set Rec_Comp_2[Recipe_Max]=RingOfBasiliusHero
	set Rec_Comp_3[Recipe_Max]=MaskOfDeath
	set Rec_Comp_4[Recipe_Max]=RecipeVladmirOffering
	set Rec_Final[Recipe_Max]=VladmirsOffering
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Hyperstone
	set Rec_Comp_2[Recipe_Max]=PlateMail
	set Rec_Comp_3[Recipe_Max]=Chainmail
	set Rec_Comp_4[Recipe_Max]=RecipeAssaultCuirass
	set Rec_Final[Recipe_Max]=AssaultCuirass
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=SoulBooster
	set Rec_Comp_2[Recipe_Max]=RecipeBloodstone
	set Rec_Comp_3[Recipe_Max]=SoulRing
	set Rec_Final[Recipe_Max]=bloodstone
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=RingOfRegeneration
	set Rec_Comp_2[Recipe_Max]=RingOfRegeneration
	set Rec_Comp_3[Recipe_Max]=RingOfHealth
	set Rec_Comp_4[Recipe_Max]=PlaneswalkerCloak
	set Rec_Final[Recipe_Max]=HoodOfDefiance
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=GlovesOfHaste
	set Rec_Comp_2[Recipe_Max]=HelmOfIronWill
	set Rec_Comp_3[Recipe_Max]=BladesOfAttack
	set Rec_Comp_4[Recipe_Max]=RecipeArmlet
	set Rec_Final[Recipe_Max]=ArmletOffCourier
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=MysticStaff
	set Rec_Comp_2[Recipe_Max]=PlateMail
	set Rec_Comp_3[Recipe_Max]=RecipeShivasGuard
	set Rec_Final[Recipe_Max]=ShivasGuard
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=OblivionStaff
	set Rec_Comp_2[Recipe_Max]=OblivionStaff
	set Rec_Comp_3[Recipe_Max]=RecipeOrchid
	set Rec_Final[Recipe_Max]=Orchid
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=BootsOfSpeed
	set Rec_Comp_2[Recipe_Max]=BladesOfAttack
	set Rec_Comp_3[Recipe_Max]=BladesOfAttack
	set Rec_Final[Recipe_Max]=PhaseBoots
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=MagicStick
	set Rec_Comp_2[Recipe_Max]=IronwoodBranch
	set Rec_Comp_3[Recipe_Max]=IronwoodBranch
	set Rec_Comp_4[Recipe_Max]=CircletOfNobility
	set Rec_Final[Recipe_Max]=MagicWand
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=RingOfRegeneration
	set Rec_Comp_2[Recipe_Max]=StaffOfWizardry
	set Rec_Comp_3[Recipe_Max]=RecipeForceStaff
	set Rec_Final[Recipe_Max]=ForceStaff
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=HoodOfDefiance
	set Rec_Comp_2[Recipe_Max]=HeaddressOfRejuvenation
	set Rec_Comp_3[Recipe_Max]=RecipePipe
	set Rec_Final[Recipe_Max]=Pipe
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=StoutShield
	set Rec_Comp_2[Recipe_Max]=SlippersOfAgility
	set Rec_Comp_3[Recipe_Max]=SlippersOfAgility
	set Rec_Final[Recipe_Max]=PoormansShield
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=StoutShieldRanged
	set Rec_Comp_2[Recipe_Max]=SlippersOfAgility
	set Rec_Comp_3[Recipe_Max]=SlippersOfAgility
	set Rec_Final[Recipe_Max]=PoormansShield
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=SobiMask
	set Rec_Comp_2[Recipe_Max]=GauntletOfStrength
	set Rec_Comp_3[Recipe_Max]=GauntletOfStrength
	set Rec_Comp_4[Recipe_Max]=RecipeUrnOfShadows
	set Rec_Final[Recipe_Max]=UrnOfShadows
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=SobiMask
	set Rec_Comp_2[Recipe_Max]=RingOfRegeneration
	set Rec_Comp_3[Recipe_Max]=RecipeSoulRing
	set Rec_Final[Recipe_Max]=SoulRing
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Eaglehorn
	set Rec_Comp_2[Recipe_Max]=GhostScepter
	set Rec_Final[Recipe_Max]=EtherealBlade
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=BootsOfSpeed
	set Rec_Comp_2[Recipe_Max]=EnergyBooster
	set Rec_Final[Recipe_Max]=ArcaneBoots
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=RobeOfMagi
	set Rec_Comp_2[Recipe_Max]=Bracer
	set Rec_Comp_3[Recipe_Max]=RecipeJanggo
	set Rec_Final[Recipe_Max]=janggo
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=janggo
	set Rec_Comp_2[Recipe_Max]=RecipeJanggo
	set Rec_Final[Recipe_Max]=janggo
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=janggoempty
	set Rec_Comp_2[Recipe_Max]=RecipeJanggo
	set Rec_Final[Recipe_Max]=janggo
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=HelmOfIronWill
	set Rec_Comp_2[Recipe_Max]=NullTalisman
	set Rec_Comp_3[Recipe_Max]=RecipeVeilOfDiscord
	set Rec_Final[Recipe_Max]=VeilOfDiscord
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=BootsOfSpeed
	set Rec_Comp_2[Recipe_Max]=RingOfProtection
	set Rec_Comp_3[Recipe_Max]=RingOfRegeneration
	set Rec_Final[Recipe_Max]=TranquilBoots
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=StaffOfWizardry
	set Rec_Comp_2[Recipe_Max]=StaffOfWizardry
	set Rec_Comp_3[Recipe_Max]=VitalityBooster
	set Rec_Final[Recipe_Max]=RodOfAtos
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=Sange
	set Rec_Comp_2[Recipe_Max]=TalismanOfEvasion
	set Rec_Final[Recipe_Max]=HeavensHalberd
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=CraniumBasher
	set Rec_Comp_2[Recipe_Max]=SacredRelic
	set Rec_Final[Recipe_Max]=AbyssalBlade
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=WraithBand
	set Rec_Comp_2[Recipe_Max]=RingOfBasilius
	set Rec_Final[Recipe_Max]=RingOfAquila
	set Recipe_Max=Recipe_Max+1
	set Rec_Comp_1[Recipe_Max]=WraithBand
	set Rec_Comp_2[Recipe_Max]=RingOfBasiliusHero
	set Rec_Final[Recipe_Max]=RingOfAquilaHero
endfunction

function InitAllCooldownsTable takes nothing returns nothing
	//if LoadBoolean(SPELLID, 0) is true then you should use value from level 1 for any other level
	//if LoadBoolean(SPELLID, 1) is true then it's ultimate which triggers scoreboard values
	//
	
	call SaveReal(CooldownStorage,-'QB02',1,13)//QB02 -> Waveform
	call SaveBoolean(CooldownStorage,-'QB02',0,true)//QB02 -> Waveform
	call SaveReal(CooldownStorage,-'A0FN',1,11)//A0FN -> Waveform
	call SaveBoolean(CooldownStorage,-'A0FN',0,true)//A0FN -> Waveform
	call SaveReal(CooldownStorage,-'QB0E',1,9)//QB0E -> Light Strike Array
	call SaveBoolean(CooldownStorage,-'QB0E',0,true)//QB0E -> Light Strike Array
	call SaveReal(CooldownStorage,-'QB0P',1,10)//QB0P -> Overpower
	call SaveBoolean(CooldownStorage,-'QB0P',0,true)//QB0P -> Overpower
	call SaveReal(CooldownStorage,-'A1N4',1,10)//A1N4 -> Overpower
	call SaveBoolean(CooldownStorage,-'A1N4',0,true)//A1N4 -> Overpower
	call SaveReal(CooldownStorage,-'QB0J',1,8)//QB0J -> Fireblast
	call SaveBoolean(CooldownStorage,-'QB0J',0,true)//QB0J -> Fireblast
	call SaveReal(CooldownStorage,-'A2KQ',1,6)//A2KQ -> Unrefined Fireblast
	call SaveBoolean(CooldownStorage,-'A2KQ',0,true)
	call SaveReal(CooldownStorage,-'A04W',1,6)//A04W -> Fireblast
	call SaveBoolean(CooldownStorage,-'A04W',0,true)//A04W -> Fireblast
	call SaveReal(CooldownStorage,-'QB0G',1,12)//QB0G -> Dragon Tail
	call SaveReal(CooldownStorage,-'QB0G',2,11)//QB0G -> Dragon Tail
	call SaveReal(CooldownStorage,-'QB0G',3,10)//QB0G -> Dragon Tail
	call SaveReal(CooldownStorage,-'QB0G',4,9)//QB0G -> Dragon Tail
	call SaveReal(CooldownStorage,-'A0AR',1,12)//A0AR -> Dragon Tail
	call SaveReal(CooldownStorage,-'A0AR',2,11)//A0AR -> Dragon Tail
	call SaveReal(CooldownStorage,-'A0AR',3,10)//A0AR -> Dragon Tail
	call SaveReal(CooldownStorage,-'A0AR',4,9)//A0AR -> Dragon Tail
	call SaveReal(CooldownStorage,-'QB0L',1,30)//QB0L -> Sleight of Fist
	call SaveReal(CooldownStorage,-'QB0L',2,24)//QB0L -> Sleight of Fist
	call SaveReal(CooldownStorage,-'QB0L',3,16)//QB0L -> Sleight of Fist
	call SaveReal(CooldownStorage,-'QB0L',4,8)//QB0L -> Sleight of Fist
	call SaveReal(CooldownStorage,-'A2H0',1,30)//A2H0 -> Sleight of Fist
	call SaveReal(CooldownStorage,-'A2H0',2,22)//A2H0 -> Sleight of Fist
	call SaveReal(CooldownStorage,-'A2H0',3,14)//A2H0 -> Sleight of Fist
	call SaveReal(CooldownStorage,-'A2H0',4,6)//A2H0 -> Sleight of Fist
	call SaveReal(CooldownStorage,-'QB0H',1,10)//QB0H -> Hellfire Blast
	call SaveBoolean(CooldownStorage,-'QB0H',0,true)//QB0H -> Hellfire Blast
	call SaveReal(CooldownStorage,-'AHtb',1,8)//AHtb -> Hellfire Blast
	call SaveBoolean(CooldownStorage,-'AHtb',0,true)//AHtb -> Hellfire Blast
	call SaveReal(CooldownStorage,-'QB0I',1,10)//QB0I -> Slithereen Crush
	call SaveBoolean(CooldownStorage,-'QB0I',0,true)//QB0I -> Slithereen Crush
	call SaveReal(CooldownStorage,-'A29K',1,8)//A29K -> Slithereen Crush
	call SaveBoolean(CooldownStorage,-'A29K',0,true)//A29K -> Slithereen Crush
	call SaveBoolean(CooldownStorage,-'QB0C',1,true)//QB0C -> Amplify Damage
	call SaveReal(CooldownStorage,-'QB0C',1,5)//QB0C -> Amplify Damage
	call SaveBoolean(CooldownStorage,-'QB0C',0,true)//QB0C -> Amplify Damage
	call SaveBoolean(CooldownStorage,-'A034',1,true)//A034 -> Amplify Damage
	call SaveReal(CooldownStorage,-'A034',1,5)//A034 -> Amplify Damage
	call SaveBoolean(CooldownStorage,-'A034',0,true)//A034 -> Amplify Damage
	call SaveReal(CooldownStorage,-'QB0A',1,20)//QB0A -> Skeleton Walk Balance
	call SaveBoolean(CooldownStorage,-'QB0A',0,true)//QB0A -> Skeleton Walk Balance
	call SaveReal(CooldownStorage,-'A025',1,20)//A025 -> Skeleton Walk
	call SaveBoolean(CooldownStorage,-'A025',0,true)//A025 -> Skeleton Walk
	call SaveReal(CooldownStorage,-'QB0F',1,11)//QB0F -> Split Earth
	call SaveBoolean(CooldownStorage,-'QB0F',0,true)//QB0F -> Split Earth
	call SaveReal(CooldownStorage,-'Z397',1,9)//Z397 -> Split Earth
	call SaveBoolean(CooldownStorage,-'Z397',0,true)//Z397 -> Split Earth
	call SaveReal(CooldownStorage,-'QB06',1,6)//QB06 -> Carrion Swarm
	call SaveBoolean(CooldownStorage,-'QB06',0,true)//QB06 -> Carrion Swarm
	call SaveReal(CooldownStorage,-'A078',1,4)//A078 -> Carrion Swarm
	call SaveBoolean(CooldownStorage,-'A078',0,true)//A078 -> Carrion Swarm
	call SaveReal(CooldownStorage,-'QB00',1,12)//QB00 -> Chaos Bolt
	call SaveBoolean(CooldownStorage,-'QB00',0,true)//QB00 -> Chaos Bolt
	call SaveReal(CooldownStorage,-'A055',1,12)//A055 -> Chaos Bolt
	call SaveBoolean(CooldownStorage,-'A055',0,true)//A055 -> Chaos Bolt
	call SaveReal(CooldownStorage,-'A2SG',1,2.25)//A2SG -> Purifying Flames
	call SaveBoolean(CooldownStorage,-'A2SG',0,true)//A2SG -> Purifying Flames
	call SaveBoolean(CooldownStorage,-'QB11',1,true)//QB11 -> False Promise
	call SaveReal(CooldownStorage,-'QB11',1,40)//QB11 -> False Promise
	call SaveReal(CooldownStorage,-'QB11',2,35)//QB11 -> False Promise
	call SaveReal(CooldownStorage,-'QB11',3,30)//QB11 -> False Promise
	call SaveBoolean(CooldownStorage,-'A2TF',1,true)//A2TF -> False Promise
	call SaveReal(CooldownStorage,-'A2TF',1,40)//A2TF -> False Promise
	call SaveBoolean(CooldownStorage,-'A2TF',0,true)//A2TF -> False Promise
	
	call SaveReal(CooldownStorage,-'A02A',1,10)//A02A -> Magic Missile
	call SaveBoolean(CooldownStorage,-'A02A',0,true)//A02A -> Magic Missile
	call SaveReal(CooldownStorage,-'A17O',1,12)//A17O -> Wave of Terror
	call SaveBoolean(CooldownStorage,-'A17O',0,true)//A17O -> Wave of Terror
	call SaveBoolean(CooldownStorage,-'A0IN',1,true)//A0IN -> Nether Swap
	call SaveReal(CooldownStorage,-'A0IN',1,45)//A0IN -> Nether Swap
	call SaveBoolean(CooldownStorage,-'A0IN',0,true)//A0IN -> Nether Swap
	call SaveBoolean(CooldownStorage,-'A1AW',1,true)//A1AW -> Nether Swap upgrade
	call SaveReal(CooldownStorage,-'A1AW',1,10)//A1AW -> Nether Swap upgrade
	call SaveBoolean(CooldownStorage,-'A1AW',0,true)//A1AW -> Nether Swap upgrade
	call SaveReal(CooldownStorage,-'A020',1,1.75)//A020 -> Arc Lightning
	call SaveBoolean(CooldownStorage,-'A020',0,true)//A020 -> Arc Lightning
	call SaveReal(CooldownStorage,-'A0JC',1,6)//A0JC -> Lightning Bolt
	call SaveBoolean(CooldownStorage,-'A0JC',0,true)//A0JC -> Lightning Bolt
	call SaveBoolean(CooldownStorage,-'A29G',1,true)//A29G -> Thundergod's Wrath
	call SaveReal(CooldownStorage,-'A29G',1,90)//A29G -> Thundergod's Wrath
	call SaveBoolean(CooldownStorage,-'A29G',0,true)//A29G -> Thundergod's Wrath
	call SaveBoolean(CooldownStorage,-'A29H',1,true)//A29H -> Thundergod's Wrath
	call SaveReal(CooldownStorage,-'A29H',1,90)//A29H -> Thundergod's Wrath
	call SaveBoolean(CooldownStorage,-'A29H',0,true)//A29H -> Thundergod's Wrath
	call SaveReal(CooldownStorage,-'A0DX',1,30)//A0DX -> Enchant
	call SaveReal(CooldownStorage,-'A0DX',2,25)//A0DX -> Enchant
	call SaveReal(CooldownStorage,-'A0DX',3,20)//A0DX -> Enchant
	call SaveReal(CooldownStorage,-'A0DX',4,15)//A0DX -> Enchant
	call SaveReal(CooldownStorage,-'A01B',1,35)//A01B -> Nature's Attendants
	call SaveBoolean(CooldownStorage,-'A01B',0,true)//A01B -> Nature's Attendants
	call SaveReal(CooldownStorage,-'A0G6',1,10)//A0G6 -> Adaptive Strike
	call SaveBoolean(CooldownStorage,-'A0G6',0,true)//A0G6 -> Adaptive Strike
	call SaveReal(CooldownStorage,-'A0KX',1,1)//A0KX -> Morph
	call SaveReal(CooldownStorage,-'A0KX',2,1)//A0KX -> Morph
	call SaveReal(CooldownStorage,-'A0KX',3,.75)//A0KX -> Morph
	call SaveReal(CooldownStorage,-'A0KX',4,.5)//A0KX -> Morph
	call SaveBoolean(CooldownStorage,-'A0G8',1,true)//A0G8 -> Replicate
	call SaveReal(CooldownStorage,-'A0G8',1,80)//A0G8 -> Replicate
	call SaveBoolean(CooldownStorage,-'A0G8',0,true)//A0G8 -> Replicate
	call SaveReal(CooldownStorage,-'A1E9',1,10)//A1E9 -> Crystal Nova
	call SaveBoolean(CooldownStorage,-'A1E9',0,true)//A1E9 -> Crystal Nova
	call SaveReal(CooldownStorage,-'A04C',1,12)//A04C -> Frostbite
	call SaveBoolean(CooldownStorage,-'A04C',0,true)
	call SaveBoolean(CooldownStorage,-'A03R',1,true)//A03R -> Freezing Field
	call SaveReal(CooldownStorage,-'A03R',1,100)//A03R -> Freezing Field
	call SaveReal(CooldownStorage,-'A03R',2,100)//A03R -> Freezing Field
	call SaveReal(CooldownStorage,-'A03R',3,100)//A03R -> Freezing Field
	call SaveBoolean(CooldownStorage,-'A0AV',1,true)//A0AV -> Freezing Field
	call SaveReal(CooldownStorage,-'A0AV',1,100)//A0AV -> Freezing Field
	call SaveReal(CooldownStorage,-'A0AV',2,100)//A0AV -> Freezing Field
	call SaveReal(CooldownStorage,-'A0AV',3,100)//A0AV -> Freezing Field
	call SaveReal(CooldownStorage,-'A190',1,13)//A190 -> Storm Bolt
	call SaveBoolean(CooldownStorage,-'A190',0,true)//A190 -> Storm Bolt
	call SaveReal(CooldownStorage,-'A2IS',1,32)//A2IS -> Warcry
	call SaveReal(CooldownStorage,-'A2IS',2,26)//A2IS -> Warcry
	call SaveReal(CooldownStorage,-'A2IS',3,20)//A2IS -> Warcry
	call SaveReal(CooldownStorage,-'A2IS',4,14)//A2IS -> Warcry
	call SaveBoolean(CooldownStorage,-'A0WP',1,true)//A0WP -> God's Strength
	call SaveReal(CooldownStorage,-'A0WP',1,80)//A0WP -> God's Strength
	call SaveBoolean(CooldownStorage,-'A0WP',0,true)//A0WP -> God's Strength
	call SaveBoolean(CooldownStorage,-'A43D',1,true)//A43D -> God's Strength Agh
	call SaveReal(CooldownStorage,-'A43D',1,80)//A43D -> God's Strength Agh
	call SaveBoolean(CooldownStorage,-'A43D',0,true)//A43D -> God's Strength Agh
	call SaveReal(CooldownStorage,-'A063',1,40)//A063 -> Mirror Image
	call SaveBoolean(CooldownStorage,-'A063',0,true)//A063 -> Mirror Image
	call SaveReal(CooldownStorage,-'A24D',1,14)//A24D -> Ensnare
	call SaveBoolean(CooldownStorage,-'A24D',0,true)//A24D -> Ensnare
	call SaveReal(CooldownStorage,-'A2KU',1,10)//A2KU -> Rip Tide
	call SaveBoolean(CooldownStorage,-'A2KU',0,true)//A2KU -> Rip Tide
	call SaveBoolean(CooldownStorage,-'A07U',1,true)//A07U -> Song of the Siren
	call SaveReal(CooldownStorage,-'A07U',1,180)//A07U -> Song of the Siren
	call SaveReal(CooldownStorage,-'A07U',2,120)//A07U -> Song of the Siren
	call SaveReal(CooldownStorage,-'A07U',3,60)//A07U -> Song of the Siren
	call SaveBoolean(CooldownStorage,-'A38E',1,true)//A38E -> Song of the Siren
	call SaveReal(CooldownStorage,-'A38E',1,180)//A38E -> Song of the Siren
	call SaveReal(CooldownStorage,-'A38E',2,120)//A38E -> Song of the Siren
	call SaveReal(CooldownStorage,-'A38E',3,60)//A38E -> Song of the Siren
	call SaveReal(CooldownStorage,-'A0SK',1,15)//A0SK -> Fissure
	call SaveBoolean(CooldownStorage,-'A0SK',0,true)//A0SK -> Fissure
	call SaveReal(CooldownStorage,-'A0DL',1,5)//A0DL -> Enchant Totem
	call SaveBoolean(CooldownStorage,-'A0DL',0,true)//A0DL -> Enchant Totem
	call SaveBoolean(CooldownStorage,-'A0DH',1,true)//A0DH -> Echo Slam
	call SaveReal(CooldownStorage,-'A0DH',1,110)//A0DH -> Echo Slam
	call SaveBoolean(CooldownStorage,-'A0DH',0,true)//A0DH -> Echo Slam
	call SaveBoolean(CooldownStorage,-'A1OB',1,true)//A1OB -> Echo Slam
	call SaveReal(CooldownStorage,-'A1OB',1,110)//A1OB -> Echo Slam
	call SaveBoolean(CooldownStorage,-'A1OB',0,true)//A1OB -> Echo Slam
	call SaveReal(CooldownStorage,-'A0RG',1,11)//A0RG -> Smoke Screen
	call SaveBoolean(CooldownStorage,-'A0RG',0,true)//A0RG -> Smoke Screen
	call SaveBoolean(CooldownStorage,-'A0K9',1,true)//A0K9 -> Blink Strike
	call SaveBoolean(CooldownStorage,-'A0A5',0,true)//A0RG -> Smoke Screen
	call SaveReal(CooldownStorage,-'A0A5',1,100)//A0A5 -> Summon Spirit Bear
	call SaveReal(CooldownStorage,-'A1EG',1,30)//A1EG -> Rabid
	call SaveBoolean(CooldownStorage,-'A1EG',0,true)//A1EG -> Rabid
	call SaveBoolean(CooldownStorage,-'A0AG',1,true)//A0AG -> True Form
	call SaveReal(CooldownStorage,-'A01F',1,8.5)//A01F -> Dragon Slave
	call SaveBoolean(CooldownStorage,-'A01F',0,true)//A01F -> Dragon Slave
	call SaveBoolean(CooldownStorage,-'A01P',1,true)//A01P -> Laguna Blade
	call SaveReal(CooldownStorage,-'A01P',1,70)//A01P -> Laguna Blade
	call SaveReal(CooldownStorage,-'A01P',2,60)//A01P -> Laguna Blade
	call SaveReal(CooldownStorage,-'A01P',3,50)//A01P -> Laguna Blade
	call SaveReal(CooldownStorage,-'A01P',4,9)//A01P -> Laguna Blade
	call SaveBoolean(CooldownStorage,-'A09Z',1,true)//A09Z -> Laguna Blade
	call SaveReal(CooldownStorage,-'A09Z',1,70)//A09Z -> Laguna Blade
	call SaveReal(CooldownStorage,-'A09Z',2,60)//A09Z -> Laguna Blade
	call SaveReal(CooldownStorage,-'A09Z',3,50)//A09Z -> Laguna Blade
	call SaveReal(CooldownStorage,-'A05G',1,30)//A05G -> Blade Fury
	call SaveReal(CooldownStorage,-'A05G',2,26)//A05G -> Blade Fury
	call SaveReal(CooldownStorage,-'A05G',3,22)//A05G -> Blade Fury
	call SaveReal(CooldownStorage,-'A05G',4,18)//A05G -> Blade Fury
	call SaveReal(CooldownStorage,-'A047',1,60)//A047 -> Healing Ward
	call SaveBoolean(CooldownStorage,-'A047',0,true)//A047 -> Healing Ward
	call SaveBoolean(CooldownStorage,-'A0M1',1,true)//A0M1 -> Omnislash
	call SaveReal(CooldownStorage,-'A0M1',1,130)//A0M1 -> Omnislash
	call SaveReal(CooldownStorage,-'A0M1',2,120)//A0M1 -> Omnislash
	call SaveReal(CooldownStorage,-'A0M1',3,110)//A0M1 -> Omnislash
	call SaveBoolean(CooldownStorage,-'A1AX',1,true)//A1AX -> Omnislash upgrade
	call SaveReal(CooldownStorage,-'A1AX',1,70)//A1AX -> Omnislash upgrade
	call SaveBoolean(CooldownStorage,-'A1AX',0,true)//A1AX -> Omnislash upgrade
	call SaveReal(CooldownStorage,-'A14L',1,20)//A14L -> Curse of the Silent
	call SaveReal(CooldownStorage,-'A14L',2,16)//A14L -> Curse of the Silent
	call SaveReal(CooldownStorage,-'A14L',3,12)//A14L -> Curse of the Silent
	call SaveReal(CooldownStorage,-'A14L',4,8)//A14L -> Curse of the Silent
	call SaveReal(CooldownStorage,-'A2NT',1,36)//A2NT -> Last Word
	call SaveReal(CooldownStorage,-'A2NT',2,28)//A2NT -> Last Word
	call SaveReal(CooldownStorage,-'A2NT',3,20)//A2NT -> Last Word
	call SaveReal(CooldownStorage,-'A2NT',4,12)//A2NT -> Last Word
	call SaveBoolean(CooldownStorage,-'A0L3',1,true)//A0L3 -> Global Silence
	call SaveReal(CooldownStorage,-'A0L3',1,130)//A0L3 -> Global Silence
	call SaveBoolean(CooldownStorage,-'A0L3',0,true)//A0L3 -> Global Silence
	call SaveBoolean(CooldownStorage,-'A2QC',1,true)//A2QC -> Global Silence
	call SaveReal(CooldownStorage,-'A2QC',1,130)//A2QC -> Global Silence
	call SaveBoolean(CooldownStorage,-'A2QC',0,true)//A2QC -> Global Silence
	call SaveReal(CooldownStorage,-'A01Z',1,10)//A01Z -> Nature's Guise
	call SaveReal(CooldownStorage,-'A01Z',2,8)//A01Z -> Nature's Guise
	call SaveReal(CooldownStorage,-'A01Z',3,6)//A01Z -> Nature's Guise
	call SaveReal(CooldownStorage,-'A01Z',4,4)//A01Z -> Nature's Guise
	call SaveReal(CooldownStorage,-'A26N',1,16)//A26N -> Leech Seed
	call SaveReal(CooldownStorage,-'A26N',2,14)//A26N -> Leech Seed
	call SaveReal(CooldownStorage,-'A26N',3,12)//A26N -> Leech Seed
	call SaveReal(CooldownStorage,-'A26N',4,10)//A26N -> Leech Seed
	call SaveReal(CooldownStorage,-'A2ML',1,20)//A2ML -> Living Armor
	call SaveReal(CooldownStorage,-'A2ML',2,18)//A2ML -> Living Armor
	call SaveReal(CooldownStorage,-'A2ML',3,16)//A2ML -> Living Armor
	call SaveReal(CooldownStorage,-'A2ML',4,14)//A2ML -> Living Armor
	call SaveBoolean(CooldownStorage,-'A07Z',1,true)//A07Z -> Overgrowth
	call SaveReal(CooldownStorage,-'A07Z',1,70)//A07Z -> Overgrowth
	call SaveBoolean(CooldownStorage,-'A07Z',0,true)//A07Z -> Overgrowth
	call SaveBoolean(CooldownStorage,-'A44S',1,true)//A44S -> Overgrowth Upgrade
	call SaveReal(CooldownStorage,-'A44S',1,70)//A44S -> Overgrowth Upgrade
	call SaveBoolean(CooldownStorage,-'A44S',0,true)//A44S -> Overgrowth Upgrade
	call SaveReal(CooldownStorage,-'A1AA',1,15)//A1AA -> Echo Stomp
	call SaveBoolean(CooldownStorage,-'A1AA',0,true)//A1AA -> Echo Stomp
	call SaveReal(CooldownStorage,-'A1A8',1,16)//A1A8 -> Ancestral Spirit
	call SaveBoolean(CooldownStorage,-'A1A8',0,true)//A1A8 -> Ancestral Spirit
	call SaveBoolean(CooldownStorage,-'A1A1',1,true)//A1A1 -> Earth Splitter
	call SaveReal(CooldownStorage,-'A1A1',1,100)//A1A1 -> Earth Splitter
	call SaveBoolean(CooldownStorage,-'A1A1',0,true)//A1A1 -> Earth Splitter
	call SaveBoolean(CooldownStorage,-'A43J',1,true)//A43J -> Earth Splitter
	call SaveReal(CooldownStorage,-'A43J',1,100)//A43J -> Earth Splitter
	call SaveBoolean(CooldownStorage,-'A43J',0,true)//A43J -> Earth Splitter
	call SaveReal(CooldownStorage,-'A085',1,10)//A085 -> Illuminate
	call SaveBoolean(CooldownStorage,-'A085',0,true)//A085 -> Illuminate
	call SaveReal(CooldownStorage,-'A10X',1,16)//A10X -> Mana Leak
	call SaveReal(CooldownStorage,-'A10X',2,14)//A10X -> Mana Leak
	call SaveReal(CooldownStorage,-'A10X',3,12)//A10X -> Mana Leak
	call SaveReal(CooldownStorage,-'A10X',4,10)//A10X -> Mana Leak
	call SaveReal(CooldownStorage,-'A112',1,19)//A112 -> Chakra Magic
	call SaveReal(CooldownStorage,-'A112',2,18)//A112 -> Chakra Magic
	call SaveReal(CooldownStorage,-'A112',3,17)//A112 -> Chakra Magic
	call SaveReal(CooldownStorage,-'A112',4,16)//A112 -> Chakra Magic
	call SaveBoolean(CooldownStorage,-'QM01',1,true)//QM01 -> Spirit Form
	call SaveReal(CooldownStorage,-'A03Y',1,5)//A03Y -> Earthshock
	call SaveBoolean(CooldownStorage,-'A03Y',0,true)//A03Y -> Earthshock
	call SaveBoolean(CooldownStorage,-'A0LC',1,true)//A0LC -> Enrage
	call SaveReal(CooldownStorage,-'A0LC',1,25)//A0LC -> Enrage
	call SaveBoolean(CooldownStorage,-'A0LC',0,true)//A0LC -> Enrage
	call SaveBoolean(CooldownStorage,-'A443',1,true)//A443 -> Enrage
	call SaveReal(CooldownStorage,-'A443',1,25)//A443 -> Enrage
	call SaveBoolean(CooldownStorage,-'A443',0,true)//A443 -> Enrage
	call SaveReal(CooldownStorage,-'A011',1,13)//A011 -> Ignite
	call SaveBoolean(CooldownStorage,-'A011',0,true)//A011 -> Ignite
	call SaveReal(CooldownStorage,-'A083',1,16)//A083 -> Bloodlust
	call SaveBoolean(CooldownStorage,-'A083',0,true)//A083 -> Bloodlust
	call SaveReal(CooldownStorage,-'A049',1,14)//A049 -> Laser
	call SaveBoolean(CooldownStorage,-'A049',0,true)//A049 -> Laser
	call SaveReal(CooldownStorage,-'A33G',1,14)//A33G -> Laser
	call SaveBoolean(CooldownStorage,-'A33G',0,true)//A33G -> Laser
	call SaveReal(CooldownStorage,-'A05E',1,25)//A05E -> Heat Seeking Missile
	call SaveBoolean(CooldownStorage,-'A05E',0,true)//A05E -> Heat Seeking Missile
	call SaveReal(CooldownStorage,-'A33F',1,25)//A33F -> Heat Seeking Missile
	call SaveBoolean(CooldownStorage,-'A33F',0,true)//A33F -> Heat Seeking Missile
	call SaveReal(CooldownStorage,-'A0BQ',1,25)//A0BQ -> March of the Machines
	call SaveBoolean(CooldownStorage,-'A0BQ',0,true)//A0BQ -> March of the Machines
	call SaveReal(CooldownStorage,-'A21E',1,11)//A21E -> Sprout
	call SaveReal(CooldownStorage,-'A21E',2,10)//A21E -> Sprout
	call SaveReal(CooldownStorage,-'A21E',3,9)//A21E -> Sprout
	call SaveReal(CooldownStorage,-'A21E',4,8)//A21E -> Sprout
	call SaveReal(CooldownStorage,-'A01O',1,50)//A01O -> Teleportation
	call SaveReal(CooldownStorage,-'A01O',2,40)//A01O -> Teleportation
	call SaveReal(CooldownStorage,-'A01O',3,30)//A01O -> Teleportation
	call SaveReal(CooldownStorage,-'A01O',4,20)//A01O -> Teleportation
	call SaveReal(CooldownStorage,-'AEfn',1,37)//AEfn -> Force of Nature
	call SaveBoolean(CooldownStorage,-'AEfn',0,true)//AEfn -> Force of Nature
	call SaveBoolean(CooldownStorage,-'A1W8',1,true)//A1W8 -> Wrath of Nature
	call SaveReal(CooldownStorage,-'A1W8',1,90)//A1W8 -> Wrath of Nature
	call SaveReal(CooldownStorage,-'A1W8',2,75)//A1W8 -> Wrath of Nature
	call SaveReal(CooldownStorage,-'A1W8',3,60)//A1W8 -> Wrath of Nature
	call SaveBoolean(CooldownStorage,-'A1W9',1,true)//A1W9 -> Wrath of Nature upgrade
	call SaveReal(CooldownStorage,-'A1W9',1,90)//A1W9 -> Wrath of Nature upgrade
	call SaveReal(CooldownStorage,-'A1W9',2,75)//A1W9 -> Wrath of Nature upgrade
	call SaveReal(CooldownStorage,-'A1W9',3,60)//A1W9 -> Wrath of Nature upgrade
	call SaveReal(CooldownStorage,-'A10D',1,7)//A10D -> Spirit Lance
	call SaveBoolean(CooldownStorage,-'A10D',0,true)//A10D -> Spirit Lance
	call SaveReal(CooldownStorage,-'A46H',1,25)//A46H -> Doppelganger
	call SaveReal(CooldownStorage,-'A46H',2,20)//A46H -> Doppelganger
	call SaveReal(CooldownStorage,-'A46H',3,15)//A46H -> Doppelganger
	call SaveReal(CooldownStorage,-'A46H',4,10)//A46H -> Doppelganger
	call SaveReal(CooldownStorage,-'A0LL',1,17)//A0LL -> Avalanche
	call SaveBoolean(CooldownStorage,-'A0LL',0,true)//A0LL -> Avalanche
	call SaveReal(CooldownStorage,-'A0BZ',1,9)//A0BZ -> Toss
	call SaveBoolean(CooldownStorage,-'A0BZ',0,true)//A0BZ -> Toss
	call SaveReal(CooldownStorage,-'A05J',1,19)//A05J -> Land Mines
	call SaveReal(CooldownStorage,-'A05J',2,16)//A05J -> Land Mines
	call SaveReal(CooldownStorage,-'A05J',3,14)//A05J -> Land Mines
	call SaveReal(CooldownStorage,-'A05J',4,10)//A05J -> Land Mines
	call SaveReal(CooldownStorage,-'A06H',1,20)//A06H -> Stasis Trap
	call SaveReal(CooldownStorage,-'A06H',2,16)//A06H -> Stasis Trap
	call SaveReal(CooldownStorage,-'A06H',3,13)//A06H -> Stasis Trap
	call SaveReal(CooldownStorage,-'A06H',4,10)//A06H -> Stasis Trap
	call SaveReal(CooldownStorage,-'A06B',1,160)//A06B -> Suicide Squad, Attack!
	call SaveReal(CooldownStorage,-'A06B',2,140)//A06B -> Suicide Squad, Attack!
	call SaveReal(CooldownStorage,-'A06B',3,120)//A06B -> Suicide Squad, Attack!
	call SaveReal(CooldownStorage,-'A06B',4,100)//A06B -> Suicide Squad, Attack!
	call SaveReal(CooldownStorage,-'A471',1,160)//A06B -> Suicide Squad, Attack!
	call SaveReal(CooldownStorage,-'A471',2,140)//A06B -> Suicide Squad, Attack!
	call SaveReal(CooldownStorage,-'A471',3,120)//A06B -> Suicide Squad, Attack!
	call SaveReal(CooldownStorage,-'A471',4,100)//A06B -> Suicide Squad, Attack!
	call SaveBoolean(CooldownStorage,-'A0AK',1,true)//A0AK -> Remote Mines
	call SaveReal(CooldownStorage,-'A0AK',1,10)//A0AK -> Remote Mines
	call SaveBoolean(CooldownStorage,-'A0AK',0,true)//A0AK -> Remote Mines
	call SaveBoolean(CooldownStorage,-'A1FY',1,true)//A1FY -> Remote Mines
	call SaveReal(CooldownStorage,-'A1FY',1,10)//A1FY -> Remote Mines
	call SaveBoolean(CooldownStorage,-'A1FY',0,true)//A1FY -> Remote Mines
	call SaveReal(CooldownStorage,-'A0KM',1,14)//A0KM -> Penitence
	call SaveReal(CooldownStorage,-'A0KM',2,13)//A0KM -> Penitence
	call SaveReal(CooldownStorage,-'A0KM',3,12)//A0KM -> Penitence
	call SaveReal(CooldownStorage,-'A0KM',4,11)//A0KM -> Penitence
	call SaveReal(CooldownStorage,-'A0LV',1,11)//A0LV -> Test of Faith
	call SaveBoolean(CooldownStorage,-'A0LV',0,true)//A0LV -> Test of Faith
	call SaveReal(CooldownStorage,-'A28T',1,30)//A28T -> Holy Persuasion
	call SaveReal(CooldownStorage,-'A28T',2,26)//A28T -> Holy Persuasion
	call SaveReal(CooldownStorage,-'A28T',3,22)//A28T -> Holy Persuasion
	call SaveReal(CooldownStorage,-'A28T',4,18)//A28T -> Holy Persuasion
	call SaveReal(CooldownStorage,-'A361',1,30)//A361 -> Holy Persuasion
	call SaveReal(CooldownStorage,-'A361',2,26)//A361 -> Holy Persuasion
	call SaveReal(CooldownStorage,-'A361',3,22)//A361 -> Holy Persuasion
	call SaveReal(CooldownStorage,-'A361',4,18)//A361 -> Holy Persuasion
	call SaveBoolean(CooldownStorage,-'A0LT',1,true)//A0LT -> Hand of God
	call SaveBoolean(CooldownStorage,-'A0LT',0,true)//A042 -> Lucent Beam
	call SaveReal(CooldownStorage,-'A0LT',1,100)//A0LT -> Hand of God
	call SaveBoolean(CooldownStorage,-'A1CS',1,true)//A1CS -> Hand of God upgraded
	call SaveReal(CooldownStorage,-'A1CS',1,30)//A1CS -> Hand of God upgraded
	call SaveBoolean(CooldownStorage,-'A1CS',0,true)//A1CS -> Hand of God upgraded
	call SaveReal(CooldownStorage,-'A042',1,6)//A042 -> Lucent Beam
	call SaveBoolean(CooldownStorage,-'A042',0,true)//A042 -> Lucent Beam
	call SaveBoolean(CooldownStorage,-'A054',1,true)//A054 -> Eclipse
	call SaveReal(CooldownStorage,-'A054',1,120)//A054 -> Eclipse
	call SaveBoolean(CooldownStorage,-'A054',0,true)//A054 -> Eclipse
	call SaveBoolean(CooldownStorage,-'A00U',1,true)//A00U -> Eclipse
	call SaveReal(CooldownStorage,-'A00U',1,160)//A00U -> Eclipse
	call SaveReal(CooldownStorage,-'A00U',2,150)//A00U -> Eclipse
	call SaveReal(CooldownStorage,-'A00U',3,140)//A00U -> Eclipse
	call SaveBoolean(CooldownStorage,-'A04P',1,true)//A04P -> Assassinate
	call SaveReal(CooldownStorage,-'A04P',1,20)//A04P -> Assassinate
	call SaveReal(CooldownStorage,-'A04P',2,15)//A04P -> Assassinate
	call SaveReal(CooldownStorage,-'A04P',3,10)//A04P -> Assassinate
	call SaveBoolean(CooldownStorage,-'A1AU',1,true)//A1AU -> Assassinate upgrade
	call SaveReal(CooldownStorage,-'A1AU',1,10)//A1AU -> Assassinate upgrade
	call SaveBoolean(CooldownStorage,-'A1AU',0,true)//A1AU -> Assassinate upgrade
	call SaveReal(CooldownStorage,-'A21M',1,15)//A21M -> Whirling Axes
	call SaveReal(CooldownStorage,-'A21M',2,14)//A21M -> Whirling Axes
	call SaveReal(CooldownStorage,-'A21M',3,13)//A21M -> Whirling Axes
	call SaveReal(CooldownStorage,-'A21M',4,12)//A21M -> Whirling Axes
	call SaveReal(CooldownStorage,-'A21N',1,12)//A21N -> Whirling Axes
	call SaveBoolean(CooldownStorage,-'A21N',0,true)//A21N -> Whirling Axes
	call SaveBoolean(CooldownStorage,-'A1EJ',1,true)//A1EJ -> Battle Trance
	call SaveReal(CooldownStorage,-'A1EJ',1,30)//A1EJ -> Battle Trance
	call SaveBoolean(CooldownStorage,-'A1EJ',0,true)//A1EJ -> Battle Trance
	call SaveReal(CooldownStorage,-'A010',1,8)//A010 -> Ether Shock
	call SaveBoolean(CooldownStorage,-'A010',0,true)//A010 -> Ether Shock
	call SaveReal(CooldownStorage,-'A0RX',1,13)//A0RX -> Voodoo
	call SaveBoolean(CooldownStorage,-'A0RX',0,true)//A0RX -> Voodoo
	call SaveReal(CooldownStorage,-'A00P',1,10)//A00P -> Shackles
	call SaveBoolean(CooldownStorage,-'A00P',0,true)//A00P -> Shackles
	call SaveBoolean(CooldownStorage,-'A00H',1,true)//A00H -> Mass Serpent Ward
	call SaveReal(CooldownStorage,-'A00H',1,110)//A00H -> Mass Serpent Ward
	call SaveBoolean(CooldownStorage,-'A00H',0,true)//A00H -> Mass Serpent Ward
	call SaveBoolean(CooldownStorage,-'A0A1',1,true)//A0A1 -> Mass Serpent Ward
	call SaveReal(CooldownStorage,-'A0A1',1,110)//A0A1 -> Mass Serpent Ward
	call SaveBoolean(CooldownStorage,-'A0A1',0,true)//A0A1 -> Mass Serpent Ward
	call SaveReal(CooldownStorage,-'A1T8',1,20)//A1T8 -> Spirits
	call SaveReal(CooldownStorage,-'A1T8',2,18)//A1T8 -> Spirits
	call SaveReal(CooldownStorage,-'A1T8',3,16)//A1T8 -> Spirits
	call SaveReal(CooldownStorage,-'A1T8',4,14)//A1T8 -> Spirits
	call SaveBoolean(CooldownStorage,-'A1TB',1,true)//A1TB -> Relocate
	call SaveReal(CooldownStorage,-'A1TB',1,90)//A1TB -> Relocate
	call SaveReal(CooldownStorage,-'A1TB',2,75)//A1TB -> Relocate
	call SaveReal(CooldownStorage,-'A1TB',3,60)//A1TB -> Relocate
	call SaveBoolean(CooldownStorage,-'A3FQ',0,true)//A1TB -> Relocate
	call SaveBoolean(CooldownStorage,-'A3FQ',1,true)//A1TB -> Relocate
	call SaveReal(CooldownStorage,-'A3FQ',1,30)//A1TB -> Relocate
	call SaveReal(CooldownStorage,-'A06M',1,12)//A06M -> Thunder Clap
	call SaveBoolean(CooldownStorage,-'A06M',0,true)//A06M -> Thunder Clap
	call SaveReal(CooldownStorage,-'Acdh',1,8)//Acdh -> Drunken Haze
	call SaveBoolean(CooldownStorage,-'Acdh',0,true)//Acdh -> Drunken Haze
	call SaveBoolean(CooldownStorage,-'A0MQ',1,true)//A0MQ -> Primal Split
	call SaveReal(CooldownStorage,-'A0MQ',1,180)//A0MQ -> Primal Split
	call SaveReal(CooldownStorage,-'A0MQ',2,160)//A0MQ -> Primal Split
	call SaveReal(CooldownStorage,-'A0MQ',3,140)//A0MQ -> Primal Split
	call SaveReal(CooldownStorage,-'A0MQ',4,180)//A0MQ -> Primal Split
	call SaveBoolean(CooldownStorage,-'A1B6',1,true)//A1B6 -> Primal Split upgrade
	call SaveReal(CooldownStorage,-'A1B6',1,180)//A1B6 -> Primal Split upgrade
	call SaveReal(CooldownStorage,-'A1B6',2,160)//A1B6 -> Primal Split upgrade
	call SaveReal(CooldownStorage,-'A1B6',3,140)//A1B6 -> Primal Split upgrade
	call SaveReal(CooldownStorage,-'A1B6',4,180)//A1B6 -> Primal Split upgrade
	call SaveReal(CooldownStorage,-'A00S',1,13)//A00S -> Hoof Stomp
	call SaveBoolean(CooldownStorage,-'A00S',0,true)//A00S -> Hoof Stomp
	call SaveReal(CooldownStorage,-'A00L',1,8)//A00L -> Double Edge
	call SaveBoolean(CooldownStorage,-'A00L',0,true)//A00L -> Double Edge
	call SaveBoolean(CooldownStorage,-'A2O6',1,true)//A2O6 -> Stampede
	call SaveReal(CooldownStorage,-'A2O6',1,50)//A2O6 -> Stampede
	call SaveBoolean(CooldownStorage,-'A2O6',0,true)//A2O6 -> Stampede
	call SaveBoolean(CooldownStorage,-'A384',1,true)//A384 -> Stampede
	call SaveReal(CooldownStorage,-'A384',1,50)//A384 -> Stampede
	call SaveBoolean(CooldownStorage,-'A384',0,true)//A384 -> Stampede
	call SaveReal(CooldownStorage,-'A004',1,10)//A004 -> Shuriken Toss
	call SaveBoolean(CooldownStorage,-'A004',0,true)//A004 -> Shuriken Toss
	call SaveReal(CooldownStorage,-'A07A',1,15)//A07A -> Wind Walk
	call SaveBoolean(CooldownStorage,-'A07A',0,true)//A07A -> Wind Walk
	call SaveBoolean(CooldownStorage,-'A0B4',1,true)//A0B4 -> Track
	call SaveReal(CooldownStorage,-'A0B4',1,4)//A0B4 -> Track
	call SaveBoolean(CooldownStorage,-'A0B4',0,true)//A0B4 -> Track
	call SaveReal(CooldownStorage,-'A03F',1,9)//A03F -> Breathe Fire
	call SaveBoolean(CooldownStorage,-'A03F',0,true)//A03F -> Breathe Fire
	call SaveBoolean(CooldownStorage,-'QM00',1,true)//QM00 -> Elder Dragon Form
	call SaveReal(CooldownStorage,-'QM00',1,115)//QM00 -> Elder Dragon Form
	call SaveBoolean(CooldownStorage,-'QM00',0,true)//QM00 -> Elder Dragon Form
	call SaveReal(CooldownStorage,-'AEbl',1,14)//AEbl -> Blink
	call SaveReal(CooldownStorage,-'AEbl',2,12)//AEbl -> Blink
	call SaveReal(CooldownStorage,-'AEbl',3,10)//AEbl -> Blink
	call SaveReal(CooldownStorage,-'AEbl',4,8)//AEbl -> Blink
	call SaveBoolean(CooldownStorage,-'A0E3',1,true)//A0E3 -> Mana Void
	call SaveReal(CooldownStorage,-'A0E3',1,70)//A0E3 -> Mana Void
	call SaveBoolean(CooldownStorage,-'A0E3',0,true)//A0E3 -> Mana Void
	call SaveReal(CooldownStorage,-'A33A',1,13)//A33A -> Gust
	call SaveBoolean(CooldownStorage,-'A33A',0,true)//A33A -> Gust
	call SaveReal(CooldownStorage,-'A2O2',1,100)//A2O2 -> Trueshot Aura
	call SaveBoolean(CooldownStorage,-'A2O2',0,true)//A2O2 -> Trueshot Aura
	call SaveBoolean(CooldownStorage,-'QF89',1,true)
	call SaveReal(CooldownStorage,-'QF89',1,40)
	call SaveBoolean(CooldownStorage,-'QF89',0,true)
	call SaveReal(CooldownStorage,-'A08N',1,10)//A08N -> Purification
	call SaveBoolean(CooldownStorage,-'A08N',0,true)//A08N -> Purification
	call SaveReal(CooldownStorage,-'A08V',1,14)//A08V -> Repel
	call SaveBoolean(CooldownStorage,-'A08V',0,true)//A08V -> Repel
	call SaveBoolean(CooldownStorage,-'A0ER',1,true)//A0ER -> Guardian Angel
	call SaveReal(CooldownStorage,-'A0ER',1,100)//A0ER -> Guardian Angel
	call SaveBoolean(CooldownStorage,-'A0ER',0,true)//A0ER -> Guardian Angel
	call SaveBoolean(CooldownStorage,-'A2S8',1,true)//A2S8 -> Guardian Angel
	call SaveReal(CooldownStorage,-'A2S8',1,100)//A2S8 -> Guardian Angel
	call SaveBoolean(CooldownStorage,-'A2S8',0,true)//A2S8 -> Guardian Angel
	call SaveReal(CooldownStorage,-'A0O1',1,13)//A0O1 -> Wild Axes
	call SaveBoolean(CooldownStorage,-'A0O1',0,true)//A0O1 -> Wild Axes
	call SaveBoolean(CooldownStorage,-'A0O2',1,true)//A0O2 -> Primal Roar
	call SaveReal(CooldownStorage,-'A0O2',1,80)//A0O2 -> Primal Roar
	call SaveReal(CooldownStorage,-'A0O2',2,75)//A0O2 -> Primal Roar
	call SaveReal(CooldownStorage,-'A0O2',3,70)//A0O2 -> Primal Roar
	call SaveReal(CooldownStorage,-'A0O2',4,9)//A0O2 -> Primal Roar
	call SaveBoolean(CooldownStorage,-'A289',1,true)//A289 -> Primal Roar
	call SaveReal(CooldownStorage,-'A289',1,45)//A289 -> Primal Roar
	call SaveBoolean(CooldownStorage,-'A289',0,true)//A289 -> Primal Roar
	call SaveReal(CooldownStorage,-'A0O7',1,10)//A0O7 -> Dual Breath
	call SaveBoolean(CooldownStorage,-'A0O7',0,true)//A0O7 -> Dual Breath
	call SaveReal(CooldownStorage,-'A0O6',1,12)//A0O6 -> Ice Path
	call SaveReal(CooldownStorage,-'A0O6',2,11)//A0O6 -> Ice Path
	call SaveReal(CooldownStorage,-'A0O6',3,10)//A0O6 -> Ice Path
	call SaveReal(CooldownStorage,-'A0O6',4,9)//A0O6 -> Ice Path
	call SaveReal(CooldownStorage,-'A30T',1,13)//A30T -> Liquid Fire
	call SaveReal(CooldownStorage,-'A30T',2,10)//A30T -> Liquid Fire
	call SaveReal(CooldownStorage,-'A30T',3,7)//A30T -> Liquid Fire
	call SaveReal(CooldownStorage,-'A30T',4,4)//A30T -> Liquid Fire
	call SaveBoolean(CooldownStorage,-'A0O5',1,true)//A0O5 -> Macropyre
	call SaveReal(CooldownStorage,-'A0O5',1,60)//A0O5 -> Macropyre
	call SaveBoolean(CooldownStorage,-'A0O5',0,true)//A0O5 -> Macropyre
	call SaveBoolean(CooldownStorage,-'A1B1',1,true)//A1B1 -> Macropyre upgrade
	call SaveReal(CooldownStorage,-'A1B1',1,60)//A1B1 -> Macropyre upgrade
	call SaveBoolean(CooldownStorage,-'A1B1',0,true)//A1B1 -> Macropyre upgrade
	call SaveReal(CooldownStorage,-'A0IL',1,22)//A0IL -> Acid Spray
	call SaveBoolean(CooldownStorage,-'A0IL',0,true)//A0IL -> Acid Spray
	call SaveReal(CooldownStorage,-'A1NI',1,16)//A1NI -> Unstable Concoction
	call SaveBoolean(CooldownStorage,-'A1NI',0,true)//A1NI -> Unstable Concoction
	call SaveBoolean(CooldownStorage,-'QB0K',1,true)//QB0K -> Chemical Rage
	call SaveReal(CooldownStorage,-'QB0K',1,45)//QB0K -> Chemical Rage
	call SaveBoolean(CooldownStorage,-'QB0K',0,true)//QB0K -> Chemical Rage
	call SaveReal(CooldownStorage,-'A0KV',1,12)//A0KV -> Starfall
	call SaveBoolean(CooldownStorage,-'A0KV',0,true)//A0KV -> Starfall
	call SaveReal(CooldownStorage,-'A0L8',1,17)//A0L8 -> Elune's Arrow
	call SaveBoolean(CooldownStorage,-'A0L8',0,true)//A0L8 -> Elune's Arrow
	call SaveReal(CooldownStorage,-'A0LN',1,16)//A0LN -> Leap
	call SaveReal(CooldownStorage,-'A0LN',2,14)//A0LN -> Leap
	call SaveReal(CooldownStorage,-'A0LN',3,12)//A0LN -> Leap
	call SaveReal(CooldownStorage,-'A0LN',4,10)//A0LN -> Leap
	call SaveBoolean(CooldownStorage,-'A0KU',1,true)//A0KU -> Moonlight Shadow
	call SaveReal(CooldownStorage,-'A0KU',1,140)//A0KU -> Moonlight Shadow
	call SaveReal(CooldownStorage,-'A0KU',2,120)//A0KU -> Moonlight Shadow
	call SaveReal(CooldownStorage,-'A0KU',3,100)//A0KU -> Moonlight Shadow
	call SaveReal(CooldownStorage,-'A14P',1,3.5)//A14P -> Static Remnant
	call SaveBoolean(CooldownStorage,-'A14P',0,true)//A14P -> Static Remnant
	call SaveReal(CooldownStorage,-'A14R',1,16)//A14R -> Electric Vortex
	call SaveReal(CooldownStorage,-'A14R',2,15)//A14R -> Electric Vortex
	call SaveReal(CooldownStorage,-'A14R',3,14)//A14R -> Electric Vortex
	call SaveReal(CooldownStorage,-'A14R',4,13)//A14R -> Electric Vortex
	call SaveReal(CooldownStorage,-'A0QP',1,22)//A0QP -> Inner Vitality
	call SaveReal(CooldownStorage,-'A0QP',2,18)//A0QP -> Inner Vitality
	call SaveReal(CooldownStorage,-'A0QP',3,14)//A0QP -> Inner Vitality
	call SaveReal(CooldownStorage,-'A0QP',4,10)//A0QP -> Inner Vitality
	call SaveBoolean(CooldownStorage,-'A0QR',1,true)//A0QR -> Life Break
	call SaveReal(CooldownStorage,-'A0QR',1,20)//A0QR -> Life Break
	call SaveBoolean(CooldownStorage,-'A0QR',0,true)//A0QR -> Life Break
	call SaveBoolean(CooldownStorage,-'A1B3',1,true)//A1B3 -> Life Break upgrade
	call SaveReal(CooldownStorage,-'A1B3',1,12)//A1B3 -> Life Break upgrade
	call SaveBoolean(CooldownStorage,-'A1B3',0,true)//A1B3 -> Life Break upgrade
	call SaveReal(CooldownStorage,-'A1EA',1,17)//A1EA -> Refraction
	call SaveBoolean(CooldownStorage,-'A1EA',0,true)//A1EA -> Refraction
	call SaveReal(CooldownStorage,-'A0RV',1,6)//A0RV -> Meld
	call SaveBoolean(CooldownStorage,-'A0RV',0,true)//A0RV -> Meld
	call SaveBoolean(CooldownStorage,-'A0RP',1,true)//A0RP -> Psionic Trap
	call SaveReal(CooldownStorage,-'A0RP',1,11)//A0RP -> Psionic Trap
	call SaveReal(CooldownStorage,-'A0RP',2,8)//A0RP -> Psionic Trap
	call SaveReal(CooldownStorage,-'A0RP',3,5)//A0RP -> Psionic Trap
	call SaveBoolean(CooldownStorage,-'A449',1,true)//A449 -> Psionic Trap
	call SaveReal(CooldownStorage,-'A449',1,11)//A449 -> Psionic Trap
	call SaveReal(CooldownStorage,-'A449',2,8)//A449 -> Psionic Trap
	call SaveReal(CooldownStorage,-'A449',3,5)//A449 -> Psionic Trap
	call SaveReal(CooldownStorage,-'A0S9',1,11)//A0S9 -> Illusory Orb
	call SaveBoolean(CooldownStorage,-'A0S9',0,true)//A0S9 -> Illusory Orb
	call SaveReal(CooldownStorage,-'A0SC',1,12)//A0SC -> Waning Rift
	call SaveBoolean(CooldownStorage,-'A0SC',0,true)//A0SC -> Waning Rift
	call SaveReal(CooldownStorage,-'A0SB',1,6)//A0SB -> Phase Shift
	call SaveBoolean(CooldownStorage,-'A0SB',0,true)//A0SB -> Phase Shift
	call SaveBoolean(CooldownStorage,-'A0S8',1,true)//A0S8 -> Dream Coil
	call SaveReal(CooldownStorage,-'A0S8',1,75)//A0S8 -> Dream Coil
	call SaveBoolean(CooldownStorage,-'A0S8',0,true)//A0S8 -> Dream Coil
	call SaveBoolean(CooldownStorage,-'A1QP',1,true)//A1QP -> Dream Coil
	call SaveReal(CooldownStorage,-'A1QP',1,75)//A1QP -> Dream Coil
	call SaveBoolean(CooldownStorage,-'A1QP',0,true)//A1QP -> Dream Coil
	call SaveReal(CooldownStorage,-'A0Z4',1,32)//A0Z4 -> Battery Assault
	call SaveReal(CooldownStorage,-'A0Z4',2,28)//A0Z4 -> Battery Assault
	call SaveReal(CooldownStorage,-'A0Z4',3,24)//A0Z4 -> Battery Assault
	call SaveReal(CooldownStorage,-'A0Z4',4,20)//A0Z4 -> Battery Assault
	call SaveReal(CooldownStorage,-'A0Z5',1,15)//A0Z5 -> Power Cog
	call SaveBoolean(CooldownStorage,-'A0Z5',0,true)//A0Z5 -> Power Cog
	call SaveReal(CooldownStorage,-'A0Z6',1,20)//A0Z6 -> Rocket Flare
	call SaveReal(CooldownStorage,-'A0Z6',2,18)//A0Z6 -> Rocket Flare
	call SaveReal(CooldownStorage,-'A0Z6',3,16)//A0Z6 -> Rocket Flare
	call SaveReal(CooldownStorage,-'A0Z6',4,14)//A0Z6 -> Rocket Flare
	call SaveBoolean(CooldownStorage,-'A0Z8',1,true)//A0Z8 -> Hookshot
	call SaveReal(CooldownStorage,-'A0Z8',1,70)//A0Z8 -> Hookshot
	call SaveReal(CooldownStorage,-'A0Z8',2,55)//A0Z8 -> Hookshot
	call SaveReal(CooldownStorage,-'A0Z8',3,40)//A0Z8 -> Hookshot
	call SaveBoolean(CooldownStorage,-'A1CV',1,true)//A1CV -> Hookshot Upgrade
	call SaveReal(CooldownStorage,-'A1CV',1,12)//A1CV -> Hookshot Upgrade
	call SaveBoolean(CooldownStorage,-'A1CV',0,true)//A1CV -> Hookshot Upgrade
	call SaveReal(CooldownStorage,-'A136',1,10)//A136 -> Torrent
	call SaveBoolean(CooldownStorage,-'A136',0,true)//A136 -> Torrent
	call SaveReal(CooldownStorage,-'A11N',1,14)//A11N -> X Marks The Spot
	call SaveReal(CooldownStorage,-'A11N',2,12)//A11N -> X Marks The Spot
	call SaveReal(CooldownStorage,-'A11N',3,10)//A11N -> X Marks The Spot
	call SaveReal(CooldownStorage,-'A11N',4,8)//A11N -> X Marks The Spot
	call SaveBoolean(CooldownStorage,-'A11K',1,true)//A11K -> Ghost Ship
	call SaveReal(CooldownStorage,-'A11K',1,60)//A11K -> Ghost Ship
	call SaveReal(CooldownStorage,-'A11K',2,50)//A11K -> Ghost Ship
	call SaveReal(CooldownStorage,-'A11K',3,40)//A11K -> Ghost Ship
	call SaveReal(CooldownStorage,-'A12J',1,12)//A12J -> Shackleshot
	call SaveBoolean(CooldownStorage,-'A12J',0,true)//A12J -> Shackleshot
	call SaveReal(CooldownStorage,-'A12K',1,9)//A12K -> Powershot
	call SaveBoolean(CooldownStorage,-'A12K',0,true)//A12K -> Powershot
	call SaveReal(CooldownStorage,-'A14I',1,15)//A14I -> Windrunner
	call SaveBoolean(CooldownStorage,-'A14I',0,true)//A14I -> Windrunner
	call SaveBoolean(CooldownStorage,-'A12P',1,true)//A12P -> Focus Fire
	call SaveReal(CooldownStorage,-'A12P',1,60)//A12P -> Focus Fire
	call SaveBoolean(CooldownStorage,-'A12P',0,true)//A12P -> Focus Fire
	call SaveBoolean(CooldownStorage,-'A1D6',1,true)//A1D6 -> Focus Fire Upgraded
	call SaveReal(CooldownStorage,-'A1D6',1,15)//A1D6 -> Focus Fire Upgraded
	call SaveBoolean(CooldownStorage,-'A1D6',0,true)//A1D6 -> Focus Fire Upgraded
	call SaveReal(CooldownStorage,-'A1SO',1,7)//A1SO -> Rocket Barrage
	call SaveReal(CooldownStorage,-'A1SO',2,6.5)//A1SO -> Rocket Barrage
	call SaveReal(CooldownStorage,-'A1SO',3,6)//A1SO -> Rocket Barrage
	call SaveReal(CooldownStorage,-'A1SO',4,5.5)//A1SO -> Rocket Barrage
	call SaveReal(CooldownStorage,-'A1SQ',1,20)//A1SQ -> Homing Missile
	call SaveReal(CooldownStorage,-'A1SQ',2,17)//A1SQ -> Homing Missile
	call SaveReal(CooldownStorage,-'A1SQ',3,14)//A1SQ -> Homing Missile
	call SaveReal(CooldownStorage,-'A1SQ',4,11)//A1SQ -> Homing Missile
	call SaveReal(CooldownStorage,-'A229',1,30)//A229 -> Flak Cannon
	call SaveBoolean(CooldownStorage,-'A229',0,true)//A229 -> Flak Cannon
	call SaveBoolean(CooldownStorage,-'A1T5',1,true)//A1T5 -> Call Down
	call SaveReal(CooldownStorage,-'A1T5',1,55)//A1T5 -> Call Down
	call SaveReal(CooldownStorage,-'A1T5',2,50)//A1T5 -> Call Down
	call SaveReal(CooldownStorage,-'A1T5',3,45)//A1T5 -> Call Down
	call SaveReal(CooldownStorage,-'A1T5',4,22)//A1T5 -> Call Down
	call SaveBoolean(CooldownStorage,-'A235',1,true)//A235 -> Call Down
	call SaveReal(CooldownStorage,-'A235',1,55)//A235 -> Call Down
	call SaveReal(CooldownStorage,-'A235',2,50)//A235 -> Call Down
	call SaveReal(CooldownStorage,-'A235',3,45)//A235 -> Call Down
	call SaveReal(CooldownStorage,-'A235',4,22)//A235 -> Call Down
	call SaveReal(CooldownStorage,-'A1TV',1,12)//A1TV -> Thunder Strike
	call SaveReal(CooldownStorage,-'A1TV',2,11)//A1TV -> Thunder Strike
	call SaveReal(CooldownStorage,-'A1TV',3,10)//A1TV -> Thunder Strike
	call SaveReal(CooldownStorage,-'A1TV',4,9)//A1TV -> Thunder Strike
	call SaveReal(CooldownStorage,-'A1SW',1,60)//A1SW -> Glimpse
	call SaveReal(CooldownStorage,-'A1SW',2,46)//A1SW -> Glimpse
	call SaveReal(CooldownStorage,-'A1SW',3,32)//A1SW -> Glimpse
	call SaveReal(CooldownStorage,-'A1SW',4,18)//A1SW -> Glimpse
	call SaveReal(CooldownStorage,-'A1SU',1,14)//A1SU -> Kinetic Field
	call SaveReal(CooldownStorage,-'A1SU',2,13)//A1SU -> Kinetic Field
	call SaveReal(CooldownStorage,-'A1SU',3,12)//A1SU -> Kinetic Field
	call SaveReal(CooldownStorage,-'A1SU',4,11)//A1SU -> Kinetic Field
	call SaveBoolean(CooldownStorage,-'A1U6',1,true)//A1U6 -> Static Storm
	call SaveReal(CooldownStorage,-'A1U6',1,85)//A1U6 -> Static Storm
	call SaveBoolean(CooldownStorage,-'A1U6',0,true)//A1U6 -> Static Storm
	call SaveBoolean(CooldownStorage,-'A30N',1,true)//A30N -> Static Storm
	call SaveReal(CooldownStorage,-'A30N',1,85)//A30N -> Static Storm
	call SaveBoolean(CooldownStorage,-'A30N',0,true)//A30N -> Static Storm
	call SaveReal(CooldownStorage,-'A1YO',1,19)//A1YO -> Ice Shards
	call SaveReal(CooldownStorage,-'A1YO',2,16)//A1YO -> Ice Shards
	call SaveReal(CooldownStorage,-'A1YO',3,13)//A1YO -> Ice Shards
	call SaveReal(CooldownStorage,-'A1YO',4,10)//A1YO -> Ice Shards
	call SaveReal(CooldownStorage,-'A1S7',1,21)//A1S7 -> Snowball
	call SaveBoolean(CooldownStorage,-'A1S7',0,true)//A1S7 -> Snowball
	call SaveReal(CooldownStorage,-'A1YR',1,50)//A1YR -> Frozen Sigil
	call SaveBoolean(CooldownStorage,-'A1YR',0,true)//A1YR -> Frozen Sigil
	call SaveBoolean(CooldownStorage,-'A1YQ',1,true)//A1YQ -> Walrus Punch
	call SaveReal(CooldownStorage,-'A1YQ',1,30)//A1YQ -> Walrus Punch
	call SaveReal(CooldownStorage,-'A1YQ',2,24)//A1YQ -> Walrus Punch
	call SaveReal(CooldownStorage,-'A1YQ',3,18)//A1YQ -> Walrus Punch
	call SaveReal(CooldownStorage,-'A1YQ',4,9)//A1YQ -> Walrus Punch
	call SaveBoolean(CooldownStorage,-'A3DE',1,true)//A3DE -> Walrus Punch
	call SaveReal(CooldownStorage,-'A3DE',1,20)//A3DE -> Walrus Punch
	call SaveReal(CooldownStorage,-'A3DE',2,16)//A3DE -> Walrus Punch
	call SaveReal(CooldownStorage,-'A3DE',3,12)//A3DE -> Walrus Punch
	call SaveReal(CooldownStorage,-'A1RJ',1,18)//A1RJ -> Icarus Dive
	call SaveBoolean(CooldownStorage,-'A1RJ',0,true)//A1RJ -> Icarus Dive
	call SaveReal(CooldownStorage,-'A1YX',1,45)//A1YX -> Fire Spirits
	call SaveReal(CooldownStorage,-'A1YX',2,40)//A1YX -> Fire Spirits
	call SaveReal(CooldownStorage,-'A1YX',3,35)//A1YX -> Fire Spirits
	call SaveReal(CooldownStorage,-'A1YX',4,30)//A1YX -> Fire Spirits
	call SaveReal(CooldownStorage,-'A1YY',1,20)//A1YY -> Sun Ray
	call SaveBoolean(CooldownStorage,-'A1YY',0,true)//A1YY -> Sun Ray
	call SaveBoolean(CooldownStorage,-'A1RK',1,true)//A1RK -> Supernova
	call SaveReal(CooldownStorage,-'A1RK',1,110)//A1RK -> Supernova
	call SaveBoolean(CooldownStorage,-'A1RK',0,true)//A1RK -> Supernova
	call SaveBoolean(CooldownStorage,-'A43H',1,true)//A43H -> Supernova
	call SaveReal(CooldownStorage,-'A43H',1,110)//A43H -> Supernova
	call SaveBoolean(CooldownStorage,-'A43H',0,true)//A43H -> Supernova
	call SaveReal(CooldownStorage,-'A0FW',1,1.5)//A0FW -> Viscous Nasal Goo
	call SaveBoolean(CooldownStorage,-'A0FW',0,true)//A0FW -> Viscous Nasal Goo
	call SaveReal(CooldownStorage,-'A0GP',1,3)//A0GP -> Quill Spray
	call SaveBoolean(CooldownStorage,-'A0GP',0,true)//A0GP -> Quill Spray
	call SaveReal(CooldownStorage,-'A27F',1,14)//A27F -> Telekinesis
	call SaveBoolean(CooldownStorage,-'A27F',0,true)//A27F -> Telekinesis
	call SaveReal(CooldownStorage,-'A27G',1,16)//A27G -> Fade Bolt
	call SaveReal(CooldownStorage,-'A27G',2,14)//A27G -> Fade Bolt
	call SaveReal(CooldownStorage,-'A27G',3,12)//A27G -> Fade Bolt
	call SaveReal(CooldownStorage,-'A27G',4,10)//A27G -> Fade Bolt
	call SaveBoolean(CooldownStorage,-'A27H',1,true)//A27H -> Spell Steal
	call SaveReal(CooldownStorage,-'A27H',1,20)//A27H -> Spell Steal
	call SaveReal(CooldownStorage,-'A27H',2,18)//A27H -> Spell Steal
	call SaveReal(CooldownStorage,-'A27H',3,16)//A27H -> Spell Steal
	call SaveBoolean(CooldownStorage,-'A30J',1,true)//A30J -> Spell Steal
	call SaveReal(CooldownStorage,-'A30J',1,2)//A30J -> Spell Steal
	call SaveBoolean(CooldownStorage,-'A30J',0,true)//A30J -> Spell Steal
	call SaveReal(CooldownStorage,-'A2H3',1,14)//A2H3 -> Searing Chains
	call SaveReal(CooldownStorage,-'A2H3',2,12)//A2H3 -> Searing Chains
	call SaveReal(CooldownStorage,-'A2H3',3,10)//A2H3 -> Searing Chains
	call SaveReal(CooldownStorage,-'A2H3',4,8)//A2H3 -> Searing Chains
	call SaveReal(CooldownStorage,-'A2HS',1,35)//A2HS -> Flame Guard
	call SaveBoolean(CooldownStorage,-'A2HS',0,true)//A2HS -> Flame Guard
	call SaveReal(CooldownStorage,-'A2JB',1,13)//A2JB -> Overwhelming Odds
	call SaveBoolean(CooldownStorage,-'A2JB',0,true)//A2JB -> Overwhelming Odds
	call SaveReal(CooldownStorage,-'A2J2',1,16)//A2J2 -> Press The Attack
	call SaveReal(CooldownStorage,-'A2J2',2,15)//A2J2 -> Press The Attack
	call SaveReal(CooldownStorage,-'A2J2',3,14)//A2J2 -> Press The Attack
	call SaveReal(CooldownStorage,-'A2J2',4,13)//A2J2 -> Press The Attack
	call SaveBoolean(CooldownStorage,-'A2CI',1,true)//A2CI -> Duel
	call SaveReal(CooldownStorage,-'A2CI',1,50)//A2CI -> Duel
	call SaveBoolean(CooldownStorage,-'A2CI',0,true)//A2CI -> Duel
	call SaveBoolean(CooldownStorage,-'A38C',1,true)//A38C -> Duel
	call SaveReal(CooldownStorage,-'A38C',1,50)//A38C -> Duel
	call SaveBoolean(CooldownStorage,-'A38C',0,true)//A38C -> Duel
	call SaveReal(CooldownStorage,-'A2BE',1,5)//A2BE -> Arcane Bolt
	call SaveReal(CooldownStorage,-'A2BE',2,4)//A2BE -> Arcane Bolt
	call SaveReal(CooldownStorage,-'A2BE',3,3)//A2BE -> Arcane Bolt
	call SaveReal(CooldownStorage,-'A2BE',4,2)//A2BE -> Arcane Bolt
	call SaveReal(CooldownStorage,-'A2IT',1,18)//A2IT -> Concussive Shot
	call SaveReal(CooldownStorage,-'A2IT',2,16)//A2IT -> Concussive Shot
	call SaveReal(CooldownStorage,-'A2IT',3,14)//A2IT -> Concussive Shot
	call SaveReal(CooldownStorage,-'A2IT',4,12)//A2IT -> Concussive Shot
	call SaveReal(CooldownStorage,-'A2HN',1,11)//A2HN -> Ancient Seal
	call SaveBoolean(CooldownStorage,-'A2HN',0,true)//A2HN -> Ancient Seal
	call SaveBoolean(CooldownStorage,-'A2BG',1,true)//A2BG -> Mystic Flare
	call SaveReal(CooldownStorage,-'A2BG',1,60)//A2BG -> Mystic Flare
	call SaveReal(CooldownStorage,-'A2BG',2,40)//A2BG -> Mystic Flare
	call SaveReal(CooldownStorage,-'A2BG',3,20)//A2BG -> Mystic Flare
	call SaveBoolean(CooldownStorage,-'A30H',1,true)//A30H -> Mystic Flare
	call SaveReal(CooldownStorage,-'A30H',1,20)//A30H -> Mystic Flare
	call SaveReal(CooldownStorage,-'A30H',2,10)//A30H -> Mystic Flare
	call SaveReal(CooldownStorage,-'A2FK',1,6)//A2FK -> Whirling Death
	call SaveBoolean(CooldownStorage,-'A2FK',0,true)//A2FK -> Whirling Death
	call SaveReal(CooldownStorage,-'A2E3',1,4)//A2E3 -> Timber Chain
	call SaveBoolean(CooldownStorage,-'A2E3',0,true)//A2E3 -> Timber Chain
	call SaveBoolean(CooldownStorage,-'A2E5',1,true)//A2E5 -> Chakram
	call SaveReal(CooldownStorage,-'A2E5',1,8)//A2E5 -> Chakram
	call SaveBoolean(CooldownStorage,-'A2E5',0,true)//A2E5 -> Chakram
	call SaveBoolean(CooldownStorage,-'A43S',1,true)//A43S -> Chakram
	call SaveReal(CooldownStorage,-'A43S',1,8)//A43S -> Chakram
	call SaveBoolean(CooldownStorage,-'A43S',0,true)//A43S -> Chakram
	call SaveReal(CooldownStorage,-'A03D',1,30)//A03D -> Summon Wolves
	call SaveBoolean(CooldownStorage,-'A03D',0,true)//A03D -> Summon Wolves
	call SaveReal(CooldownStorage,-'A0ZF',1,20)//A0ZF -> Howl
	call SaveBoolean(CooldownStorage,-'A0ZF',0,true)//A0ZF -> Howl
	call SaveBoolean(CooldownStorage,-'QM02',1,true)//QM02 -> Shapeshift
	call SaveReal(CooldownStorage,-'QM02',1,100)//QM02 -> Shapeshift
	call SaveReal(CooldownStorage,-'QM02',2,70)//QM02 -> Shapeshift
	call SaveReal(CooldownStorage,-'QM02',3,40)//QM02 -> Shapeshift
	call SaveReal(CooldownStorage,-'A0BH',1,10)//A0BH -> Spawn Spiderlings
	call SaveBoolean(CooldownStorage,-'A0BH',0,true)//A0BH -> Spawn Spiderlings
	call SaveReal(CooldownStorage,-'Z234',1,30)//Z234 -> Spin Web
	call SaveBoolean(CooldownStorage,-'Z234',0,true)//Z234 -> Spin Web
	call SaveBoolean(CooldownStorage,-'A0WQ',1,true)//A0WQ -> Insatiable Hunger
	call SaveReal(CooldownStorage,-'A0WQ',1,45)//A0WQ -> Insatiable Hunger
	call SaveBoolean(CooldownStorage,-'A0WQ',0,true)//A0WQ -> Insatiable Hunger
	call SaveReal(CooldownStorage,-'A0YM',1,7)//A0YM -> Stifling Dagger
	call SaveBoolean(CooldownStorage,-'A0YM',0,true)//A0YM -> Stifling Dagger
	call SaveReal(CooldownStorage,-'A0PL',1,14)//A0PL -> Phantom Strike
	call SaveReal(CooldownStorage,-'A0PL',2,12)//A0PL -> Phantom Strike
	call SaveReal(CooldownStorage,-'A0PL',3,10)//A0PL -> Phantom Strike
	call SaveReal(CooldownStorage,-'A0PL',4,8)//A0PL -> Phantom Strike
	call SaveReal(CooldownStorage,-'A0G2',1,11)//A0G2 -> Mystic Snake
	call SaveBoolean(CooldownStorage,-'A0G2',0,true)//A0G2 -> Mystic Snake
	call SaveBoolean(CooldownStorage,-'A1AT',1,true)//A1AT -> Stone Gaze
	call SaveReal(CooldownStorage,-'A1AT',1,90)//A1AT -> Stone Gaze
	call SaveBoolean(CooldownStorage,-'A1AT',0,true)//A1AT -> Stone Gaze
	call SaveReal(CooldownStorage,-'A02H',1,8)//A02H -> Void
	call SaveBoolean(CooldownStorage,-'A02H',0,true)//A02H -> Void
	call SaveReal(CooldownStorage,-'A08C',1,12)//A08C -> Crippling Fear
	call SaveReal(CooldownStorage,-'A08C',2,12)//A08C -> Crippling Fear
	call SaveReal(CooldownStorage,-'A08C',3,12)//A08C -> Crippling Fear
	call SaveReal(CooldownStorage,-'A08C',4,12)//A08C -> Crippling Fear
	call SaveBoolean(CooldownStorage,-'DRKN',1,true)//DRKN -> Darkness
	call SaveReal(CooldownStorage,-'DRKN',1,160)//DRKN -> Darkness
	call SaveReal(CooldownStorage,-'DRKN',2,120)//DRKN -> Darkness
	call SaveReal(CooldownStorage,-'DRKN',3,80)//DRKN -> Darkness
	call SaveBoolean(CooldownStorage,-'DRKU',1,true)//DRKN -> Darkness
	call SaveReal(CooldownStorage,-'DRKU',1,180)//DRKN -> Darkness
	call SaveReal(CooldownStorage,-'DRKU',2,150)//DRKN -> Darkness
	call SaveReal(CooldownStorage,-'DRKU',3,120)//DRKN -> Darkness
	call SaveBoolean(CooldownStorage,-'A01Y',1,true)//A01Y -> Reincarnation
	call SaveReal(CooldownStorage,-'A01Y',1,220)//A01Y -> Reincarnation
	call SaveReal(CooldownStorage,-'A01Y',2,160)//A01Y -> Reincarnation
	call SaveReal(CooldownStorage,-'A01Y',3,100)//A01Y -> Reincarnation
	call SaveBoolean(CooldownStorage,-'A1AZ',1,true)//A1AZ -> Reincarnation upgrade
	call SaveReal(CooldownStorage,-'A1AZ',1,220)//A1AZ -> Reincarnation upgrade
	call SaveReal(CooldownStorage,-'A1AZ',2,160)//A1AZ -> Reincarnation upgrade
	call SaveReal(CooldownStorage,-'A1AZ',3,100)//A1AZ -> Reincarnation upgrade
	call SaveReal(CooldownStorage,-'A10R',1,70)//A10R -> Devour
	call SaveReal(CooldownStorage,-'A10R',2,60)//A10R -> Devour
	call SaveReal(CooldownStorage,-'A10R',3,50)//A10R -> Devour
	call SaveReal(CooldownStorage,-'A10R',4,40)//A10R -> Devour
	call SaveReal(CooldownStorage,-'A1OP',1,30)//A1OP -> Scorched Earth
	call SaveBoolean(CooldownStorage,-'A1OP',0,true)//A1OP -> Scorched Earth
	call SaveReal(CooldownStorage,-'A094',1,7)//A094 -> LVL? Death
	call SaveBoolean(CooldownStorage,-'A094',0,true)//A094 -> LVL? Death
	call SaveBoolean(CooldownStorage,-'A0MU',1,true)//A0MU -> Doom
	call SaveReal(CooldownStorage,-'A0MU',1,100)//A0MU -> Doom
	call SaveBoolean(CooldownStorage,-'A0MU',0,true)//A0MU -> Doom
	call SaveBoolean(CooldownStorage,-'A0A2',1,true)//A0A2 -> Doom
	call SaveReal(CooldownStorage,-'A0A2',1,100)//A0A2 -> Doom
	call SaveBoolean(CooldownStorage,-'A0A2',0,true)//A0A2 -> Doom
	call SaveReal(CooldownStorage,-'A0X7',1,11)//A0X7 -> Impale
	call SaveBoolean(CooldownStorage,-'A0X7',0,true)//A0X7 -> Impale
	call SaveReal(CooldownStorage,-'A1H5',1,28)//A1H5 -> Mana Burn
	call SaveReal(CooldownStorage,-'A1H5',2,20)//A1H5 -> Mana Burn
	call SaveReal(CooldownStorage,-'A1H5',3,12)//A1H5 -> Mana Burn
	call SaveReal(CooldownStorage,-'A1H5',4,4)//A1H5 -> Mana Burn
	call SaveReal(CooldownStorage,-'A2KO',1,12)//A2KO -> Spiked Carapace
	call SaveBoolean(CooldownStorage,-'A2KO',0,true)//A2KO -> Spiked Carapace
	call SaveBoolean(CooldownStorage,-'A09U',1,true)//A09U -> Vendetta
	call SaveReal(CooldownStorage,-'A09U',1,70)//A09U -> Vendetta
	call SaveReal(CooldownStorage,-'A09U',2,60)//A09U -> Vendetta
	call SaveReal(CooldownStorage,-'A09U',3,50)//A09U -> Vendetta
	call SaveReal(CooldownStorage,-'A09U',4,5)//A09U -> Vendetta
	call SaveReal(CooldownStorage,-'A05C',1,17)//A05C -> Sprint
	call SaveBoolean(CooldownStorage,-'A05C',0,true)//A05C -> Sprint
	call SaveReal(CooldownStorage,-'A0Q7',1,16)//A0Q7 -> Shadow Strike
	call SaveReal(CooldownStorage,-'A0Q7',2,12)//A0Q7 -> Shadow Strike
	call SaveReal(CooldownStorage,-'A0Q7',3,8)//A0Q7 -> Shadow Strike
	call SaveReal(CooldownStorage,-'A0Q7',4,4)//A0Q7 -> Shadow Strike
	call SaveReal(CooldownStorage,-'A0ME',1,15)//A0ME -> Blink QoP
	call SaveReal(CooldownStorage,-'A0ME',2,13)//A0ME -> Blink QoP
	call SaveReal(CooldownStorage,-'A0ME',3,11)//A0ME -> Blink QoP
	call SaveReal(CooldownStorage,-'A0ME',4,9)//A0ME -> Blink QoP
	call SaveReal(CooldownStorage,-'A04A',1,7)//A04A -> Scream of Pain
	call SaveBoolean(CooldownStorage,-'A04A',0,true)//A04A -> Scream of Pain
	call SaveBoolean(CooldownStorage,-'A28R',1,true)//A28R -> Sonic Wave
	call SaveReal(CooldownStorage,-'A28R',1,120)//A28R -> Sonic Wave
	call SaveReal(CooldownStorage,-'A28R',2,110)//A28R -> Sonic Wave
	call SaveReal(CooldownStorage,-'A28R',3,100)//A28R -> Sonic Wave
	call SaveBoolean(CooldownStorage,-'A28S',1,true)//A28S -> Sonic Wave
	call SaveReal(CooldownStorage,-'A28S',1,40)//A28S -> Sonic Wave
	call SaveBoolean(CooldownStorage,-'A28S',0,true)//A28S -> Sonic Wave
	call SaveReal(CooldownStorage,-'A030',1,45)//A030 -> Strafe
	call SaveReal(CooldownStorage,-'A030',2,40)//A030 -> Strafe
	call SaveReal(CooldownStorage,-'A030',3,35)//A030 -> Strafe
	call SaveReal(CooldownStorage,-'A030',4,35)//A030 -> Strafe
	call SaveBoolean(CooldownStorage,-'A04Q',1,true)//A04Q -> Death Pact
	call SaveReal(CooldownStorage,-'A04Q',1,45)//A04Q -> Death Pact
	call SaveReal(CooldownStorage,-'A04Q',2,35)//A04Q -> Death Pact
	call SaveReal(CooldownStorage,-'A04Q',3,25)//A04Q -> Death Pact
	call SaveReal(CooldownStorage,-'A0LK',1,19)//A0LK -> Time Walk
	call SaveReal(CooldownStorage,-'A0LK',2,17)//A0LK -> Time Walk
	call SaveReal(CooldownStorage,-'A0LK',3,15)//A0LK -> Time Walk
	call SaveReal(CooldownStorage,-'A0LK',4,13)//A0LK -> Time Walk
	call SaveBoolean(CooldownStorage,-'A0J1',1,true)//A0J1 -> Chronosphere
	call SaveReal(CooldownStorage,-'A0J1',1,130)//A0J1 -> Chronosphere
	call SaveReal(CooldownStorage,-'A0J1',2,120)//A0J1 -> Chronosphere
	call SaveReal(CooldownStorage,-'A0J1',3,110)//A0J1 -> Chronosphere
	call SaveBoolean(CooldownStorage,-'A1D7',1,true)//A1D7 -> Chronosphere Upgraded
	call SaveReal(CooldownStorage,-'A1D7',1,70)//A1D7 -> Chronosphere Upgraded
	call SaveBoolean(CooldownStorage,-'A1D7',0,true)//A1D7 -> Chronosphere Upgraded
	call SaveBoolean(CooldownStorage,-'A080',1,true)//A080 -> Viper Strike
	call SaveReal(CooldownStorage,-'A080',1,70)//A080 -> Viper Strike
	call SaveReal(CooldownStorage,-'A080',2,50)//A080 -> Viper Strike
	call SaveReal(CooldownStorage,-'A080',3,30)//A080 -> Viper Strike
	call SaveReal(CooldownStorage,-'A080',4,8)//A080 -> Viper Strike
	call SaveBoolean(CooldownStorage,-'A1UZ',1,true)//A1UZ -> Viper Strike
	call SaveReal(CooldownStorage,-'A1UZ',1,12)//A1UZ -> Viper Strike
	call SaveBoolean(CooldownStorage,-'A1UZ',0,true)//A1UZ -> Viper Strike
	call SaveReal(CooldownStorage,-'A1E7',1,14)//A1E7 -> Plasma Field
	call SaveBoolean(CooldownStorage,-'A1E7',0,true)//A1E7 -> Plasma Field
	call SaveReal(CooldownStorage,-'A1DP',1,25)//A1DP -> Static Link
	call SaveBoolean(CooldownStorage,-'A1DP',0,true)//A1DP -> Static Link
	call SaveBoolean(CooldownStorage,-'A1AO',1,true)//A1AO -> Eye of the Storm
	call SaveReal(CooldownStorage,-'A1AO',1,80)//A1AO -> Eye of the Storm
	call SaveReal(CooldownStorage,-'A1AO',2,70)//A1AO -> Eye of the Storm
	call SaveReal(CooldownStorage,-'A1AO',3,60)//A1AO -> Eye of the Storm
	call SaveBoolean(CooldownStorage,-'A1UV',1,true)//A1UV -> Eye of the Storm
	call SaveReal(CooldownStorage,-'A1UV',1,80)//A1UV -> Eye of the Storm
	call SaveReal(CooldownStorage,-'A1UV',2,70)//A1UV -> Eye of the Storm
	call SaveReal(CooldownStorage,-'A1UV',3,60)//A1UV -> Eye of the Storm
	call SaveReal(CooldownStorage,-'A0T2',1,19)//A0T2 -> Rage
	call SaveBoolean(CooldownStorage,-'A0T2',0,true)//A0T2 -> Rage
	call SaveReal(CooldownStorage,-'A194',1,12)//A194 -> Open Wounds
	call SaveBoolean(CooldownStorage,-'A194',0,true)//A194 -> Open Wounds
	call SaveBoolean(CooldownStorage,-'A0SW',1,true)//A0SW -> Infest
	call SaveReal(CooldownStorage,-'A0SW',1,100)//A0SW -> Infest
	call SaveBoolean(CooldownStorage,-'A0SW',0,true)//A0SW -> Infest
	call SaveReal(CooldownStorage,-'A0MT',1,5.5)//A0MT -> Nether Blast
	call SaveBoolean(CooldownStorage,-'A0MT',0,true)//A0MT -> Nether Blast
	call SaveReal(CooldownStorage,-'A2TD',1,12)//A2TD -> Decrepify
	call SaveReal(CooldownStorage,-'A2TD',2,10)//A2TD -> Decrepify
	call SaveReal(CooldownStorage,-'A2TD',3,8)//A2TD -> Decrepify
	call SaveReal(CooldownStorage,-'A2TD',4,6)//A2TD -> Decrepify
	call SaveReal(CooldownStorage,-'A09D',1,35)//A09D -> Nether Ward
	call SaveBoolean(CooldownStorage,-'A09D',0,true)//A09D -> Nether Ward
	call SaveBoolean(CooldownStorage,-'A0CC',1,true)//A0CC -> Life Drain
	call SaveReal(CooldownStorage,-'A0CC',1,22)//A0CC -> Life Drain
	call SaveBoolean(CooldownStorage,-'A0CC',0,true)//A0CC -> Life Drain
	call SaveBoolean(CooldownStorage,-'A02Z',1,true)//A02Z -> Life Drain
	call SaveReal(CooldownStorage,-'A046',1,12)//A046 -> Gush
	call SaveBoolean(CooldownStorage,-'A046',0,true)//A046 -> Gush
	call SaveReal(CooldownStorage,-'A226',1,7)//A226 -> Anchor Smash
	call SaveReal(CooldownStorage,-'A226',2,6)//A226 -> Anchor Smash
	call SaveReal(CooldownStorage,-'A226',3,5)//A226 -> Anchor Smash
	call SaveReal(CooldownStorage,-'A226',4,4)//A226 -> Anchor Smash
	call SaveBoolean(CooldownStorage,-'A29I',1,true)//A29I -> Ravage
	call SaveReal(CooldownStorage,-'A29I',1,150)//A29I -> Ravage
	call SaveBoolean(CooldownStorage,-'A29I',0,true)//A29I -> Ravage
	call SaveReal(CooldownStorage,-'A04V',1,8)//A04V -> Enfeeble
	call SaveBoolean(CooldownStorage,-'A04V',0,true)//A04V -> Enfeeble
	call SaveReal(CooldownStorage,-'A0GK',1,14)//A0GK -> Brain Sap
	call SaveBoolean(CooldownStorage,-'A0GK',0,true)//A0GK -> Brain Sap
	call SaveReal(CooldownStorage,-'A04Y',1,16)//A04Y -> Nightmare
	call SaveReal(CooldownStorage,-'A04Y',2,15)//A04Y -> Nightmare
	call SaveReal(CooldownStorage,-'A04Y',3,14)//A04Y -> Nightmare
	call SaveReal(CooldownStorage,-'A04Y',4,13)//A04Y -> Nightmare
	call SaveBoolean(CooldownStorage,-'A02Q',1,true)//A02Q -> Fiend's Grip
	call SaveReal(CooldownStorage,-'A02Q',1,100)//A02Q -> Fiend's Grip
	call SaveBoolean(CooldownStorage,-'A02Q',0,true)//A02Q -> Fiend's Grip
	call SaveBoolean(CooldownStorage,-'A1D9',1,true)//A1D9 -> Fiend's Grip Upgrade
	call SaveReal(CooldownStorage,-'A1D9',1,100)//A1D9 -> Fiend's Grip Upgrade
	call SaveBoolean(CooldownStorage,-'A1D9',0,true)//A1D9 -> Fiend's Grip Upgrade
	call SaveReal(CooldownStorage,-'A05V',1,8)//A05V -> Death Pulse
	call SaveReal(CooldownStorage,-'A05V',2,7)//A05V -> Death Pulse
	call SaveReal(CooldownStorage,-'A05V',3,6)//A05V -> Death Pulse
	call SaveReal(CooldownStorage,-'A05V',4,5)//A05V -> Death Pulse
	call SaveBoolean(CooldownStorage,-'A067',1,true)//A067 -> Reaper's Scythe
	call SaveReal(CooldownStorage,-'A067',1,100)//A067 -> Reaper's Scythe
	call SaveReal(CooldownStorage,-'A067',2,85)//A067 -> Reaper's Scythe
	call SaveReal(CooldownStorage,-'A067',3,70)//A067 -> Reaper's Scythe
	call SaveBoolean(CooldownStorage,-'A08P',1,true)//A08P -> Reaper's Scythe
	call SaveReal(CooldownStorage,-'A08P',1,70)//A08P -> Reaper's Scythe
	call SaveBoolean(CooldownStorage,-'A08P',0,true)//A08P -> Reaper's Scythe
	call SaveReal(CooldownStorage,-'A06I',1,14)//A06I -> Meat Hook
	call SaveReal(CooldownStorage,-'A06I',2,13)//A06I -> Meat Hook
	call SaveReal(CooldownStorage,-'A06I',3,12)//A06I -> Meat Hook
	call SaveReal(CooldownStorage,-'A06I',4,11)//A06I -> Meat Hook
	call SaveBoolean(CooldownStorage,-'A0FL',1,true)//A0FL -> Dismember
	call SaveReal(CooldownStorage,-'A0FL',1,30)//A0FL -> Dismember
	call SaveBoolean(CooldownStorage,-'A0FL',0,true)//A0FL -> Dismember
	call SaveBoolean(CooldownStorage,-'A1CX',1,true)//A1CX -> Dismember Upgraded
	call SaveReal(CooldownStorage,-'A1CX',1,30)//A1CX -> Dismember Upgraded
	call SaveBoolean(CooldownStorage,-'A1CX',0,true)//A1CX -> Dismember Upgraded
	call SaveReal(CooldownStorage,-'A1P8',1,35)//A1P8 -> Charge of Darkness
	call SaveBoolean(CooldownStorage,-'A1P8',0,true)//A1P8 -> Charge of Darkness
	call SaveReal(CooldownStorage,-'A0ES',1,12)//A0ES -> Empowering Haste
	call SaveBoolean(CooldownStorage,-'A0ES',0,true)//A0ES -> Empowering Haste
	call SaveBoolean(CooldownStorage,-'A0G4',1,true)//A0G4 -> Nether Strike
	call SaveReal(CooldownStorage,-'A0G4',1,80)//A0G4 -> Nether Strike
	call SaveReal(CooldownStorage,-'A0G4',2,70)//A0G4 -> Nether Strike
	call SaveReal(CooldownStorage,-'A0G4',3,60)//A0G4 -> Nether Strike
	call SaveBoolean(CooldownStorage,-'A1D8',1,true)//A1D8 -> Nether Strike Upgrade
	call SaveReal(CooldownStorage,-'A1D8',1,20)//A1D8 -> Nether Strike Upgrade
	call SaveBoolean(CooldownStorage,-'A1D8',0,true)//A1D8 -> Nether Strike Upgrade
	call SaveReal(CooldownStorage,-'A1QW',1,35)//A1QW -> The Swarm
	call SaveReal(CooldownStorage,-'A1QW',2,30)//A1QW -> The Swarm
	call SaveReal(CooldownStorage,-'A1QW',3,25)//A1QW -> The Swarm
	call SaveReal(CooldownStorage,-'A1QW',4,20)//A1QW -> The Swarm
	call SaveReal(CooldownStorage,-'A0CA',1,14)//A0CA -> Shukuchi
	call SaveReal(CooldownStorage,-'A0CA',2,12)//A0CA -> Shukuchi
	call SaveReal(CooldownStorage,-'A0CA',3,10)//A0CA -> Shukuchi
	call SaveReal(CooldownStorage,-'A0CA',4,8)//A0CA -> Shukuchi
	call SaveBoolean(CooldownStorage,-'A0CT',1,true)//A0CT -> Time Lapse
	call SaveReal(CooldownStorage,-'A0CT',1,60)//A0CT -> Time Lapse
	call SaveReal(CooldownStorage,-'A0CT',2,50)//A0CT -> Time Lapse
	call SaveReal(CooldownStorage,-'A0CT',3,40)//A0CT -> Time Lapse
	call SaveBoolean(CooldownStorage,-'A3DM',1,true)//A3DM -> Time Lapse
	call SaveReal(CooldownStorage,-'A3DM',1,20)//A3DM -> Time Lapse
	call SaveBoolean(CooldownStorage,-'A3DM',0,true)//A3DM -> Time Lapse
	call SaveReal(CooldownStorage,-'A0EY',1,10)//A0EY -> Shadowraze
	call SaveBoolean(CooldownStorage,-'A0EY',0,true)//A0EY -> Shadowraze
	call SaveBoolean(CooldownStorage,-'A29J',1,true)//A29J -> Requiem of Souls
	call SaveReal(CooldownStorage,-'A29J',1,120)//A29J -> Requiem of Souls
	call SaveReal(CooldownStorage,-'A29J',2,110)//A29J -> Requiem of Souls
	call SaveReal(CooldownStorage,-'A29J',3,100)//A29J -> Requiem of Souls
	call SaveReal(CooldownStorage,-'A06O',1,11)//A06O -> Burrowstrike
	call SaveBoolean(CooldownStorage,-'A06O',0,true)//A06O -> Burrowstrike
	call SaveReal(CooldownStorage,-'A0H0',1,25)//A0H0 -> Sand Storm
	call SaveReal(CooldownStorage,-'A0H0',2,20)//A0H0 -> Sand Storm
	call SaveReal(CooldownStorage,-'A0H0',3,15)//A0H0 -> Sand Storm
	call SaveReal(CooldownStorage,-'A0H0',4,10)//A0H0 -> Sand Storm
	call SaveBoolean(CooldownStorage,-'A06R',1,true)//A06R -> Epicenter
	call SaveReal(CooldownStorage,-'A06R',1,100)//A06R -> Epicenter
	call SaveReal(CooldownStorage,-'A06R',2,90)//A06R -> Epicenter
	call SaveReal(CooldownStorage,-'A06R',3,80)//A06R -> Epicenter
	call SaveBoolean(CooldownStorage,-'A1B4',1,true)//A1B4 -> Epicenter upgrade
	call SaveReal(CooldownStorage,-'A1B4',1,90)//A1B4 -> Epicenter upgrade
	call SaveReal(CooldownStorage,-'A1B4',2,80)//A1B4 -> Epicenter upgrade
	call SaveReal(CooldownStorage,-'A1B4',3,70)//A1B4 -> Epicenter upgrade
	call SaveReal(CooldownStorage,-'A0I6',1,13)//A0I6 -> Berserker's Call
	call SaveBoolean(CooldownStorage,-'A0I6',0,true)//A0I6 -> Berserker's Call
	call SaveReal(CooldownStorage,-'A0S1',1,20)//A0S1 -> Battle Hunger
	call SaveReal(CooldownStorage,-'A0S1',2,15)//A0S1 -> Battle Hunger
	call SaveReal(CooldownStorage,-'A0S1',3,10)//A0S1 -> Battle Hunger
	call SaveReal(CooldownStorage,-'A0S1',4,5)//A0S1 -> Battle Hunger
	call SaveBoolean(CooldownStorage,-'A0E2',1,true)//A0E2 -> Culling Blade
	call SaveReal(CooldownStorage,-'A0E2',1,75)//A0E2 -> Culling Blade
	call SaveReal(CooldownStorage,-'A0E2',2,65)//A0E2 -> Culling Blade
	call SaveReal(CooldownStorage,-'A0E2',3,55)//A0E2 -> Culling Blade
	call SaveReal(CooldownStorage,-'A0E2',4,9)//A0E2 -> Culling Blade
	call SaveBoolean(CooldownStorage,-'A1MR',1,true)//A1MR -> Culling Blade
	call SaveReal(CooldownStorage,-'A1MR',1,6)//A1MR -> Culling Blade
	call SaveBoolean(CooldownStorage,-'A1MR',0,true)//A1MR -> Culling Blade
	call SaveReal(CooldownStorage,-'A44X',1,12)//A44X -> Bloodrage New
	call SaveReal(CooldownStorage,-'A44X',2,10)//A44X -> Bloodrage New
	call SaveReal(CooldownStorage,-'A44X',3,8)//A44X -> Bloodrage New
	call SaveReal(CooldownStorage,-'A44X',4,6)//A44X -> Bloodrage New
	call SaveReal(CooldownStorage,-'A44Z',1,18)//A44Z -> Blood Rite
	call SaveBoolean(CooldownStorage,-'A44Z',0,true)//A44Z -> Blood Rite
	call SaveBoolean(CooldownStorage,-'A0LH',1,true)//A0LH -> Rupture
	call SaveReal(CooldownStorage,-'A0LH',1,70)//A0LH -> Rupture
	call SaveReal(CooldownStorage,-'A0LH',2,60)//A0LH -> Rupture
	call SaveReal(CooldownStorage,-'A0LH',3,50)//A0LH -> Rupture
	call SaveReal(CooldownStorage,-'A0I3',1,4.5)//A0I3 -> Death Coil
	call SaveBoolean(CooldownStorage,-'A0I3',0,true)//A0I3 -> Death Coil
	call SaveReal(CooldownStorage,-'A0MF',1,12)//A0MF -> Aphotic Shield
	call SaveReal(CooldownStorage,-'A0MF',2,10)//A0MF -> Aphotic Shield
	call SaveReal(CooldownStorage,-'A0MF',3,8)//A0MF -> Aphotic Shield
	call SaveReal(CooldownStorage,-'A0MF',4,6)//A0MF -> Aphotic Shield
	call SaveBoolean(CooldownStorage,-'A0NS',1,true)//A0NS -> Borrowed Time
	call SaveReal(CooldownStorage,-'A0NS',1,90)//A0NS -> Borrowed Time
	call SaveReal(CooldownStorage,-'A0NS',2,80)//A0NS -> Borrowed Time
	call SaveReal(CooldownStorage,-'A0NS',3,70)//A0NS -> Borrowed Time
	call SaveBoolean(CooldownStorage,-'A1DA',1,true)//A1DA -> Borrowed Time Upgrade
	call SaveReal(CooldownStorage,-'A1DA',1,90)//A1DA -> Borrowed Time Upgrade
	call SaveReal(CooldownStorage,-'A1DA',2,80)//A1DA -> Borrowed Time Upgrade
	call SaveReal(CooldownStorage,-'A1DA',3,70)//A1DA -> Borrowed Time Upgrade
	call SaveReal(CooldownStorage,-'A0HW',1,15)//A0HW -> Spectral Dagger
	call SaveReal(CooldownStorage,-'A0HW',2,14)//A0HW -> Spectral Dagger
	call SaveReal(CooldownStorage,-'A0HW',3,13)//A0HW -> Spectral Dagger
	call SaveReal(CooldownStorage,-'A0HW',4,12)//A0HW -> Spectral Dagger
	call SaveBoolean(CooldownStorage,-'A0H9',1,true)//A0H9 -> Haunt
	call SaveReal(CooldownStorage,-'A0H9',1,120)//A0H9 -> Haunt
	call SaveBoolean(CooldownStorage,-'A0H9',0,true)//A0H9 -> Haunt
	call SaveReal(CooldownStorage,-'A0NM',1,12)//A0NM -> Paralyzing Cask
	call SaveBoolean(CooldownStorage,-'A0NM',0,true)//A0NM -> Paralyzing Cask
	call SaveReal(CooldownStorage,-'A0NO',1,20)//A0NO -> Maledict
	call SaveBoolean(CooldownStorage,-'A0NO',0,true)//A0NO -> Maledict
	call SaveBoolean(CooldownStorage,-'A0NT',1,true)//A0NT -> Death Ward
	call SaveReal(CooldownStorage,-'A0NT',1,80)//A0NT -> Death Ward
	call SaveBoolean(CooldownStorage,-'A0NT',0,true)//A0NT -> Death Ward
	call SaveBoolean(CooldownStorage,-'A0NX',1,true)//A0NX -> Death Ward
	call SaveReal(CooldownStorage,-'A0NX',1,80)//A0NX -> Death Ward
	call SaveBoolean(CooldownStorage,-'A0NX',0,true)//A0NX -> Death Ward
	call SaveReal(CooldownStorage,-'A0OJ',1,18)//A0OJ -> Astral Imprisonment
	call SaveReal(CooldownStorage,-'A0OJ',2,16)//A0OJ -> Astral Imprisonment
	call SaveReal(CooldownStorage,-'A0OJ',3,14)//A0OJ -> Astral Imprisonment
	call SaveReal(CooldownStorage,-'A0OJ',4,12)//A0OJ -> Astral Imprisonment
	call SaveBoolean(CooldownStorage,-'A0OK',1,true)//A0OK -> Sanity's Eclipse
	call SaveReal(CooldownStorage,-'A0OK',1,130)//A0OK -> Sanity's Eclipse
	call SaveBoolean(CooldownStorage,-'A0OK',0,true)//A0OK -> Sanity's Eclipse
	call SaveBoolean(CooldownStorage,-'A1VW',1,true)//A1VW -> Sanity's Eclipse
	call SaveReal(CooldownStorage,-'A1VW',1,130)//A1VW -> Sanity's Eclipse
	call SaveBoolean(CooldownStorage,-'A1VW',0,true)//A1VW -> Sanity's Eclipse
	call SaveReal(CooldownStorage,-'A0J5',1,25)//A0J5 -> Fatal Bonds
	call SaveBoolean(CooldownStorage,-'A0J5',0,true)//A0J5 -> Fatal Bonds
	call SaveReal(CooldownStorage,-'A0AS',1,13)//A0AS -> Shadow Word
	call SaveBoolean(CooldownStorage,-'A0AS',0,true)//A0AS -> Shadow Word
	call SaveReal(CooldownStorage,-'A06P',1,50)//A06P -> Upheaval
	call SaveReal(CooldownStorage,-'A06P',2,46)//A06P -> Upheaval
	call SaveReal(CooldownStorage,-'A06P',3,42)//A06P -> Upheaval
	call SaveReal(CooldownStorage,-'A06P',4,38)//A06P -> Upheaval
	call SaveBoolean(CooldownStorage,-'S008',1,true)//S008 -> Rain of Chaos
	call SaveReal(CooldownStorage,-'S008',1,165)//S008 -> Rain of Chaos
	call SaveBoolean(CooldownStorage,-'S008',0,true)//S008 -> Rain of Chaos
	call SaveBoolean(CooldownStorage,-'S00U',1,true)//S00U -> Rain of Chaos
	call SaveReal(CooldownStorage,-'S00U',1,165)//S00U -> Rain of Chaos
	call SaveBoolean(CooldownStorage,-'S00U',0,true)//S00U -> Rain of Chaos
	call SaveReal(CooldownStorage,-'A0NB',1,9)//A0NB -> Earthbind
	call SaveReal(CooldownStorage,-'A0NB',2,8)//A0NB -> Earthbind
	call SaveReal(CooldownStorage,-'A0NB',3,7)//A0NB -> Earthbind
	call SaveReal(CooldownStorage,-'A0NB',4,6)//A0NB -> Earthbind
	call SaveReal(CooldownStorage,-'A0N8',1,12)//A0N8 -> Poof
	call SaveReal(CooldownStorage,-'A0N8',2,10)//A0N8 -> Poof
	call SaveReal(CooldownStorage,-'A0N8',3,8)//A0N8 -> Poof
	call SaveReal(CooldownStorage,-'A0N8',4,4.5)//A0N8 -> Poof
	call SaveReal(CooldownStorage,-'A0NQ',1,15)//A0NQ -> Poison Touch
	call SaveReal(CooldownStorage,-'A0NQ',2,13)//A0NQ -> Poison Touch
	call SaveReal(CooldownStorage,-'A0NQ',3,11)//A0NQ -> Poison Touch
	call SaveReal(CooldownStorage,-'A0NQ',4,7)//A0NQ -> Poison Touch
	call SaveReal(CooldownStorage,-'A10L',1,60)//A10L -> Shallow Grave
	call SaveReal(CooldownStorage,-'A10L',2,45)//A10L -> Shallow Grave
	call SaveReal(CooldownStorage,-'A10L',3,30)//A10L -> Shallow Grave
	call SaveReal(CooldownStorage,-'A10L',4,15)//A10L -> Shallow Grave
	call SaveReal(CooldownStorage,-'A0OR',1,12)//A0OR -> Shadow Wave
	call SaveReal(CooldownStorage,-'A0OR',2,10)//A0OR -> Shadow Wave
	call SaveReal(CooldownStorage,-'A0OR',3,8)//A0OR -> Shadow Wave
	call SaveReal(CooldownStorage,-'A0OR',4,6)//A0OR -> Shadow Wave
	call SaveBoolean(CooldownStorage,-'A10Q',1,true)//A10Q -> Weave
	call SaveReal(CooldownStorage,-'A10Q',1,40)//A10Q -> Weave
	call SaveBoolean(CooldownStorage,-'A10Q',0,true)//A10Q -> Weave
	call SaveBoolean(CooldownStorage,-'A1DB',1,true)//A1DB -> Weave Upgrade
	call SaveReal(CooldownStorage,-'A1DB',1,40)//A1DB -> Weave Upgrade
	call SaveBoolean(CooldownStorage,-'A1DB',0,true)//A1DB -> Weave Upgrade
	call SaveReal(CooldownStorage,-'A01I',1,14)//A01I -> Firestorm
	call SaveBoolean(CooldownStorage,-'A01I',0,true)//A01I -> Firestorm
	call SaveReal(CooldownStorage,-'A0RA',1,24)//A0RA -> Pit of Malice
	call SaveReal(CooldownStorage,-'A0RA',2,21)//A0RA -> Pit of Malice
	call SaveReal(CooldownStorage,-'A0RA',3,18)//A0RA -> Pit of Malice
	call SaveReal(CooldownStorage,-'A0RA',4,15)//A0RA -> Pit of Malice
	call SaveBoolean(CooldownStorage,-'A0R0',1,true)//A0R0 -> Dark Rift
	call SaveReal(CooldownStorage,-'A0R0',1,75)//A0R0 -> Dark Rift
	call SaveReal(CooldownStorage,-'A0R0',2,65)//A0R0 -> Dark Rift
	call SaveReal(CooldownStorage,-'A0R0',3,55)//A0R0 -> Dark Rift
	call SaveReal(CooldownStorage,-'A0R5',1,24)//A0R5 -> Soul Rip
	call SaveReal(CooldownStorage,-'A0R5',2,18)//A0R5 -> Soul Rip
	call SaveReal(CooldownStorage,-'A0R5',3,12)//A0R5 -> Soul Rip
	call SaveReal(CooldownStorage,-'A0R5',4,6)//A0R5 -> Soul Rip
	call SaveReal(CooldownStorage,-'A3JX',1,10)
	call SaveReal(CooldownStorage,-'A3JX',2,8)
	call SaveReal(CooldownStorage,-'A3JX',3,6)
	call SaveReal(CooldownStorage,-'A3JX',4,4)
	call SaveReal(CooldownStorage,-'A15S',1,10)//decay
	call SaveReal(CooldownStorage,-'A15S',2,8)
	call SaveReal(CooldownStorage,-'A15S',3,6)
	call SaveReal(CooldownStorage,-'A15S',4,4)
	call SaveReal(CooldownStorage,-'A15V',1,60)//A15V -> Tombstone
	call SaveBoolean(CooldownStorage,-'A15V',0,true)//A15V -> Tombstone
	call SaveBoolean(CooldownStorage,-'QM03',1,true)//QM03 -> Flesh Golem
	call SaveReal(CooldownStorage,-'QM03',1,75)//QM03 -> Flesh Golem
	call SaveBoolean(CooldownStorage,-'QM03',0,true)//QM03 -> Flesh Golem
	call SaveReal(CooldownStorage,-'A0QE',1,20)//A0QE -> Vacuum
	call SaveBoolean(CooldownStorage,-'A0QE',0,true)//A0QE -> Vacuum
	call SaveReal(CooldownStorage,-'A0QG',1,9)//A0QG -> Ion Shell
	call SaveBoolean(CooldownStorage,-'A0QG',0,true)//A0QG -> Ion Shell
	call SaveReal(CooldownStorage,-'A0R7',1,12)//A0R7 -> Surge
	call SaveReal(CooldownStorage,-'A0R7',2,11)//A0R7 -> Surge
	call SaveReal(CooldownStorage,-'A0R7',3,10)//A0R7 -> Surge
	call SaveReal(CooldownStorage,-'A0R7',4,9)//A0R7 -> Surge
	call SaveBoolean(CooldownStorage,-'A0QK',1,true)//A0QK -> Wall of Replica
	call SaveReal(CooldownStorage,-'A0QK',1,100)//A0QK -> Wall of Replica
	call SaveBoolean(CooldownStorage,-'A0QK',0,true)//A0QK -> Wall of Replica
	call SaveBoolean(CooldownStorage,-'A21Q',1,true)//A21Q -> Wall of Replica
	call SaveReal(CooldownStorage,-'A21Q',1,100)//A21Q -> Wall of Replica
	call SaveBoolean(CooldownStorage,-'A21Q',0,true)//A21Q -> Wall of Replica
	call SaveBoolean(CooldownStorage,-'A32A',0,true)
	call SaveReal(CooldownStorage,-'A32A',1,12)//A32A -> Spit
	call SaveReal(CooldownStorage,-'A32C',1,13)//A32C -> Trample
	call SaveBoolean(CooldownStorage,-'A32C',0,true)//A32C -> Trample
	call SaveReal(CooldownStorage,-'A32E',1,1.5)//A32E -> Digest
	call SaveBoolean(CooldownStorage,-'A32E',0,true)//A32E -> Digest
	call SaveBoolean(CooldownStorage,-'A32G',1,true)//A32G -> Drums of War
	call SaveReal(CooldownStorage,-'A32G',1,90)//A32G -> Drums of War
	call SaveReal(CooldownStorage,-'A32G',2,80)//A32G -> Drums of War
	call SaveReal(CooldownStorage,-'A32G',3,70)//A32G -> Drums of War
	call SaveReal(CooldownStorage,-'A0I7',1,15)//A0I7 -> Malefice
	call SaveBoolean(CooldownStorage,-'A0I7',0,true)//A0I7 -> Malefice
	call SaveReal(CooldownStorage,-'A180',1,35)//A180 -> Demonic Conversion
	call SaveBoolean(CooldownStorage,-'A180',0,true)//A180 -> Demonic Conversion
	call SaveReal(CooldownStorage,-'A0B1',1,25)//A0B1 -> Midnight Pulse
	call SaveBoolean(CooldownStorage,-'A0B1',0,true)//A0B1 -> Midnight Pulse
	call SaveBoolean(CooldownStorage,-'A1BX',1,true)//A1BX -> Black Hole
	call SaveReal(CooldownStorage,-'A1BX',1,200)//A1BX -> Black Hole
	call SaveReal(CooldownStorage,-'A1BX',2,190)//A1BX -> Black Hole
	call SaveReal(CooldownStorage,-'A1BX',3,180)//A1BX -> Black Hole
	call SaveBoolean(CooldownStorage,-'A30L',1,true)//A30L -> Black Hole
	call SaveReal(CooldownStorage,-'A30L',1,200)//A30L -> Black Hole
	call SaveReal(CooldownStorage,-'A30L',2,190)//A30L -> Black Hole
	call SaveReal(CooldownStorage,-'A30L',3,180)//A30L -> Black Hole
	call SaveReal(CooldownStorage,-'A1EL',1,3)//A1EL -> Sticky Napalm
	call SaveBoolean(CooldownStorage,-'A1EL',0,true)//A1EL -> Sticky Napalm
	call SaveReal(CooldownStorage,-'A19V',1,14)//A19V -> Flamebreak
	call SaveBoolean(CooldownStorage,-'A19V',0,true)//A19V -> Flamebreak
	call SaveReal(CooldownStorage,-'QM04',1,40)//QM04 -> Firefly
	call SaveBoolean(CooldownStorage,-'QM04',0,true)//QM04 -> Firefly
	call SaveBoolean(CooldownStorage,-'A19O',1,true)//A19O -> Flaming Lasso
	call SaveReal(CooldownStorage,-'A19O',1,90)//A19O -> Flaming Lasso
	call SaveReal(CooldownStorage,-'A19O',2,70)//A19O -> Flaming Lasso
	call SaveReal(CooldownStorage,-'A19O',3,50)//A19O -> Flaming Lasso
	call SaveBoolean(CooldownStorage,-'A1MV',1,true)//A19O -> Flaming Lasso
	call SaveReal(CooldownStorage,-'A1MV',1,90)//A19O -> Flaming Lasso
	call SaveReal(CooldownStorage,-'A1MV',2,70)//A19O -> Flaming Lasso
	call SaveReal(CooldownStorage,-'A1MV',3,50)//A19O -> Flaming Lasso
	call SaveReal(CooldownStorage,-'A1MG',1,15)//A1MG -> Cold Feet
	call SaveReal(CooldownStorage,-'A1MG',2,13)//A1MG -> Cold Feet
	call SaveReal(CooldownStorage,-'A1MG',3,11)//A1MG -> Cold Feet
	call SaveReal(CooldownStorage,-'A1MG',4,9)//A1MG -> Cold Feet
	call SaveReal(CooldownStorage,-'A1HS',1,4)//A1HS -> Ice Vortex
	call SaveBoolean(CooldownStorage,-'A1HS',0,true)//A1HS -> Ice Vortex
	call SaveReal(CooldownStorage,-'A1HQ',1,25)//A1HQ -> Chilling Touch
	call SaveBoolean(CooldownStorage,-'A1HQ',0,true)//A1HQ -> Chilling Touch
	call SaveBoolean(CooldownStorage,-'A1MI',1,true)//A1MI -> Ice Blast
	call SaveReal(CooldownStorage,-'A1MI',1,40)//A1MI -> Ice Blast
	call SaveBoolean(CooldownStorage,-'A1MI',0,true)//A1MI -> Ice Blast
	call SaveBoolean(CooldownStorage,-'A2QE',1,true)//A2QE -> Ice Blast
	call SaveReal(CooldownStorage,-'A2QE',1,40)//A2QE -> Ice Blast
	call SaveBoolean(CooldownStorage,-'A2QE',0,true)//A2QE -> Ice Blast
	call SaveReal(CooldownStorage,-'A1IM',1,9)//A1IM -> Dark Pact
	call SaveReal(CooldownStorage,-'A1IM',2,8)//A1IM -> Dark Pact
	call SaveReal(CooldownStorage,-'A1IM',3,7)//A1IM -> Dark Pact
	call SaveReal(CooldownStorage,-'A1IM',4,6)//A1IM -> Dark Pact
	call SaveReal(CooldownStorage,-'A1J7',1,20)//A1J7 -> Pounce
	call SaveReal(CooldownStorage,-'A1J7',2,16)//A1J7 -> Pounce
	call SaveReal(CooldownStorage,-'A1J7',3,12)//A1J7 -> Pounce
	call SaveReal(CooldownStorage,-'A1J7',4,8)//A1J7 -> Pounce
	call SaveBoolean(CooldownStorage,-'A1IN',1,true)//A1IN -> Shadow Dance
	call SaveReal(CooldownStorage,-'A1IN',1,75)//A1IN -> Shadow Dance
	call SaveBoolean(CooldownStorage,-'A1IN',0,true)//A1IN -> Shadow Dance
	call SaveReal(CooldownStorage,-'A2KZ',1,22)//A2KZ -> Reflection
	call SaveReal(CooldownStorage,-'A2KZ',2,20)//A2KZ -> Reflection
	call SaveReal(CooldownStorage,-'A2KZ',3,18)//A2KZ -> Reflection
	call SaveReal(CooldownStorage,-'A2KZ',4,16)//A2KZ -> Reflection
	call SaveReal(CooldownStorage,-'A0H4',1,16)//A0H4 -> Conjure Image
	call SaveBoolean(CooldownStorage,-'A0H4',0,true)//A0H4 -> Conjure Image
	call SaveReal(CooldownStorage,-'A1RI',1,140)//A1RI -> Metamorphosis
	call SaveBoolean(CooldownStorage,-'A1RI',0,true)//A1RI -> Metamorphosis
	call SaveBoolean(CooldownStorage,-'A07Q',1,true)//A07Q -> Sunder
	call SaveReal(CooldownStorage,-'A07Q',1,120)//A07Q -> Sunder
	call SaveReal(CooldownStorage,-'A07Q',2,80)//A07Q -> Sunder
	call SaveReal(CooldownStorage,-'A07Q',3,40)//A07Q -> Sunder
	call SaveReal(CooldownStorage,-'A20T',1,22)//A20T -> Diabolic Edict
	call SaveBoolean(CooldownStorage,-'A20T',0,true)//A20T -> Diabolic Edict
	call SaveReal(CooldownStorage,-'A06V',1,4)//A06V -> Lightning Storm
	call SaveBoolean(CooldownStorage,-'A06V',0,true)//A06V -> Lightning Storm
	call SaveReal(CooldownStorage,-'A1S8',1,25)//A1S8 -> Disruption
	call SaveReal(CooldownStorage,-'A1S8',2,22)//A1S8 -> Disruption
	call SaveReal(CooldownStorage,-'A1S8',3,19)//A1S8 -> Disruption
	call SaveReal(CooldownStorage,-'A1S8',4,16)//A1S8 -> Disruption
	call SaveReal(CooldownStorage,-'A1SB',1,13)//A1SB -> Soul Catcher
	call SaveBoolean(CooldownStorage,-'A1SB',0,true)//A1SB -> Soul Catcher
	call SaveReal(CooldownStorage,-'A1S4',1,2.5)//A1S4 -> Shadow Poison
	call SaveBoolean(CooldownStorage,-'A1S4',0,true)//A1S4 -> Shadow Poison
	call SaveBoolean(CooldownStorage,-'A343',1,true)//A343 -> Demonic Purge
	call SaveReal(CooldownStorage,-'A343',1,50)//A343 -> Demonic Purge
	call SaveBoolean(CooldownStorage,-'A343',0,true)//A343 -> Demonic Purge
	call SaveBoolean(CooldownStorage,-'A34J',1,true)//A34J -> Demonic Purge
	call SaveReal(CooldownStorage,-'A07F',1,8)//A07F -> Frost Nova
	call SaveBoolean(CooldownStorage,-'A07F',0,true)//A07F -> Frost Nova
	call SaveReal(CooldownStorage,-'A08R',1,5)//A08R -> Frost Armor
	call SaveBoolean(CooldownStorage,-'A08R',0,true)//A08R -> Frost Armor
	call SaveReal(CooldownStorage,-'A053',1,44)//A053 -> Dark Ritual
	call SaveReal(CooldownStorage,-'A053',2,36)//A053 -> Dark Ritual
	call SaveReal(CooldownStorage,-'A053',3,28)//A053 -> Dark Ritual
	call SaveReal(CooldownStorage,-'A053',4,20)//A053 -> Dark Ritual
	call SaveBoolean(CooldownStorage,-'A05T',1,true)//A05T -> Chain Frost
	call SaveReal(CooldownStorage,-'A05T',1,120)//A05T -> Chain Frost
	call SaveReal(CooldownStorage,-'A05T',2,90)//A05T -> Chain Frost
	call SaveReal(CooldownStorage,-'A05T',3,60)//A05T -> Chain Frost
	call SaveBoolean(CooldownStorage,-'A08H',1,true)//A08H -> Chain Frost
	call SaveReal(CooldownStorage,-'A08H',1,120)//A08H -> Chain Frost
	call SaveReal(CooldownStorage,-'A08H',2,90)//A08H -> Chain Frost
	call SaveReal(CooldownStorage,-'A08H',3,60)//A08H -> Chain Frost
	call SaveReal(CooldownStorage,-'A07M',1,11)//A07M -> Silence
	call SaveBoolean(CooldownStorage,-'A07M',0,true)//A07M -> Silence
	call SaveBoolean(CooldownStorage,-'A04N',1,true)//A04N -> Exorcism
	call SaveReal(CooldownStorage,-'A04N',1,145)//A04N -> Exorcism
	call SaveBoolean(CooldownStorage,-'A04N',0,true)//A04N -> Exorcism
	call SaveReal(CooldownStorage,-'A0X5',1,12)//A0X5 -> Impale
	call SaveBoolean(CooldownStorage,-'A0X5',0,true)//A0X5 -> Impale
	call SaveReal(CooldownStorage,-'A0MN',1,30)//A0MN -> Voodoo
	call SaveReal(CooldownStorage,-'A0MN',2,24)//A0MN -> Voodoo
	call SaveReal(CooldownStorage,-'A0MN',3,18)//A0MN -> Voodoo
	call SaveReal(CooldownStorage,-'A0MN',4,12)//A0MN -> Voodoo
	call SaveReal(CooldownStorage,-'A02N',1,15)//A02N -> Mana Drain
	call SaveReal(CooldownStorage,-'A02N',2,12)//A02N -> Mana Drain
	call SaveReal(CooldownStorage,-'A02N',3,8)//A02N -> Mana Drain
	call SaveReal(CooldownStorage,-'A02N',4,5)//A02N -> Mana Drain
	call SaveBoolean(CooldownStorage,-'A095',1,true)//A095 -> Finger of Death
	call SaveReal(CooldownStorage,-'A095',1,160)//A095 -> Finger of Death
	call SaveReal(CooldownStorage,-'A095',2,100)//A095 -> Finger of Death
	call SaveReal(CooldownStorage,-'A095',3,40)//A095 -> Finger of Death
	call SaveReal(CooldownStorage,-'A095',4,9)//A095 -> Finger of Death
	call SaveBoolean(CooldownStorage,-'A09W',1,true)//A09W -> Finger of Death
	call SaveReal(CooldownStorage,-'A09W',1,100)//A09W -> Finger of Death
	call SaveReal(CooldownStorage,-'A09W',2,60)//A09W -> Finger of Death
	call SaveReal(CooldownStorage,-'A09W',3,20)//A09W -> Finger of Death
	call SaveReal(CooldownStorage,-'A09W',4,9)//A09W -> Finger of Death
	call SaveReal(CooldownStorage,-'A173',1,16)//A173 -> Venomous Gale
	call SaveBoolean(CooldownStorage,-'A173',0,true)//A173 -> Venomous Gale
	call SaveReal(CooldownStorage,-'A0MS',1,5)//A0MS -> Plague Ward
	call SaveBoolean(CooldownStorage,-'A0MS',0,true)//A0MS -> Plague Ward
	call SaveBoolean(CooldownStorage,-'A013',1,true)//A013 -> Poison Nova
	call SaveReal(CooldownStorage,-'A013',1,100)//A013 -> Poison Nova
	call SaveBoolean(CooldownStorage,-'A013',0,true)//A013 -> Poison Nova
	call SaveBoolean(CooldownStorage,-'A0A6',1,true)//A0A6 -> Poison Nova Upg
	call SaveReal(CooldownStorage,-'A0A6',1,100)//A0A6 -> Poison Nova Upg
	call SaveReal(CooldownStorage,-'A0A6',2,80)//A0A6 -> Poison Nova Upg
	call SaveReal(CooldownStorage,-'A0A6',3,60)//A0A6 -> Poison Nova Upg
	call SaveReal(CooldownStorage,-'A0A6',4,40)//A0A6 -> Poison Nova Upg
	call SaveReal(CooldownStorage,-'A02S',1,10)//A02S -> Shockwave
	call SaveReal(CooldownStorage,-'A02S',2,9)//A02S -> Shockwave
	call SaveReal(CooldownStorage,-'A02S',3,8)//A02S -> Shockwave
	call SaveReal(CooldownStorage,-'A02S',4,7)//A02S -> Shockwave
	call SaveReal(CooldownStorage,-'A037',1,8)//A037 -> Empower
	call SaveBoolean(CooldownStorage,-'A037',0,true)//A037 -> Empower
	call SaveReal(CooldownStorage,-'A1RD',1,20)//A1RD -> Skewer
	call SaveBoolean(CooldownStorage,-'A1RD',0,true)//A1RD -> Skewer
	call SaveBoolean(CooldownStorage,-'A29L',1,true)//A29L -> Reverse Polarity
	call SaveReal(CooldownStorage,-'A29L',1,120)//A29L -> Reverse Polarity
	call SaveReal(CooldownStorage,-'A29L',2,110)//A29L -> Reverse Polarity
	call SaveReal(CooldownStorage,-'A29L',3,100)//A29L -> Reverse Polarity
	call SaveBoolean(CooldownStorage,-'A447',1,true)//A447 -> Reverse Polarity
	call SaveReal(CooldownStorage,-'A447',1,120)//A447 -> Reverse Polarity
	call SaveReal(CooldownStorage,-'A447',2,110)//A447 -> Reverse Polarity
	call SaveReal(CooldownStorage,-'A447',3,100)//A447 -> Reverse Polarity
	call SaveReal(CooldownStorage,-'A08X',1,10)//A08X -> Grave Chill
	call SaveBoolean(CooldownStorage,-'A08X',0,true)//A08X -> Grave Chill
	call SaveReal(CooldownStorage,-'A1NA',1,4)//A1NA -> Soul Assumption
	call SaveBoolean(CooldownStorage,-'A1NA',0,true)//A1NA -> Soul Assumption
	call SaveBoolean(CooldownStorage,-'A1NE',1,true)//A1NE -> Familiars
	call SaveReal(CooldownStorage,-'A1NE',1,180)//A1NE -> Familiars
	call SaveReal(CooldownStorage,-'A1NE',2,160)//A1NE -> Familiars
	call SaveReal(CooldownStorage,-'A1NE',3,140)//A1NE -> Familiars
	call SaveReal(CooldownStorage,-'A1NE',4,9)//A1NE -> Familiars
	call SaveBoolean(CooldownStorage,-'A2IG',1,true)//A2IG -> Familiars
	call SaveReal(CooldownStorage,-'A2IG',1,180)//A2IG -> Familiars
	call SaveReal(CooldownStorage,-'A2IG',2,160)//A2IG -> Familiars
	call SaveReal(CooldownStorage,-'A2IG',3,140)//A2IG -> Familiars
	call SaveReal(CooldownStorage,-'A2IG',4,9)//A2IG -> Familiars
	call SaveReal(CooldownStorage,-'A0RW',1,14)//A0RW -> Reality Rift
	call SaveReal(CooldownStorage,-'A0RW',2,12)//A0RW -> Reality Rift
	call SaveReal(CooldownStorage,-'A0RW',3,10)//A0RW -> Reality Rift
	call SaveReal(CooldownStorage,-'A0RW',4,8)//A0RW -> Reality Rift
	call SaveBoolean(CooldownStorage,-'A03O',1,true)//A03O -> Phantasm
	call SaveReal(CooldownStorage,-'A03O',1,100)//A03O -> Phantasm
	call SaveBoolean(CooldownStorage,-'A03O',0,true)//A03O -> Phantasm
	call SaveReal(CooldownStorage,-'A332',1,50)//A332 -> Arctic Burn
	call SaveReal(CooldownStorage,-'A332',2,40)//A332 -> Arctic Burn
	call SaveReal(CooldownStorage,-'A332',3,30)//A332 -> Arctic Burn
	call SaveReal(CooldownStorage,-'A332',4,20)//A332 -> Arctic Burn
	call SaveReal(CooldownStorage,-'A2LA',1,7)//A2LA -> Splinter Blast
	call SaveBoolean(CooldownStorage,-'A2LA',0,true)//A2LA -> Splinter Blast
	call SaveReal(CooldownStorage,-'A2LB',1,17)//A2LB -> Cold Embrace
	call SaveReal(CooldownStorage,-'A2LB',2,16)//A2LB -> Cold Embrace
	call SaveReal(CooldownStorage,-'A2LB',3,15)//A2LB -> Cold Embrace
	call SaveReal(CooldownStorage,-'A2LB',4,14)//A2LB -> Cold Embrace
	call SaveBoolean(CooldownStorage,-'A0Z0',1,true)//A0Z0 -> Winter's Curse
	call SaveReal(CooldownStorage,-'A0Z0',1,90)//A0Z0 -> Winter's Curse
	call SaveReal(CooldownStorage,-'A0Z0',2,80)//A0Z0 -> Winter's Curse
	call SaveReal(CooldownStorage,-'A0Z0',3,70)//A0Z0 -> Winter's Curse
	call SaveReal(CooldownStorage,-'A2M1',1,14)//A2M1 -> Flux
	call SaveBoolean(CooldownStorage,-'A2M1',0,true)//A2M1 -> Flux
	call SaveReal(CooldownStorage,-'A2LM',1,32)//A2LM -> Magnetic Field
	call SaveBoolean(CooldownStorage,-'A2LM',0,true)//A2LM -> Magnetic Field
	call SaveReal(CooldownStorage,-'A2LL',1,4)//A2LL -> Spark Wraith
	call SaveBoolean(CooldownStorage,-'A2LL',0,true)//A2LL -> Spark Wraith
	call SaveBoolean(CooldownStorage,-'A2M0',1,true)//A2M0 -> Tempest Double
	call SaveReal(CooldownStorage,-'A2M0',1,65)//A2M0 -> Tempest Double
	call SaveReal(CooldownStorage,-'A2M0',2,60)//A2M0 -> Tempest Double
	call SaveReal(CooldownStorage,-'A2M0',3,55)//A2M0 -> Tempest Double
	call SaveReal(CooldownStorage,-'A2M0',4,40)//A2M0 -> Tempest Double
	call SaveReal(CooldownStorage,-'A2QM',1,22)//A2QM -> Boulder Smash
	call SaveReal(CooldownStorage,-'A2QM',2,18)//A2QM -> Boulder Smash
	call SaveReal(CooldownStorage,-'A2QM',3,14)//A2QM -> Boulder Smash
	call SaveReal(CooldownStorage,-'A2QM',4,10)//A2QM -> Boulder Smash
	call SaveReal(CooldownStorage,-'A2TJ',1,16)//A2TJ -> Rolling Boulder
	call SaveReal(CooldownStorage,-'A2TJ',2,12)//A2TJ -> Rolling Boulder
	call SaveReal(CooldownStorage,-'A2TJ',3,8)//A2TJ -> Rolling Boulder
	call SaveReal(CooldownStorage,-'A2TJ',4,4)//A2TJ -> Rolling Boulder
	call SaveReal(CooldownStorage,-'A2QI',1,13)//A2QI -> Geomagnetic Grip
	call SaveBoolean(CooldownStorage,-'A2QI',0,true)//A2QI -> Geomagnetic Grip
	call SaveBoolean(CooldownStorage,-'A2TI',1,true)//A2TI -> Magnetize
	call SaveReal(CooldownStorage,-'A2TI',1,80)//A2TI -> Magnetize
	call SaveBoolean(CooldownStorage,-'A2TI',0,true)//A2TI -> Magnetize
	call SaveReal(CooldownStorage,-'A2QT',1,12)//A2QT -> Fortune's End
	call SaveBoolean(CooldownStorage,-'A2QT',0,true)//A2QT -> Fortune's End
	call SaveReal(CooldownStorage,-'A2T5',1,12)//A2T5 -> Fate's Edict
	call SaveBoolean(CooldownStorage,-'A2T5',0,true)//A2T5 -> Fate's Edict
	call SaveReal(CooldownStorage,-'A1PH',1,12)//A1PH -> Soul Steal
	call SaveBoolean(CooldownStorage,-'A1PH',0,true)//A1PH -> Soul Steal
//	call SaveReal(CooldownStorage,-'A34A',1,13)//A34A -> Cheat Death
//	call SaveReal(CooldownStorage,-'A34A',2,12)//A34A -> Cheat Death
//	call SaveReal(CooldownStorage,-'A34A',3,11)//A34A -> Cheat Death
//	call SaveReal(CooldownStorage,-'A34A',4,10)//A34A -> Cheat Death
	call SaveBoolean(CooldownStorage,-'A33U',1,true)//A33U -> Lightning Grapple
	call SaveReal(CooldownStorage,-'A33U',1,20)//A33U -> Lightning Grapple
	call SaveBoolean(CooldownStorage,-'A33U',0,true)//A33U -> Lightning Grapple
	call SaveReal(CooldownStorage,-'Z601',1,22)//Z601 -> Sun Strike
	call SaveBoolean(CooldownStorage,-'Z601',0,true)//Z601 -> Sun Strike
	call SaveReal(CooldownStorage,-'Z602',1,28)//Z602 -> Chaos Meteor
	call SaveBoolean(CooldownStorage,-'Z602',0,true)//Z602 -> Chaos Meteor
	call SaveReal(CooldownStorage,-'Z603',1,25)//Z603 -> Forge Spirit
	call SaveBoolean(CooldownStorage,-'Z603',0,true)//Z603 -> Forge Spirit
	call SaveReal(CooldownStorage,-'Z604',1,11)//Z604 -> Cold Snap
	call SaveBoolean(CooldownStorage,-'Z604',0,true)//Z604 -> Cold Snap
	call SaveReal(CooldownStorage,-'Z605',1,35)//Z605 -> Ghost Walk
	call SaveBoolean(CooldownStorage,-'Z605',0,true)//Z605 -> Ghost Walk
	call SaveReal(CooldownStorage,-'Z606',1,24)//Z606 -> Ice Wall
	call SaveReal(CooldownStorage,-'Z606',2,21)//Z606 -> Ice Wall
	call SaveReal(CooldownStorage,-'Z606',3,18)//Z606 -> Ice Wall
	call SaveReal(CooldownStorage,-'Z606',4,15)//Z606 -> Ice Wall
	call SaveReal(CooldownStorage,-'Z607',1,9)//Z607 -> Alacrity
	call SaveBoolean(CooldownStorage,-'Z607',0,true)//Z607 -> Alacrity
	call SaveReal(CooldownStorage,-'Z608',1,28)//Z608 -> Tornado
	call SaveReal(CooldownStorage,-'Z608',2,26)//Z608 -> Tornado
	call SaveReal(CooldownStorage,-'Z608',3,24)//Z608 -> Tornado
	call SaveReal(CooldownStorage,-'Z608',4,22)//Z608 -> Tornado
	call SaveReal(CooldownStorage,-'Z609',1,28)//Z609 -> EMP
	call SaveReal(CooldownStorage,-'Z609',2,26)//Z609 -> EMP
	call SaveReal(CooldownStorage,-'Z609',3,24)//Z609 -> EMP
	call SaveReal(CooldownStorage,-'Z609',4,22)//Z609 -> EMP
	call SaveReal(CooldownStorage,-'Z610',1,18)//Z610 -> Deafening Blast
	call SaveBoolean(CooldownStorage,-'Z610',0,true)//Z610 -> Deafening Blast
	call SaveReal(CooldownStorage,-'A3K5',1,18)//Z610 -> Deafening Blast
	call SaveBoolean(CooldownStorage,-'A3K5',0,true)//Z610 -> Deafening Blast
	call SaveReal(CooldownStorage,-'A40K',1,10)//A40K -> Unus
	call SaveBoolean(CooldownStorage,-'A40K',0,true)//A40K -> Unus
	call SaveReal(CooldownStorage,-'A40S',1,30)//A40S -> Unus
	call SaveBoolean(CooldownStorage,-'A40S',0,true)//A40S -> Unus
	call SaveReal(CooldownStorage,-'A40L',1,10)//A40L -> Duos
	call SaveBoolean(CooldownStorage,-'A40L',0,true)//A40L -> Duos
	call SaveReal(CooldownStorage,-'A40T',1,30)//A40T -> Duos
	call SaveBoolean(CooldownStorage,-'A40T',0,true)//A40T -> Duos
	call SaveReal(CooldownStorage,-'A40M',1,10)//A40M -> Tertius
	call SaveBoolean(CooldownStorage,-'A40M',0,true)//A40M -> Tertius
	call SaveReal(CooldownStorage,-'A40U',1,30)//A40U -> Tertius
	call SaveBoolean(CooldownStorage,-'A40U',0,true)//A40U -> Tertius
	call SaveBoolean(CooldownStorage,-'A40N',1,true)//A40N -> Denique
	call SaveReal(CooldownStorage,-'A40N',1,100)//A40N -> Denique
	call SaveBoolean(CooldownStorage,-'A40N',0,true)//A40N -> Denique
	call SaveBoolean(CooldownStorage,-'A40V',1,true)//A40V -> Denique
	call SaveReal(CooldownStorage,-'A40V',1,100)//A40V -> Denique
	call SaveBoolean(CooldownStorage,-'A40V',0,true)//A40V -> Denique
	call SaveReal(CooldownStorage,-'A0QV',1,30)//A0QV -> Raise Dead
	call SaveBoolean(CooldownStorage,-'A0QV',0,true)//A0QV -> Raise Dead
	call SaveReal(CooldownStorage,-'A43Y',1,20)//A43Y -> Watcher
	call SaveReal(CooldownStorage,-'A43Y',2,15)//A43Y -> Watcher
	call SaveReal(CooldownStorage,-'A43Y',3,10)//A43Y -> Watcher
	call SaveReal(CooldownStorage,-'A43Y',4,5)//A43Y -> Watcher
	call SaveReal(CooldownStorage,-'A00T',1,26)//A00T -> Urna Swarm
	call SaveReal(CooldownStorage,-'A00T',2,19)//A00T -> Urna Swarm
	call SaveReal(CooldownStorage,-'A00T',3,12)//A00T -> Urna Swarm
	call SaveReal(CooldownStorage,-'A00T',4,5)//A00T -> Urna Swarm
	call SaveBoolean(CooldownStorage,-'A46J',1,true)//A46J -> Mind Control
	call SaveReal(CooldownStorage,-'A46J',1,50)//A46J -> Mind Control
	call SaveBoolean(CooldownStorage,-'A46J',0,true)//A46J -> Mind Control
	call SaveReal(CooldownStorage,-'A0EC',1,12)//A0EC -> Bloodrage
	call SaveReal(CooldownStorage,-'A0EC',2,10)//A0EC -> Bloodrage
	call SaveReal(CooldownStorage,-'A0EC',3,8)//A0EC -> Bloodrage
	call SaveReal(CooldownStorage,-'A0EC',4,6)//A0EC -> Bloodrage
	call SaveReal(CooldownStorage,-'A44U',1,20)//A44U -> Ante Up
	call SaveBoolean(CooldownStorage,-'A44U',0,true)//A44U -> Ante Up
	call SaveReal(CooldownStorage,-'A451',1,16)//A451 -> Firewall
	call SaveBoolean(CooldownStorage,-'A451',0,true)//A451 -> Firewall
	call SaveReal(CooldownStorage,-'A454',1,16)//A454 -> Fire Stomp
	call SaveBoolean(CooldownStorage,-'A454',0,true)//A454 -> Fire Stomp
	call SaveBoolean(CooldownStorage,-'A456',1,true)//A456 -> Inferno
	call SaveReal(CooldownStorage,-'A456',1,60)//A456 -> Inferno
	call SaveReal(CooldownStorage,-'A456',2,55)//A456 -> Inferno
	call SaveReal(CooldownStorage,-'A456',3,50)//A456 -> Inferno
	call SaveReal(CooldownStorage,-'A45W',1,14)//A45W -> Vital Strike
	call SaveBoolean(CooldownStorage,-'A45W',0,true)//A45W -> Vital Strike
	call SaveReal(CooldownStorage,-'A45X',1,11)//A45X -> Arrow Shower
	call SaveBoolean(CooldownStorage,-'A45X',0,true)//A45X -> Arrow Shower
	call SaveBoolean(CooldownStorage,-'A461',1,true)//A461 -> Swoop Down
	call SaveReal(CooldownStorage,-'A461',1,60)//A461 -> Swoop Down
	call SaveBoolean(CooldownStorage,-'A461',0,true)
	
	//beastmaster
	call SaveReal(CooldownStorage,-'A301',1,40)//Summon boar
	call SaveBoolean(CooldownStorage,-'A301',0,true)
	
	call SaveReal(CooldownStorage,-'A300',1,40)//Summon eagle
	call SaveBoolean(CooldownStorage,-'A300',0,true)
	
	
	//kotl
	call SaveReal(CooldownStorage,-'A10U',1,15)//A10U -> Recall
	
	call SaveReal(CooldownStorage,-'A11X',1,20)//A11X -> Blinding Light
	call SaveReal(CooldownStorage,-'A11X',2,16)//A11X -> Blinding Light
	call SaveReal(CooldownStorage,-'A11X',3,12)//A11X -> Blinding Light
	
	//tuskar
	call SaveReal(CooldownStorage,-'A3DF',1,12)//A3DF -> Walrus Kick
	//doom
	call SaveReal(CooldownStorage,-'A1OQ',1,4)//A1OQ -> Chain Lightning
	call SaveReal(CooldownStorage,-'A1OR',1,5)//A1OR -> Frost Armor
	call SaveReal(CooldownStorage,-'A1OS',1,12)//A1OS -> Thunder Clap
	call SaveReal(CooldownStorage,-'A1OT',1,18)//A1OT -> Mana Burn
	call SaveReal(CooldownStorage,-'A1OU',1,5)//A1OU -> Purge
	call SaveReal(CooldownStorage,-'A1OV',1,8)//A1OV -> Shockwave
	call SaveReal(CooldownStorage,-'A1P0',1,20)//A1P0 -> War Stomp
	call SaveReal(CooldownStorage,-'A1P4',1,70)//A1P4 -> Tornado
	call SaveReal(CooldownStorage,-'A1P5',1,25)//A1P5 -> Raise Dead
	call SaveReal(CooldownStorage,-'A1P6',1,20)//A1P6 -> Ensnare
	call SaveReal(CooldownStorage,-'A36K',1,30)//A36K -> Hurl Boulder (Golem Doom)
	
	//sf
	call SaveReal(CooldownStorage,-'A0FH',1,10)//A0FH -> Shadowraze
	call SaveBoolean(CooldownStorage,-'A0FH',0,true)//A0FH -> Shadowraze
	call SaveReal(CooldownStorage,-'A0F0',1,10)//A0F0 -> Shadowraze
	call SaveBoolean(CooldownStorage,-'A0F0',0,true)//A0F0 -> Shadowraze
	
	//balanar
	call SaveReal(CooldownStorage,-'A08C',1,12)//A08C -> Crippling Fear
	call SaveBoolean(CooldownStorage,-'A08C',0,true)//A08C -> Crippling Fear
	
	//timber
	call SaveReal(CooldownStorage,-'A43Q',1,8)//A43Q -> Chakram Second
	call SaveBoolean(CooldownStorage,-'A43Q',0,true)//A43Q -> Chakram Second
	
	//treant
	call SaveReal(CooldownStorage,-'A01V',1,25)//A01V -> Eyes in the Forest
	
	
	
	
	
	
endfunction

function InitBaseRects takes nothing returns nothing
	set ScouBotMeleeSpawnRect=Rect(6176.,3136.,6400.,3392.)
	set ScouMidMeleeSpawnRect=Rect(3616.,3584.,3872.,3872.)
	set ScouTopMeleeSpawnRect=Rect(2304.,5280.,2752.,5728.)
	set gg_rct_Hero_Creation_UD=Rect(6176.,5952.,6624.,6240.)
	set SentBotRangeSpawnRect=Rect(-4224.,-6848.,-3968.,-6592.)
	set SentTopRangeSpawnRect=Rect(-6304.,-4384.,-6080.,-4224.)
	set SentMidRangeSpawnRect=Rect(-4928.,-5760.,-4736.,-5536.)
	set ScouBotRangeSpawnRect=Rect(6048.,3424.,6304.,3776.)
	set ScouMidRangeSpawnRect=Rect(4128.,3776.,4352.,4032.)
	set ScouTopRangeSpawnRect=Rect(2752.,5408.,3040.,5632.)
	set gg_rct_Hero_Creation_NE=Rect(-7040.,-6912.,-6688.,-6656.)
	set SentBotMeleeSpawnRect=Rect(-3648.,-6880.,-3424.,-6688.)
	set SentTopMeleeSpawnRect=Rect(-6336.,-4224.,-5984.,-3904.)
	set SentMidMeleeSpawnRect=Rect(-4896.,-5504.,-4608.,-5184.)
	set BottomRuneSpawnRect=Rect(2912.,-2944.,3104.,-2720.)
	set F4=Rect(5696.,5504.,7296.,7392.)
	set G4=Rect(-7680.,-8032.,-6176.,-6240.)
	set TopRuneSpawnRect=Rect(-2464.,1536.,-2240.,1760.)
	set NR_Und_Ar=Rect(4480,-1184,4512,-1216)
	set NR_Elf_Ar=Rect(-3328.,-416.,-3104.,-96.)
	set NR_Elf_Cr=Rect(1440.,-4096.,1728.,-3872.)
	set NR_Und_Bpr=Rect(-4576.,3328.,-4448.,3488.)
	set NR_Und_Pr=Rect(-3264.,4192.,-2912.,4320.)
	set NR_Elf_Pr=Rect(2848.,-5088.,3072.,-4928.)
	set NR_Und_TRr=Rect(-1824.,2240.,-1472.,2464.)
	set NR_Elf_BRr=Rect(3008.,-3776.,3136.,-3648.)
	set NR_Und_BBr=Rect(1184.,2976.,1280.,3104.)
	set NR_Elf_OldSmr=Rect(-512.,-3648.,-320.,-3520.)
	set gg_rct_Allpick_Sent=Rect(-7104.,6656.,-6848.,6912.)
	set gg_rct_Allpick_Scourge=Rect(-7104.,6656.,-6880.,6880.)
	set RoshanSpawnRect=Rect(4192,-2272,4224,-2304)
	set NR_Und_A=Rect(4000,-736,4768,-1568)
	set NR_Elf_A=Rect(-3552.,-768.,-2528.,320.)
	set NR_Elf_C=Rect(1056.,-5216.,2368.,-3744.)
	set NR_Und_Bp=Rect(-5120.,3008.,-3648.,4320.)
	set NR_Und_P=Rect(-3456.,3808.,-2656.,4864.)
	set NR_Elf_P=Rect(2272.,-6080.,3776.,-4928.)
	set NR_Und_TR=Rect(-1888.,2208.,-992.,3040.)
	set NR_Und_BB=Rect(416.,2624.,1632.,3648.)
	set NR_Elf_BR=Rect(2592.,-4800.,3744.,-3328.)
	set NR_Elf_OldSm=Rect(-1024.,-3808.,192.,-2752.)
	set FountainRectFrogSent=Rect(-7936.,-7776.,-5920.,-5760.)
	set FountainRectFrogScourge=Rect(5504.,5184.,7744.,7136.)
	set NR_Uld_OldSm=Rect(-800.,3072.,64.,4032.)
	set NR_Uld_OldSmr=Rect(-384.,3392.,-192.,3520.)
	set NR_Elf_Roof=Rect(-1728.,-4992,-768.,-3840.)
	set NR_Elf_Roofr=Rect(-1152.,-4704.,-960.,-4480.)
	set J5=Rect(-480.,-800.,-256.,-512.)
	set IA=Rect(-8192.,-3712.,-7008.,-2144.)
	set OA=Rect(-3360.,-8192.,-1472.,-7648.)
	set BA=Rect(-2528.,-7840.,-1696.,-7488.)
	set CA=Rect(-2336.,-7584.,-1600.,-7456.)
	set DA=Rect(-8192.,2016.,-6816.,2880.)
	set EA=Rect(6880.,-3328.,8000.,-2624.)
	set Waypoints_ScMidSpawn=Rect(3904.,2976.,4160.,3264.)
	set Waypoints_ScTopSpawn=Rect(2336.,5952.,2592.,6240.)
	set Waypoints_ScBotSpawn=Rect(6304.,1984.,6560.,2272.)
	set Waypoints_SentBotSpawn=Rect(-3328.,-6912.,-3072.,-6624.)
	set Waypoints_SentMidSpawn=Rect(-4384.,-4800.,-4128.,-4512.)
	set Waypoints_SentTopSpawn=Rect(-6432.,-3840.,-6176.,-3552.)
	
	set RestrictedRegion=CreateRegion()
	call RegionAddRect(RestrictedRegion,Rect(-7968.,5216.,-7456.,5920.))
	call RegionAddRect(RestrictedRegion,Rect(-8064.,2880.,-7648.,4512.))
	call RegionAddRect(RestrictedRegion,Rect(-3296.,3712.,-2688.,3968.))
	call RegionAddRect(RestrictedRegion,Rect(-2400.,2016.,-1952.,2624.))
	call RegionAddRect(RestrictedRegion,Rect(-2016.,1600.,-1216.,2048.))
	call RegionAddRect(RestrictedRegion,Rect(-2144.,2528.,-1888.,2944.))
	call RegionAddRect(RestrictedRegion,Rect(-1280.,1728.,-736.,2176.))
	call RegionAddRect(RestrictedRegion,Rect(-1696.,-768.,-1376.,-448.))
	call RegionAddRect(RestrictedRegion,Rect(-576.,.0,-352.,256.))
	call RegionAddRect(RestrictedRegion,Rect(3104.,-2784.,3680.,-2304.))
	call RegionAddRect(RestrictedRegion,Rect(3264.,-3040.,3872.,-2656.))
	call RegionAddRect(RestrictedRegion,Rect(4960.,-3104.,5632.,-2816.))
	call RegionAddRect(RestrictedRegion,Rect(4896.,-3744.,5280.,-3456.))
	call RegionAddRect(RestrictedRegion,Rect(7488.,-3520.,8192.,-2336.))
	call RegionAddRect(RestrictedRegion,Rect(6656.,-3328.,7808.,-2656.))
	call RegionAddRect(RestrictedRegion,Rect(7104.,-8192.,8192.,-5920.))
	call RegionAddRect(RestrictedRegion,Rect(5952.,-8192.,7200.,-7712.))
	call RegionAddRect(RestrictedRegion,Rect(7168.,-6240.,8128.,-5184.))
	call RegionAddRect(RestrictedRegion,Rect(5824.,-8032.,6400.,-7776.))
	call RegionAddRect(RestrictedRegion,Rect(6976.,-6560.,7488.,-5920.))
	call RegionAddRect(RestrictedRegion,Rect(-5856.,2944.,-5600.,3200.))
	call RegionAddRect(RestrictedRegion,Rect(6784.,-7776.,7264.,-7456.))
	call RegionAddRect(RestrictedRegion,Rect(-8192.,-8128.,5472.,-7648.))
	call RegionAddRect(RestrictedRegion,Rect(2368.,-7904.,2688.,-7584.))
	call RegionAddRect(RestrictedRegion,Rect(-1664.,-7808.,-1344.,-7552.))
	call RegionAddRect(RestrictedRegion,Rect(-2944.,-8192.,-1664.,-7680.))
	call RegionAddRect(RestrictedRegion,Rect(-4000.,-8192.,-3168.,-7616.))
	call RegionAddRect(RestrictedRegion,Rect(-5760.,-8000.,-5184.,-7584.))
	call RegionAddRect(RestrictedRegion,Rect(-3296.,3744.,-3104.,3872.))
	call RegionAddRect(RestrictedRegion,Rect(-8192.,-8192.,-6720.,-7744.))
	call RegionAddRect(RestrictedRegion,Rect(-8192.,-6432.,-7456.,-4928.))
	call RegionAddRect(RestrictedRegion,Rect(-8192.,-8128.,-7904.,8160.))
	call RegionAddRect(RestrictedRegion,Rect(-7744.,3936.,-7328.,5600.))
	call RegionAddRect(RestrictedRegion,Rect(-7680.,1984.,-6560.,2816.))
	call RegionAddRect(RestrictedRegion,Rect(-7776.,1696.,-6944.,2176.))
	call RegionAddRect(RestrictedRegion,Rect(-8032.,-3040.,-7680.,-2720.))
	call RegionAddRect(RestrictedRegion,Rect(-7904.,-2656.,-7552.,-2336.))
	call RegionAddRect(RestrictedRegion,Rect(-3936.,-2720.,-3584.,-2400.))
	call RegionAddRect(RestrictedRegion,Rect(-3168.,-1952.,-2912.,-1696.))
	call RegionAddRect(RestrictedRegion,Rect(-4128.,-1632.,-3776.,-1152.))
	call RegionAddRect(RestrictedRegion,Rect(-4992.,-1792.,-3968.,-1440.))
	call RegionAddRect(RestrictedRegion,Rect(-5536.,-1664.,-4832.,-1280.))
	call RegionAddRect(RestrictedRegion,Rect(-2304.,3872.,-2048.,4096.))
	call RegionAddRect(RestrictedRegion,Rect(-5664.,-1440.,-5344.,.0))
	call RegionAddRect(RestrictedRegion,Rect(-5824.,-1504.,-5472.,-544.))
	call RegionAddRect(RestrictedRegion,Rect(-5216.,-1216.,-4480.,-384.))
	call RegionAddRect(RestrictedRegion,Rect(-5632.,448.,-5152.,1856.))
	call RegionAddRect(RestrictedRegion,Rect(-5856.,1440.,-5248.,2592.))
	call RegionAddRect(RestrictedRegion,Rect(-5408.,1888.,-4928.,2368.))
	call RegionAddRect(RestrictedRegion,Rect(-5056.,1664.,-4064.,2144.))
	call RegionAddRect(RestrictedRegion,Rect(-4320.,1344.,-3808.,1952.))
	call RegionAddRect(RestrictedRegion,Rect(-4224.,1440.,-3200.,2016.))
	call RegionAddRect(RestrictedRegion,Rect(-2112.,3424.,-1856.,3744.))
	call RegionAddRect(RestrictedRegion,Rect(-2400.,640.,-2208.,896.))
	call RegionAddRect(RestrictedRegion,Rect(-3392.,640.,-3200.,896.))
	call RegionAddRect(RestrictedRegion,Rect(-3744.,-1024.,-3232.,384.))
	call RegionAddRect(RestrictedRegion,Rect(-2016.,-5504.,-1664.,-4768.))
	call RegionAddRect(RestrictedRegion,Rect(-1760.,-5248.,-1312.,-4800.))
	call RegionAddRect(RestrictedRegion,Rect(896.,-3328.,1088.,-3072.))
	call RegionAddRect(RestrictedRegion,Rect(2816.,-3488.,3008.,-3232.))
	call RegionAddRect(RestrictedRegion,Rect(1568.,-2976.,1760.,-2656.))
	call RegionAddRect(RestrictedRegion,Rect(-768.,-1344.,-480.,-1024.))
	call RegionAddRect(RestrictedRegion,Rect(1152.,-6560.,1376.,-6272.))
	call RegionAddRect(RestrictedRegion,Rect(1216.,-6368.,1504.,-6176.))
	call RegionAddRect(RestrictedRegion,Rect(-1376.,-6784.,-1184.,-6528.))
	call RegionAddRect(RestrictedRegion,Rect(7616.,-6528.,8192.,8160.))
	call RegionAddRect(RestrictedRegion,Rect(7072.,-2304.,7264.,-2048.))
	call RegionAddRect(RestrictedRegion,Rect(-7872.,7872.,8192.,8192.))
	call RegionAddRect(RestrictedRegion,Rect(1792.,7776.,2112.,8192.))
	call RegionAddRect(RestrictedRegion,Rect(-2656.,.0,-2496.,256.))
	call RegionAddRect(RestrictedRegion,Rect(-768.,7232.,-416.,7424.))
	call RegionAddRect(RestrictedRegion,Rect(-7968.,5472.,-7648.,5792.))
	call RegionAddRect(RestrictedRegion,Rect(1120.,7904.,1312.,8160.))
	call RegionAddRect(RestrictedRegion,Rect(736.,4480.,1120.,4800.))
	call RegionAddRect(RestrictedRegion,Rect(2208.,4928.,2400.,5152.))
	call RegionAddRect(RestrictedRegion,Rect(576.,4384.,1120.,4928.))
	call RegionAddRect(RestrictedRegion,Rect(2560.,4160.,2784.,4576.))
	call RegionAddRect(RestrictedRegion,Rect(6208.,7488.,8192.,8192.))
	call RegionAddRect(RestrictedRegion,Rect(576.,4256.,1024.,4672.))
	call RegionAddRect(RestrictedRegion,Rect(544.,4352.,992.,4768.))
	call RegionAddRect(RestrictedRegion,Rect(704.,2496.,1376.,2784.))
	call RegionAddRect(RestrictedRegion,Rect(-2240.,1792.,-1856.,2240.))
	call RegionAddRect(RestrictedRegion,Rect(-1472.,1472.,-992.,1728.))
	call RegionAddRect(RestrictedRegion,Rect(2368.,-3264.,2656.,-2944.))
	call RegionAddRect(RestrictedRegion,Rect(2624.,-3648.,2816.,-2912.))
	call RegionAddRect(RestrictedRegion,Rect(2464.,-3456.,2656.,-3200.))
	call RegionAddRect(RestrictedRegion,Rect(2784.,-3232.,2976.,-2976.))
	call RegionAddRect(RestrictedRegion,Rect(2784.,-3424.,2976.,-3168.))
	call RegionAddRect(RestrictedRegion,Rect(7328.,7808.,8192.,8192.))
	call RegionAddRect(RestrictedRegion,Rect(1984.,7584.,3296.,8192.))
	call RegionAddRect(RestrictedRegion,Rect(2240.,7392.,2560.,8192.))
	call RegionAddRect(RestrictedRegion,Rect(-1888.,416.,-1696.,576.))
	call RegionAddRect(RestrictedRegion,Rect(7776.,2720.,8192.,3648.))
	call RegionAddRect(RestrictedRegion,Rect(5280.,640.,5664.,1184.))
	call RegionAddRect(RestrictedRegion,Rect(-3104.,2720.,-2624.,3232.))
	call RegionAddRect(RestrictedRegion,Rect(-7572,-8203,-6119,-7411))
	call RegionAddRect(RestrictedRegion,Rect(7775,5406,7257,7613))
	call RegionAddRect(RestrictedRegion,Rect(5744,6788,7257,7613))
	call RegionAddRect(RestrictedRegion,Rect(2507,-3777, 2654,-3458))
endfunction

function InitNeutralDots takes nothing returns nothing
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_Ar),GetRectCenterY(NR_Und_Ar),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_Ar),GetRectCenterY(NR_Und_Ar),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_Ar),GetRectCenterY(NR_Elf_Ar),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_Cr),GetRectCenterY(NR_Elf_Cr),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_Bpr),GetRectCenterY(NR_Und_Bpr),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_Pr),GetRectCenterY(NR_Und_Pr),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_Pr),GetRectCenterY(NR_Elf_Pr),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_TRr),GetRectCenterY(NR_Und_TRr),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_BRr),GetRectCenterY(NR_Elf_BRr),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_BBr),GetRectCenterY(NR_Und_BBr),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_OldSmr),GetRectCenterY(NR_Elf_OldSmr),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Uld_OldSmr),GetRectCenterY(NR_Uld_OldSmr),0))//u001 -> Ghoul
	call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_Roofr),GetRectCenterY(NR_Elf_Roofr),0))//u001 -> Ghoul
endfunction

function InitCreateTaverns takes nothing returns nothing
	local player p=Player(15)
	set TavernIntSent1=CreateUnit(p,'n008',-7360,6464,270)//n008 -> Intelligence (Sentinel - 1)
	set TavernIntSent2=CreateUnit(p,'n0GJ',-7168,6464,270)//n0GJ -> Intelligence (Sentinel - 2)
	set TavernIntScourge1=CreateUnit(p,'n01D',-6848,6464,270)//n01D -> Intelligence (Scourge - 1)
	set TavernIntScourge2=CreateUnit(p,'n0LH',-6656,6464,270)//n0LH -> Intelligence (Scourge - 2)
	set TavernAgiSent1=CreateUnit(p,'n01N',-7360,6784,270)//n01N -> Agility (Sentinel - 1)
	set TavernAgiSent2=CreateUnit(p,'n007',-7168,6784,270)//n007 -> Agility (Sentinel - 2)
	set TavernAgiScourge1=CreateUnit(p,'n005',-6848,6784,270)//n005 -> Agility (Scourge - 1)
	set TavernAgiScourge2=CreateUnit(p,'n0LI',-6656,6784,270)//n0LI -> Agility (Scourge - 2)
	set TavernStrSent1=CreateUnit(p,'n01B',-7360,7104,270)//n01B -> Strength (Sentinel - 1)
	set TavernStrSent2=CreateUnit(p,'n01P',-7168,7104,270)//n01P -> Strength (Sentinel - 2)
	set TavernStrScourge1=CreateUnit(p,'n0GK',-6848,7104,270)//n0GK -> Strength (Scourge - 1)
	set TavernStrScourge2=CreateUnit(p,'n0LJ',-6656,7104,270)//n0LJ -> Strength (Scourge - 2)
	call SetUnitColor(TavernIntSent1,ConvertPlayerColor(1))
	call SetUnitColor(TavernIntSent2,ConvertPlayerColor(1))
	call SetUnitColor(TavernIntScourge1,ConvertPlayerColor(9))
	call SetUnitColor(TavernIntScourge2,ConvertPlayerColor(9))
	call SetUnitColor(TavernAgiSent1,ConvertPlayerColor(6))
	call SetUnitColor(TavernAgiSent2,ConvertPlayerColor(6))
	call SetUnitColor(TavernAgiScourge1,ConvertPlayerColor(10))
	call SetUnitColor(TavernAgiScourge2,ConvertPlayerColor(10))
	call SetUnitColor(TavernStrSent1,ConvertPlayerColor(0))
	call SetUnitColor(TavernStrSent2,ConvertPlayerColor(0))
	call SetUnitColor(TavernStrScourge1,ConvertPlayerColor(11))
	call SetUnitColor(TavernStrScourge2,ConvertPlayerColor(11))
endfunction

function InitBuildingsSent takes nothing returns nothing
	local trigger t
	set SentFountain=CreateUnit(Sentinels[0],'nfoh',-7168,-7168,270)//nfoh -> Well of Life
	call CreateUnit(Sentinels[0],'o00G',-7168,-7168,270)//o00G -> Vision Dummy 1000/1000
	set SentinelBuilding_BlackMarket1=CreateUnit(Player15,'n12B',-6360,-6892,45)//n12B -> Black Market
	set SentinelBuilding_BlackMarket2=CreateUnit(Player15,'n12B',-6837,-5824,90)//n12B -> Black Market
	set SentinelBuilding_ShopCache=CreateUnit(Player15,'hC95',-6880,-7136,270)//hC95 -> Cache of the Quel'thelan
	set SentinelBuilding_ShopWeapon=CreateUnit(Player15,'n01K',-7264,-6688,270)//n01K -> Weapons Dealer
	set SentinelBuilding_ShopAccessorizer=CreateUnit(Player15,'nC38',-7264,-6880,270)//nC38 -> Sena The Accessorizer
	set SentinelBuilding_ShopChimaera=CreateUnit(Player15,'e025',-6624,-7136,270)//e025 -> Ancient of Wonders
	set SentinelBuilding_Shop1=CreateUnit(Player15,'n00V',-6940+64,-6368,270)//n00V -> Arcane Sanctum
	set SentinelBuilding_Shop2=CreateUnit(Player15,'n00W',-7264+0,-6496+64,270)//n00W -> Ancient Weaponry
	set SentinelBuilding_Shop3=CreateUnit(Player15,'n002',-6816+64,-6368,270)//n002 -> Supportive Vestments
	set SentinelBuilding_Shop4=CreateUnit(Player15,'n00X',-7200+64,-6368,270)//n00X -> Enchanted Artifacts
	set SentinelBuilding_Shop5=CreateUnit(Player15,'n009',-6678+64,-6432,270)//n009 -> Gateway Relics
	set SentinelBuilding_Shop6=CreateUnit(Player15,'n0HE',-7072+64,-6368,270)//n0HE -> Protectorate
	set TreeOfLife=CreateUnit(Sentinels[0],'etol',-5568,-6016,270)//etol -> The World Tree
	set Towers_Sent_Top_1=CreateUnit(Sentinels[0],'e00R',-6112,1568,90)//e00R -> Ancient Protector - level 1
	set Towers_Sent_Mid_1=CreateUnit(Sentinels[0],'e00R',-1504,-1824,45)//e00R -> Ancient Protector - level 1
	set Towers_Sent_Bot_1=CreateUnit(Sentinels[0],'e00R',4960,-6752,0)//e00R -> Ancient Protector - level 1
	set Towers_Sent_Top_2=CreateUnit(Sentinels[0],'e011',-6112,-1184,90)//e011 -> Ancient Protector - level 2
	set Towers_Sent_Mid_2=CreateUnit(Sentinels[0],'e011',-3488,-3296,45)//e011 -> Ancient Protector - level 2
	set Towers_Sent_Bot_2=CreateUnit(Sentinels[0],'e011',-608,-6688,0)//e011 -> Ancient Protector - level 2
	
	set JK=CreateTrigger()
	call TriggerRegisterUnitEvent(JK,TreeOfLife,EVENT_UNIT_DEATH)
	call TriggerAddAction(JK,function SID)
	
	call SaveRectHandle(MHT,GetHandleId(Towers_Sent_Top_2),'ABDr',Rect(-6944.,-1792.,-5248.,-224.))
	call SaveRectHandle(MHT,GetHandleId(Towers_Sent_Mid_2),'ABDr',Rect(-4128.,-3712.,-2496.,-2272.))
	call SaveRectHandle(MHT,GetHandleId(Towers_Sent_Bot_2),'ABDr',Rect(-1536.,-7424.,640.,-6048.))
	call GroupAddUnit(ABDGroup,Towers_Sent_Top_2)
	call GroupAddUnit(ABDGroup,Towers_Sent_Mid_2)
	call GroupAddUnit(ABDGroup,Towers_Sent_Bot_2)
	
	set Towers_Sent_Top_3=CreateUnit(Sentinels[0],'e00S',-6368,-4256,90)//e00S -> Ancient Protector - level 3
	set Towers_Sent_Mid_3=CreateUnit(Sentinels[0],'e00S',-4448,-4960,45)//e00S -> Ancient Protector - level 3
	set Towers_Sent_Bot_3=CreateUnit(Sentinels[0],'e00S',-3744,-6816,0)//e00S -> Ancient Protector - level 3
	set Towers_Sent_Tree1=CreateUnit(Sentinels[0],'e019',-5536,-5664,45)//e019 -> Ancient Protector - level 4
	set Towers_Sent_Tree2=CreateUnit(Sentinels[0],'e019',-5216,-6048,45)//e019 -> Ancient Protector - level 4
	set Elf_Rax_Melee_Top=CreateUnit(Sentinels[0],'eaom',-6080,-4480,90)//eaom -> Ancient of War
	set Elf_Rax_Melee_Mid=CreateUnit(Sentinels[0],'eaom',-4416,-5312,45)//eaom -> Ancient of War
	set Elf_Rax_Melee_Bot=CreateUnit(Sentinels[0],'eaom',-4032,-7040,0)//eaom -> Ancient of War
	set Elf_Rax_Range_Top=CreateUnit(Sentinels[0],'eaoe',-6656,-4480,90)//eaoe -> Ancient of Lore
	set Elf_Rax_Range_Mid=CreateUnit(Sentinels[0],'eaoe',-4864,-4992,45)//eaoe -> Ancient of Lore
	set Elf_Rax_Range_Bot=CreateUnit(Sentinels[0],'eaoe',-4032,-6528,0)//eaoe -> Ancient of Lore
	
	call SaveBaseRects(Towers_Sent_Top_3)
	call SaveBaseRects(Towers_Sent_Mid_3)
	call SaveBaseRects(Towers_Sent_Bot_3)
	call SaveBaseRects(Towers_Sent_Tree1)
	call SaveBaseRects(Towers_Sent_Tree2)
	call SaveBaseRects(Elf_Rax_Melee_Top)
	call SaveBaseRects(Elf_Rax_Melee_Mid)
	call SaveBaseRects(Elf_Rax_Melee_Bot)
	call SaveBaseRects(Elf_Rax_Range_Top)
	call SaveBaseRects(Elf_Rax_Range_Mid)
	call SaveBaseRects(Elf_Rax_Range_Bot)
	
	set EK7=CreateUnit(Sentinels[0],'emow',-5856,-5472,270)//emow -> Moon Well
	set EM7=CreateUnit(Sentinels[0],'emow',-6624,-5088,270)//emow -> Moon Well
	set EN7=CreateUnit(Sentinels[0],'emow',-5344,-3936,270)//emow -> Moon Well
	set EO7=CreateUnit(Sentinels[0],'emow',-5088,-4576,270)//emow -> Moon Well
	set EP7=CreateUnit(Sentinels[0],'emow',-3936,-5344,270)//emow -> Moon Well
	set EQ7=CreateUnit(Sentinels[0],'emow',-5088,-5536,270)//emow -> Moon Well
	set ER7=CreateUnit(Sentinels[0],'emow',-4896,-6240,270)//emow -> Moon Well
	set ES7=CreateUnit(Sentinels[0],'emow',-3808,-5856,270)//emow -> Moon Well
	set ET7=CreateUnit(Sentinels[0],'emow',-4512,-7072,270)//emow -> Moon Well
	set EU7=CreateUnit(Sentinels[0],'emow',-5472,-4704,270)//emow -> Moon Well
	set EV7=CreateUnit(Sentinels[0],'emow',-4512,-5856,270)//emow -> Moon Well
	set EW7=CreateUnit(Sentinels[0],'eaow',-6080,-5120,270)//eaow -> Ancient of Wind
	set EX7=CreateUnit(Sentinels[0],'eaow',-4544,-6528,270)//eaow -> Ancient of Wind
	set EY7=CreateUnit(Sentinels[0],'edob',-6400,-5696,270)//edob -> Hunter's Hall
	set EZ7=CreateUnit(Sentinels[0],'edob',-5248,-6848,270)//edob -> Hunter's Hall
	call SetPlayerAbilityAvailable2(Player15,'Aro1',false)//Aro1 -> Root
	call SetUnitColor(SentinelBuilding_ShopCache,PlayColor0)
	call SetUnitColor(SentinelBuilding_ShopChimaera,PlayColor0)
	call SetUnitColor(SentinelBuilding_ShopAccessorizer,PlayColor12)
	call SetUnitColor(SentinelBuilding_ShopWeapon,PlayColor12)
	call SetUnitColor(SentinelBuilding_Shop1,PlayColor12)
	call SetUnitColor(SentinelBuilding_Shop2,PlayColor12)
	call SetUnitColor(SentinelBuilding_Shop3,PlayColor12)
	call SetUnitColor(SentinelBuilding_Shop4,PlayColor12)
	call SetUnitColor(SentinelBuilding_Shop5,PlayColor12)
	call UnitAddAbility(Towers_Sent_Top_2,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Sent_Mid_2,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Sent_Bot_2,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Sent_Top_3,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Sent_Mid_3,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Sent_Bot_3,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Sent_Tree1,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Sent_Tree2,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(TreeOfLife,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Elf_Rax_Melee_Top,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Elf_Rax_Melee_Mid,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Elf_Rax_Melee_Bot,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Elf_Rax_Range_Top,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Elf_Rax_Range_Mid,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Elf_Rax_Range_Bot,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EW7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EX7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EY7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EZ7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EK7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EM7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EN7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EO7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EP7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EQ7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(ER7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(ES7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(ET7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EU7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(EV7,'Avul')//Avul -> Invulnerable
	
	set Elf_Rax_Range_Top_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Elf_Rax_Range_Top_Deathward,Elf_Rax_Range_Top,EVENT_UNIT_DEATH)
	call TriggerAddAction(Elf_Rax_Range_Top_Deathward,function MRD)
	set Elf_Rax_Range_Mid_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Elf_Rax_Range_Mid_Deathward,Elf_Rax_Range_Mid,EVENT_UNIT_DEATH)
	call TriggerAddAction(Elf_Rax_Range_Mid_Deathward,function MSD)
	set Elf_Rax_Range_Bot_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Elf_Rax_Range_Bot_Deathward,Elf_Rax_Range_Bot,EVENT_UNIT_DEATH)
	call TriggerAddAction(Elf_Rax_Range_Bot_Deathward,function MTD)
	set Elf_Rax_Melee_Top_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Elf_Rax_Melee_Top_Deathward,Elf_Rax_Melee_Top,EVENT_UNIT_DEATH)
	call TriggerAddAction(Elf_Rax_Melee_Top_Deathward,function MUD)
	set Elf_Rax_Melee_Mid_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Elf_Rax_Melee_Mid_Deathward,Elf_Rax_Melee_Mid,EVENT_UNIT_DEATH)
	call TriggerAddAction(Elf_Rax_Melee_Mid_Deathward,function MVD)
	set Elf_Rax_Melee_Bot_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Elf_Rax_Melee_Bot_Deathward,Elf_Rax_Melee_Bot,EVENT_UNIT_DEATH)
	call TriggerAddAction(Elf_Rax_Melee_Bot_Deathward,function MWD)
	
	set CirclesOfPower_1=CreateUnit(Player(1),'ncop',-7424,-7176,270)//ncop -> Circle of Power
	call ConvertCircle(CirclesOfPower_1,1)
	call BreakDummyCreate(CirclesOfPower_1)
	set CirclesOfPower_2=CreateUnit(Player(2),'ncop',-7424,-6998,270)//ncop -> Circle of Power
	call ConvertCircle(CirclesOfPower_2,2)
	call BreakDummyCreate(CirclesOfPower_2)
	set CirclesOfPower_3=CreateUnit(Player(3),'ncop',-7424,-6820,270)//ncop -> Circle of Power
	call ConvertCircle(CirclesOfPower_3,3)
	call BreakDummyCreate(CirclesOfPower_3)
	set CirclesOfPower_4=CreateUnit(Player(4),'ncop',-7424,-6592,270)//ncop -> Circle of Power
	call ConvertCircle(CirclesOfPower_4,4)
	call BreakDummyCreate(CirclesOfPower_4)
	set CirclesOfPower_5=CreateUnit(Player(5),'ncop',-7424,-6400,270)//ncop -> Circle of Power
	call ConvertCircle(CirclesOfPower_5,5)
	call BreakDummyCreate(CirclesOfPower_5)
	
	set t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,TreeOfLife,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function M3D))
	
	set IH=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(IH,EVENT_PLAYER_UNIT_DEATH)
	call TriggerAddCondition(IH,Condition(function SBD))
	call TriggerAddAction(IH,function S6D)
	
endfunction

function InitBuildingsScourge takes nothing returns nothing
	local trigger t
	set ScourgeFountain=CreateUnit(Scourges[0],'ndfl',6784,6368,270)//ndfl -> Defiled Fountain of Life
	call CreateUnit(Scourges[0],'o00G',6784,6368,270)//o00G -> Vision Dummy 1000/1000
	set ScourgeBuilding_BlackMarket1=CreateUnit(Player15,'n12B',5521,6187,180)//n12B -> Black Market
	set ScourgeBuilding_BlackMarket2=CreateUnit(Player15,'n12B',6500,5600,-45)//n12B -> Black Market
	set ScourgeBuilding_ShopGateway=CreateUnit(Player15,'nC35',6816,5984,270)//nC35 -> Demonic Artifacts
	set ScourgeBuilding_ShopWeapon=CreateUnit(Player15,'n01K',6304,6368,270)//n01K -> Weapons Dealer
	set ScourgeBuilding_ShopAccessorizer=CreateUnit(Player15,'nC38',6496,6368,270)//nC38 -> Sena The Accessorizer
	set ScourgeBuilding_ShopGraveyard=CreateUnit(Player15,'u00Q',6760,5664,270)//u00Q -> Tomb of Relics
	set ScourgeBuilding_Shop1=CreateUnit(Player15,'n00V',5920,6048+128,0)//n00V -> Arcane Sanctum
	set ScourgeBuilding_Shop2=CreateUnit(Player15,'n00W',5984+128,6432,0)//n00W -> Ancient Weaponry
	set ScourgeBuilding_Shop3=CreateUnit(Player15,'n002',5920,5920+128,0)//n002 -> Supportive Vestments
	set ScourgeBuilding_Shop4=CreateUnit(Player15,'n00X',5920+64,6304+128,0)//n00X -> Enchanted Artifacts
	set ScourgeBuilding_Shop5=CreateUnit(Player15,'n009',5984,5792+128,0)//n009 -> Gateway Relics
	set ScourgeBuilding_Shop6=CreateUnit(Player15,'n0HE',5920,6176+128,0)//n0HE -> Protectorate
	set FrozenThrone=CreateUnit(Scourges[0],'unpl',5248,4918,220)//unpl -> The Frozen Throne
	set Towers_Scourge_Top_1=CreateUnit(Scourges[0],'u00M',-4704,5920,270)//u00M -> Spirit Tower - level 1
	set Towers_Scourge_Mid_1=CreateUnit(Scourges[0],'u00M',1056,-96,270)//u00M -> Spirit Tower - level 1
	set Towers_Scourge_Bot_1=CreateUnit(Scourges[0],'u00M',6048,-2080,270)//u00M -> Spirit Tower - level 1
	set Towers_Scourge_Top_2=CreateUnit(Scourges[0],'u00D',-32,5920,270)//u00D -> Spirit Tower - level 2
	set Towers_Scourge_Mid_2=CreateUnit(Scourges[0],'u00D',2528,1824,270)//u00D -> Spirit Tower - level 2
	set Towers_Scourge_Bot_2=CreateUnit(Scourges[0],'u00D',6272,-160,270)//u00D -> Spirit Tower - level 2
	
	set YK=CreateTrigger()
	call TriggerRegisterUnitEvent(YK,FrozenThrone,EVENT_UNIT_DEATH)
	call TriggerAddAction(YK,function SKD)
	
	call SaveRectHandle(MHT,GetHandleId(Towers_Scourge_Top_2),'ABDr',Rect(-1088.,5376.,768.,6624.))
	call SaveRectHandle(MHT,GetHandleId(Towers_Scourge_Mid_2),'ABDr',Rect(1600.,1024.,3456.,2432.))
	call SaveRectHandle(MHT,GetHandleId(Towers_Scourge_Bot_2),'ABDr',Rect(5504.,-1056.,7200.,512.))
	call GroupAddUnit(ABDGroup,Towers_Scourge_Top_2)
	call GroupAddUnit(ABDGroup,Towers_Scourge_Mid_2)
	call GroupAddUnit(ABDGroup,Towers_Scourge_Bot_2)
	
	set Towers_Scourge_Top_3=CreateUnit(Scourges[0],'u00N',2976,5792,270)//u00N -> Spirit Tower - level 3
	set Towers_Scourge_Mid_3=CreateUnit(Scourges[0],'u00N',3936,3488,270)//u00N -> Spirit Tower - level 3
	set Towers_Scourge_Bot_3=CreateUnit(Scourges[0],'u00N',6368,2528,270)//u00N -> Spirit Tower - level 3
	set Towers_Scourge_Throne1=CreateUnit(Scourges[0],'u00T',4832,4832,270)//u00T -> Spirit Tower - level 4
	set Towers_Scourge_Throne2=CreateUnit(Scourges[0],'u00T',5152,4512,270)//u00T -> Spirit Tower - level 4
	
	set Und_Rax_Melee_Top=CreateUnit(Scourges[0],'usep',3392,5504,270)//usep -> Crypt
	set Und_Rax_Melee_Mid=CreateUnit(Scourges[0],'usep',4352,3584,270)//usep -> Crypt
	set Und_Rax_Melee_Bot=CreateUnit(Scourges[0],'usep',6656,2880,270)//usep -> Crypt
	set Und_Rax_Range_Top=CreateUnit(Scourges[0],'utod',3392,6080,270)//utod -> Temple of the Damned
	set Und_Rax_Range_Mid=CreateUnit(Scourges[0],'utod',3904,3904,270)//utod -> Temple of the Damned
	set Und_Rax_Range_Bot=CreateUnit(Scourges[0],'utod',6080,2944,270)//utod -> Temple of the Damned
	
	set Und_Rax_Range_Top_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Und_Rax_Range_Top_Deathward,Und_Rax_Range_Top,EVENT_UNIT_DEATH)
	call TriggerAddAction(Und_Rax_Range_Top_Deathward,function MXD)
	set Und_Rax_Range_Mid_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Und_Rax_Range_Mid_Deathward,Und_Rax_Range_Mid,EVENT_UNIT_DEATH)
	call TriggerAddAction(Und_Rax_Range_Mid_Deathward,function MYD)
	set Und_Rax_Range_Bot_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Und_Rax_Range_Bot_Deathward,Und_Rax_Range_Bot,EVENT_UNIT_DEATH)
	call TriggerAddAction(Und_Rax_Range_Bot_Deathward,function MZD)
	set Und_Rax_Melee_Top_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Und_Rax_Melee_Top_Deathward,Und_Rax_Melee_Top,EVENT_UNIT_DEATH)
	call TriggerAddAction(Und_Rax_Melee_Top_Deathward,function MAD)
	set Und_Rax_Melee_Mid_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Und_Rax_Melee_Mid_Deathward,Und_Rax_Melee_Mid,EVENT_UNIT_DEATH)
	call TriggerAddAction(Und_Rax_Melee_Mid_Deathward,function MBD)
	set Und_Rax_Melee_Bot_Deathward=CreateTrigger()
	call TriggerRegisterUnitEvent(Und_Rax_Melee_Bot_Deathward,Und_Rax_Melee_Bot,EVENT_UNIT_DEATH)
	call TriggerAddAction(Und_Rax_Melee_Bot_Deathward,function MCD)
	
	call SaveBaseRects(Towers_Scourge_Top_3)
	call SaveBaseRects(Towers_Scourge_Mid_3)
	call SaveBaseRects(Towers_Scourge_Bot_3)
	call SaveBaseRects(Towers_Scourge_Throne1)
	call SaveBaseRects(Towers_Scourge_Throne2)
	call SaveBaseRects(Und_Rax_Melee_Top)
	call SaveBaseRects(Und_Rax_Melee_Mid)
	call SaveBaseRects(Und_Rax_Melee_Bot)
	call SaveBaseRects(Und_Rax_Range_Top)
	call SaveBaseRects(Und_Rax_Range_Mid)
	call SaveBaseRects(Und_Rax_Range_Bot)
	
	set I77=CreateUnit(Scourges[0],'uzig',2656,4704,270)//uzig -> Ziggurat
	set I87=CreateUnit(Scourges[0],'uzig',3168,4064,270)//uzig -> Ziggurat
	set I97=CreateUnit(Scourges[0],'uzig',3488,4832,270)//uzig -> Ziggurat
	set ID7=CreateUnit(Scourges[0],'uzig',4128,6240,270)//uzig -> Ziggurat
	set IE7=CreateUnit(Scourges[0],'uzig',4064,5280,270)//uzig -> Ziggurat
	set IF7=CreateUnit(Scourges[0],'uzig',4384,4256,270)//uzig -> Ziggurat
	set IG7=CreateUnit(Scourges[0],'uzig',5728,4000,270)//uzig -> Ziggurat
	set IH7=CreateUnit(Scourges[0],'uzig',5536,2464,270)//uzig -> Ziggurat
	set II7=CreateUnit(Scourges[0],'uzig',5024,3744,270)//uzig -> Ziggurat
	set IJ7=CreateUnit(Scourges[0],'uzig',6880,3936,270)//uzig -> Ziggurat
	set IK7=CreateUnit(Scourges[0],'uzig',4640,2848,270)//uzig -> Ziggurat
	set IM7=CreateUnit(Scourges[0],'usap',3968,5888,270)//usap -> Sacrificial Pit
	set IN7=CreateUnit(Scourges[0],'usap',6400,3584,270)//usap -> Sacrificial Pit
	set IO7=CreateUnit(Scourges[0],'ubon',4992,5952,270)//ubon -> Boneyard
	set IP7=CreateUnit(Scourges[0],'ubon',6464,4608,270)//ubon -> Boneyard
	call SetUnitColor(ScourgeBuilding_ShopGateway,PlayColor6)
	call SetUnitColor(ScourgeBuilding_ShopAccessorizer,PlayColor12)
	call SetUnitColor(ScourgeBuilding_ShopWeapon,PlayColor12)
	call SetUnitColor(ScourgeBuilding_Shop1,PlayColor12)
	call SetUnitColor(ScourgeBuilding_Shop2,PlayColor12)
	call SetUnitColor(ScourgeBuilding_Shop3,PlayColor12)
	call SetUnitColor(ScourgeBuilding_Shop4,PlayColor12)
	call SetUnitColor(ScourgeBuilding_Shop5,PlayColor12)
	call UnitAddAbility(Towers_Scourge_Top_2,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Scourge_Mid_2,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Scourge_Bot_2,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Scourge_Top_3,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Scourge_Mid_3,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Scourge_Bot_3,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Scourge_Throne1,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Towers_Scourge_Throne2,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(FrozenThrone,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Und_Rax_Melee_Top,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Und_Rax_Melee_Mid,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Und_Rax_Melee_Bot,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Und_Rax_Range_Top,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Und_Rax_Range_Mid,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(Und_Rax_Range_Bot,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(IM7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(IN7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(IO7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(IP7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(I77,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(I87,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(I97,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(ID7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(IE7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(IF7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(IG7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(IH7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(II7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(IJ7,'Avul')//Avul -> Invulnerable
	call UnitAddAbility(IK7,'Avul')//Avul -> Invulnerable
	
	set CirclesOfPower_7=CreateUnit(Player(7),'ncop',7040,6400,270)//ncop -> Circle of Power
	call ConvertCircle(CirclesOfPower_7,7)
	call BreakDummyCreate(CirclesOfPower_7)
	set CirclesOfPower_8=CreateUnit(Player(8),'ncop',7040,6208,270)//ncop -> Circle of Power
	call ConvertCircle(CirclesOfPower_8,8)
	call BreakDummyCreate(CirclesOfPower_8)
	set CirclesOfPower_9=CreateUnit(Player(9),'ncop',7040,6016,270)//ncop -> Circle of Power
	call ConvertCircle(CirclesOfPower_9,9)
	call BreakDummyCreate(CirclesOfPower_9)
	set CirclesOfPower_10=CreateUnit(Player(10),'ncop',7040,5824,270)//ncop -> Circle of Power
	call ConvertCircle(CirclesOfPower_10,10)
	call BreakDummyCreate(CirclesOfPower_10)
	set CirclesOfPower_11=CreateUnit(Player(11),'ncop',7040-64,5632,270)//ncop -> Circle of Power
	call ConvertCircle(CirclesOfPower_11,11)
	call BreakDummyCreate(CirclesOfPower_11)
	
	set t=CreateTrigger()
	call TriggerRegisterUnitEvent(t,FrozenThrone,EVENT_UNIT_DAMAGED)
	call TriggerAddCondition(t,Condition(function MLD))
	
	set OH=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(OH,EVENT_PLAYER_UNIT_DEATH)
	call TriggerAddCondition(OH,Condition(function SLD))
	call TriggerAddAction(OH,function S5D)
	
endfunction

function InitSystemsData takes nothing returns nothing
	local integer i=0
	set BonusDamageSystemCont[0]='A17F'//A17F -> Damage Bonus System - 1
	set BonusDamageSystemCont[1]='A17G'//A17G -> Damage Bonus System - 2
	set BonusDamageSystemCont[2]='A17H'//A17H -> Damage Bonus System - 4
	set BonusDamageSystemCont[3]='A17C'//A17C -> Damage Bonus System - 8
	set BonusDamageSystemCont[4]='A17D'//A17D -> Damage Bonus System - 16
	set BonusDamageSystemCont[5]='A17E'//A17E -> Damage Bonus System - 32
	set BonusDamageSystemCont[6]='A17J'//A17J -> Damage Bonus System - 64
	set BonusDamageSystemCont[7]='A17I'//A17I -> Damage Bonus System - 128
	set BonusDamageSystemCont[8]='A17L'//A17L -> Damage Bonus System - 256
	set BonusDamageSystemCont[9]='A439'
	set BonusDamageSystemCont[10]='A43A'
	set BonusDamageSystemCont[11]='A43B'
	set MaxHPBonusSystem[0]='A378'
	set MaxHPBonusSystem[1]='A379'
	set MaxHPBonusSystem[2]='A37A'
	set MaxHPBonusSystem[3]='A37B'
	set MaxHPBonusSystem[4]='A37C'
	set MaxHPBonusSystem[5]='A37D'
	set MaxHPBonusSystem[6]='A37E'
	set MaxHPBonusSystem[7]='A37F'
	set MaxHPBonusSystem[8]='A37G'
	set MaxHPBonusSystem[9]='A37H'
	set MaxHPBonusSystem[10]='A37I'
	set MaxHPBonusSystem[11]='A37J'
	set MaxHPBonusSystem[12]='A37K'
	set MaxHPBonusSystem[13]='A37L'
	
	set BonusMSPercentSystem[0]='USS0'
	set BonusMSPercentSystem[1]='USS1'
	set BonusMSPercentSystem[2]='USS2'
	set BonusMSPercentSystem[3]='USS3'
	set BonusMSPercentSystem[4]='USS4'
	set BonusMSPercentSystem[5]='USS5'
	set BonusMSPercentSystem[6]='USS6'
	set BonusMSPercentSystem[7]='USS7'
	set BonusMSPercentSystem[8]='USS8'
	set BonusMSPercentSystem[9]='USS9'
	set EvasionContainers[0]='EVS0'
	set EvasionContainers[1]='EVS1'
	set EvasionContainers[2]='EVS2'
	set EvasionContainers[3]='EVS3'
	set EvasionContainers[4]='EVS4'
	set EvasionContainers[5]='EVS5'
	set EvasionContainers[6]='EVS6'
	set EvasionContainers[7]='EVS7'
	set EvasionContainers[8]='EVS8'
	
	set HPBonusSystem[0]='A1QE'//A1QE -> HP Bonus System - 1
	set HPBonusSystem[1]='A1QF'//A1QF -> HP Bonus System - 2
	set HPBonusSystem[2]='A1QI'//A1QI -> HP Bonus System - 4
	set HPBonusSystem[3]='A1QK'//A1QK -> HP Bonus System - 8
	set HPBonusSystem[4]='A1QJ'//A1QJ -> HP Bonus System - 16
	set HPBonusSystem[5]='A1QH'//A1QH -> HP Bonus System - 32
	set HPBonusSystem[6]='A1QO'//A1QO -> HP Bonus System - 64
	set HPBonusSystem[7]='A1QN'//A1QN -> HP Bonus System - 128
	set HPBonusSystem[8]='A1QM'//A1QM -> HP Bonus System - 256
	set HPBonusSystem[9]='A1QG'//A1QG -> HP Bonus System - 512
	set HPBonusSystem[10]='A1QQ'//A1QQ -> HP Bonus System - 1024
	set NegativeArmorSystem[0]='A1CM'//A1CM -> Negative Armor System -1
	set NegativeArmorSystem[1]='A1CK'//A1CK -> Negative Armor System -2
	set NegativeArmorSystem[2]='A1CF'//A1CF -> Negative Armor System -4
	set NegativeArmorSystem[3]='A1CI'//A1CI -> Negative Armor System -8
	set NegativeArmorSystem[4]='A1CG'//A1CG -> Negative Armor System -16
	set NegativeArmorSystem[5]='A1CH'//A1CH -> Negative Armor System -32
	set ArmletStrBonus[0]='ARM0'
	set ArmletStrBonus[1]='ARM1'
	set ArmletStrBonus[2]='ARM2'
	set ArmletStrBonus[3]='ARM3'
	set ArmletStrBonus[4]='ARM4'
	
	call HideAbility('A42L')
	
	call HideAbility('A344')//A344 -> Battle Cry
	call HideAbility('A27N')//A27N -> Null Field Level 1
	call HideAbility('A27O')//A27O -> Null Field Level 2
	call HideAbility('A27M')//A27M -> Null Field Level 3
	call HideAbility('A1IE')//A1IE -> Nightcrawler Container - 1
	call HideAbility('A1IF')//A1IF -> Nightcrawler Container - 2
	call HideAbility('A1IG')//A1IG -> Nightcrawler Container - 3
	call HideAbility('A2QA')
	call HideAbility('A27P')//A27P -> Null Field Level 4
	call HideAbility('A1CA')//A1CA -> Natural Order 1
	call HideAbility('A1C9')//A1C9 -> Natural Order 2
	call HideAbility('A1CB')//A1CB -> Natural Order 3
	call HideAbility('A1CC')//A1CC -> Natural Order 4
	call HideAbility('QF9E')
//	call HideAbility('A1LD')//A1LD -> Gust Container
	call HideAbility('A1UH')
	call HideAbility('A1HZ')//A1HZ -> Ice Vortex 1
	call HideAbility('A1I4')//A1I4 -> Ice Vortex 2
	call HideAbility('A1I3')//A1I3 -> Ice Vortex 3
	call HideAbility('A1I6')//A1I6 -> Ice Vortex 4
	call HideAbility('A29N')//A29N -> Courier Reincarnation Container
	call HideAbility('A414')
	call HideAbility('A174')//A174 -> Cranium Basher Container
	call HideAbility('A1ET')//A1ET -> Split Shot Reduction Level 1
	call HideAbility('A1ES')//A1ES -> Split Shot Reduction Level 2
	call HideAbility('A1EQ')//A1EQ -> Split Shot Reduction Level 3
	call HideAbility('A1ER')//A1ER -> Split Shot Reduction Level 4
	call HideAbility('A23F')//A23F -> Split Shot Spell Book
	call HideAbility('A1VV')//A1VV -> Spell Immunity
	
	call HideAbility(EvasionContainers[0])
	call HideAbility(EvasionContainers[1])
	call HideAbility(EvasionContainers[2])
	call HideAbility(EvasionContainers[3])
	call HideAbility(EvasionContainers[4])
	call HideAbility(EvasionContainers[5])
	call HideAbility(EvasionContainers[6])
	call HideAbility(EvasionContainers[7])
	call HideAbility(EvasionContainers[8])
	call HideAbility(BonusMSPercentSystem[0])
	call HideAbility(BonusMSPercentSystem[1])
	call HideAbility(BonusMSPercentSystem[2])
	call HideAbility(BonusMSPercentSystem[3])
	call HideAbility(BonusMSPercentSystem[4])
	call HideAbility(BonusMSPercentSystem[5])
	call HideAbility(BonusMSPercentSystem[6])
	call HideAbility(BonusMSPercentSystem[7])
	call HideAbility(BonusMSPercentSystem[8])
	call HideAbility(BonusMSPercentSystem[9])
	call HideAbility('A431')
	set stuns[0]='A420'
	set stuns[1]='A421'
	set stuns[2]='A422'
	set stuns[3]='A423'
	set stuns[4]='A424'
	set stuns[5]='A425'
	set stuns[6]='A426'
	set stuns[7]='A427'
	set stuns[8]='A428'
	set stuns[9]='A429'
	set stuns[10]='A42A'
	set stuns[11]='A42B'
	set stuns[12]='A42C'
	
	
	loop
		call PreloadQueryAdd(LoDArmourAbilityBase+i)
		set i=i+1
		exitwhen i >= LoDArmourAbilityCount
	endloop
	set i=0
	loop
		call PreloadQueryAdd(LoDArmourNegAbilityBase+i)
		set i=i+1
		exitwhen i >= LoDArmourNegAbilityCount
	endloop
	set i=0
	loop
		call PreloadQueryAdd(LoDDamageAbilityBase+i)
		set i=i+1
		exitwhen i >= LoDDamageAbilityCount
	endloop
	set i=0
	loop
		call PreloadQueryAdd(LoDRegenAbilityBase+i)
		set i=i+1
		exitwhen i >= LoDRegenAbilityCount
	endloop
	set i=0
	loop
		call PreloadQueryAdd(LoDManaRegenAbilityBase+i)
		set i=i+1
		exitwhen i >= LoDManaRegenAbilityCount
	endloop
	set i=0
	loop
		call PreloadQueryAdd(LoDAttackAbilityBase+i)
		set i=i+1
		exitwhen i >= LoDAttackAbilityCount
	endloop
	set i=0
	loop
		call PreloadQueryAdd(LoDAttackNegAbilityBase+i)
		set i=i+1
		exitwhen i >= LoDAttackNegAbilityCount
	endloop
	set i=0
	loop
		call PreloadQueryAdd(LoDDamageNegAbilityBase+i)
		set i=i+1
		exitwhen i >= LoDDamageNegAbilityCount
	endloop
	
	call PreloadQueryAdd(HPBonusSystem[0])
	call PreloadQueryAdd(HPBonusSystem[1])
	call PreloadQueryAdd(HPBonusSystem[2])
	call PreloadQueryAdd(HPBonusSystem[3])
	call PreloadQueryAdd(HPBonusSystem[4])
	call PreloadQueryAdd(HPBonusSystem[5])
	call PreloadQueryAdd(HPBonusSystem[6])
	call PreloadQueryAdd(HPBonusSystem[7])
	call PreloadQueryAdd(HPBonusSystem[8])
	call PreloadQueryAdd(HPBonusSystem[9])
	call PreloadQueryAdd(HPBonusSystem[10])
	
endfunction

function PRD_Init takes nothing returns nothing
	call SaveReal(PRDtable,-1,0,0.0038)
	call SaveReal(PRDtable,-1,1,0.0147)
	call SaveReal(PRDtable,-1,2,0.0322)
	call SaveReal(PRDtable,-1,3,0.0557)
	call SaveReal(PRDtable,-1,4,0.0847)
	call SaveReal(PRDtable,-1,5,0.1189)
	call SaveReal(PRDtable,-1,6,0.1579)
	call SaveReal(PRDtable,-1,7,0.2015)
	call SaveReal(PRDtable,-1,8,0.2493)
	call SaveReal(PRDtable,-1,9,0.3021)
	call SaveReal(PRDtable,-1,10,0.3604)
	call SaveReal(PRDtable,-1,11,0.4226)
	call SaveReal(PRDtable,-1,12,0.4811)
	call SaveReal(PRDtable,-1,13,0.5714)
	call SaveReal(PRDtable,-1,14,0.6666)
	call SaveReal(PRDtable,-1,15,0.7500)
	call SaveReal(PRDtable,-1,16,0.8235)
	call SaveReal(PRDtable,-1,17,0.8888)
	call SaveReal(PRDtable,-1,18,0.9473)
	call SaveReal(PRDtable,-1,19,1.0000)
endfunction

function Spiritbreaker_Charge_Init takes nothing returns nothing
	//walking animations
	call SaveInteger(MHT,'H06S','A1P8',11) //kunka//H06S -> Admiral, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00D','A1P8',0)  //Beastmaster//H00D -> Beastmaster, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H503','A1P8',5)  //Crabe//H503 -> Utility Lobster, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H000','A1P8',0)  //Centaur//H000 -> Centaur Warchief, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Otch','A1P8',1)  //Earthshaker//Otch -> Earthshaker, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Harf','A1P8',12) //Omniknight//Harf -> Omniknight, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Npbm','A1P8',0)  //Panda Brewmaster//Npbm -> Pandaren Brewmaster, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H001','A1P8',0)  //Sven//H001 -> Rogue Knight, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Ucrl','A1P8',1)  //Tiny, no tree//Ucrl -> Stone Giant, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Ucrl','A1P8',8)  //Tiny, with tree//Ucrl -> Stone Giant, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'O015','A1P8',1)  //Tauren Chieften//O015 -> Tauren Chieftain, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Hamg','A1P8',8)  //Roof//Hamg -> Treant Protector, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'O01F','A1P8',3)  //Wisp//O01F -> Guardian Wisp, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N01I','A1P8',4)  //Alchemist, normal//N01I -> Alchemist, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N01H','A1P8',15) //Alchemist, chemical rage 1//N01H -> Alchemist, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N01T','A1P8',15) //Alchemist, chemical rage 2//N01T -> Alchemist, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N01J','A1P8',15) //Alchemist, chemical rage 3//N01J -> Alchemist, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H600','A1P8',15) //Alchemist, chemical rage 1//H600 -> Alchemist, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H601','A1P8',15) //Alchemist, chemical rage 2//H601 -> Alchemist, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H602','A1P8',15) //Alchemist, chemical rage 3//H602 -> Alchemist, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00T','A1P8',0)  //Clockwerk//H00T -> Clockwerk Goblin, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Hlgr','A1P8',6)  //Dragon Knight//Hlgr -> Dragon Knight, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00E','A1P8',4)  //Dragon Knight, dragon 1//H00E -> Dragon Knight, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00F','A1P8',4)  //Dragon Knight, dragon 2//H00F -> Dragon Knight, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00G','A1P8',4)  //Dragon Knight, dragon 3//H00G -> Dragon Knight, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00Q','A1P8',17) //Huskar//H00Q -> Sacred Warrior, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H008','A1P8',1)  //Bristleback//H008 -> Bristleback, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02F','A1P8',5)  //Phoenix//E02F -> Phoenix, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02I','A1P8',12) //Tuskarr//E02I -> Tuskarr, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02K','A1P8',0)  //Legion Commander//E02K -> Legion Commander, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E032','A1P8',6)  //Shredder//E032 -> Goblin Shredder, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0MU','A1P8',0)  //Kaolin//N0MU -> Earth Spirit, A1P8 -> Charge of Darkness

	call SaveInteger(MHT,'Edem','A1P8',8)  //antimage//Edem -> Anti-Mage, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Usyl','A1P8',4)  //sniper//Usyl -> Dwarven Sniper, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Nbbc','A1P8',6)  //juggernaut//Nbbc -> Juggernaut, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N01O','A1P8',8)  //Syllabear, normal form//N01O -> Lone Druid, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N013','A1P8',13) //Syllabear, bear form 1//N013 -> Lone Druid, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N014','A1P8',13) //Syllabear, bear form 2//N014 -> Lone Druid, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N015','A1P8',13) //Syllabear, bear form 3//N015 -> Lone Druid, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E005','A1P8',1)  //Luna//E005 -> Moon Rider, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H0DL','A1P8',1)  //morphling//H0DL -> Ghost Revenant, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'HC49','A1P8',2)  //Siren//HC49 -> Naga Siren, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Ogrh','A1P8',0)  //Phantom Lancer//Ogrh -> Phantom Lancer, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N01V','A1P8',6)  //Potm//N01V -> Priestess of the Moon, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'HC92','A1P8',10) //Riki//HC92 -> Stealth Assassin, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N016','A1P8',8)  //Troll Warlord, normal form//N016 -> Troll Warlord, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N017','A1P8',8)  //Troll Warlord, melee1//N017 -> Troll Warlord, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'QTW2','A1P8',8)  //Troll Warlord, melee2//QTW2 -> Troll Warlord, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'QTW3','A1P8',8)  //Troll Warlord, melee3//QTW3 -> Troll Warlord, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N02B','A1P8',8)  //Troll Warlord, melee4//N02B -> Troll Warlord, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02N','A1P8',2)  //gryo, normal form//E02N -> Gyrocopter, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02O','A1P8',2)  //gryo, barrage form//E02O -> Gyrocopter, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Nbrn','A1P8',8)  //Drow Ranger//Nbrn -> Drow Ranger, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E01Y','A1P8',2)  //Templar Assassin, dat ass :3//E01Y -> Templar Assassin, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Huth','A1P8',0)  //Ursa Warrior//Huth -> Ursa Warrior, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Hvwd','A1P8',5)  //Vengeful Spirit	//Hvwd -> Vengeful Spirit, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Naka','A1P8',2)  //Bounty Hunter//Naka -> Bounty Hunter, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0M0','A1P8',0)  //Ember Spirit//N0M0 -> Ember Spirit, A1P8 -> Charge of Darkness
	
	call SaveInteger(MHT,'H501','A1P8',3)  //Sieger//H501 -> Sieger, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H502','A1P8',10)  //Sorceress//H502 -> Sorceress, A1P8 -> Charge of Darkness
	
	call SaveInteger(MHT,'H500','A1P8',9)  //formless//H500 -> Formless, A1P8 -> Charge of Darkness

	call SaveInteger(MHT,'Hjai','A1P8',6)  //Crystal Maiden//Hjai -> Crystal Maiden, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Emoo','A1P8',8)  //Enchantress//Emoo -> Enchantress, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N00B','A1P8',3)  //Fairie Dragon//N00B -> Faerie Dragon, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00A','A1P8',2)  //Chen//H00A -> Holy Knight, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Hblm','A1P8',0)  //keeper of the light//Hblm -> Keeper of the Light, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Hmbr','A1P8',20) //Zeus//Hmbr -> Lord of Olympus, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Emns','A1P8',7)  //Furion//Emns -> Prophet, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N01A','A1P8',1)  //Silencer//N01A -> Silencer, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H004','A1P8',2)  //Lina//H004 -> Slayer, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00S','A1P8',0)  //Storm//H00S -> Storm Spirit, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0MU','A1P8',0)  //Kaolin//N0MU -> Earth Spirit, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0EG','A1P8',8)  //Windrunner//N0EG -> Windrunner, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02J','A1P8',2)  //Thrall//E02J -> Disruptor, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Hmkg','A1P8',11) //Ogre//Hmkg -> Ogre Magi, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00K','A1P8',0)  //Techies//H00K -> Goblin Techies, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E00P','A1P8',4)  //Twin Headed Dragon//E00P -> Twin Head Dragon, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Ntin','A1P8',0)  //Tinker//Ntin -> Tinker, A1P8 -> Charge of Darkness
	if GetRandomReal(0,1)>0.9 then
		call SaveInteger(MHT,'Ntin','A1P8',13) //Tinker, robogobo!//Ntin -> Tinker, A1P8 -> Charge of Darkness
	endif
	call SaveInteger(MHT,'Orkn','A1P8',0)  //Rhasta//Orkn -> Shadow Shaman, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02X','A1P8',1)  //Rubick//E02X -> Grand Magus, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H0DO','A1P8',4)  //Skyhawk//H0DO -> Skywrath Mage, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'NOMD','A1P8',1)  //Oracle//A1P8 -> Charge of Darkness

	call SaveInteger(MHT,'Opgh','A1P8',6)  //Axe//Opgh -> Axe, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'U00A','A1P8',7)  //Chaos Knight//U00A -> Chaos Knight, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'UC42','A1P8',1)  //Doombringer//UC42 -> Doom Bringer, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'U007','A1P8',1)  //Niax//U007 -> Lifestealer, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Udea','A1P8',0)  //Abaddon//Udea -> Lord of Avernus, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'U008','A1P8',2)  //Lycan, normal form//U008 -> Lycanthrope, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E015','A1P8',2)  //Lycan, wolf form//E015 -> Lycanthrope, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Udre','A1P8',4)  //Night Stalker//Udre -> Night Stalker, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N00R','A1P8',3)  //Pit Lord//N00R -> Pit Lord, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'U00F','A1P8',1)  //Pudge//U00F -> Butcher, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'NC00','A1P8',2)  //Skeleton King//NC00 -> Skeleton King, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'UC91','A1P8',1)  //Slardar//UC91 -> Slithereen Guard, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00R','A1P8',1)  //Dirge, normal form//H00R -> Undying, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H07I','A1P8',8)  //Dirge, flesh golem//H07I -> Flesh Golem, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Ofar','A1P8',1)  //Tide//Ofar -> Tidehunter, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'UC11','A1P8',3)  //Magnus//UC11 -> Magnataur, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'O00J','A1P8',2)  //Spirit Breaker//O00J -> Spiritbreaker, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'U00K','A1P8',1)  //Sandking//U00K -> Sand King, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'KODO','A1P8',9)  //KODO//KODO -> Chakk, A1P8 -> Charge of Darkness

	call SaveInteger(MHT,'Hvsh','A1P8',3)  //Bloodseeker//Hvsh -> Bloodseeker, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E004','A1P8',4)  //Clinkz//E004 -> Bone Fletcher, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'U006','A1P8',1)  //Broodmother//U006 -> Broodmother, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'U000','A1P8',13) //Nerubian Assassin//U000 -> Nerubian Assassin, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Ubal','A1P8',2)  //Nerubian weaver//Ubal -> Nerubian Weaver, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Ewar','A1P8',2)  //Phantom Assassin//Ewar -> Phantom Assassin, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Nfir','A1P8',2)  //Shadow Fiend//Nfir -> Shadow Fiend, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Eevi','A1P8',7)  //terrorblade//Eevi -> Soul Keeper, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Eevm','A1P8',14) //terrorblade morphed 1//Eevm -> Soul Keeper, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02V','A1P8',14) //terrorblade morphed 2//E02V -> Soul Keeper, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02W','A1P8',14) //terrorblade morphed 3//E02W -> Soul Keeper, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02U','A1P8',14) //terrorblade morphed 4//E02U -> Soul Keeper, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E01B','A1P8',1)  //Spectre//E01B -> Spectre, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'EC57','A1P8',2)  //Venomancer//EC57 -> Venomancer, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'EC77','A1P8',5)  //Viper//EC77 -> Netherdrake, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00I','A1P8',1)  //Meepo//H00I -> Geomancer, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E002','A1P8',1)  //Razor//E002 -> Lightning Revenant, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H071','A1P8',1)  //Night crawler//H071 -> Murloc Nightcrawler, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'EC45','A1P8',0)  //Faceless Void//EC45 -> Faceless Void, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00V','A1P8',1)  //Medusa//H00V -> Gorgon, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0MK','A1P8',9)  //Arc Warden//N0MK -> Arc Warden, A1P8 -> Charge of Darkness

	call SaveInteger(MHT,'Oshd','A1P8',5)  //Bane Elemental//Oshd -> Bane Elemental, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00N','A1P8',2)  //Dark Seer//H00N -> Dark Seer, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'UC76','A1P8',2)  //Krobelus//UC76 -> Death Prophet, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'UC18','A1P8',0)  //Lion//UC18 -> Demon Witch, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Uktl','A1P8',2)  //Enigma//Uktl -> Enigma, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Ulic','A1P8',4)  //Lich//Ulic -> Lich, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'U00E','A1P8',6)  //Necro//U00E -> Necrolyte, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00H','A1P8',3)  //pugna//H00H -> Oblivion, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'U00P','A1P8',4)  //Oblivion Destroyer//U00P -> Obsidian Destroyer, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'UC01','A1P8',7)  //Queen of Pain//UC01 -> Queen of Pain, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E01C','A1P8',5)  //Warlock//E01C -> Warlock, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E02H','A1P8',2)  //Shadow Deamon//E02H -> Shadow Demon, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'O016','A1P8',3)  //Batrider//O016 -> Batrider, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'O017','A1P8',3)  //Batrider, firefly//O017 -> Batrider, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N01W','A1P8',8)  //Dazzle//N01W -> Shadow Priest, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'H00U','A1P8',2)  //Invoker//H00U -> Invoker, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'UC60','A1P8',5)  //Visage//UC60 -> Necro'lic, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'Ekee','A1P8',2)  //Leshrac//Ekee -> Tormented Soul, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'E01A','A1P8',8)  //Witch Doctor//E01A -> Witch Doctor, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0HP','A1P8',9)  //Ancient Apperation//N0HP -> Ancient Apparition, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0M7','A1P8',3)  //Winter Wyvern//N0M7 -> Winter Wyvern, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0MB','A1P8',3)  //Winter Wyvern, flyer 1//N0MB -> Winter Wyvern, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0MC','A1P8',3)  //Winter Wyvern, flyer 2//N0MC -> Winter Wyvern, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0MO','A1P8',3)  //Winter Wyvern, flyer 3//N0MO -> Winter Wyvern, A1P8 -> Charge of Darkness
	call SaveInteger(MHT,'N0MA','A1P8',3)  //Winter Wyvern, flyer 4//N0MA -> Winter Wyvern, A1P8 -> Charge of Darkness
endfunction

function SBE takes integer uid, integer aid returns nothing
	call SaveInteger(UMD,uid,5,aid)
endfunction

function SaveBonusEffects takes nothing returns nothing
	call SBE(HeroID[VS],'A1NR')//A1NR -> Aghanim Effect (Vengeful Spirit)
	call SBE(HeroID[Zeus],'A0PF')//A0PF -> Aghanim Effect (Zeus)
	call SBE(HeroID[Enchantress],'A1X2')//A1X2 -> Aghanim Effect (Enchantress 2)
	call SBE(HeroID[Morphling],0)
	call SBE(HeroID[indexid_CM],'A0Q9')//A0Q9 -> Aghanim Effect (CM2)
	call SBE(HeroID[Sven],0)
	call SBE(HeroID[NagaSiren],0)
	call SBE(HeroID[ES],'A1OC')//A1OC -> Aghanim Effect (Earthshaker)
	call SBE(HeroID[Riki],0)
	call SBE(HeroID[LoneDruid],0)
	call SBE(HeroID[Lina],'A0PC')//A0PC -> Aghanim Effect (Lina)
	call SBE(HeroID[Juggernaut],'A1QL')//A1QL -> Aghanim Effect (Jugg)
	call SBE(HeroID[Silencer],0)
	call SBE(HeroID[Treant],0)
	call SBE(HeroID[Chieftain],0)
	call SBE(HeroID[Kotl],0)
	call SBE(HeroID[Ursa],0)
	call SBE(HeroID[OgreMagi],'A0P9')//A0P9 -> Aghanim Effect (Ogre Magi)
	call SBE(HeroID[Tinker],0)
	call SBE(HeroID[Furion],'A20M')//A20M -> Furion Aghanim Effect
	call SBE(HeroID[PL],0)
	call SBE(HeroID[Tiny],0)
	call SBE(HeroID[Techies],'A1R7')//A1R7 -> Goblin Techies
	call SBE(HeroID[Chen],'A20V')//A20V -> Aghanim Effect (Chen)
	call SBE(HeroID[Luna],'A1NQ')//A1NQ -> Aghanim Effect (Luna)
	call SBE(HeroID[Sniper],0)
	call SBE(HeroID[Troll],0)
	call SBE(HeroID[Rhasta],'A0P8')//A0P8 -> Aghanim Effect (Rhasta)
	call SBE(HeroID[Wisp],0)
	call SBE(HeroID[Pandaren],0)
	call SBE(HeroID[Centaur],0)
	call SBE(HeroID[Bounty],0)
	call SBE(HeroID[indexid_DK],0)
	call SBE(HeroID[indexid_AM],0)
	call SBE(HeroID[Trax],0)
	call SBE(HeroID[Omni],0)
	call SBE(HeroID[Beastmaster],'A29E')//A29E -> Beastmaster Aghanim Effect
	call SBE(HeroID[THD],'A1VF')//A1VF -> Twin Head Dragon Aghanim Effect
	call SBE(HeroID[Alchemist],0)
	call SBE(HeroID[Potm],0)
	call SBE(HeroID[Storm],0)
	call SBE(HeroID[Huskar],'A1NS')//A1NS -> Aghanim Effect (Huskar)
	call SBE(HeroID[Lanaya],0)
	call SBE(HeroID[Puck],'A1RG')//A1RG -> Puck Effect
	call SBE(HeroID[Clock],'A220')//A220 -> Aghanim Effect (Clockwerk)
	call SBE(HeroID[Admiral],0)
	call SBE(HeroID[WR],0)
	call SBE(HeroID[Gyro],'A23E')//A23E -> Aghanim Effect (Gyrocopter)
	call SBE(HeroID[Disruptor],0)
	call SBE(HeroID[Tusk],0)
	call SBE(HeroID[Phoenix],0)
	call SBE(HeroID[BB],0)
	call SBE(HeroID[Rubick],0)
	call SBE(HeroID[Xin],0)
	call SBE(HeroID[Legion],0)
	call SBE(HeroID[Skywrath],0)
	call SBE(HeroID[Timber],0)
	call SBE(HeroID[Lycan],0)
	call SBE(HeroID[Brood],0)
	call SBE(HeroID[PA],0)
	call SBE(HeroID[Medusa],0)
	call SBE(HeroID[Bala],0)
	call SBE(HeroID[Leoric],0)
	call SBE(HeroID[Doom],0)
	call SBE(HeroID[NA],0)
	call SBE(HeroID[Slardar],0)
	call SBE(HeroID[QoP],'A0P7')//A0P7 -> Aghanim Effect (QOP)
	call SBE(HeroID[Bone],0)
	call SBE(HeroID[Void],'A1R3')//A1R3 -> Aghanim Effect (Void)
	call SBE(HeroID[Viper],0)
	call SBE(HeroID[Razor],0)
	call SBE(HeroID[Lifestealer],0)
	call SBE(HeroID[Pugna],'A0PB')//A0PB -> Aghanim Effect (Pugna)
	call SBE(HeroID[Tide],0)
	call SBE(HeroID[Bane],'A1R8')//A1R8 -> Bane Elemental
	call SBE(HeroID[Necrolyte],'A1R9')//A1R9 -> Necrolyte
	call SBE(HeroID[Pudge],'A1VB')//A1VB -> Butcher Aghanim Effect
	call SBE(HeroID[Barathum],'A1VE')//A1VE -> Spiritbreaker Aghanim Effect
	call SBE(HeroID[Weaver],0)
	call SBE(HeroID[indexid_SF],0)
	call SBE(HeroID[SK],'A1NX')//A1NX -> Aghanim Effect (Sandking)
	call SBE(HeroID[Axe],'A1V9')//A1V9 -> Axe Aghanim Effect
	call SBE(HeroID[BS],0)
	call SBE(HeroID[Abaddon],0)
	call SBE(HeroID[Spectre],0)
	call SBE(HeroID[WD],'A1V5')//A1V5 -> Aghanim Effect (Witch Doctor)
	call SBE(HeroID[OD],'A1VZ')//A1VZ -> Aghanim Effect (Destroyer)
	call SBE(HeroID[WL],'A1UY')//A1UY -> Aghanim Effect (Warlock)
	call SBE(HeroID[Geomancer],0)
	call SBE(HeroID[Dazzle],0)
	call SBE(HeroID[Pit],0)
	call SBE(HeroID[Zombie],0)
	call SBE(HeroID[DS],'A21Z')//A21Z -> Aghanim Effect (Dark Seer)
	call SBE(HeroID[Kodo],0)
	call SBE(HeroID[Enigma],0)
	call SBE(HeroID[Batrider],0)
	call SBE(HeroID[indexid_AA],0)
	call SBE(HeroID[Slark],0)
	call SBE(HeroID[TB],0)
	call SBE(HeroID[Leshrak],0)
	call SBE(HeroID[indexid_SD],0)
	call SBE(HeroID[Lich],'A0PE')//A0PE -> Aghanim Effect (Lich)
	call SBE(HeroID[Banshee],0)
	call SBE(HeroID[Lion],'A0PA')//A0PA -> Aghanim Effect (Lion)
	call SBE(HeroID[Veno],0)
	call SBE(HeroID[Magnus],0)
	call SBE(HeroID[Visage],0)
	call SBE(HeroID[Nessaj],0)
	call SBE(HeroID[Wyvern],0)
	call SBE(HeroID[Zet],0)
	call SBE(HeroID[Earth],0)
	call SBE(HeroID[Oracle],0)
	call SBE(HeroID[Crabe],0)
	call SBE(HeroID[Sieger],0)
	call SBE(HeroID[Sorcesser],0)
	call SBE(HeroID[Invoker],0)
	call SBE(HeroID[Formless],0)
	call SBE(HeroID[SpaceOrc],0)
endfunction

function InitSounds takes nothing returns nothing
	set bj_rescueSound=CreateSoundFromLabel("Rescue",false,false,false,10000,10000)
	set bj_questDiscoveredSound=CreateSoundFromLabel("QuestNew",false,false,false,10000,10000)
	set bj_questUpdatedSound=CreateSoundFromLabel("QuestUpdate",false,false,false,10000,10000)
	set bj_questCompletedSound=CreateSoundFromLabel("QuestCompleted",false,false,false,10000,10000)
	set bj_questFailedSound=CreateSoundFromLabel("QuestFailed",false,false,false,10000,10000)
	set bj_questHintSound=CreateSoundFromLabel("Hint",false,false,false,10000,10000)
	set bj_questSecretSound=CreateSoundFromLabel("SecretFound",false,false,false,10000,10000)
	set bj_questItemAcquiredSound=CreateSoundFromLabel("ItemReward",false,false,false,10000,10000)
	set bj_questWarningSound=CreateSoundFromLabel("Warning",false,false,false,10000,10000)
	set bj_victoryDialogSound=CreateSoundFromLabel("QuestCompleted",false,false,false,10000,10000)
	set bj_defeatDialogSound=CreateSoundFromLabel("QuestFailed",false,false,false,10000,10000)
	set OC=CreateSound("Abilities\\Spells\\NightElf\\Blink\\BlinkArrival1.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(OC,"BlinkTarget")
	call SetSoundDuration(OC,1466)
	call SetSoundPitch(OC,1.6)
	set AC=CreateSound("Abilities\\Spells\\Human\\Blizzard\\BlizzardLoop1.wav",true,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(AC,"BlizzardLoop")
	call SetSoundDuration(AC,4000)
	set BC=CreateSound("Buildings\\Undead\\TempleOfTheDamned\\TempleOfTheDamnedWhat.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(BC,"TempleOfTheDamnedWhat")
	call SetSoundDuration(BC,3518)
	call SetSoundDistanceCutoff(BC,2000.)
	set Sound_AxeKillFX=CreateSound("Abilities\\Spells\\Human\\Flare\\FlareTarget2.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(Sound_AxeKillFX,"Flare2")
	call SetSoundDuration(Sound_AxeKillFX,1344)
	call SetSoundDistanceCutoff(Sound_AxeKillFX,2000.)
	set Sounds_Dominating=CreateSound("Sounds\\Dominating.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_Dominating,1802)
	call SetSoundChannel(Sounds_Dominating,0)
	call SetSoundVolume(Sounds_Dominating,127)
	call SetSoundPitch(Sounds_Dominating,1.)
	set Sounds_DK=CreateSound("Sounds\\Double_Kill.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_DK,2012)
	call SetSoundChannel(Sounds_DK,0)
	call SetSoundVolume(Sounds_DK,127)
	call SetSoundPitch(Sounds_DK,1.)
	set Sounds_FB=CreateSound("Sounds\\firstblood.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_FB,1567)
	call SetSoundChannel(Sounds_FB,0)
	call SetSoundVolume(Sounds_FB,127)
	call SetSoundPitch(Sounds_FB,1.)
	set Sound_TechiesLaugh=CreateSound("Units\\Creeps\\GoblinSapper\\GoblinSapperYesAttack1.wav",false,false,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(Sound_TechiesLaugh,"GoblinSapperYesAttack")
	call SetSoundDuration(Sound_TechiesLaugh,813)
	call SetSoundChannel(Sound_TechiesLaugh,0)
	set Sounds_Godlike=CreateSound("Sounds\\GodLike.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_Godlike,1828)
	call SetSoundChannel(Sounds_Godlike,0)
	call SetSoundVolume(Sounds_Godlike,127)
	call SetSoundPitch(Sounds_Godlike,1.)
	set Sounds_HolyShit=CreateSound("Sounds\\HolyShit.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_HolyShit,2325)
	call SetSoundChannel(Sounds_HolyShit,0)
	call SetSoundVolume(Sounds_HolyShit,127)
	call SetSoundPitch(Sounds_HolyShit,1.)
	set KC=CreateSound("Buildings\\NightElf\\MoonWell\\MoonWellWhat1.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(KC,"MoonWellWhat")
	call SetSoundDuration(KC,2972)
	call SetSoundDistances(KC,600.,10000.)
	call SetSoundDistanceCutoff(KC,2000.)
	set LC=CreateSound("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaos.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(LC,"MarkOfChaos")
	call SetSoundDuration(LC,4000)
	set Sounds_KillingSpree=CreateSound("Sounds\\Killing_Spree.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_KillingSpree,2377)
	call SetSoundChannel(Sounds_KillingSpree,0)
	call SetSoundVolume(Sounds_KillingSpree,127)
	call SetSoundPitch(Sounds_KillingSpree,1.)
	set NC=CreateSound("Sound\\Buildings\\Death\\NightElfBuildingDeathSmall1.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(NC,"DeathNightElfBuildingCancel")
	call SetSoundDuration(NC,3675)
	set Sounds_Megakill=CreateSound("Sounds\\MegaKill.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_Megakill,2612)
	call SetSoundChannel(Sounds_Megakill,0)
	call SetSoundVolume(Sounds_Megakill,127)
	call SetSoundPitch(Sounds_Megakill,1.)
	set SoundMeld=CreateSound("Abilities\\Spells\\NightElf\\ShadowMeld\\ShadowMeld1.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(SoundMeld,"ShadowMeld")
	call SetSoundDuration(SoundMeld,941)
	set Sounds_Monsterkill=CreateSound("Sounds\\MonsterKill.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_Monsterkill,3344)
	call SetSoundChannel(Sounds_Monsterkill,0)
	call SetSoundVolume(Sounds_Monsterkill,127)
	call SetSoundPitch(Sounds_Monsterkill,1.)
	set Sounds_Ownage=CreateSound("Sounds\\Ownage.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_Ownage,2586)
	call SetSoundChannel(Sounds_Ownage,0)
	call SetSoundVolume(Sounds_Ownage,127)
	call SetSoundPitch(Sounds_Ownage,1.)
	set TD=CreateSound("Abilities\\Spells\\Undead\\DevourMagic\\DevourMagic.wav",false,true,true,10,10,"MissilesEAX")
	call SetSoundParamsFromLabel(TD,"DevourMagicLaunch")
	call SetSoundDuration(TD,1225)
	set QD=CreateSound("Sound\\Ambient\\DoodadEffects\\TheHornOfCenarius.wav",false,false,false,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(QD,"HornOfCenariusSound")
	call SetSoundDuration(QD,12121)
	call SetSoundVolume(QD,115)
	set Sounds_TrippleKill=CreateSound("Sounds\\triple_kill.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_TrippleKill,1907)
	call SetSoundChannel(Sounds_TrippleKill,0)
	call SetSoundVolume(Sounds_TrippleKill,127)
	call SetSoundPitch(Sounds_TrippleKill,1.)
	set Sounds_Unstoppable=CreateSound("Sounds\\Unstoppable.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_Unstoppable,2038)
	call SetSoundChannel(Sounds_Unstoppable,0)
	call SetSoundVolume(Sounds_Unstoppable,127)
	call SetSoundPitch(Sounds_Unstoppable,1.)
	set CE=CreateSound("Abilities\\Spells\\Human\\DivineShield\\PaladinDivineShieldDeath1.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(CE,"DivineShieldDeath")
	call SetSoundDuration(CE,1043)
	call SetSoundDistanceCutoff(CE,1500.)
	set DE=CreateSound("Abilities\\Spells\\Items\\AIso\\SoulGem.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(DE,"SoulGem")
	call SetSoundDuration(DE,4474)
	set Sounds_WickedSick=CreateSound("Sounds\\WhickedSick.mp3",false,false,false,10,10,"DefaultEAXON")
	call SetSoundDuration(Sounds_WickedSick,2612)
	call SetSoundChannel(Sounds_WickedSick,0)
	call SetSoundVolume(Sounds_WickedSick,127)
	call SetSoundPitch(Sounds_WickedSick,1.)
	set FE=CreateSound("Units\\Creeps\\GoblinSapper\\GoblinSapperYesAttack4.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(FE,"GoblinSapperYesAttack")
	call SetSoundDuration(FE,1091)
	call SetSoundChannel(FE,0)
	set GE=CreateSound("Abilities\\Spells\\NightElf\\shadowstrike\\ShadowStrikeBirth1.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(GE,"ShadowStrikeBirth")
	call SetSoundDuration(GE,2194)
	call SetSoundPitch(GE,1.2)
	set XE=CreateSound("Abilities\\Spells\\Human\\ReviveHuman\\ReviveHuman.wav",false,false,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(XE,"ReviveHuman")
	call SetSoundDuration(XE,3196)
	call SetSoundChannel(XE,8)
	set gg_snd_DarkSummoningLaunch1 = CreateSound( "Abilities\\Spells\\Undead\\DarkSummoning\\DarkSummoningLaunch1.wav", false, true, true, 10, 10, "SpellsEAX" )
	call SetSoundParamsFromLabel( gg_snd_DarkSummoningLaunch1, "DarkSummoningMissileLaunch" )
	call SetSoundDuration( gg_snd_DarkSummoningLaunch1, 2624 )
	call SetSoundChannel(gg_snd_DarkSummoningLaunch1,10)
	set gg_snd_PossessionMissileLaunch1 = CreateSound( "Abilities\\Spells\\Undead\\Possession\\PossessionMissileLaunch1.wav", false, true, true, 10, 10, "SpellsEAX" )
	call SetSoundParamsFromLabel( gg_snd_PossessionMissileLaunch1, "PossessionMissileLaunch" )
	call SetSoundDuration( gg_snd_PossessionMissileLaunch1, 1335 )
	call SetSoundChannel(gg_snd_PossessionMissileLaunch1,10)
	set Sounds_UltraKill=CreateSound("Sounds\\UltraKill.mp3",false,false,false,10,10,"")
	call SetSoundDuration(Sounds_UltraKill,1958)
	call SetSoundChannel(Sounds_UltraKill,0)
	call SetSoundVolume(Sounds_UltraKill,127)
	call SetSoundPitch(Sounds_UltraKill,1.)
	set Sounds_Rampage=CreateSound("Sounds\\Rampage.mp3",false,false,false,10,10,"")
	call SetSoundDuration(Sounds_Rampage,1195)
	call SetSoundChannel(Sounds_Rampage,0)
	call SetSoundVolume(Sounds_Rampage,127)
	call SetSoundPitch(Sounds_Rampage,1.)
	set ME=CreateSound("Units\\Orc\\AncestralGuardian\\AncestralGuardianAttack1.wav",false,true,true,10,10,"CombatSoundsEAX")
	call SetSoundParamsFromLabel(ME,"AncestralGuardianAttack1")
	call SetSoundDuration(ME,1181)
	set NE=CreateSound("Abilities\\Spells\\Human\\Feedback\\Feedback.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(NE,"Feedback")
	call SetSoundDuration(NE,1222)
	set SE=CreateSound("Units\\Undead\\Abomination\\AbominationPissed5.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(SE,"AbominationPissed")
	call SetSoundDuration(SE,1735)
	set RE=CreateSound("Sound\\Units\\Death\\ArtilleryCorpseExplodeDeath1.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(RE,"ArtilleryExplodeDeath")
	call SetSoundDuration(RE,1486)
	set PE=CreateSound("Units\\Undead\\CryptFiend\\CryptFiendPissed2.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(PE,"CryptFiendPissed")
	call SetSoundDuration(PE,3541)
	set ResQFun=CreateSound("Units\\Orc\\BatTroll\\TrollbatriderPissed4.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(ResQFun,"TrollbatriderPissed")
	call SetSoundDuration(ResQFun,2659)
	set QE=CreateSound("Units\\Undead\\Banshee\\BansheeDeath.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(QE,"BansheeDeath")
	call SetSoundDuration(QE,2380)
	set IF=CreateSound("Abilities\\Spells\\Other\\Volcano\\VolcanoLoop.wav",false,false,false,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(IF,"VolcanoLoop")
	call SetSoundDuration(IF,7616)
	set OF=CreateSound("Abilities\\Spells\\Human\\ThunderClap\\ThunderClapCaster.wav",false,false,false,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(OF,"ThunderClap")
	call SetSoundDuration(OF,3451)
	set AF=CreateSound("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImage.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(AF,"MirrorImage")
	call SetSoundDuration(AF,1756)
	set BF=CreateSound("Abilities\\Spells\\Human\\CloudOfFog\\CloudOfFogLoop1.wav",true,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(BF,"CloudOfFogLoop")
	call SetSoundDuration(BF,2038)
	call SetSoundPitch(BF,.9)
	set ZF=CreateSound("Sound\\Interface\\Hint.wav",false,false,false,10,10,"")
	call SetSoundParamsFromLabel(ZF,"Hint")
	call SetSoundDuration(ZF,2006)
	set VF=CreateSound("war3mapImported\\pl_impact_stun.mp3",false,true,true,10,10,"SpellsEAX")
	call SetSoundDuration(VF,1340)
	call SetSoundChannel(VF,11)
	call SetSoundVolume(VF,127)
	call SetSoundPitch(VF,1.)
	call SetSoundDistances(VF,600.,10000.)
	call SetSoundDistanceCutoff(VF,2000.)
	call SetSoundConeAngles(VF,.0,.0,127)
	call SetSoundConeOrientation(VF,.0,.0,.0)
	set WF=CreateSound("Sound\\Buildings\\Fire\\OrcHumanLargeBuildingFire1.wav",true,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(WF,"HumanFireLarge")
	call SetSoundDuration(WF,3471)
	set XF=CreateSound("Units\\Human\\Phoenix\\PhoenixEggWhat1.wav",false,false,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(XF,"PhoenixEggWhat")
	call SetSoundDuration(XF,1579)
	call SetSoundChannel(XF,0)
	set sound068=CreateSound("Buildings\\Undead\\Ziggurat\\ZigguratUpgrade.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(sound068,"ZigguratUpgradeWhat")
	call SetSoundDuration(sound068,4203)
	call SetSoundDistances(sound068,600.0,10000.0)
	call SetSoundDistanceCutoff(sound068,3000.0)
	set KF=CreateSound("Abilities\\Spells\\Human\\SpellSteal\\SpellStealMissile.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(KF,"SpellStealMissileLaunch")
	call SetSoundDuration(KF,1541)
	set LF=CreateSound("Abilities\\Spells\\Human\\SpellSteal\\SpellStealTarget.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(LF,"SpellStealTarget")
	call SetSoundDuration(LF,984)
	set MF=CreateSound("Abilities\\Spells\\Undead\\UndeadMine\\AcolyteMining.wav",false,true,true,10,10,"DefaultEAXON")
	call SetSoundParamsFromLabel(MF,"AcolyteMining")
	call SetSoundDuration(MF,4233)
	call SetSoundChannel(MF,0)
	set SF=CreateSound("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouch.wav",false,true,true,10,10,"SpellsEAX")
	call SetSoundParamsFromLabel(SF,"SpiritTouch")
	call SetSoundDuration(SF,2043)
	call SetSoundChannel(SF,11)
endfunction

function InitCustomTeams takes nothing returns nothing
	call SetPlayerTeam(Player(1),0)
	call SetPlayerTeam(Player(2),0)
	call SetPlayerTeam(Player(3),0)
	call SetPlayerTeam(Player(4),0)
	call SetPlayerTeam(Player(5),0)
	call SetPlayerTeam(Player(7),1)
	call SetPlayerTeam(Player(8),1)
	call SetPlayerTeam(Player(9),1)
	call SetPlayerTeam(Player(10),1)
	call SetPlayerTeam(Player(11),1)
endfunction

function main takes nothing returns nothing
	local weathereffect we
	local integer i
	local player p
	local unit u
	local integer hu
	local trigger t
	local real life
	local integer ZG8
	local integer HFH
	local version v
	local integer T88
	local integer a
	local location YT9
	local region UJE
	local real d
	local timer tt
	local integer k=0
	loop
		set bj_FORCE_PLAYER[k]=CreateForce()
		call ForceAddPlayer(bj_FORCE_PLAYER[k],Player(k))
		set Players[k]=Player(k)
		set k=k+1
		exitwhen k==16
	endloop
	set IsPlayerObs=IsPlayerObserver(GetLocalPlayer())
	set LocalPlayerId=GetPlayerId(GetLocalPlayer())
	call ExecuteFunc("Ascii__onInit")
	call ExecuteFunc("HexNumber__onInit")
	call InitMemoryHack()
	call LoadingProgressCheckout("injection done, setting lib")
	call fInitMPBars(true)
	call fInitHPBars(true)
	call LoadingProgressCheckout("hp/mp bars enabled")
	call DisableLibFeatures(LIB_Feature_FileHelper)
	call FuncSetMainFuncWork(true)
	call LoadingProgressCheckout("settings done")
//	call fFileHelperReleaseStorm(true)
	call DisableOPLimit()
	call ObjectData__Init()
	call LoD_Init()
	call SuspendTimeOfDay(true)
	call TriggerAddCondition(GAME_TRIGGER,Condition(function LoD_Event_Condition))
	call TriggerAddCondition(CHAT_TRIGGER,Condition(function LoD_Chat_Event))
	call SetCameraBounds(-7552.+GetCameraMargin(CAMERA_MARGIN_LEFT),-7936.+GetCameraMargin(CAMERA_MARGIN_BOTTOM),7552.-GetCameraMargin(CAMERA_MARGIN_RIGHT),7424.-GetCameraMargin(CAMERA_MARGIN_TOP),-7552.+GetCameraMargin(CAMERA_MARGIN_LEFT),7424.-GetCameraMargin(CAMERA_MARGIN_TOP),7552.-GetCameraMargin(CAMERA_MARGIN_RIGHT),-7936.+GetCameraMargin(CAMERA_MARGIN_BOTTOM))
	call SetDayNightModels("Environment\\DNC\\DNCFelwood\\DNCFelwoodTerrain\\DNCFelwoodTerrain.mdl","Environment\\DNC\\DNCFelwood\\DNCFelwoodUnit\\DNCFelwoodUnit.mdl")
	call SetWaterBaseColor(0,0,255,255)
	call NewSoundEnvironment("Default")
	call SetAmbientDaySound("FelwoodDay")
	call SetAmbientNightSound("FelwoodNight")
	call SetMapMusic("Music",true,0)
	call InitSounds()
	call InitBaseRects()
	
	set p=Player(15)
	set GoblinShop_Bot=CreateUnit(p,'u00Z',7360.,-4416.,270.)//u00Z -> Goblin Laboratory
	set GoblinShop_Top=CreateUnit(p,'u00Z',-7296.,4224.,270.)//u00Z -> Goblin Laboratory
	set u=CreateUnit(p,'uC74',3200.,-64.,270.)//uC74 -> Leragas The Vile
	set u=CreateUnit(p,'uC74',-4544.,1152.,270.)//uC74 -> Leragas The Vile
	set GoblinMerch_Top=CreateUnit(p,'u010',-7296.,4416.,270.)//u010 -> Goblin Merchant
	set GoblinMerch_Bot=CreateUnit(p,'u010',7360.,-4224.,270.)//u010 -> Goblin Merchant
	call SetUnitColor(GoblinMerch_Bot,ConvertPlayerColor(12))
	call SetUnitColor(GoblinMerch_Top,ConvertPlayerColor(12))
	call SetUnitColor(GoblinShop_Top,ConvertPlayerColor(12))
	call SetUnitColor(GoblinShop_Bot,ConvertPlayerColor(12))
	set FurbolgHut_Top=CreateUnit(p,'n12K',-7373.0,4355.0,270.000)//n12K -> Furbolg's hut
	call SetUnitColor(FurbolgHut_Top,ConvertPlayerColor(12))
	set FurbolgHut_Bot=CreateUnit(p,'n12K',7439.0,-4289.0,270.000)//n12K -> Furbolg's hut
	call SetUnitColor(FurbolgHut_Bot,ConvertPlayerColor(12))
	set TopWaypointDummy=CreateUnit(p,'e00D',-6005.1,5458.6,212.15)//e00D -> AttackToLeft
	set MidWaypointDummy=CreateUnit(p,'e00B',-561.7,-651.7,325.6)//e00B -> AttackToMid
	set BottomWaypointDummy=CreateUnit(p,'e00A',5613.5,-6350.9,64.)//e00A -> AttackToRight
	set SentBaseWaypointDummy=CreateUnit(p,'e008',-5467.9,-5891.1,307.304)//e008 -> AttackToSent
	set ScouBaseWaypointDummy=CreateUnit(p,'e001',4901.8,4536.6,212.11)//e001 -> AttackToUD
	call ConfigureNeutralVictim()
	set PL8=Filter(function ReturnTrue)
	set filterIssueHauntOrderAtLocBJ=Filter(function IssueHauntOrderAtLocBJFilter)
	set filterEnumDestructablesInCircleBJ=Filter(function S08)
	set filterGetUnitsInRectOfPlayer=Filter(function GetUnitsInRectOfPlayerFilter)
	set filterGetUnitsOfTypeIdAll=Filter(function GetUnitsOfTypeIdAllFilter)
	set filterGetUnitsOfPlayerAndTypeId=Filter(function GetUnitsOfPlayerAndTypeIdFilter)
	set filterMeleeTrainedUnitIsHeroBJ=Filter(function MeleeTrainedUnitIsHeroBJFilter)
	set filterLivingPlayerUnitsOfTypeId=Filter(function LivingPlayerUnitsOfTypeIdFilter)
	set ZG8=0
	loop
		exitwhen ZG8==16
		set bj_FORCE_PLAYER[ZG8]=CreateForce()
		call ForceAddPlayer(bj_FORCE_PLAYER[ZG8],Player(ZG8))
		set ZG8=ZG8+1
	endloop
	set bj_FORCE_ALL_PLAYERS=CreateForce()
	call ForceEnumPlayers(bj_FORCE_ALL_PLAYERS,null)
	set bj_cineModePriorSpeed=GetGameSpeed()
	set bj_cineModePriorFogSetting=IsFogEnabled()
	set bj_cineModePriorMaskSetting=IsFogMaskEnabled()
	set ZG8=0
	loop
		exitwhen ZG8>=bj_MAX_QUEUED_TRIGGERS
		set bj_queuedExecTriggers[ZG8]=null
		set bj_queuedExecUseConds[ZG8]=false
		set ZG8=ZG8+1
	endloop
	set bj_isSinglePlayer=false
	set HFH=0
	set ZG8=0
	loop
		exitwhen ZG8>=12
		if(GetPlayerController(Player(ZG8))==MAP_CONTROL_USER and GetPlayerSlotState(Player(ZG8))==PLAYER_SLOT_STATE_PLAYING)then
			set HFH=HFH+1
		endif
		set ZG8=ZG8+1
	endloop
	set bj_isSinglePlayer=(HFH==1)
	call DelayedSuspendDecayCreate()
	call InitQueuedTriggers()
	call InitRescuableBehaviorBJ()
	call InitDNCSounds()
	call InitMapRects()
	call InitSummonableCaps()
	call SetAllItemTypeSlots(11)
	call SetAllUnitTypeSlots(11)
	set bj_stockUpdateTimer=CreateTimer()
	call TimerStart(bj_stockUpdateTimer,bj_STOCK_RESTOCK_INITIAL_DELAY,false,function TG8)
	set bj_stockItemPurchased=CreateTrigger()
	call TriggerRegisterPlayerUnitEvent(bj_stockItemPurchased,Player(15),EVENT_PLAYER_UNIT_SELL_ITEM,null)
	call TriggerAddAction(bj_stockItemPurchased,function RemovePurchasedItem)
	call DetectGameStarted()
	set PreloaderUnit=CreateUnit(Player(15),'H00Y',0,0,0)//H00Y -> Preloader Hero
	call ShowUnit(PreloaderUnit,false)
	call PauseUnit(PreloaderUnit,true)
	set tt=CreateTimer()
	call SaveTimerHandle(HY,GetHandleId(PreloaderUnit),0,tt)
	set Force_Elfs=CreateForce()
	set Force_Unds=CreateForce()
	set AllPlayers=CreateForce()
	call TK8()
	call InitGroups()
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,15,true)
	call TriggerAddCondition(t,Condition(function UJ8))
	set t=null
	call ExecuteFunc("InitSystemsData")
	
	call FlushGameCache(InitGameCache("dr.x"))
	set GCM=InitGameCache("dr.x")
	call FlushGameCache(InitGameCache("d"))
	set RGCGC=InitGameCache("d")
	call FlushGameCache(InitGameCache("meta"))
	set RGCGC2=InitGameCache("meta")
	call FlushGameCache(InitGameCache("mapid"))
	set RGCGC3=InitGameCache("mapid")
	
	set PN=CreateTrigger()
	call TriggerAddCondition(PN,Condition(function GS9))
	set GlobalTimer=CreateTimer()
	set CS=Rect(-7040,-7680,7040,7168)
	call SetFloatGameState(GAME_STATE_TIME_OF_DAY,6.)
	call SuspendTimeOfDay(false)
	call SetSkyModel("Environment\\Sky\\FoggedSky\\FoggedSky.mdl")
	call SetCreepCampFilterState(true)
	set MainModeInTxt="Normal Mode"
	call TimerStart(GlobalTimer,99999.,false,null)
	set Weather_Rain=AddWeatherEffect(bj_mapInitialPlayableArea,'RAhr')
	set Weather_Snow=AddWeatherEffect(bj_mapInitialPlayableArea,'SNbs')
	set Weather_Moonlight=AddWeatherEffect(bj_mapInitialPlayableArea,'LRma')
	set Weather_Wind=AddWeatherEffect(bj_mapInitialPlayableArea,'WOlw')
	set Sentinels[0]=Player(0)
	set Sentinels[1]=Player(1)
	set Sentinels[2]=Player(2)
	set Sentinels[3]=Player(3)
	set Sentinels[4]=Player(4)
	set Sentinels[5]=Player(5)
	set Scourges[0]=Player(6)
	set Scourges[1]=Player(7)
	set Scourges[2]=Player(8)
	set Scourges[3]=Player(9)
	set Scourges[4]=Player(10)
	set Scourges[5]=Player(11)
	set Neutrals=Player(12)
	set ABDGroup=CreateGroup()
	set FrozenThroneLoc=GetUnitLoc(ScouBaseWaypointDummy)
	set TreeOfLifeLoc=GetUnitLoc(SentBaseWaypointDummy)
	set MidCreepsWaypoint=GetUnitLoc(MidWaypointDummy)
	set TopCreepsWaypoint=GetUnitLoc(TopWaypointDummy)
	set BottomCreepsWaypoint=GetUnitLoc(BottomWaypointDummy)
	set WaypointLocations[1]=TreeOfLifeLoc
	set WaypointLocations[2]=TopCreepsWaypoint
	set WaypointLocations[3]=MidCreepsWaypoint
	set WaypointLocations[4]=BottomCreepsWaypoint
	set WaypointLocations[5]=FrozenThroneLoc
	set ScourgeMidMeleeSpawn=GetRectCenter(ScouMidMeleeSpawnRect)
	set ScourgeTopMeleeSpawn=GetRectCenter(ScouTopMeleeSpawnRect)
	set ScourgeBottomMeleeSpawn=GetRectCenter(ScouBotMeleeSpawnRect)
	set ScourgeMidRangeSpawn=GetRectCenter(ScouMidRangeSpawnRect)
	set ScourgeTopRangeSpawn=GetRectCenter(ScouTopRangeSpawnRect)
	set ScourgeBottomRangeSpawn=GetRectCenter(ScouBotRangeSpawnRect)
	set SentinelMidMeleeSpawn=GetRectCenter(SentMidMeleeSpawnRect)
	set SentinelTopMeleeSpawn=GetRectCenter(SentTopMeleeSpawnRect)
	set SentinelBottomMeleeSpawn=GetRectCenter(SentBotMeleeSpawnRect)
	set SentinelMidRangeSpawn=GetRectCenter(SentMidRangeSpawnRect)
	set SentinelTopRangeSpawn=GetRectCenter(SentTopRangeSpawnRect)
	set SentinelBottomRangeSpawn=GetRectCenter(SentBotRangeSpawnRect)
	set TopRuneSpawn=GetRectCenter(TopRuneSpawnRect)
	set BottomRuneSpawn=GetRectCenter(BottomRuneSpawnRect)
	
	set t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	//call TriggerRegisterAnyUnitEvent(DamageRegister,EVENT_UNIT_ATTACKED)
	call TriggerAddCondition(t,Condition(function DamageRegisterEnter))
	set DamageRegister=CreateTrigger()
	call TriggerAddCondition(DamageRegister,Condition(function DamageHappened))
	call SetAltMinimapIcon("war3mapImported\\black.blp")
	call AddWrapper("MissChance",-1)
	call InitBuildingsSent()
	call InitBuildingsScourge()
	
	call EnableSuicide(CirclesOfPower[1])
	call EnableSuicide(CirclesOfPower[2])
	call EnableSuicide(CirclesOfPower[3])
	call EnableSuicide(CirclesOfPower[4])
	call EnableSuicide(CirclesOfPower[5])
	call EnableSuicide(CirclesOfPower[7])
	call EnableSuicide(CirclesOfPower[8])
	call EnableSuicide(CirclesOfPower[9])
	call EnableSuicide(CirclesOfPower[10])
	call EnableSuicide(CirclesOfPower[11])
	call InitForces()
	call InitHeroes()
	call TechAll()
	call ExecuteFunc("InitCreateTaverns")
	call ExecuteFunc("InitItems")
	call ExecuteFunc("Buyback_Init")
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.01,false)
	call TriggerAddCondition(t,Condition(function InitAbilLists1388))
	set t=CreateTrigger()
	call TriggerRegisterPlayerEventLeave(t,Sentinels[1])
	call TriggerRegisterPlayerEventLeave(t,Sentinels[2])
	call TriggerRegisterPlayerEventLeave(t,Sentinels[3])
	call TriggerRegisterPlayerEventLeave(t,Sentinels[4])
	call TriggerRegisterPlayerEventLeave(t,Sentinels[5])
	call TriggerRegisterPlayerEventLeave(t,Scourges[1])
	call TriggerRegisterPlayerEventLeave(t,Scourges[2])
	call TriggerRegisterPlayerEventLeave(t,Scourges[3])
	call TriggerRegisterPlayerEventLeave(t,Scourges[4])
	call TriggerRegisterPlayerEventLeave(t,Scourges[5])
	call TriggerAddAction(t,function PlayerLeave_Act1)
	call TriggerAddAction(t,function PlayerLeave_CheckFF)
	call TriggerAddAction(t,function PlayerLeave_DropSkills)
	if udg_ObserverMode then
		call IY9()
		set t=CreateTrigger()
		if IsPlayerObserver(udg_Observer1)then
			call TriggerRegisterPlayerEventLeave(t,udg_Observer1)
		endif
		if IsPlayerObserver(udg_Observer2)then
			call TriggerRegisterPlayerEventLeave(t,udg_Observer2)
		endif
		call TriggerAddAction(t,function IZ9)
	endif
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_REVIVE_FINISH)
	call TriggerAddAction(t,function HeroRespawn)
	set HeroEnters=CreateTrigger()
	call TriggerRegisterEnterRectSimple(HeroEnters,GetWorldBounds())
	call TriggerAddCondition(HeroEnters,Condition(function VD9))
	call TriggerAddAction(HeroEnters,function HeroEntersMap)
	
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SELL)
	call TriggerAddAction(t,function TavernHeroSelected)
	call TriggerAddCondition(t,Condition(function VX9))
	set t=CreateTrigger()
	call TriggerRegisterPlayerEvent(t,Player(1),EVENT_PLAYER_END_CINEMATIC)
	call TriggerRegisterPlayerEvent(t,Player(2),EVENT_PLAYER_END_CINEMATIC)
	call TriggerRegisterPlayerEvent(t,Player(3),EVENT_PLAYER_END_CINEMATIC)
	call TriggerRegisterPlayerEvent(t,Player(4),EVENT_PLAYER_END_CINEMATIC)
	call TriggerRegisterPlayerEvent(t,Player(5),EVENT_PLAYER_END_CINEMATIC)
	call TriggerRegisterPlayerEvent(t,Player(7),EVENT_PLAYER_END_CINEMATIC)
	call TriggerRegisterPlayerEvent(t,Player(8),EVENT_PLAYER_END_CINEMATIC)
	call TriggerRegisterPlayerEvent(t,Player(9),EVENT_PLAYER_END_CINEMATIC)
	call TriggerRegisterPlayerEvent(t,Player(10),EVENT_PLAYER_END_CINEMATIC)
	call TriggerRegisterPlayerEvent(t,Player(11),EVENT_PLAYER_END_CINEMATIC)
	call TriggerAddAction(t, function EscPressed)
	set TriggerGoldPerSecond=CreateTrigger()
	call TriggerRegisterTimerEvent(TriggerGoldPerSecond,0.6,true)
	call TriggerAddCondition(TriggerGoldPerSecond,Condition(function GoldPerSecTrigger))
	call DisableTrigger(TriggerGoldPerSecond)
	set TriggerUpdateGameTime=CreateTrigger()
	call TriggerRegisterTimerEvent(TriggerUpdateGameTime,.5,true)
	call TriggerAddAction(TriggerUpdateGameTime,function UpdateTime)
	call SetTime(0,0,false)
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SELL)
	call TriggerAddCondition(t,Condition(function ReliableGoldHandling))
	set RoshanUpdaterTrigger=CreateTrigger()
	call TriggerAddCondition(RoshanUpdaterTrigger,Condition(function YM9))
	call TimerStart(CreateTimer(),600,true,function RoshanBuffer)
	
	call TimedReveal(Player(0),5,-6990.,6840.,750)
	call TimedReveal(Player(1),5,-6990.,6840.,750)
	call TimedReveal(Player(2),5,-6990.,6840.,750)
	call TimedReveal(Player(3),5,-6990.,6840.,750)
	call TimedReveal(Player(4),5,-6990.,6840.,750)
	call TimedReveal(Player(5),5,-6990.,6840.,750)
	call TimedReveal(Player(6),5,-6990.,6840.,750)
	call TimedReveal(Player(7),5,-6990.,6840.,750)
	call TimedReveal(Player(8),5,-6990.,6840.,750)
	call TimedReveal(Player(9),5,-6990.,6840.,750)
	call TimedReveal(Player(10),5,-6990.,6840.,750)
	call TimedReveal(Player(11),5,-6990.,6840.,750)
	call TimedReveal(Player(12),5,-6990.,6840.,750)
	set RegionNoTPScrollPenalty=CreateRegion()
	call RegionAddRect(RegionNoTPScrollPenalty,Rect(-8192.,-8128.,-5120.,-5536.))
	call RegionAddRect(RegionNoTPScrollPenalty,Rect(4608.,4352.,8192.,8192.))
	
	set RuneSpawnTrigger=CreateTrigger()
	call TriggerAddCondition(RuneSpawnTrigger,Condition(function RuneSpawn))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SELL)
	call TriggerAddCondition(t,Condition(function UnitItem_Enter))
	
	set t_manipulateitem=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t_manipulateitem,EVENT_PLAYER_UNIT_PICKUP_ITEM)
	call TriggerRegisterAnyUnitEvent(t_manipulateitem,EVENT_PLAYER_UNIT_DROP_ITEM)
	call TriggerRegisterAnyUnitEvent(t_manipulateitem,EVENT_PLAYER_UNIT_PAWN_ITEM)
	call TriggerAddCondition(t_manipulateitem,Condition(function CM9))
	
	set GenericItemActionTrigger=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(GenericItemActionTrigger,EVENT_PLAYER_UNIT_PICKUP_ITEM)
	call TriggerRegisterAnyUnitEvent(GenericItemActionTrigger,EVENT_PLAYER_UNIT_DROP_ITEM)
	call TriggerRegisterAnyUnitEvent(GenericItemActionTrigger,EVENT_PLAYER_UNIT_PAWN_ITEM)
	call TriggerAddCondition(GenericItemActionTrigger,Condition(function CA9))
	
	set t=CreateTrigger()
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function Spell_Disassemble))
	set t=CreateTrigger()
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_DROP_ITEM)
	call TriggerAddCondition(t,Condition(function CourierCantSell))
	
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function BloodstoneMP))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddAction(t,function Autoselection)
	call TriggerAddCondition(t,Condition(function ReturnTrue))
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.1,true)
	call TriggerAddCondition(t,Condition(function CheckToggleItems))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
	call TriggerAddCondition(t,Condition(function D2D))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DROP_ITEM)
	call TriggerAddCondition(t,Condition(function D5D))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DROP_ITEM)
	call TriggerAddCondition(t,Condition(function E7D))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
	call TriggerAddCondition(t,Condition(function EDD))
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.5,true)
	call TriggerAddCondition(t,Condition(function LinkensWrapper))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
	call TriggerAddCondition(t,Condition(function FBD))
//	call Spectre_Dispersion_Init()
	
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function VariousItemSpells))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CAST)
	call TriggerAddCondition(t,Condition(function Func1164))
	set t=CreateTrigger()
	call TriggerRegisterPlayerUnitEvent(t,Neutrals,EVENT_PLAYER_UNIT_SPELL_EFFECT,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,Neutrals,EVENT_PLAYER_UNIT_SPELL_CAST,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function RoshanSlam))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_USE_ITEM)
	call TriggerAddCondition(t,Condition(function KBD))
	set YT9=GetRectCenter(RoshanSpawnRect)
	call RoshanSetups()
	call PauseUnit(CreateUnit(Player(12),'o00G',GetUnitX(Roshan),GetUnitY(Roshan),0),true)//o00G -> Vision Dummy
//	set Roshan=CreateUnitAtLoc(Player(12),'n00L',YT9,bj_UNIT_FACING)//n00L -> Roshan
//	call SetUnitAcquireRange(Roshan,150)
//	call YI9(Roshan)
//	call RemoveLocation(YT9)
//	call UnitAddItem(Roshan,CreateItem(Item_Real[Aegis],0,0))
//	call RoshanAddArmor(Roshan)
	
	set t=CreateTrigger()
	call TriggerRegisterUnitInRange(t,BottomWaypointDummy,300,Condition(function ReturnTrue))
	call TriggerRegisterUnitInRange(t,MidWaypointDummy,300,Condition(function ReturnTrue))
	call TriggerRegisterUnitInRange(t,TopWaypointDummy,300,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function KLD))
	set AddExtraRangeCreepTrigger=CreateTrigger()
	call TriggerAddAction(AddExtraRangeCreepTrigger,function K1D)
	set AddExtraMeleeCreepTrigger=CreateTrigger()
	call TriggerAddAction(AddExtraMeleeCreepTrigger,function K0D)
	set t=CreateTrigger()
	set UJE=CreateRegion()
	call RegionAddRect(UJE,SentMidMeleeSpawnRect)
	call RegionAddRect(UJE,SentMidRangeSpawnRect)
	call RegionAddRect(UJE,Waypoints_SentMidSpawn)
	call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function K5D))
	set t=CreateTrigger()
	set UJE=CreateRegion()
	call RegionAddRect(UJE,ScouMidRangeSpawnRect)
	call RegionAddRect(UJE,ScouMidMeleeSpawnRect)
	call RegionAddRect(UJE,Waypoints_ScMidSpawn)
	call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function K2D))
	set t=CreateTrigger()
	set UJE=CreateRegion()
	call RegionAddRect(UJE,SentTopMeleeSpawnRect)
	call RegionAddRect(UJE,SentTopRangeSpawnRect)
	call RegionAddRect(UJE,Waypoints_SentTopSpawn)
	call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function M4D))
	set t=CreateTrigger()
	set UJE=CreateRegion()
	call RegionAddRect(UJE,ScouTopRangeSpawnRect)
	call RegionAddRect(UJE,ScouTopMeleeSpawnRect)
	call RegionAddRect(UJE,Waypoints_ScTopSpawn)
	call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function M7D))
	set t=CreateTrigger()
	set UJE=CreateRegion()
	call RegionAddRect(UJE,SentBotRangeSpawnRect)
	call RegionAddRect(UJE,SentBotMeleeSpawnRect)
	call RegionAddRect(UJE,Waypoints_SentBotSpawn)
	call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function M8D))
	set t=CreateTrigger()
	set UJE=CreateRegion()
	call RegionAddRect(UJE,ScouBotRangeSpawnRect)
	call RegionAddRect(UJE,ScouBotMeleeSpawnRect)
	call RegionAddRect(UJE,Waypoints_ScBotSpawn)
	call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function M9D))
	set AG=CreateTrigger()
	call TriggerAddAction(AG,function CreepSpawning)
	
	
	
	set JG=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(JG,EVENT_PLAYER_UNIT_DEATH)
	call TriggerAddCondition(JG,Condition(function M1D))
	call TriggerAddAction(JG,function MegaCreepsSent)
	set KG=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(KG,EVENT_PLAYER_UNIT_DEATH)
	call TriggerAddCondition(KG,Condition(function M5D))
	call TriggerAddAction(KG,function MegaCreepsScourge)
	set LG=CreateTrigger()
	call TriggerAddAction(LG,function CreepUpgradeTime)
	set MG=CreateTrigger()
	call TriggerRegisterTimerEvent(MG,75,false)
	call TriggerAddAction(MG,function PreloadNeutrals)
	set NG=CreateTrigger()
	call TriggerAddCondition(NG,Condition(function NeutralsRespawn))
	set SG=CreateTrigger()
	call TriggerAddAction(SG,function SuperCreeps)
	set TG=CreateTrigger()
	call TriggerAddAction(TG,function RefreshBoard)
	set QG=CreateTrigger()
	call TriggerRegisterTimerEvent(QG,1.,true)
	call TriggerAddAction(QG,function BigRefreshBoard)
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DESELECTED)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SELECTED)
	call TriggerAddCondition(t,Condition(function ShopAnimation))
	
	set t=CreateTrigger()
	call TriggerAddCondition(t,Condition(function ABD))
	call TriggerRegisterUnitEvent(t,Towers_Sent_Top_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Top_2,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Mid_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Mid_2,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Bot_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Bot_2,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Top_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Top_3,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Mid_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Mid_3,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Bot_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Bot_3,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Tree1,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Tree1,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Tree2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Sent_Tree2,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Top,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Top,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Mid,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Mid,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Bot,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Bot,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Top,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Top,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Mid,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Mid,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Bot,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Bot,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Top_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Top_2,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Mid_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Mid_2,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Bot_2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Bot_2,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Top_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Top_3,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Mid_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Mid_3,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Bot_3,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Bot_3,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Throne1,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Throne1,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Throne2,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Towers_Scourge_Throne2,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Top,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Top,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Mid,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Mid,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Bot,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Bot,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Und_Rax_Range_Top,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Und_Rax_Range_Top,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Und_Rax_Range_Mid,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Und_Rax_Range_Mid,EVENT_UNIT_DEATH)
	call TriggerRegisterUnitEvent(t,Und_Rax_Range_Bot,EVENT_UNIT_DAMAGED)
	call TriggerRegisterUnitEvent(t,Und_Rax_Range_Bot,EVENT_UNIT_DEATH)
	
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,1,true)
	call TriggerAddCondition(t,Condition(function ABD_HealTimer))
	call TriggerAddCondition(t,Condition(function FixCameraHeight))
	call TriggerAddCondition(t,Condition(function CreepsAntiStuck))
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,5,true)
	call TriggerAddCondition(t,Condition(function ABD_Timer))
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,4,true)
	call TriggerAddCondition(t,Condition(function RZD))
	set Y57=GetAvailableGroup()
	set t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddCondition(t,Condition(function R3D))
	call DestroyFogModifier(CreateFogModifierRect(Sentinels[0],FOG_OF_WAR_VISIBLE,bj_mapInitialPlayableArea,true,true))
	call DestroyFogModifier(CreateFogModifierRect(Scourges[0],FOG_OF_WAR_VISIBLE,bj_mapInitialPlayableArea,true,true))
//	set t=CreateTrigger()
//	call TriggerRegisterTimerEvent(t,3.5,true)
//	call TriggerAddCondition(t,Condition(function CourierFountainCheck))
	
	
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
	call TriggerAddCondition(t,Condition(function SPD))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerAddCondition(t,Condition(function STD))
	set ZI7=CreateTrigger()
	call TriggerAddAction(ZI7,function SXD)
	set t=CreateTrigger()
	call TriggerRegisterPlayerUnitEvent(t,Neutrals,EVENT_PLAYER_UNIT_ATTACKED,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function Roshan_IllusionKiller))
	set ForbiddenWardsRegion=CreateRegion()
	call RegionAddRect(ForbiddenWardsRegion,Rect(3456,-2016,4448,-2624))
	set RoshAbuseRect=Rect(3456-64,-2016+64,3456+128,-2016-128)
	set DummyUtilizator=CreateTrigger()
	call TriggerRegisterEnterRectSimple(DummyUtilizator,GetWorldBounds())
	call TriggerAddCondition(DummyUtilizator,Condition(function SZD))
	call TriggerAddAction(DummyUtilizator,function DummyUtilize)
	
	if(bj_isSinglePlayer and S2D())then
		call AddFlyingCourierIfSolo()
		call T3D()
	endif
	set t=CreateTrigger()
	call TriggerRegisterPlayerChatEvent(t,PlayerModeTyper,"-wtf",true)
	call TriggerAddAction(t,function T0D)
	call TriggerAddCondition(t,Condition(function T6D))
	set t=CreateTrigger()
	call TriggerRegisterPlayerChatEvent(t,PlayerModeTyper,"-test",true)
	call TriggerAddCondition(t,Condition(function U7D))
	
	set t=CreateTrigger()//send hero levels
	call TriggerRegisterPlayerUnitEvent(t,Sentinels[1],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,Sentinels[2],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,Sentinels[3],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,Sentinels[4],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,Sentinels[5],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,Scourges[1],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,Scourges[2],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,Scourges[3],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,Scourges[4],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
	call TriggerRegisterPlayerUnitEvent(t,Scourges[5],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function T2D))
	set t=CreateTrigger()
	set UJE=CreateRegion()
	call RegionAddRect(UJE,GetWorldBounds())
	call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function HeroAttackedLogic_Init))
	set t=CreateTrigger()
	call TriggerRegisterUnitInRange(t,BottomWaypointDummy,300,Condition(function ReturnTrue))
	call TriggerRegisterUnitInRange(t,MidWaypointDummy,300,Condition(function ReturnTrue))
	call TriggerRegisterUnitInRange(t,TopWaypointDummy,300,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function UZD))
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,25,false)
	call TriggerAddAction(t,function UCD)
	call TriggerAddAction(t,function VFD)
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,2,false)
	call TriggerAddCondition(t,Condition(function U2D))
	set KK=CreateRegion()
	call RegionAddRect(KK,G4)
	call RegionAddRect(KK,F4)
	set t=CreateTrigger()
	call TriggerRegisterPlayerChatEvent(t,Sentinels[1],"",false)
	call TriggerRegisterPlayerChatEvent(t,Sentinels[2],"",false)
	call TriggerRegisterPlayerChatEvent(t,Sentinels[3],"",false)
	call TriggerRegisterPlayerChatEvent(t,Sentinels[4],"",false)
	call TriggerRegisterPlayerChatEvent(t,Sentinels[5],"",false)
	call TriggerRegisterPlayerChatEvent(t,Scourges[1],"",false)
	call TriggerRegisterPlayerChatEvent(t,Scourges[2],"",false)
	call TriggerRegisterPlayerChatEvent(t,Scourges[3],"",false)
	call TriggerRegisterPlayerChatEvent(t,Scourges[4],"",false)
	call TriggerRegisterPlayerChatEvent(t,Scourges[5],"",false)
	call TriggerAddAction(t,function VGD)
	set i=0
	loop
		set CSONStatus1[i]=true
		set CSONStatus2[i]=true
		set SelectionHelperEnabled[i]=true
		set ShowRollNumbers[i]=true
		set ShakingOn[i]=true
		set LeftAt[i]="Here"
		set HeroRespawnTimer[i]=CreateTimer()
		set ReadyCooldown[i]=-2
		set MultikillTimers[i]=CreateTimer()
		call SaveInteger(HY,GetHandleId(MultikillTimers[i]),0,i)
		set TxtDur[i]=10.
		set i=i+1
		exitwhen i>16
	endloop
	set i=0
	loop
		set ShowDeathTimer[GetPlayerId(Sentinels[i])]=true
		set ShowDeathTimer[GetPlayerId(Scourges[i])]=true
		set i=i+1
		exitwhen i>5
	endloop
	set t=CreateTrigger()
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
	call TriggerAddCondition(t,Condition(function ZTD))
	set t=CreateTrigger()
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
	call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
	call TriggerAddCondition(t,Condition(function DoubleHold))
	call TriggerAddCondition(t,Condition(function RunePickupPriority))
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,5,true)
	call TriggerAddCondition(t,Condition(function ZSD))
	
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,.01,false)
	call TriggerAddCondition(t,Condition(function ZAD))
	call TriggerAddCondition(t,Condition(function L1D))

	set t=null
	set t=CreateTrigger()
	call TriggerAddAction(t,function LLD)
	call TriggerAddCondition(t,Condition(function B1D))
	set AR7=t

	if udg_ObserverMode then
		set t=CreateTrigger()
		call TriggerRegisterTimerEvent(t,1,true)
		call TriggerAddCondition(t,Condition(function IJE))
	endif
	set MeleeRangeItemsSwitcher=CreateTrigger()
	call TriggerRegisterTimerEvent(MeleeRangeItemsSwitcher,10,true)
	call TriggerAddCondition(MeleeRangeItemsSwitcher,Condition(function MeleeRangeItemsFix))
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,15,false)
	call TriggerAddCondition(t,Condition(function JEE))
	call TriggerAddCondition(t,Condition(function JDE))
	set t=CreateTrigger()
	set UJE=CreateRegion()
	call RegionAddRect(UJE,GetWorldBounds())
	call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
	call TriggerAddCondition(t,Condition(function YYF))
	
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,0.1,false)
	call TriggerAddAction(t,function HEH)
	
	
	// RMD - MapID
	call Traffic_RegisterCustomGlobalData("i","d",0x03)
	
	// RMD - Meta Data
	call Traffic_RegisterCustomMetaData("a","Kills",0)
	call Traffic_RegisterCustomMetaData("b","Deaths",0)
	call Traffic_RegisterCustomMetaData("c","Assists",0)
	call Traffic_RegisterCustomMetaData("d","CreepKills",0)
	call Traffic_RegisterCustomMetaData("e","CreepDenies",0)
	call Traffic_RegisterCustomMetaData("f","Neutrals",0)
	
	
	set RoshanCanWalkHere=Rect(3008,-2016,4448,-2784)
//	set t=CreateTrigger()
//	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
//	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DROP_ITEM)
//	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PAWN_ITEM)
//	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
//	call TriggerAddCondition(t,Condition(function EvasionStacking))
//	set ShowSkillsOnSelectT=CreateTrigger()
//	call TriggerRegisterAnyUnitEvent(ShowSkillsOnSelectT,EVENT_PLAYER_UNIT_SELECTED)
//	call TriggerAddCondition(ShowSkillsOnSelectT,Condition(function ShowSkillsOnSelecting))
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_CHANGE_OWNER)
	call TriggerAddCondition(t,Condition(function OwnerChanging))
	
	set  t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
	call TriggerAddCondition(t,Condition(function Func0736))
	
	
	if bj_isSinglePlayer and (PlayerNames[1]=="df" or PlayerNames[2]=="df" or PlayerNames[3]=="df" or PlayerNames[4]=="df" or PlayerNames[5]=="df" or PlayerNames[6]=="df" or PlayerNames[8]=="df" or PlayerNames[7]=="df" or PlayerNames[8]=="df" or PlayerNames[9]=="df" or PlayerNames[10]=="df" or PlayerNames[11]=="df") then
		set IsL1ch=true
	endif
	set t=CreateTrigger()
	call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
	call TriggerAddCondition(t,Condition(function Kaolin_Prereg))
	call TriggerAddCondition(t,Condition(function TimeLapse_PreInit))
	
	set FountainRectSent=Rect(-7648,-7680,-6240,-6240)
	set FountainRectScourge=Rect(5856,5472,7712,7296)
	set SentFountainReg=CreateRegion()
	call RegionAddRect(SentFountainReg,FountainRectSent)
	set ScourgeFountainReg=CreateRegion()
	call RegionAddRect(ScourgeFountainReg,FountainRectScourge)
	set t=CreateTrigger()
	call TriggerAddCondition(t,Condition(function FountainHeal))
	call TriggerRegisterTimerEvent(t,0.1,true)
	call TriggerRegisterLeaveRegion(t,SentFountainReg,Condition(function FoutainEnteringFilter))
	call TriggerRegisterLeaveRegion(t,ScourgeFountainReg,Condition(function FoutainEnteringFilter))
	
	set t=CreateTrigger()
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CAST)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CHANNEL)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_ENDCAST)
	call TriggerAddCondition(t,Condition(function TrackUnitsCastEvents))
	
	set t=null
	set UJE=null
	
	call SetTerrainFogEx(0,9999999.,10000000.,.0,.0,.0,.0)
	call SetReservedLocalHeroButtons(1)
	call EnumDestructablesInRect(Rect(3262,-1900,4817,-2800),Condition(function RoshanPitBlockersFilter),function RoshanPitOccluderHeightFix)
	//call CameraSetSmoothingFactor(2)
	call DoubleRightClickInit()
	set t=CreateTrigger()
	call TriggerRegisterLeaveRectSimple(t,bj_mapInitialPlayableArea)
	//call RectF(GetRectMinX(bj_mapInitialPlayableArea),GetRectMinY(bj_mapInitialPlayableArea),GetRectMaxX(bj_mapInitialPlayableArea),GetRectMaxY(bj_mapInitialPlayableArea))
	call TriggerAddCondition(t,Condition(function PushOutToMap))
	set RecreationTrigger=CreateTrigger()
	call TriggerRegisterTimerEvent(RecreationTrigger,1,true)
	call TriggerAddAction(RecreationTrigger,function SaveHeroesTick)
	
	call PushOut2()
	call ExecuteFunc("Spiritbreaker_Charge_Init")
	call ExecuteFunc("PRD_Init")
	call ExecuteFunc("StoreAllTints")
	call ExecuteFunc("StoreAllUnitsBounty")
	call ExecuteFunc("InitLotusOrbItemAbilities")
	call ExecuteFunc("StoreAllUnitsSightRange")
	call ExecuteFunc("InitSCMD")
	call ExecuteFunc("InitShopping")
	call ExecuteFunc("SaveBonusEffects")
	call ExecuteFunc("InitMyLb")
	call ExecuteFunc("InitAllCooldownsTable")
	call ExecuteFunc("InitUltiesCD")
	call ExecuteFunc("InitDispellableBuffsList")
	call ExecuteFunc("InitTowersDamageCounter")
	set TreeRevivalTrigger=CreateTrigger()
	call TriggerAddCondition(TreeRevivalTrigger,Condition(function TreeRevive))
	call EnumDestructablesInRect(GetPlayableMapRect(),Condition(function ReturnTrue),function TreeRevivalGrouping)
	set t=null
	set u=null
	set YT9=null
	call InitProPlayers()
	set t=CreateTrigger()
	call TriggerRegisterTimerEvent(t,0.3,true)
	call TriggerAddAction(t,function RunDotAConfigSettings)
endfunction

function config takes nothing returns nothing
	call SetMapName("TRIGSTR_50000")
	call SetMapDescription("TRIGSTR_50001")
	call SetPlayers(10)
//	call SetTeams(10)
//	call SetGamePlacement(MAP_PLACEMENT_TEAMS_TOGETHER)
	call DefineStartLocation(0,-6990.,6840.)
	call DefineStartLocation(1,-6990.,6840.)
	call DefineStartLocation(2,-6990.,6840.)
	call DefineStartLocation(3,-6990.,6840.)
	call DefineStartLocation(4,-6990.,6840.)
	call DefineStartLocation(5,-6990.,6840.)
	call DefineStartLocation(6,-6990.,6840.)
	call DefineStartLocation(7,-6990.,6840.)
	call DefineStartLocation(8,-6990.,6840.)
	call DefineStartLocation(9,-6990.,6840.)
	call SetPlayerColor(Player(1),ConvertPlayerColor(1))
	call SetPlayerRacePreference(Player(1),RACE_PREF_NIGHTELF)
	call SetPlayerRaceSelectable(Player(1),false)
	call SetPlayerController(Player(1),MAP_CONTROL_USER)
	call SetPlayerColor(Player(2),ConvertPlayerColor(2))
	call SetPlayerRacePreference(Player(2),RACE_PREF_NIGHTELF)
	call SetPlayerRaceSelectable(Player(2),false)
	call SetPlayerController(Player(2),MAP_CONTROL_USER)
	call SetPlayerColor(Player(3),ConvertPlayerColor(3))
	call SetPlayerRacePreference(Player(3),RACE_PREF_NIGHTELF)
	call SetPlayerRaceSelectable(Player(3),false)
	call SetPlayerController(Player(3),MAP_CONTROL_USER)
	call SetPlayerColor(Player(4),ConvertPlayerColor(4))
	call SetPlayerRacePreference(Player(4),RACE_PREF_NIGHTELF)
	call SetPlayerRaceSelectable(Player(4),false)
	call SetPlayerController(Player(4),MAP_CONTROL_USER)
	call SetPlayerColor(Player(5),ConvertPlayerColor(5))
	call SetPlayerRacePreference(Player(5),RACE_PREF_NIGHTELF)
	call SetPlayerRaceSelectable(Player(5),false)
	call SetPlayerController(Player(5),MAP_CONTROL_USER)
	call SetPlayerColor(Player(7),ConvertPlayerColor(7))
	call SetPlayerRacePreference(Player(7),RACE_PREF_UNDEAD)
	call SetPlayerRaceSelectable(Player(7),false)
	call SetPlayerController(Player(7),MAP_CONTROL_USER)
	call SetPlayerColor(Player(8),ConvertPlayerColor(8))
	call SetPlayerRacePreference(Player(8),RACE_PREF_UNDEAD)
	call SetPlayerRaceSelectable(Player(8),false)
	call SetPlayerController(Player(8),MAP_CONTROL_USER)
	call SetPlayerColor(Player(9),ConvertPlayerColor(9))
	call SetPlayerRacePreference(Player(9),RACE_PREF_UNDEAD)
	call SetPlayerRaceSelectable(Player(9),false)
	call SetPlayerController(Player(9),MAP_CONTROL_USER)
	call SetPlayerColor(Player(10),ConvertPlayerColor(10))
	call SetPlayerRacePreference(Player(10),RACE_PREF_UNDEAD)
	call SetPlayerRaceSelectable(Player(10),false)
	call SetPlayerController(Player(10),MAP_CONTROL_USER)
	call SetPlayerColor(Player(11),ConvertPlayerColor(11))
	call SetPlayerRacePreference(Player(11),RACE_PREF_UNDEAD)
	call SetPlayerRaceSelectable(Player(11),false)
	call SetPlayerController(Player(11),MAP_CONTROL_USER)
	call InitCustomTeams()
	call SetPlayerAlliance(Player(15),Player(1),ConvertAllianceType(6),true)
	call SetPlayerAlliance(Player(15),Player(2),ConvertAllianceType(6),true)
	call SetPlayerAlliance(Player(15),Player(3),ConvertAllianceType(6),true)
	call SetPlayerAlliance(Player(15),Player(4),ConvertAllianceType(6),true)
	call SetPlayerAlliance(Player(15),Player(5),ConvertAllianceType(6),true)
	call SetPlayerAlliance(Player(15),Player(7),ConvertAllianceType(6),true)
	call SetPlayerAlliance(Player(15),Player(8),ConvertAllianceType(6),true)
	call SetPlayerAlliance(Player(15),Player(9),ConvertAllianceType(6),true)
	call SetPlayerAlliance(Player(15),Player(10),ConvertAllianceType(6),true)
	call SetPlayerAlliance(Player(15),Player(11),ConvertAllianceType(6),true)
endfunction